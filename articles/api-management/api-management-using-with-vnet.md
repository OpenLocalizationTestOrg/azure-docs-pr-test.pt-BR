---
title: Como usar o Gerenciamento de API do Azure com redes virtuais
description: "Saiba como configurar uma conexão a uma rede virtual no Gerenciamento de API do Azure e acessar serviços Web por meio dela."
services: api-management
documentationcenter: 
author: antonba
manager: erikre
editor: 
ms.assetid: 64b58f7b-ca22-47dc-89c0-f6bb0af27a48
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/15/2016
ms.author: apimpm
ms.openlocfilehash: 268cee739188d81feffc36ac07fcdfa18ff95a4d
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/18/2017
---
# <a name="how-to-use-azure-api-management-with-virtual-networks"></a><span data-ttu-id="e3f5c-103">Como usar o Gerenciamento de API do Azure com redes virtuais</span><span class="sxs-lookup"><span data-stu-id="e3f5c-103">How to use Azure API Management with virtual networks</span></span>
<span data-ttu-id="e3f5c-104">As redes virtuais do Azure (VNETs) permitem que você coloque qualquer um dos recursos do Azure em uma rede não roteável para a Internet com acesso controlado.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-104">Azure Virtual Networks (VNETs) allow you to place any of your Azure resources in a non-internet routeable network that you control access to.</span></span> <span data-ttu-id="e3f5c-105">Essas redes podem ser conectadas às redes locais usando várias tecnologias VPN.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-105">These networks can then be connected to your on-premises networks using various VPN technologies.</span></span> <span data-ttu-id="e3f5c-106">Para saber mais sobre redes virtuais do Azure, confira [Visão geral da Rede Virtual do Azure](../virtual-network/virtual-networks-overview.md).</span><span class="sxs-lookup"><span data-stu-id="e3f5c-106">To learn more about Azure Virtual Networks start with the information here: [Azure Virtual Network Overview](../virtual-network/virtual-networks-overview.md).</span></span>

<span data-ttu-id="e3f5c-107">O Gerenciamento de API do Azure pode ser implantado na VNET (rede virtual) para que possa acessar serviços de back-end na rede.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-107">Azure API Management can be deployed inside the virtual network (VNET), so it can access backend services within the network.</span></span> <span data-ttu-id="e3f5c-108">O portal do desenvolvedor e o gateway de API podem ser configurados para serem acessados pela Internet ou somente na rede virtual.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-108">The developer portal and API gateway, can be configured to be accessible either from the Internet or only within the virtual network.</span></span>

> [!NOTE]
> <span data-ttu-id="e3f5c-109">O Gerenciamento de API do Azure oferece suporte às VNets clássicas e do Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-109">Azure API Management supports both classic and Azure Resource Manager VNets.</span></span>
>
>

## <span data-ttu-id="e3f5c-110"><a name="enable-vpn"> </a>Habilitar conexão de VNET</span><span class="sxs-lookup"><span data-stu-id="e3f5c-110"><a name="enable-vpn"> </a>Enable VNET connection</span></span>
> [!NOTE]
> <span data-ttu-id="e3f5c-111">A conectividade da VNET está disponível nos tipos **Premium** e **Developer**.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-111">VNET connectivity is available in the **Premium** and **Developer** tiers.</span></span> <span data-ttu-id="e3f5c-112">Para alternar entre as camadas, abra o serviço de Gerenciamento de API no Portal do Azure e abra a guia **Escala e preços**. Na seção **Tipo de preço**, selecione o tipo Premium ou Desenvolvedor e clique em Salvar.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-112">To switch between the tiers, open your API Management service in the Azure portal and then open the **Scale and pricing** tab. Under the **Pricing tier** section, select the Premium or Developer tier and click Save.</span></span>
>

<span data-ttu-id="e3f5c-113">Para habilitar a conectividade de VNET, abra o serviço de Gerenciamento de API no Portal do Azure e abra a página **Rede virtual**.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-113">To enable VNET connectivity, open your API Management service in the Azure portal and open the **Virtual network** page.</span></span>

![Menu de rede virtual de Gerenciamento de API][api-management-using-vnet-menu]

<span data-ttu-id="e3f5c-115">Selecione o tipo de acesso desejado:</span><span class="sxs-lookup"><span data-stu-id="e3f5c-115">Select the desired access type:</span></span>

* <span data-ttu-id="e3f5c-116">**Externo**: o portal de desenvolvedor e o gateway de Gerenciamento de API podem ser acessados pela Internet pública por meio de um balanceador de carga externo.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-116">**External**: the API Management gateway and developer portal are accessible from the public internet via an external load balancer.</span></span> <span data-ttu-id="e3f5c-117">O gateway pode acessar recursos na rede virtual.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-117">The gateway can access resources within the virtual network.</span></span>

![Emparelhamento público][api-management-vnet-public]

* <span data-ttu-id="e3f5c-119">**Interno**: o portal de desenvolvedor e o gateway de Gerenciamento de API só podem ser acessados de dentro da rede virtual por meio de um balanceador de carga interno.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-119">**Internal**: the API Management gateway and developer portal are accessible only from within the virtual network via an internal load balancer.</span></span> <span data-ttu-id="e3f5c-120">O gateway pode acessar recursos na rede virtual.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-120">The gateway can access resources within the virtual network.</span></span>

![Emparelhamento privado][api-management-vnet-private]

<span data-ttu-id="e3f5c-122">Agora você verá uma lista de todas as regiões em que o serviço de Gerenciamento de API é disponibilizado.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-122">You will now see a list of all regions where your API Management service is provisioned.</span></span> <span data-ttu-id="e3f5c-123">Selecione uma VNET e uma sub-rede para cada região.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-123">Select a VNET and subnet for every region.</span></span> <span data-ttu-id="e3f5c-124">A lista é preenchida com as redes virtuais clássicas e do Resource Manager disponíveis em sua assinatura do Azure que estão instaladas na região que você está configurando.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-124">The list is populated with both classic and Resource Manager virtual networks available in your Azure subscriptions that are setup in the region you are configuring.</span></span>

> [!NOTE]
> <span data-ttu-id="e3f5c-125">O **Ponto de Extremidade de Serviço**, no diagrama acima, inclui Gateway/Proxy, Portal do Publicador, Portal do Desenvolvedor, GIT e o Ponto de Extremidade de Gerenciamento Direto.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-125">**Service Endpoint** in the above diagram includes Gateway/Proxy, Publisher Portal, Developer Portal, GIT, and the Direct Management Endpoint.</span></span>
> <span data-ttu-id="e3f5c-126">O **Ponto de Extremidade de Gerenciamento**, no diagrama acima, é o ponto de extremidade hospedado no serviço para gerenciar a configuração por meio do Portal do Azure e do Powershell.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-126">**Management Endpoint** in the above diagram is the endpoint hosted on the service to manage configuration via Azure portal and Powershell.</span></span>
> <span data-ttu-id="e3f5c-127">Além disso, observe que, mesmo que o diagrama mostre os endereços IP de seus vários pontos de extremidade, o serviço de Gerenciamento de API responde **somente** em seus nomes de host configurados.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-127">Also, note, that, even though, the diagram shows IP Addresses for its various endpoints, API Management service **only** responds on its configured Hostnames.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="e3f5c-128">Ao implantar uma instância do Gerenciamento de API do Azure a uma VNET do Resource Manager, o serviço deve estar em uma sub-rede dedicada que não contém outros recursos, exceto as instâncias do Gerenciamento de API do Azure.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-128">When deploying an Azure API Management instance to a Resource Manager VNET, the service must be in a dedicated subnet that contains no other resources except for Azure API Management instances.</span></span> <span data-ttu-id="e3f5c-129">Se for feita uma tentativa de implantar uma instância do Gerenciamento de API do Azure em uma VNET do Resource Manager que contém outros recursos, a implantação falhará.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-129">If an attempt is made to deploy an Azure API Management instance to a Resource Manager VNET subnet that contains other resources, the deployment will fail.</span></span>
>
>

![Selecionar VPN][api-management-setup-vpn-select]

<span data-ttu-id="e3f5c-131">Clique em **Salvar** na parte superior da tela.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-131">Click **Save** at the top of the screen.</span></span>

> [!NOTE]
> <span data-ttu-id="e3f5c-132">O endereço VIP da instância do Gerenciamento de API mudará sempre que a VNET for habilitada ou desabilitada.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-132">The VIP address of the API Management instance will change each time VNET is enabled or disabled.</span></span>  
> <span data-ttu-id="e3f5c-133">O endereço VIP também será alterado quando o Gerenciamento de API for movido de **Externo** para **Interno** ou vice-versa</span><span class="sxs-lookup"><span data-stu-id="e3f5c-133">The VIP address will also change when API Management is moved from **External** to **Internal** or vice-versa</span></span>
>


> [!IMPORTANT]
> <span data-ttu-id="e3f5c-134">Se você remover o Gerenciamento de API de uma rede virtual ou alterar uma em que ele esteja implantado, a rede virtual usada anteriormente poderá permanecer bloqueada por até 4 horas.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-134">If you remove API Management from a VNET or change the one it is deployed in, the previously used VNET can remain locked for up to 4 hours.</span></span> <span data-ttu-id="e3f5c-135">Durante esse período, não será possível excluir a rede virtual nem implantar um novo recurso nela.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-135">During this period it will not be possible to delete the VNET or deploy a new resource to it.</span></span>

## <span data-ttu-id="e3f5c-136"><a name="enable-vnet-powershell"> </a>Habilitar a conexão de VNET usando cmdlets do PowerShell</span><span class="sxs-lookup"><span data-stu-id="e3f5c-136"><a name="enable-vnet-powershell"> </a>Enable VNET connection using PowerShell cmdlets</span></span>
<span data-ttu-id="e3f5c-137">Você também pode habilitar a conectividade de VNET usando os cmdlets do PowerShell</span><span class="sxs-lookup"><span data-stu-id="e3f5c-137">You can also enable VNET connectivity using the PowerShell cmdlets</span></span>

* <span data-ttu-id="e3f5c-138">**Criar um serviço de Gerenciamento de API dentro de uma VNET**: use o cmdlet [New-AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement) para criar um serviço de Gerenciamento de API do Azure dentro de uma VNET.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-138">**Create an API Management service inside a VNET**: Use the cmdlet [New-AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement) to create an Azure API Management service inside a VNET.</span></span>

* <span data-ttu-id="e3f5c-139">**Implantar um serviço de Gerenciamento de API existente dentro de uma VNET**: use o cmdlet [Update-AzureRmApiManagementDeployment](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment) para mover um serviço de Gerenciamento de API do Azure existente dentro de uma rede virtual.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-139">**Deploy an existing API Management service inside a VNET**: Use the cmdlet [Update-AzureRmApiManagementDeployment](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment) to move an existing Azure API Management service inside a Virtual Network.</span></span>

## <span data-ttu-id="e3f5c-140"><a name="connect-vnet"> </a>Conectar-se a um serviço Web hospedado em uma rede virtual</span><span class="sxs-lookup"><span data-stu-id="e3f5c-140"><a name="connect-vnet"> </a>Connect to a web service hosted within a virtual Network</span></span>
<span data-ttu-id="e3f5c-141">Depois que o serviço de Gerenciamento de API for conectado à VNET, acessar os serviços de back-end nela será o mesmo que acessar serviços públicos.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-141">After your API Management service is connected to the VNET, accessing backend services within it is no different than accessing public services.</span></span> <span data-ttu-id="e3f5c-142">Basta digitar o endereço IP local ou o nome do host (se um servidor DNS estiver configurado para a VNET) do serviço Web no campo **URL do serviço Web** ao criar uma nova API ou editar uma já existente.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-142">Just type in the local IP address or the host name (if a DNS server is configured for the VNET) of your web service into the **Web service URL** field when creating a new API or editing an existing one.</span></span>

![Adicionar a API da VPN][api-management-setup-vpn-add-api]

## <span data-ttu-id="e3f5c-144"><a name="network-configuration-issues"> </a>Problemas comuns de configuração de rede</span><span class="sxs-lookup"><span data-stu-id="e3f5c-144"><a name="network-configuration-issues"> </a>Common Network Configuration Issues</span></span>
<span data-ttu-id="e3f5c-145">Veja a seguir uma lista de problemas comuns de erro de configuração que podem ocorrer ao implantar o serviço de Gerenciamento de API em uma rede virtual.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-145">Following is a list of common misconfiguration issues that can occur while deploying API Management service into a Virtual Network.</span></span>

* <span data-ttu-id="e3f5c-146">**Configuração personalizada de servidor DNS**: o serviço Gerenciamento de API depende de vários serviços do Azure.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-146">**Custom DNS server setup**: The API Management service depends on several Azure services.</span></span> <span data-ttu-id="e3f5c-147">Quando o Gerenciamento de API estiver hospedado em uma VNET com um servidor DNS personalizado, será necessário resolver os nomes de host desses serviços do Azure.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-147">When API Management is hosted in a VNET with a custom DNS server, it needs to resolve the hostnames of those Azure services.</span></span> <span data-ttu-id="e3f5c-148">Siga [estas](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) orientações sobre a configuração de DNS personalizada.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-148">Please follow [this](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) guidance on custom DNS setup.</span></span> <span data-ttu-id="e3f5c-149">Consulte a tabela de portas abaixo e outros requisitos de rede para ter uma referência.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-149">See the ports table below and other network requirements for reference.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="e3f5c-150">Se estiver usando um ou mais servidores DNS personalizados para a VNET, é aconselhável que você os configure **antes** de implantar um serviço Gerenciamento de API nele.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-150">It is recommended that, if you are using a Custom DNS Server(s) for the VNET, you set that up **before** deploying an API Management service into it.</span></span> <span data-ttu-id="e3f5c-151">Caso contrário, você precisará atualizar o serviço de Gerenciamento de API sempre que você alterar os servidores DNS executando a [operação Aplicar Configuração de Rede](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates)</span><span class="sxs-lookup"><span data-stu-id="e3f5c-151">Otherwise you need to update the API Management service each time you change the DNS Servers(s) by running the [Apply Network Configuration Operation](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates)</span></span>

* <span data-ttu-id="e3f5c-152">**Portas necessárias para o Gerenciamento de API**: o tráfego de entrada e saída para a sub-rede na qual o Gerenciamento de API foi implantado pode ser controlado usando o [Grupo de Segurança de Rede][Network Security Group].</span><span class="sxs-lookup"><span data-stu-id="e3f5c-152">**Ports required for API Management**: Inbound and Outbound traffic into the Subnet in which API Management is deployed can be controlled using [Network Security Group][Network Security Group].</span></span> <span data-ttu-id="e3f5c-153">Se qualquer uma dessas portas estiver indisponível, o Gerenciamento de API poderá não funcionar corretamente e poderá se tornar inacessível.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-153">If any of these ports are unavailable, API Management may not operate properly and may become inaccessible.</span></span> <span data-ttu-id="e3f5c-154">A existência de uma ou mais dessas portas bloqueadas é outro problema de configuração incorreta no uso do Gerenciamento de API em uma VNET.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-154">Having one or more of these ports blocked is another common misconfiguration issue when using API Management with a VNET.</span></span>

<span data-ttu-id="e3f5c-155">Quando uma instância do serviço Gerenciamento de API está hospedada em uma rede virtual, as portas na tabela a seguir são usadas.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-155">When an API Management service instance is hosted in a VNET, the ports in the following table are used.</span></span>

| <span data-ttu-id="e3f5c-156">Porta(s) de Origem/Destino</span><span class="sxs-lookup"><span data-stu-id="e3f5c-156">Source / Destination Port(s)</span></span> | <span data-ttu-id="e3f5c-157">Direção</span><span class="sxs-lookup"><span data-stu-id="e3f5c-157">Direction</span></span> | <span data-ttu-id="e3f5c-158">Protocolo de transporte</span><span class="sxs-lookup"><span data-stu-id="e3f5c-158">Transport protocol</span></span> | <span data-ttu-id="e3f5c-159">Finalidade</span><span class="sxs-lookup"><span data-stu-id="e3f5c-159">Purpose</span></span> | <span data-ttu-id="e3f5c-160">Origem/Destino</span><span class="sxs-lookup"><span data-stu-id="e3f5c-160">Source / Destination</span></span> | <span data-ttu-id="e3f5c-161">Tipo de acesso</span><span class="sxs-lookup"><span data-stu-id="e3f5c-161">Access type</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="e3f5c-162">* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="e3f5c-162">* / 80, 443</span></span> |<span data-ttu-id="e3f5c-163">Entrada</span><span class="sxs-lookup"><span data-stu-id="e3f5c-163">Inbound</span></span> |<span data-ttu-id="e3f5c-164">TCP</span><span class="sxs-lookup"><span data-stu-id="e3f5c-164">TCP</span></span> |<span data-ttu-id="e3f5c-165">Comunicação do cliente com o Gerenciamento de API</span><span class="sxs-lookup"><span data-stu-id="e3f5c-165">Client communication to API Management</span></span> |<span data-ttu-id="e3f5c-166">INTERNET / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="e3f5c-166">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="e3f5c-167">Externo</span><span class="sxs-lookup"><span data-stu-id="e3f5c-167">External</span></span> |
| <span data-ttu-id="e3f5c-168">* / 3443</span><span class="sxs-lookup"><span data-stu-id="e3f5c-168">* / 3443</span></span> |<span data-ttu-id="e3f5c-169">Entrada</span><span class="sxs-lookup"><span data-stu-id="e3f5c-169">Inbound</span></span> |<span data-ttu-id="e3f5c-170">TCP</span><span class="sxs-lookup"><span data-stu-id="e3f5c-170">TCP</span></span> |<span data-ttu-id="e3f5c-171">Ponto de extremidade de gerenciamento para o Portal do Azure e o Powershell</span><span class="sxs-lookup"><span data-stu-id="e3f5c-171">Management endpoint for Azure portal and Powershell</span></span> |<span data-ttu-id="e3f5c-172">INTERNET / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="e3f5c-172">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="e3f5c-173">Interno e externo</span><span class="sxs-lookup"><span data-stu-id="e3f5c-173">External & Internal</span></span> |
| <span data-ttu-id="e3f5c-174">* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="e3f5c-174">* / 80, 443</span></span> |<span data-ttu-id="e3f5c-175">Saída</span><span class="sxs-lookup"><span data-stu-id="e3f5c-175">Outbound</span></span> |<span data-ttu-id="e3f5c-176">TCP</span><span class="sxs-lookup"><span data-stu-id="e3f5c-176">TCP</span></span> |<span data-ttu-id="e3f5c-177">Dependência do Armazenamento do Azure e do Barramento de Serviço do Azure</span><span class="sxs-lookup"><span data-stu-id="e3f5c-177">Dependency on Azure Storage and Azure Service Bus</span></span> |<span data-ttu-id="e3f5c-178">VIRTUAL_NETWORK/INTERNET</span><span class="sxs-lookup"><span data-stu-id="e3f5c-178">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="e3f5c-179">Interno e externo</span><span class="sxs-lookup"><span data-stu-id="e3f5c-179">External & Internal</span></span> |
| <span data-ttu-id="e3f5c-180">* / 1433</span><span class="sxs-lookup"><span data-stu-id="e3f5c-180">* / 1433</span></span> |<span data-ttu-id="e3f5c-181">Saída</span><span class="sxs-lookup"><span data-stu-id="e3f5c-181">Outbound</span></span> |<span data-ttu-id="e3f5c-182">TCP</span><span class="sxs-lookup"><span data-stu-id="e3f5c-182">TCP</span></span> |<span data-ttu-id="e3f5c-183">Dependência no SQL Azure</span><span class="sxs-lookup"><span data-stu-id="e3f5c-183">Dependency on Azure SQL</span></span> |<span data-ttu-id="e3f5c-184">VIRTUAL_NETWORK/INTERNET</span><span class="sxs-lookup"><span data-stu-id="e3f5c-184">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="e3f5c-185">Interno e externo</span><span class="sxs-lookup"><span data-stu-id="e3f5c-185">External & Internal</span></span> |
| <span data-ttu-id="e3f5c-186">* / 11000 - 11999</span><span class="sxs-lookup"><span data-stu-id="e3f5c-186">* / 11000 - 11999</span></span> |<span data-ttu-id="e3f5c-187">Saída</span><span class="sxs-lookup"><span data-stu-id="e3f5c-187">Outbound</span></span> |<span data-ttu-id="e3f5c-188">TCP</span><span class="sxs-lookup"><span data-stu-id="e3f5c-188">TCP</span></span> |<span data-ttu-id="e3f5c-189">Dependência do SQL V12 do Azure</span><span class="sxs-lookup"><span data-stu-id="e3f5c-189">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="e3f5c-190">VIRTUAL_NETWORK/INTERNET</span><span class="sxs-lookup"><span data-stu-id="e3f5c-190">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="e3f5c-191">Interno e externo</span><span class="sxs-lookup"><span data-stu-id="e3f5c-191">External & Internal</span></span> |
| <span data-ttu-id="e3f5c-192">* / 14000 - 14999</span><span class="sxs-lookup"><span data-stu-id="e3f5c-192">* / 14000 - 14999</span></span> |<span data-ttu-id="e3f5c-193">Saída</span><span class="sxs-lookup"><span data-stu-id="e3f5c-193">Outbound</span></span> |<span data-ttu-id="e3f5c-194">TCP</span><span class="sxs-lookup"><span data-stu-id="e3f5c-194">TCP</span></span> |<span data-ttu-id="e3f5c-195">Dependência do SQL V12 do Azure</span><span class="sxs-lookup"><span data-stu-id="e3f5c-195">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="e3f5c-196">VIRTUAL_NETWORK/INTERNET</span><span class="sxs-lookup"><span data-stu-id="e3f5c-196">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="e3f5c-197">Interno e externo</span><span class="sxs-lookup"><span data-stu-id="e3f5c-197">External & Internal</span></span> |
| <span data-ttu-id="e3f5c-198">* / 5671</span><span class="sxs-lookup"><span data-stu-id="e3f5c-198">* / 5671</span></span> |<span data-ttu-id="e3f5c-199">Saída</span><span class="sxs-lookup"><span data-stu-id="e3f5c-199">Outbound</span></span> |<span data-ttu-id="e3f5c-200">AMQP</span><span class="sxs-lookup"><span data-stu-id="e3f5c-200">AMQP</span></span> |<span data-ttu-id="e3f5c-201">Dependência para registrar em log a política de Hub de Eventos e o agente de monitoramento</span><span class="sxs-lookup"><span data-stu-id="e3f5c-201">Dependency for Log to Event Hub policy and monitoring agent</span></span> |<span data-ttu-id="e3f5c-202">VIRTUAL_NETWORK/INTERNET</span><span class="sxs-lookup"><span data-stu-id="e3f5c-202">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="e3f5c-203">Interno e externo</span><span class="sxs-lookup"><span data-stu-id="e3f5c-203">External & Internal</span></span> |
| <span data-ttu-id="e3f5c-204">6381 - 6383 / 6381 - 6383</span><span class="sxs-lookup"><span data-stu-id="e3f5c-204">6381 - 6383 / 6381 - 6383</span></span> |<span data-ttu-id="e3f5c-205">Entrada e Saída</span><span class="sxs-lookup"><span data-stu-id="e3f5c-205">Inbound & Outbound</span></span> |<span data-ttu-id="e3f5c-206">UDP</span><span class="sxs-lookup"><span data-stu-id="e3f5c-206">UDP</span></span> |<span data-ttu-id="e3f5c-207">Dependência de Cache Redis</span><span class="sxs-lookup"><span data-stu-id="e3f5c-207">Dependency on Redis Cache</span></span> |<span data-ttu-id="e3f5c-208">VIRTUAL_NETWORK / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="e3f5c-208">VIRTUAL_NETWORK / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="e3f5c-209">Interno e externo</span><span class="sxs-lookup"><span data-stu-id="e3f5c-209">External & Internal</span></span> |-
| <span data-ttu-id="e3f5c-210">* / 445</span><span class="sxs-lookup"><span data-stu-id="e3f5c-210">* / 445</span></span> |<span data-ttu-id="e3f5c-211">Saída</span><span class="sxs-lookup"><span data-stu-id="e3f5c-211">Outbound</span></span> |<span data-ttu-id="e3f5c-212">TCP</span><span class="sxs-lookup"><span data-stu-id="e3f5c-212">TCP</span></span> |<span data-ttu-id="e3f5c-213">Dependência do Compartilhamento de Arquivos do Azure para GIT</span><span class="sxs-lookup"><span data-stu-id="e3f5c-213">Dependency on Azure File Share for GIT</span></span> |<span data-ttu-id="e3f5c-214">VIRTUAL_NETWORK/INTERNET</span><span class="sxs-lookup"><span data-stu-id="e3f5c-214">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="e3f5c-215">Interno e externo</span><span class="sxs-lookup"><span data-stu-id="e3f5c-215">External & Internal</span></span> |
| <span data-ttu-id="e3f5c-216">* / *</span><span class="sxs-lookup"><span data-stu-id="e3f5c-216">* / *</span></span> | <span data-ttu-id="e3f5c-217">Entrada</span><span class="sxs-lookup"><span data-stu-id="e3f5c-217">Inbound</span></span> |<span data-ttu-id="e3f5c-218">TCP</span><span class="sxs-lookup"><span data-stu-id="e3f5c-218">TCP</span></span> |<span data-ttu-id="e3f5c-219">Balanceador de carga de infraestrutura do Azure</span><span class="sxs-lookup"><span data-stu-id="e3f5c-219">Azure Infrastructure Load Balancer</span></span> | <span data-ttu-id="e3f5c-220">AZURE_LOAD_BALANCER / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="e3f5c-220">AZURE_LOAD_BALANCER / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="e3f5c-221">Interno e externo</span><span class="sxs-lookup"><span data-stu-id="e3f5c-221">External & Internal</span></span> |

* <span data-ttu-id="e3f5c-222">**Funcionalidade SSL**: para habilitar a criação e validação de cadeia de certificados SSL o serviço Gerenciamento de API precisa de conectividade de rede de saída para ocsp.msocsp.com, mscrl.microsoft.com e crl.microsoft.com. Essa dependência não é necessária, se qualquer certificado que você carrega no Gerenciamento de API contém a cadeia completa para a raiz de CA.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-222">**SSL functionality**: To enable SSL certificate chain building and validation the API Management service needs Outbound network connectivity to ocsp.msocsp.com, mscrl.microsoft.com and crl.microsoft.com. This dependency is not required, if any certificate you upload to API Management contain the full chain to the CA root.</span></span>

* <span data-ttu-id="e3f5c-223">**Acesos de DNS**: O acesso de saída na porta 53 é necessário para a comunicação com servidores DNS.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-223">**DNS Access**: Outbound access on port 53 is required for communication with DNS servers.</span></span> <span data-ttu-id="e3f5c-224">Se houver um servidor DNS personalizado na outra extremidade de um gateway de VPN, o servidor DNS deverá estar acessível pela sub-rede que hospeda o Gerenciamento de API.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-224">If a custom DNS server exists on the other end of a VPN gateway, the DNS server must be reachable from the subnet hosting API Management.</span></span>

* <span data-ttu-id="e3f5c-225">**Monitoramento de integridade e métricas**: conectividade de rede de saída para pontos de extremidade do Monitoramento do Azure, que são resolvidos sob os seguintes domínios: global.metrics.nsatc.net, shoebox2.metrics.nsatc.net e prod3.metrics.nsatc.net.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-225">**Metrics and Health Monitoring**: Outbound network connectivity to Azure Monitoring endpoints, which resolve under the following domains: global.metrics.nsatc.net, shoebox2.metrics.nsatc.net, prod3.metrics.nsatc.net.</span></span>

* <span data-ttu-id="e3f5c-226">**Configuração da ExpressRoute**: uma configuração de cliente comum é definir sua própria rota padrão (0.0.0.0/0), que força o tráfego de saída da Internet para o fluxo local.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-226">**Express Route Setup**: A common customer configuration is to define their own default route (0.0.0.0/0) which forces outbound Internet traffic to instead flow on-premises.</span></span> <span data-ttu-id="e3f5c-227">Esse fluxo de tráfego invariavelmente interrompe a conectividade com o Gerenciamento de API do Azure, pois o tráfego de saída é bloqueado localmente ou convertido em NAT para um conjunto irreconhecível de endereços que não funcionam mais com vários pontos de extremidade do Azure.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-227">This traffic flow invariably breaks connectivity with Azure API Management because the outbound traffic is either blocked on-premises, or NAT'd to an unrecognizable set of addresses that no longer work with various Azure endpoints.</span></span> <span data-ttu-id="e3f5c-228">A solução é definir uma (ou mais) [UDRs][UDRs] (rotas definidas pelo usuário) na sub-rede que contém o Gerenciamento de API do Azure.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-228">The solution is to define one (or more) user-defined routes ([UDRs][UDRs]) on the subnet that contains the Azure API Management.</span></span> <span data-ttu-id="e3f5c-229">Uma UDR define rotas específicas de sub-rede que serão consideradas no lugar da rota padrão.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-229">A UDR defines subnet-specific routes that will be honored instead of the default route.</span></span>
  <span data-ttu-id="e3f5c-230">Se possível, é recomendável usar a seguinte configuração:</span><span class="sxs-lookup"><span data-stu-id="e3f5c-230">If possible, it is recommended to use the following configuration:</span></span>
 * <span data-ttu-id="e3f5c-231">A configuração de ExpressRoute anuncia 0.0.0.0/0 e, por padrão, encapsula à força todo o tráfego de saída no local.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-231">The ExpressRoute configuration advertises 0.0.0.0/0 and by default force tunnels all outbound traffic on-premises.</span></span>
 * <span data-ttu-id="e3f5c-232">O UDR aplicada à sub-rede que contém o Gerenciamento de API do Azure define 0.0.0.0/0 com um tipo do próximo salto da Internet.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-232">The UDR applied to the subnet containing the Azure API Management defines 0.0.0.0/0 with a next hop type of Internet.</span></span>
 <span data-ttu-id="e3f5c-233">O efeito combinado dessas etapas é que a UDR do nível de sub-rede tem precedência sobre o túnel forçado do ExpressRoute, garantindo acesso de Internet de saída do Gerenciamento de API do Azure.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-233">The combined effect of these steps is that the subnet level UDR takes precedence over the ExpressRoute forced tunneling, thus ensuring outbound Internet access from the Azure API Management.</span></span>

>[!WARNING]  
><span data-ttu-id="e3f5c-234">O Gerenciamento de API do Azure não tem suporte com configurações do ExpressRoute que **incorretamente cruzam anúncios de rotas do caminho de emparelhamento público para o caminho de emparelhamento privado**.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-234">Azure API Management is not supported with ExpressRoute configurations that **incorrectly cross-advertise routes from the public peering path to the private peering path**.</span></span> <span data-ttu-id="e3f5c-235">As configurações de ExpressRoute com emparelhamento público definido receberão anúncios de rota da Microsoft para um grande conjunto de intervalos de endereços IP do Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-235">ExpressRoute configurations that have public peering configured, will receive route advertisements from Microsoft for a large set of Microsoft Azure IP address ranges.</span></span> <span data-ttu-id="e3f5c-236">Se esses intervalos de endereços forem incorretamente anunciados de modo cruzado no caminho de emparelhamento privado, o resultado final será que todos os pacotes de saída de rede da sub-rede da instância do Gerenciamento de API do Azure serão incorretamente encapsulados à força em uma infraestrutura de rede local do cliente.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-236">If these address ranges are incorrectly cross-advertised on the private peering path, the end result is that all outbound network packets from the Azure API Management instance's subnet are incorrectly force-tunneled to a customer's on-premises network infrastructure.</span></span> <span data-ttu-id="e3f5c-237">Esse fluxo de rede interrompe o Gerenciamento de API do Azure.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-237">This network flow breaks Azure API Management.</span></span> <span data-ttu-id="e3f5c-238">A solução para esse problema é parar as rotas de anúncios cruzados do caminho de emparelhamento público para o caminho de emparelhamento particular.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-238">The solution to this problem is to stop cross-advertising routes from the public peering path to the private peering path.</span></span>


## <span data-ttu-id="e3f5c-239"><a name="troubleshooting"> </a>Solução de problemas</span><span class="sxs-lookup"><span data-stu-id="e3f5c-239"><a name="troubleshooting"> </a>Troubleshooting</span></span>
<span data-ttu-id="e3f5c-240">Ao fazer alterações em sua rede, consulte [NetworkStatus API](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus) para validar se o serviço de Gerenciamento de API não perdeu o acesso a qualquer um dos recursos críticos dos quais ele depende.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-240">When making changes to your network, refer to [NetworkStatus API](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus), to validate if the API Management service has not lost access to any of the critical resources which it depends upon.</span></span> <span data-ttu-id="e3f5c-241">O status de conectividade deve ser atualizado a cada 15 minutos.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-241">The connectivity status should be updated every 15 minutes.</span></span>

## <span data-ttu-id="e3f5c-242"><a name="limitations"> </a>Limitações</span><span class="sxs-lookup"><span data-stu-id="e3f5c-242"><a name="limitations"> </a>Limitations</span></span>
* <span data-ttu-id="e3f5c-243">Uma sub-rede que contém instâncias de Gerenciamento de API não pode conter outros tipos de recursos do Azure.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-243">A subnet containing API Management instances cannot contain any other Azure resource types.</span></span>
* <span data-ttu-id="e3f5c-244">A sub-rede e o serviço de Gerenciamento de API devem estar na mesma assinatura.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-244">The subnet and the API Management service must be in the same subscription.</span></span>
* <span data-ttu-id="e3f5c-245">Uma sub-rede que contém instâncias de Gerenciamento de API não pode ser movida entre assinaturas.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-245">A subnet containing API Management instances cannot be moved across subscriptions.</span></span>
* <span data-ttu-id="e3f5c-246">Ao usar uma rede virtual interna, apenas um endereço IP interno estará disponível do intervalo indicado na [RFC 1918](https://tools.ietf.org/html/rfc1918), um endereço IP público não pode ser fornecido.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-246">When using an internal virtual network, only an internal IP address will be available from the range stated in [RFC 1918](https://tools.ietf.org/html/rfc1918), a public IP address cannot be provided.</span></span>
* <span data-ttu-id="e3f5c-247">Para implantações de Gerenciamento de API de várias regiões com redes virtuais internas configuradas, os usuários são responsáveis por gerenciar sua próprias como possuem o DNS de balanceamento de carga.</span><span class="sxs-lookup"><span data-stu-id="e3f5c-247">For multi-region API Management deployments, with Internal virtual networks configured, users are responsible for managing their own load balancing as they own the DNS.</span></span>


## <span data-ttu-id="e3f5c-248"><a name="related-content"> </a>Conteúdo relacionado</span><span class="sxs-lookup"><span data-stu-id="e3f5c-248"><a name="related-content"> </a>Related content</span></span>
* [<span data-ttu-id="e3f5c-249">Conectando uma rede virtual ao back-end usando o Gateway de VPN</span><span class="sxs-lookup"><span data-stu-id="e3f5c-249">Connecting a Virtual Network to backend using Vpn Gateway</span></span>](../vpn-gateway/vpn-gateway-about-vpngateways.md#s2smulti)
* [<span data-ttu-id="e3f5c-250">Conectar uma rede virtual de diferentes modelos de implantação</span><span class="sxs-lookup"><span data-stu-id="e3f5c-250">Connecting a Virtual Network from different deployment models</span></span>](../vpn-gateway/vpn-gateway-connect-different-deployment-models-powershell.md)
* [<span data-ttu-id="e3f5c-251">Como usar o Inspetor de API para rastrear chamadas no Gerenciamento de API do Azure</span><span class="sxs-lookup"><span data-stu-id="e3f5c-251">How to use the API Inspector to trace calls in Azure API Management</span></span>](api-management-howto-api-inspector.md)

[api-management-using-vnet-menu]: ./media/api-management-using-with-vnet/api-management-menu-vnet.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-type.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-select.png
[api-management-setup-vpn-add-api]: ./media/api-management-using-with-vnet/api-management-using-vnet-add-api.png
[api-management-vnet-private]: ./media/api-management-using-with-vnet/api-management-vnet-private.png
[api-management-vnet-public]: ./media/api-management-using-with-vnet/api-management-vnet-public.png

[Enable VPN connections]: #enable-vpn
[Connect to a web service behind VPN]: #connect-vpn
[Related content]: #related-content

[UDRs]: ../virtual-network/virtual-networks-udr-overview.md
[Network Security Group]: ../virtual-network/virtual-networks-nsg.md
