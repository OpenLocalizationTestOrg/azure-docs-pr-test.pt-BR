---
title: "Implantar o gateway de fábrica conectada do Azure IoT Suite | Microsoft Docs"
description: "Como implantar um gateway no Windows ou no Linux para permitir conectividade com a solução pré-configurada de fábrica conectada."
services: 
suite: iot-suite
documentationcenter: na
author: dominicbetts
manager: timlt
editor: 
ms.service: iot-suite
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/24/2017
ms.author: dobett
ms.openlocfilehash: b0e6ae705911d7c18643c77b7fe08fdffffa5eb1
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/03/2017
---
# <a name="deploy-a-gateway-on-windows-or-linux-for-the-connected-factory-preconfigured-solution"></a><span data-ttu-id="f39f3-103">Implantar um gateway no Windows ou Linux para a solução pré-configurada de fábrica conectada</span><span class="sxs-lookup"><span data-stu-id="f39f3-103">Deploy a gateway on Windows or Linux for the connected factory preconfigured solution</span></span>

<span data-ttu-id="f39f3-104">O software necessário para implantar um gateway para a solução pré-configurada de fábrica conectada tem dois componentes:</span><span class="sxs-lookup"><span data-stu-id="f39f3-104">The software required to deploy a gateway for the connected factory preconfigured solution has two components:</span></span>

* <span data-ttu-id="f39f3-105">O *Proxy OPC* estabelece uma conexão ao Hub IoT.</span><span class="sxs-lookup"><span data-stu-id="f39f3-105">The *OPC Proxy* establishes a connection to IoT Hub.</span></span> <span data-ttu-id="f39f3-106">O *Proxy OPC* aguarda então as mensagens de comando e controle do navegador de OPC integrado que é executado no portal da solução de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="f39f3-106">The *OPC Proxy* then waits for command and control messages from the integrated OPC Browser that runs in the connected factory solution portal.</span></span>
* <span data-ttu-id="f39f3-107">O *Publicador OPC* conecta-se a servidores OPC UA locais existentes e encaminha mensagens de telemetria deles para o Hub IoT.</span><span class="sxs-lookup"><span data-stu-id="f39f3-107">The *OPC Publisher* connects to existing on-premises OPC UA servers and forwards telemetry messages from them to IoT Hub.</span></span>

<span data-ttu-id="f39f3-108">Ambos os componentes são de código livre e estão disponíveis como origem no GitHub e nos contêineres do Docker:</span><span class="sxs-lookup"><span data-stu-id="f39f3-108">Both components are open-source and are available as source on GitHub and as Docker containers:</span></span>

| <span data-ttu-id="f39f3-109">GitHub</span><span class="sxs-lookup"><span data-stu-id="f39f3-109">GitHub</span></span> | <span data-ttu-id="f39f3-110">DockerHub</span><span class="sxs-lookup"><span data-stu-id="f39f3-110">DockerHub</span></span> |
| ------ | --------- |
| <span data-ttu-id="f39f3-111">[Publicador OPC][lnk-publisher-github]</span><span class="sxs-lookup"><span data-stu-id="f39f3-111">[OPC Publisher][lnk-publisher-github]</span></span> | <span data-ttu-id="f39f3-112">[Publicador OPC][lnk-publisher-docker]</span><span class="sxs-lookup"><span data-stu-id="f39f3-112">[OPC Publisher][lnk-publisher-docker]</span></span> |
| <span data-ttu-id="f39f3-113">[Proxy OPC][lnk-proxy-github]</span><span class="sxs-lookup"><span data-stu-id="f39f3-113">[OPC Proxy][lnk-proxy-github]</span></span> | <span data-ttu-id="f39f3-114">[Proxy OPC][lnk-proxy-docker]</span><span class="sxs-lookup"><span data-stu-id="f39f3-114">[OPC Proxy][lnk-proxy-docker]</span></span> |

<span data-ttu-id="f39f3-115">Nenhum endereço IP voltado ao público nem falhas no firewall do gateway são necessários para nenhum desses componentes.</span><span class="sxs-lookup"><span data-stu-id="f39f3-115">No public-facing IP address or holes in the gateway firewall are required for either component.</span></span> <span data-ttu-id="f39f3-116">O Proxy OPC e o Publicador OPC usam somente as portas de saída 443, 5671 e 8883.</span><span class="sxs-lookup"><span data-stu-id="f39f3-116">The OPC Proxy and OPC Publisher use only outbound ports 443, 5671, and 8883.</span></span>

<span data-ttu-id="f39f3-117">As etapas neste artigo mostram como implantar um gateway usando o Docker no [Windows](#windows-deployment) ou [Linux](#linux-deployment).</span><span class="sxs-lookup"><span data-stu-id="f39f3-117">The steps in this article show you how to deploy a gateway using Docker on either [Windows](#windows-deployment) or [Linux](#linux-deployment).</span></span> <span data-ttu-id="f39f3-118">O gateway permite conectividade com a solução pré-configurada de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="f39f3-118">The gateway enables connectivity to the connected factory preconfigured solution.</span></span>

> [!NOTE]
> <span data-ttu-id="f39f3-119">O software do gateway que é executado no contêiner do Docker é o [Azure IoT Edge].</span><span class="sxs-lookup"><span data-stu-id="f39f3-119">The gateway software that runs in the Docker container is [Azure IoT Edge].</span></span>

## <a name="windows-deployment"></a><span data-ttu-id="f39f3-120">Implantação no Windows</span><span class="sxs-lookup"><span data-stu-id="f39f3-120">Windows deployment</span></span>

> [!NOTE]
> <span data-ttu-id="f39f3-121">Se você ainda não tem um dispositivo de gateway, a Microsoft aconselha a comprar um gateway comercial de um de nossos parceiros.</span><span class="sxs-lookup"><span data-stu-id="f39f3-121">If you don't yet have a gateway device, Microsoft recommends you buy a commercial gateway from one of our partners.</span></span> <span data-ttu-id="f39f3-122">Veja o [catálogo de dispositivos do Azure IoT] para obter uma lista de dispositivos de gateway compatíveis com a solução de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="f39f3-122">Visit the [Azure IoT device catalog] for a list of gateway devices compatible with the connected factory solution.</span></span> <span data-ttu-id="f39f3-123">Siga as instruções que acompanham o dispositivo para configurar o gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-123">Follow the instructions that come with the device to set up the gateway.</span></span> <span data-ttu-id="f39f3-124">Se preferir, use as instruções a seguir para configurar manualmente um dos seus gateways existentes.</span><span class="sxs-lookup"><span data-stu-id="f39f3-124">Alternatively, use the following instructions to manually set up one of your existing gateways.</span></span>

### <a name="install-docker"></a><span data-ttu-id="f39f3-125">Instalar o Docker</span><span class="sxs-lookup"><span data-stu-id="f39f3-125">Install Docker</span></span>

<span data-ttu-id="f39f3-126">Instale o [Docker para Windows] no seu dispositivo de gateway baseado no Windows.</span><span class="sxs-lookup"><span data-stu-id="f39f3-126">Install [Docker for Windows] on your Windows-based gateway device.</span></span> <span data-ttu-id="f39f3-127">Durante a configuração do Docker no Windows, selecione uma unidade no seu computador host para compartilhar com o Docker.</span><span class="sxs-lookup"><span data-stu-id="f39f3-127">During Windows Docker setup, select a drive on your host machine to share with Docker.</span></span> <span data-ttu-id="f39f3-128">A seguinte captura de tela mostra o compartilhamento da unidade D no sistema Windows:</span><span class="sxs-lookup"><span data-stu-id="f39f3-128">The following screenshot shows sharing the D drive on your Windows system:</span></span>

![Instalar o Docker][img-install-docker]

<span data-ttu-id="f39f3-130">Em seguida, crie uma pasta chamada **docker** na raiz da unidade compartilhada.</span><span class="sxs-lookup"><span data-stu-id="f39f3-130">Then create a folder called **docker** in the root of the shared drive.</span></span>
<span data-ttu-id="f39f3-131">Você também pode executar essa etapa após a instalação do docker usando o menu **Configurações**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-131">You can also perform this step after installing docker from the **Settings** menu.</span></span>

### <a name="configure-the-gateway"></a><span data-ttu-id="f39f3-132">Configurar o gateway</span><span class="sxs-lookup"><span data-stu-id="f39f3-132">Configure the gateway</span></span>

1. <span data-ttu-id="f39f3-133">Você precisa da cadeia de conexão **iothubowner** da sua implantação de fábrica conectada do Azure IoT Suite para concluir a implantação do gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-133">You need the **iothubowner** connection string of your Azure IoT Suite connected factory deployment to complete the gateway deployment.</span></span> <span data-ttu-id="f39f3-134">No [portal do Azure], navegue até o Hub IoT no grupo de recursos criado quando você implantou a solução de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="f39f3-134">In the [Azure portal], navigate to your IoT Hub in the resource group created when you deployed the connected factory solution.</span></span> <span data-ttu-id="f39f3-135">Clique em **Políticas de acesso compartilhado** para acessar a cadeia de conexão **iothubowner**:</span><span class="sxs-lookup"><span data-stu-id="f39f3-135">Click **Shared access policies** to access the **iothubowner** connection string:</span></span>

    ![Localizar a cadeia de conexão Hub IoT][img-hub-connection]

    <span data-ttu-id="f39f3-137">Copie o valor de **Cadeia de conexão – chave primária**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-137">Copy the **Connection string--primary key** value.</span></span>

1. <span data-ttu-id="f39f3-138">Configure o gateway para o Hub IoT executando os dois módulos de gateway **uma vez** em um prompt de comando com:</span><span class="sxs-lookup"><span data-stu-id="f39f3-138">Configure the gateway for your IoT Hub by running the two gateway modules **once** from a command prompt with:</span></span>

    `docker run -it --rm -h <ApplicationName> -v //D/docker:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/CertificateStores -v //D/docker:/root/.dotnet/corefx/cryptography/x509stores microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName> "<IoTHubOwnerConnectionString>"`

    `docker run -it --rm -v //D/docker:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -i -c "<IoTHubOwnerConnectionString>" -D /mapped/cs.db`

    * <span data-ttu-id="f39f3-139">**&lt;ApplicationName&gt;** é o nome a dar ao Publicador OPC UA no formato **publisher.&lt;seu nome de domínio totalmente qualificado&gt;**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-139">**&lt;ApplicationName&gt;** is the name to give to your OPC UA Publisher in the format **publisher.&lt;your fully qualified domain name&gt;**.</span></span> <span data-ttu-id="f39f3-140">Por exemplo, se sua rede de fábrica é chamada **myfactorynetwork.com**, o valor de **ApplicationName** é **publisher.myfactorynetwork.com**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-140">For example, if your factory network is called **myfactorynetwork.com**, the **ApplicationName** value is **publisher.myfactorynetwork.com**.</span></span>
    * <span data-ttu-id="f39f3-141">**&lt;IoTHubOwnerConnectionString&gt;** é a cadeia de conexão **iothubowner** que você copiou na etapa anterior.</span><span class="sxs-lookup"><span data-stu-id="f39f3-141">**&lt;IoTHubOwnerConnectionString&gt;** is the **iothubowner** connection string you copied in the previous step.</span></span> <span data-ttu-id="f39f3-142">Essa cadeia de conexão é usada apenas nessa etapa e você não precisará dela nas próximas etapas:</span><span class="sxs-lookup"><span data-stu-id="f39f3-142">This connection string is only used in this step, you don’t need it in the following steps:</span></span>

    <span data-ttu-id="f39f3-143">Você usa a pasta D:\\docker mapeada (o argumento `-v`) posteriormente para persistir os dois certificados X.509 usados pelos módulos de gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-143">You use the mapped D:\\docker folder (the `-v` argument) later to persist the two X.509 certificates that the gateway modules use.</span></span>

### <a name="run-the-gateway"></a><span data-ttu-id="f39f3-144">Executar o gateway</span><span class="sxs-lookup"><span data-stu-id="f39f3-144">Run the gateway</span></span>

1. <span data-ttu-id="f39f3-145">Reinicie o gateway usando os seguintes comandos:</span><span class="sxs-lookup"><span data-stu-id="f39f3-145">Restart the gateway using the following commands:</span></span>

    `docker run -it --rm -h <ApplicationName> --expose 62222 -p 62222:62222 -v //D/docker:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/Logs -v //D/docker:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/CertificateStores -v //D/docker:/shared -v //D/docker:/root/.dotnet/corefx/cryptography/x509stores -e _GW_PNFP="/shared/publishednodes.JSON" microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName>`

    `docker run -it --rm -v //D/docker:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -D /mapped/cs.db`

1. <span data-ttu-id="f39f3-146">Por motivos de segurança, os dois certificados X.509 persistidos na pasta D:\\docker contêm a chave privada.</span><span class="sxs-lookup"><span data-stu-id="f39f3-146">For security reasons, the two X.509 certificates persisted in the D:\\docker folder contain the private key.</span></span> <span data-ttu-id="f39f3-147">Limite o acesso a essa pasta às credenciais (normalmente **Administradores**) usadas para executar o contêiner do Docker.</span><span class="sxs-lookup"><span data-stu-id="f39f3-147">Limit access to this folder to the credentials (typically **Administrators**) you use to run the Docker container.</span></span> <span data-ttu-id="f39f3-148">Clique com o botão direito do mouse na pasta D:\\docker, escolha **Propriedades**, **Segurança** e, por fim, **Editar**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-148">Right-click the D:\\docker folder, choose **Properties**, then **Security**, and then **Edit**.</span></span> <span data-ttu-id="f39f3-149">Dê aos **Administradores** controle total e remova todas as outras pessoas:</span><span class="sxs-lookup"><span data-stu-id="f39f3-149">Give **Administrators** full control and remove everyone else:</span></span>

    ![Conceder permissões ao compartilhamento do Docker][img-docker-share]

1. <span data-ttu-id="f39f3-151">Verifique a conectividade de rede.</span><span class="sxs-lookup"><span data-stu-id="f39f3-151">Verify network connectivity.</span></span> <span data-ttu-id="f39f3-152">Em um prompt de comando, digite o comando `ping publisher.<your fully qualified domain name>` para efetuar ping no gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-152">From a command prompt, enter the command `ping publisher.<your fully qualified domain name>` to ping your gateway.</span></span> <span data-ttu-id="f39f3-153">Se o destino não estiver acessível, adicione o endereço IP e o nome do seu gateway ao arquivo de hosts no gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-153">If the destination is unreachable, add the IP address and name of your gateway to the hosts file on your gateway.</span></span> <span data-ttu-id="f39f3-154">O arquivo de hosts está localizado na pasta **Windows\\System32\\drivers\\etc**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-154">The hosts file is located in the **Windows\\System32\\drivers\\etc** folder.</span></span>

1. <span data-ttu-id="f39f3-155">Em seguida, tente se conectar ao publicador usando um cliente OPC UA local em execução no gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-155">Next, try to connect to the publisher using a local OPC UA client running on the gateway.</span></span> <span data-ttu-id="f39f3-156">A URL do ponto de extremidade OPC UA é `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span><span class="sxs-lookup"><span data-stu-id="f39f3-156">The OPC UA endpoint URL is `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span></span> <span data-ttu-id="f39f3-157">Caso não tenha um cliente OPC UA, você poderá baixar e usar um [cliente OPC UA de software livre].</span><span class="sxs-lookup"><span data-stu-id="f39f3-157">If you don't have an OPC UA client, you can download and use an [open-source OPC UA client].</span></span>

1. <span data-ttu-id="f39f3-158">Quando tiver concluído com êxito esses testes locais, navegue até a página **Conectar seu próprio Servidor OPC UA** no portal de solução de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="f39f3-158">When you have successfully completed these local tests, browse to the **Connect your own OPC UA Server** page in the connected factory solution portal.</span></span> <span data-ttu-id="f39f3-159">Insira a URL de ponto de extremidade do publicador (`tcp://publisher.<your fully qualified domain name>:62222`) e clique em **Conectar**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-159">Enter the publisher endpoint URL (`tcp://publisher.<your fully qualified domain name>:62222`) and click **Connect**.</span></span> <span data-ttu-id="f39f3-160">Você recebe um aviso de certificado. Clique em **Continuar.**</span><span class="sxs-lookup"><span data-stu-id="f39f3-160">You get a certificate warning, then click **Proceed.**</span></span> <span data-ttu-id="f39f3-161">Em seguida, você verá um erro informando que o publicador não confia no UA Web Client.</span><span class="sxs-lookup"><span data-stu-id="f39f3-161">Next you get an error that the publisher doesn’t trust the UA Web Client.</span></span> <span data-ttu-id="f39f3-162">Para resolver esse erro, copie o certificado **UA Web Client** da pasta **D:\\docker\\Rejected Certificates\\certs** para a pasta **D:\\docker\\UA Applications\\certs** no gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-162">To resolve this error, copy the **UA Web Client** certificate from the **D:\\docker\\Rejected Certificates\\certs** folder to the **D:\\docker\\UA Applications\\certs** folder on the gateway.</span></span> <span data-ttu-id="f39f3-163">Não é preciso reiniciar o gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-163">You do not need to restart of the gateway.</span></span> <span data-ttu-id="f39f3-164">Repita esta etapa.</span><span class="sxs-lookup"><span data-stu-id="f39f3-164">Repeat this step.</span></span> <span data-ttu-id="f39f3-165">Agora, é possível se conectar ao gateway da nuvem e você está pronto para adicionar servidores OPC UA à solução.</span><span class="sxs-lookup"><span data-stu-id="f39f3-165">You can now connect to the gateway from the cloud, and you are ready to add OPC UA servers to the solution.</span></span>

### <a name="add-your-opc-ua-servers"></a><span data-ttu-id="f39f3-166">Adicionar os servidores OPC UA</span><span class="sxs-lookup"><span data-stu-id="f39f3-166">Add your OPC UA servers</span></span>

1. <span data-ttu-id="f39f3-167">Navegue até a página **Conectar seu próprio Servidor OPC UA** no portal de solução de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="f39f3-167">Browse to the **Connect your own OPC UA Server** page in the connected factory solution portal.</span></span> <span data-ttu-id="f39f3-168">Siga as mesmas etapas da seção anterior para estabelecer uma relação de confiança entre o portal da fábrica conectada e o servidor OPC UA.</span><span class="sxs-lookup"><span data-stu-id="f39f3-168">Follow the same steps as in the preceding section to establish trust between the connected factory portal and the OPC UA server.</span></span> <span data-ttu-id="f39f3-169">Esta etapa estabelece uma relação de confiança mútua dos certificados do portal da fábrica conectada e o servidor OPC UA e cria uma conexão.</span><span class="sxs-lookup"><span data-stu-id="f39f3-169">This step establishes a mutual trust of the certificates from the connected factory portal and the OPC UA server and creates a connection.</span></span>

1. <span data-ttu-id="f39f3-170">Procure a árvore de nós OPC UA do servidor OPC UA, clique com o botão direito do mouse nos nós OPC e selecione **publicar**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-170">Browse the OPC UA nodes tree of your OPC UA server, right-click the OPC nodes, and select **publish**.</span></span> <span data-ttu-id="f39f3-171">Para que a publicação funcione dessa maneira, o servidor OPC UA e o publicador devem estar na mesma rede.</span><span class="sxs-lookup"><span data-stu-id="f39f3-171">For publishing to work this way, the OPC UA server and the publisher must be on the same network.</span></span> <span data-ttu-id="f39f3-172">Em outras palavras, se o nome de domínio totalmente qualificado do publicador for **publicador.meudominio.com**, o nome de domínio totalmente qualificado do servidor OPC UA deverá ser, por exemplo, **meuservidoropcua.meudominio.com**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-172">In other words, if the fully qualified domain name of the publisher is **publisher.mydomain.com** then the fully qualified domain name of the OPC UA server must be, for example, **myopcuaserver.mydomain.com**.</span></span> <span data-ttu-id="f39f3-173">Se sua configuração for diferente, você poderá adicionar nós manualmente ao arquivo publishesnodes.json encontrado na pasta **D:\\docker**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-173">If your setup is different, you can manually add nodes to the publishesnodes.json file found in the **D:\\docker** folder.</span></span> <span data-ttu-id="f39f3-174">O arquivo publishesnodes.json é gerado automaticamente na primeira publicação bem-sucedida de um nó OPC.</span><span class="sxs-lookup"><span data-stu-id="f39f3-174">The publishesnodes.json file is automatically generated on the first successful publish of an OPC node.</span></span>

1. <span data-ttu-id="f39f3-175">Agora, a telemetria flui do dispositivo de gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-175">Telemetry now flows from the gateway device.</span></span> <span data-ttu-id="f39f3-176">Você pode ver a telemetria na exibição **Locais de Fábrica** do portal de fábrica conectada em **Nova Fábrica**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-176">You can view the telemetry in the **Factory Locations** view of the connected factory portal under **New Factory**.</span></span>

## <a name="linux-deployment"></a><span data-ttu-id="f39f3-177">Implantação no Linux</span><span class="sxs-lookup"><span data-stu-id="f39f3-177">Linux deployment</span></span>

> [!NOTE]
> <span data-ttu-id="f39f3-178">Se você ainda não tem um dispositivo de gateway, a Microsoft aconselha a comprar um gateway comercial de um de nossos parceiros.</span><span class="sxs-lookup"><span data-stu-id="f39f3-178">If you don't yet have a gateway device, Microsoft recommends you buy a commercial gateway from one of our partners.</span></span> <span data-ttu-id="f39f3-179">Veja o [catálogo de dispositivos do Azure IoT] para obter uma lista de dispositivos de gateway compatíveis com a solução de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="f39f3-179">Visit the [Azure IoT device catalog] for a list of gateway devices compatible with the connected factory solution.</span></span> <span data-ttu-id="f39f3-180">Siga as instruções que acompanham o dispositivo para configurar o gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-180">Follow the instructions that come with the device to set up the gateway.</span></span> <span data-ttu-id="f39f3-181">Se preferir, use as instruções a seguir para configurar manualmente um dos seus gateways existentes.</span><span class="sxs-lookup"><span data-stu-id="f39f3-181">Alternatively, use the following instructions to manually set up one of your existing gateways.</span></span>

<span data-ttu-id="f39f3-182">[Instale o Docker] em seu dispositivo de gateway Linux.</span><span class="sxs-lookup"><span data-stu-id="f39f3-182">[Install Docker] on your Linux gateway device.</span></span>

### <a name="configure-the-gateway"></a><span data-ttu-id="f39f3-183">Configurar o gateway</span><span class="sxs-lookup"><span data-stu-id="f39f3-183">Configure the gateway</span></span>

1. <span data-ttu-id="f39f3-184">Você precisa da cadeia de conexão **iothubowner** da sua implantação de fábrica conectada do Azure IoT Suite para concluir a implantação do gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-184">You need the **iothubowner** connection string of your Azure IoT Suite connected factory deployment to complete the gateway deployment.</span></span> <span data-ttu-id="f39f3-185">No [portal do Azure], navegue até o Hub IoT no grupo de recursos criado quando você implantou a solução de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="f39f3-185">In the [Azure portal], navigate to your IoT Hub in the resource group created when you deployed the connected factory solution.</span></span> <span data-ttu-id="f39f3-186">Clique em **Políticas de acesso compartilhado** para acessar a cadeia de conexão **iothubowner**:</span><span class="sxs-lookup"><span data-stu-id="f39f3-186">Click **Shared access policies** to access the **iothubowner** connection string:</span></span>

    ![Localizar a cadeia de conexão Hub IoT][img-hub-connection]

    <span data-ttu-id="f39f3-188">Copie o valor de **Cadeia de conexão – chave primária**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-188">Copy the **Connection string--primary key** value.</span></span>

1. <span data-ttu-id="f39f3-189">Configure o gateway para o Hub IoT executando os dois módulos de gateway **uma vez** em um shell com:</span><span class="sxs-lookup"><span data-stu-id="f39f3-189">Configure the gateway for your IoT Hub by running the two gateway modules **once** from a shell with:</span></span>

    `sudo docker run -it --rm -h <ApplicationName> -v /shared:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/ -v /shared:/root/.dotnet/corefx/cryptography/x509stores microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName> "<IoTHubOwnerConnectionString>"`

    `sudo docker run --rm -it -v /shared:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -i -c "<IoTHubOwnerConnectionString>" -D /mapped/cs.db`

    * <span data-ttu-id="f39f3-190">**&lt;ApplicationName&gt;** é o nome do aplicativo OPC UA que o gateway cria no formato **publicador.&lt;seu nome de domínio totalmente qualificado&gt;**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-190">**&lt;ApplicationName&gt;** is the name of the OPC UA application the gateway creates in the format **publisher.&lt;your fully qualified domain name&gt;**.</span></span> <span data-ttu-id="f39f3-191">Por exemplo, **publicador.microsoft.com**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-191">For example, **publisher.microsoft.com**.</span></span>
    * <span data-ttu-id="f39f3-192">**&lt;IoTHubOwnerConnectionString&gt;** é a cadeia de conexão **iothubowner** que você copiou na etapa anterior.</span><span class="sxs-lookup"><span data-stu-id="f39f3-192">**&lt;IoTHubOwnerConnectionString&gt;** is the **iothubowner** connection string you copied in the previous step.</span></span> <span data-ttu-id="f39f3-193">Essa cadeia de conexão é usada apenas nessa etapa e você não precisará dela nas próximas etapas:</span><span class="sxs-lookup"><span data-stu-id="f39f3-193">This connection string is only used in this step, you don’t need it in the following steps:</span></span>

    <span data-ttu-id="f39f3-194">Você usa a pasta **/shared** mapeada (o argumento `-v`) posteriormente para persistir os dois certificados X.509 usados pelos módulos de gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-194">You use the **/shared** folder (the `-v` argument) later to persist the two X.509 certificates that the gateway modules use.</span></span>

### <a name="run-the-gateway"></a><span data-ttu-id="f39f3-195">Executar o gateway</span><span class="sxs-lookup"><span data-stu-id="f39f3-195">Run the gateway</span></span>

1. <span data-ttu-id="f39f3-196">Reinicie o gateway usando os seguintes comandos:</span><span class="sxs-lookup"><span data-stu-id="f39f3-196">Restart the gateway using the following commands:</span></span>

    `sudo docker run -it -h <ApplicationName> --expose 62222 -p 62222:62222 –-rm -v /shared:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/Logs -v /shared:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/CertificateStores -v /shared:/shared -v /shared:/root/.dotnet/corefx/cryptography/x509stores -e _GW_PNFP="/shared/publishednodes.JSON" microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName>`

    `sudo docker run -it -v /shared:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -D /mapped/cs.db`

1. <span data-ttu-id="f39f3-197">Por motivos de segurança, os dois certificados X.509 persistidos na pasta **/shared** contêm a chave privada.</span><span class="sxs-lookup"><span data-stu-id="f39f3-197">For security reasons, the two X.509 certificates persisted in the **/shared** folder contain the private key.</span></span> <span data-ttu-id="f39f3-198">Limite o acesso a essa pasta às credenciais usadas para executar o contêiner do Docker.</span><span class="sxs-lookup"><span data-stu-id="f39f3-198">Limit access to this folder to the credentials you use to run the Docker container.</span></span> <span data-ttu-id="f39f3-199">Para definir as permissões apenas para **raiz**, use o comando do shell `chmod` na pasta.</span><span class="sxs-lookup"><span data-stu-id="f39f3-199">To set the permissions for **root** only, use the `chmod` shell command on the folder.</span></span>

1. <span data-ttu-id="f39f3-200">Verifique a conectividade de rede.</span><span class="sxs-lookup"><span data-stu-id="f39f3-200">Verify network connectivity.</span></span> <span data-ttu-id="f39f3-201">De um shell, digite o comando `ping publisher.<your fully qualified domain name>` para efetuar ping no gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-201">From a shell, enter the command `ping publisher.<your fully qualified domain name>` to ping your gateway.</span></span> <span data-ttu-id="f39f3-202">Se o destino não estiver acessível, adicione o endereço IP e o nome do seu gateway ao arquivo de hosts no gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-202">If the destination is unreachable, add the IP address and name of your gateway to your hosts file on your gateway.</span></span> <span data-ttu-id="f39f3-203">O arquivo de hosts está localizado na pasta **/etc**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-203">The hosts file is located in the **/etc** folder.</span></span>

1. <span data-ttu-id="f39f3-204">Em seguida, tente se conectar ao publicador usando um cliente OPC UA local em execução no gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-204">Next, try to connect to the publisher using a local OPC UA client running on the gateway.</span></span> <span data-ttu-id="f39f3-205">A URL do ponto de extremidade OPC UA é `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span><span class="sxs-lookup"><span data-stu-id="f39f3-205">The OPC UA endpoint URL is `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span></span> <span data-ttu-id="f39f3-206">Caso não tenha um cliente OPC UA, você poderá baixar e usar um [cliente OPC UA de software livre].</span><span class="sxs-lookup"><span data-stu-id="f39f3-206">If you don't have an OPC UA client, you can download and use an [open-source OPC UA client].</span></span>

1. <span data-ttu-id="f39f3-207">Quando tiver concluído com êxito esses testes locais, navegue até a página **Conectar seu próprio Servidor OPC UA** no portal de solução de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="f39f3-207">When you have successfully completed these local tests, browse to the **Connect your own OPC UA Server** page in the connected factory solution portal.</span></span> <span data-ttu-id="f39f3-208">Insira a URL de ponto de extremidade do publicador (`tcp://publisher.<your fully qualified domain name>:62222`) e clique em **Conectar**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-208">Enter the publisher endpoint URL (`tcp://publisher.<your fully qualified domain name>:62222`) and click **Connect**.</span></span> <span data-ttu-id="f39f3-209">Você recebe um aviso de certificado. Clique em **Continuar.**</span><span class="sxs-lookup"><span data-stu-id="f39f3-209">You get a certificate warning, then click **Proceed.**</span></span> <span data-ttu-id="f39f3-210">Em seguida, você verá um erro informando que o publicador não confia no UA Web Client.</span><span class="sxs-lookup"><span data-stu-id="f39f3-210">Next you get an error that the publisher doesn’t trust the UA Web Client.</span></span> <span data-ttu-id="f39f3-211">Para resolver esse erro, copie o certificado **UA Web Client** da pasta **/shared/Rejected Certificates/certs** para a pasta **/shared/UA Applications/certs** no gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-211">To resolve this error, copy the **UA Web Client** certificate from the **/shared/Rejected Certificates/certs** folder to the **/shared/UA Applications/certs** folder on the gateway.</span></span> <span data-ttu-id="f39f3-212">Não é preciso reiniciar o gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-212">You do not need to restart of the gateway.</span></span> <span data-ttu-id="f39f3-213">Repita esta etapa.</span><span class="sxs-lookup"><span data-stu-id="f39f3-213">Repeat this step.</span></span> <span data-ttu-id="f39f3-214">Agora, é possível se conectar ao gateway da nuvem e você está pronto para adicionar servidores OPC UA à solução.</span><span class="sxs-lookup"><span data-stu-id="f39f3-214">You can now connect to the gateway from the cloud, and you are ready to add OPC UA servers to the solution.</span></span>

### <a name="add-your-opc-ua-servers"></a><span data-ttu-id="f39f3-215">Adicionar os servidores OPC UA</span><span class="sxs-lookup"><span data-stu-id="f39f3-215">Add your OPC UA servers</span></span>

1. <span data-ttu-id="f39f3-216">Navegue até a página **Conectar seu próprio Servidor OPC UA** no portal de solução de fábrica conectada.</span><span class="sxs-lookup"><span data-stu-id="f39f3-216">Browse to the **Connect your own OPC UA Server** page in the connected factory solution portal.</span></span> <span data-ttu-id="f39f3-217">Siga as mesmas etapas da seção anterior para estabelecer uma relação de confiança entre o portal da fábrica conectada e o servidor OPC UA.</span><span class="sxs-lookup"><span data-stu-id="f39f3-217">Follow the same steps as in the preceding section to establish trust between the connected factory portal and the OPC UA server.</span></span> <span data-ttu-id="f39f3-218">Esta etapa estabelece uma relação de confiança mútua dos certificados do portal da fábrica conectada e o servidor OPC UA e cria uma conexão.</span><span class="sxs-lookup"><span data-stu-id="f39f3-218">This step establishes a mutual trust of the certificates from the connected factory portal and the OPC UA server and creates a connection.</span></span>

1. <span data-ttu-id="f39f3-219">Procure a árvore de nós OPC UA do servidor OPC UA, clique com o botão direito do mouse nos nós OPC e selecione **publicar**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-219">Browse the OPC UA nodes tree of your OPC UA server, right-click the OPC nodes, and select **publish**.</span></span> <span data-ttu-id="f39f3-220">Para que a publicação funcione dessa maneira, o servidor OPC UA e o publicador devem estar na mesma rede.</span><span class="sxs-lookup"><span data-stu-id="f39f3-220">For publishing to work this way, the OPC UA server and the publisher must be on the same network.</span></span> <span data-ttu-id="f39f3-221">Em outras palavras, se o nome de domínio totalmente qualificado do publicador for **publicador.meudominio.com**, o nome de domínio totalmente qualificado do servidor OPC UA deverá ser, por exemplo, **meuservidoropcua.meudominio.com**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-221">In other words, if the fully qualified domain name of the publisher is **publisher.mydomain.com** then the fully qualified domain name of the OPC UA server must be, for example, **myopcuaserver.mydomain.com**.</span></span> <span data-ttu-id="f39f3-222">Se sua configuração for diferente, você poderá adicionar nós manualmente ao arquivo publishesnodes.json encontrado na pasta **/shared**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-222">If your setup is different, you can manually add nodes to the publishesnodes.json file found in the **/shared** folder.</span></span> <span data-ttu-id="f39f3-223">O publishesnodes.json é gerado automaticamente na primeira publicação bem-sucedida de um nó OPC.</span><span class="sxs-lookup"><span data-stu-id="f39f3-223">The publishesnodes.json is automatically generated on the first successful publish of an OPC node.</span></span>

1. <span data-ttu-id="f39f3-224">Agora, a telemetria flui do dispositivo de gateway.</span><span class="sxs-lookup"><span data-stu-id="f39f3-224">Telemetry now flows from the gateway device.</span></span> <span data-ttu-id="f39f3-225">Você pode ver a telemetria na exibição **Locais de Fábrica** do portal de fábrica conectada em **Nova Fábrica**.</span><span class="sxs-lookup"><span data-stu-id="f39f3-225">You can view the telemetry in the **Factory Locations** view of the connected factory portal under **New Factory**.</span></span>

## <a name="next-steps"></a><span data-ttu-id="f39f3-226">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="f39f3-226">Next steps</span></span>

<span data-ttu-id="f39f3-227">Para saber mais sobre a arquitetura da solução pré-configurada de fábrica conectada, confira [Passo a passo da solução pré-configurada de fábrica conectada][lnk-walkthrough].</span><span class="sxs-lookup"><span data-stu-id="f39f3-227">To learn more about the architecture of the connected factory preconfigured solution, see [Connected factory preconfigured solution walkthrough][lnk-walkthrough].</span></span>

[img-install-docker]: ./media/iot-suite-connected-factory-gateway-deployment/image1.png
[img-hub-connection]: ./media/iot-suite-connected-factory-gateway-deployment/image2.png
[img-docker-share]: ./media/iot-suite-connected-factory-gateway-deployment/image3.png

<span data-ttu-id="f39f3-228">[Docker para Windows]: https://www.docker.com/docker-windows</span><span class="sxs-lookup"><span data-stu-id="f39f3-228">[Docker for Windows]: https://www.docker.com/docker-windows</span></span>
<span data-ttu-id="f39f3-229">[catálogo de dispositivos do Azure IoT]: https://catalog.azureiotsuite.com/?q=opc</span><span class="sxs-lookup"><span data-stu-id="f39f3-229">[Azure IoT device catalog]: https://catalog.azureiotsuite.com/?q=opc</span></span>
<span data-ttu-id="f39f3-230">[portal do Azure]: http://portal.azure.com/</span><span class="sxs-lookup"><span data-stu-id="f39f3-230">[Azure portal]: http://portal.azure.com/</span></span>
<span data-ttu-id="f39f3-231">[cliente OPC UA de software livre]: https://github.com/OPCFoundation/UA-.NETStandardLibrary/tree/master/SampleApplications/Samples/Client.Net4</span><span class="sxs-lookup"><span data-stu-id="f39f3-231">[open-source OPC UA client]: https://github.com/OPCFoundation/UA-.NETStandardLibrary/tree/master/SampleApplications/Samples/Client.Net4</span></span>
<span data-ttu-id="f39f3-232">[Instale o Docker]: https://www.docker.com/community-edition#/download</span><span class="sxs-lookup"><span data-stu-id="f39f3-232">[Install Docker]: https://www.docker.com/community-edition#/download</span></span>
[lnk-walkthrough]: iot-suite-connected-factory-sample-walkthrough.md
<span data-ttu-id="f39f3-233">[Azure IoT Edge]: https://github.com/Azure/iot-edge</span><span class="sxs-lookup"><span data-stu-id="f39f3-233">[Azure IoT Edge]: https://github.com/Azure/iot-edge</span></span>

[lnk-publisher-github]: https://github.com/Azure/iot-edge-opc-publisher
[lnk-publisher-docker]: https://hub.docker.com/r/microsoft/iot-gateway-opc-ua
[lnk-proxy-github]: https://github.com/Azure/iot-edge-opc-proxy
[lnk-proxy-docker]: https://hub.docker.com/r/microsoft/iot-gateway-opc-ua-proxy