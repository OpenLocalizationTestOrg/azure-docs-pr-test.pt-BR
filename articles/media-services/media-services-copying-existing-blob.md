---
title: "Copiar blobs de uma conta de armazenamento para um ativo dos Serviços de Mídia do Azure | Microsoft Docs"
description: "Este tópico mostra como copiar um blob existente para um Ativo dos Serviços de Mídia. O exemplo usa Extensões do SDK do .NET dos Serviços de Mídia do Azure."
services: media-services
documentationcenter: 
author: Juliako
manager: cfowler
editor: 
ms.assetid: 6a63823f-f3c9-424c-91b8-566f70bec346
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: ne
ms.topic: article
ms.date: 08/03/2017
ms.author: juliako
ms.openlocfilehash: 2bc1f0114a096920d4a7c9cb57e44c9b3612bf86
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/29/2017
---
# <a name="copying-existing-blobs-into-a-media-services-asset"></a><span data-ttu-id="99b8e-104">Copiar blobs existentes para um ativo dos Serviços de Mídia</span><span class="sxs-lookup"><span data-stu-id="99b8e-104">Copying existing blobs into a Media Services Asset</span></span>
<span data-ttu-id="99b8e-105">Este tópico mostra como copiar os blobs de uma conta de armazenamento para um novo ativo dos AMS (Serviços de Mídia do Azure) usando as [Extensões do SDK do .NET dos Serviços de Mídia do Azure](https://github.com/Azure/azure-sdk-for-media-services-extensions/).</span><span class="sxs-lookup"><span data-stu-id="99b8e-105">This topic shows how to copy blobs from a storage account into a new Azure Media Services (AMS) asset using [Azure Media Services .NET SDK Extensions](https://github.com/Azure/azure-sdk-for-media-services-extensions/).</span></span>

<span data-ttu-id="99b8e-106">Os métodos de extensão funcionam com:</span><span class="sxs-lookup"><span data-stu-id="99b8e-106">The extension methods works with:</span></span>

- <span data-ttu-id="99b8e-107">Ativos regulares.</span><span class="sxs-lookup"><span data-stu-id="99b8e-107">Regular assets.</span></span>
- <span data-ttu-id="99b8e-108">Ativos de arquivamento dinâmico (formato FragBlob).</span><span class="sxs-lookup"><span data-stu-id="99b8e-108">Live archive assets (FragBlob format).</span></span>
- <span data-ttu-id="99b8e-109">Ativos de origem e de destino que pertencem a contas de Serviços de Mídia diferentes (mesmo entre data centers diferentes).</span><span class="sxs-lookup"><span data-stu-id="99b8e-109">Source and destination assets belonging to different Media Services accounts (even across different data centers).</span></span> <span data-ttu-id="99b8e-110">No entanto, essa ação pode incorrer em encargos.</span><span class="sxs-lookup"><span data-stu-id="99b8e-110">However, there may be charges incurred by doing so.</span></span> <span data-ttu-id="99b8e-111">Para obter mais informações sobre preços, consulte o [Transferências de Dados](https://azure.microsoft.com/pricing/#header-11).</span><span class="sxs-lookup"><span data-stu-id="99b8e-111">For more information about pricing, see [Data Transfers](https://azure.microsoft.com/pricing/#header-11).</span></span>

> [!NOTE]
> <span data-ttu-id="99b8e-112">Você não deve tentar alterar o conteúdo de contêineres de blob que foram gerados pelos serviços de mídia sem o uso de APIs de serviços de mídia.</span><span class="sxs-lookup"><span data-stu-id="99b8e-112">You should not attempt to change the contents of blob containers that were generated by Media Services without using Media Service APIs.</span></span>
> 

<span data-ttu-id="99b8e-113">O tópico mostra dois exemplos de código:</span><span class="sxs-lookup"><span data-stu-id="99b8e-113">The topic shows two code samples:</span></span>

1. <span data-ttu-id="99b8e-114">Copie blobs de um ativo em uma conta do AMS para um novo ativo em outra conta do AMS.</span><span class="sxs-lookup"><span data-stu-id="99b8e-114">Copy blobs from an asset in one AMS account into a new asset in another AMS account.</span></span>
2. <span data-ttu-id="99b8e-115">Copie blobs de alguma conta de armazenamento para um novo ativo em uma conta do AMS.</span><span class="sxs-lookup"><span data-stu-id="99b8e-115">Copy blobs from some storage account into a new asset in an AMS account.</span></span>

## <a name="copy-blobs-between-two-ams-accounts"></a><span data-ttu-id="99b8e-116">Copiar blobs entre duas contas do AMS</span><span class="sxs-lookup"><span data-stu-id="99b8e-116">Copy blobs between two AMS accounts</span></span>  

### <a name="prerequisites"></a><span data-ttu-id="99b8e-117">Pré-requisitos</span><span class="sxs-lookup"><span data-stu-id="99b8e-117">Prerequisites</span></span>

<span data-ttu-id="99b8e-118">Duas contas dos Serviços de Mídia.</span><span class="sxs-lookup"><span data-stu-id="99b8e-118">Two Media Services accounts.</span></span> <span data-ttu-id="99b8e-119">Confira o tópico [Criar uma conta dos Serviços de Mídia](media-services-portal-create-account.md).</span><span class="sxs-lookup"><span data-stu-id="99b8e-119">See the topic [How to Create a Media Services Account](media-services-portal-create-account.md).</span></span>

### <a name="download-sample"></a><span data-ttu-id="99b8e-120">Baixar exemplo</span><span class="sxs-lookup"><span data-stu-id="99b8e-120">Download sample</span></span>
<span data-ttu-id="99b8e-121">Você pode seguir as etapas deste artigo ou baixar um exemplo que contém o código descrito [neste](https://azure.microsoft.com/documentation/samples/media-services-dotnet-copy-blob-into-asset/) artigo.</span><span class="sxs-lookup"><span data-stu-id="99b8e-121">You can follow the steps in this article or you can download a sample that contains the code described in this article from [here](https://azure.microsoft.com/documentation/samples/media-services-dotnet-copy-blob-into-asset/).</span></span>

### <a name="set-up-your-project"></a><span data-ttu-id="99b8e-122">Configurar o seu projeto</span><span class="sxs-lookup"><span data-stu-id="99b8e-122">Set up your project</span></span>

1. <span data-ttu-id="99b8e-123">Configure seu ambiente de desenvolvimento, conforme descrito em [Desenvolvimento de Serviços de Mídia com o .NET](media-services-dotnet-how-to-use.md).</span><span class="sxs-lookup"><span data-stu-id="99b8e-123">Set up your development environment as described in [Media Services development with .NET](media-services-dotnet-how-to-use.md).</span></span> 
2. <span data-ttu-id="99b8e-124">Adicione outras referências que são necessárias para este projeto: System.Configuration.</span><span class="sxs-lookup"><span data-stu-id="99b8e-124">Add other references that are required for this project: System.Configuration.</span></span>
3. <span data-ttu-id="99b8e-125">Adicione a seção appSettings ao arquivo .config e atualize os valores com base em suas contas de Serviços de Mídia, na conta de armazenamento de destino e na ID do ativo de origem.</span><span class="sxs-lookup"><span data-stu-id="99b8e-125">Add the appSettings section to the .config file and update the values based on your Media Services accounts, the destination storage account and the source asset ID.</span></span>  

```   
<appSettings>
    <add key="AMSSourceAADTenantDomain" value="AADTenantDomain"/>
    <add key="AMSSourceRESTAPIEndpoint" value="RESTAPIEndpoint"/>
    <add key="AMSDestAADTenantDomain" value="AADTenantDomain"/>
    <add key="AMSDestRESTAPIEndpoint" value="RESTAPIEndpoint"/>
    <add key="DestStorageAccountName" value="name"/>
    <add key="DestStorageAccountKey" value="key"/>
    <add key="SourceAssetID" value="nb:cid:UUID:assetID"/>
</appSettings>
```

### <a name="copy-blobs-from-an-asset-in-one-ams-account-into-an-asset-in-another-ams-account"></a><span data-ttu-id="99b8e-126">Copiar blobs de um ativo em uma conta do AMS para um ativo em outra conta do AMS</span><span class="sxs-lookup"><span data-stu-id="99b8e-126">Copy blobs from an asset in one AMS account into an asset in another AMS account</span></span>

<span data-ttu-id="99b8e-127">O código a seguir usa o método da extensão **IAsset.Copy** para copiar todos os arquivos do ativo de origem para o ativo de destino usando uma única extensão.</span><span class="sxs-lookup"><span data-stu-id="99b8e-127">The following code uses extension **IAsset.Copy** method to copy all files in the source asset into the destination asset using a single extension.</span></span>

```
using System;
using Microsoft.WindowsAzure.MediaServices.Client;
using System.Linq;
using System.Configuration;
using Microsoft.WindowsAzure.Storage.Auth;

namespace CopyExistingBlobsIntoAsset
{
    class Program
    {
        static string _sourceAADTenantDomain = ConfigurationManager.AppSettings["AMSSourceAADTenantDomain"];
        static string _sourceRESTAPIEndpoint = ConfigurationManager.AppSettings["AMSSourceRESTAPIEndpoint"];
        static string _destAADTenantDomain = ConfigurationManager.AppSettings["AMSDestAADTenantDomain"];
        static string _destRESTAPIEndpoint = ConfigurationManager.AppSettings["AMSDestRESTAPIEndpoint"];
        static string _destStorageAccountName = ConfigurationManager.AppSettings["DestStorageAccountName"];
        static string _destStorageAccountKey = ConfigurationManager.AppSettings["DestStorageAccountKey"];
        static string _sourceAssetID = ConfigurationManager.AppSettings["SourceAssetID"];

        private static CloudMediaContext _sourceContext = null;
        private static CloudMediaContext _destContext = null;

        static void Main(string[] args)
        {
            var tokenCredentials1 = new AzureAdTokenCredentials(_sourceAADTenantDomain, AzureEnvironments.AzureCloudEnvironment);
            var tokenProvider1 = new AzureAdTokenProvider(tokenCredentials1);
            var tokenCredentials2 = new AzureAdTokenCredentials(_destAADTenantDomain, AzureEnvironments.AzureCloudEnvironment);
            var tokenProvider2 = new AzureAdTokenProvider(tokenCredentials2);

            // Create the context for your source Media Services account.
            _sourceContext = new CloudMediaContext(new Uri(_sourceRESTAPIEndpoint), tokenProvider1);

            // Create the context for your destination Media Services account.
            _destContext = new CloudMediaContext(new Uri(_destRESTAPIEndpoint), tokenProvider2);

            // Get the credentials of the default Storage account bound to your destination Media Services account.
            StorageCredentials destinationStorageCredentials =
                new StorageCredentials(_destStorageAccountName, _destStorageAccountKey);

            // Get a reference to the source asset in the source context.
            IAsset sourceAsset = _sourceContext.Assets.Where(a => a.Id == _sourceAssetID).First();

            // Create an empty destination asset in the destination context.
            IAsset destinationAsset = _destContext.Assets.Create(sourceAsset.Name, AssetCreationOptions.None);

            // Copy the files in the source asset instance into the destination asset instance.
            sourceAsset.Copy(destinationAsset, destinationStorageCredentials);

            Console.WriteLine("Done");
        }
    }
}
```

## <a name="copy-blobs-from-a-storage-account-into-an-ams-account"></a><span data-ttu-id="99b8e-128">Copiar blobs de uma conta de armazenamento para uma conta do AMS</span><span class="sxs-lookup"><span data-stu-id="99b8e-128">Copy blobs from a storage account into an AMS account</span></span> 

### <a name="prerequisites"></a><span data-ttu-id="99b8e-129">Pré-requisitos</span><span class="sxs-lookup"><span data-stu-id="99b8e-129">Prerequisites</span></span>

- <span data-ttu-id="99b8e-130">Uma conta de armazenamento do qual você deseja copiar blobs.</span><span class="sxs-lookup"><span data-stu-id="99b8e-130">One Storage account from which you want to copy blobs.</span></span>
- <span data-ttu-id="99b8e-131">Uma conta do AMS para qual você deseja copiar blobs.</span><span class="sxs-lookup"><span data-stu-id="99b8e-131">One AMS account into which you want to copy blobs.</span></span>

### <a name="set-up-your-project"></a><span data-ttu-id="99b8e-132">Configurar o seu projeto</span><span class="sxs-lookup"><span data-stu-id="99b8e-132">Set up your project</span></span>

1. <span data-ttu-id="99b8e-133">Configure seu ambiente de desenvolvimento, conforme descrito em [Desenvolvimento de Serviços de Mídia com o .NET](media-services-dotnet-how-to-use.md).</span><span class="sxs-lookup"><span data-stu-id="99b8e-133">Set up your development environment as described in [Media Services development with .NET](media-services-dotnet-how-to-use.md).</span></span> 
2. <span data-ttu-id="99b8e-134">Adicione outras referências que são necessárias para este projeto: System.Configuration.</span><span class="sxs-lookup"><span data-stu-id="99b8e-134">Add other references that are required for this project: System.Configuration.</span></span>
3. <span data-ttu-id="99b8e-135">Adicione a seção appSettings ao arquivo .config e atualize os valores com base em suas contas do AMS de armazenamento de origem e destino.</span><span class="sxs-lookup"><span data-stu-id="99b8e-135">Add the appSettings section to the .config file and update the values based on your source storage and destination AMS accounts.</span></span>

```
<appSettings>
  <add key="SourceStorageAccountName" value="name" />
  <add key="SourceStorageAccountKey" value="key" />
  <add key="AMSAADTenantDomain" value="tenant"/>
  <add key="AMSESTAPIEndpoint" value="endpoint"/>
  <add key="AMSStorageAccountName" value="name" />
  <add key="AMSStorageAccountKey" value="key" />
</appSettings>
```

### <a name="copy-blobs-from-some-storage-account-into-a-new-asset-in-a-ams-account"></a><span data-ttu-id="99b8e-136">Copiar blobs de alguma conta de armazenamento para um novo ativo na conta do AMS</span><span class="sxs-lookup"><span data-stu-id="99b8e-136">Copy blobs from some storage account into a new asset in a AMS account</span></span>

<span data-ttu-id="99b8e-137">O código a seguir copia blobs de uma conta de armazenamento para um ativo dos Serviços de Mídia.</span><span class="sxs-lookup"><span data-stu-id="99b8e-137">The following code copies blobs from a storage account into a Media Services asset.</span></span> 

>[!NOTE]
><span data-ttu-id="99b8e-138">Há um limite de 1.000.000 políticas para diferentes políticas de AMS (por exemplo, para política de Localizador ou ContentKeyAuthorizationPolicy).</span><span class="sxs-lookup"><span data-stu-id="99b8e-138">There is a limit of 1,000,000 policies for different AMS policies (for example, for Locator policy or ContentKeyAuthorizationPolicy).</span></span> <span data-ttu-id="99b8e-139">Use a mesma ID de política, se você estiver sempre usando os mesmos dias/permissões de acesso, por exemplo, políticas de localizadores que devem permanecer no local por um longo período (políticas de não carregamento).</span><span class="sxs-lookup"><span data-stu-id="99b8e-139">You should use the same policy ID if you are always using the same days / access permissions, for example, policies for locators that are intended to remain in place for a long time (non-upload policies).</span></span> <span data-ttu-id="99b8e-140">Para obter mais informações, consulte [este](media-services-dotnet-manage-entities.md#limit-access-policies) tópico.</span><span class="sxs-lookup"><span data-stu-id="99b8e-140">For more information, see [this](media-services-dotnet-manage-entities.md#limit-access-policies) topic.</span></span>

```
using System;
using System.Configuration;
using System.Linq;
using Microsoft.WindowsAzure.MediaServices.Client;
using Microsoft.WindowsAzure.Storage.Auth;
using Microsoft.WindowsAzure.Storage;
using Microsoft.WindowsAzure.Storage.Blob;
    
namespace CopyExistingBlobsIntoAsset
{
    class Program
    {
        // Read values from the App.config file.
        private static readonly string _AMSAADTenantDomain =
            ConfigurationManager.AppSettings["AMSAADTenantDomain"];
        private static readonly string _AMSRESTAPIEndpoint =
            ConfigurationManager.AppSettings["AMSESTAPIEndpoint"];
        private static readonly string _AMSStorageAccountName =
            ConfigurationManager.AppSettings["AMSStorageAccountName"];
        private static readonly string _AMSStorageAccountKey =
            ConfigurationManager.AppSettings["AMSStorageAccountKey"];
        private static readonly string _sourceStorageAccountName =
            ConfigurationManager.AppSettings["SourceStorageAccountName"];
        private static readonly string _sourceStorageAccountKey =
            ConfigurationManager.AppSettings["SourceStorageAccountKey"];

        // Field for service context.
        private static CloudMediaContext _context = null;
        private static CloudStorageAccount _sourceStorageAccount = null;
        private static CloudStorageAccount _destinationStorageAccount = null;

        static void Main(string[] args)
        {
            var tokenCredentials = new AzureAdTokenCredentials(_AMSAADTenantDomain, 
                AzureEnvironments.AzureCloudEnvironment);
            var tokenProvider = new AzureAdTokenProvider(tokenCredentials);

            // Create the context for your source Media Services account.
            _context = new CloudMediaContext(new Uri(_AMSRESTAPIEndpoint), tokenProvider);
            
            _sourceStorageAccount =
                new CloudStorageAccount(new StorageCredentials(_sourceStorageAccountName,
                    _sourceStorageAccountKey), true);

            _destinationStorageAccount =
                new CloudStorageAccount(new StorageCredentials(_AMSStorageAccountName,
                    _AMSStorageAccountKey), true);

            CloudBlobClient sourceCloudBlobClient =
                _sourceStorageAccount.CreateCloudBlobClient();
            CloudBlobContainer sourceContainer =
                sourceCloudBlobClient.GetContainerReference("NameOfBlobContainerYouWantToCopy");

            CreateAssetFromExistingBlobs(sourceContainer);

            Console.WriteLine("Done");
        }

        static public IAsset CreateAssetFromExistingBlobs(CloudBlobContainer sourceBlobContainer)
        {
            CloudBlobClient destBlobStorage = _destinationStorageAccount.CreateCloudBlobClient();

            // Create a new asset. 
            IAsset asset = _context.Assets.Create("NewAsset_" + Guid.NewGuid(), AssetCreationOptions.None);

            IAccessPolicy writePolicy = _context.AccessPolicies.Create("writePolicy",
                TimeSpan.FromHours(24), AccessPermissions.Write);

            ILocator destinationLocator =
                _context.Locators.CreateLocator(LocatorType.Sas, asset, writePolicy);

            // Get the asset container URI and Blob copy from mediaContainer to assetContainer. 
            CloudBlobContainer destAssetContainer =
                destBlobStorage.GetContainerReference((new Uri(destinationLocator.Path)).Segments[1]);

            if (destAssetContainer.CreateIfNotExists())
            {
                destAssetContainer.SetPermissions(new BlobContainerPermissions
                {
                    PublicAccess = BlobContainerPublicAccessType.Blob
                });
            }

            var blobList = sourceBlobContainer.ListBlobs();

            foreach (var sourceBlob in blobList)
            {
                var assetFile = asset.AssetFiles.Create((sourceBlob as ICloudBlob).Name);

                ICloudBlob destinationBlob = destAssetContainer.GetBlockBlobReference(assetFile.Name);

                CopyBlob(sourceBlob as ICloudBlob, destAssetContainer);

                assetFile.ContentFileSize = (sourceBlob as ICloudBlob).Properties.Length;
                assetFile.Update();
                Console.WriteLine("File {0} is of {1} size", assetFile.Name, assetFile.ContentFileSize);
            }

            asset.Update();

            destinationLocator.Delete();
            writePolicy.Delete();

            // Set the primary asset file.
            // If, for example, we copied a set of Smooth Streaming files, 
            // set the .ism file to be the primary file. 
            // If we, for example, copied an .mp4, then the mp4 would be the primary file. 
            var ismAssetFile = asset.AssetFiles.ToList().
                Where(f => f.Name.EndsWith(".ism", StringComparison.OrdinalIgnoreCase)).ToArray().FirstOrDefault();

            // The following code assigns the first .ism file as the primary file in the asset.
            // An asset should have one .ism file.  
            if (ismAssetFile != null)
            {
                ismAssetFile.IsPrimary = true;
                ismAssetFile.Update();
            }

            return asset;
        }

        /// <summary>
        /// Copies the specified blob into the specified container.
        /// </summary>
        /// <param name="sourceBlob">The source container.</param>
        /// <param name="destinationContainer">The destination container.</param>
        static private void CopyBlob(ICloudBlob sourceBlob, CloudBlobContainer destinationContainer)
        {
            var signature = sourceBlob.GetSharedAccessSignature(new SharedAccessBlobPolicy
            {
                Permissions = SharedAccessBlobPermissions.Read,
                SharedAccessExpiryTime = DateTime.UtcNow.AddHours(24)
            });

            ICloudBlob destinationBlob = destinationContainer.GetBlockBlobReference(sourceBlob.Name);

            if (destinationBlob.Exists())
            {
                Console.WriteLine(string.Format("Destination blob '{0}' already exists. Skipping.", destinationBlob.Uri));
            }
            else
            {

                // Display the size of the source blob.
                Console.WriteLine(sourceBlob.Properties.Length);

                Console.WriteLine(string.Format("Copy blob '{0}' to '{1}'", sourceBlob.Uri, destinationBlob.Uri));
                destinationBlob.StartCopyFromBlob(new Uri(sourceBlob.Uri.AbsoluteUri + signature));

                while (true)
                {
                    // The StartCopyFromBlob is an async operation, 
                    // so we want to check if the copy operation is completed before proceeding. 
                    // To do that, we call FetchAttributes on the blob and check the CopyStatus. 
                    destinationBlob.FetchAttributes();
                    if (destinationBlob.CopyState.Status != CopyStatus.Pending)
                    {
                        break;
                    }
                    //It's still not completed. So wait for some time.
                    System.Threading.Thread.Sleep(1000);
                }

                // Display the size of the destination blob.
                Console.WriteLine(destinationBlob.Properties.Length);

            }
        }
    }
}
```
## <a name="next-steps"></a><span data-ttu-id="99b8e-141">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="99b8e-141">Next steps</span></span>

<span data-ttu-id="99b8e-142">Agora você pode codificar seus ativos carregados.</span><span class="sxs-lookup"><span data-stu-id="99b8e-142">You can now encode your uploaded assets.</span></span> <span data-ttu-id="99b8e-143">Para saber mais, veja [Codificar ativos](media-services-portal-encode.md).</span><span class="sxs-lookup"><span data-stu-id="99b8e-143">For more information, see [Encode assets](media-services-portal-encode.md).</span></span>

<span data-ttu-id="99b8e-144">Você também pode usar as Azure Functions para disparar um trabalho de codificação baseado em um arquivo que chega no contêiner configurado.</span><span class="sxs-lookup"><span data-stu-id="99b8e-144">You can also use Azure Functions to trigger an encoding job based on a file arriving in the configured container.</span></span> <span data-ttu-id="99b8e-145">Para obter mais informações, confira [este exemplo](https://azure.microsoft.com/resources/samples/media-services-dotnet-functions-integration/ ).</span><span class="sxs-lookup"><span data-stu-id="99b8e-145">For more information, see [this sample](https://azure.microsoft.com/resources/samples/media-services-dotnet-functions-integration/ ).</span></span>

## <a name="media-services-learning-paths"></a><span data-ttu-id="99b8e-146">Roteiros de aprendizagem dos Serviços de Mídia</span><span class="sxs-lookup"><span data-stu-id="99b8e-146">Media Services learning paths</span></span>
[!INCLUDE [media-services-learning-paths-include](../../includes/media-services-learning-paths-include.md)]

## <a name="provide-feedback"></a><span data-ttu-id="99b8e-147">Fornecer comentários</span><span class="sxs-lookup"><span data-stu-id="99b8e-147">Provide feedback</span></span>
[!INCLUDE [media-services-user-voice-include](../../includes/media-services-user-voice-include.md)]

