---
title: "Autenticação do Azure Active Directory e Resource Manager | Microsoft Docs"
description: "Guia do desenvolvedor para autenticação com a API do Azure Resource Manager e o Azure Active Directory para integrar um aplicativo a outras assinaturas do Azure."
services: azure-resource-manager,active-directory
documentationcenter: na
author: dushyantgill
manager: timlt
editor: tysonn
ms.assetid: 17b2b40d-bf42-4c7d-9a88-9938409c5088
ms.service: azure-resource-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 12/27/2016
ms.author: dugill;tomfitz
ms.openlocfilehash: 7830dc4774652f4d108e98660dce3bcea7b32d05
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="use-resource-manager-authentication-api-to-access-subscriptions"></a><span data-ttu-id="08473-103">Usar API de autenticação do Resource Manager para acessar assinaturas</span><span class="sxs-lookup"><span data-stu-id="08473-103">Use Resource Manager authentication API to access subscriptions</span></span>
## <a name="introduction"></a><span data-ttu-id="08473-104">Introdução</span><span class="sxs-lookup"><span data-stu-id="08473-104">Introduction</span></span>
<span data-ttu-id="08473-105">Se você for um desenvolvedor de software que precisa criar um aplicativo que gerencie recursos do Azure de um cliente, este tópico mostra como fazer a autenticação com as APIs do Azure Resource Manager e obter acesso a recursos em outras assinaturas.</span><span class="sxs-lookup"><span data-stu-id="08473-105">If you are a software developer who needs to create an app that manages customer's Azure resources, this topic shows you how to authenticate with the Azure Resource Manager APIs and gain access to resources in other subscriptions.</span></span>

<span data-ttu-id="08473-106">Seu aplicativo pode acessar as APIs do Gerenciador de Recursos de duas maneiras:</span><span class="sxs-lookup"><span data-stu-id="08473-106">Your app can access the Resource Manager APIs in couple of ways:</span></span>

1. <span data-ttu-id="08473-107">**Acesso de aplicativo + usuário**: para aplicativos que acessam recursos em nome de um usuário conectado.</span><span class="sxs-lookup"><span data-stu-id="08473-107">**User + app access**: for apps that access resources on behalf of a signed-in user.</span></span> <span data-ttu-id="08473-108">Essa abordagem funciona para aplicativos, como aplicativos Web e ferramentas de linha de comando, que lidam apenas com "gerenciamento interativo" dos recursos do Azure.</span><span class="sxs-lookup"><span data-stu-id="08473-108">This approach works for apps, such as web apps and command-line tools, that deal with only "interactive management" of Azure resources.</span></span>
2. <span data-ttu-id="08473-109">**Acesso somente a aplicativos**: para aplicativos que executam serviços daemon e trabalhos agendados.</span><span class="sxs-lookup"><span data-stu-id="08473-109">**App-only access**: for apps that run daemon services and scheduled jobs.</span></span> <span data-ttu-id="08473-110">A identidade do aplicativo recebe acesso direto aos recursos.</span><span class="sxs-lookup"><span data-stu-id="08473-110">The app's identity is granted direct access to the resources.</span></span> <span data-ttu-id="08473-111">Essa abordagem funciona para aplicativos que precisam de acesso de administração remota (autônomo) de longo prazo ao Azure.</span><span class="sxs-lookup"><span data-stu-id="08473-111">This approach works for apps that need long-term headless (unattended) access to Azure.</span></span>

<span data-ttu-id="08473-112">Este tópico fornece instruções passo a passo para criar um aplicativo que utiliza ambos os métodos de autorização.</span><span class="sxs-lookup"><span data-stu-id="08473-112">This topic provides step-by-step instructions to create an app that employs both these authorization methods.</span></span> <span data-ttu-id="08473-113">Ele mostra como executar cada etapa com a API REST ou o C#.</span><span class="sxs-lookup"><span data-stu-id="08473-113">It shows how to perform each step with REST API or C#.</span></span> <span data-ttu-id="08473-114">O aplicativo ASP.NET MVC completo está disponível em [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span><span class="sxs-lookup"><span data-stu-id="08473-114">The complete ASP.NET MVC application is available at [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span></span>

## <a name="what-the-web-app-does"></a><span data-ttu-id="08473-115">O que o aplicativo Web faz</span><span class="sxs-lookup"><span data-stu-id="08473-115">What the web app does</span></span>
<span data-ttu-id="08473-116">O aplicativo Web:</span><span class="sxs-lookup"><span data-stu-id="08473-116">The web app:</span></span>

1. <span data-ttu-id="08473-117">Conecta um usuário do Azure.</span><span class="sxs-lookup"><span data-stu-id="08473-117">Signs-in an Azure user.</span></span>
2. <span data-ttu-id="08473-118">Solicita que o usuário conceda ao Resource Manager acesso ao aplicativo Web.</span><span class="sxs-lookup"><span data-stu-id="08473-118">Asks user to grant the web app access to Resource Manager.</span></span>
3. <span data-ttu-id="08473-119">Obtém o token de acesso de usuário + aplicativo acessando o Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="08473-119">Gets user + app access token for accessing Resource Manager.</span></span>
4. <span data-ttu-id="08473-120">Usa o token (obtido na etapa 3) para chamar o Resource Manager e atribuir a entidade de serviço do aplicativo a uma função na assinatura, o que confere ao aplicativo acesso de longo prazo à assinatura.</span><span class="sxs-lookup"><span data-stu-id="08473-120">Uses token (from step 3) to call Resource Manager and assign the app's service principal to a role in the subscription, which gives the app long-term access to the subscription.</span></span>
5. <span data-ttu-id="08473-121">Obtém o token de acesso somente ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="08473-121">Gets app-only access token.</span></span>
6. <span data-ttu-id="08473-122">Usa o token (obtido na etapa 5) para gerenciar recursos na assinatura por meio do Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="08473-122">Uses token (from step 5) to manage resources in the subscription through Resource Manager.</span></span>

<span data-ttu-id="08473-123">Veja o fluxo completo do aplicativo Web.</span><span class="sxs-lookup"><span data-stu-id="08473-123">Here's the end-to-end flow of the web application.</span></span>

![Fluxo de autenticação do Resource Manager](./media/resource-manager-api-authentication/Auth-Swim-Lane.png)

<span data-ttu-id="08473-125">Como um usuário, você fornece a ID da assinatura que quer usar:</span><span class="sxs-lookup"><span data-stu-id="08473-125">As a user, you provide the subscription id for the subscription you want to use:</span></span>

![fornecer ID de assinatura](./media/resource-manager-api-authentication/sample-ux-1.png)

<span data-ttu-id="08473-127">Escolha a conta a ser usada para fazer logon.</span><span class="sxs-lookup"><span data-stu-id="08473-127">Select the account to use for logging in.</span></span>

![escolher conta](./media/resource-manager-api-authentication/sample-ux-2.png)

<span data-ttu-id="08473-129">Forneça suas credenciais.</span><span class="sxs-lookup"><span data-stu-id="08473-129">Provide your credentials.</span></span>

![fornecer credenciais](./media/resource-manager-api-authentication/sample-ux-3.png)

<span data-ttu-id="08473-131">Conceda às suas assinaturas do Azure acesso ao aplicativo:</span><span class="sxs-lookup"><span data-stu-id="08473-131">Grant the app access to your Azure subscriptions:</span></span>

![Conceder acesso](./media/resource-manager-api-authentication/sample-ux-4.png)

<span data-ttu-id="08473-133">Gerencie as assinaturas conectadas:</span><span class="sxs-lookup"><span data-stu-id="08473-133">Manage your connected subscriptions:</span></span>

![Conectar assinatura](./media/resource-manager-api-authentication/sample-ux-7.png)

## <a name="register-application"></a><span data-ttu-id="08473-135">Registrar aplicativo</span><span class="sxs-lookup"><span data-stu-id="08473-135">Register application</span></span>
<span data-ttu-id="08473-136">Antes de iniciar a codificação, registre o aplicativo Web com o Azure AD (Active Directory).</span><span class="sxs-lookup"><span data-stu-id="08473-136">Before you start coding, register your web app with Azure Active Directory (AD).</span></span> <span data-ttu-id="08473-137">O registro do aplicativo cria uma identidade central para seu aplicativo no Azure AD.</span><span class="sxs-lookup"><span data-stu-id="08473-137">The app registration creates a central identity for your app in Azure AD.</span></span> <span data-ttu-id="08473-138">Ele contém informações básicas sobre seu aplicativo, como ID do Cliente OAuth, URLs de Resposta e credenciais que o aplicativo usa para autenticar e acessar as APIs do Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="08473-138">It holds basic information about your application like OAuth Client ID, Reply URLs, and credentials that your application uses to authenticate and access Azure Resource Manager APIs.</span></span> <span data-ttu-id="08473-139">O registro do aplicativo também registra as várias permissões delegadas de que seu aplicativo precisa para acessar APIs da Microsoft em nome do usuário.</span><span class="sxs-lookup"><span data-stu-id="08473-139">The app registration also records the various delegated permissions that your application needs when accessing Microsoft APIs on behalf of the user.</span></span>

<span data-ttu-id="08473-140">Como o aplicativo acessa outra assinatura, você deve configurá-lo como um aplicativo multilocatário.</span><span class="sxs-lookup"><span data-stu-id="08473-140">Because your app accesses other subscription, you must configure it as a multi-tenant application.</span></span> <span data-ttu-id="08473-141">Para passar na validação, forneça um domínio associado ao Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="08473-141">To pass validation, provide a domain associated with your Azure Active Directory.</span></span> <span data-ttu-id="08473-142">Para ver os domínios associados ao Azure Active Directory, faça logon no [Portal Clássico](https://manage.windowsazure.com).</span><span class="sxs-lookup"><span data-stu-id="08473-142">To see the domains associated with your Azure Active Directory, log in to the [classic portal](https://manage.windowsazure.com).</span></span> <span data-ttu-id="08473-143">Selecione o Azure Active Directory e depois **Domínios**.</span><span class="sxs-lookup"><span data-stu-id="08473-143">Select your Azure Active Directory and then select **Domains**.</span></span>

<span data-ttu-id="08473-144">O exemplo a seguir mostra como registrar o aplicativo usando o Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="08473-144">The following example shows how to register the app by using Azure PowerShell.</span></span> <span data-ttu-id="08473-145">Você deve ter a versão mais recente (agosto de 2016) do Azure PowerShell para que esse comando funcione.</span><span class="sxs-lookup"><span data-stu-id="08473-145">You must have the latest version (August 2016) of Azure PowerShell for this command to work.</span></span>

    $app = New-AzureRmADApplication -DisplayName "{app name}" -HomePage "https://{your domain}/{app name}" -IdentifierUris "https://{your domain}/{app name}" -Password "{your password}" -AvailableToOtherTenants $true

<span data-ttu-id="08473-146">Para fazer logon como o aplicativo do AD, são necessárias a ID e a senha do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="08473-146">To log in as the AD application, you need the application id and password.</span></span> <span data-ttu-id="08473-147">Para ver a ID do aplicativo que é retornada pelo comando anterior, use:</span><span class="sxs-lookup"><span data-stu-id="08473-147">To see the application id that is returned from the previous command, use:</span></span>

    $app.ApplicationId

<span data-ttu-id="08473-148">O exemplo a seguir mostra como registrar o aplicativo usando a CLI do Azure.</span><span class="sxs-lookup"><span data-stu-id="08473-148">The following example shows how to register the app by using Azure CLI.</span></span>

    azure ad app create --name {app name} --home-page https://{your domain}/{app name} --identifier-uris https://{your domain}/{app name} --password {your password} --available true

<span data-ttu-id="08473-149">Os resultados incluem o AppId, que é necessário durante a autenticação do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="08473-149">The results include the AppId, which you need when authenticating as the application.</span></span>

### <a name="optional-configuration---certificate-credential"></a><span data-ttu-id="08473-150">Configuração opcional - credenciais de certificado</span><span class="sxs-lookup"><span data-stu-id="08473-150">Optional configuration - certificate credential</span></span>
<span data-ttu-id="08473-151">O Azure AD também dá suporte a credenciais de certificado para aplicativos: crie um certificado autoassinado, mantenha a chave privada e adicione a chave pública a seu registro de aplicativo do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="08473-151">Azure AD also supports certificate credentials for applications: you create a self-signed cert, keep the private key, and add the public key to your Azure AD application registration.</span></span> <span data-ttu-id="08473-152">Para autenticação, seu aplicativo envia uma pequena carga ao Azure AD assinada usando sua chave privada e o Azure AD valida a assinatura usando a chave pública que você registrou.</span><span class="sxs-lookup"><span data-stu-id="08473-152">For authentication, your application sends a small payload to Azure AD signed using your private key, and Azure AD validates the signature using the public key that you registered.</span></span>

<span data-ttu-id="08473-153">Para saber mais sobre como criar um aplicativo do AD com um certificado, confira [Use Azure PowerShell to create a service principal to access resources](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) (Usar o Azure PowerShell para criar uma entidade de serviço a fim de acessar recursos) ou [Use Azure CLI to create a service principal to access resources](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate) (Usar a CLI do Azure para criar uma entidade de serviço a fim de acessar recursos).</span><span class="sxs-lookup"><span data-stu-id="08473-153">For information about creating an AD app with a certificate, see [Use Azure PowerShell to create a service principal to access resources](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) or [Use Azure CLI to create a service principal to access resources](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate).</span></span>

## <a name="get-tenant-id-from-subscription-id"></a><span data-ttu-id="08473-154">Obter ID de locatário da ID de assinatura</span><span class="sxs-lookup"><span data-stu-id="08473-154">Get tenant id from subscription id</span></span>
<span data-ttu-id="08473-155">Para solicitar um token que possa ser usado para chamar o Resource Manager, seu aplicativo precisa saber a ID do locatário do Azure AD que hospeda a assinatura do Azure.</span><span class="sxs-lookup"><span data-stu-id="08473-155">To request a token that can be used to call Resource Manager, your application needs to know the tenant ID of the Azure AD tenant that hosts the Azure subscription.</span></span> <span data-ttu-id="08473-156">É bem provável que os usuários saibam as respectivas IDs de assinatura, mas talvez não saibam as IDs de seus locatários para o Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="08473-156">Most likely, your users know their subscription ids, but they might not know their tenant ids for Azure Active Directory.</span></span> <span data-ttu-id="08473-157">Para obter a ID de locatário do usuário, peça ao usuário a ID de assinatura.</span><span class="sxs-lookup"><span data-stu-id="08473-157">To get the user's tenant id, ask the user for the subscription id.</span></span> <span data-ttu-id="08473-158">Forneça essa ID de assinatura ao enviar uma solicitação sobre a assinatura:</span><span class="sxs-lookup"><span data-stu-id="08473-158">Provide that subscription id when sending a request about the subscription:</span></span>

    https://management.azure.com/subscriptions/{subscription-id}?api-version=2015-01-01

<span data-ttu-id="08473-159">A solicitação falha porque o usuário ainda não se conectou, mas você pode recuperar a ID de locatário na resposta.</span><span class="sxs-lookup"><span data-stu-id="08473-159">The request fails because the user has not logged in yet, but you can retrieve the tenant id from the response.</span></span> <span data-ttu-id="08473-160">Nessa exceção, recupere a ID de locatário no valor do cabeçalho de resposta para **WWW-Authenticate**.</span><span class="sxs-lookup"><span data-stu-id="08473-160">In that exception, retrieve the tenant id from the response header value for **WWW-Authenticate**.</span></span> <span data-ttu-id="08473-161">Você vê essa implementação no método [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) .</span><span class="sxs-lookup"><span data-stu-id="08473-161">You see this implementation in the [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) method.</span></span>

## <a name="get-user--app-access-token"></a><span data-ttu-id="08473-162">Obter token de acesso ao aplicativo + usuário</span><span class="sxs-lookup"><span data-stu-id="08473-162">Get user + app access token</span></span>
<span data-ttu-id="08473-163">Seu aplicativo redireciona o usuário para o Azure AD com uma Solicitação de Autorização OAuth 2.0 a fim de autenticar as credenciais do usuário e obter um código de autorização.</span><span class="sxs-lookup"><span data-stu-id="08473-163">Your application redirects the user to Azure AD with an OAuth 2.0 Authorize Request - to authenticate the user's credentials and get back an authorization code.</span></span> <span data-ttu-id="08473-164">O aplicativo usa o código de autorização a fim de obter um token de acesso para o Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="08473-164">Your application uses the authorization code to get an access token for Resource Manager.</span></span> <span data-ttu-id="08473-165">O método [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) cria a solicitação de autorização.</span><span class="sxs-lookup"><span data-stu-id="08473-165">The [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) method creates the authorization request.</span></span>

<span data-ttu-id="08473-166">Este tópico mostra as solicitações da API REST para autenticar o usuário.</span><span class="sxs-lookup"><span data-stu-id="08473-166">This topic shows the REST API requests to authenticate the user.</span></span> <span data-ttu-id="08473-167">Você também pode usar bibliotecas auxiliares para realizar a autenticação em seu código.</span><span class="sxs-lookup"><span data-stu-id="08473-167">You can also use helper libraries to perform authentication in your code.</span></span> <span data-ttu-id="08473-168">Para saber mais sobre essas bibliotecas, confira [Bibliotecas de autenticação do Azure Active Directory](../active-directory/active-directory-authentication-libraries.md).</span><span class="sxs-lookup"><span data-stu-id="08473-168">For more information about these libraries, see [Azure Active Directory Authentication Libraries](../active-directory/active-directory-authentication-libraries.md).</span></span> <span data-ttu-id="08473-169">Para obter instruções sobre como integrar o gerenciamento de identidades em um aplicativo, confira [Guia do desenvolvedor do Azure Active Directory](../active-directory/active-directory-developers-guide.md).</span><span class="sxs-lookup"><span data-stu-id="08473-169">For guidance on integrating identity management in an application, see [Azure Active Directory developer's guide](../active-directory/active-directory-developers-guide.md).</span></span>

### <a name="auth-request-oauth-20"></a><span data-ttu-id="08473-170">Solicitação de autorização (OAuth 2.0)</span><span class="sxs-lookup"><span data-stu-id="08473-170">Auth request (OAuth 2.0)</span></span>
<span data-ttu-id="08473-171">Emita uma solicitação de autorização Open ID Connect/OAuth 2.0 para o ponto de extremidade de autorização do Azure AD:</span><span class="sxs-lookup"><span data-stu-id="08473-171">Issue an Open ID Connect/OAuth2.0 Authorize Request to the Azure AD Authorize endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize

<span data-ttu-id="08473-172">Os parâmetros de cadeia de caracteres de consulta disponíveis para essa solicitação estão descritos no tópico [Solicitar um código de autorização](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code).</span><span class="sxs-lookup"><span data-stu-id="08473-172">The query string parameters that are available for this request are described in the [request an authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) topic.</span></span>

<span data-ttu-id="08473-173">O exemplo abaixo mostra como solicitar autorização OAuth 2.0:</span><span class="sxs-lookup"><span data-stu-id="08473-173">The following example shows how to request OAuth2.0 authorization:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=query&response_type=code&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&domain_hint=live.com

<span data-ttu-id="08473-174">O Azure AD autentica o usuário e, se necessário, pede a ele para conceder permissão ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="08473-174">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span></span> <span data-ttu-id="08473-175">Ele retorna o código de autorização para a URL de resposta do seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="08473-175">It returns the authorization code to the Reply URL of your application.</span></span> <span data-ttu-id="08473-176">Dependendo do response_mode solicitado, o Azure AD envia de volta os dados na cadeia de caracteres de consulta ou como dados de postagem.</span><span class="sxs-lookup"><span data-stu-id="08473-176">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span></span>

    code=AAABAAAAiL****FDMZBUwZ8eCAA&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="auth-request-open-id-connect"></a><span data-ttu-id="08473-177">Solicitação de autorização (Open ID Connect)</span><span class="sxs-lookup"><span data-stu-id="08473-177">Auth request (Open ID Connect)</span></span>
<span data-ttu-id="08473-178">Se além de desejar acessar o Azure Resource Manager em nome do usuário, você também quiser permitir que o usuário entre em seu aplicativo usando a respectiva conta do Azure AD, emita uma Solicitação de Autorização Open ID Connect.</span><span class="sxs-lookup"><span data-stu-id="08473-178">If you not only wish to access Azure Resource Manager on behalf of the user, but also allow the user to sign in to your application using their Azure AD account, issue an Open ID Connect Authorize Request.</span></span> <span data-ttu-id="08473-179">Com o Open ID Connect, seu aplicativo também recebe um id_token do Azure AD que pode ser usado para conectar o usuário.</span><span class="sxs-lookup"><span data-stu-id="08473-179">With Open ID Connect, your application also receives an id_token from Azure AD that your app can use to sign in the user.</span></span>

<span data-ttu-id="08473-180">Os parâmetros de cadeia de caracteres de consulta disponíveis para essa solicitação estão descritos no tópico [Enviar a solicitação de conexão](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request).</span><span class="sxs-lookup"><span data-stu-id="08473-180">The query string parameters that are available for this request are described in the [Send the sign-in request](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) topic.</span></span>

<span data-ttu-id="08473-181">Eis um exemplo de solicitação Open ID Connect:</span><span class="sxs-lookup"><span data-stu-id="08473-181">An example Open ID Connect request is:</span></span>

     https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=form_post&response_type=code+id_token&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&scope=openid+profile&nonce=63567Dc4MDAw&domain_hint=live.com&state=M_12tMyKaM8

<span data-ttu-id="08473-182">O Azure AD autentica o usuário e, se necessário, pede a ele para conceder permissão ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="08473-182">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span></span> <span data-ttu-id="08473-183">Ele retorna o código de autorização para a URL de resposta do seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="08473-183">It returns the authorization code to the Reply URL of your application.</span></span> <span data-ttu-id="08473-184">Dependendo do response_mode solicitado, o Azure AD envia de volta os dados na cadeia de caracteres de consulta ou como dados de postagem.</span><span class="sxs-lookup"><span data-stu-id="08473-184">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span></span>

<span data-ttu-id="08473-185">Eis um exemplo de resposta Open ID Connect:</span><span class="sxs-lookup"><span data-stu-id="08473-185">An example Open ID Connect response is:</span></span>

    code=AAABAAAAiL*****I4rDWd7zXsH6WUjlkIEQxIAA&id_token=eyJ0eXAiOiJKV1Q*****T3GrzzSFxg&state=M_12tMyKaM8&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="token-request-oauth20-code-grant-flow"></a><span data-ttu-id="08473-186">Solicitação de token (Fluxo de concessão de código OAuth 2.0)</span><span class="sxs-lookup"><span data-stu-id="08473-186">Token request (OAuth2.0 Code Grant Flow)</span></span>
<span data-ttu-id="08473-187">Agora que seu aplicativo recebeu o código de autorização do Azure AD, é hora de obter o token de acesso para o Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="08473-187">Now that your application has received the authorization code from Azure AD, it is time to get the access token for Azure Resource Manager.</span></span>  <span data-ttu-id="08473-188">Poste uma solicitação de token de concessão de código OAuth 2.0 no ponto de extremidade de token do Azure AD:</span><span class="sxs-lookup"><span data-stu-id="08473-188">Post an OAuth2.0 Code Grant Token Request to the Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="08473-189">Os parâmetros de cadeia de caracteres de consulta disponíveis para essa solicitação estão descritos no tópico [Usar o código de autorização](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token).</span><span class="sxs-lookup"><span data-stu-id="08473-189">The query string parameters that are available for this request are described in the [use the authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) topic.</span></span>

<span data-ttu-id="08473-190">O exemplo abaixo mostra uma solicitação de token de concessão de código com credenciais de senha:</span><span class="sxs-lookup"><span data-stu-id="08473-190">The following example shows a request for code grant token with password credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="08473-191">Ao trabalhar com as credenciais de certificado, crie um JWT (Token Web JSON) e assine (RSA SHA256) usando a chave particular de credenciais de certificado do seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="08473-191">When working with certificate credentials, create a JSON Web Token (JWT) and sign (RSA SHA256) using the private key of your application's certificate credential.</span></span> <span data-ttu-id="08473-192">Os tipos de declaração para o token são mostrados na [Declarações de token JWT](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span><span class="sxs-lookup"><span data-stu-id="08473-192">The claim types for the token are shown in [JWT token claims](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span></span> <span data-ttu-id="08473-193">Para referência, confira o [Código da biblioteca de autenticação do Active Directory (.NET)](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) para assinar tokens JWT de asserção de cliente.</span><span class="sxs-lookup"><span data-stu-id="08473-193">For reference, see the [Active Directory Auth Library (.NET) code](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) to sign Client Assertion JWT tokens.</span></span>

<span data-ttu-id="08473-194">Confira as [especificações do Open ID Connect](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) para obter detalhes sobre a autenticação de cliente.</span><span class="sxs-lookup"><span data-stu-id="08473-194">See the [Open ID Connect spec](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) for details on client authentication.</span></span>

<span data-ttu-id="08473-195">O exemplo abaixo mostra uma solicitação de token de concessão de código com credenciais de certificado:</span><span class="sxs-lookup"><span data-stu-id="08473-195">The following example shows a request for code grant token with certificate credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer&client_assertion=eyJhbG*****Y9cYo8nEjMyA

<span data-ttu-id="08473-196">Um exemplo de resposta de token de concessão de código:</span><span class="sxs-lookup"><span data-stu-id="08473-196">An example response for code grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039858","not_before":"1432035958","resource":"https://management.core.windows.net/","access_token":"eyJ0eXAiOiJKV1Q****M7Cw6JWtfY2lGc5A","refresh_token":"AAABAAAAiL9Kn2Z****55j-sjnyYgAA","scope":"user_impersonation","id_token":"eyJ0eXAiOiJKV*****-drP1J3P-HnHi9Rr46kGZnukEBH4dsg"}

#### <a name="handle-code-grant-token-response"></a><span data-ttu-id="08473-197">Manipular resposta de token de concessão de código</span><span class="sxs-lookup"><span data-stu-id="08473-197">Handle code grant token response</span></span>
<span data-ttu-id="08473-198">Uma resposta bem-sucedida de token contém o token de acesso (usuário e aplicativo) para o Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="08473-198">A successful token response contains the (user + app) access token for Azure Resource Manager.</span></span> <span data-ttu-id="08473-199">Seu aplicativo usa esse token de acesso para acessar o Resource Manager em nome do usuário.</span><span class="sxs-lookup"><span data-stu-id="08473-199">Your application uses this access token to access Resource Manager on behalf of the user.</span></span> <span data-ttu-id="08473-200">A vida útil dos tokens de acesso emitidos pelo Azure AD é de uma hora.</span><span class="sxs-lookup"><span data-stu-id="08473-200">The lifetime of access tokens issued by Azure AD is one hour.</span></span> <span data-ttu-id="08473-201">É improvável que o aplicativo Web precise renovar o token de acesso (usuário + aplicativo).</span><span class="sxs-lookup"><span data-stu-id="08473-201">It is unlikely that your web application needs to renew the (user + app) access token.</span></span> <span data-ttu-id="08473-202">Se ele precisa renovar o token de acesso, use o token de atualização que o aplicativo recebe na resposta de token.</span><span class="sxs-lookup"><span data-stu-id="08473-202">If it needs to renew the access token, use the refresh token that your application receives in the token response.</span></span> <span data-ttu-id="08473-203">Poste uma solicitação de token OAuth 2.0 no ponto de extremidade de token do Azure AD:</span><span class="sxs-lookup"><span data-stu-id="08473-203">Post an OAuth2.0 Token Request to the Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="08473-204">Os parâmetros a serem usados com a solicitação de atualização são descrito em [Atualização dos tokens de acesso](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span><span class="sxs-lookup"><span data-stu-id="08473-204">The parameters to use with the refresh request are described in [refreshing the access token](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span></span>

<span data-ttu-id="08473-205">O exemplo abaixo mostra como usar o token de atualização:</span><span class="sxs-lookup"><span data-stu-id="08473-205">The following example shows how to use the refresh token:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=refresh_token&refresh_token=AAABAAAAiL9Kn2Z****55j-sjnyYgAA&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="08473-206">Embora os tokens de atualização possam ser usados para obter novos tokens de acesso para o Azure Resource Manager, eles não são adequados para que seu aplicativo tenha acesso offline.</span><span class="sxs-lookup"><span data-stu-id="08473-206">Although refresh tokens can be used to get new access tokens for Azure Resource Manager, they are not suitable for offline access by your application.</span></span> <span data-ttu-id="08473-207">O tempo de vida dos tokens de atualização é limitado e os tokens de atualização estão associados ao usuário.</span><span class="sxs-lookup"><span data-stu-id="08473-207">The refresh tokens lifetime is limited, and refresh tokens are bound to the user.</span></span> <span data-ttu-id="08473-208">Se o usuário sair da organização, o aplicativo que usa o token de atualização perderá o acesso.</span><span class="sxs-lookup"><span data-stu-id="08473-208">If the user leaves the organization, the application using the refresh token loses access.</span></span> <span data-ttu-id="08473-209">Essa abordagem não é adequada para aplicativos que são usados pelas equipes para gerenciar seus recursos do Azure.</span><span class="sxs-lookup"><span data-stu-id="08473-209">This approach isn't suitable for applications that are used by teams to manage their Azure resources.</span></span>

## <a name="check-if-user-can-assign-access-to-subscription"></a><span data-ttu-id="08473-210">Verificar se o usuário pode atribuir acesso à assinatura</span><span class="sxs-lookup"><span data-stu-id="08473-210">Check if user can assign access to subscription</span></span>
<span data-ttu-id="08473-211">Seu aplicativo agora tem um token para acessar o Azure Resource Manager em nome do usuário.</span><span class="sxs-lookup"><span data-stu-id="08473-211">Your application now has a token to access Azure Resource Manager on behalf of the user.</span></span> <span data-ttu-id="08473-212">A próxima etapa é conectar o aplicativo à assinatura.</span><span class="sxs-lookup"><span data-stu-id="08473-212">The next step is to connect your app to the subscription.</span></span> <span data-ttu-id="08473-213">Depois de se conectar, o aplicativo pode gerenciar as assinaturas mesmo quando o usuário não estiver presente (acesso offline de longo prazo).</span><span class="sxs-lookup"><span data-stu-id="08473-213">After connecting, your app can manage those subscriptions even when the user isn't present (long-term offline access).</span></span>

<span data-ttu-id="08473-214">Para conectar cada assinatura, chame a API das [permissões da lista do Resource Manager](https://docs.microsoft.com/rest/api/authorization/permissions) para determinar se o usuário tem direitos de gerenciamento de acesso para a assinatura.</span><span class="sxs-lookup"><span data-stu-id="08473-214">For each subscription to connect, call the [Resource Manager list permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API to determine whether the user has access management rights for the subscription.</span></span>

<span data-ttu-id="08473-215">O método [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) do aplicativo de exemplo do ASP.NET MVC implementa essa chamada.</span><span class="sxs-lookup"><span data-stu-id="08473-215">The [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) method of the ASP.NET MVC sample app implements this call.</span></span>

<span data-ttu-id="08473-216">O exemplo a seguir mostra como solicitar permissões de um usuário em uma assinatura.</span><span class="sxs-lookup"><span data-stu-id="08473-216">The following example shows how to request a user's permissions on a subscription.</span></span> <span data-ttu-id="08473-217">83cfe939-2402-4581-b761-4f59b0a041e4 é a ID da assinatura.</span><span class="sxs-lookup"><span data-stu-id="08473-217">83cfe939-2402-4581-b761-4f59b0a041e4 is the id of the subscription.</span></span>

    GET https://management.azure.com/subscriptions/83cfe939-2402-4581-b761-4f59b0a041e4/providers/microsoft.authorization/permissions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiLC***lwO1mM7Cw6JWtfY2lGc5A

<span data-ttu-id="08473-218">Veja um exemplo de resposta para obter permissões do usuário na assinatura:</span><span class="sxs-lookup"><span data-stu-id="08473-218">An example of the response to get user's permissions on subscription is:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"actions":["*"],"notActions":["Microsoft.Authorization/*/Write","Microsoft.Authorization/*/Delete"]},{"actions":["*/read"],"notActions":[]}]}

<span data-ttu-id="08473-219">A API de permissões retorna várias permissões.</span><span class="sxs-lookup"><span data-stu-id="08473-219">The permissions API returns multiple permissions.</span></span> <span data-ttu-id="08473-220">Cada permissão consiste em ações permitidas (actions) e ações não permitidas (notactions).</span><span class="sxs-lookup"><span data-stu-id="08473-220">Each permission consists of allowed actions (actions) and disallowed actions (notactions).</span></span> <span data-ttu-id="08473-221">Se uma ação estiver presente na lista de ações permitidas de alguma permissão e não estiver presente na lista notactions dessa permissão, o usuário terá permissão para executar essa ação.</span><span class="sxs-lookup"><span data-stu-id="08473-221">If an action is present in the allowed actions list of any permission and not present in the notactions list of that permission, the user is allowed to perform that action.</span></span> <span data-ttu-id="08473-222">**microsoft.authorization/roleassignments/write** é a ação que concede direitos de gerenciamento de acesso.</span><span class="sxs-lookup"><span data-stu-id="08473-222">**microsoft.authorization/roleassignments/write** is the action that that grants access management rights.</span></span> <span data-ttu-id="08473-223">Seu aplicativo deve analisar o resultado de permissões e procurar uma correspondência de regex nessa cadeia de caracteres de ação em actions e notactions de cada permissão.</span><span class="sxs-lookup"><span data-stu-id="08473-223">Your application must parse the permissions result to look for a regex match on this action string in the actions and notactions of each permission.</span></span>

## <a name="get-app-only-access-token"></a><span data-ttu-id="08473-224">Obter token de acesso somente ao aplicativo</span><span class="sxs-lookup"><span data-stu-id="08473-224">Get app-only access token</span></span>
<span data-ttu-id="08473-225">Agora, você sabe se o usuário pode atribuir acesso à assinatura do Azure.</span><span class="sxs-lookup"><span data-stu-id="08473-225">Now, you know if the user can assign access to the Azure subscription.</span></span> <span data-ttu-id="08473-226">As próximas etapas são:</span><span class="sxs-lookup"><span data-stu-id="08473-226">The next steps are:</span></span>

1. <span data-ttu-id="08473-227">Atribuir a função RBAC apropriada à identidade do aplicativo na assinatura.</span><span class="sxs-lookup"><span data-stu-id="08473-227">Assign the appropriate RBAC role to your application's identity on the subscription.</span></span>
2. <span data-ttu-id="08473-228">Validar a atribuição de acesso consultando a permissão do aplicativo na assinatura ou acessando o Resource Manager usando o token somente de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="08473-228">Validate the access assignment by querying for the Application's permission on the subscription or by accessing Resource Manager using app-only token.</span></span>
3. <span data-ttu-id="08473-229">Registrar a conexão em sua estrutura de dados de "assinaturas conectadas" dos aplicativos, persistindo a ID da assinatura.</span><span class="sxs-lookup"><span data-stu-id="08473-229">Record the connection in your applications "connected subscriptions" data structure - persisting the id of the subscription.</span></span>

<span data-ttu-id="08473-230">Vamos examinar mais detalhadamente a primeira etapa.</span><span class="sxs-lookup"><span data-stu-id="08473-230">Let's look closer at the first step.</span></span> <span data-ttu-id="08473-231">Para atribuir a função RBAC apropriada à identidade do aplicativo, você deve determinar:</span><span class="sxs-lookup"><span data-stu-id="08473-231">To assign the appropriate RBAC role to the application's identity, you must determine:</span></span>

* <span data-ttu-id="08473-232">A ID do objeto de identidade do seu aplicativo no Azure Active Directory do usuário</span><span class="sxs-lookup"><span data-stu-id="08473-232">The object id of your application's identity in the user's Azure Active Directory</span></span>
* <span data-ttu-id="08473-233">O identificador da função RBAC que seu aplicativo requer na assinatura</span><span class="sxs-lookup"><span data-stu-id="08473-233">The identifier of the RBAC role that your application requires on the subscription</span></span>

<span data-ttu-id="08473-234">Quando o aplicativo autentica um usuário em um Azure AD, ele cria um objeto de entidade de serviço para o aplicativo nesse Azure AD.</span><span class="sxs-lookup"><span data-stu-id="08473-234">When your application authenticates a user from an Azure AD, it creates a service principal object for your application in that Azure AD.</span></span> <span data-ttu-id="08473-235">O Azure permite que as funções RBAC sejam atribuídas a entidades de serviço para conceder acesso direto a aplicativos correspondentes nos recursos do Azure.</span><span class="sxs-lookup"><span data-stu-id="08473-235">Azure allows RBAC roles to be assigned to service principals to grant direct access to corresponding applications on Azure resources.</span></span> <span data-ttu-id="08473-236">Essa ação é exatamente o que desejamos fazer.</span><span class="sxs-lookup"><span data-stu-id="08473-236">This action is exactly what we wish to do.</span></span> <span data-ttu-id="08473-237">Consulte a API do Azure AD Graph para determinar o identificador da entidade de serviço do seu aplicativo no Azure AD do usuário conectado.</span><span class="sxs-lookup"><span data-stu-id="08473-237">Query the Azure AD Graph API to determine the identifier of the service principal of your application in the signed-in user's Azure AD.</span></span>

<span data-ttu-id="08473-238">Você tem apenas um token de acesso para o Azure Resource Manager. É necessário um novo token de acesso para chamar a API do Azure AD Graph.</span><span class="sxs-lookup"><span data-stu-id="08473-238">You only have an access token for Azure Resource Manager - you need a new access token to call the Azure AD Graph API.</span></span> <span data-ttu-id="08473-239">Cada aplicativo no Azure AD tem permissão para consultar seu próprio objeto de entidade de serviço, de modo que um token de acesso somente de aplicativo é suficiente.</span><span class="sxs-lookup"><span data-stu-id="08473-239">Every application in Azure AD has permission to query its own service principal object, so an app-only access token is sufficient.</span></span>

<a id="app-azure-ad-graph" />

### <a name="get-app-only-access-token-for-azure-ad-graph-api"></a><span data-ttu-id="08473-240">Obter o token de acesso somente de aplicativo para a API do Azure AD Graph</span><span class="sxs-lookup"><span data-stu-id="08473-240">Get app-only access token for Azure AD Graph API</span></span>
<span data-ttu-id="08473-241">Para autenticar seu aplicativo e obter um token para a API do Graph do Azure AD, emita uma solicitação de token de fluxo OAuth 2.0 de Concessão de Credencial de Cliente para o ponto de extremidade de token do Azure AD (**https://login.microsoftonline.com/{directory_domain_name}/OAuth2/Token**).</span><span class="sxs-lookup"><span data-stu-id="08473-241">To authenticate your app and get a token to Azure AD Graph API, issue a Client Credential Grant OAuth2.0 flow token request to Azure AD token endpoint (**https://login.microsoftonline.com/{directory_domain_name}/OAuth2/Token**).</span></span>

<span data-ttu-id="08473-242">O método [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) do aplicativo de exemplo do ASP.NET MVC obtém um token de acesso somente de aplicativo para API do Graph usando a Biblioteca de Autenticação do Active Directory para .NET.</span><span class="sxs-lookup"><span data-stu-id="08473-242">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) method of the ASP.net MVC sample application gets an app-only access token for Graph API using the Active Directory Authentication Library for .NET.</span></span>

<span data-ttu-id="08473-243">Os parâmetros de cadeia de caracteres de consulta disponíveis para essa solicitação estão descritos no tópico [Solicitar um token de acesso](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token).</span><span class="sxs-lookup"><span data-stu-id="08473-243">The query string parameters that are available for this request are described in the [Request an Access Token](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) topic.</span></span>

<span data-ttu-id="08473-244">Um exemplo de solicitação de token de concessão de credencial de cliente:</span><span class="sxs-lookup"><span data-stu-id="08473-244">An example request for client credential grant token:</span></span>

    POST https://login.microsoftonline.com/62e173e9-301e-423e-bcd4-29121ec1aa24/oauth2/token HTTP/1.1
    Content-Type: application/x-www-form-urlencoded
    Content-Length: 187</pre>
    <pre>grant_type=client_credentials&client_id=a0448380-c346-4f9f-b897-c18733de9394&resource=https%3A%2F%2Fgraph.windows.net%2F &client_secret=olna8C*****Og%3D

<span data-ttu-id="08473-245">Um exemplo de resposta de token de concessão de credencial de cliente:</span><span class="sxs-lookup"><span data-stu-id="08473-245">An example response for client credential grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039862","not_before":"1432035962","resource":"https://graph.windows.net/","access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSIsImtpZCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLndpbmRv****G5gUTV-kKorR-pg"}

### <a name="get-objectid-of-application-service-principal-in-user-azure-ad"></a><span data-ttu-id="08473-246">Obter a ID de objeto da entidade de serviço de aplicativo no Azure AD do usuário</span><span class="sxs-lookup"><span data-stu-id="08473-246">Get ObjectId of application service principal in user Azure AD</span></span>
<span data-ttu-id="08473-247">Use o token de acesso somente de aplicativo para consultar a API [Entidades de Serviço do Azure AD Graph](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) para determinar a ID de objeto da entidade de serviço do aplicativo no diretório.</span><span class="sxs-lookup"><span data-stu-id="08473-247">Now, use the app-only access token to query the [Azure AD Graph Service Principals](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) API to determine the Object Id of the application's service principal in the directory.</span></span>

<span data-ttu-id="08473-248">O método [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) do aplicativo de exemplo do ASP.NET MVC implementa essa chamada.</span><span class="sxs-lookup"><span data-stu-id="08473-248">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) method of the ASP.net MVC sample application implements this call.</span></span>

<span data-ttu-id="08473-249">O exemplo a seguir mostra como solicitar a entidade de serviço do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="08473-249">The following example shows how to request an application's service principal.</span></span> <span data-ttu-id="08473-250">a0448380-c346-4f9f-b897-c18733de9394 é a ID do cliente do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="08473-250">a0448380-c346-4f9f-b897-c18733de9394 is the client id of the application.</span></span>

    GET https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/servicePrincipals?api-version=1.5&$filter=appId%20eq%20'a0448380-c346-4f9f-b897-c18733de9394' HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJK*****-kKorR-pg

<span data-ttu-id="08473-251">O exemplo a seguir mostra uma resposta à solicitação da entidade de serviço do aplicativo</span><span class="sxs-lookup"><span data-stu-id="08473-251">The following example shows a response to the request for an application's service principal</span></span>

    HTTP/1.1 200 OK

    {"odata.metadata":"https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/$metadata#directoryObjects/Microsoft.DirectoryServices.ServicePrincipal","value":[{"odata.type":"Microsoft.DirectoryServices.ServicePrincipal","objectType":"ServicePrincipal","objectId":"9b5018d4-6951-42ed-8a92-f11ec283ccec","deletionTimestamp":null,"accountEnabled":true,"appDisplayName":"CloudSense","appId":"a0448380-c346-4f9f-b897-c18733de9394","appOwnerTenantId":"62e173e9-301e-423e-bcd4-29121ec1aa24","appRoleAssignmentRequired":false,"appRoles":[],"displayName":"CloudSense","errorUrl":null,"homepage":"http://www.vipswapper.com/cloudsense","keyCredentials":[],"logoutUrl":null,"oauth2Permissions":[{"adminConsentDescription":"Allow the application to access CloudSense on behalf of the signed-in user.","adminConsentDisplayName":"Access CloudSense","id":"b7b7338e-683a-4796-b95e-60c10380de1c","isEnabled":true,"type":"User","userConsentDescription":"Allow the application to access CloudSense on your behalf.","userConsentDisplayName":"Access CloudSense","value":"user_impersonation"}],"passwordCredentials":[],"preferredTokenSigningKeyThumbprint":null,"publisherName":"vipswapper"quot;,"replyUrls":["http://www.vipswapper.com/cloudsense","http://www.vipswapper.com","http://vipswapper.com","http://vipswapper.azurewebsites.net","http://localhost:62080"],"samlMetadataUrl":null,"servicePrincipalNames":["http://www.vipswapper.com/cloudsense","a0448380-c346-4f9f-b897-c18733de9394"],"tags":["WindowsAzureActiveDirectoryIntegratedApp"]}]}

### <a name="get-azure-rbac-role-identifier"></a><span data-ttu-id="08473-252">Obter o identificador de função RBAC do Azure</span><span class="sxs-lookup"><span data-stu-id="08473-252">Get Azure RBAC role identifier</span></span>
<span data-ttu-id="08473-253">Para atribuir a função RBAC apropriada à entidade de serviço, é preciso determinar o identificador da função RBAC do Azure.</span><span class="sxs-lookup"><span data-stu-id="08473-253">To assign the appropriate RBAC role to your service principal, you must determine the identifier of the Azure RBAC role.</span></span>

<span data-ttu-id="08473-254">A função RBAC certa para seu aplicativo:</span><span class="sxs-lookup"><span data-stu-id="08473-254">The right RBAC role for your application:</span></span>

* <span data-ttu-id="08473-255">Se o aplicativo monitora apenas a assinatura, sem fazer alterações, ele exigirá apenas permissões de leitura na assinatura.</span><span class="sxs-lookup"><span data-stu-id="08473-255">If your application only monitors the subscription, without making any changes, it requires only reader permissions on the subscription.</span></span> <span data-ttu-id="08473-256">Atribua a função **Leitor** .</span><span class="sxs-lookup"><span data-stu-id="08473-256">Assign the **Reader** role.</span></span>
* <span data-ttu-id="08473-257">Se o aplicativo gerencia a assinatura do Azure, criando/modificando/excluindo entidades, será necessária uma das permissões de colaborador.</span><span class="sxs-lookup"><span data-stu-id="08473-257">If your application manages Azure the subscription, creating/modifying/deleting entities, it requires one of the contributor permissions.</span></span>
  * <span data-ttu-id="08473-258">Para gerenciar um determinado tipo de recurso, atribua as funções de colaborador específicas do recurso (Colaborador da Máquina Virtual, Colaborador de Rede Virtual, Colaborador da Conta de Armazenamento, etc.)</span><span class="sxs-lookup"><span data-stu-id="08473-258">To manage a particular type of resource, assign the resource-specific contributor roles (Virtual Machine Contributor, Virtual Network Contributor, Storage Account Contributor, etc.)</span></span>
  * <span data-ttu-id="08473-259">Para gerenciar qualquer tipo de recurso, atribua a função **Colaborador** .</span><span class="sxs-lookup"><span data-stu-id="08473-259">To manage any resource type, assign the **Contributor** role.</span></span>

<span data-ttu-id="08473-260">A atribuição de função para seu aplicativo está visível para os usuários. Portanto, escolha o privilégio mínimo exigido.</span><span class="sxs-lookup"><span data-stu-id="08473-260">The role assignment for your application is visible to users, so select the least-required privilege.</span></span>

<span data-ttu-id="08473-261">Chame a [API de definição de função do Resource Manager](https://docs.microsoft.com/rest/api/authorization/roledefinitions) para listar todas as funções RBAC do Azure, bem como para pesquisar e iterar sobre o resultado a fim de localizar a definição de função desejada pelo nome.</span><span class="sxs-lookup"><span data-stu-id="08473-261">Call the [Resource Manager role definition API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) to list all Azure RBAC roles and search then iterate over the result to find the desired role definition by name.</span></span>

<span data-ttu-id="08473-262">O método [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) do aplicativo de exemplo do ASP.NET MVC implementa essa chamada.</span><span class="sxs-lookup"><span data-stu-id="08473-262">The [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) method of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="08473-263">O exemplo de solicitação a seguir mostra como obter o identificador de função RBAC do Azure.</span><span class="sxs-lookup"><span data-stu-id="08473-263">The following request example shows how to get Azure RBAC role identifier.</span></span> <span data-ttu-id="08473-264">09cbd307-aa71-4aca-b346-5f253e6e3ebb é a ID da assinatura.</span><span class="sxs-lookup"><span data-stu-id="08473-264">09cbd307-aa71-4aca-b346-5f253e6e3ebb is the id of the subscription.</span></span>

    GET https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV*****fY2lGc5

<span data-ttu-id="08473-265">A resposta está no seguinte formato:</span><span class="sxs-lookup"><span data-stu-id="08473-265">The response is in the following format:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"properties":{"roleName":"API Management Service Contributor","type":"BuiltInRole","description":"Lets you manage API Management services, but not access to them.","scope":"/","permissions":[{"actions":["Microsoft.ApiManagement/Services/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/312a565d-c81f-4fd8-895a-4e21e48d571c","type":"Microsoft.Authorization/roleDefinitions","name":"312a565d-c81f-4fd8-895a-4e21e48d571c"},{"properties":{"roleName":"Application Insights Component Contributor","type":"BuiltInRole","description":"Lets you manage Application Insights components, but not access to them.","scope":"/","permissions":[{"actions":["Microsoft.Insights/components/*","Microsoft.Insights/webtests/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/ae349356-3a1b-4a5e-921d-050484c6347e","type":"Microsoft.Authorization/roleDefinitions","name":"ae349356-3a1b-4a5e-921d-050484c6347e"}]}

<span data-ttu-id="08473-266">Você não precisa chamar essa API continuamente.</span><span class="sxs-lookup"><span data-stu-id="08473-266">You do not need to call this API on an ongoing basis.</span></span> <span data-ttu-id="08473-267">Depois de determinar o GUID conhecido da definição da função, você poderá construir a ID de definição de função como:</span><span class="sxs-lookup"><span data-stu-id="08473-267">Once you've determined the well-known GUID of the role definition, you can construct the role definition id as:</span></span>

    /subscriptions/{subscription_id}/providers/Microsoft.Authorization/roleDefinitions/{well-known-role-guid}

<span data-ttu-id="08473-268">Aqui estão os GUIDS conhecidos de funções internas comumente usadas:</span><span class="sxs-lookup"><span data-stu-id="08473-268">Here are the well-known guids of commonly used built-in roles:</span></span>

| <span data-ttu-id="08473-269">Função</span><span class="sxs-lookup"><span data-stu-id="08473-269">Role</span></span> | <span data-ttu-id="08473-270">Guid</span><span class="sxs-lookup"><span data-stu-id="08473-270">Guid</span></span> |
| --- | --- |
| <span data-ttu-id="08473-271">Leitor</span><span class="sxs-lookup"><span data-stu-id="08473-271">Reader</span></span> |<span data-ttu-id="08473-272">acdd72a7-3385-48ef-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="08473-272">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |
| <span data-ttu-id="08473-273">Colaborador</span><span class="sxs-lookup"><span data-stu-id="08473-273">Contributor</span></span> |<span data-ttu-id="08473-274">b24988ac-6180-42a0-ab88-20f7382dd24c</span><span class="sxs-lookup"><span data-stu-id="08473-274">b24988ac-6180-42a0-ab88-20f7382dd24c</span></span> |
| <span data-ttu-id="08473-275">Colaborador de Máquina Virtual</span><span class="sxs-lookup"><span data-stu-id="08473-275">Virtual Machine Contributor</span></span> |<span data-ttu-id="08473-276">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span><span class="sxs-lookup"><span data-stu-id="08473-276">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span></span> |
| <span data-ttu-id="08473-277">Colaborador de Rede Virtual</span><span class="sxs-lookup"><span data-stu-id="08473-277">Virtual Network Contributor</span></span> |<span data-ttu-id="08473-278">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span><span class="sxs-lookup"><span data-stu-id="08473-278">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span></span> |
| <span data-ttu-id="08473-279">Colaborador da Conta de Armazenamento</span><span class="sxs-lookup"><span data-stu-id="08473-279">Storage Account Contributor</span></span> |<span data-ttu-id="08473-280">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span><span class="sxs-lookup"><span data-stu-id="08473-280">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span></span> |
| <span data-ttu-id="08473-281">Colaborador do Site</span><span class="sxs-lookup"><span data-stu-id="08473-281">Website Contributor</span></span> |<span data-ttu-id="08473-282">de139f84-1756-47ae-9be6-808fbbe84772</span><span class="sxs-lookup"><span data-stu-id="08473-282">de139f84-1756-47ae-9be6-808fbbe84772</span></span> |
| <span data-ttu-id="08473-283">Colaborador do Plano de Web</span><span class="sxs-lookup"><span data-stu-id="08473-283">Web Plan Contributor</span></span> |<span data-ttu-id="08473-284">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span><span class="sxs-lookup"><span data-stu-id="08473-284">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span></span> |
| <span data-ttu-id="08473-285">Colaborador do SQL Server</span><span class="sxs-lookup"><span data-stu-id="08473-285">SQL Server Contributor</span></span> |<span data-ttu-id="08473-286">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span><span class="sxs-lookup"><span data-stu-id="08473-286">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span></span> |
| <span data-ttu-id="08473-287">Colaborador do banco de dados SQL</span><span class="sxs-lookup"><span data-stu-id="08473-287">SQL DB Contributor</span></span> |<span data-ttu-id="08473-288">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span><span class="sxs-lookup"><span data-stu-id="08473-288">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span></span> |

### <a name="assign-rbac-role-to-application"></a><span data-ttu-id="08473-289">Atribuir função RBAC ao aplicativo</span><span class="sxs-lookup"><span data-stu-id="08473-289">Assign RBAC role to application</span></span>
<span data-ttu-id="08473-290">Você tem tudo o que é necessário para atribuir a função RBAC apropriada à entidade de serviço usando a API [Criar atribuição de função do Resource Manager](https://docs.microsoft.com/rest/api/authorization/roleassignments) .</span><span class="sxs-lookup"><span data-stu-id="08473-290">You have everything you need to assign the appropriate RBAC role to your service principal by using the [Resource Manager create role assignment](https://docs.microsoft.com/rest/api/authorization/roleassignments) API.</span></span>

<span data-ttu-id="08473-291">O método [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) do aplicativo de exemplo ASP.NET MVC implementa essa chamada.</span><span class="sxs-lookup"><span data-stu-id="08473-291">The [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) method of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="08473-292">Um exemplo de solicitação para atribuir função RBAC ao aplicativo:</span><span class="sxs-lookup"><span data-stu-id="08473-292">An example request to assign RBAC role to application:</span></span>

    PUT https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/microsoft.authorization/roleassignments/4f87261d-2816-465d-8311-70a27558df4c?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiL*****FlwO1mM7Cw6JWtfY2lGc5
    Content-Type: application/json
    Content-Length: 230

    {"properties": {"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2"}}

<span data-ttu-id="08473-293">Na solicitação, são usados os seguintes valores:</span><span class="sxs-lookup"><span data-stu-id="08473-293">In the request, the following values are used:</span></span>

| <span data-ttu-id="08473-294">Guid</span><span class="sxs-lookup"><span data-stu-id="08473-294">Guid</span></span> | <span data-ttu-id="08473-295">Descrição</span><span class="sxs-lookup"><span data-stu-id="08473-295">Description</span></span> |
| --- | --- |
| <span data-ttu-id="08473-296">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span><span class="sxs-lookup"><span data-stu-id="08473-296">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span></span> |<span data-ttu-id="08473-297">a ID da assinatura</span><span class="sxs-lookup"><span data-stu-id="08473-297">the id of the subscription</span></span> |
| <span data-ttu-id="08473-298">c3097b31-7309-4c59-b4e3-770f8406bad2</span><span class="sxs-lookup"><span data-stu-id="08473-298">c3097b31-7309-4c59-b4e3-770f8406bad2</span></span> |<span data-ttu-id="08473-299">a ID de objeto da entidade de serviço do aplicativo</span><span class="sxs-lookup"><span data-stu-id="08473-299">the object id of the service principal of the application</span></span> |
| <span data-ttu-id="08473-300">acdd72a7-3385-48ef-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="08473-300">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |<span data-ttu-id="08473-301">a ID da função de leitor</span><span class="sxs-lookup"><span data-stu-id="08473-301">the id of the reader role</span></span> |
| <span data-ttu-id="08473-302">4f87261d-2816-465d-8311-70a27558df4c</span><span class="sxs-lookup"><span data-stu-id="08473-302">4f87261d-2816-465d-8311-70a27558df4c</span></span> |<span data-ttu-id="08473-303">um novo GUID criado para a nova atribuição de função</span><span class="sxs-lookup"><span data-stu-id="08473-303">a new guid created for the new role assignment</span></span> |

<span data-ttu-id="08473-304">A resposta está no seguinte formato:</span><span class="sxs-lookup"><span data-stu-id="08473-304">The response is in the following format:</span></span>

    HTTP/1.1 201 Created

    {"properties":{"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2","scope":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb"},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleAssignments/4f87261d-2816-465d-8311-70a27558df4c","type":"Microsoft.Authorization/roleAssignments","name":"4f87261d-2816-465d-8311-70a27558df4c"}

### <a name="get-app-only-access-token-for-azure-resource-manager"></a><span data-ttu-id="08473-305">Obter token de acesso somente de aplicativo para o Azure Resource Manager</span><span class="sxs-lookup"><span data-stu-id="08473-305">Get app-only access token for Azure Resource Manager</span></span>
<span data-ttu-id="08473-306">Para confirmar que o aplicativo tem o acesso desejado na assinatura, execute uma tarefa de teste na assinatura usando um token somente de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="08473-306">To validate that app has the desired access on the subscription, perform a test task on the subscription using an app-only token.</span></span>

<span data-ttu-id="08473-307">Para obter um token de acesso somente de aplicativo, siga as instruções da seção [Obter o token de acesso somente de aplicativo para a API do Azure AD Graph](#app-azure-ad-graph)com um valor diferente para o parâmetro de recurso:</span><span class="sxs-lookup"><span data-stu-id="08473-307">To get an app-only access token, follow instructions from section [Get app-only access token for Azure AD Graph API](#app-azure-ad-graph), with a different value for the resource parameter:</span></span>

    https://management.core.windows.net/

<span data-ttu-id="08473-308">O método [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) do aplicativo de exemplo do ASP.NET MVC obtém um token de acesso somente de aplicativo para o Azure Resource Manager usando a Biblioteca de Autenticação do Active Directory para .NET.</span><span class="sxs-lookup"><span data-stu-id="08473-308">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample application gets an app-only access token for Azure Resource Manager using the Active Directory Authentication Library for .net.</span></span>

#### <a name="get-applications-permissions-on-subscription"></a><span data-ttu-id="08473-309">Obter permissões do aplicativo na assinatura</span><span class="sxs-lookup"><span data-stu-id="08473-309">Get Application's Permissions on Subscription</span></span>
<span data-ttu-id="08473-310">Para verificar se o aplicativo tem o acesso desejado em uma assinatura do Azure, você também pode chamar a API [Permissões do Resource Manager](https://docs.microsoft.com/rest/api/authorization/permissions) .</span><span class="sxs-lookup"><span data-stu-id="08473-310">To check that your application has the desired access on an Azure subscription, you may also call the [Resource Manager Permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API.</span></span> <span data-ttu-id="08473-311">Essa abordagem é semelhante a como você determinou se o usuário tem direitos de Gerenciamento de Acesso para a assinatura.</span><span class="sxs-lookup"><span data-stu-id="08473-311">This approach is similar to how you determined whether the user has Access Management rights for the subscription.</span></span> <span data-ttu-id="08473-312">No entanto, desta vez, chame a API de permissões com o token de acesso somente de aplicativo que foi recebido na etapa anterior.</span><span class="sxs-lookup"><span data-stu-id="08473-312">However, this time, call the permissions API with the app-only access token that you received in the previous step.</span></span>

<span data-ttu-id="08473-313">O método [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) do aplicativo de exemplo do ASP.NET MVC implementa essa chamada.</span><span class="sxs-lookup"><span data-stu-id="08473-313">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample app implements this call.</span></span>

## <a name="manage-connected-subscriptions"></a><span data-ttu-id="08473-314">Gerenciar assinaturas conectadas</span><span class="sxs-lookup"><span data-stu-id="08473-314">Manage connected subscriptions</span></span>
<span data-ttu-id="08473-315">Quando a função RBAC apropriada é atribuída à entidade de serviço do aplicativo na assinatura, seu aplicativo pode continuar monitorando-a/gerenciando-a usando tokens de acesso somente de aplicativo para o Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="08473-315">When the appropriate RBAC role is assigned to your application's service principal on the subscription, your application can keep monitoring/managing it using app-only access tokens for Azure Resource Manager.</span></span>

<span data-ttu-id="08473-316">Se um proprietário de assinatura remover a atribuição de função do aplicativo usando o portal clássico ou as ferramentas de linha de comando, o aplicativo não poderá mais acessar essa assinatura.</span><span class="sxs-lookup"><span data-stu-id="08473-316">If a subscription owner removes your application's role assignment using the classic portal or command-line tools, your application is no longer able to access that subscription.</span></span> <span data-ttu-id="08473-317">Nesse caso, você deve informar ao usuário que a conexão com a assinatura foi cortada fora do aplicativo e dar-lhe uma opção para "reparar" a conexão.</span><span class="sxs-lookup"><span data-stu-id="08473-317">In that case, you should notify the user that the connection with the subscription was severed from outside the application and give them an option to "repair" the connection.</span></span> <span data-ttu-id="08473-318">"Reparar" é simplesmente recriar a atribuição de função que foi excluída offline.</span><span class="sxs-lookup"><span data-stu-id="08473-318">"Repair" would simply re-create the role assignment that was deleted offline.</span></span>

<span data-ttu-id="08473-319">Assim como você habilitou o usuário para conectar as assinaturas ao aplicativo, também é preciso permitir que o usuário desconecte as assinaturas.</span><span class="sxs-lookup"><span data-stu-id="08473-319">Just as you enabled the user to connect subscriptions to your application, you must allow the user to disconnect subscriptions too.</span></span> <span data-ttu-id="08473-320">Do ponto de vista do gerenciamento de acesso, desconectar significa remover a atribuição da função que a entidade do serviço do aplicativo tem na assinatura.</span><span class="sxs-lookup"><span data-stu-id="08473-320">From an access management point of view, disconnect means removing the role assignment that the application's service principal has on the subscription.</span></span> <span data-ttu-id="08473-321">Se desejar, o estado da assinatura no aplicativo também pode ser removido.</span><span class="sxs-lookup"><span data-stu-id="08473-321">Optionally, any state in the application for the subscription might be removed too.</span></span>
<span data-ttu-id="08473-322">Somente os usuários com permissão de gerenciamento de acesso na assinatura podem desconectar a assinatura.</span><span class="sxs-lookup"><span data-stu-id="08473-322">Only users with access management permission on the subscription are able to disconnect the subscription.</span></span>

<span data-ttu-id="08473-323">O método [RevokeRoleFromServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) do aplicativo de exemplo do ASP.NET MVC implementa essa chamada.</span><span class="sxs-lookup"><span data-stu-id="08473-323">The [RevokeRoleFromServicePrincipalOnSubscription method](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="08473-324">Pronto! Agora os usuários podem agora se conectar e gerenciar suas assinaturas do Azure com seu aplicativo facilmente.</span><span class="sxs-lookup"><span data-stu-id="08473-324">That's it - users can now easily connect and manage their Azure subscriptions with your application.</span></span>
