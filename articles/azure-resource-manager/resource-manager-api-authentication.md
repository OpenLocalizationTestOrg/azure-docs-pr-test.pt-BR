---
title: aaaAzure do Active Directory authentication e o Gerenciador de recursos | Microsoft Docs
description: Tooauthentication de guia do desenvolvedor com hello API do Gerenciador de recursos do Azure e Active Directory do Azure para integrar um aplicativo com outras assinaturas do Azure.
services: azure-resource-manager,active-directory
documentationcenter: na
author: dushyantgill
manager: timlt
editor: tysonn
ms.assetid: 17b2b40d-bf42-4c7d-9a88-9938409c5088
ms.service: azure-resource-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 12/27/2016
ms.author: dugill;tomfitz
ms.openlocfilehash: 757e45fdb28488b45de70647746461888bf35a56
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/06/2017
---
# <a name="use-resource-manager-authentication-api-tooaccess-subscriptions"></a><span data-ttu-id="3a90f-103">Usar assinaturas de tooaccess de API de autenticação do Gerenciador de recursos</span><span class="sxs-lookup"><span data-stu-id="3a90f-103">Use Resource Manager authentication API tooaccess subscriptions</span></span>
## <a name="introduction"></a><span data-ttu-id="3a90f-104">Introdução</span><span class="sxs-lookup"><span data-stu-id="3a90f-104">Introduction</span></span>
<span data-ttu-id="3a90f-105">Se você for um desenvolvedor de software que precisa toocreate um aplicativo que gerencia os recursos do Azure do cliente, este tópico mostra como tooauthenticate com hello APIs do Gerenciador de recursos do Azure e obter acesso tooresources em outras assinaturas.</span><span class="sxs-lookup"><span data-stu-id="3a90f-105">If you are a software developer who needs toocreate an app that manages customer's Azure resources, this topic shows you how tooauthenticate with hello Azure Resource Manager APIs and gain access tooresources in other subscriptions.</span></span>

<span data-ttu-id="3a90f-106">Seu aplicativo pode acessar Olá APIs do Gerenciador de recursos de duas maneiras:</span><span class="sxs-lookup"><span data-stu-id="3a90f-106">Your app can access hello Resource Manager APIs in couple of ways:</span></span>

1. <span data-ttu-id="3a90f-107">**Acesso de aplicativo + usuário**: para aplicativos que acessam recursos em nome de um usuário conectado.</span><span class="sxs-lookup"><span data-stu-id="3a90f-107">**User + app access**: for apps that access resources on behalf of a signed-in user.</span></span> <span data-ttu-id="3a90f-108">Essa abordagem funciona para aplicativos, como aplicativos Web e ferramentas de linha de comando, que lidam apenas com "gerenciamento interativo" dos recursos do Azure.</span><span class="sxs-lookup"><span data-stu-id="3a90f-108">This approach works for apps, such as web apps and command-line tools, that deal with only "interactive management" of Azure resources.</span></span>
2. <span data-ttu-id="3a90f-109">**Acesso somente a aplicativos**: para aplicativos que executam serviços daemon e trabalhos agendados.</span><span class="sxs-lookup"><span data-stu-id="3a90f-109">**App-only access**: for apps that run daemon services and scheduled jobs.</span></span> <span data-ttu-id="3a90f-110">identidade do aplicativo Hello recebe recursos de toohello acesso direto.</span><span class="sxs-lookup"><span data-stu-id="3a90f-110">hello app's identity is granted direct access toohello resources.</span></span> <span data-ttu-id="3a90f-111">Essa abordagem funciona para aplicativos que precisam tooAzure de acesso (autônomo) sem cabeçalho de longo prazo.</span><span class="sxs-lookup"><span data-stu-id="3a90f-111">This approach works for apps that need long-term headless (unattended) access tooAzure.</span></span>

<span data-ttu-id="3a90f-112">Este tópico fornece instruções passo a passo toocreate um aplicativo que utiliza esses dois métodos de autorização.</span><span class="sxs-lookup"><span data-stu-id="3a90f-112">This topic provides step-by-step instructions toocreate an app that employs both these authorization methods.</span></span> <span data-ttu-id="3a90f-113">Ele mostra como tooperform cada etapa com API REST ou c#.</span><span class="sxs-lookup"><span data-stu-id="3a90f-113">It shows how tooperform each step with REST API or C#.</span></span> <span data-ttu-id="3a90f-114">aplicativo ASP.NET MVC completo de saudação está disponível em [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span><span class="sxs-lookup"><span data-stu-id="3a90f-114">hello complete ASP.NET MVC application is available at [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span></span>

## <a name="what-hello-web-app-does"></a><span data-ttu-id="3a90f-115">O aplicativo web de saudação não</span><span class="sxs-lookup"><span data-stu-id="3a90f-115">What hello web app does</span></span>
<span data-ttu-id="3a90f-116">Olá web app:</span><span class="sxs-lookup"><span data-stu-id="3a90f-116">hello web app:</span></span>

1. <span data-ttu-id="3a90f-117">Conecta um usuário do Azure.</span><span class="sxs-lookup"><span data-stu-id="3a90f-117">Signs-in an Azure user.</span></span>
2. <span data-ttu-id="3a90f-118">Solicita acesso usuário toogrant Olá web aplicativo tooResource Manager.</span><span class="sxs-lookup"><span data-stu-id="3a90f-118">Asks user toogrant hello web app access tooResource Manager.</span></span>
3. <span data-ttu-id="3a90f-119">Obtém o token de acesso de usuário + aplicativo acessando o Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="3a90f-119">Gets user + app access token for accessing Resource Manager.</span></span>
4. <span data-ttu-id="3a90f-120">Usa toocall token (da etapa 3) o Gerenciador de recursos e a função de tooa principal de serviço do aplicativo de saudação atribuir na assinatura hello, que dá a assinatura toohello de acesso a longo prazo Olá aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3a90f-120">Uses token (from step 3) toocall Resource Manager and assign hello app's service principal tooa role in hello subscription, which gives hello app long-term access toohello subscription.</span></span>
5. <span data-ttu-id="3a90f-121">Obtém o token de acesso somente ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3a90f-121">Gets app-only access token.</span></span>
6. <span data-ttu-id="3a90f-122">Usa recursos de token (da etapa 5) toomanage na assinatura Olá por meio do Gerenciador de recursos.</span><span class="sxs-lookup"><span data-stu-id="3a90f-122">Uses token (from step 5) toomanage resources in hello subscription through Resource Manager.</span></span>

<span data-ttu-id="3a90f-123">Aqui está o fluxo de ponta a ponta de saudação do aplicativo da web hello.</span><span class="sxs-lookup"><span data-stu-id="3a90f-123">Here's hello end-to-end flow of hello web application.</span></span>

![Fluxo de autenticação do Resource Manager](./media/resource-manager-api-authentication/Auth-Swim-Lane.png)

<span data-ttu-id="3a90f-125">Como um usuário forneça a id da assinatura Olá assinatura Olá deseja toouse:</span><span class="sxs-lookup"><span data-stu-id="3a90f-125">As a user, you provide hello subscription id for hello subscription you want toouse:</span></span>

![fornecer ID de assinatura](./media/resource-manager-api-authentication/sample-ux-1.png)

<span data-ttu-id="3a90f-127">Selecione Olá toouse de conta para efetuar login.</span><span class="sxs-lookup"><span data-stu-id="3a90f-127">Select hello account toouse for logging in.</span></span>

![escolher conta](./media/resource-manager-api-authentication/sample-ux-2.png)

<span data-ttu-id="3a90f-129">Forneça suas credenciais.</span><span class="sxs-lookup"><span data-stu-id="3a90f-129">Provide your credentials.</span></span>

![fornecer credenciais](./media/resource-manager-api-authentication/sample-ux-3.png)

<span data-ttu-id="3a90f-131">Conceda tooyour de acesso do aplicativo hello assinaturas do Azure:</span><span class="sxs-lookup"><span data-stu-id="3a90f-131">Grant hello app access tooyour Azure subscriptions:</span></span>

![Conceder acesso](./media/resource-manager-api-authentication/sample-ux-4.png)

<span data-ttu-id="3a90f-133">Gerencie as assinaturas conectadas:</span><span class="sxs-lookup"><span data-stu-id="3a90f-133">Manage your connected subscriptions:</span></span>

![Conectar assinatura](./media/resource-manager-api-authentication/sample-ux-7.png)

## <a name="register-application"></a><span data-ttu-id="3a90f-135">Registrar aplicativo</span><span class="sxs-lookup"><span data-stu-id="3a90f-135">Register application</span></span>
<span data-ttu-id="3a90f-136">Antes de iniciar a codificação, registre o aplicativo Web com o Azure AD (Active Directory).</span><span class="sxs-lookup"><span data-stu-id="3a90f-136">Before you start coding, register your web app with Azure Active Directory (AD).</span></span> <span data-ttu-id="3a90f-137">o registro do aplicativo Hello cria uma identidade central para seu aplicativo no AD do Azure.</span><span class="sxs-lookup"><span data-stu-id="3a90f-137">hello app registration creates a central identity for your app in Azure AD.</span></span> <span data-ttu-id="3a90f-138">Ela contém informações básicas sobre o seu aplicativo como ID do cliente OAuth, URLs de resposta e as credenciais que o aplicativo usa tooauthenticate e acesso a APIs do Gerenciador de recursos do Azure.</span><span class="sxs-lookup"><span data-stu-id="3a90f-138">It holds basic information about your application like OAuth Client ID, Reply URLs, and credentials that your application uses tooauthenticate and access Azure Resource Manager APIs.</span></span> <span data-ttu-id="3a90f-139">o registro do aplicativo Hello também registra Olá várias permissões que seu aplicativo precisa ao acessar APIs Microsoft em nome de usuário de saudação.</span><span class="sxs-lookup"><span data-stu-id="3a90f-139">hello app registration also records hello various delegated permissions that your application needs when accessing Microsoft APIs on behalf of hello user.</span></span>

<span data-ttu-id="3a90f-140">Como o aplicativo acessa outra assinatura, você deve configurá-lo como um aplicativo multilocatário.</span><span class="sxs-lookup"><span data-stu-id="3a90f-140">Because your app accesses other subscription, you must configure it as a multi-tenant application.</span></span> <span data-ttu-id="3a90f-141">validação de toopass, forneça um domínio associado com o Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="3a90f-141">toopass validation, provide a domain associated with your Azure Active Directory.</span></span> <span data-ttu-id="3a90f-142">domínios de saudação toosee associados com o Active Directory do Azure, o log em toohello [portal clássico](https://manage.windowsazure.com).</span><span class="sxs-lookup"><span data-stu-id="3a90f-142">toosee hello domains associated with your Azure Active Directory, log in toohello [classic portal](https://manage.windowsazure.com).</span></span> <span data-ttu-id="3a90f-143">Selecione o Azure Active Directory e depois **Domínios**.</span><span class="sxs-lookup"><span data-stu-id="3a90f-143">Select your Azure Active Directory and then select **Domains**.</span></span>

<span data-ttu-id="3a90f-144">saudação de exemplo a seguir mostra como tooregister Olá aplicativo usando o PowerShell do Azure.</span><span class="sxs-lookup"><span data-stu-id="3a90f-144">hello following example shows how tooregister hello app by using Azure PowerShell.</span></span> <span data-ttu-id="3a90f-145">Você deve ter Olá versão mais recente (agosto de 2016) do PowerShell do Azure para este comando toowork.</span><span class="sxs-lookup"><span data-stu-id="3a90f-145">You must have hello latest version (August 2016) of Azure PowerShell for this command toowork.</span></span>

    $app = New-AzureRmADApplication -DisplayName "{app name}" -HomePage "https://{your domain}/{app name}" -IdentifierUris "https://{your domain}/{app name}" -Password "{your password}" -AvailableToOtherTenants $true

<span data-ttu-id="3a90f-146">toolog em como Olá aplicativo do AD, é necessário senha e a id do aplicativo hello.</span><span class="sxs-lookup"><span data-stu-id="3a90f-146">toolog in as hello AD application, you need hello application id and password.</span></span> <span data-ttu-id="3a90f-147">toosee Olá id do aplicativo que é retornado pelo comando anterior hello, use:</span><span class="sxs-lookup"><span data-stu-id="3a90f-147">toosee hello application id that is returned from hello previous command, use:</span></span>

    $app.ApplicationId

<span data-ttu-id="3a90f-148">saudação de exemplo a seguir mostra como tooregister Olá aplicativo usando a CLI do Azure.</span><span class="sxs-lookup"><span data-stu-id="3a90f-148">hello following example shows how tooregister hello app by using Azure CLI.</span></span>

    azure ad app create --name {app name} --home-page https://{your domain}/{app name} --identifier-uris https://{your domain}/{app name} --password {your password} --available true

<span data-ttu-id="3a90f-149">resultados da saudação incluem hello AppId, que é necessário ao autenticar como aplicativo hello.</span><span class="sxs-lookup"><span data-stu-id="3a90f-149">hello results include hello AppId, which you need when authenticating as hello application.</span></span>

### <a name="optional-configuration---certificate-credential"></a><span data-ttu-id="3a90f-150">Configuração opcional - credenciais de certificado</span><span class="sxs-lookup"><span data-stu-id="3a90f-150">Optional configuration - certificate credential</span></span>
<span data-ttu-id="3a90f-151">O AD do Azure também oferece suporte a credenciais de certificado para aplicativos: criar um certificado autoassinado, mantenha a chave privada hello e adicionar o registro do aplicativo hello tooyour de chave pública do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="3a90f-151">Azure AD also supports certificate credentials for applications: you create a self-signed cert, keep hello private key, and add hello public key tooyour Azure AD application registration.</span></span> <span data-ttu-id="3a90f-152">Para autenticação, o aplicativo envia tooAzure uma pequena carga AD assinado usando sua chave privada e o AD do Azure valida a assinatura de saudação usando a chave pública de saudação que você registrou.</span><span class="sxs-lookup"><span data-stu-id="3a90f-152">For authentication, your application sends a small payload tooAzure AD signed using your private key, and Azure AD validates hello signature using hello public key that you registered.</span></span>

<span data-ttu-id="3a90f-153">Para obter informações sobre como criar um aplicativo do AD com um certificado, consulte [toocreate de usar o Azure PowerShell uma entidade de serviço recursos tooaccess](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) ou [toocreate CLI do Azure Use uma entidade de serviço tooaccess recursos](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate).</span><span class="sxs-lookup"><span data-stu-id="3a90f-153">For information about creating an AD app with a certificate, see [Use Azure PowerShell toocreate a service principal tooaccess resources](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) or [Use Azure CLI toocreate a service principal tooaccess resources](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate).</span></span>

## <a name="get-tenant-id-from-subscription-id"></a><span data-ttu-id="3a90f-154">Obter ID de locatário da ID de assinatura</span><span class="sxs-lookup"><span data-stu-id="3a90f-154">Get tenant id from subscription id</span></span>
<span data-ttu-id="3a90f-155">toorequest um token que pode ser usado toocall Gerenciador de recursos, seu aplicativo precisa tooknow Olá locatário ID de locatário de saudação do AD do Azure que hospeda Olá assinatura do Azure.</span><span class="sxs-lookup"><span data-stu-id="3a90f-155">toorequest a token that can be used toocall Resource Manager, your application needs tooknow hello tenant ID of hello Azure AD tenant that hosts hello Azure subscription.</span></span> <span data-ttu-id="3a90f-156">É bem provável que os usuários saibam as respectivas IDs de assinatura, mas talvez não saibam as IDs de seus locatários para o Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="3a90f-156">Most likely, your users know their subscription ids, but they might not know their tenant ids for Azure Active Directory.</span></span> <span data-ttu-id="3a90f-157">tooget Olá id de locatário do usuário, peça ao usuário Olá Olá id da assinatura. Forneça essa id de assinatura ao enviar uma solicitação de assinatura de saudação:</span><span class="sxs-lookup"><span data-stu-id="3a90f-157">tooget hello user's tenant id, ask hello user for hello subscription id. Provide that subscription id when sending a request about hello subscription:</span></span>

    https://management.azure.com/subscriptions/{subscription-id}?api-version=2015-01-01

<span data-ttu-id="3a90f-158">Falha na solicitação de saudação porque Olá usuário não foi conectado ainda, mas você pode recuperar a id de locatário de saudação da resposta de saudação.</span><span class="sxs-lookup"><span data-stu-id="3a90f-158">hello request fails because hello user has not logged in yet, but you can retrieve hello tenant id from hello response.</span></span> <span data-ttu-id="3a90f-159">Essa exceção, recuperar id de locatário de saudação do valor de cabeçalho de resposta Olá para **WWW-Authenticate**.</span><span class="sxs-lookup"><span data-stu-id="3a90f-159">In that exception, retrieve hello tenant id from hello response header value for **WWW-Authenticate**.</span></span> <span data-ttu-id="3a90f-160">Consulte esta implementação em Olá [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) método.</span><span class="sxs-lookup"><span data-stu-id="3a90f-160">You see this implementation in hello [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) method.</span></span>

## <a name="get-user--app-access-token"></a><span data-ttu-id="3a90f-161">Obter token de acesso ao aplicativo + usuário</span><span class="sxs-lookup"><span data-stu-id="3a90f-161">Get user + app access token</span></span>
<span data-ttu-id="3a90f-162">Seu aplicativo redireciona Olá usuário tooAzure AD com um OAuth 2.0 autorizar solicitar - tooauthenticate Olá as credenciais de usuário e voltar a um código de autorização.</span><span class="sxs-lookup"><span data-stu-id="3a90f-162">Your application redirects hello user tooAzure AD with an OAuth 2.0 Authorize Request - tooauthenticate hello user's credentials and get back an authorization code.</span></span> <span data-ttu-id="3a90f-163">Seu aplicativo usa tooget código de autorização Olá um token de acesso para o Gerenciador de recursos.</span><span class="sxs-lookup"><span data-stu-id="3a90f-163">Your application uses hello authorization code tooget an access token for Resource Manager.</span></span> <span data-ttu-id="3a90f-164">Olá [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) método cria a solicitação de autorização de saudação.</span><span class="sxs-lookup"><span data-stu-id="3a90f-164">hello [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) method creates hello authorization request.</span></span>

<span data-ttu-id="3a90f-165">Este tópico mostra o usuário de saudação do hello API REST solicitações tooauthenticate.</span><span class="sxs-lookup"><span data-stu-id="3a90f-165">This topic shows hello REST API requests tooauthenticate hello user.</span></span> <span data-ttu-id="3a90f-166">Você também pode usar a autenticação do auxiliar bibliotecas tooperform em seu código.</span><span class="sxs-lookup"><span data-stu-id="3a90f-166">You can also use helper libraries tooperform authentication in your code.</span></span> <span data-ttu-id="3a90f-167">Para saber mais sobre essas bibliotecas, confira [Bibliotecas de autenticação do Azure Active Directory](../active-directory/active-directory-authentication-libraries.md).</span><span class="sxs-lookup"><span data-stu-id="3a90f-167">For more information about these libraries, see [Azure Active Directory Authentication Libraries](../active-directory/active-directory-authentication-libraries.md).</span></span> <span data-ttu-id="3a90f-168">Para obter instruções sobre como integrar o gerenciamento de identidades em um aplicativo, confira [Guia do desenvolvedor do Azure Active Directory](../active-directory/active-directory-developers-guide.md).</span><span class="sxs-lookup"><span data-stu-id="3a90f-168">For guidance on integrating identity management in an application, see [Azure Active Directory developer's guide](../active-directory/active-directory-developers-guide.md).</span></span>

### <a name="auth-request-oauth-20"></a><span data-ttu-id="3a90f-169">Solicitação de autorização (OAuth 2.0)</span><span class="sxs-lookup"><span data-stu-id="3a90f-169">Auth request (OAuth 2.0)</span></span>
<span data-ttu-id="3a90f-170">Emita um ponto de extremidade de autorização toohello AD do Azure abrir conectar/OAuth 2.0 autorizar solicitações de identificação:</span><span class="sxs-lookup"><span data-stu-id="3a90f-170">Issue an Open ID Connect/OAuth2.0 Authorize Request toohello Azure AD Authorize endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize

<span data-ttu-id="3a90f-171">parâmetros de cadeia de caracteres de consulta de saudação que estão disponíveis para esta solicitação são descritos em Olá [solicitar um código de autorização](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) tópico.</span><span class="sxs-lookup"><span data-stu-id="3a90f-171">hello query string parameters that are available for this request are described in hello [request an authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) topic.</span></span>

<span data-ttu-id="3a90f-172">Olá mostrado no exemplo a seguir como toorequest autorização do OAuth 2.0:</span><span class="sxs-lookup"><span data-stu-id="3a90f-172">hello following example shows how toorequest OAuth2.0 authorization:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=query&response_type=code&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&domain_hint=live.com

<span data-ttu-id="3a90f-173">O AD do Azure autentica o usuário hello e, se necessário, pede Olá usuário toogrant permissão toohello aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3a90f-173">Azure AD authenticates hello user, and, if necessary, asks hello user toogrant permission toohello app.</span></span> <span data-ttu-id="3a90f-174">Ele retorna toohello código de autorização Olá URL de resposta do seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3a90f-174">It returns hello authorization code toohello Reply URL of your application.</span></span> <span data-ttu-id="3a90f-175">Dependendo da saudação solicitado response_mode, o envia de volta Olá dados na cadeia de caracteres de consulta ou como dados de postagem do AD do Azure.</span><span class="sxs-lookup"><span data-stu-id="3a90f-175">Depending on hello requested response_mode, Azure AD either sends back hello data in query string or as post data.</span></span>

    code=AAABAAAAiL****FDMZBUwZ8eCAA&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="auth-request-open-id-connect"></a><span data-ttu-id="3a90f-176">Solicitação de autorização (Open ID Connect)</span><span class="sxs-lookup"><span data-stu-id="3a90f-176">Auth request (Open ID Connect)</span></span>
<span data-ttu-id="3a90f-177">Se você não só deseja tooaccess Gerenciador de recursos do Azure em nome de usuário hello, mas também permite Olá usuário toosign no aplicativo tooyour usando sua conta do AD do Azure, execute um Open ID autorizar solicitação de conexão.</span><span class="sxs-lookup"><span data-stu-id="3a90f-177">If you not only wish tooaccess Azure Resource Manager on behalf of hello user, but also allow hello user toosign in tooyour application using their Azure AD account, issue an Open ID Connect Authorize Request.</span></span> <span data-ttu-id="3a90f-178">Com o Open ID Connect, seu aplicativo também recebe um id_token do AD do Azure que seu aplicativo pode usar toosign usuário hello.</span><span class="sxs-lookup"><span data-stu-id="3a90f-178">With Open ID Connect, your application also receives an id_token from Azure AD that your app can use toosign in hello user.</span></span>

<span data-ttu-id="3a90f-179">parâmetros de cadeia de caracteres de consulta de saudação que estão disponíveis para esta solicitação são descritos em Olá [Olá entrar a solicitação de envio](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) tópico.</span><span class="sxs-lookup"><span data-stu-id="3a90f-179">hello query string parameters that are available for this request are described in hello [Send hello sign-in request](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) topic.</span></span>

<span data-ttu-id="3a90f-180">Eis um exemplo de solicitação Open ID Connect:</span><span class="sxs-lookup"><span data-stu-id="3a90f-180">An example Open ID Connect request is:</span></span>

     https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=form_post&response_type=code+id_token&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&scope=openid+profile&nonce=63567Dc4MDAw&domain_hint=live.com&state=M_12tMyKaM8

<span data-ttu-id="3a90f-181">O AD do Azure autentica o usuário hello e, se necessário, pede Olá usuário toogrant permissão toohello aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3a90f-181">Azure AD authenticates hello user, and, if necessary, asks hello user toogrant permission toohello app.</span></span> <span data-ttu-id="3a90f-182">Ele retorna toohello código de autorização Olá URL de resposta do seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3a90f-182">It returns hello authorization code toohello Reply URL of your application.</span></span> <span data-ttu-id="3a90f-183">Dependendo da saudação solicitado response_mode, o envia de volta Olá dados na cadeia de caracteres de consulta ou como dados de postagem do AD do Azure.</span><span class="sxs-lookup"><span data-stu-id="3a90f-183">Depending on hello requested response_mode, Azure AD either sends back hello data in query string or as post data.</span></span>

<span data-ttu-id="3a90f-184">Eis um exemplo de resposta Open ID Connect:</span><span class="sxs-lookup"><span data-stu-id="3a90f-184">An example Open ID Connect response is:</span></span>

    code=AAABAAAAiL*****I4rDWd7zXsH6WUjlkIEQxIAA&id_token=eyJ0eXAiOiJKV1Q*****T3GrzzSFxg&state=M_12tMyKaM8&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="token-request-oauth20-code-grant-flow"></a><span data-ttu-id="3a90f-185">Solicitação de token (Fluxo de concessão de código OAuth 2.0)</span><span class="sxs-lookup"><span data-stu-id="3a90f-185">Token request (OAuth2.0 Code Grant Flow)</span></span>
<span data-ttu-id="3a90f-186">Agora que seu aplicativo tiver recebido o código de autorização de saudação do AD do Azure, é o token de acesso de saudação do tempo tooget para o Gerenciador de recursos do Azure.</span><span class="sxs-lookup"><span data-stu-id="3a90f-186">Now that your application has received hello authorization code from Azure AD, it is time tooget hello access token for Azure Resource Manager.</span></span>  <span data-ttu-id="3a90f-187">Poste um solicitação Token do OAuth 2.0 código Grant toohello Token de AD do Azure ponto de extremidade:</span><span class="sxs-lookup"><span data-stu-id="3a90f-187">Post an OAuth2.0 Code Grant Token Request toohello Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="3a90f-188">parâmetros de cadeia de caracteres de consulta de saudação que estão disponíveis para esta solicitação são descritos em Olá [usar código de autorização Olá](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) tópico.</span><span class="sxs-lookup"><span data-stu-id="3a90f-188">hello query string parameters that are available for this request are described in hello [use hello authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) topic.</span></span>

<span data-ttu-id="3a90f-189">saudação de exemplo a seguir mostra uma solicitação de token de concessão de código com credencial de senha:</span><span class="sxs-lookup"><span data-stu-id="3a90f-189">hello following example shows a request for code grant token with password credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="3a90f-190">Ao trabalhar com as credenciais de certificado, crie um JSON Web Token (JWT) e o sinal (RSA SHA256) usando Olá a chave privada da credencial de certificado do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3a90f-190">When working with certificate credentials, create a JSON Web Token (JWT) and sign (RSA SHA256) using hello private key of your application's certificate credential.</span></span> <span data-ttu-id="3a90f-191">Olá tipos de declaração de token de saudação são mostrados na [declarações do token de JWT](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span><span class="sxs-lookup"><span data-stu-id="3a90f-191">hello claim types for hello token are shown in [JWT token claims](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span></span> <span data-ttu-id="3a90f-192">Para referência, consulte Olá [código de biblioteca de autenticação do Active Directory (.NET)](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) toosign de tokens JWT de asserção do cliente.</span><span class="sxs-lookup"><span data-stu-id="3a90f-192">For reference, see hello [Active Directory Auth Library (.NET) code](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) toosign Client Assertion JWT tokens.</span></span>

<span data-ttu-id="3a90f-193">Consulte Olá [abrir conexão de ID especificação](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) para obter detalhes sobre autenticação de cliente.</span><span class="sxs-lookup"><span data-stu-id="3a90f-193">See hello [Open ID Connect spec](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) for details on client authentication.</span></span>

<span data-ttu-id="3a90f-194">saudação de exemplo a seguir mostra uma solicitação de token de concessão de código com credenciais de certificado:</span><span class="sxs-lookup"><span data-stu-id="3a90f-194">hello following example shows a request for code grant token with certificate credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer&client_assertion=eyJhbG*****Y9cYo8nEjMyA

<span data-ttu-id="3a90f-195">Um exemplo de resposta de token de concessão de código:</span><span class="sxs-lookup"><span data-stu-id="3a90f-195">An example response for code grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039858","not_before":"1432035958","resource":"https://management.core.windows.net/","access_token":"eyJ0eXAiOiJKV1Q****M7Cw6JWtfY2lGc5A","refresh_token":"AAABAAAAiL9Kn2Z****55j-sjnyYgAA","scope":"user_impersonation","id_token":"eyJ0eXAiOiJKV*****-drP1J3P-HnHi9Rr46kGZnukEBH4dsg"}

#### <a name="handle-code-grant-token-response"></a><span data-ttu-id="3a90f-196">Manipular resposta de token de concessão de código</span><span class="sxs-lookup"><span data-stu-id="3a90f-196">Handle code grant token response</span></span>
<span data-ttu-id="3a90f-197">Uma resposta bem-sucedida de token contém o token de acesso de saudação (usuário + aplicativo) para o Gerenciador de recursos do Azure.</span><span class="sxs-lookup"><span data-stu-id="3a90f-197">A successful token response contains hello (user + app) access token for Azure Resource Manager.</span></span> <span data-ttu-id="3a90f-198">Seu aplicativo usa esse acesso token tooaccess Gerenciador de recursos em nome de usuário de saudação.</span><span class="sxs-lookup"><span data-stu-id="3a90f-198">Your application uses this access token tooaccess Resource Manager on behalf of hello user.</span></span> <span data-ttu-id="3a90f-199">tempo de vida de saudação de tokens de acesso emitido pelo AD do Azure é uma hora.</span><span class="sxs-lookup"><span data-stu-id="3a90f-199">hello lifetime of access tokens issued by Azure AD is one hour.</span></span> <span data-ttu-id="3a90f-200">É improvável que seu aplicativo da web precisa de token de acesso do toorenew hello (usuário + aplicativo).</span><span class="sxs-lookup"><span data-stu-id="3a90f-200">It is unlikely that your web application needs toorenew hello (user + app) access token.</span></span> <span data-ttu-id="3a90f-201">Se precisar de token de acesso do toorenew Olá, use o token de atualização de saudação que seu aplicativo recebe na resposta de token hello.</span><span class="sxs-lookup"><span data-stu-id="3a90f-201">If it needs toorenew hello access token, use hello refresh token that your application receives in hello token response.</span></span> <span data-ttu-id="3a90f-202">Poste um solicitação de Token OAuth 2.0 toohello Token de AD do Azure ponto de extremidade:</span><span class="sxs-lookup"><span data-stu-id="3a90f-202">Post an OAuth2.0 Token Request toohello Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="3a90f-203">Olá toouse parâmetros com a solicitação de atualização de saudação são descritos em [atualização token de acesso de saudação](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span><span class="sxs-lookup"><span data-stu-id="3a90f-203">hello parameters toouse with hello refresh request are described in [refreshing hello access token](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span></span>

<span data-ttu-id="3a90f-204">Olá exemplo a seguir mostra como o token de atualização toouse hello:</span><span class="sxs-lookup"><span data-stu-id="3a90f-204">hello following example shows how toouse hello refresh token:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=refresh_token&refresh_token=AAABAAAAiL9Kn2Z****55j-sjnyYgAA&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="3a90f-205">Embora os tokens de atualização podem ser usado tooget novos tokens de acesso para o Azure Resource Manager, eles não são adequados para acesso offline por seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3a90f-205">Although refresh tokens can be used tooget new access tokens for Azure Resource Manager, they are not suitable for offline access by your application.</span></span> <span data-ttu-id="3a90f-206">tempo de vida de tokens de atualização Olá é limitado e tokens de atualização são usuário toohello associado.</span><span class="sxs-lookup"><span data-stu-id="3a90f-206">hello refresh tokens lifetime is limited, and refresh tokens are bound toohello user.</span></span> <span data-ttu-id="3a90f-207">Se o usuário Olá deixa a organização hello, aplicativo hello usando o token de atualização Olá perde o acesso.</span><span class="sxs-lookup"><span data-stu-id="3a90f-207">If hello user leaves hello organization, hello application using hello refresh token loses access.</span></span> <span data-ttu-id="3a90f-208">Essa abordagem não é adequada para aplicativos que são usadas por equipes toomanage seus recursos do Azure.</span><span class="sxs-lookup"><span data-stu-id="3a90f-208">This approach isn't suitable for applications that are used by teams toomanage their Azure resources.</span></span>

## <a name="check-if-user-can-assign-access-toosubscription"></a><span data-ttu-id="3a90f-209">Verifique se o usuário pode atribuir acesso toosubscription</span><span class="sxs-lookup"><span data-stu-id="3a90f-209">Check if user can assign access toosubscription</span></span>
<span data-ttu-id="3a90f-210">Seu aplicativo agora tem um token tooaccess Gerenciador de recursos do Azure em nome de usuário de saudação.</span><span class="sxs-lookup"><span data-stu-id="3a90f-210">Your application now has a token tooaccess Azure Resource Manager on behalf of hello user.</span></span> <span data-ttu-id="3a90f-211">próxima etapa do Hello é tooconnect sua assinatura do aplicativo toohello.</span><span class="sxs-lookup"><span data-stu-id="3a90f-211">hello next step is tooconnect your app toohello subscription.</span></span> <span data-ttu-id="3a90f-212">Depois de se conectar, seu aplicativo pode gerenciar as assinaturas mesmo quando o usuário Olá não estiver presente (acesso offline a longo prazo).</span><span class="sxs-lookup"><span data-stu-id="3a90f-212">After connecting, your app can manage those subscriptions even when hello user isn't present (long-term offline access).</span></span>

<span data-ttu-id="3a90f-213">Para cada tooconnect de assinatura, chame Olá [permissões de lista do Gerenciador de recursos](https://docs.microsoft.com/rest/api/authorization/permissions) API toodetermine se o usuário Olá tem direitos de gerenciamento de acesso para a assinatura de saudação.</span><span class="sxs-lookup"><span data-stu-id="3a90f-213">For each subscription tooconnect, call hello [Resource Manager list permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API toodetermine whether hello user has access management rights for hello subscription.</span></span>

<span data-ttu-id="3a90f-214">Olá [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) método hello amostra de aplicativo do ASP.NET MVC implementa esta chamada.</span><span class="sxs-lookup"><span data-stu-id="3a90f-214">hello [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) method of hello ASP.NET MVC sample app implements this call.</span></span>

<span data-ttu-id="3a90f-215">Olá mostrado no exemplo a seguir como toorequest permissões de um usuário em uma assinatura.</span><span class="sxs-lookup"><span data-stu-id="3a90f-215">hello following example shows how toorequest a user's permissions on a subscription.</span></span> <span data-ttu-id="3a90f-216">83cfe939-2402-4581-b761-4f59b0a041e4 é a id de saudação de assinatura de saudação.</span><span class="sxs-lookup"><span data-stu-id="3a90f-216">83cfe939-2402-4581-b761-4f59b0a041e4 is hello id of hello subscription.</span></span>

    GET https://management.azure.com/subscriptions/83cfe939-2402-4581-b761-4f59b0a041e4/providers/microsoft.authorization/permissions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiLC***lwO1mM7Cw6JWtfY2lGc5A

<span data-ttu-id="3a90f-217">Um exemplo de permissões do usuário do hello resposta tooget na assinatura é:</span><span class="sxs-lookup"><span data-stu-id="3a90f-217">An example of hello response tooget user's permissions on subscription is:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"actions":["*"],"notActions":["Microsoft.Authorization/*/Write","Microsoft.Authorization/*/Delete"]},{"actions":["*/read"],"notActions":[]}]}

<span data-ttu-id="3a90f-218">permissões de saudação API retorna várias permissões.</span><span class="sxs-lookup"><span data-stu-id="3a90f-218">hello permissions API returns multiple permissions.</span></span> <span data-ttu-id="3a90f-219">Cada permissão consiste em ações permitidas (actions) e ações não permitidas (notactions).</span><span class="sxs-lookup"><span data-stu-id="3a90f-219">Each permission consists of allowed actions (actions) and disallowed actions (notactions).</span></span> <span data-ttu-id="3a90f-220">Se uma ação está presente no hello permitido a lista de ações de permissão e não está presente na lista de notactions Olá dessa permissão, o usuário de saudação é permitido tooperform essa ação.</span><span class="sxs-lookup"><span data-stu-id="3a90f-220">If an action is present in hello allowed actions list of any permission and not present in hello notactions list of that permission, hello user is allowed tooperform that action.</span></span> <span data-ttu-id="3a90f-221">**Microsoft.Authorization/RoleAssignments/Write** ação Olá que que concede acesso rights management.</span><span class="sxs-lookup"><span data-stu-id="3a90f-221">**microsoft.authorization/roleassignments/write** is hello action that that grants access management rights.</span></span> <span data-ttu-id="3a90f-222">Seu aplicativo deve analisar Olá permissões resultado toolook uma correspondência de regex nessa cadeia de caracteres de ação em ações hello e notactions de cada permissão.</span><span class="sxs-lookup"><span data-stu-id="3a90f-222">Your application must parse hello permissions result toolook for a regex match on this action string in hello actions and notactions of each permission.</span></span>

## <a name="get-app-only-access-token"></a><span data-ttu-id="3a90f-223">Obter token de acesso somente ao aplicativo</span><span class="sxs-lookup"><span data-stu-id="3a90f-223">Get app-only access token</span></span>
<span data-ttu-id="3a90f-224">Agora, você sabe se o usuário Olá pode atribuir acesso toohello assinatura do Azure.</span><span class="sxs-lookup"><span data-stu-id="3a90f-224">Now, you know if hello user can assign access toohello Azure subscription.</span></span> <span data-ttu-id="3a90f-225">Olá próximas etapas são:</span><span class="sxs-lookup"><span data-stu-id="3a90f-225">hello next steps are:</span></span>

1. <span data-ttu-id="3a90f-226">Atribua Olá apropriado RBAC função tooyour identidade do aplicativo na assinatura de saudação.</span><span class="sxs-lookup"><span data-stu-id="3a90f-226">Assign hello appropriate RBAC role tooyour application's identity on hello subscription.</span></span>
2. <span data-ttu-id="3a90f-227">Valide a atribuição de acesso de saudação consultando a permissão do aplicativo hello assinatura hello ou acessando o Gerenciador de recursos usando o token somente de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3a90f-227">Validate hello access assignment by querying for hello Application's permission on hello subscription or by accessing Resource Manager using app-only token.</span></span>
3. <span data-ttu-id="3a90f-228">Conexão de registro Olá em sua estrutura de dados de aplicativos "assinaturas conectado" - persistência id Olá de assinatura de saudação.</span><span class="sxs-lookup"><span data-stu-id="3a90f-228">Record hello connection in your applications "connected subscriptions" data structure - persisting hello id of hello subscription.</span></span>

<span data-ttu-id="3a90f-229">Vamos analisar mais detalhadamente a primeira etapa de saudação.</span><span class="sxs-lookup"><span data-stu-id="3a90f-229">Let's look closer at hello first step.</span></span> <span data-ttu-id="3a90f-230">tooassign Olá apropriado RBAC função toohello identidade do aplicativo, você deve determinar:</span><span class="sxs-lookup"><span data-stu-id="3a90f-230">tooassign hello appropriate RBAC role toohello application's identity, you must determine:</span></span>

* <span data-ttu-id="3a90f-231">id de objeto de saudação da identidade do aplicativo no Active Directory do Azure do usuário Olá</span><span class="sxs-lookup"><span data-stu-id="3a90f-231">hello object id of your application's identity in hello user's Azure Active Directory</span></span>
* <span data-ttu-id="3a90f-232">Olá identificador da função RBAC Olá que seu aplicativo requer assinatura Olá</span><span class="sxs-lookup"><span data-stu-id="3a90f-232">hello identifier of hello RBAC role that your application requires on hello subscription</span></span>

<span data-ttu-id="3a90f-233">Quando o aplicativo autentica um usuário em um Azure AD, ele cria um objeto de entidade de serviço para o aplicativo nesse Azure AD.</span><span class="sxs-lookup"><span data-stu-id="3a90f-233">When your application authenticates a user from an Azure AD, it creates a service principal object for your application in that Azure AD.</span></span> <span data-ttu-id="3a90f-234">O Azure permite RBAC funções toobe atribuído entidades tooservice aplicativos de toocorresponding toogrant acesso direto em recursos do Azure.</span><span class="sxs-lookup"><span data-stu-id="3a90f-234">Azure allows RBAC roles toobe assigned tooservice principals toogrant direct access toocorresponding applications on Azure resources.</span></span> <span data-ttu-id="3a90f-235">Esta ação é exatamente o que desejamos toodo.</span><span class="sxs-lookup"><span data-stu-id="3a90f-235">This action is exactly what we wish toodo.</span></span> <span data-ttu-id="3a90f-236">Consulta hello Azure AD Graph API toodetermine Olá identificador da entidade de serviço de saudação do seu aplicativo no usuário conectado Olá 's AD do Azure.</span><span class="sxs-lookup"><span data-stu-id="3a90f-236">Query hello Azure AD Graph API toodetermine hello identifier of hello service principal of your application in hello signed-in user's Azure AD.</span></span>

<span data-ttu-id="3a90f-237">Você só tem um token de acesso para o Gerenciador de recursos do Azure - você precisa de uma novo saudação de toocall token de acesso do Azure AD Graph API.</span><span class="sxs-lookup"><span data-stu-id="3a90f-237">You only have an access token for Azure Resource Manager - you need a new access token toocall hello Azure AD Graph API.</span></span> <span data-ttu-id="3a90f-238">Cada aplicativo no AD do Azure tem permissão tooquery seu próprio objeto de entidade de serviço, para que um token de acesso somente de aplicativo é suficiente.</span><span class="sxs-lookup"><span data-stu-id="3a90f-238">Every application in Azure AD has permission tooquery its own service principal object, so an app-only access token is sufficient.</span></span>

<a id="app-azure-ad-graph" />

### <a name="get-app-only-access-token-for-azure-ad-graph-api"></a><span data-ttu-id="3a90f-239">Obter o token de acesso somente de aplicativo para a API do Azure AD Graph</span><span class="sxs-lookup"><span data-stu-id="3a90f-239">Get app-only access token for Azure AD Graph API</span></span>
<span data-ttu-id="3a90f-240">tooauthenticate seu aplicativo e obter um token tooAzure AD Graph API, emitir um endpoint token tooAzure AD de solicitação de token OAuth 2.0 de concessão de credenciais de cliente fluxo (**https://login.microsoftonline.com/ {directory_domain_name} / OAuth2/Token**).</span><span class="sxs-lookup"><span data-stu-id="3a90f-240">tooauthenticate your app and get a token tooAzure AD Graph API, issue a Client Credential Grant OAuth2.0 flow token request tooAzure AD token endpoint (**https://login.microsoftonline.com/{directory_domain_name}/OAuth2/Token**).</span></span>

<span data-ttu-id="3a90f-241">Olá [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) método hello aplicativo de exemplo do ASP.net MVC obtém um aplicativo somente acesso de token para o uso da API do Graph hello biblioteca de autenticação do Active Directory para .NET.</span><span class="sxs-lookup"><span data-stu-id="3a90f-241">hello [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) method of hello ASP.net MVC sample application gets an app-only access token for Graph API using hello Active Directory Authentication Library for .NET.</span></span>

<span data-ttu-id="3a90f-242">parâmetros de cadeia de caracteres de consulta de saudação que estão disponíveis para esta solicitação são descritos em Olá [solicitar um Token de acesso](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) tópico.</span><span class="sxs-lookup"><span data-stu-id="3a90f-242">hello query string parameters that are available for this request are described in hello [Request an Access Token](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) topic.</span></span>

<span data-ttu-id="3a90f-243">Um exemplo de solicitação de token de concessão de credencial de cliente:</span><span class="sxs-lookup"><span data-stu-id="3a90f-243">An example request for client credential grant token:</span></span>

    POST https://login.microsoftonline.com/62e173e9-301e-423e-bcd4-29121ec1aa24/oauth2/token HTTP/1.1
    Content-Type: application/x-www-form-urlencoded
    Content-Length: 187</pre>
    <pre>grant_type=client_credentials&client_id=a0448380-c346-4f9f-b897-c18733de9394&resource=https%3A%2F%2Fgraph.windows.net%2F &client_secret=olna8C*****Og%3D

<span data-ttu-id="3a90f-244">Um exemplo de resposta de token de concessão de credencial de cliente:</span><span class="sxs-lookup"><span data-stu-id="3a90f-244">An example response for client credential grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039862","not_before":"1432035962","resource":"https://graph.windows.net/","access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSIsImtpZCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLndpbmRv****G5gUTV-kKorR-pg"}

### <a name="get-objectid-of-application-service-principal-in-user-azure-ad"></a><span data-ttu-id="3a90f-245">Obter a ID de objeto da entidade de serviço de aplicativo no Azure AD do usuário</span><span class="sxs-lookup"><span data-stu-id="3a90f-245">Get ObjectId of application service principal in user Azure AD</span></span>
<span data-ttu-id="3a90f-246">Agora, use Olá Olá de tooquery de token de acesso somente de aplicativo [entidades de serviço do Azure AD Graph](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) saudação do API toodetermine Id de objeto da entidade de serviço do aplicativo hello no diretório de saudação.</span><span class="sxs-lookup"><span data-stu-id="3a90f-246">Now, use hello app-only access token tooquery hello [Azure AD Graph Service Principals](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) API toodetermine hello Object Id of hello application's service principal in hello directory.</span></span>

<span data-ttu-id="3a90f-247">Olá [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) método hello aplicativo de exemplo do ASP.net MVC implementa esta chamada.</span><span class="sxs-lookup"><span data-stu-id="3a90f-247">hello [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) method of hello ASP.net MVC sample application implements this call.</span></span>

<span data-ttu-id="3a90f-248">Olá mostrado no exemplo a seguir como toorequest entidade de serviço do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3a90f-248">hello following example shows how toorequest an application's service principal.</span></span> <span data-ttu-id="3a90f-249">a0448380-c346-4f9f-b897-c18733de9394 é a id de cliente de saudação do aplicativo hello.</span><span class="sxs-lookup"><span data-stu-id="3a90f-249">a0448380-c346-4f9f-b897-c18733de9394 is hello client id of hello application.</span></span>

    GET https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/servicePrincipals?api-version=1.5&$filter=appId%20eq%20'a0448380-c346-4f9f-b897-c18733de9394' HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJK*****-kKorR-pg

<span data-ttu-id="3a90f-250">Olá exemplo a seguir mostra uma resposta toohello solicitação de serviço do aplicativo principal</span><span class="sxs-lookup"><span data-stu-id="3a90f-250">hello following example shows a response toohello request for an application's service principal</span></span>

    HTTP/1.1 200 OK

    {"odata.metadata":"https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/$metadata#directoryObjects/Microsoft.DirectoryServices.ServicePrincipal","value":[{"odata.type":"Microsoft.DirectoryServices.ServicePrincipal","objectType":"ServicePrincipal","objectId":"9b5018d4-6951-42ed-8a92-f11ec283ccec","deletionTimestamp":null,"accountEnabled":true,"appDisplayName":"CloudSense","appId":"a0448380-c346-4f9f-b897-c18733de9394","appOwnerTenantId":"62e173e9-301e-423e-bcd4-29121ec1aa24","appRoleAssignmentRequired":false,"appRoles":[],"displayName":"CloudSense","errorUrl":null,"homepage":"http://www.vipswapper.com/cloudsense","keyCredentials":[],"logoutUrl":null,"oauth2Permissions":[{"adminConsentDescription":"Allow hello application tooaccess CloudSense on behalf of hello signed-in user.","adminConsentDisplayName":"Access CloudSense","id":"b7b7338e-683a-4796-b95e-60c10380de1c","isEnabled":true,"type":"User","userConsentDescription":"Allow hello application tooaccess CloudSense on your behalf.","userConsentDisplayName":"Access CloudSense","value":"user_impersonation"}],"passwordCredentials":[],"preferredTokenSigningKeyThumbprint":null,"publisherName":"vipswapper"quot;,"replyUrls":["http://www.vipswapper.com/cloudsense","http://www.vipswapper.com","http://vipswapper.com","http://vipswapper.azurewebsites.net","http://localhost:62080"],"samlMetadataUrl":null,"servicePrincipalNames":["http://www.vipswapper.com/cloudsense","a0448380-c346-4f9f-b897-c18733de9394"],"tags":["WindowsAzureActiveDirectoryIntegratedApp"]}]}

### <a name="get-azure-rbac-role-identifier"></a><span data-ttu-id="3a90f-251">Obter o identificador de função RBAC do Azure</span><span class="sxs-lookup"><span data-stu-id="3a90f-251">Get Azure RBAC role identifier</span></span>
<span data-ttu-id="3a90f-252">tooassign Olá apropriado RBAC tooyour serviço de função principal, você deve determinar o identificador de saudação da função de RBAC do Azure de saudação.</span><span class="sxs-lookup"><span data-stu-id="3a90f-252">tooassign hello appropriate RBAC role tooyour service principal, you must determine hello identifier of hello Azure RBAC role.</span></span>

<span data-ttu-id="3a90f-253">função RBAC de direito Hello, para seu aplicativo:</span><span class="sxs-lookup"><span data-stu-id="3a90f-253">hello right RBAC role for your application:</span></span>

* <span data-ttu-id="3a90f-254">Se seu aplicativo monitora apenas assinatura hello, sem fazer alterações, ele requer somente permissões de leitura de assinatura de saudação.</span><span class="sxs-lookup"><span data-stu-id="3a90f-254">If your application only monitors hello subscription, without making any changes, it requires only reader permissions on hello subscription.</span></span> <span data-ttu-id="3a90f-255">Atribuir Olá **leitor** função.</span><span class="sxs-lookup"><span data-stu-id="3a90f-255">Assign hello **Reader** role.</span></span>
* <span data-ttu-id="3a90f-256">Se seu aplicativo gerencia a assinatura do Azure hello, criação/modificação/exclusão de entidades, ele requer permissões de Colaborador hello.</span><span class="sxs-lookup"><span data-stu-id="3a90f-256">If your application manages Azure hello subscription, creating/modifying/deleting entities, it requires one of hello contributor permissions.</span></span>
  * <span data-ttu-id="3a90f-257">toomanage um determinado tipo de recurso, atribuir funções de Colaborador de recursos específicos de saudação (colaborador da máquina Virtual, colaborador de rede Virtual, colaborador da conta de armazenamento, etc.)</span><span class="sxs-lookup"><span data-stu-id="3a90f-257">toomanage a particular type of resource, assign hello resource-specific contributor roles (Virtual Machine Contributor, Virtual Network Contributor, Storage Account Contributor, etc.)</span></span>
  * <span data-ttu-id="3a90f-258">toomanage qualquer tipo de recurso, atribuir Olá **Colaborador** função.</span><span class="sxs-lookup"><span data-stu-id="3a90f-258">toomanage any resource type, assign hello **Contributor** role.</span></span>

<span data-ttu-id="3a90f-259">atribuição de função de saudação para seu aplicativo é toousers visível, para que selecionar Olá privilégio necessário pelo menos.</span><span class="sxs-lookup"><span data-stu-id="3a90f-259">hello role assignment for your application is visible toousers, so select hello least-required privilege.</span></span>

<span data-ttu-id="3a90f-260">Chamar hello [definição de função do Gerenciador de recursos API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) toolist todas as funções de RBAC do Azure e pesquisa, em seguida, itere Olá Olá de toofind do resultado desejado a definição de função por nome.</span><span class="sxs-lookup"><span data-stu-id="3a90f-260">Call hello [Resource Manager role definition API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) toolist all Azure RBAC roles and search then iterate over hello result toofind hello desired role definition by name.</span></span>

<span data-ttu-id="3a90f-261">Olá [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) método hello amostra de aplicativo do ASP.net MVC implementa esta chamada.</span><span class="sxs-lookup"><span data-stu-id="3a90f-261">hello [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) method of hello ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="3a90f-262">solicitação a seguir Olá exemplo mostra como identificador de função tooget RBAC do Azure.</span><span class="sxs-lookup"><span data-stu-id="3a90f-262">hello following request example shows how tooget Azure RBAC role identifier.</span></span> <span data-ttu-id="3a90f-263">09cbd307-aa71-4aca-b346-5f253e6e3ebb é a id de saudação de assinatura de saudação.</span><span class="sxs-lookup"><span data-stu-id="3a90f-263">09cbd307-aa71-4aca-b346-5f253e6e3ebb is hello id of hello subscription.</span></span>

    GET https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV*****fY2lGc5

<span data-ttu-id="3a90f-264">resposta de saudação está no hello formato a seguir:</span><span class="sxs-lookup"><span data-stu-id="3a90f-264">hello response is in hello following format:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"properties":{"roleName":"API Management Service Contributor","type":"BuiltInRole","description":"Lets you manage API Management services, but not access toothem.","scope":"/","permissions":[{"actions":["Microsoft.ApiManagement/Services/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/312a565d-c81f-4fd8-895a-4e21e48d571c","type":"Microsoft.Authorization/roleDefinitions","name":"312a565d-c81f-4fd8-895a-4e21e48d571c"},{"properties":{"roleName":"Application Insights Component Contributor","type":"BuiltInRole","description":"Lets you manage Application Insights components, but not access toothem.","scope":"/","permissions":[{"actions":["Microsoft.Insights/components/*","Microsoft.Insights/webtests/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/ae349356-3a1b-4a5e-921d-050484c6347e","type":"Microsoft.Authorization/roleDefinitions","name":"ae349356-3a1b-4a5e-921d-050484c6347e"}]}

<span data-ttu-id="3a90f-265">Não é necessário toocall essa API em uma base contínua.</span><span class="sxs-lookup"><span data-stu-id="3a90f-265">You do not need toocall this API on an ongoing basis.</span></span> <span data-ttu-id="3a90f-266">Depois de determinar Olá GUID conhecida Olá da definição da função, você pode construir a id de definição de função hello como:</span><span class="sxs-lookup"><span data-stu-id="3a90f-266">Once you've determined hello well-known GUID of hello role definition, you can construct hello role definition id as:</span></span>

    /subscriptions/{subscription_id}/providers/Microsoft.Authorization/roleDefinitions/{well-known-role-guid}

<span data-ttu-id="3a90f-267">Aqui estão os guids de saudação bem conhecidos de funções internas usadas:</span><span class="sxs-lookup"><span data-stu-id="3a90f-267">Here are hello well-known guids of commonly used built-in roles:</span></span>

| <span data-ttu-id="3a90f-268">Função</span><span class="sxs-lookup"><span data-stu-id="3a90f-268">Role</span></span> | <span data-ttu-id="3a90f-269">Guid</span><span class="sxs-lookup"><span data-stu-id="3a90f-269">Guid</span></span> |
| --- | --- |
| <span data-ttu-id="3a90f-270">Leitor</span><span class="sxs-lookup"><span data-stu-id="3a90f-270">Reader</span></span> |<span data-ttu-id="3a90f-271">acdd72a7-3385-48ef-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="3a90f-271">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |
| <span data-ttu-id="3a90f-272">Colaborador</span><span class="sxs-lookup"><span data-stu-id="3a90f-272">Contributor</span></span> |<span data-ttu-id="3a90f-273">b24988ac-6180-42a0-ab88-20f7382dd24c</span><span class="sxs-lookup"><span data-stu-id="3a90f-273">b24988ac-6180-42a0-ab88-20f7382dd24c</span></span> |
| <span data-ttu-id="3a90f-274">Colaborador de Máquina Virtual</span><span class="sxs-lookup"><span data-stu-id="3a90f-274">Virtual Machine Contributor</span></span> |<span data-ttu-id="3a90f-275">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span><span class="sxs-lookup"><span data-stu-id="3a90f-275">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span></span> |
| <span data-ttu-id="3a90f-276">Colaborador de Rede Virtual</span><span class="sxs-lookup"><span data-stu-id="3a90f-276">Virtual Network Contributor</span></span> |<span data-ttu-id="3a90f-277">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span><span class="sxs-lookup"><span data-stu-id="3a90f-277">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span></span> |
| <span data-ttu-id="3a90f-278">Colaborador da Conta de Armazenamento</span><span class="sxs-lookup"><span data-stu-id="3a90f-278">Storage Account Contributor</span></span> |<span data-ttu-id="3a90f-279">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span><span class="sxs-lookup"><span data-stu-id="3a90f-279">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span></span> |
| <span data-ttu-id="3a90f-280">Colaborador do Site</span><span class="sxs-lookup"><span data-stu-id="3a90f-280">Website Contributor</span></span> |<span data-ttu-id="3a90f-281">de139f84-1756-47ae-9be6-808fbbe84772</span><span class="sxs-lookup"><span data-stu-id="3a90f-281">de139f84-1756-47ae-9be6-808fbbe84772</span></span> |
| <span data-ttu-id="3a90f-282">Colaborador do Plano de Web</span><span class="sxs-lookup"><span data-stu-id="3a90f-282">Web Plan Contributor</span></span> |<span data-ttu-id="3a90f-283">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span><span class="sxs-lookup"><span data-stu-id="3a90f-283">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span></span> |
| <span data-ttu-id="3a90f-284">Colaborador do SQL Server</span><span class="sxs-lookup"><span data-stu-id="3a90f-284">SQL Server Contributor</span></span> |<span data-ttu-id="3a90f-285">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span><span class="sxs-lookup"><span data-stu-id="3a90f-285">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span></span> |
| <span data-ttu-id="3a90f-286">Colaborador do banco de dados SQL</span><span class="sxs-lookup"><span data-stu-id="3a90f-286">SQL DB Contributor</span></span> |<span data-ttu-id="3a90f-287">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span><span class="sxs-lookup"><span data-stu-id="3a90f-287">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span></span> |

### <a name="assign-rbac-role-tooapplication"></a><span data-ttu-id="3a90f-288">Atribuir RBAC função tooapplication</span><span class="sxs-lookup"><span data-stu-id="3a90f-288">Assign RBAC role tooapplication</span></span>
<span data-ttu-id="3a90f-289">Você tem tudo o que precisa tooassign Olá apropriado RBAC função tooyour entidade de serviço usando Olá [Gerenciador de recursos de criar a atribuição de função](https://docs.microsoft.com/rest/api/authorization/roleassignments) API.</span><span class="sxs-lookup"><span data-stu-id="3a90f-289">You have everything you need tooassign hello appropriate RBAC role tooyour service principal by using hello [Resource Manager create role assignment](https://docs.microsoft.com/rest/api/authorization/roleassignments) API.</span></span>

<span data-ttu-id="3a90f-290">Olá [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) método hello amostra de aplicativo do ASP.net MVC implementa esta chamada.</span><span class="sxs-lookup"><span data-stu-id="3a90f-290">hello [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) method of hello ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="3a90f-291">Um exemplo solicitação tooassign RBAC função tooapplication:</span><span class="sxs-lookup"><span data-stu-id="3a90f-291">An example request tooassign RBAC role tooapplication:</span></span>

    PUT https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/microsoft.authorization/roleassignments/4f87261d-2816-465d-8311-70a27558df4c?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiL*****FlwO1mM7Cw6JWtfY2lGc5
    Content-Type: application/json
    Content-Length: 230

    {"properties": {"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2"}}

<span data-ttu-id="3a90f-292">Na solicitação de Olá Olá valores a seguir é usado:</span><span class="sxs-lookup"><span data-stu-id="3a90f-292">In hello request, hello following values are used:</span></span>

| <span data-ttu-id="3a90f-293">Guid</span><span class="sxs-lookup"><span data-stu-id="3a90f-293">Guid</span></span> | <span data-ttu-id="3a90f-294">Descrição</span><span class="sxs-lookup"><span data-stu-id="3a90f-294">Description</span></span> |
| --- | --- |
| <span data-ttu-id="3a90f-295">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span><span class="sxs-lookup"><span data-stu-id="3a90f-295">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span></span> |<span data-ttu-id="3a90f-296">id de saudação de assinatura de saudação</span><span class="sxs-lookup"><span data-stu-id="3a90f-296">hello id of hello subscription</span></span> |
| <span data-ttu-id="3a90f-297">c3097b31-7309-4c59-b4e3-770f8406bad2</span><span class="sxs-lookup"><span data-stu-id="3a90f-297">c3097b31-7309-4c59-b4e3-770f8406bad2</span></span> |<span data-ttu-id="3a90f-298">id de objeto de saudação da entidade de serviço de saudação do aplicativo hello</span><span class="sxs-lookup"><span data-stu-id="3a90f-298">hello object id of hello service principal of hello application</span></span> |
| <span data-ttu-id="3a90f-299">acdd72a7-3385-48ef-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="3a90f-299">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |<span data-ttu-id="3a90f-300">id de saudação da função de leitor de saudação</span><span class="sxs-lookup"><span data-stu-id="3a90f-300">hello id of hello reader role</span></span> |
| <span data-ttu-id="3a90f-301">4f87261d-2816-465d-8311-70a27558df4c</span><span class="sxs-lookup"><span data-stu-id="3a90f-301">4f87261d-2816-465d-8311-70a27558df4c</span></span> |<span data-ttu-id="3a90f-302">um novo guid criado para a nova atribuição de função hello</span><span class="sxs-lookup"><span data-stu-id="3a90f-302">a new guid created for hello new role assignment</span></span> |

<span data-ttu-id="3a90f-303">resposta de saudação está no hello formato a seguir:</span><span class="sxs-lookup"><span data-stu-id="3a90f-303">hello response is in hello following format:</span></span>

    HTTP/1.1 201 Created

    {"properties":{"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2","scope":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb"},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleAssignments/4f87261d-2816-465d-8311-70a27558df4c","type":"Microsoft.Authorization/roleAssignments","name":"4f87261d-2816-465d-8311-70a27558df4c"}

### <a name="get-app-only-access-token-for-azure-resource-manager"></a><span data-ttu-id="3a90f-304">Obter token de acesso somente de aplicativo para o Azure Resource Manager</span><span class="sxs-lookup"><span data-stu-id="3a90f-304">Get app-only access token for Azure Resource Manager</span></span>
<span data-ttu-id="3a90f-305">toovalidate que o aplicativo tem acesso de saudação desejado na assinatura hello, executar uma tarefa de teste Olá assinatura usando um token somente de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3a90f-305">toovalidate that app has hello desired access on hello subscription, perform a test task on hello subscription using an app-only token.</span></span>

<span data-ttu-id="3a90f-306">tooget um token de acesso somente de aplicativo, siga as instruções da seção [obter token de acesso de somente de aplicativo do Azure AD Graph API](#app-azure-ad-graph), com um valor diferente para o parâmetro de recurso hello:</span><span class="sxs-lookup"><span data-stu-id="3a90f-306">tooget an app-only access token, follow instructions from section [Get app-only access token for Azure AD Graph API](#app-azure-ad-graph), with a different value for hello resource parameter:</span></span>

    https://management.core.windows.net/

<span data-ttu-id="3a90f-307">Olá [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) método hello aplicativo de exemplo do ASP.NET MVC obtém um acesso somente de aplicativo token para usar o Gerenciador de recursos do Azure hello biblioteca de autenticação do Active Directory para .net.</span><span class="sxs-lookup"><span data-stu-id="3a90f-307">hello [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of hello ASP.NET MVC sample application gets an app-only access token for Azure Resource Manager using hello Active Directory Authentication Library for .net.</span></span>

#### <a name="get-applications-permissions-on-subscription"></a><span data-ttu-id="3a90f-308">Obter permissões do aplicativo na assinatura</span><span class="sxs-lookup"><span data-stu-id="3a90f-308">Get Application's Permissions on Subscription</span></span>
<span data-ttu-id="3a90f-309">toocheck que seu aplicativo tem Olá desejado de acesso em uma assinatura do Azure, você também pode chamar hello [permissões do Gerenciador de recursos](https://docs.microsoft.com/rest/api/authorization/permissions) API.</span><span class="sxs-lookup"><span data-stu-id="3a90f-309">toocheck that your application has hello desired access on an Azure subscription, you may also call hello [Resource Manager Permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API.</span></span> <span data-ttu-id="3a90f-310">Essa abordagem é toohow semelhante, você determinou se usuário Olá tem direitos de gerenciamento de acesso para a assinatura de saudação.</span><span class="sxs-lookup"><span data-stu-id="3a90f-310">This approach is similar toohow you determined whether hello user has Access Management rights for hello subscription.</span></span> <span data-ttu-id="3a90f-311">No entanto, neste momento, chame hello permissões API com o token de acesso somente de aplicativo hello recebido na etapa anterior hello.</span><span class="sxs-lookup"><span data-stu-id="3a90f-311">However, this time, call hello permissions API with hello app-only access token that you received in hello previous step.</span></span>

<span data-ttu-id="3a90f-312">Olá [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) método hello amostra de aplicativo do ASP.NET MVC implementa esta chamada.</span><span class="sxs-lookup"><span data-stu-id="3a90f-312">hello [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of hello ASP.NET MVC sample app implements this call.</span></span>

## <a name="manage-connected-subscriptions"></a><span data-ttu-id="3a90f-313">Gerenciar assinaturas conectadas</span><span class="sxs-lookup"><span data-stu-id="3a90f-313">Manage connected subscriptions</span></span>
<span data-ttu-id="3a90f-314">Quando a função apropriada de RBAC Olá é atribuída a entidade de serviço do aplicativo tooyour assinatura hello, seu aplicativo pode manter monitorar e gerenciar usando tokens de acesso somente de aplicativo para o Gerenciador de recursos do Azure.</span><span class="sxs-lookup"><span data-stu-id="3a90f-314">When hello appropriate RBAC role is assigned tooyour application's service principal on hello subscription, your application can keep monitoring/managing it using app-only access tokens for Azure Resource Manager.</span></span>

<span data-ttu-id="3a90f-315">Se um proprietário da assinatura remove a atribuição de função do aplicativo usando o portal clássico do hello ou ferramentas de linha de comando, o aplicativo é tooaccess não é mais possível essa assinatura.</span><span class="sxs-lookup"><span data-stu-id="3a90f-315">If a subscription owner removes your application's role assignment using hello classic portal or command-line tools, your application is no longer able tooaccess that subscription.</span></span> <span data-ttu-id="3a90f-316">Nesse caso, você deve notificar o usuário Olá que conexão Olá com assinatura Olá foi danificada do aplicativo fora do hello e conceder a eles uma opção muito "reparar" conexão hello.</span><span class="sxs-lookup"><span data-stu-id="3a90f-316">In that case, you should notify hello user that hello connection with hello subscription was severed from outside hello application and give them an option too"repair" hello connection.</span></span> <span data-ttu-id="3a90f-317">"Reparar" seria simplesmente crie novamente a atribuição de função hello que foi excluída offline.</span><span class="sxs-lookup"><span data-stu-id="3a90f-317">"Repair" would simply re-create hello role assignment that was deleted offline.</span></span>

<span data-ttu-id="3a90f-318">Assim como você ativou o aplicativo de tooyour hello usuário tooconnect assinaturas, você deve permitir assinaturas de toodisconnect usuário Olá muito.</span><span class="sxs-lookup"><span data-stu-id="3a90f-318">Just as you enabled hello user tooconnect subscriptions tooyour application, you must allow hello user toodisconnect subscriptions too.</span></span> <span data-ttu-id="3a90f-319">De um acesso gerenciamento ponto de Vista, desconecte significa remover a atribuição de função de saudação entidade de serviço do aplicativo hello tem assinatura hello.</span><span class="sxs-lookup"><span data-stu-id="3a90f-319">From an access management point of view, disconnect means removing hello role assignment that hello application's service principal has on hello subscription.</span></span> <span data-ttu-id="3a90f-320">Opcionalmente, pode ser removido qualquer estado no aplicativo hello para assinatura Olá muito.</span><span class="sxs-lookup"><span data-stu-id="3a90f-320">Optionally, any state in hello application for hello subscription might be removed too.</span></span>
<span data-ttu-id="3a90f-321">Somente os usuários com permissão de gerenciamento de acesso na assinatura de saudação são toodisconnect capaz de assinatura de saudação.</span><span class="sxs-lookup"><span data-stu-id="3a90f-321">Only users with access management permission on hello subscription are able toodisconnect hello subscription.</span></span>

<span data-ttu-id="3a90f-322">Olá [RevokeRoleFromServicePrincipalOnSubscription método](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) de saudação ASP.net MVC o aplicativo de exemplo implementa esta chamada.</span><span class="sxs-lookup"><span data-stu-id="3a90f-322">hello [RevokeRoleFromServicePrincipalOnSubscription method](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) of hello ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="3a90f-323">Pronto! Agora os usuários podem agora se conectar e gerenciar suas assinaturas do Azure com seu aplicativo facilmente.</span><span class="sxs-lookup"><span data-stu-id="3a90f-323">That's it - users can now easily connect and manage their Azure subscriptions with your application.</span></span>
