---
title: "Autenticação de entidade de serviço para Aplicativos de API no Serviço de Aplicativo do Azure | Microsoft Docs"
description: "Saiba como proteger um aplicativo de API no Serviço de Aplicativo do Azure em cenários serviço a serviço."
services: app-service\api
documentationcenter: .net
author: alexkarcher-msft
manager: erikre
editor: 
ms.assetid: 7ca0bab2-1d29-4d51-b779-dce0edd34f8b
ms.service: app-service-api
ms.workload: na
ms.tgt_pltfrm: dotnet
ms.devlang: na
ms.topic: article
ms.date: 06/30/2016
ms.author: alkarche
ms.openlocfilehash: 95653287546bbe358111ed16af0c30a53caff2b5
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="service-principal-authentication-for-api-apps-in-azure-app-service"></a><span data-ttu-id="dff1e-103">Autenticação de entidade de serviço para Aplicativos de API no Serviço de Aplicativo do Azure</span><span class="sxs-lookup"><span data-stu-id="dff1e-103">Service principal authentication for API Apps in Azure App Service</span></span>
## <a name="overview"></a><span data-ttu-id="dff1e-104">Visão geral</span><span class="sxs-lookup"><span data-stu-id="dff1e-104">Overview</span></span>
<span data-ttu-id="dff1e-105">Este artigo explica como usar a autenticação do Serviço de Aplicativo para acesso *interno* aos aplicativos de API.</span><span class="sxs-lookup"><span data-stu-id="dff1e-105">This article explains how to use App Service authentication for *internal* access to API apps.</span></span> <span data-ttu-id="dff1e-106">Um cenário interno é quando você tem um aplicativo de API que deseja que seja consumível apenas por seu próprio código de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="dff1e-106">An internal scenario is where you have an API app that you want to be consumable only by your own application code.</span></span> <span data-ttu-id="dff1e-107">A maneira recomendada de implementar esse cenário no Serviço de Aplicativo é usar o Azure AD para proteger o aplicativo de API chamado.</span><span class="sxs-lookup"><span data-stu-id="dff1e-107">The recommended way to implement this scenario in App Service is to use Azure AD to protect the called API app.</span></span> <span data-ttu-id="dff1e-108">Você chama o aplicativo de API protegido com um token de portador que obtém do Azure AD fornecendo credenciais (entidade de serviço) de identidade do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="dff1e-108">You call the protected API app with a bearer token that you get from Azure AD by providing application identity (service principal) credentials.</span></span> <span data-ttu-id="dff1e-109">Para ver alternativas ao uso do Azure AD, consulte a seção **Autenticação serviço a serviço** da [Visão geral de autenticação do Serviço de Aplicativo do Azure](../app-service/app-service-authentication-overview.md#service-to-service-authentication).</span><span class="sxs-lookup"><span data-stu-id="dff1e-109">For alternatives to using Azure AD, see the **Service-to-service authentication** section of the [Azure App Service authentication overview](../app-service/app-service-authentication-overview.md#service-to-service-authentication).</span></span>

<span data-ttu-id="dff1e-110">Neste artigo, você aprenderá o seguinte:</span><span class="sxs-lookup"><span data-stu-id="dff1e-110">In this article, you'll learn:</span></span>

* <span data-ttu-id="dff1e-111">Como usar o Active Directory do Azure (Azure AD) para proteger um aplicativo de API contra acesso não autenticado.</span><span class="sxs-lookup"><span data-stu-id="dff1e-111">How to use Azure Active Directory (Azure AD) to protect an API app from unauthenticated access.</span></span>
* <span data-ttu-id="dff1e-112">Como consumir um aplicativo de API protegido de um aplicativo de API, um aplicativo Web ou um aplicativo móvel usando credenciais de entidade de serviço (identidade de aplicativo) do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="dff1e-112">How to consume a protected API app from an API app, web app, or mobile app by using Azure AD service principal (app identity) credentials.</span></span> <span data-ttu-id="dff1e-113">Para obter informações sobre como consumir de um aplicativo lógico, consulte [Usando a API personalizada hospedada no Serviço de Aplicativo com Aplicativos Lógicos](../logic-apps/logic-apps-custom-hosted-api.md).</span><span class="sxs-lookup"><span data-stu-id="dff1e-113">For information about how to consume from a logic app, see [Using your custom API hosted on App Service with Logic apps](../logic-apps/logic-apps-custom-hosted-api.md).</span></span>
* <span data-ttu-id="dff1e-114">Como verificar se o aplicativo de API protegido não pode ser chamado de um navegador por usuários conectados.</span><span class="sxs-lookup"><span data-stu-id="dff1e-114">How to make sure that the protected API app can't be called from a browser by logged on users.</span></span>
* <span data-ttu-id="dff1e-115">Como verificar se o aplicativo de API protegido só pode ser chamado por uma entidade de serviço do Azure AD específica.</span><span class="sxs-lookup"><span data-stu-id="dff1e-115">How to make sure that the protected API app can only be called by a specific Azure AD service principal.</span></span>

<span data-ttu-id="dff1e-116">O artigo contém duas seções:</span><span class="sxs-lookup"><span data-stu-id="dff1e-116">The article contains two sections:</span></span>

* <span data-ttu-id="dff1e-117">A seção [Como configurar a autenticação de entidade de serviço no Serviço de Aplicativo do Azure](#authconfig) explica em termos gerais como configurar a autenticação para qualquer aplicativo de API e como consumir o aplicativo de API protegido.</span><span class="sxs-lookup"><span data-stu-id="dff1e-117">The [How to configure service principal authentication in Azure App Service](#authconfig) section explains in general how to configure authentication for any API app, and how to consume the protected API app.</span></span> <span data-ttu-id="dff1e-118">Esta seção aplica-se igualmente a todas as estruturas às quais o Serviço de Aplicativo dá suporte, incluindo .NET, Node.js e Java.</span><span class="sxs-lookup"><span data-stu-id="dff1e-118">This section applies equally to all frameworks supported by App Service, including .NET, Node.js, and Java.</span></span>
* <span data-ttu-id="dff1e-119">A partir da seção [Continuação dos tutoriais de introdução ao .NET](#tutorialstart) , o tutorial o guiará você pela configuração de um cenário de "acesso interno" para um aplicativo .NET de exemplo em execução no Serviço de Aplicativo.</span><span class="sxs-lookup"><span data-stu-id="dff1e-119">Starting with the [Continuing the .NET getting-started tutorials](#tutorialstart) section, the tutorial guides you through configuring an "internal access" scenario for a .NET sample application running in App Service.</span></span> 

## <span data-ttu-id="dff1e-120"><a id="authconfig"></a> Como configurar a autenticação da entidade de serviço no Serviço de Aplicativo do Azure</span><span class="sxs-lookup"><span data-stu-id="dff1e-120"><a id="authconfig"></a> How to configure service principal authentication in Azure App Service</span></span>
<span data-ttu-id="dff1e-121">Esta seção fornece instruções gerais que se aplicam a qualquer aplicativo de API.</span><span class="sxs-lookup"><span data-stu-id="dff1e-121">This section provides general instructions that apply to any API app.</span></span> <span data-ttu-id="dff1e-122">Para obter etapas específicas para o aplicativo de exemplo .NET de Lista de Tarefas Pendentes, vá para [Continuação da série de tutoriais de introdução aos Aplicativos de API .NET](#tutorialstart).</span><span class="sxs-lookup"><span data-stu-id="dff1e-122">For steps specific to the To Do List .NET sample application, go to [Continuing the .NET API Apps tutorial series](#tutorialstart).</span></span>

1. <span data-ttu-id="dff1e-123">No [Portal do Azure](https://portal.azure.com/), navegue até a folha **Configurações** do aplicativo de API que você deseja proteger, localize a seção **Recursos** e clique em **Autenticação/Autorização**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-123">In the [Azure portal](https://portal.azure.com/), navigate to the **Settings** blade of the API app that you want to protect, and then find the **Features** section and click **Authentication/ Authorization**.</span></span>
   
    ![Autenticação/Autorização no portal do Azure](./media/app-service-api-dotnet-user-principal-auth/features.png)
2. <span data-ttu-id="dff1e-125">Na folha **Autenticação/Autorização**, clique em **Ativada**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-125">In the **Authentication / Authorization** blade, click **On**.</span></span>
3. <span data-ttu-id="dff1e-126">Na lista suspensa **Ação a tomar quando a solicitação não está autenticada**, selecione **Efetuar logon com o Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-126">In the **Action to take when request is not authenticated** drop-down list, select **Log in with Azure Active Directory** .</span></span>
4. <span data-ttu-id="dff1e-127">Em **Provedores de Autenticação**, selecione **Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-127">Under **Authentication Providers**, select **Azure Active Directory**.</span></span>
   
    ![Folha Autenticação/Autorização no portal do Azure](./media/app-service-api-dotnet-user-principal-auth/authblade.png)
5. <span data-ttu-id="dff1e-129">Configure a folha **Configurações do Azure Active Directory** para criar um novo aplicativo Azure AD ou use um aplicativo Azure AD existente se já tiver um que deseja usar.</span><span class="sxs-lookup"><span data-stu-id="dff1e-129">Configure the **Azure Active Directory Settings** blade to create a new Azure AD application, or use an existing Azure AD application if you already have one that you want to use.</span></span>
   
    <span data-ttu-id="dff1e-130">Cenários internos normalmente envolvem um aplicativo de API que chama um aplicativo de API.</span><span class="sxs-lookup"><span data-stu-id="dff1e-130">Internal scenarios typically involve an API app calling an API app.</span></span> <span data-ttu-id="dff1e-131">Você pode usar aplicativos do Azure AD separados para cada aplicativo de API ou apenas um aplicativo Azure AD.</span><span class="sxs-lookup"><span data-stu-id="dff1e-131">You can use separate Azure AD applications for each API app or just one Azure AD application.</span></span>
   
    <span data-ttu-id="dff1e-132">Para obter instruções detalhadas sobre essa folha, consulte [Como configurar seu aplicativo do Serviço de Aplicativo para usar o logon do Azure Active Directory](../app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication.md).</span><span class="sxs-lookup"><span data-stu-id="dff1e-132">For detailed instructions on this blade, see [How to configure your App Service application to use Azure Active Directory login](../app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication.md).</span></span>
6. <span data-ttu-id="dff1e-133">Quando você terminar de usar a folha de configuração do provedor de autenticação, clique em **OK**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-133">When you're done with the authentication provider configuration blade, click **OK**.</span></span>
7. <span data-ttu-id="dff1e-134">Na folha **Autenticação/Autorização**, clique em **Salvar**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-134">In the **Authentication / Authorization** blade, click **Save**.</span></span>
   
    ![Clique em Salvar](./media/app-service-api-dotnet-service-principal-auth/authsave.png)

<span data-ttu-id="dff1e-136">Quando isso for feito, o Serviço de Aplicativo permitirá somente solicitações de chamadores no locatário do Azure AD configurado.</span><span class="sxs-lookup"><span data-stu-id="dff1e-136">When this is done, App Service only allows requests from callers in the configured Azure AD tenant.</span></span> <span data-ttu-id="dff1e-137">Nenhum código de autenticação ou de autorização é necessário no aplicativo de API protegido.</span><span class="sxs-lookup"><span data-stu-id="dff1e-137">No authentication or authorization code is required in the protected API app.</span></span> <span data-ttu-id="dff1e-138">O token de portador é passado para o aplicativo de API, juntamente com declarações usadas com frequência em cabeçalhos HTTP, e você pode ler essas informações no código para validar que as solicitações são de um chamador específico, como uma entidade de serviço.</span><span class="sxs-lookup"><span data-stu-id="dff1e-138">The bearer token is passed to the API app along with commonly used claims in HTTP headers, and you can read that information in code to validate that requests are from a particular caller, such as a service principal.</span></span>

<span data-ttu-id="dff1e-139">Essa funcionalidade de autenticação funciona da mesma maneira para todas as linguagens às quais o Serviço de Aplicativo dá suporte, incluindo .NET, Node.js e Java.</span><span class="sxs-lookup"><span data-stu-id="dff1e-139">This authentication functionality works the same way for all languages that App service supports, including .NET, Node.js, and Java.</span></span> 

#### <a name="how-to-consume-the-protected-api-app"></a><span data-ttu-id="dff1e-140">Como consumir o aplicativo de API protegido</span><span class="sxs-lookup"><span data-stu-id="dff1e-140">How to consume the protected API app</span></span>
<span data-ttu-id="dff1e-141">O chamador deve fornecer um token de portador do Azure AD com chamadas de API.</span><span class="sxs-lookup"><span data-stu-id="dff1e-141">The caller must provide an Azure AD bearer token with API calls.</span></span> <span data-ttu-id="dff1e-142">Para obter um token de portador usando credenciais de entidade de serviço, o chamador usa a ADAL (Biblioteca de Autenticação do Active Directory para [.NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory), [Node.js](https://github.com/AzureAD/azure-activedirectory-library-for-nodejs) ou [Java](https://github.com/AzureAD/azure-activedirectory-library-for-java)).</span><span class="sxs-lookup"><span data-stu-id="dff1e-142">To get a bearer token using service principal credentials, the caller uses Active Directory Authentication Library (ADAL for [.NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory), [Node.js](https://github.com/AzureAD/azure-activedirectory-library-for-nodejs), or [Java](https://github.com/AzureAD/azure-activedirectory-library-for-java)).</span></span> <span data-ttu-id="dff1e-143">Para obter um token, o código que chama a ADAL fornece a ela as seguintes informações:</span><span class="sxs-lookup"><span data-stu-id="dff1e-143">To get a token, the code that calls ADAL provides to ADAL the following information:</span></span>

* <span data-ttu-id="dff1e-144">O nome de seu locatário do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="dff1e-144">The name of your Azure AD tenant.</span></span>
* <span data-ttu-id="dff1e-145">A ID e o segredo do cliente (chave do aplicativo) do aplicativo Azure AD associado ao chamador.</span><span class="sxs-lookup"><span data-stu-id="dff1e-145">The client ID and client secret (app key) of the Azure AD app associated with the caller.</span></span>
* <span data-ttu-id="dff1e-146">A ID do cliente do aplicativo Azure AD associado ao aplicativo de API protegido.</span><span class="sxs-lookup"><span data-stu-id="dff1e-146">The client ID of the Azure AD application associated with the protected API app.</span></span> <span data-ttu-id="dff1e-147">(Se apenas um aplicativo Azure AD for usado, essa será a mesma ID de cliente usada para o chamador.)</span><span class="sxs-lookup"><span data-stu-id="dff1e-147">(If just one Azure AD application is used, this is the same client ID as the one for the caller.)</span></span>

<span data-ttu-id="dff1e-148">Esses valores estão disponíveis nas páginas do Azure AD do [portal clássico do Azure](https://manage.windowsazure.com/).</span><span class="sxs-lookup"><span data-stu-id="dff1e-148">These values are available in the Azure AD pages of the [Azure classic portal](https://manage.windowsazure.com/).</span></span>

<span data-ttu-id="dff1e-149">Depois que o token for adquirido, o chamador o incluirá em solicitações HTTP no cabeçalho de Autorização.</span><span class="sxs-lookup"><span data-stu-id="dff1e-149">Once the token has been acquired, the caller includes it with HTTP requests in the Authorization header.</span></span>  <span data-ttu-id="dff1e-150">O Serviço de Aplicativo valida o token e permite que as solicitações cheguem ao aplicativo de API protegido.</span><span class="sxs-lookup"><span data-stu-id="dff1e-150">App Service validates the token and allows the requests to reach the protected API app.</span></span>

#### <a name="how-to-protect-the-api-app-from-access-by-users-in-the-same-tenant"></a><span data-ttu-id="dff1e-151">Como proteger o aplicativo de API contra acesso por usuários no mesmo locatário</span><span class="sxs-lookup"><span data-stu-id="dff1e-151">How to protect the API app from access by users in the same tenant</span></span>
<span data-ttu-id="dff1e-152">Tokens de portador para usuários no mesmo locatário são considerados válidos para o aplicativo de API protegido.</span><span class="sxs-lookup"><span data-stu-id="dff1e-152">Bearer tokens for users in the same tenant are considered valid for the protected API app.</span></span>  <span data-ttu-id="dff1e-153">Se você quiser garantir que apenas uma entidade de serviço possa chamar o aplicativo de API protegido, adicione o código no aplicativo de API protegido para validar as seguintes declarações do token:</span><span class="sxs-lookup"><span data-stu-id="dff1e-153">If you want to ensure that only a service principal can call the protected API app, add code in the protected API app to validate the following claims from the token:</span></span>

* <span data-ttu-id="dff1e-154">`appid` deve ser a ID do cliente do aplicativo Azure AD que está associada ao chamador.</span><span class="sxs-lookup"><span data-stu-id="dff1e-154">`appid` should be the client ID of the Azure AD application that is associated with the caller.</span></span> 
* <span data-ttu-id="dff1e-155">`oid` (`objectidentifier`) deve ser a ID da entidade de serviço do chamador.</span><span class="sxs-lookup"><span data-stu-id="dff1e-155">`oid` (`objectidentifier`) should be the service principal ID of the caller.</span></span> 

<span data-ttu-id="dff1e-156">O Serviço de Aplicativo também fornece a declaração `objectidentifier` no cabeçalho X-MS-CLIENT-PRINCIPAL-ID.</span><span class="sxs-lookup"><span data-stu-id="dff1e-156">App Service also provides the `objectidentifier` claim in the X-MS-CLIENT-PRINCIPAL-ID header.</span></span>

### <a name="how-to-protect-the-api-app-from-browser-access"></a><span data-ttu-id="dff1e-157">Como proteger o aplicativo de API contra acesso do navegador</span><span class="sxs-lookup"><span data-stu-id="dff1e-157">How to protect the API app from browser access</span></span>
<span data-ttu-id="dff1e-158">Se você não validar declarações no código no aplicativo de API protegido e se usar um aplicativo Azure AD diferente para o aplicativo de API protegido, verifique se a URL de Resposta do aplicativo Azure AD não é igual à URL base do aplicativo de API.</span><span class="sxs-lookup"><span data-stu-id="dff1e-158">If you don't validate claims in code in the protected API app, and if you use a separate Azure AD application for the protected API app, make sure that the Azure AD application's Reply URL is not the same as the API app's base URL.</span></span> <span data-ttu-id="dff1e-159">Se a URL de Resposta apontar diretamente para o aplicativo de API protegido, um usuário no mesmo locatário do Azure AD poderá navegar até o aplicativo de API, fazer logon e chamar a API com êxito.</span><span class="sxs-lookup"><span data-stu-id="dff1e-159">If the Reply URL points directly to the protected API app, a user in the same Azure AD tenant could browse to the API app, log on, and successfully call the API.</span></span>

## <span data-ttu-id="dff1e-160"><a id="tutorialstart"></a> Continuar a série de tutoriais de Aplicativos de API do .NET</span><span class="sxs-lookup"><span data-stu-id="dff1e-160"><a id="tutorialstart"></a> Continuing the .NET API Apps tutorial series</span></span>
<span data-ttu-id="dff1e-161">Se você estiver seguindo a série de tutoriais do Node.js ou do Java para aplicativos de API, vá para a seção [Próximas etapas](#next-steps) .</span><span class="sxs-lookup"><span data-stu-id="dff1e-161">If you are following the Node.js or Java tutorial series for API apps, skip to the [Next steps](#next-steps) section.</span></span> 

<span data-ttu-id="dff1e-162">O restante deste artigo continua a série de tutoriais de Aplicativos de API do .NET e pressupõe que você tenha concluído o [tutorial de autenticação de usuário](app-service-api-dotnet-user-principal-auth.md) e possua o aplicativo de exemplo em execução no Azure com a autenticação de usuário habilitada.</span><span class="sxs-lookup"><span data-stu-id="dff1e-162">The remainder of this article continues the .NET API Apps tutorial series and assumes that you have completed the [user authentication tutorial](app-service-api-dotnet-user-principal-auth.md) and have the sample application running in Azure with user authentication enabled.</span></span>

## <a name="set-up-authentication-in-azure"></a><span data-ttu-id="dff1e-163">Configurar a autenticação no Azure</span><span class="sxs-lookup"><span data-stu-id="dff1e-163">Set up authentication in Azure</span></span>
<span data-ttu-id="dff1e-164">Nesta seção, você configurará o Serviço de Aplicativo para que as únicas solicitações HTTP que ele permita que cheguem ao aplicativo de API de camada de dados sejam aquelas que tiverem tokens de portador válidos do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="dff1e-164">In this section you configure App Service so that the only HTTP requests it allows to reach the data tier API app are the ones that have valid Azure AD bearer tokens.</span></span> 

<span data-ttu-id="dff1e-165">Na seção a seguir, você configurará o aplicativo de API de camada intermediária para enviar as credenciais do aplicativo ao Azure AD, obter de volta um token de portador e enviar o token de portador ao aplicativo de API de camada de dados.</span><span class="sxs-lookup"><span data-stu-id="dff1e-165">In the following section, you configure the middle tier API app to send application credentials to Azure AD, get back a bearer token, and send the bearer token to the data tier API app.</span></span> <span data-ttu-id="dff1e-166">Esse processo é ilustrado no diagrama.</span><span class="sxs-lookup"><span data-stu-id="dff1e-166">This process is illustrated in the diagram.</span></span>

![Diagrama do serviço de autenticação](./media/app-service-api-dotnet-service-principal-auth/appdiagram.png)

<span data-ttu-id="dff1e-168">Se você enfrenta problemas ao seguir as instruções do tutorial, consulte a seção [Solução de problemas](#troubleshooting) no final do tutorial.</span><span class="sxs-lookup"><span data-stu-id="dff1e-168">If you run into problems while following the tutorial directions, see the [Troubleshooting](#troubleshooting) section at the end of the tutorial.</span></span> 

1. <span data-ttu-id="dff1e-169">No [Portal do Azure](https://portal.azure.com/), navegue até a folha **Configuração** do aplicativo de API que você criou para ToDoListDataAPI (camada de dados) e clique em **Configurações**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-169">In the [Azure portal](https://portal.azure.com/), navigate to the **Settings** blade of the API app that you created for the ToDoListDataAPI (data tier) API app, and then click **Settings**.</span></span>
2. <span data-ttu-id="dff1e-170">Na folha **Configurações**, localize a seção **Recursos** e clique em **Autenticação / Autorização**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-170">In the **Settings** blade, find the **Features** section, and then click **Authentication / Authorization**.</span></span>
   
    ![Autenticação/Autorização no portal do Azure](./media/app-service-api-dotnet-user-principal-auth/features.png)
3. <span data-ttu-id="dff1e-172">Na folha **Autenticação/Autorização**, clique em **Ativada**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-172">In the **Authentication / Authorization** blade, click **On**.</span></span>
4. <span data-ttu-id="dff1e-173">Na lista suspensa **Ação a tomar quando a solicitação não está autenticada**, selecione **Efetuar logon com o Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-173">In the **Action to take when request is not authenticated** drop-down list, select **Log in with Azure Active Directory**.</span></span>
   
    <span data-ttu-id="dff1e-174">Essa é a configuração que faz com que o Serviço de Aplicativo garanta que somente solicitações autenticadas cheguem ao aplicativo de API.</span><span class="sxs-lookup"><span data-stu-id="dff1e-174">This is the setting that causes App Service to ensure that only authenticated requests reach the API app.</span></span> <span data-ttu-id="dff1e-175">Para solicitações com tokens de portador válido, o Serviço de Aplicativo passa os tokens para o aplicativo de API e popula os cabeçalhos HTTP com declarações comumente usadas para disponibilizar essas informações mais facilmente ao código.</span><span class="sxs-lookup"><span data-stu-id="dff1e-175">For requests that have valid bearer tokens, App Service passes the tokens along to the API app and populates HTTP headers with commonly used claims to make that information more easily available to your code.</span></span>
5. <span data-ttu-id="dff1e-176">Em **Provedores de Autenticação**, clique em **Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-176">Under **Authentication Providers**, click **Azure Active Directory**.</span></span>
   
    ![Folha Autenticação/Autorização no portal do Azure](./media/app-service-api-dotnet-user-principal-auth/authblade.png)
6. <span data-ttu-id="dff1e-178">Na folha **Configurações do Azure Active Directory**, clique em **Expresso**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-178">In the **Azure Active Directory Settings** blade, click **Express**.</span></span>
   
    <span data-ttu-id="dff1e-179">Com a opção **Expresso**, o Azure pode criar automaticamente um aplicativo do AAD no [locatário](https://msdn.microsoft.com/en-us/library/azure/jj573650.aspx#BKMK_WhatIsAnAzureADTenant) do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="dff1e-179">With the **Express** option Azure can automatically create an AAD application in your Azure AD [tenant](https://msdn.microsoft.com/en-us/library/azure/jj573650.aspx#BKMK_WhatIsAnAzureADTenant).</span></span> 
   
    <span data-ttu-id="dff1e-180">Você não precisa criar um locatário, pois cada conta do Azure tem um automaticamente.</span><span class="sxs-lookup"><span data-stu-id="dff1e-180">You don't have to create a tenant, because every Azure account automatically has one.</span></span>
7. <span data-ttu-id="dff1e-181">Em **Modo de gerenciamento**, clique em **Criar novo aplicativo do AD** se ainda não estiver selecionado.</span><span class="sxs-lookup"><span data-stu-id="dff1e-181">Under **Management mode**, click **Create New AD App** if it isn't already selected.</span></span>
   
    <span data-ttu-id="dff1e-182">O portal insere um valor padrão na caixa de entrada **Criar Aplicativo** .</span><span class="sxs-lookup"><span data-stu-id="dff1e-182">The portal plugs the **Create App** input box with a default value.</span></span> <span data-ttu-id="dff1e-183">Por padrão, o aplicativo Azure AD tem o mesmo nome que o aplicativo de API.</span><span class="sxs-lookup"><span data-stu-id="dff1e-183">By default, the Azure AD application is named the same as the API app.</span></span> <span data-ttu-id="dff1e-184">Se preferir, você pode inserir um nome diferente.</span><span class="sxs-lookup"><span data-stu-id="dff1e-184">If you prefer, you can enter a different name.</span></span>
   
    ![Configurações do Azure AD](./media/app-service-api-dotnet-service-principal-auth/aadsettings.png)
   
    <span data-ttu-id="dff1e-186">**Observação**: como alternativa, você pode usar um único aplicativo Azure AD para o aplicativo de API de chamada e o aplicativo de API protegido.</span><span class="sxs-lookup"><span data-stu-id="dff1e-186">**Note**: As an alternative, you could use a single Azure AD application for both the calling API app and the protected API app.</span></span> <span data-ttu-id="dff1e-187">Se escolher essa alternativa, você não precisará da opção **Criar novo aplicativo do AD** aqui, pois já criou um aplicativo Azure AD no início do tutorial de autenticação de usuário.</span><span class="sxs-lookup"><span data-stu-id="dff1e-187">If you chose that alternative, you would not need the **Create New AD App** option here because you already created an Azure AD application earlier in the user authentication tutorial.</span></span> <span data-ttu-id="dff1e-188">Neste tutorial, você usará aplicativos do Azure AD separados para o aplicativo de API de chamada e o aplicativo de API protegido.</span><span class="sxs-lookup"><span data-stu-id="dff1e-188">For this tutorial, you'll use separate Azure AD applications for the calling API app and the protected API app.</span></span>
8. <span data-ttu-id="dff1e-189">Anote o valor que está na caixa de entrada **Criar Aplicativo** ; você procurará esse aplicativo do AAD no portal clássico do Azure posteriormente.</span><span class="sxs-lookup"><span data-stu-id="dff1e-189">Make a note of the value that is in the **Create App** input box; you'll look up this AAD application in the Azure classic portal later.</span></span>
9. <span data-ttu-id="dff1e-190">Clique em **OK**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-190">Click **OK**.</span></span>
10. <span data-ttu-id="dff1e-191">Na folha **Autenticação/Autorização**, clique em **Salvar**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-191">In the **Authentication / Authorization** blade, click **Save**.</span></span>
    
    ![Clique em Salvar](./media/app-service-api-dotnet-service-principal-auth/saveauth.png)
    
    <span data-ttu-id="dff1e-193">O Serviço de Aplicativo cria um aplicativo do Azure Active Directory com a **URL de entrada** e a **URL de resposta** definidas automaticamente como a URL de seu aplicativo de API.</span><span class="sxs-lookup"><span data-stu-id="dff1e-193">App Service creates an Azure Active Directory application with **Sign-on URL** and **Reply URL** automatically set to the URL of your API app.</span></span> <span data-ttu-id="dff1e-194">O último valor habilita os usuários em seu locatário do AAD a fazer logon e acessar o aplicativo de API.</span><span class="sxs-lookup"><span data-stu-id="dff1e-194">The latter value enables users in your AAD tenant to log in and access the API app.</span></span>

### <a name="verify-that-the-api-app-is-protected"></a><span data-ttu-id="dff1e-195">Verificar se o aplicativo de API está protegido</span><span class="sxs-lookup"><span data-stu-id="dff1e-195">Verify that the API app is protected</span></span>
1. <span data-ttu-id="dff1e-196">Em um navegador, vá para a URL do aplicativo de API: na folha **Aplicativo de API** no portal do Azure, clique no link na **URL**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-196">In a browser go to the URL of the API app: in the **API app** blade in the Azure portal, click the link under **URL**.</span></span> 
   
    <span data-ttu-id="dff1e-197">Você será redirecionado para uma tela de logon, pois solicitações não autenticadas não têm permissão para chegar ao aplicativo de API.</span><span class="sxs-lookup"><span data-stu-id="dff1e-197">You are redirected to a login screen because unauthenticated requests are not allowed to reach the API app.</span></span> 
   
    <span data-ttu-id="dff1e-198">Se seu navegador for para a interface do usuário do Swagger, talvez já esteja conectado. Nesse caso, abra uma janela InPrivate ou Incognito e vá para a URL da interface do usuário do Swagger.</span><span class="sxs-lookup"><span data-stu-id="dff1e-198">If your browser does go to the Swagger UI, your browser might already be logged on -- in that case, open an InPrivate or Incognito window and go to the Swagger UI URL.</span></span>
2. <span data-ttu-id="dff1e-199">Faça logon com as credenciais de um usuário em seu locatário do AAD.</span><span class="sxs-lookup"><span data-stu-id="dff1e-199">Log in with credentials of a user in your AAD tenant.</span></span>
   
   <span data-ttu-id="dff1e-200">Quando você estiver conectado, uma página "criado com êxito" será exibida no navegador.</span><span class="sxs-lookup"><span data-stu-id="dff1e-200">When you're logged on, the "successfully created" page appears in the browser.</span></span>

## <a name="configure-the-todolistapi-project-to-acquire-and-send-the-azure-ad-token"></a><span data-ttu-id="dff1e-201">Configurar o projeto ToDoListAPI para adquirir e enviar o token do Azure AD</span><span class="sxs-lookup"><span data-stu-id="dff1e-201">Configure the ToDoListAPI project to acquire and send the Azure AD token</span></span>
<span data-ttu-id="dff1e-202">Nesta seção, você executará as seguintes tarefas:</span><span class="sxs-lookup"><span data-stu-id="dff1e-202">In this section you do the following tasks:</span></span>

* <span data-ttu-id="dff1e-203">Adicionar código no aplicativo de API de camada intermediária que usa credenciais do aplicativo Azure AD para adquirir um token e enviá-lo com solicitações HTTP ao aplicativo de API de camada de dados.</span><span class="sxs-lookup"><span data-stu-id="dff1e-203">Add code in the middle tier API app that uses Azure AD application credentials to acquire a token and send it with HTTP requests to the data tier API app.</span></span>
* <span data-ttu-id="dff1e-204">Obter as credenciais necessárias do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="dff1e-204">Get the credentials you need from Azure AD.</span></span>
* <span data-ttu-id="dff1e-205">Inserir as credenciais nas configurações de ambiente de tempo de execução do Serviço de Aplicativo do Azure no aplicativo de API de camada intermediária.</span><span class="sxs-lookup"><span data-stu-id="dff1e-205">Enter the credentials into Azure App Service runtime environment settings in the middle tier API app.</span></span> 

### <a name="configure-the-todolistapi-project-to-acquire-and-send-the-azure-ad-token"></a><span data-ttu-id="dff1e-206">Configurar o projeto ToDoListAPI para adquirir e enviar o token do Azure AD</span><span class="sxs-lookup"><span data-stu-id="dff1e-206">Configure the ToDoListAPI project to acquire and send the Azure AD token</span></span>
<span data-ttu-id="dff1e-207">Faça as alterações a seguir no projeto ToDoListAPI no Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="dff1e-207">Make the following changes in the ToDoListAPI project in Visual Studio.</span></span>

1. <span data-ttu-id="dff1e-208">Remova as marcas de comentários de todo o código no arquivo *ServicePrincipal.cs* .</span><span class="sxs-lookup"><span data-stu-id="dff1e-208">Uncomment all of the code in the *ServicePrincipal.cs* file.</span></span>
   
    <span data-ttu-id="dff1e-209">Esse é o código que usa a ADAL para .NET para adquirir o token de portador do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="dff1e-209">This is the code that uses ADAL for .NET to acquire the Azure AD bearer token.</span></span>  <span data-ttu-id="dff1e-210">Ele usa vários valores de configuração que você definirá mais tarde no ambiente de tempo de execução do Azure.</span><span class="sxs-lookup"><span data-stu-id="dff1e-210">It uses several configuration values that you'll set in the Azure runtime environment later.</span></span> <span data-ttu-id="dff1e-211">O código é o seguinte:</span><span class="sxs-lookup"><span data-stu-id="dff1e-211">Here's the code:</span></span> 
   
        public static class ServicePrincipal
        {
            static string authority = ConfigurationManager.AppSettings["ida:Authority"];
            static string clientId = ConfigurationManager.AppSettings["ida:ClientId"];
            static string clientSecret = ConfigurationManager.AppSettings["ida:ClientSecret"];
            static string resource = ConfigurationManager.AppSettings["ida:Resource"];
   
            public static AuthenticationResult GetS2SAccessTokenForProdMSA()
            {
                return GetS2SAccessToken(authority, resource, clientId, clientSecret);
            }
   
            static AuthenticationResult GetS2SAccessToken(string authority, string resource, string clientId, string clientSecret)
            {
                var clientCredential = new ClientCredential(clientId, clientSecret);
                AuthenticationContext context = new AuthenticationContext(authority, false);
                AuthenticationResult authenticationResult = context.AcquireToken(
                    resource,
                    clientCredential);
                return authenticationResult;
            }
        }
   
    <span data-ttu-id="dff1e-212">**Observação:** esse código requer a ADAL para o pacote do NuGet do .NET (Microsoft.IdentityModel.Clients.ActiveDirectory), que já está instalado no projeto.</span><span class="sxs-lookup"><span data-stu-id="dff1e-212">**Note:** This code requires the ADAL for .NET NuGet package (Microsoft.IdentityModel.Clients.ActiveDirectory), which is already installed in the project.</span></span> <span data-ttu-id="dff1e-213">Se criasse o projeto do zero, você precisaria instalar este pacote.</span><span class="sxs-lookup"><span data-stu-id="dff1e-213">If you were creating this project from scratch, you would have to install this package.</span></span> <span data-ttu-id="dff1e-214">O pacote não é instalado automaticamente pelo modelo de novo projeto de aplicativo de API.</span><span class="sxs-lookup"><span data-stu-id="dff1e-214">This package is not automatically installed by the API app new-project template.</span></span>
2. <span data-ttu-id="dff1e-215">Em *Controllers/ToDoListController*, remova as marcas de comentário do código no método `NewDataAPIClient` que adiciona o token a solicitações HTTP no cabeçalho de autorização.</span><span class="sxs-lookup"><span data-stu-id="dff1e-215">In *Controllers/ToDoListController*, uncomment the code in the `NewDataAPIClient` method that adds the token to HTTP requests in the authorization header.</span></span>
   
        client.HttpClient.DefaultRequestHeaders.Authorization =
            new AuthenticationHeaderValue("Bearer", ServicePrincipal.GetS2SAccessTokenForProdMSA().AccessToken);
3. <span data-ttu-id="dff1e-216">Implantar o projeto ToDoListAPI.</span><span class="sxs-lookup"><span data-stu-id="dff1e-216">Deploy the ToDoListAPI project.</span></span> <span data-ttu-id="dff1e-217">(Clique com o botão direito do mouse no projeto e em **Publicar > Publicar**.)</span><span class="sxs-lookup"><span data-stu-id="dff1e-217">(Right-click the project, then click **Publish > Publish**.)</span></span>
   
    <span data-ttu-id="dff1e-218">O Visual Studio implanta o projeto e abre a URL base do aplicativo Web em um navegador.</span><span class="sxs-lookup"><span data-stu-id="dff1e-218">Visual Studio deploys the project and opens a browser to the web app's base URL.</span></span> <span data-ttu-id="dff1e-219">Isso mostrará uma página de erro 403, que é normal em uma tentativa de ir para uma URL base da API Web em um navegador.</span><span class="sxs-lookup"><span data-stu-id="dff1e-219">This will show a 403 error page, which is normal for an attempt to go to a Web API base URL from a browser.</span></span>
4. <span data-ttu-id="dff1e-220">Feche o navegador.</span><span class="sxs-lookup"><span data-stu-id="dff1e-220">Close the browser.</span></span>

### <a name="get-azure-ad-configuration-values"></a><span data-ttu-id="dff1e-221">Obter valores de configuração do Azure AD</span><span class="sxs-lookup"><span data-stu-id="dff1e-221">Get Azure AD configuration values</span></span>
1. <span data-ttu-id="dff1e-222">No [portal clássico do Azure](https://manage.windowsazure.com/), vá para **Active Directory do Azure**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-222">In the [Azure classic portal](https://manage.windowsazure.com/), go to **Azure Active Directory**.</span></span>
2. <span data-ttu-id="dff1e-223">Na guia **Diretório** , clique no locatário do AAD.</span><span class="sxs-lookup"><span data-stu-id="dff1e-223">On the **Directory** tab, click your AAD tenant.</span></span>
3. <span data-ttu-id="dff1e-224">Clique em **Aplicativos > Aplicativos que minha empresa tem** e clique na marca de seleção.</span><span class="sxs-lookup"><span data-stu-id="dff1e-224">Click **Applications > Applications my company owns**, and then click the check mark.</span></span>
4. <span data-ttu-id="dff1e-225">Na lista de aplicativos, clique no nome do aplicativo que o Azure criou quando você habilitou a autenticação para o aplicativo de API ToDoListDataAPI (camada de dados).</span><span class="sxs-lookup"><span data-stu-id="dff1e-225">In the list of applications, click the name of the one that Azure created for you when you enabled authentication for the ToDoListDataAPI (data tier) API app.</span></span>
5. <span data-ttu-id="dff1e-226">Clique na guia **Configurar** .</span><span class="sxs-lookup"><span data-stu-id="dff1e-226">Click the **Configure** tab.</span></span>
6. <span data-ttu-id="dff1e-227">Copie o valor de **ID do cliente** e salve-o em algum local em que você possa obtê-lo posteriormente.</span><span class="sxs-lookup"><span data-stu-id="dff1e-227">Copy the **Client ID** value and save it someplace you can get it from later.</span></span> 
7. <span data-ttu-id="dff1e-228">No Portal Clássico do Azure, volte à lista de **Aplicativos que minha empresa possui**e clique no aplicativo do AAD que você criou para o aplicativo de API de camada intermediária ToDoListAPI (aquele que você criou no tutorial anterior, não o criado neste tutorial).</span><span class="sxs-lookup"><span data-stu-id="dff1e-228">In the Azure classic portal go back to the list of **Applications my company owns**, and click the AAD application that you created for the middle tier ToDoListAPI API app (the one you created in the previous tutorial, not the one you created in this tutorial).</span></span>
8. <span data-ttu-id="dff1e-229">Clique na guia **Configurar** .</span><span class="sxs-lookup"><span data-stu-id="dff1e-229">Click the **Configure** tab.</span></span>
9. <span data-ttu-id="dff1e-230">Copie o valor de **ID do cliente** e salve-o em algum local em que você possa obtê-lo posteriormente.</span><span class="sxs-lookup"><span data-stu-id="dff1e-230">Copy the **Client ID** value and save it someplace you can get it from later.</span></span>
10. <span data-ttu-id="dff1e-231">Em **Chaves**, selecione **1 ano** na lista suspensa **Selecionar duração**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-231">Under **keys**, select **1 year** from the **Select duration** drop-down list.</span></span>
11. <span data-ttu-id="dff1e-232">Clique em **Salvar**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-232">Click **Save**.</span></span>
    
     ![Gerar chave do aplicativo](./media/app-service-api-dotnet-service-principal-auth/genkey.png)
12. <span data-ttu-id="dff1e-234">Copie o valor de chave e salve-o em algum local em que você possa obtê-lo posteriormente.</span><span class="sxs-lookup"><span data-stu-id="dff1e-234">Copy the key value and save it someplace you can get it from later.</span></span>
    
     ![Copiar a nova chave do aplicativo](./media/app-service-api-dotnet-service-principal-auth/genkeycopy.png)

### <a name="configure-azure-ad-settings-in-the-middle-tier-api-apps-runtime-environment"></a><span data-ttu-id="dff1e-236">Definir configurações do Azure AD no ambiente de tempo de execução do aplicativo de API de camada intermediária</span><span class="sxs-lookup"><span data-stu-id="dff1e-236">Configure Azure AD settings in the middle tier API app's runtime environment</span></span>
1. <span data-ttu-id="dff1e-237">Vá para o [Portal do Azure](https://portal.azure.com/)e navegue até a folha **Aplicativo de API** do aplicativo de API que hospeda o projeto TodoListAPI (camada intermediária).</span><span class="sxs-lookup"><span data-stu-id="dff1e-237">Go to the [Azure portal](https://portal.azure.com/), and then navigate to the **API App** blade for the API app that hosts the TodoListAPI (middle tier) project.</span></span>
2. <span data-ttu-id="dff1e-238">Clique em **Configurações > Configurações do Aplicativo**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-238">Click **Settings > Application Settings**.</span></span>
3. <span data-ttu-id="dff1e-239">Na seção **Configurações do aplicativo** , adicione as seguintes chaves e valores:</span><span class="sxs-lookup"><span data-stu-id="dff1e-239">In the **App settings** section, add the following keys and values:</span></span>
   
   | <span data-ttu-id="dff1e-240">**Chave**</span><span class="sxs-lookup"><span data-stu-id="dff1e-240">**Key**</span></span> | <span data-ttu-id="dff1e-241">ida:Authority</span><span class="sxs-lookup"><span data-stu-id="dff1e-241">ida:Authority</span></span> |
   | --- | --- |
   | <span data-ttu-id="dff1e-242">**Valor**</span><span class="sxs-lookup"><span data-stu-id="dff1e-242">**Value**</span></span> |<span data-ttu-id="dff1e-243">https://login.microsoftonline.com/{your Azure AD tenant name}</span><span class="sxs-lookup"><span data-stu-id="dff1e-243">https://login.microsoftonline.com/{your Azure AD tenant name}</span></span> |
   | <span data-ttu-id="dff1e-244">**Exemplo**</span><span class="sxs-lookup"><span data-stu-id="dff1e-244">**Example**</span></span> |<span data-ttu-id="dff1e-245">https://login.microsoftonline.com/contoso.onmicrosoft.com</span><span class="sxs-lookup"><span data-stu-id="dff1e-245">https://login.microsoftonline.com/contoso.onmicrosoft.com</span></span> |
   
   | <span data-ttu-id="dff1e-246">**Chave**</span><span class="sxs-lookup"><span data-stu-id="dff1e-246">**Key**</span></span> | <span data-ttu-id="dff1e-247">ida:ClientId</span><span class="sxs-lookup"><span data-stu-id="dff1e-247">ida:ClientId</span></span> |
   | --- | --- |
   | <span data-ttu-id="dff1e-248">**Valor**</span><span class="sxs-lookup"><span data-stu-id="dff1e-248">**Value**</span></span> |<span data-ttu-id="dff1e-249">ID do cliente do aplicativo de chamada (camada intermediária - ToDoListAPI)</span><span class="sxs-lookup"><span data-stu-id="dff1e-249">Client ID of the calling application (middle tier - ToDoListAPI)</span></span> |
   | <span data-ttu-id="dff1e-250">**Exemplo**</span><span class="sxs-lookup"><span data-stu-id="dff1e-250">**Example**</span></span> |<span data-ttu-id="dff1e-251">960adec2-b74a-484a-960adec2-b74a-484a</span><span class="sxs-lookup"><span data-stu-id="dff1e-251">960adec2-b74a-484a-960adec2-b74a-484a</span></span> |
   
   | <span data-ttu-id="dff1e-252">**Chave**</span><span class="sxs-lookup"><span data-stu-id="dff1e-252">**Key**</span></span> | <span data-ttu-id="dff1e-253">ida:ClientSecret</span><span class="sxs-lookup"><span data-stu-id="dff1e-253">ida:ClientSecret</span></span> |
   | --- | --- |
   | <span data-ttu-id="dff1e-254">**Valor**</span><span class="sxs-lookup"><span data-stu-id="dff1e-254">**Value**</span></span> |<span data-ttu-id="dff1e-255">Chave de aplicativo do aplicativo de chamada (camada intermediária - ToDoListAPI)</span><span class="sxs-lookup"><span data-stu-id="dff1e-255">App key of the calling application (middle tier - ToDoListAPI)</span></span> |
   | <span data-ttu-id="dff1e-256">**Exemplo**</span><span class="sxs-lookup"><span data-stu-id="dff1e-256">**Example**</span></span> |<span data-ttu-id="dff1e-257">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span><span class="sxs-lookup"><span data-stu-id="dff1e-257">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span></span> |
   
   | <span data-ttu-id="dff1e-258">**Chave**</span><span class="sxs-lookup"><span data-stu-id="dff1e-258">**Key**</span></span> | <span data-ttu-id="dff1e-259">ida:Resource</span><span class="sxs-lookup"><span data-stu-id="dff1e-259">ida:Resource</span></span> |
   | --- | --- |
   | <span data-ttu-id="dff1e-260">**Valor**</span><span class="sxs-lookup"><span data-stu-id="dff1e-260">**Value**</span></span> |<span data-ttu-id="dff1e-261">ID do cliente do aplicativo chamado (camada de dados - ToDoListDataAPI)</span><span class="sxs-lookup"><span data-stu-id="dff1e-261">Client ID of the called application (data tier - ToDoListDataAPI)</span></span> |
   | <span data-ttu-id="dff1e-262">**Exemplo**</span><span class="sxs-lookup"><span data-stu-id="dff1e-262">**Example**</span></span> |<span data-ttu-id="dff1e-263">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span><span class="sxs-lookup"><span data-stu-id="dff1e-263">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span></span> |
   
    <span data-ttu-id="dff1e-264">**Observação**: para `ida:Resource`, use a **ID do cliente** do aplicativo e não o **URI da ID do aplicativo**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-264">**Note**: For `ida:Resource`, make sure you use the called application's **client ID** and not its **App ID URI**.</span></span>
   
    <span data-ttu-id="dff1e-265">`ida:ClientId` e `ida:Resource` são diferentes valores para este tutorial porque você está usando aplicativos Azure AD separados para a camada intermediária e para a camada de dados.</span><span class="sxs-lookup"><span data-stu-id="dff1e-265">`ida:ClientId` and `ida:Resource` are different values for this tutorial because you're using separate Azure AD applicaations for the middle tier and data tier.</span></span> <span data-ttu-id="dff1e-266">Se estivesse usando um único aplicativo Azure AD para o aplicativo de chamada de API e para o aplicativo de API protegido, você usaria o mesmo valor em `ida:ClientId` e `ida:Resource`.</span><span class="sxs-lookup"><span data-stu-id="dff1e-266">If you were using a single Azure AD application for the calling API app and the protected API app, you would use the same value in both `ida:ClientId` and `ida:Resource`.</span></span>
   
    <span data-ttu-id="dff1e-267">O código usa o ConfigurationManager para obter esses valores, para que eles possam ser armazenados no arquivo Web.config do projeto ou no ambiente de tempo de execução do Azure.</span><span class="sxs-lookup"><span data-stu-id="dff1e-267">The code uses ConfigurationManager to get these values, so they could be stored in the project's Web.config file or in the Azure runtime environment.</span></span> <span data-ttu-id="dff1e-268">Enquanto um aplicativo do ASP.NET é executado no Serviço de Aplicativo do Azure, as configurações de ambiente automaticamente substituem as configurações de Web.config.</span><span class="sxs-lookup"><span data-stu-id="dff1e-268">While an ASP.NET application is running in Azure App Service, environment settings automatically override settings from Web.config.</span></span> <span data-ttu-id="dff1e-269">As configurações de ambiente geralmente são uma [maneira mais segura de armazenar informações confidenciais em comparação com um arquivo Web.config](http://www.asp.net/identity/overview/features-api/best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure).</span><span class="sxs-lookup"><span data-stu-id="dff1e-269">Environment settings are generally a [more secure way to store sensitive information compared to a Web.config file](http://www.asp.net/identity/overview/features-api/best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure).</span></span>
4. <span data-ttu-id="dff1e-270">Clique em **Salvar**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-270">Click **Save**.</span></span>
   
    ![Clique em Salvar](./media/app-service-api-dotnet-service-principal-auth/appsettings.png)

### <a name="test-the-application"></a><span data-ttu-id="dff1e-272">Testar o aplicativo</span><span class="sxs-lookup"><span data-stu-id="dff1e-272">Test the application</span></span>
1. <span data-ttu-id="dff1e-273">Em um navegador, vá para a URL HTTPS do aplicativo Web de front-end do AngularJS.</span><span class="sxs-lookup"><span data-stu-id="dff1e-273">In a browser go to the HTTPS URL of the AngularJS front end web app.</span></span>
2. <span data-ttu-id="dff1e-274">Clique na guia **Lista de Tarefas Pendentes** e faça logon usando as credenciais de um usuário de seu locatário do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="dff1e-274">Click the **To Do List** tab and log in with credentials for a user in your Azure AD tenant.</span></span> 
3. <span data-ttu-id="dff1e-275">Adicione itens pendentes para verificar se o aplicativo está funcionando.</span><span class="sxs-lookup"><span data-stu-id="dff1e-275">Add to-do items to verify that the application is working.</span></span>
   
    ![A página Lista de tarefas pendentes](./media/app-service-api-dotnet-service-principal-auth/mvchome.png)
   
    <span data-ttu-id="dff1e-277">Se o aplicativo não funcionar conforme o esperado, verifique todas as configurações que você inseriu no portal do Azure.</span><span class="sxs-lookup"><span data-stu-id="dff1e-277">If the application doesn't work as expected, double-check all of the settings you entered in the Azure portal.</span></span> <span data-ttu-id="dff1e-278">Se todas as configurações parecerem corretas, confira a seção [Solução de problemas](#troubleshooting) mais adiante neste tutorial.</span><span class="sxs-lookup"><span data-stu-id="dff1e-278">If all of the settings appear to be correct, see the [Troubleshooting](#troubleshooting) section later in this tutorial.</span></span>

## <a name="protect-the-api-app-from-browser-access"></a><span data-ttu-id="dff1e-279">Proteger o aplicativo de API contra acesso do navegador</span><span class="sxs-lookup"><span data-stu-id="dff1e-279">Protect the API app from browser access</span></span>
<span data-ttu-id="dff1e-280">Para este tutorial, você criou um aplicativo Azure AD separado para o aplicativo de API ToDoListDataAPI (camada de dados).</span><span class="sxs-lookup"><span data-stu-id="dff1e-280">For this tutorial you created a separate Azure AD application for the ToDoListDataAPI (data tier) API app.</span></span> <span data-ttu-id="dff1e-281">Como você viu, quando o Serviço de Aplicativo cria um aplicativo do AAD, ele configura o aplicativo do AAD de uma maneira que habilita um usuário a ir para a URL do aplicativo de API em um navegador e fazer logon.</span><span class="sxs-lookup"><span data-stu-id="dff1e-281">As you've seen, when App Service creates an AAD application, it configures the AAD application in a way that enables a user to go to the API app's URL in a browser and log on.</span></span> <span data-ttu-id="dff1e-282">Isso significa que é possível que um usuário final em seu locatário do Azure AD (e não apenas uma entidade de serviço) acesse a API.</span><span class="sxs-lookup"><span data-stu-id="dff1e-282">That means it's possible for an end user in your Azure AD tenant, not just a service principal, to access the API.</span></span> 

<span data-ttu-id="dff1e-283">Se quiser impedir o acesso do navegador sem escrever código no aplicativo de API protegido, você poderá alterar a **URL de resposta** no aplicativo do AAD para que ela seja diferente da URL de base do aplicativo de API.</span><span class="sxs-lookup"><span data-stu-id="dff1e-283">If you want to prevent browser access without writing any code in the protected API app, you can change the **Reply URL** in the AAD application so that it's different from the API app's base URL.</span></span> 

### <a name="disable-browser-access"></a><span data-ttu-id="dff1e-284">Desabilitar o acesso do navegador</span><span class="sxs-lookup"><span data-stu-id="dff1e-284">Disable browser access</span></span>
1. <span data-ttu-id="dff1e-285">Na guia **Configurar** do portal clássico do aplicativo do AAD criado para o projeto TodoListService, altere o valor do campo **URL de Resposta** para que seja uma URL válida, mas não a URL do aplicativo de API.</span><span class="sxs-lookup"><span data-stu-id="dff1e-285">In the classic portal's **Configure** tab for the AAD application that was created for the TodoListService, change the value in the **Reply URL** field so that it is a valid URL but not the API app's URL.</span></span>
2. <span data-ttu-id="dff1e-286">Clique em **Salvar**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-286">Click **Save**.</span></span>

### <a name="verify-browser-access-no-longer-works"></a><span data-ttu-id="dff1e-287">Verificar se o acesso de navegador não funciona mais</span><span class="sxs-lookup"><span data-stu-id="dff1e-287">Verify browser access no longer works</span></span>
<span data-ttu-id="dff1e-288">Anteriormente, você verificou que pode ir para a URL do aplicativo de API por meio de um navegador fazendo logon com as credenciais de um usuário individual.</span><span class="sxs-lookup"><span data-stu-id="dff1e-288">Earlier you verified that you can go to the API app URL from a browser by logging on with an individual user's credentials.</span></span> <span data-ttu-id="dff1e-289">Nesta seção, você verá que isso não é mais possível.</span><span class="sxs-lookup"><span data-stu-id="dff1e-289">In this section, you verify that this is no longer possible.</span></span> 

1. <span data-ttu-id="dff1e-290">Em uma nova janela do navegador, vá para a URL do aplicativo de API novamente.</span><span class="sxs-lookup"><span data-stu-id="dff1e-290">In a new browser window, go to the URL of the API app again.</span></span>
2. <span data-ttu-id="dff1e-291">Faça logon quando for solicitado a fazer isso.</span><span class="sxs-lookup"><span data-stu-id="dff1e-291">Log in when prompted to do so.</span></span>
3. <span data-ttu-id="dff1e-292">O logon é bem-sucedido, mas leva a uma página de erro.</span><span class="sxs-lookup"><span data-stu-id="dff1e-292">Login succeeds but leads to an error page.</span></span>
   
    <span data-ttu-id="dff1e-293">Você configurou o aplicativo do AAD para que os usuários no locatário do AAD não possam fazer logon e acessar a API por meio de um navegador.</span><span class="sxs-lookup"><span data-stu-id="dff1e-293">You've configured the AAD app so that users in the AAD tenant cannot log in and access the API from a browser.</span></span> <span data-ttu-id="dff1e-294">Você ainda pode acessar o aplicativo de API usando um token de entidade de serviço, que você pode verificar indo para a URL do aplicativo Web e adicionando mais itens pendentes.</span><span class="sxs-lookup"><span data-stu-id="dff1e-294">You can still access the API app by using a service principal token, which you can verify by going to the web app's URL and adding more to-do items.</span></span>

## <a name="restrict-access-to-a-particular-service-principal"></a><span data-ttu-id="dff1e-295">Restringir o acesso a uma entidade de serviço específica</span><span class="sxs-lookup"><span data-stu-id="dff1e-295">Restrict access to a particular service principal</span></span>
<span data-ttu-id="dff1e-296">Agora, qualquer chamador que possa obter um token para um usuário ou uma entidade de serviço em seu locatário do Azure AD poderá chamar o aplicativo de API TodoListDataAPI (camada de dados).</span><span class="sxs-lookup"><span data-stu-id="dff1e-296">Right now, any caller that can get a token for a user or service principal in your Azure AD tenant can call the TodoListDataAPI (data tier) API app.</span></span> <span data-ttu-id="dff1e-297">Convém garantir que o aplicativo de API de camada de dados só aceite chamadas do aplicativo de API TodoListAPI (camada intermediária) e apenas de uma entidade de serviço específica.</span><span class="sxs-lookup"><span data-stu-id="dff1e-297">You might want to make sure that the data tier API app only accepts calls from the TodoListAPI (middle tier) API app, and only from a particular service principal.</span></span> 

<span data-ttu-id="dff1e-298">Você pode adicionar essas restrições adicionando código para validar as declarações `appid` e `objectidentifier` em chamadas de entrada.</span><span class="sxs-lookup"><span data-stu-id="dff1e-298">You can add these restrictions by adding code to validate the `appid` and `objectidentifier` claims on incoming calls.</span></span>

<span data-ttu-id="dff1e-299">Para este tutorial, você coloca o código que valida a ID do aplicativo e a ID da entidade de serviço diretamente em suas ações do controlador.</span><span class="sxs-lookup"><span data-stu-id="dff1e-299">For this tutorial you put the code that validates app ID and service principal ID directly in your controller actions.</span></span>  <span data-ttu-id="dff1e-300">As alternativas são usar um atributo `Authorize` personalizado ou fazer essa validação nas sequências de inicialização (por exemplo, middleware OWIN).</span><span class="sxs-lookup"><span data-stu-id="dff1e-300">Alternatives are to use a custom `Authorize` attribute or to do this validation in your startup sequences (e.g. OWIN middleware).</span></span> <span data-ttu-id="dff1e-301">Para obter um exemplo desse último item, consulte [este aplicativo de exemplo](https://github.com/mohitsriv/EasyAuthMultiTierSample/blob/master/MyDashDataAPI/Startup.cs).</span><span class="sxs-lookup"><span data-stu-id="dff1e-301">For an example of the latter, see [this sample application](https://github.com/mohitsriv/EasyAuthMultiTierSample/blob/master/MyDashDataAPI/Startup.cs).</span></span> 

<span data-ttu-id="dff1e-302">Faça as alterações a seguir no projeto TodoListDataAPI.</span><span class="sxs-lookup"><span data-stu-id="dff1e-302">Make the following changes to the TodoListDataAPI project.</span></span>

1. <span data-ttu-id="dff1e-303">Abra o arquivo *Controllers/TodoListController.cs* .</span><span class="sxs-lookup"><span data-stu-id="dff1e-303">Open the *Controllers/TodoListController.cs* file.</span></span>
2. <span data-ttu-id="dff1e-304">Remova as marcas de comentários das linhas que definem `trustedCallerClientId` e `trustedCallerServicePrincipalId`.</span><span class="sxs-lookup"><span data-stu-id="dff1e-304">Uncomment the lines that set `trustedCallerClientId` and `trustedCallerServicePrincipalId`.</span></span>
   
        private static string trustedCallerClientId = ConfigurationManager.AppSettings["todo:TrustedCallerClientId"];
        private static string trustedCallerServicePrincipalId = ConfigurationManager.AppSettings["todo:TrustedCallerServicePrincipalId"];
3. <span data-ttu-id="dff1e-305">Remova as marcas de comentários do código no método CheckCallerId.</span><span class="sxs-lookup"><span data-stu-id="dff1e-305">Uncomment the code in the CheckCallerId method.</span></span> <span data-ttu-id="dff1e-306">Esse método é chamado no início de cada método de ação no controlador.</span><span class="sxs-lookup"><span data-stu-id="dff1e-306">This method is called at the start of every action method in the controller.</span></span> 
   
        private static void CheckCallerId()
        {
            string currentCallerClientId = ClaimsPrincipal.Current.FindFirst("appid").Value;
            string currentCallerServicePrincipalId = ClaimsPrincipal.Current.FindFirst("http://schemas.microsoft.com/identity/claims/objectidentifier").Value;
            if (currentCallerClientId != trustedCallerClientId || currentCallerServicePrincipalId != trustedCallerServicePrincipalId)
            {
                throw new HttpResponseException(new HttpResponseMessage { StatusCode = HttpStatusCode.Unauthorized, ReasonPhrase = "The appID or service principal ID is not the expected value." });
            }
        }
4. <span data-ttu-id="dff1e-307">Reimplante o projeto ToDoListDataAPI no Serviço de Aplicativo do Azure.</span><span class="sxs-lookup"><span data-stu-id="dff1e-307">Redeploy the ToDoListDataAPI project to Azure App Service.</span></span>
5. <span data-ttu-id="dff1e-308">No navegador, vá para a URL HTTPS do aplicativo Web de front-end do AngularJS e, na home page, clique na guia **Lista de Tarefas Pendentes** .</span><span class="sxs-lookup"><span data-stu-id="dff1e-308">In your browser, go to the AngularJS front end web app's HTTPS URL, and in the home page click the **To Do List** tab.</span></span>
   
    <span data-ttu-id="dff1e-309">O aplicativo não funciona porque as chamadas ao back-end estão falhando.</span><span class="sxs-lookup"><span data-stu-id="dff1e-309">The application doesn't work because calls to the back end are failing.</span></span> <span data-ttu-id="dff1e-310">O novo código está verificando o appid e o objectidentifier reais, mas ainda não tem os valores corretos em relação aos quais deve verificá-los.</span><span class="sxs-lookup"><span data-stu-id="dff1e-310">The new code is checking actual appid and objectidentifier but it doesn't yet have the correct values to check them against.</span></span> <span data-ttu-id="dff1e-311">O Console de Ferramentas de Desenvolvedor do navegador relata que o servidor está retornando um erro HTTP 401.</span><span class="sxs-lookup"><span data-stu-id="dff1e-311">The browser Developer Tools Console reports that the server is returning an HTTP 401 error.</span></span>
   
    ![Erro no Console de Ferramentas de Desenvolvedor](./media/app-service-api-dotnet-service-principal-auth/webapperror.png)
   
    <span data-ttu-id="dff1e-313">Nas etapas a seguir, você configura os valores esperados.</span><span class="sxs-lookup"><span data-stu-id="dff1e-313">In the following steps you configure the expected values.</span></span>
6. <span data-ttu-id="dff1e-314">Usando o PowerShell do Azure AD, obtenha o valor da entidade de serviço do aplicativo do Azure AD que você criou para o projeto TodoListWebApp.</span><span class="sxs-lookup"><span data-stu-id="dff1e-314">Using Azure AD PowerShell, get the value of the service principal for the Azure AD application that you created for the TodoListWebApp project.</span></span>
   
    <span data-ttu-id="dff1e-315">a.</span><span class="sxs-lookup"><span data-stu-id="dff1e-315">a.</span></span> <span data-ttu-id="dff1e-316">Para obter instruções sobre como instalar o Azure PowerShell e conectar-se à sua assinatura, confira [Usar o Azure PowerShell com o Azure Resource Manager](../powershell-azure-resource-manager.md).</span><span class="sxs-lookup"><span data-stu-id="dff1e-316">For instructions on how to install Azure PowerShell and connect to your subscription, see [Using Azure PowerShell with Azure Resource Manager](../powershell-azure-resource-manager.md).</span></span>
   
    <span data-ttu-id="dff1e-317">b.</span><span class="sxs-lookup"><span data-stu-id="dff1e-317">b.</span></span> <span data-ttu-id="dff1e-318">Para obter uma lista de entidades de serviço, execute o comando `Login-AzureRmAccount` e, em seguida, o comando `Get-AzureRmADServicePrincipal`.</span><span class="sxs-lookup"><span data-stu-id="dff1e-318">To get a list of service principals, execute the `Login-AzureRmAccount` command and then the `Get-AzureRmADServicePrincipal` command.</span></span>
   
    <span data-ttu-id="dff1e-319">c.</span><span class="sxs-lookup"><span data-stu-id="dff1e-319">c.</span></span> <span data-ttu-id="dff1e-320">Localize o objectid da entidade de serviço do aplicativo TodoListAPI e salve-o em um local do qual você possa copiá-lo mais tarde.</span><span class="sxs-lookup"><span data-stu-id="dff1e-320">Find the objectid for the service principal of the TodoListAPI application, and save it in a location you can copy from later.</span></span>
7. <span data-ttu-id="dff1e-321">No portal do Azure, navegue até a folha do aplicativo de API no qual o projeto ToDoListDataAPI foi implantado.</span><span class="sxs-lookup"><span data-stu-id="dff1e-321">In the Azure portal, navigate to the API app blade for the API app that you deployed the ToDoListDataAPI project to.</span></span>
8. <span data-ttu-id="dff1e-322">Clique em **Configurações > Configurações do Aplicativo**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-322">Click **Settings > Application settings**.</span></span>
9. <span data-ttu-id="dff1e-323">Na seção **Configurações do aplicativo** , adicione as seguintes chaves e valores:</span><span class="sxs-lookup"><span data-stu-id="dff1e-323">In the **App settings** section, add the following keys and values:</span></span>
   
   | <span data-ttu-id="dff1e-324">**Chave**</span><span class="sxs-lookup"><span data-stu-id="dff1e-324">**Key**</span></span> | <span data-ttu-id="dff1e-325">todo:TrustedCallerServicePrincipalId</span><span class="sxs-lookup"><span data-stu-id="dff1e-325">todo:TrustedCallerServicePrincipalId</span></span> |
   | --- | --- |
   | <span data-ttu-id="dff1e-326">**Valor**</span><span class="sxs-lookup"><span data-stu-id="dff1e-326">**Value**</span></span> |<span data-ttu-id="dff1e-327">Id da entidade de serviço do aplicativo de chamada</span><span class="sxs-lookup"><span data-stu-id="dff1e-327">Service principal id of calling application</span></span> |
   | <span data-ttu-id="dff1e-328">**Exemplo**</span><span class="sxs-lookup"><span data-stu-id="dff1e-328">**Example**</span></span> |<span data-ttu-id="dff1e-329">4f4a94a4-6f0d-4072-4f4a94a4-6f0d-4072</span><span class="sxs-lookup"><span data-stu-id="dff1e-329">4f4a94a4-6f0d-4072-4f4a94a4-6f0d-4072</span></span> |
   
   | <span data-ttu-id="dff1e-330">**Chave**</span><span class="sxs-lookup"><span data-stu-id="dff1e-330">**Key**</span></span> | <span data-ttu-id="dff1e-331">todo:TrustedCallerClientId</span><span class="sxs-lookup"><span data-stu-id="dff1e-331">todo:TrustedCallerClientId</span></span> |
   | --- | --- |
   | <span data-ttu-id="dff1e-332">**Valor**</span><span class="sxs-lookup"><span data-stu-id="dff1e-332">**Value**</span></span> |<span data-ttu-id="dff1e-333">ID do cliente do aplicativo de chamada ‒ copiada do aplicativo Azure AD TodoListAPI</span><span class="sxs-lookup"><span data-stu-id="dff1e-333">Client ID of calling application - copied from the TodoListAPI Azure AD application</span></span> |
   | <span data-ttu-id="dff1e-334">**Exemplo**</span><span class="sxs-lookup"><span data-stu-id="dff1e-334">**Example**</span></span> |<span data-ttu-id="dff1e-335">960adec2-b74a-484a-960adec2-b74a-484a</span><span class="sxs-lookup"><span data-stu-id="dff1e-335">960adec2-b74a-484a-960adec2-b74a-484a</span></span> |
10. <span data-ttu-id="dff1e-336">Clique em **Salvar**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-336">Click **Save**.</span></span>
    
     ![Clique em Salvar](./media/app-service-api-dotnet-service-principal-auth/trustedcaller.png)
11. <span data-ttu-id="dff1e-338">No navegador, retorne à URL do aplicativo Web e, na home page, clique na guia **Lista de Tarefas Pendentes** .</span><span class="sxs-lookup"><span data-stu-id="dff1e-338">In your browser, return to the web app's URL, and in the home page click the **To Do List** tab.</span></span>
    
     <span data-ttu-id="dff1e-339">Desta vez, o aplicativo funciona como esperado, pois a ID do aplicativo chamador confiável e a ID da entidade de serviço são os valores esperados.</span><span class="sxs-lookup"><span data-stu-id="dff1e-339">This time the application works as expected because the trusted caller app ID and service principal ID are the expected values.</span></span>
    
     ![A página Lista de tarefas pendentes](./media/app-service-api-dotnet-service-principal-auth/mvchome.png)

## <a name="building-the-projects-from-scratch"></a><span data-ttu-id="dff1e-341">Como criar os projetos do zero</span><span class="sxs-lookup"><span data-stu-id="dff1e-341">Building the projects from scratch</span></span>
<span data-ttu-id="dff1e-342">Os dois projetos de API Web foram criados usando o modelo de projeto **Aplicativo de API do Azure** e substituindo o controlador de Valores padrão por um controlador ToDoList.</span><span class="sxs-lookup"><span data-stu-id="dff1e-342">The two Web API projects were created by using the **Azure API App** project template and replacing the default Values controller with a ToDoList controller.</span></span> <span data-ttu-id="dff1e-343">Para adquirir tokens de entidade de serviço do Azure AD no projeto ToDoListAPI, foi instalado o pacote NuGet da [ADAL (Biblioteca de Autenticação do Active Directory) para .NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory/) .</span><span class="sxs-lookup"><span data-stu-id="dff1e-343">For acquiring Azure AD service principal tokens in the ToDoListAPI project, the [Active Directory Authentication Library (ADAL) for .NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory/) NuGet package was installed.</span></span>

<span data-ttu-id="dff1e-344">Para obter informações sobre como criar um aplicativo de página única do AngularJS com um back-end de API Web como ToDoListAngular, confira [Laboratório prático: criar um SPA (aplicativo de página única) com a API Web ASP.NET e Angular.js](http://www.asp.net/web-api/overview/getting-started-with-aspnet-web-api/build-a-single-page-application-spa-with-aspnet-web-api-and-angularjs).</span><span class="sxs-lookup"><span data-stu-id="dff1e-344">For information about how to  create an AngularJS single-page application with a Web API back end like ToDoListAngular, see  [Hands On Lab: Build a Single Page Application (SPA) with ASP.NET Web API and Angular.js](http://www.asp.net/web-api/overview/getting-started-with-aspnet-web-api/build-a-single-page-application-spa-with-aspnet-web-api-and-angularjs).</span></span> <span data-ttu-id="dff1e-345">Para obter informações sobre como adicionar código de autenticação do Azure AD, confira [Como proteger aplicativos de página única do AngularJS com o Azure AD](../active-directory/active-directory-devquickstarts-angular.md).</span><span class="sxs-lookup"><span data-stu-id="dff1e-345">For information about how to add Azure AD authentication code, see [Securing AngularJS Single Page Apps with Azure AD](../active-directory/active-directory-devquickstarts-angular.md).</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="dff1e-346">Solução de problemas</span><span class="sxs-lookup"><span data-stu-id="dff1e-346">Troubleshooting</span></span>
[!INCLUDE [troubleshooting](../../includes/app-service-api-auth-troubleshooting.md)]

* <span data-ttu-id="dff1e-347">Não confunda ToDoListAPI (camada intermediária) e ToDoListDataAPI (camada de dados).</span><span class="sxs-lookup"><span data-stu-id="dff1e-347">Make sure that you don't confuse ToDoListAPI (middle tier) and ToDoListDataAPI (data tier).</span></span> <span data-ttu-id="dff1e-348">Por exemplo, neste tutorial, você pode adicionar autenticação ao aplicativo de API de camada de dados, **mas a chave do aplicativo deve vir do aplicativo Azure AD que você criou para o aplicativo de API de camada intermediária**.</span><span class="sxs-lookup"><span data-stu-id="dff1e-348">For example, in this tutorial you add authentication to the data tier API app, **but the app key must come from the Azure AD application that you created for the middle tier API app**.</span></span>

## <a name="next-steps"></a><span data-ttu-id="dff1e-349">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="dff1e-349">Next steps</span></span>
<span data-ttu-id="dff1e-350">Este é o último tutorial da série de Aplicativos de API.</span><span class="sxs-lookup"><span data-stu-id="dff1e-350">This is the last tutorial in the API Apps series.</span></span> 

<span data-ttu-id="dff1e-351">Para saber mais sobre o Active Directory do Azure, confira os recursos a seguir.</span><span class="sxs-lookup"><span data-stu-id="dff1e-351">For more information about Azure Active Directory, see the following resources.</span></span>

* [<span data-ttu-id="dff1e-352">Guia dos desenvolvedores do AD do Azure</span><span class="sxs-lookup"><span data-stu-id="dff1e-352">Azure AD developers' guide</span></span>](http://aka.ms/aaddev)
* [<span data-ttu-id="dff1e-353">Cenários do AD do Azure</span><span class="sxs-lookup"><span data-stu-id="dff1e-353">Azure AD scenarios</span></span>](http://aka.ms/aadscenarios)
* [<span data-ttu-id="dff1e-354">Exemplos do AD do Azure</span><span class="sxs-lookup"><span data-stu-id="dff1e-354">Azure AD samples</span></span>](http://aka.ms/aadsamples)
  
    <span data-ttu-id="dff1e-355">[WebApp-WebAPI-OAuth2-AppIdentity-DotNet](http://github.com/AzureADSamples/WebApp-WebAPI-OAuth2-AppIdentity-DotNet) é semelhante ao que é mostrado neste tutorial, mas sem usar a autenticação do Serviço de Aplicativo.</span><span class="sxs-lookup"><span data-stu-id="dff1e-355">The [WebApp-WebAPI-OAuth2-AppIdentity-DotNet](http://github.com/AzureADSamples/WebApp-WebAPI-OAuth2-AppIdentity-DotNet) sample is similar to what is shown in this tutorial, but without using App Service authentication.</span></span>

<span data-ttu-id="dff1e-356">Para saber mais sobre outras maneiras de implantar projetos do Visual Studio em aplicativos de API, usando o Visual Studio ou [automatizando a implantação](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) de um [sistema de controle do código-fonte](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control), confira [Como implantar um aplicativo do Serviço de Aplicativo do Azure](../app-service-web/web-sites-deploy.md).</span><span class="sxs-lookup"><span data-stu-id="dff1e-356">For information about other ways to deploy Visual Studio projects to API apps, by using Visual Studio or by [automating deployment](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) from a [source control system](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control), see [How to deploy an Azure App Service app](../app-service-web/web-sites-deploy.md).</span></span>

