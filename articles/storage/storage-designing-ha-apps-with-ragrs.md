---
title: "Criando aplicativos altamente disponíveis usando o Armazenamento com Redundância Geográfica do Azure com Acesso de Leitura (RA-GRS) | Microsoft Docs"
description: "Como usar o armazenamento RA-GRS do Azure para projetar um aplicativo altamente disponível que seja flexível o suficiente para lidar com interrupções."
services: storage
documentationcenter: .net
author: robinsh
manager: timlt
editor: tysonn
ms.assetid: 8f040b0f-8926-4831-ac07-79f646f31926
ms.service: storage
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: dotnet
ms.topic: article
ms.date: 1/19/2017
ms.author: robinsh
ms.openlocfilehash: adc7e23d8c9f869f2951490020e3d0f1a2b2e81c
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/03/2017
---
# <a name="designing-highly-available-applications-using-ra-grs"></a><span data-ttu-id="924e3-103">Criando aplicativos altamente disponíveis usando RA-GRS</span><span class="sxs-lookup"><span data-stu-id="924e3-103">Designing Highly Available Applications using RA-GRS</span></span>

<span data-ttu-id="924e3-104">Um recurso comum das infraestruturas de nuvem é que elas fornecem uma plataforma altamente disponível para hospedar aplicativos.</span><span class="sxs-lookup"><span data-stu-id="924e3-104">A common feature of cloud-based infrastructures is that they provide a highly available platform for hosting applications.</span></span> <span data-ttu-id="924e3-105">Os desenvolvedores de aplicativos baseados em nuvem devem considerar cuidadosamente como aproveitar essa plataforma para fornecer aplicativos altamente disponíveis aos usuários.</span><span class="sxs-lookup"><span data-stu-id="924e3-105">Developers of cloud-based applications must consider carefully how to leverage this platform to deliver highly available applications to their users.</span></span> <span data-ttu-id="924e3-106">Este artigo aborda especificamente como os desenvolvedores podem usar o Armazenamento do Azure com Redundância de Área Geográfica com Acesso de Leitura (RA-GRS) para tornar seus aplicativos mais disponíveis.</span><span class="sxs-lookup"><span data-stu-id="924e3-106">This article focuses specifically on how developers can use the Azure Storage Read Access Geo Redundant Storage (RA-GRS) to make their applications more available.</span></span>

<span data-ttu-id="924e3-107">Há quatro opções de redundância: LRS (armazenamento com redundância local), ZRS (armazenamento com redundância de zona), GRS (armazenamento com redundância geográfica) e RA-GRS (armazenamento com redundância geográfica com acesso de leitura).</span><span class="sxs-lookup"><span data-stu-id="924e3-107">There are four choices for redundancy – LRS (Locally Redundant Storage), ZRS (Zone Redundant Storage), GRS (Geo-Redundant Storage), and RA-GRS (Read Access Geo-Redundant Storage).</span></span> <span data-ttu-id="924e3-108">Vamos discutir GRS e RA-GRS neste artigo.</span><span class="sxs-lookup"><span data-stu-id="924e3-108">We are going to discuss GRS and RA-GRS in this article.</span></span> <span data-ttu-id="924e3-109">Com GRS, três cópias dos dados são mantidas na região primária que você selecionou ao configurar a conta de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="924e3-109">With GRS, three copies of your data are kept in the primary region you selected when setting up the storage account.</span></span> <span data-ttu-id="924e3-110">Três cópias adicionais são mantidas de forma assíncrona em uma região secundária especificada pelo Azure.</span><span class="sxs-lookup"><span data-stu-id="924e3-110">Three additional copies are maintained asynchronously in a secondary region specified by Azure.</span></span> <span data-ttu-id="924e3-111">RA-GRS é o mesmo que GRS, exceto que você tem acesso de leitura à cópia secundária.</span><span class="sxs-lookup"><span data-stu-id="924e3-111">RA-GRS is the same thing as GRS except that you have read access to the secondary copy.</span></span> <span data-ttu-id="924e3-112">Para obter mais informações sobre as diferentes opções de redundância do Armazenamento do Azure, confira [Replicação do Armazenamento do Azure](https://docs.microsoft.com/en-us/azure/storage/storage-redundancy).</span><span class="sxs-lookup"><span data-stu-id="924e3-112">For more information about the different Azure Storage redundancy options, see [Azure Storage replication](https://docs.microsoft.com/en-us/azure/storage/storage-redundancy).</span></span> <span data-ttu-id="924e3-113">O artigo sobre replicação também mostra os emparelhamentos de regiões primárias e secundárias.</span><span class="sxs-lookup"><span data-stu-id="924e3-113">The replication article also shows the pairings of the primary and secondary regions.</span></span>

<span data-ttu-id="924e3-114">Há trechos de código incluídos neste artigo e um link para um exemplo completo no fim, que você pode baixar e executar.</span><span class="sxs-lookup"><span data-stu-id="924e3-114">There are code snippets included in this article, and a link to a complete sample at the end that you can download and run.</span></span>

## <a name="key-features-of-ra-grs"></a><span data-ttu-id="924e3-115">Principais recursos do RA-GRS</span><span class="sxs-lookup"><span data-stu-id="924e3-115">Key features of RA-GRS</span></span>

<span data-ttu-id="924e3-116">Antes de abordarmos como usar o armazenamento RA-GRS, vamos falar sobre suas propriedades e seu comportamento.</span><span class="sxs-lookup"><span data-stu-id="924e3-116">Before we talk about how to use RA-GRS storage, let's talk about its properties and behavior.</span></span>

* <span data-ttu-id="924e3-117">O Armazenamento do Azure mantém uma cópia somente leitura dos dados que você armazena na região primária em uma região secundária; conforme observado anteriormente, o serviço de armazenamento determina o local da região secundária.</span><span class="sxs-lookup"><span data-stu-id="924e3-117">Azure Storage maintains a read-only copy of the data you store in your primary region in a secondary region; as noted above, the storage service determines the location of the secondary region.</span></span>

* <span data-ttu-id="924e3-118">A cópia somente leitura é [eventualmente consistente](https://en.wikipedia.org/wiki/Eventual_consistency) com os dados na região primária.</span><span class="sxs-lookup"><span data-stu-id="924e3-118">The read-only copy is [eventually consistent](https://en.wikipedia.org/wiki/Eventual_consistency) with the data in the primary region.</span></span>

* <span data-ttu-id="924e3-119">Para blobs, tabelas e filas, você pode consultar a região secundária para obter um valor de *Hora da Última Sincronização* que informa quando ocorreu a última replicação da região primária para a secundária.</span><span class="sxs-lookup"><span data-stu-id="924e3-119">For blobs, tables, and queues, you can query the secondary region for a *Last Sync Time* value that tells you when the last replication from the primary to the secondary region occurred.</span></span> <span data-ttu-id="924e3-120">(Não há suporte para isso no Armazenamento de Arquivos do Azure, os quais não têm redundância RA-GRS no momento.)</span><span class="sxs-lookup"><span data-stu-id="924e3-120">(This is not supported for Azure File storage, which doesn't have RA-GRS redundancy at this time.)</span></span>

* <span data-ttu-id="924e3-121">Você pode usar a Biblioteca de Cliente de Armazenamento para interagir com os dados na região primária ou secundária.</span><span class="sxs-lookup"><span data-stu-id="924e3-121">You can use the Storage Client Library to interact with the data in either the primary or secondary region.</span></span> <span data-ttu-id="924e3-122">Você também poderá redirecionar as solicitações de leitura automaticamente para a região secundária se uma solicitação de leitura para a região primária atingir o tempo limite.</span><span class="sxs-lookup"><span data-stu-id="924e3-122">You can also redirect read requests automatically to the secondary region if a read request to the primary region times out.</span></span>

* <span data-ttu-id="924e3-123">Se um grande problema afetar a acessibilidade dos dados na região primária, a equipe do Azure poderá disparar um failover geográfico. Nesse ponto, as entradas DNS que apontam para a região primária serão alteradas para apontar para a região secundária.</span><span class="sxs-lookup"><span data-stu-id="924e3-123">If there is a major issue affecting the accessibility of the data in the primary region, the Azure team may trigger a geo-failover, at which point the DNS entries pointing to the primary region will be changed to point to the secondary region.</span></span>

* <span data-ttu-id="924e3-124">Se ocorrer um failover geográfico, o Azure selecionará um novo local secundário, replicará os dados para esse local e apontará as entradas DNS secundárias para ele.</span><span class="sxs-lookup"><span data-stu-id="924e3-124">If a geo-failover occurs, Azure will select a new secondary location and replicate the data to that location, then point the secondary DNS entries to it.</span></span> <span data-ttu-id="924e3-125">O ponto de extremidade secundário ficará indisponível até que a conta de armazenamento termine a replicação.</span><span class="sxs-lookup"><span data-stu-id="924e3-125">The secondary endpoint will be unavailable until the storage account has finished replicating.</span></span> <span data-ttu-id="924e3-126">Para obter mais informações, confira [O que fazer se ocorrer uma falha de Armazenamento do Azure](https://docs.microsoft.com/en-us/azure/storage/storage-disaster-recovery-guidance).</span><span class="sxs-lookup"><span data-stu-id="924e3-126">For more information, please see [What to do if an Azure Storage outage occurs](https://docs.microsoft.com/en-us/azure/storage/storage-disaster-recovery-guidance).</span></span>

## <a name="application-design-considerations-when-using-ra-grs"></a><span data-ttu-id="924e3-127">Considerações de design de aplicativo ao usar RA-GRS</span><span class="sxs-lookup"><span data-stu-id="924e3-127">Application design considerations when using RA-GRS</span></span>

<span data-ttu-id="924e3-128">A principal finalidade deste artigo é mostrar como criar um aplicativo que continue a funcionar (embora com capacidade limitada) mesmo que ocorra um grande desastre no data center primário.</span><span class="sxs-lookup"><span data-stu-id="924e3-128">The main purpose of this article is to show you how to design an application that will continue to function (albeit in a limited capacity) even in the event of a major disaster at the primary data center.</span></span> <span data-ttu-id="924e3-129">Para isso, você pode fazer com que o aplicativo lide com problemas transitórios ou demorados alternando para leitura da região secundária quando houver um problema e alternando novamente quando a região primária estiver disponível novamente.</span><span class="sxs-lookup"><span data-stu-id="924e3-129">You do this by having your application to handle transient or long-running issues by switching to read from the secondary region while there is a problem, and switching back when the primary region is available again.</span></span>

### <a name="using-eventually-consistent-data"></a><span data-ttu-id="924e3-130">Usando dados eventualmente consistentes</span><span class="sxs-lookup"><span data-stu-id="924e3-130">Using eventually consistent data</span></span>

<span data-ttu-id="924e3-131">Esta solução pressupõe que é aceitável retornar o que poderiam ser dados obsoletos para o aplicativo de chamada.</span><span class="sxs-lookup"><span data-stu-id="924e3-131">This proposed solution assumes that it is okay to return what could be stale data to the calling application.</span></span> <span data-ttu-id="924e3-132">Como os dados secundários são consistentes, é possível que os dados tenham sido gravados no primário, mas a atualização para o secundário não tenha concluído a replicação quando a região primária se tornou inacessível.</span><span class="sxs-lookup"><span data-stu-id="924e3-132">Because the secondary data is eventually consistent, it is possible that the data was written to the primary but the update to the secondary had not finished replicating when the primary region became inaccessible.</span></span>

<span data-ttu-id="924e3-133">Por exemplo, o cliente poderia enviar uma atualização bem-sucedida, e o primário poderia ficar inoperante antes de a atualização ser propagada para o secundário.</span><span class="sxs-lookup"><span data-stu-id="924e3-133">For example, your customer could submit an update that is successful, and then the primary could go down before the update is propagated to the secondary.</span></span> <span data-ttu-id="924e3-134">Nesse caso, se o cliente solicitar a leitura dos dados novamente, receberá os dados obsoletos, em vez dos dados atualizados.</span><span class="sxs-lookup"><span data-stu-id="924e3-134">In this case, if the customer then asks to read the data back, he receives the stale data instead of the updated data.</span></span> <span data-ttu-id="924e3-135">Você deve decidir se isso é aceitável e, nesse caso, como você enviará uma mensagem ao cliente.</span><span class="sxs-lookup"><span data-stu-id="924e3-135">You must decide if this is acceptable, and if so, how you will message the customer.</span></span> <span data-ttu-id="924e3-136">Você verá como verificar a Hora da Última Sincronização nos dados secundários adiante neste artigo para saber se o secundário está atualizado.</span><span class="sxs-lookup"><span data-stu-id="924e3-136">You'll see how to check the Last Sync Time on the secondary data later in this article to see if the secondary is up-to-date.</span></span>

### <a name="handling-services-separately-or-all-together"></a><span data-ttu-id="924e3-137">Tratamento de serviços separadamente ou em conjunto</span><span class="sxs-lookup"><span data-stu-id="924e3-137">Handling services separately or all together</span></span>

<span data-ttu-id="924e3-138">Embora não seja provável, é possível que um serviço se torne indisponível enquanto os outros serviços ainda estão totalmente funcionais.</span><span class="sxs-lookup"><span data-stu-id="924e3-138">While not likely, it is possible for one service to become unavailable while the other services are still fully functional.</span></span> <span data-ttu-id="924e3-139">Você pode lidar com as repetições e o modo somente leitura para cada serviço separadamente (blobs, filas, tabelas) ou pode lidar com as repetições de forma genérica para todos os serviços de armazenamento em conjunto.</span><span class="sxs-lookup"><span data-stu-id="924e3-139">You can handle the retries and read-only mode for each service separately (blobs, queues, tables), or you can handle retries generically for all the storage services together.</span></span>

<span data-ttu-id="924e3-140">Por exemplo, se usar filas e blobs no aplicativo, você poderá optar por incluir código separado para lidar com erros com nova tentativa para cada um desses itens.</span><span class="sxs-lookup"><span data-stu-id="924e3-140">For example, if you use queues and blobs in your application, you may decide to put in separate code to handle retryable errors for each of these.</span></span> <span data-ttu-id="924e3-141">Em seguida, se você receber uma repetição do serviço blob, mas o serviço fila ainda estiver funcionando, somente a parte do aplicativo que lida com os blobs será afetada.</span><span class="sxs-lookup"><span data-stu-id="924e3-141">Then if you get a retry from the blob service, but the queue service is still working, only the part of your application that handles blobs will be impacted.</span></span> <span data-ttu-id="924e3-142">Se você decidir lidar com todas as tentativas de serviço de armazenamento de forma genérica e uma chamada ao serviço blob retornar um erros com nova tentativa, as solicitações para o serviço blob e o serviço fila serão afetadas.</span><span class="sxs-lookup"><span data-stu-id="924e3-142">If you decide to handle all storage service retries generically and a call to the blob service returns a retryable error, then requests to both the blob service and the queue service will be impacted.</span></span>

<span data-ttu-id="924e3-143">Em última análise, isso depende da complexidade do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="924e3-143">Ultimately, this depends on the complexity of your application.</span></span> <span data-ttu-id="924e3-144">Você pode optar por não lidar com as falhas de serviço, mas, em vez disso, redirecionar as solicitações de leitura a todos os serviços de armazenamento para a região secundária e executar o aplicativo no modo somente leitura ao detectar um problema em qualquer serviço de armazenamento na região primária.</span><span class="sxs-lookup"><span data-stu-id="924e3-144">You may decide not to handle the failures by service, but instead to redirect read requests for all storage services to the secondary region and run the application in read-only mode when you detect a problem with any storage service in the primary region.</span></span>

### <a name="other-considerations"></a><span data-ttu-id="924e3-145">Outras considerações</span><span class="sxs-lookup"><span data-stu-id="924e3-145">Other considerations</span></span>

<span data-ttu-id="924e3-146">Essas são as outras considerações que discutiremos no restante deste artigo.</span><span class="sxs-lookup"><span data-stu-id="924e3-146">These are the other considerations we will discuss in the rest of this article.</span></span>

*   <span data-ttu-id="924e3-147">Lidar com repetições de solicitações de leitura usando o padrão de Disjuntor</span><span class="sxs-lookup"><span data-stu-id="924e3-147">Handling retries of read requests using the Circuit Breaker pattern</span></span>

*   <span data-ttu-id="924e3-148">Dados eventualmente consistentes e a Hora da Última Sincronização</span><span class="sxs-lookup"><span data-stu-id="924e3-148">Eventually-consistent data and the Last Sync Time</span></span>

*   <span data-ttu-id="924e3-149">Testando</span><span class="sxs-lookup"><span data-stu-id="924e3-149">Testing</span></span>

## <a name="running-your-application-in-read-only-mode"></a><span data-ttu-id="924e3-150">Executando o aplicativo no modo somente leitura</span><span class="sxs-lookup"><span data-stu-id="924e3-150">Running your application in read-only mode</span></span>

<span data-ttu-id="924e3-151">Para usar o armazenamento de RA-GRS, você deve ser capaz de lidar com as solicitações de leitura com falha e as solicitações de atualização com falha (nesse caso, atualizações significam inserções, atualizações e exclusões).</span><span class="sxs-lookup"><span data-stu-id="924e3-151">To use RA-GRS storage, you must be able to handle both failed read requests and failed update requests (with update in this case meaning inserts, updates, and deletions).</span></span> <span data-ttu-id="924e3-152">Se o data center primário falhar, as solicitações de leitura poderão ser redirecionadas para o data center secundário, mas as solicitações de atualização não podem, pois o secundário é somente leitura.</span><span class="sxs-lookup"><span data-stu-id="924e3-152">If the primary data center fails, read requests can be redirected to the secondary data center, but update requests cannot because the secondary is read only.</span></span> <span data-ttu-id="924e3-153">Por esse motivo, você precisa de uma maneira de executar o aplicativo no modo somente leitura.</span><span class="sxs-lookup"><span data-stu-id="924e3-153">For this reason, you need some way to run your application in read-only mode.</span></span>

<span data-ttu-id="924e3-154">Por exemplo, você pode definir um sinalizador que será verificado antes de enviar solicitações de atualização ao serviço de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="924e3-154">For example, you can set a flag that will be checked before submitting any update requests to the storage service.</span></span> <span data-ttu-id="924e3-155">Quando uma das solicitações de atualização chega, você pode ignorá-la e retornar uma resposta apropriada para o cliente.</span><span class="sxs-lookup"><span data-stu-id="924e3-155">When one of the update requests comes through, you can skip it and return an appropriate response to the customer.</span></span> <span data-ttu-id="924e3-156">Talvez você até ainda queira desabilitar totalmente determinados recursos até que o problema seja resolvido e notificar os usuários de que esses recursos estão temporariamente indisponíveis.</span><span class="sxs-lookup"><span data-stu-id="924e3-156">You may even want to disable certain features altogether until the problem is resolved and notify users that those features are temporarily unavailable.</span></span>

<span data-ttu-id="924e3-157">Se optar por lidar com os erros em cada serviço separadamente, você também precisará lidar com a capacidade de executar o aplicativo no modo somente leitura pelo serviço.</span><span class="sxs-lookup"><span data-stu-id="924e3-157">If you decide to handle errors for each service separately, you will also need to handle the ability to run your application in read-only mode by service.</span></span> <span data-ttu-id="924e3-158">Você pode ter sinalizadores somente leitura para cada serviço que podem ser habilitados e desabilitados e lidar com o sinalizador apropriado nos locais apropriados no código.</span><span class="sxs-lookup"><span data-stu-id="924e3-158">You could have read-only flags for each service that can be enabled and disabled and handle the appropriate flag in the appropriate places in your code.</span></span>

<span data-ttu-id="924e3-159">Ser capaz de executar o aplicativo no modo somente leitura tem outro benefício: a capacidade de garantir funcionalidade limitada durante uma atualização importante do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="924e3-159">Being able to run your application in read-only mode has another side benefit – it gives you the ability to ensure limited functionality during a major application upgrade.</span></span> <span data-ttu-id="924e3-160">Você pode disparar o aplicativo para ser executado no modo somente leitura e apontar para o data center secundário, garantindo que ninguém acessa os dados na região primária enquanto você faz atualizações.</span><span class="sxs-lookup"><span data-stu-id="924e3-160">You can trigger your application to run in read-only mode and point to the secondary data center, ensuring nobody is accessing the data in the primary region while you're making upgrades.</span></span>

## <a name="handling-updates-when-running-in-read-only-mode"></a><span data-ttu-id="924e3-161">Tratamento de atualizações ao executar no modo somente leitura</span><span class="sxs-lookup"><span data-stu-id="924e3-161">Handling updates when running in read-only mode</span></span>

<span data-ttu-id="924e3-162">Há várias maneiras de lidar com solicitações de atualização durante a execução no modo somente leitura.</span><span class="sxs-lookup"><span data-stu-id="924e3-162">There are many ways to handle update requests when running in read-only mode.</span></span> <span data-ttu-id="924e3-163">Não abordaremos isso de forma abrangente, mas, em geral, há alguns padrões a serem considerados.</span><span class="sxs-lookup"><span data-stu-id="924e3-163">We won't cover this comprehensively, but generally, there are a couple of patterns that you consider.</span></span>

1.  <span data-ttu-id="924e3-164">Você pode responder ao usuário e informar que não está aceitando atualizações.</span><span class="sxs-lookup"><span data-stu-id="924e3-164">You can respond to your user and tell them you are not currently accepting updates.</span></span> <span data-ttu-id="924e3-165">Por exemplo, um sistema de gerenciamento de contatos pode habilitar os clientes a acessar informações de contato, mas não fazer atualizações.</span><span class="sxs-lookup"><span data-stu-id="924e3-165">For example, a contact management system could enable customers to access contact information but not make updates.</span></span>

2.  <span data-ttu-id="924e3-166">Você pode enfileirar as atualizações em outra região.</span><span class="sxs-lookup"><span data-stu-id="924e3-166">You can enqueue your updates in another region.</span></span> <span data-ttu-id="924e3-167">Nesse caso, você gravaria as solicitações de atualização pendentes em uma fila em uma região diferente e teria uma maneira de processar essas solicitações depois que o data center primário ficasse online novamente.</span><span class="sxs-lookup"><span data-stu-id="924e3-167">In this case, you would write your pending update requests to a queue in a different region, and then have a way to process those requests after the primary data center comes online again.</span></span> <span data-ttu-id="924e3-168">Nesse cenário, você deve informar ao cliente que a atualização solicitada está na fila para processamento posterior.</span><span class="sxs-lookup"><span data-stu-id="924e3-168">In this scenario, you should let the customer know that the update requested is queued for later processing.</span></span>

3.  <span data-ttu-id="924e3-169">Você pode gravar as atualizações em uma conta de armazenamento em outra região.</span><span class="sxs-lookup"><span data-stu-id="924e3-169">You can write your updates to a storage account in another region.</span></span> <span data-ttu-id="924e3-170">Em seguida, quando o data center primário ficar online novamente, você poderá ter uma maneira de mesclar essas atualizações nos dados principais, dependendo da estrutura dos dados.</span><span class="sxs-lookup"><span data-stu-id="924e3-170">Then when the primary data center comes back online, you can have a way to merge those updates into the primary data, depending on the structure of the data.</span></span> <span data-ttu-id="924e3-171">Por exemplo, se estiver criando arquivos separados com um carimbo de data/hora no nome, você poderá copiar esses arquivos de volta para a região primária.</span><span class="sxs-lookup"><span data-stu-id="924e3-171">For example, if you are creating separate files with a date/time stamp in the name, you can copy those files back to the primary region.</span></span> <span data-ttu-id="924e3-172">Isso funciona para algumas cargas de trabalho, como dados de log e iOT.</span><span class="sxs-lookup"><span data-stu-id="924e3-172">This works for some workloads such as logging and iOT data.</span></span>

## <a name="handling-retries"></a><span data-ttu-id="924e3-173">Lidar com repetições</span><span class="sxs-lookup"><span data-stu-id="924e3-173">Handling retries</span></span>

<span data-ttu-id="924e3-174">Como saber quais são os erros com nova tentativa?</span><span class="sxs-lookup"><span data-stu-id="924e3-174">How do you know which errors are retryable?</span></span> <span data-ttu-id="924e3-175">Isso é determinado pela biblioteca de cliente de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="924e3-175">This is determined by the storage client library.</span></span> <span data-ttu-id="924e3-176">Por exemplo, um erro 404 (recurso não encontrado) não é um erro com nova tentativa, pois isso provavelmente não resultará em sucesso.</span><span class="sxs-lookup"><span data-stu-id="924e3-176">For example, a 404 error (resource not found) is not retryable because retrying it is not likely to result in success.</span></span> <span data-ttu-id="924e3-177">Por outro lado, um erro 500 é um erro com nova tentativa, pois ele é um erro de servidor e pode ser simplesmente um problema temporário.</span><span class="sxs-lookup"><span data-stu-id="924e3-177">On the other hand, a 500 error is retryable because it is a server error, and it may simply be a transient issue.</span></span> <span data-ttu-id="924e3-178">Para obter mais detalhes, confira [abrir o código-fonte para a classe ExponentialRetry](https://github.com/Azure/azure-storage-net/blob/87b84b3d5ee884c7adc10e494e2c7060956515d0/Lib/Common/RetryPolicies/ExponentialRetry.cs) na biblioteca de cliente de armazenamento do .NET.</span><span class="sxs-lookup"><span data-stu-id="924e3-178">For more details, check out the [open source code for the ExponentialRetry class](https://github.com/Azure/azure-storage-net/blob/87b84b3d5ee884c7adc10e494e2c7060956515d0/Lib/Common/RetryPolicies/ExponentialRetry.cs) in the .NET storage client library.</span></span> <span data-ttu-id="924e3-179">(Procure o método ShouldRetry.)</span><span class="sxs-lookup"><span data-stu-id="924e3-179">(Look for the ShouldRetry method.)</span></span>

### <a name="read-requests"></a><span data-ttu-id="924e3-180">Solicitações de leitura</span><span class="sxs-lookup"><span data-stu-id="924e3-180">Read requests</span></span>

<span data-ttu-id="924e3-181">Solicitações de leitura poderão ser redirecionadas para o armazenamento secundário, se houver um problema no armazenamento primário.</span><span class="sxs-lookup"><span data-stu-id="924e3-181">Read requests can be redirected to secondary storage if there is a problem with primary storage.</span></span> <span data-ttu-id="924e3-182">Conforme observado acima em [Usando dados eventualmente consistentes](#using-eventually-consistent-data), deve ser aceitável que o aplicativo potencialmente leia dados obsoletos.</span><span class="sxs-lookup"><span data-stu-id="924e3-182">As noted above in [Using Eventually Consistent Data](#using-eventually-consistent-data), it must be acceptable for your application to potentially read stale data.</span></span> <span data-ttu-id="924e3-183">Se estiver usando a biblioteca de cliente de armazenamento para acessar dados de RA-GRS, você poderá especificar o comportamento de nova tentativa de uma solicitação de leitura definindo um valor para a propriedade **LocationMode** como um dos seguintes:</span><span class="sxs-lookup"><span data-stu-id="924e3-183">If you are using the storage client library to access RA-GRS data, you can specify the retry behavior of a read request by setting a value for the **LocationMode** property to one of the following:</span></span>

*   <span data-ttu-id="924e3-184">**PrimaryOnly** (o padrão)</span><span class="sxs-lookup"><span data-stu-id="924e3-184">**PrimaryOnly** (the default)</span></span>

*   <span data-ttu-id="924e3-185">**PrimaryThenSecondary**</span><span class="sxs-lookup"><span data-stu-id="924e3-185">**PrimaryThenSecondary**</span></span>

*   <span data-ttu-id="924e3-186">**SecondaryOnly**</span><span class="sxs-lookup"><span data-stu-id="924e3-186">**SecondaryOnly**</span></span>

*   <span data-ttu-id="924e3-187">**SecondaryThenPrimary**</span><span class="sxs-lookup"><span data-stu-id="924e3-187">**SecondaryThenPrimary**</span></span>

<span data-ttu-id="924e3-188">Quando você define **LocationMode** como **PrimaryThenSecondary**, se a solicitação de leitura inicial para o ponto de extremidade primário falhar com um erro com nova tentativa, o cliente fará automaticamente outra solicitação de leitura para o ponto de extremidade secundário.</span><span class="sxs-lookup"><span data-stu-id="924e3-188">When you set the **LocationMode** to **PrimaryThenSecondary**, if the initial read request to the primary endpoint fails with a retryable error, the client automatically makes another read request to the secondary endpoint.</span></span> <span data-ttu-id="924e3-189">Se o erro for um tempo limite do servidor, o cliente terá que aguardar até que o tempo limite expire antes de receber um erro com nova tentativa do serviço.</span><span class="sxs-lookup"><span data-stu-id="924e3-189">If the error is a server timeout, then the client will have to wait for the timeout to expire before it receives a retryable error from the service.</span></span>

<span data-ttu-id="924e3-190">Existem basicamente dois cenários a serem considerados ao decidir como reagir a um erro com nova tentativa:</span><span class="sxs-lookup"><span data-stu-id="924e3-190">There are basically two scenarios to consider when you are deciding how to respond to a retryable error:</span></span>

*   <span data-ttu-id="924e3-191">Esse é um problema isolado, e solicitações subsequentes para o ponto de extremidade primário não retornarão um erro com nova tentativa.</span><span class="sxs-lookup"><span data-stu-id="924e3-191">This is an isolated problem and subsequent requests to the primary endpoint will not return a retryable error.</span></span> <span data-ttu-id="924e3-192">Um exemplo é quando há um erro de rede temporário.</span><span class="sxs-lookup"><span data-stu-id="924e3-192">An example of where this might happen is when there is a transient network error.</span></span>

    <span data-ttu-id="924e3-193">Nesse cenário, não há uma redução de desempenho significativa quando **LocationMode** é definido como **PrimaryThenSecondary**, pois isso ocorre apenas raramente.</span><span class="sxs-lookup"><span data-stu-id="924e3-193">In this scenario, there is no significant performance penalty in having **LocationMode** set to **PrimaryThenSecondary** as this only happens infrequently.</span></span>

*   <span data-ttu-id="924e3-194">Esse é um problema pelo menos para um dos serviços de armazenamento na região primária, e todas as solicitações subsequentes desse serviço na região primária provavelmente retornarão erros com nova tentativa por um período de tempo.</span><span class="sxs-lookup"><span data-stu-id="924e3-194">This is a problem with at least one of the storage services in the primary region and all subsequent requests to that service in the primary region are likely to return retryable errors for a period of time.</span></span> <span data-ttu-id="924e3-195">Um exemplo disso é se a região primária está totalmente inacessível.</span><span class="sxs-lookup"><span data-stu-id="924e3-195">An example of this is if the primary region is completely inaccessible.</span></span>

    <span data-ttu-id="924e3-196">Nesse cenário, há uma redução de desempenho porque todas as solicitações de leitura tentarão primeiro o ponto de extremidade primário, aguardarão até que o tempo limite expire e alternarão para o ponto de extremidade secundário.</span><span class="sxs-lookup"><span data-stu-id="924e3-196">In this scenario, there is a performance penalty because all your read requests will try the primary endpoint first, wait for the timeout to expire, then switch to the secondary endpoint.</span></span>

<span data-ttu-id="924e3-197">Nesses cenários, você deve identificar que há um problema contínuo no ponto de extremidade primário e enviar todas as solicitações de leitura diretamente para o ponto de extremidade secundário, definindo a propriedade **LocationMode** como **SecondaryOnly**.</span><span class="sxs-lookup"><span data-stu-id="924e3-197">For these scenarios, you should identify that there is an ongoing issue with the primary endpoint and send all read requests directly to the secondary endpoint by setting the **LocationMode** property to **SecondaryOnly**.</span></span> <span data-ttu-id="924e3-198">Nesse momento, você também deve alterar o aplicativo para que seja executado no modo somente leitura.</span><span class="sxs-lookup"><span data-stu-id="924e3-198">At this time, you should also change the application to run in read-only mode.</span></span> <span data-ttu-id="924e3-199">Essa abordagem é conhecida como [Padrão de Disjuntor](https://msdn.microsoft.com/library/dn589784.aspx).</span><span class="sxs-lookup"><span data-stu-id="924e3-199">This approach is known as the [Circuit Breaker Pattern](https://msdn.microsoft.com/library/dn589784.aspx).</span></span>

### <a name="update-requests"></a><span data-ttu-id="924e3-200">Solicitações de atualização</span><span class="sxs-lookup"><span data-stu-id="924e3-200">Update requests</span></span>

<span data-ttu-id="924e3-201">O padrão de Disjuntor também pode ser aplicado a solicitações de atualização.</span><span class="sxs-lookup"><span data-stu-id="924e3-201">The Circuit Breaker pattern can also be applied to update requests.</span></span> <span data-ttu-id="924e3-202">No entanto, as solicitações de atualização não poderão ser redirecionadas para o armazenamento secundário, que é somente leitura.</span><span class="sxs-lookup"><span data-stu-id="924e3-202">However, update requests cannot be redirected to secondary storage, which is read-only.</span></span> <span data-ttu-id="924e3-203">Para essas solicitações, você deve deixar a propriedade **LocationMode** definida como **PrimaryOnly** (o padrão).</span><span class="sxs-lookup"><span data-stu-id="924e3-203">For these requests, you should leave the **LocationMode** property set to **PrimaryOnly** (the default).</span></span> <span data-ttu-id="924e3-204">Para lidar com esses erros, você pode aplicar uma métrica para essas solicitações (por exemplo, 10 falhas contínuas) e, quando o limite for atingido, alternar o aplicativo para o modo somente leitura.</span><span class="sxs-lookup"><span data-stu-id="924e3-204">To handle these errors, you can apply a metric to these requests – such as 10 failures in a row – and when your threshold is met, switch the application into read-only mode.</span></span> <span data-ttu-id="924e3-205">Você pode usar os mesmos métodos para retornar para o modo de atualização que são descritos abaixo na seção seguinte sobre o padrão de Disjuntor.</span><span class="sxs-lookup"><span data-stu-id="924e3-205">You can use the same methods for returning to update mode as those described below in the next section about the Circuit Breaker pattern.</span></span>

## <a name="circuit-breaker-pattern"></a><span data-ttu-id="924e3-206">Padrão de Disjuntor</span><span class="sxs-lookup"><span data-stu-id="924e3-206">Circuit Breaker pattern</span></span>

<span data-ttu-id="924e3-207">Usar o padrão de Disjuntor no aplicativo pode impedi-lo de repetir uma operação que provavelmente falhará repetidas vezes.</span><span class="sxs-lookup"><span data-stu-id="924e3-207">Using the Circuit Breaker pattern in your application can prevent it from retrying an operation that is likely to fail repeatedly.</span></span> <span data-ttu-id="924e3-208">Ele permite que o aplicativo continue a ser executado em vez de gastar tempo enquanto a operação é repetida exponencialmente.</span><span class="sxs-lookup"><span data-stu-id="924e3-208">It allows the application to continue to run rather than taking up time while the operation is retried exponentially.</span></span> <span data-ttu-id="924e3-209">Ele também detecta quando a falha é corrigida e, nesse momento, o aplicativo pode tentar a operação novamente.</span><span class="sxs-lookup"><span data-stu-id="924e3-209">It also detects when the fault has been fixed, at which time the application can try the operation again.</span></span>

### <a name="how-to-implement-the-circuit-breaker-pattern"></a><span data-ttu-id="924e3-210">Como implementar o padrão de disjuntor</span><span class="sxs-lookup"><span data-stu-id="924e3-210">How to implement the circuit breaker pattern</span></span>

<span data-ttu-id="924e3-211">Para identificar um problema contínuo em um ponto de extremidade primário, você pode monitorar com que frequência o cliente encontra erros com nova tentativa.</span><span class="sxs-lookup"><span data-stu-id="924e3-211">To identify that there is an ongoing problem with a primary endpoint, you can monitor how frequently the client encounters retryable errors.</span></span> <span data-ttu-id="924e3-212">Como cada caso é diferente, você precisa decidir sobre o limite que deseja usar para a decisão de alternar para o ponto de extremidade secundário e executar o aplicativo no modo somente leitura.</span><span class="sxs-lookup"><span data-stu-id="924e3-212">Because each case is different, you have to decide on the threshold you want to use for the decision to switch to the secondary endpoint and run the application in read-only mode.</span></span> <span data-ttu-id="924e3-213">Por exemplo, você poderá decidir executar a mudança se houver 10 falhas contínuas sem sucesso.</span><span class="sxs-lookup"><span data-stu-id="924e3-213">For example, you could decide to perform the switch if there are 10 failures in a row with no successes.</span></span> <span data-ttu-id="924e3-214">Outro exemplo é alternar se 90% das solicitações em um período de dois minutos falharem.</span><span class="sxs-lookup"><span data-stu-id="924e3-214">Another example is to switch if 90% of the requests in a 2-minute period fail.</span></span>

<span data-ttu-id="924e3-215">Para o primeiro cenário, você pode simplesmente manter uma contagem de falhas e, se houver êxito antes de atingir o máximo, definir a contagem como zero.</span><span class="sxs-lookup"><span data-stu-id="924e3-215">For the first scenario, you can simply keep a count of the failures, and if there is a success before reaching the maximum, set the count back to zero.</span></span> <span data-ttu-id="924e3-216">Para o segundo cenário, uma maneira de implementá-lo é usar o objeto MemoryCache (no .NET).</span><span class="sxs-lookup"><span data-stu-id="924e3-216">For the second scenario, one way to implement it is to use the MemoryCache object (in .NET).</span></span> <span data-ttu-id="924e3-217">Para cada solicitação, adicione um CacheItem no cache, defina o valor para sucesso (1) ou falha (0) e defina o tempo de expiração de dois minutos a partir de agora (ou a restrição de tempo que desejar).</span><span class="sxs-lookup"><span data-stu-id="924e3-217">For each request, add a CacheItem to the cache, set the value to success (1) or fail (0), and set the expiration time to 2 minutes from now (or whatever your time constraint is).</span></span> <span data-ttu-id="924e3-218">Quando o tempo de expiração de uma entrada for atingido, a entrada será removida automaticamente.</span><span class="sxs-lookup"><span data-stu-id="924e3-218">When an entry's expiration time is reached, the entry is automatically removed.</span></span> <span data-ttu-id="924e3-219">Isso lhe dará uma janela de dois minutos sem interrupção.</span><span class="sxs-lookup"><span data-stu-id="924e3-219">This will give you a rolling 2-minute window.</span></span> <span data-ttu-id="924e3-220">Sempre que faz uma solicitação ao serviço de armazenamento, primeiro você usa uma consulta Linq no objeto MemoryCache para calcular a porcentagem de êxitos somando os valores e dividindo pela contagem.</span><span class="sxs-lookup"><span data-stu-id="924e3-220">Each time you make a request to the storage service, you first use a Linq query across the MemoryCache object to calculate the percent success by summing the values and dividing by the count.</span></span> <span data-ttu-id="924e3-221">Quando a porcentagem de êxitos ficar abaixo de determinado limite (como 10%), defina a propriedade **LocationMode** para solicitações de leitura como **SecondaryOnly** e alterne o aplicativo para o modo somente leitura antes de continuar.</span><span class="sxs-lookup"><span data-stu-id="924e3-221">When the percent success drops below some threshold (such as 10%), set the **LocationMode** property for read requests to **SecondaryOnly** and switch the application into read-only mode before continuing.</span></span>

<span data-ttu-id="924e3-222">O limite de erros usado para determinar quando alternar pode variar dependendo do serviço no aplicativo. Portanto, você deve considerar torná-los parâmetros configuráveis.</span><span class="sxs-lookup"><span data-stu-id="924e3-222">The threshold of errors used to determine when to make the switch may vary from service to service in your application, so you should consider making them configurable parameters.</span></span> <span data-ttu-id="924e3-223">Esse também é o momento para decidir se erros com nova tentativa de cada serviço devem ser tratados separadamente ou em conjunto, conforme discutido anteriormente.</span><span class="sxs-lookup"><span data-stu-id="924e3-223">This is also where you decide to handle retryable errors from each service separately or as one, as discussed previously.</span></span>

<span data-ttu-id="924e3-224">Outra consideração é como lidar com várias instâncias de um aplicativo e o que fazer ao detectar erros com nova tentativa em cada instância.</span><span class="sxs-lookup"><span data-stu-id="924e3-224">Another consideration is how to handle multiple instances of an application, and what to do when you detect retryable errors in each instance.</span></span> <span data-ttu-id="924e3-225">Por exemplo, você pode ter 20 VMs em execução com o mesmo aplicativo carregado.</span><span class="sxs-lookup"><span data-stu-id="924e3-225">For example, you may have 20 VMs running with the same application loaded.</span></span> <span data-ttu-id="924e3-226">Você lida com cada instância separadamente?</span><span class="sxs-lookup"><span data-stu-id="924e3-226">Do you handle each instance separately?</span></span> <span data-ttu-id="924e3-227">Se uma instância começar a apresentar problemas, você deseja limitar a resposta para apenas se uma instância ou deseja tentar fazer com que todas as instâncias respondam da mesma forma quando uma instância tiver um problema?</span><span class="sxs-lookup"><span data-stu-id="924e3-227">If one instance starts having problems, do you want to limit the response to just that one instance, or do you want to try to have all instances respond in the same way when one instance has a problem?</span></span> <span data-ttu-id="924e3-228">Tratar as instâncias separadamente é muito mais simples do que tentar coordenar a resposta entre elas, mas a maneira de fazer isso depende da arquitetura do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="924e3-228">Handling the instances separately is much simpler than trying to coordinate the response across them, but how you do this depends on your application's architecture.</span></span>

### <a name="options-for-monitoring-the-error-frequency"></a><span data-ttu-id="924e3-229">Opções de monitoramento da frequência de erros</span><span class="sxs-lookup"><span data-stu-id="924e3-229">Options for monitoring the error frequency</span></span>

<span data-ttu-id="924e3-230">Você tem três opções principais para monitorar a frequência de novas tentativas na região primária para determinar quando passar para a região secundária e alterar o aplicativo para que seja executado no modo somente leitura.</span><span class="sxs-lookup"><span data-stu-id="924e3-230">You have three main options for monitoring the frequency of retries in the primary region in order to determine when to switch over to the secondary region and change the application to run in read-only mode.</span></span>

*   <span data-ttu-id="924e3-231">Adicionar um manipulador para o evento [**Retrying**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.operationcontext.retrying.aspx) do objeto [**OperationContext**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.operationcontext.aspx) que você passa para solicitações de armazenamento. Esse é o método apresentado neste artigo e usado no exemplo que o acompanha.</span><span class="sxs-lookup"><span data-stu-id="924e3-231">Add a handler for the [**Retrying**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.operationcontext.retrying.aspx) event on the [**OperationContext**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.operationcontext.aspx) object you pass to your storage requests – this is the method displayed in this article and used in the accompanying sample.</span></span> <span data-ttu-id="924e3-232">Esses eventos são acionados sempre que o cliente tenta novamente uma solicitação, permitindo que você controle com que frequência o cliente encontra erros com nova tentativa em um ponto de extremidade primário.</span><span class="sxs-lookup"><span data-stu-id="924e3-232">These events fire whenever the client retries a request, enabling you to track how often the client encounters retryable errors on a primary endpoint.</span></span>

    ```csharp 
    operationContext.Retrying += (sender, arguments) =>
    {
        // Retrying in the primary region
        if (arguments.Request.Host == primaryhostname)
            ...
    };
    ```

*   <span data-ttu-id="924e3-233">No método [**Evaluate**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.retrypolicies.iextendedretrypolicy.evaluate.aspx) em uma política de repetição personalizada, você pode executar código personalizado sempre que uma repetição ocorre.</span><span class="sxs-lookup"><span data-stu-id="924e3-233">In the [**Evaluate**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.retrypolicies.iextendedretrypolicy.evaluate.aspx) method in a custom retry policy, you can run custom code whenever a retry takes place.</span></span> <span data-ttu-id="924e3-234">Além de gravação quando uma repetição ocorre, isso também lhe dá a oportunidade de modificar o comportamento de repetição.</span><span class="sxs-lookup"><span data-stu-id="924e3-234">In addition to recording when a retry happens, this also gives you the opportunity to modify your retry behavior.</span></span>

    ```csharp 
    public RetryInfo Evaluate(RetryContext retryContext,
    OperationContext operationContext)
    {
        var statusCode = retryContext.LastRequestResult.HttpStatusCode;
        if (retryContext.CurrentRetryCount >= this.maximumAttempts
        || ((statusCode &gt;= 300 && statusCode &lt; 500 && statusCode != 408)
        || statusCode == 501 // Not Implemented
        || statusCode == 505 // Version Not Supported
            ))
        {
        // Do not retry
            return null;
        }

        // Monitor retries in the primary location
        ...

        // Determine RetryInterval and TargetLocation
        RetryInfo info =
            CreateRetryInfo(retryContext.CurrentRetryCount);

        return info;
    }
    ```

*   <span data-ttu-id="924e3-235">A terceira abordagem é implementar um componente de monitoramento personalizado no aplicativo que continuamente executa ping no ponto de extremidade de armazenamento primário com solicitações de leitura fictícias (como ler um blob pequeno) para determinar sua integridade.</span><span class="sxs-lookup"><span data-stu-id="924e3-235">The third approach is to implement a custom monitoring component in your application that continually pings your primary storage endpoint with dummy read requests (such as reading a small blob) to determine its health.</span></span> <span data-ttu-id="924e3-236">Isso deve exigir alguns recursos, mas não uma quantidade significativa.</span><span class="sxs-lookup"><span data-stu-id="924e3-236">This would take up some resources, but not a significant amount.</span></span> <span data-ttu-id="924e3-237">Quando é descoberto um problema que atinge o limite você executa a mudança para **SecondaryOnly** e o modo somente leitura.</span><span class="sxs-lookup"><span data-stu-id="924e3-237">When a problem is discovered that reaches your threshold, you would then perform the switch to **SecondaryOnly** and read-only mode.</span></span>

<span data-ttu-id="924e3-238">Em algum momento, convém alternar de volta para o ponto de extremidade primário e permitir atualizações.</span><span class="sxs-lookup"><span data-stu-id="924e3-238">At some point, you will want to switch back to using the primary endpoint and allowing updates.</span></span> <span data-ttu-id="924e3-239">Se usar um dos dois primeiros métodos listados acima, você poderá simplesmente alternar de novo para o ponto de extremidade primário e habilitar o modo de atualização após um período arbitrariamente selecionado ou a execução de determinado número de operações.</span><span class="sxs-lookup"><span data-stu-id="924e3-239">If using one of the first two methods listed above, you could simply switch back to the primary endpoint and enable update mode after an arbitrarily selected amount of time or number of operations has been performed.</span></span> <span data-ttu-id="924e3-240">Você pode permitir que ele percorra a lógica de repetição novamente.</span><span class="sxs-lookup"><span data-stu-id="924e3-240">You can then let it go through the retry logic again.</span></span> <span data-ttu-id="924e3-241">Se o problema tiver sido corrigido, ele continuará a usar o ponto de extremidade primário e a permitir atualizações.</span><span class="sxs-lookup"><span data-stu-id="924e3-241">If the problem has been fixed, it will continue to use the primary endpoint and allow updates.</span></span> <span data-ttu-id="924e3-242">Se ainda houver um problema, ele alternará mais uma vez para o ponto de extremidade secundário e o modo somente leitura depois de ser reprovado nos critérios que você definiu.</span><span class="sxs-lookup"><span data-stu-id="924e3-242">If there is still a problem, it will once more switch back to the secondary endpoint and read-only mode after failing the criteria you've set.</span></span>

<span data-ttu-id="924e3-243">Para o terceiro cenário, quando a execução de ping no ponto de extremidade de armazenamento primário tiver êxito novamente, você poderá alternar de volta para **PrimaryOnly** e continuar permitindo atualizações.</span><span class="sxs-lookup"><span data-stu-id="924e3-243">For the third scenario, when pinging the primary storage endpoint becomes successful again, you can trigger the switch back to **PrimaryOnly** and continue allowing updates.</span></span>

## <a name="handling-eventually-consistent-data"></a><span data-ttu-id="924e3-244">Manipulação de dados eventualmente consistentes</span><span class="sxs-lookup"><span data-stu-id="924e3-244">Handling eventually consistent data</span></span>

<span data-ttu-id="924e3-245">RA-GRS funciona por meio da replicação de transações da região primária para a secundária.</span><span class="sxs-lookup"><span data-stu-id="924e3-245">RA-GRS works by replicating transactions from the primary to the secondary region.</span></span> <span data-ttu-id="924e3-246">Esse processo de replicação garante que os dados na região secundária sejam *eventualmente consistentes*.</span><span class="sxs-lookup"><span data-stu-id="924e3-246">This replication process guarantees that the data in the secondary region is *eventually consistent*.</span></span> <span data-ttu-id="924e3-247">Isso significa que todas as transações na região primária eventualmente aparecerão na região secundária, mas pode haver um atraso antes de aparecerem e não há garantia de que as transações chegarão na região secundária na mesma ordem que em que foram aplicadas originalmente na região primária.</span><span class="sxs-lookup"><span data-stu-id="924e3-247">This means that all the transactions in the primary region will eventually appear in the secondary region, but that there may be a lag before they appear, and that there is no guarantee the transactions arrive in the secondary region in the same order as that in which they were originally applied in the primary region.</span></span> <span data-ttu-id="924e3-248">Se as transações chegarem na região secundária fora de ordem, você *poderá* considerar que os dados na região secundária estão em um estado inconsistente até que o serviço restabeleça a ordem.</span><span class="sxs-lookup"><span data-stu-id="924e3-248">If your transactions arrive in the secondary region out of order, you *may* consider your data in the secondary region to be in an inconsistent state until the service catches up.</span></span>

<span data-ttu-id="924e3-249">A tabela a seguir mostra um exemplo do que pode acontecer quando você atualiza os detalhes de uma funcionária para torná-la membro da função *administradores*.</span><span class="sxs-lookup"><span data-stu-id="924e3-249">The following table shows an example of what might happen when you update the details of an employee to make her a member of the *administrators* role.</span></span> <span data-ttu-id="924e3-250">Para este exemplo, isso requer que você atualize a entidade **funcionário** e atualize uma entidade **função de administrador** com uma contagem do número total de administradores.</span><span class="sxs-lookup"><span data-stu-id="924e3-250">For the sake of this example, this requires you update the **employee** entity and update an **administrator role** entity with a count of the total number of administrators.</span></span> <span data-ttu-id="924e3-251">Observe como as atualizações são aplicadas fora de ordem na região secundária.</span><span class="sxs-lookup"><span data-stu-id="924e3-251">Notice how the updates are applied out of order in the secondary region.</span></span>

| <span data-ttu-id="924e3-252">**Hora**</span><span class="sxs-lookup"><span data-stu-id="924e3-252">**Time**</span></span> | <span data-ttu-id="924e3-253">**Transação**</span><span class="sxs-lookup"><span data-stu-id="924e3-253">**Transaction**</span></span>                                            | <span data-ttu-id="924e3-254">**Replicação**</span><span class="sxs-lookup"><span data-stu-id="924e3-254">**Replication**</span></span>                       | <span data-ttu-id="924e3-255">**Hora da Última Sincronização**</span><span class="sxs-lookup"><span data-stu-id="924e3-255">**Last Sync Time**</span></span> | <span data-ttu-id="924e3-256">**Resultado**</span><span class="sxs-lookup"><span data-stu-id="924e3-256">**Result**</span></span> |
|----------|------------------------------------------------------------|---------------------------------------|--------------------|------------| 
| <span data-ttu-id="924e3-257">T0</span><span class="sxs-lookup"><span data-stu-id="924e3-257">T0</span></span>       | <span data-ttu-id="924e3-258">Transação A:</span><span class="sxs-lookup"><span data-stu-id="924e3-258">Transaction A:</span></span> <br> <span data-ttu-id="924e3-259">Inserir funcionário</span><span class="sxs-lookup"><span data-stu-id="924e3-259">Insert employee</span></span> <br> <span data-ttu-id="924e3-260">entidade no principal</span><span class="sxs-lookup"><span data-stu-id="924e3-260">entity in primary</span></span> |                                   |                    | <span data-ttu-id="924e3-261">Transação A inserida no primário,</span><span class="sxs-lookup"><span data-stu-id="924e3-261">Transaction A inserted to primary,</span></span><br> <span data-ttu-id="924e3-262">ainda não replicada.</span><span class="sxs-lookup"><span data-stu-id="924e3-262">not replicated yet.</span></span> |
| <span data-ttu-id="924e3-263">T1</span><span class="sxs-lookup"><span data-stu-id="924e3-263">T1</span></span>       |                                                            | <span data-ttu-id="924e3-264">Transação A</span><span class="sxs-lookup"><span data-stu-id="924e3-264">Transaction A</span></span> <br> <span data-ttu-id="924e3-265">replicada para</span><span class="sxs-lookup"><span data-stu-id="924e3-265">replicated to</span></span><br> <span data-ttu-id="924e3-266">secundário</span><span class="sxs-lookup"><span data-stu-id="924e3-266">secondary</span></span> | <span data-ttu-id="924e3-267">T1</span><span class="sxs-lookup"><span data-stu-id="924e3-267">T1</span></span> | <span data-ttu-id="924e3-268">A transação A foi replicada para o secundário.</span><span class="sxs-lookup"><span data-stu-id="924e3-268">Transaction A replicated to secondary.</span></span> <br><span data-ttu-id="924e3-269">Hora da Última Sincronização atualizada.</span><span class="sxs-lookup"><span data-stu-id="924e3-269">Last Sync Time updated.</span></span>    |
| <span data-ttu-id="924e3-270">T2</span><span class="sxs-lookup"><span data-stu-id="924e3-270">T2</span></span>       | <span data-ttu-id="924e3-271">Transação B:</span><span class="sxs-lookup"><span data-stu-id="924e3-271">Transaction B:</span></span><br><span data-ttu-id="924e3-272">Atualização</span><span class="sxs-lookup"><span data-stu-id="924e3-272">Update</span></span><br> <span data-ttu-id="924e3-273">entidade de funcionário</span><span class="sxs-lookup"><span data-stu-id="924e3-273">employee entity</span></span><br> <span data-ttu-id="924e3-274">no principal</span><span class="sxs-lookup"><span data-stu-id="924e3-274">in primary</span></span>  |                                | <span data-ttu-id="924e3-275">T1</span><span class="sxs-lookup"><span data-stu-id="924e3-275">T1</span></span>                 | <span data-ttu-id="924e3-276">Transação B gravada no principal,</span><span class="sxs-lookup"><span data-stu-id="924e3-276">Transaction B written to primary,</span></span><br> <span data-ttu-id="924e3-277">ainda não replicada.</span><span class="sxs-lookup"><span data-stu-id="924e3-277">not replicated yet.</span></span>  |
| <span data-ttu-id="924e3-278">T3</span><span class="sxs-lookup"><span data-stu-id="924e3-278">T3</span></span>       | <span data-ttu-id="924e3-279">Transação C:</span><span class="sxs-lookup"><span data-stu-id="924e3-279">Transaction C:</span></span><br> <span data-ttu-id="924e3-280">Atualização</span><span class="sxs-lookup"><span data-stu-id="924e3-280">Update</span></span> <br><span data-ttu-id="924e3-281">administrator</span><span class="sxs-lookup"><span data-stu-id="924e3-281">administrator</span></span><br><span data-ttu-id="924e3-282">entidade de função em</span><span class="sxs-lookup"><span data-stu-id="924e3-282">role entity in</span></span><br><span data-ttu-id="924e3-283">primary</span><span class="sxs-lookup"><span data-stu-id="924e3-283">primary</span></span> |                    | <span data-ttu-id="924e3-284">T1</span><span class="sxs-lookup"><span data-stu-id="924e3-284">T1</span></span>                 | <span data-ttu-id="924e3-285">Transação C gravada no principal,</span><span class="sxs-lookup"><span data-stu-id="924e3-285">Transaction C written to primary,</span></span><br> <span data-ttu-id="924e3-286">ainda não replicada.</span><span class="sxs-lookup"><span data-stu-id="924e3-286">not replicated yet.</span></span>  |
| <span data-ttu-id="924e3-287">*T4*</span><span class="sxs-lookup"><span data-stu-id="924e3-287">*T4*</span></span>     |                                                       | <span data-ttu-id="924e3-288">Transação C</span><span class="sxs-lookup"><span data-stu-id="924e3-288">Transaction C</span></span> <br><span data-ttu-id="924e3-289">replicada para</span><span class="sxs-lookup"><span data-stu-id="924e3-289">replicated to</span></span><br> <span data-ttu-id="924e3-290">secundário</span><span class="sxs-lookup"><span data-stu-id="924e3-290">secondary</span></span> | <span data-ttu-id="924e3-291">T1</span><span class="sxs-lookup"><span data-stu-id="924e3-291">T1</span></span>         | <span data-ttu-id="924e3-292">Transação C replicada para o secundário.</span><span class="sxs-lookup"><span data-stu-id="924e3-292">Transaction C replicated to secondary.</span></span><br><span data-ttu-id="924e3-293">LastSyncTime não atualizado porque</span><span class="sxs-lookup"><span data-stu-id="924e3-293">LastSyncTime not updated because</span></span> <br><span data-ttu-id="924e3-294">a transação B ainda não foi replicada.</span><span class="sxs-lookup"><span data-stu-id="924e3-294">transaction B has not been replicated yet.</span></span>|
| <span data-ttu-id="924e3-295">*T5*</span><span class="sxs-lookup"><span data-stu-id="924e3-295">*T5*</span></span>     | <span data-ttu-id="924e3-296">Ler entidades</span><span class="sxs-lookup"><span data-stu-id="924e3-296">Read entities</span></span> <br><span data-ttu-id="924e3-297">de secundário</span><span class="sxs-lookup"><span data-stu-id="924e3-297">from secondary</span></span>                           |                                  | <span data-ttu-id="924e3-298">T1</span><span class="sxs-lookup"><span data-stu-id="924e3-298">T1</span></span>                 | <span data-ttu-id="924e3-299">Você obtém o valor obsoleto para a entidade de funcionário</span><span class="sxs-lookup"><span data-stu-id="924e3-299">You get the stale value for employee</span></span> <br> <span data-ttu-id="924e3-300">porque a transação B não foi</span><span class="sxs-lookup"><span data-stu-id="924e3-300">entity because transaction B hasn't</span></span> <br> <span data-ttu-id="924e3-301">replicada ainda.</span><span class="sxs-lookup"><span data-stu-id="924e3-301">replicated yet.</span></span> <span data-ttu-id="924e3-302">Você obtém o novo valor para</span><span class="sxs-lookup"><span data-stu-id="924e3-302">You get the new value for</span></span><br> <span data-ttu-id="924e3-303">a entidade de função de administrador porque C foi</span><span class="sxs-lookup"><span data-stu-id="924e3-303">administrator role entity because C has</span></span><br> <span data-ttu-id="924e3-304">replicada.</span><span class="sxs-lookup"><span data-stu-id="924e3-304">replicated.</span></span> <span data-ttu-id="924e3-305">A Hora da Última Sincronização ainda não</span><span class="sxs-lookup"><span data-stu-id="924e3-305">Last Sync Time still hasn't</span></span><br> <span data-ttu-id="924e3-306">foi atualizada porque a transação B</span><span class="sxs-lookup"><span data-stu-id="924e3-306">been updated because transaction B</span></span><br> <span data-ttu-id="924e3-307">não foi replicada.</span><span class="sxs-lookup"><span data-stu-id="924e3-307">hasn't replicated.</span></span> <span data-ttu-id="924e3-308">Você pode ver que a</span><span class="sxs-lookup"><span data-stu-id="924e3-308">You can tell the</span></span><br><span data-ttu-id="924e3-309">entidade da função de administrador está inconsistente</span><span class="sxs-lookup"><span data-stu-id="924e3-309">administrator role entity is inconsistent</span></span> <br><span data-ttu-id="924e3-310">porque a data/hora da entidade é posterior</span><span class="sxs-lookup"><span data-stu-id="924e3-310">because the entity date/time is after</span></span> <br><span data-ttu-id="924e3-311">à Hora da Última Sincronização.</span><span class="sxs-lookup"><span data-stu-id="924e3-311">the Last Sync Time.</span></span> |
| <span data-ttu-id="924e3-312">*T6*</span><span class="sxs-lookup"><span data-stu-id="924e3-312">*T6*</span></span>     |                                                      | <span data-ttu-id="924e3-313">Transação B</span><span class="sxs-lookup"><span data-stu-id="924e3-313">Transaction B</span></span><br> <span data-ttu-id="924e3-314">replicada para</span><span class="sxs-lookup"><span data-stu-id="924e3-314">replicated to</span></span><br> <span data-ttu-id="924e3-315">secundário</span><span class="sxs-lookup"><span data-stu-id="924e3-315">secondary</span></span> | <span data-ttu-id="924e3-316">T6</span><span class="sxs-lookup"><span data-stu-id="924e3-316">T6</span></span>                 | <span data-ttu-id="924e3-317">*T6* – todas as transações até C</span><span class="sxs-lookup"><span data-stu-id="924e3-317">*T6* – All transactions through C have</span></span> <br><span data-ttu-id="924e3-318">foram replicadas; a Hora da Última Sincronização</span><span class="sxs-lookup"><span data-stu-id="924e3-318">been replicated, Last Sync Time</span></span><br> <span data-ttu-id="924e3-319">foi atualizada.</span><span class="sxs-lookup"><span data-stu-id="924e3-319">is updated.</span></span> |

<span data-ttu-id="924e3-320">Neste exemplo, suponha que o cliente alterne para leitura da região secundária em T5.</span><span class="sxs-lookup"><span data-stu-id="924e3-320">In this example, assume the client switches to reading from the secondary region at T5.</span></span> <span data-ttu-id="924e3-321">Ele pode ler com êxito a entidade de **função de administrador** nesse momento, mas a entidade contém um valor para a contagem de administradores que não é consistente com o número de entidades **funcionário** que são marcadas como administradores na região secundária nesse momento.</span><span class="sxs-lookup"><span data-stu-id="924e3-321">It can successfully read the **administrator role** entity at this time, but the entity contains a value for the count of administrators that is not consistent with the number of **employee** entities that are marked as administrators in the secondary region at this time.</span></span> <span data-ttu-id="924e3-322">O cliente simplesmente pode exibir esse valor, com o risco de que se trata de informações inconsistentes.</span><span class="sxs-lookup"><span data-stu-id="924e3-322">Your client could simply display this value, with the risk that it is inconsistent information.</span></span> <span data-ttu-id="924e3-323">Como alternativa, o cliente pode tentar determinar que a **função de administrador** está em um estado potencialmente inconsistente porque as atualizações ocorreram fora de ordem e informar esse fato ao usuário.</span><span class="sxs-lookup"><span data-stu-id="924e3-323">Alternatively, the client could attempt to determine that the **administrator role** is in a potentially inconsistent state because the updates have happened out of order, and then inform the user of this fact.</span></span>

<span data-ttu-id="924e3-324">Para reconhecer que ele tem dados potencialmente inconsistentes, o cliente pode usar o valor da *Hora da Última Sincronização*, que você pode obter a qualquer momento consultando um serviço de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="924e3-324">To recognize that it has potentially inconsistent data, the client can use the value of the *Last Sync Time* that you can get at any time by querying a storage service.</span></span> <span data-ttu-id="924e3-325">Isso indica a hora em que os dados na região secundária estiveram consistentes pela última vez e quando o serviço aplicou todas as transações antes desse ponto no tempo.</span><span class="sxs-lookup"><span data-stu-id="924e3-325">This tells you the time when the data in the secondary region was last consistent and when the service had applied all the transactions prior to that point in time.</span></span> <span data-ttu-id="924e3-326">No exemplo mostrado acima, após o serviço inserir a entidade **funcionário** na região secundária, a Hora da Última Sincronização é definida como *T1*.</span><span class="sxs-lookup"><span data-stu-id="924e3-326">In the example shown above, after the service inserts the **employee** entity in the secondary region, the last sync time is set to *T1*.</span></span> <span data-ttu-id="924e3-327">Ela permanece em *T1* até que as atualizações de serviço da entidade **funcionário** na região secundária, quando ela é definida como *T6*.</span><span class="sxs-lookup"><span data-stu-id="924e3-327">It remains at *T1* until the service updates the **employee** entity in the secondary region when it is set to *T6*.</span></span> <span data-ttu-id="924e3-328">Se o cliente recupera a hora da última sincronização ao ler a entidade em *T5*, pode compará-la ao carimbo de data/hora na entidade.</span><span class="sxs-lookup"><span data-stu-id="924e3-328">If the client retrieves the last sync time when it reads the entity at *T5*, it can compare it with the timestamp on the entity.</span></span> <span data-ttu-id="924e3-329">Se o carimbo de data/hora na entidade é posterior à hora da última sincronização, a entidade está em um estado potencialmente inconsistente, e você pode tomar a ação apropriada para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="924e3-329">If the timestamp on the entity is later than the last sync time, then the entity is in a potentially inconsistent state, and you can take whatever is the appropriate action for your application.</span></span> <span data-ttu-id="924e3-330">Usar esse campo requer que você saiba quando a última atualização do primário foi concluída.</span><span class="sxs-lookup"><span data-stu-id="924e3-330">Using this field requires that you know when the last update to the primary was completed.</span></span>

## <a name="testing"></a><span data-ttu-id="924e3-331">Testando</span><span class="sxs-lookup"><span data-stu-id="924e3-331">Testing</span></span>

<span data-ttu-id="924e3-332">É importante testar se o aplicativo se comporta conforme o esperado ao encontra erros com nova tentativa.</span><span class="sxs-lookup"><span data-stu-id="924e3-332">It's important to test that your application behaves as expected when it encounters retryable errors.</span></span> <span data-ttu-id="924e3-333">Por exemplo, você precisa testar se o aplicativo alterna para o secundário e o modo somente leitura ao detectar um problema e alterna de volta quando a região primária fica disponível novamente.</span><span class="sxs-lookup"><span data-stu-id="924e3-333">For example, you need to test that the application switches to the secondary and into read-only mode when it detects a problem, and switches back when the primary region becomes available again.</span></span> <span data-ttu-id="924e3-334">Para fazer isso, você precisa de uma maneira de simular erros com nova tentativa e controlar com que frequência eles ocorrem.</span><span class="sxs-lookup"><span data-stu-id="924e3-334">To do this, you need a way to simulate retryable errors and control how often they occur.</span></span>

<span data-ttu-id="924e3-335">Você pode usar o [Fiddler](http://www.telerik.com/fiddler) para interceptar e modificar respostas HTTP em um script.</span><span class="sxs-lookup"><span data-stu-id="924e3-335">You can use [Fiddler](http://www.telerik.com/fiddler) to intercept and modify HTTP responses in a script.</span></span> <span data-ttu-id="924e3-336">Esse script pode identificar as respostas que vêm do ponto de extremidade primário e alterar o código de status HTTP de forma que a Biblioteca de Cliente de Armazenamento o reconheça como um erros com nova tentativa.</span><span class="sxs-lookup"><span data-stu-id="924e3-336">This script can identify responses that come from your primary endpoint and change the HTTP status code to one that the Storage Client Library recognizes as a retryable error.</span></span> <span data-ttu-id="924e3-337">Este trecho de código mostra um exemplo simples de um script do Fiddler que intercepta as respostas para ler as solicitações em relação à tabela **employeedata** para retornar um status 502:</span><span class="sxs-lookup"><span data-stu-id="924e3-337">This code snippet shows a simple example of a Fiddler script that intercepts responses to read requests against the **employeedata** table to return a 502 status:</span></span>

```java
static function OnBeforeResponse(oSession: Session) {
    ...
    if ((oSession.hostname == "\[yourstorageaccount\].table.core.windows.net")
      && (oSession.PathAndQuery.StartsWith("/employeedata?$filter"))) {
        oSession.responseCode = 502;
    }
}
```

<span data-ttu-id="924e3-338">Você pode estender esse exemplo para interceptar uma maior gama de solicitações e alterar apenas o **responseCode** em alguns deles para simular melhor um cenário do mundo real.</span><span class="sxs-lookup"><span data-stu-id="924e3-338">You could extend this example to intercept a wider range of requests and only change the **responseCode** on some of them to better simulate a real-world scenario.</span></span> <span data-ttu-id="924e3-339">Para obter mais informações sobre como personalizar os scripts do Fiddler, confira [Modificando uma solicitação ou resposta](http://docs.telerik.com/fiddler/KnowledgeBase/FiddlerScript/ModifyRequestOrResponse) na documentação do Fiddler.</span><span class="sxs-lookup"><span data-stu-id="924e3-339">For more information about customizing Fiddler scripts, see [Modifying a Request or Response](http://docs.telerik.com/fiddler/KnowledgeBase/FiddlerScript/ModifyRequestOrResponse) in the Fiddler documentation.</span></span>

<span data-ttu-id="924e3-340">Se você tiver tornado configuráveis os limites para alternar o aplicativo para o modo somente leitura, será mais fácil testar o comportamento com volumes de transações de não produção.</span><span class="sxs-lookup"><span data-stu-id="924e3-340">If you have made the thresholds for switching your application to read-only mode configurable, it will be easier to test the behavior with non-production transaction volumes.</span></span>

## <a name="next-steps"></a><span data-ttu-id="924e3-341">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="924e3-341">Next Steps</span></span>

* <span data-ttu-id="924e3-342">Para obter mais informações sobre Redundância de Área Geográfica com acesso de leitura, inclusive outro exemplo de como LastSyncTime é definido, confira [Opções de redundância de armazenamento do Windows Azure e Redundância de Área Geográfica com acesso de leitura](https://blogs.msdn.microsoft.com/windowsazurestorage/2013/12/11/windows-azure-storage-redundancy-options-and-read-access-geo-redundant-storage/).</span><span class="sxs-lookup"><span data-stu-id="924e3-342">For more information about Read Access Geo-Redundancy, including another example of how the LastSyncTime is set, please see [Windows Azure Storage Redundancy Options and Read Access Geo Redundant Storage](https://blogs.msdn.microsoft.com/windowsazurestorage/2013/12/11/windows-azure-storage-redundancy-options-and-read-access-geo-redundant-storage/).</span></span>

* <span data-ttu-id="924e3-343">Para obter um exemplo completo que mostra como fazer a alternância entre os pontos de extremidade primário e secundário, confira [Exemplos do Azure – usando o padrão de Disjuntor com o armazenamento de RA-GRS](https://github.com/Azure-Samples/storage-dotnet-circuit-breaker-pattern-ha-apps-using-ra-grs).</span><span class="sxs-lookup"><span data-stu-id="924e3-343">For a complete sample showing how to make the switch back and forth between the Primary and Secondary endpoints, please see [Azure Samples – Using the Circuit Breaker Pattern with RA-GRS storage](https://github.com/Azure-Samples/storage-dotnet-circuit-breaker-pattern-ha-apps-using-ra-grs).</span></span>
