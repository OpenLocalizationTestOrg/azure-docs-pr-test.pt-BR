---
title: "aaaOverview de saudação do ciclo de vida de serviços do Azure Service Fabric confiáveis | Microsoft Docs"
description: "Saiba mais sobre eventos de ciclo de vida diferente Olá em serviços confiáveis do Service Fabric"
services: Service-Fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: vturecek;
ms.assetid: 
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 0d75ed5ee7cda85ac9af6a02e160727277804a2b
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/06/2017
---
# <a name="reliable-services-lifecycle-overview"></a><span data-ttu-id="35416-103">Visão geral do ciclo de vida do Reliable Services</span><span class="sxs-lookup"><span data-stu-id="35416-103">Reliable services lifecycle overview</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="35416-104">C# em Windows</span><span class="sxs-lookup"><span data-stu-id="35416-104">C# on Windows</span></span>](service-fabric-reliable-services-lifecycle.md)
> * [<span data-ttu-id="35416-105">Java no Linux</span><span class="sxs-lookup"><span data-stu-id="35416-105">Java on Linux</span></span>](service-fabric-reliable-services-lifecycle-java.md)
>
>

<span data-ttu-id="35416-106">Ao pensar Olá ciclos de vida de serviços confiáveis, Noções básicas de saudação do ciclo de vida de saudação são hello mais importante.</span><span class="sxs-lookup"><span data-stu-id="35416-106">When thinking about hello lifecycles of Reliable Services, hello basics of hello lifecycle are hello most important.</span></span> <span data-ttu-id="35416-107">Em geral:</span><span class="sxs-lookup"><span data-stu-id="35416-107">In general:</span></span>

- <span data-ttu-id="35416-108">Durante a inicialização</span><span class="sxs-lookup"><span data-stu-id="35416-108">During Startup</span></span>
  - <span data-ttu-id="35416-109">Serviços são construídos</span><span class="sxs-lookup"><span data-stu-id="35416-109">Services are constructed</span></span>
  - <span data-ttu-id="35416-110">Eles têm uma oportunidade tooconstruct e retornam zero ou mais ouvintes</span><span class="sxs-lookup"><span data-stu-id="35416-110">They have an opportunity tooconstruct and return zero or more listeners</span></span>
  - <span data-ttu-id="35416-111">Todos os ouvintes retornados abertos, permitindo que a comunicação com o serviço de saudação</span><span class="sxs-lookup"><span data-stu-id="35416-111">Any returned listeners are opened, allowing communication with hello service</span></span>
  - <span data-ttu-id="35416-112">RunAsync saudação do serviço método é chamado, permitindo Olá toodo de longa execução do serviço ou trabalho de plano de fundo</span><span class="sxs-lookup"><span data-stu-id="35416-112">hello Service's RunAsync method is called, allowing hello service toodo long running or background work</span></span>
- <span data-ttu-id="35416-113">Durante o desligamento</span><span class="sxs-lookup"><span data-stu-id="35416-113">During shutdown</span></span>
  - <span data-ttu-id="35416-114">tooRunAsync passado token de cancelamento Olá será cancelada e ouvintes de saudação são fechadas</span><span class="sxs-lookup"><span data-stu-id="35416-114">hello cancellation token passed tooRunAsync is canceled, and hello listeners are closed</span></span>
  - <span data-ttu-id="35416-115">Assim que estiver concluído, próprio objeto de serviço Olá é destruído</span><span class="sxs-lookup"><span data-stu-id="35416-115">Once that is complete, hello service object itself is destructed</span></span>

<span data-ttu-id="35416-116">Há detalhes sobre Olá exata de ordenação desses eventos.</span><span class="sxs-lookup"><span data-stu-id="35416-116">There are details around hello exact ordering of these events.</span></span> <span data-ttu-id="35416-117">Em particular, a ordem de saudação de eventos pode mudar um pouco dependendo se Olá serviço confiável é sem monitoração de estado ou de monitoração de estado.</span><span class="sxs-lookup"><span data-stu-id="35416-117">In particular, hello order of events may change slightly depending on whether hello Reliable Service is Stateless or Stateful.</span></span> <span data-ttu-id="35416-118">Além disso, para os serviços com monitoração de estado, temos toodeal com cenário de troca primário hello.</span><span class="sxs-lookup"><span data-stu-id="35416-118">In addition, for stateful services, we have toodeal with hello Primary swap scenario.</span></span> <span data-ttu-id="35416-119">Durante essa sequência, função hello principal é transferido tooanother réplica (ou voltar a ficar) sem o desligamento do serviço hello.</span><span class="sxs-lookup"><span data-stu-id="35416-119">During this sequence, hello role of Primary is transferred tooanother replica (or comes back) without hello service shutting down.</span></span> <span data-ttu-id="35416-120">Por fim, temos toothink sobre condições de erro ou falha.</span><span class="sxs-lookup"><span data-stu-id="35416-120">Finally, we have toothink about error or failure conditions.</span></span>

## <a name="stateless-service-startup"></a><span data-ttu-id="35416-121">Inicialização de serviço sem estado</span><span class="sxs-lookup"><span data-stu-id="35416-121">Stateless service startup</span></span>
<span data-ttu-id="35416-122">saudação de ciclo de vida de um serviço sem monitoração de estado é bastante simples.</span><span class="sxs-lookup"><span data-stu-id="35416-122">hello lifecycle of a stateless service is fairly straightforward.</span></span> <span data-ttu-id="35416-123">Aqui está a ordem de saudação de eventos:</span><span class="sxs-lookup"><span data-stu-id="35416-123">Here's hello order of events:</span></span>

1. <span data-ttu-id="35416-124">Olá serviço é construído</span><span class="sxs-lookup"><span data-stu-id="35416-124">hello Service is constructed</span></span>
2. <span data-ttu-id="35416-125">Em seguida, ocorrem duas coisas em paralelo:</span><span class="sxs-lookup"><span data-stu-id="35416-125">Then, in parallel two things happen:</span></span>
    - <span data-ttu-id="35416-126">`StatelessService.CreateServiceInstanceListeners()` é invocado e todos os ouvintes retornados são Abertos.</span><span class="sxs-lookup"><span data-stu-id="35416-126">`StatelessService.CreateServiceInstanceListeners()` is invoked and any returned listeners are Opened.</span></span> <span data-ttu-id="35416-127">`ICommunicationListener.OpenAsync()` é chamado em cada ouvinte</span><span class="sxs-lookup"><span data-stu-id="35416-127">`ICommunicationListener.OpenAsync()` is called on each listener</span></span>
    - <span data-ttu-id="35416-128">Olá do serviço `StatelessService.RunAsync()` é chamado de método</span><span class="sxs-lookup"><span data-stu-id="35416-128">hello service's `StatelessService.RunAsync()` method is called</span></span>
3. <span data-ttu-id="35416-129">Se estiver presente, Olá do serviço `StatelessService.OnOpenAsync()` método é chamado.</span><span class="sxs-lookup"><span data-stu-id="35416-129">If present, hello service's `StatelessService.OnOpenAsync()` method is called.</span></span> <span data-ttu-id="35416-130">Essa não é uma substituição comum, mas está disponível.</span><span class="sxs-lookup"><span data-stu-id="35416-130">This is an uncommon override, but it is available.</span></span>

<span data-ttu-id="35416-131">É importante toonote que não há nenhuma ordem entre Olá chamadas toocreate e ouvintes de saudação aberto e RunAsync.</span><span class="sxs-lookup"><span data-stu-id="35416-131">It is important toonote that there is no ordering between hello calls toocreate and open hello listeners and RunAsync.</span></span> <span data-ttu-id="35416-132">ouvintes de saudação podem abrir antes RunAsync é iniciado.</span><span class="sxs-lookup"><span data-stu-id="35416-132">hello listeners may open before RunAsync is started.</span></span> <span data-ttu-id="35416-133">Da mesma forma, RunAsync poderá acabar invocado antes de ouvintes de comunicação Olá estão abertas ou até mesmo foram construídos.</span><span class="sxs-lookup"><span data-stu-id="35416-133">Similarly, RunAsync may end up invoked before hello communication listeners are open or have even been constructed.</span></span> <span data-ttu-id="35416-134">Se nenhuma sincronização é necessária, ela será deixada como implementador de toohello um exercício.</span><span class="sxs-lookup"><span data-stu-id="35416-134">If any synchronization is required, it is left as an exercise toohello implementer.</span></span> <span data-ttu-id="35416-135">Soluções comuns:</span><span class="sxs-lookup"><span data-stu-id="35416-135">Common solutions:</span></span>

  - <span data-ttu-id="35416-136">Algumas vezes os ouvintes não funcionam até que outras informações sejam criadas ou algum trabalho seja realizado.</span><span class="sxs-lookup"><span data-stu-id="35416-136">Sometimes listeners can't function until some other information is created or work done.</span></span> <span data-ttu-id="35416-137">Para serviços sem estado, esse trabalho geralmente pode ser feito em outros locais, como:</span><span class="sxs-lookup"><span data-stu-id="35416-137">For stateless services that work can usually be done in other locations, such as:</span></span> 
    - <span data-ttu-id="35416-138">no construtor do serviço Olá</span><span class="sxs-lookup"><span data-stu-id="35416-138">in hello service's constructor</span></span>
    - <span data-ttu-id="35416-139">durante a saudação `CreateServiceInstanceListeners()` chamar</span><span class="sxs-lookup"><span data-stu-id="35416-139">during hello `CreateServiceInstanceListeners()` call</span></span>
    - <span data-ttu-id="35416-140">como parte da construção de saudação do ouvinte Olá próprio</span><span class="sxs-lookup"><span data-stu-id="35416-140">as a part of hello construction of hello listener itself</span></span>
  - <span data-ttu-id="35416-141">Às vezes, hello código RunAsync não quer toostart até ouvintes Olá estão abertas.</span><span class="sxs-lookup"><span data-stu-id="35416-141">Sometimes hello code in RunAsync does not want toostart until hello listeners are open.</span></span> <span data-ttu-id="35416-142">Nesse caso, coordenação adicional será necessária.</span><span class="sxs-lookup"><span data-stu-id="35416-142">In this case additional coordination is necessary.</span></span> <span data-ttu-id="35416-143">Uma solução comum é alguns sinalizador em ouvintes Olá indicando quando eles forem concluídas.</span><span class="sxs-lookup"><span data-stu-id="35416-143">One common solution is some flag within hello listeners indicating when they have completed.</span></span> <span data-ttu-id="35416-144">Este sinalizador será verificado em RunAsync antes de continuar o trabalho de tooactual.</span><span class="sxs-lookup"><span data-stu-id="35416-144">This flag is then checked in RunAsync before continuing tooactual work.</span></span>

## <a name="stateless-service-shutdown"></a><span data-ttu-id="35416-145">Desligamento de serviço sem estado</span><span class="sxs-lookup"><span data-stu-id="35416-145">Stateless service shutdown</span></span>
<span data-ttu-id="35416-146">Ao desligar um serviço sem monitoração de estado, Olá mesmo padrão é seguido apenas na ordem inversa:</span><span class="sxs-lookup"><span data-stu-id="35416-146">When shutting down a stateless service, hello same pattern is followed, just in reverse:</span></span>

1. <span data-ttu-id="35416-147">Em paralelo</span><span class="sxs-lookup"><span data-stu-id="35416-147">In parallel</span></span>
    - <span data-ttu-id="35416-148">Todos os ouvintes abertos são Fechados.</span><span class="sxs-lookup"><span data-stu-id="35416-148">Any open listeners are Closed.</span></span> <span data-ttu-id="35416-149">`ICommunicationListener.CloseAsync()` é chamado em cada ouvinte.</span><span class="sxs-lookup"><span data-stu-id="35416-149">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="35416-150">o token de cancelamento Olá passado muito`RunAsync()` é cancelada.</span><span class="sxs-lookup"><span data-stu-id="35416-150">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="35416-151">Do token de cancelamento de saudação verificando `IsCancellationRequested` propriedade retorna true e se a chamada do token Olá `ThrowIfCancellationRequested` método lança um `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="35416-151">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="35416-152">Uma vez `CloseAsync()` conclusão em cada ouvinte e `RunAsync()` também completa do serviço Olá `StatelessService.OnCloseAsync()` método é chamado, se presente.</span><span class="sxs-lookup"><span data-stu-id="35416-152">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatelessService.OnCloseAsync()` method is called, if present.</span></span> <span data-ttu-id="35416-153">É comum toooverride `StatelessService.OnCloseAsync()`.</span><span class="sxs-lookup"><span data-stu-id="35416-153">It is uncommon toooverride `StatelessService.OnCloseAsync()`.</span></span>
3. <span data-ttu-id="35416-154">Depois de `StatelessService.OnCloseAsync()` for concluído, o objeto de serviço Olá é destruído</span><span class="sxs-lookup"><span data-stu-id="35416-154">After `StatelessService.OnCloseAsync()` completes, hello service object is destructed</span></span>

## <a name="stateful-service-startup"></a><span data-ttu-id="35416-155">Inicialização de serviço com estado</span><span class="sxs-lookup"><span data-stu-id="35416-155">Stateful service Startup</span></span>
<span data-ttu-id="35416-156">Serviços com monitoração de estado tem serviços um toostateless padrão semelhantes, com poucas alterações.</span><span class="sxs-lookup"><span data-stu-id="35416-156">Stateful services have a similar pattern toostateless services, with a few changes.</span></span> <span data-ttu-id="35416-157">Ao iniciar o serviço com monitoração de estado, a ordem de saudação de eventos é o seguinte:</span><span class="sxs-lookup"><span data-stu-id="35416-157">When starting up a stateful service, hello order of events is as follows:</span></span>

1. <span data-ttu-id="35416-158">Olá serviço é construído</span><span class="sxs-lookup"><span data-stu-id="35416-158">hello Service is constructed</span></span>
2. <span data-ttu-id="35416-159">`StatefulServiceBase.OnOpenAsync()` é chamado.</span><span class="sxs-lookup"><span data-stu-id="35416-159">`StatefulServiceBase.OnOpenAsync()` is called.</span></span> <span data-ttu-id="35416-160">Isso é substituído uncommonly no serviço de saudação.</span><span class="sxs-lookup"><span data-stu-id="35416-160">This is uncommonly overridden in hello service.</span></span>
3. <span data-ttu-id="35416-161">Olá acontecem estas coisas em paralelo</span><span class="sxs-lookup"><span data-stu-id="35416-161">hello following things happen in parallel</span></span>
    - <span data-ttu-id="35416-162">`StatefulServiceBase.CreateServiceReplicaListeners()` é invocado</span><span class="sxs-lookup"><span data-stu-id="35416-162">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked</span></span> 
      - <span data-ttu-id="35416-163">Se o serviço Olá é primária todos os ouvintes retornados são abertos.</span><span class="sxs-lookup"><span data-stu-id="35416-163">If hello service is a Primary all returned listeners are Opened.</span></span> <span data-ttu-id="35416-164">`ICommunicationListener.OpenAsync()` é chamado em cada ouvinte.</span><span class="sxs-lookup"><span data-stu-id="35416-164">`ICommunicationListener.OpenAsync()` is called on each listener.</span></span>
      - <span data-ttu-id="35416-165">Se o serviço de saudação um secundário, somente esses ouvintes marcado como `ListenOnSecondary = true` estão abertas.</span><span class="sxs-lookup"><span data-stu-id="35416-165">If hello service is a Secondary, only those listeners marked as `ListenOnSecondary = true` are opened.</span></span> <span data-ttu-id="35416-166">Ter ouvintes que estão abertos em Secundários é menos comum.</span><span class="sxs-lookup"><span data-stu-id="35416-166">Having listeners that are open on Secondaries is less common.</span></span>
    - <span data-ttu-id="35416-167">Olá se Olá serviço atualmente é um serviço de saudação primário, `StatefulServiceBase.RunAsync()` é chamado de método</span><span class="sxs-lookup"><span data-stu-id="35416-167">hello if hello Service is currently a Primary, hello service's `StatefulServiceBase.RunAsync()` method is called</span></span>
4. <span data-ttu-id="35416-168">Depois que todos os Olá do ouvinte de réplica `OpenAsync()` concluir chamadas e `RunAsync()` é chamado, `StatefulServiceBase.OnChangeRoleAsync()` é chamado.</span><span class="sxs-lookup"><span data-stu-id="35416-168">Once all hello replica listener's `OpenAsync()` calls complete and `RunAsync()` is called, `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="35416-169">Isso é substituído uncommonly no serviço de saudação.</span><span class="sxs-lookup"><span data-stu-id="35416-169">This is uncommonly overridden in hello service.</span></span>

<span data-ttu-id="35416-170">Serviços de toostateless da mesma forma, não há nenhum coordenação entre ordem Olá no qual Olá ouvintes são criados e abertos e quando RunAsync é chamado.</span><span class="sxs-lookup"><span data-stu-id="35416-170">Similarly toostateless services, there's no coordination between hello order in which hello listeners are created and opened and when RunAsync is called.</span></span> <span data-ttu-id="35416-171">Se você precisar de coordenação, soluções Olá são muito Olá mesmo.</span><span class="sxs-lookup"><span data-stu-id="35416-171">If you need coordination, hello solutions are much hello same.</span></span> <span data-ttu-id="35416-172">Há um caso adicional: diga Olá chamadas que chegam ao ouvintes de comunicação Olá exigem informações mantidas dentro de alguns [coleções confiável](service-fabric-reliable-services-reliable-collections.md).</span><span class="sxs-lookup"><span data-stu-id="35416-172">THere is one additional case: say that hello calls arriving at hello communication listeners require information kept inside some [Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span></span> <span data-ttu-id="35416-173">Porque os ouvintes de comunicação Olá foi aberto antes de coleções de saudação confiável serão de leitura ou gravável e antes de RunAsync pode iniciar, alguns coordenação adicional é necessária.</span><span class="sxs-lookup"><span data-stu-id="35416-173">Because hello communication listeners could open before hello reliable collections are readable or writeable, and before RunAsync could start, some additional coordination is necessary.</span></span> <span data-ttu-id="35416-174">solução mais simples e mais comum de saudação é para tooreturn de ouvintes de comunicação Olá algum código de erro que Olá Olá a solicitação do cliente usa tooknow tooretry.</span><span class="sxs-lookup"><span data-stu-id="35416-174">hello simplest and most common solution is for hello communication listeners tooreturn some error code that hello client uses tooknow tooretry hello request.</span></span>

## <a name="stateful-service-shutdown"></a><span data-ttu-id="35416-175">Desligamento de serviço com estado</span><span class="sxs-lookup"><span data-stu-id="35416-175">Stateful service Shutdown</span></span>
<span data-ttu-id="35416-176">Da mesma forma tooStateless serviços, eventos de ciclo de vida de saudação durante o desligamento são Olá mesmo como durante a inicialização, mas revertidas.</span><span class="sxs-lookup"><span data-stu-id="35416-176">Similarly tooStateless services, hello lifecycle events during shutdown are hello same as during startup, but reversed.</span></span> <span data-ttu-id="35416-177">Quando um serviço com monitoração de estado está sendo desligado, hello seguintes eventos ocorrem:</span><span class="sxs-lookup"><span data-stu-id="35416-177">When a stateful service is being shut down, hello following events occur:</span></span>

1. <span data-ttu-id="35416-178">Em paralelo</span><span class="sxs-lookup"><span data-stu-id="35416-178">In parallel</span></span>
    - <span data-ttu-id="35416-179">Todos os ouvintes abertos são Fechados.</span><span class="sxs-lookup"><span data-stu-id="35416-179">Any open listeners are Closed.</span></span> <span data-ttu-id="35416-180">`ICommunicationListener.CloseAsync()` é chamado em cada ouvinte.</span><span class="sxs-lookup"><span data-stu-id="35416-180">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="35416-181">o token de cancelamento Olá passado muito`RunAsync()` é cancelada.</span><span class="sxs-lookup"><span data-stu-id="35416-181">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="35416-182">Do token de cancelamento de saudação verificando `IsCancellationRequested` propriedade retorna true e se a chamada do token Olá `ThrowIfCancellationRequested` método lança um `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="35416-182">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="35416-183">Uma vez `CloseAsync()` conclusão em cada ouvinte e `RunAsync()` também completa do serviço Olá `StatefulServiceBase.OnChangeRoleAsync()` é chamado.</span><span class="sxs-lookup"><span data-stu-id="35416-183">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="35416-184">(Isso é uncommonly substituído no serviço hello.)</span><span class="sxs-lookup"><span data-stu-id="35416-184">(This is uncommonly overridden in hello service.)</span></span>
    - <span data-ttu-id="35416-185">Aguardando RunAsync toocomplete só é necessária se esta réplica de serviço primária.</span><span class="sxs-lookup"><span data-stu-id="35416-185">Waiting for RunAsync toocomplete is only necessary if this service replica was a Primary.</span></span>
3. <span data-ttu-id="35416-186">Uma vez Olá `StatefulServiceBase.OnChangeRoleAsync()` método é concluído, hello `StatefulServiceBase.OnCloseAsync()` método é chamado.</span><span class="sxs-lookup"><span data-stu-id="35416-186">Once hello `StatefulServiceBase.OnChangeRoleAsync()` method completes, hello `StatefulServiceBase.OnCloseAsync()` method is called.</span></span> <span data-ttu-id="35416-187">Essa não é uma substituição comum, mas está disponível.</span><span class="sxs-lookup"><span data-stu-id="35416-187">This is an uncommon override, but it is available.</span></span>
3. <span data-ttu-id="35416-188">Depois de `StatefulServiceBase.OnCloseAsync()` for concluído, o objeto de serviço Olá é destruído.</span><span class="sxs-lookup"><span data-stu-id="35416-188">After `StatefulServiceBase.OnCloseAsync()` completes, hello service object is destructed.</span></span>

## <a name="stateful-service-primary-swaps"></a><span data-ttu-id="35416-189">Trocas de primária do serviço com estado</span><span class="sxs-lookup"><span data-stu-id="35416-189">Stateful service primary swaps</span></span>
<span data-ttu-id="35416-190">Durante a execução de um serviço com monitoração de estado, só hello réplicas primárias do que os serviços com monitoração de estado tem seus ouvintes de comunicação abertos e seu método RunAsync chamado.</span><span class="sxs-lookup"><span data-stu-id="35416-190">While a stateful service is running, only hello Primary replicas of that stateful services have their communication listeners opened and their RunAsync method called.</span></span> <span data-ttu-id="35416-191">Secundárias são construídas, mas não recebem chamadas.</span><span class="sxs-lookup"><span data-stu-id="35416-191">Secondary are constructed but see no further calls.</span></span> <span data-ttu-id="35416-192">Enquanto um serviço com monitoração de estado é executado no entanto, qual réplica está Olá primário pode alterar.</span><span class="sxs-lookup"><span data-stu-id="35416-192">While a stateful service is running however, which replica is currently hello Primary can change.</span></span> <span data-ttu-id="35416-193">O que isso significa em termos de eventos de ciclo de vida de saudação pode ver uma réplica? Olá comportamento Olá réplica com monitoração de estado vê depende se ela é réplica Olá sendo rebaixada ou promovida durante a troca de saudação.</span><span class="sxs-lookup"><span data-stu-id="35416-193">What does this mean in terms of hello lifecycle events that a replica can see? hello behavior hello stateful replica sees depends on whether it is hello replica being demoted or promoted during hello swap.</span></span>

### <a name="for-hello-primary-being-demoted"></a><span data-ttu-id="35416-194">Para Olá primário que está sendo rebaixado</span><span class="sxs-lookup"><span data-stu-id="35416-194">For hello primary being demoted</span></span>
<span data-ttu-id="35416-195">Service Fabric precisa este toostop réplica processamento de mensagens e feche qualquer trabalho em segundo plano que está fazendo.</span><span class="sxs-lookup"><span data-stu-id="35416-195">Service Fabric needs this replica toostop processing messages and quit any background work it is doing.</span></span> <span data-ttu-id="35416-196">Como resultado, essa etapa parece semelhante toowhen Olá serviço está sendo desligado.</span><span class="sxs-lookup"><span data-stu-id="35416-196">As a result, this step looks similar toowhen hello service is being shut down.</span></span> <span data-ttu-id="35416-197">Uma diferença é que hello serviço não é destruído ou fechado, pois ele permanece como um secundário.</span><span class="sxs-lookup"><span data-stu-id="35416-197">One difference is that hello Service isn't destructed or closed since it remains as a Secondary.</span></span> <span data-ttu-id="35416-198">é chamada de saudação APIs a seguir:</span><span class="sxs-lookup"><span data-stu-id="35416-198">hello following APIs are called:</span></span>

1. <span data-ttu-id="35416-199">Em paralelo</span><span class="sxs-lookup"><span data-stu-id="35416-199">In parallel</span></span>
    - <span data-ttu-id="35416-200">Todos os ouvintes abertos são Fechados.</span><span class="sxs-lookup"><span data-stu-id="35416-200">Any open listeners are Closed.</span></span> <span data-ttu-id="35416-201">`ICommunicationListener.CloseAsync()` é chamado em cada ouvinte.</span><span class="sxs-lookup"><span data-stu-id="35416-201">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="35416-202">o token de cancelamento Olá passado muito`RunAsync()` é cancelada.</span><span class="sxs-lookup"><span data-stu-id="35416-202">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="35416-203">Do token de cancelamento de saudação verificando `IsCancellationRequested` propriedade retorna true e se a chamada do token Olá `ThrowIfCancellationRequested` método lança um `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="35416-203">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="35416-204">Uma vez `CloseAsync()` conclusão em cada ouvinte e `RunAsync()` também completa do serviço Olá `StatefulServiceBase.OnChangeRoleAsync()` é chamado.</span><span class="sxs-lookup"><span data-stu-id="35416-204">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="35416-205">Isso é substituído uncommonly no serviço de saudação.</span><span class="sxs-lookup"><span data-stu-id="35416-205">This is uncommonly overridden in hello service.</span></span>

### <a name="for-hello-secondary-being-promoted"></a><span data-ttu-id="35416-206">Para Olá secundária que está sendo promovido</span><span class="sxs-lookup"><span data-stu-id="35416-206">For hello secondary being promoted</span></span>
<span data-ttu-id="35416-207">Da mesma forma, do Service Fabric precisa este toostart réplica ouvindo mensagens percurso hello e iniciar as tarefas em segundo plano são importantes.</span><span class="sxs-lookup"><span data-stu-id="35416-207">Similarly, Service Fabric needs this replica toostart listening for messages on hello wire and start any background tasks it cares about.</span></span> <span data-ttu-id="35416-208">Como resultado, essa parece processo serviço de saudação toowhen semelhante é criado, exceto que a réplica Olá em si já existe.</span><span class="sxs-lookup"><span data-stu-id="35416-208">As a result, this process looks similar toowhen hello service is created, except that hello replica itself already exists.</span></span> <span data-ttu-id="35416-209">é chamada de saudação APIs a seguir:</span><span class="sxs-lookup"><span data-stu-id="35416-209">hello following APIs are called:</span></span>

1. <span data-ttu-id="35416-210">Em paralelo</span><span class="sxs-lookup"><span data-stu-id="35416-210">In parallel</span></span>
    - <span data-ttu-id="35416-211">`StatefulServiceBase.CreateServiceReplicaListeners()` é invocado e todos os ouvintes retornados são Abertos.</span><span class="sxs-lookup"><span data-stu-id="35416-211">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked and any returned listeners are Opened.</span></span> <span data-ttu-id="35416-212">`ICommunicationListener.OpenAsync()` é chamado em cada ouvinte.</span><span class="sxs-lookup"><span data-stu-id="35416-212">`ICommunicationListener.OpenAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="35416-213">Olá do serviço `StatefulServiceBase.RunAsync()` é chamado de método</span><span class="sxs-lookup"><span data-stu-id="35416-213">hello service's `StatefulServiceBase.RunAsync()` method is called</span></span>
2. <span data-ttu-id="35416-214">Depois que todos os Olá do ouvinte de réplica `OpenAsync()` concluir chamadas e `RunAsync()` foi chamado, `StatefulServiceBase.OnChangeRoleAsync()` é chamado.</span><span class="sxs-lookup"><span data-stu-id="35416-214">Once all hello replica listener's `OpenAsync()` calls complete and `RunAsync()` has been called,  `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="35416-215">Isso é substituído uncommonly no serviço de saudação.</span><span class="sxs-lookup"><span data-stu-id="35416-215">This is uncommonly overridden in hello service.</span></span>

### <a name="common-issues-during-stateful-service-shutdown-and-primary-demotion"></a><span data-ttu-id="35416-216">Problemas comuns durante o desligamento do serviço com estado e rebaixamento do primário</span><span class="sxs-lookup"><span data-stu-id="35416-216">Common issues during stateful service shutdown and primary demotion</span></span>
<span data-ttu-id="35416-217">Alterações do Service Fabric Olá primário de um serviço com monitoração de estado para uma variedade de razões.</span><span class="sxs-lookup"><span data-stu-id="35416-217">Service Fabric changes hello Primary of a stateful service for a variety of reasons.</span></span> <span data-ttu-id="35416-218">Hello mais comuns são [cluster rebalanceamento](service-fabric-cluster-resource-manager-balancing.md) e [atualização de aplicativo](service-fabric-application-upgrade.md).</span><span class="sxs-lookup"><span data-stu-id="35416-218">hello most common are [cluster rebalancing](service-fabric-cluster-resource-manager-balancing.md) and [application upgrade](service-fabric-application-upgrade.md).</span></span> <span data-ttu-id="35416-219">Durante essas operações (bem como durante o desligamento normal do serviço, como você veria se o serviço de saudação foi excluído), é importante que Olá Olá de relação serviço `CancellationToken`.</span><span class="sxs-lookup"><span data-stu-id="35416-219">During these operations (as well as during normal service shutdown, like you'd see if hello service was deleted), it is important that hello service respect hello `CancellationToken`.</span></span> <span data-ttu-id="35416-220">Os serviços que não tratarem o cancelamento corretamente enfrentarão vários problemas.</span><span class="sxs-lookup"><span data-stu-id="35416-220">Services that do not handle cancellation cleanly will experience several issues.</span></span> <span data-ttu-id="35416-221">Em particular, essas operações será lentas pois Service Fabric aguarda Olá serviços toostop normalmente.</span><span class="sxs-lookup"><span data-stu-id="35416-221">In particular, these operations will be slow since Service Fabric waits for hello services toostop gracefully.</span></span> <span data-ttu-id="35416-222">Isso pode levar toofailed atualizações esse tempo limite e revertê-lo, por fim.</span><span class="sxs-lookup"><span data-stu-id="35416-222">This can ultimately lead toofailed upgrades that time out and roll back.</span></span> <span data-ttu-id="35416-223">Token de cancelamento falha toohonor Olá também pode causar clusters desequilibrados porque nós obtém ativos, mas não podem ser balanceados serviços Olá desde que demora muito toomove-los em outro lugar.</span><span class="sxs-lookup"><span data-stu-id="35416-223">Failure toohonor hello cancellation token can also cause imbalanced clusters because nodes get hot but hello services can't be rebalanced since it takes too long toomove them elsewhere.</span></span> 

<span data-ttu-id="35416-224">Como os serviços de saudação com monitoração de estado, também é provável que estão usando Olá [coleções confiável](service-fabric-reliable-services-reliable-collections.md).</span><span class="sxs-lookup"><span data-stu-id="35416-224">Since hello services are stateful, it is also likely that they are using hello [Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span></span> <span data-ttu-id="35416-225">Na malha do serviço, quando primário é rebaixado, uma saudação coisas mais importantes que acontece é que o estado do acesso de gravação toohello subjacente é revogado.</span><span class="sxs-lookup"><span data-stu-id="35416-225">In Service Fabric, when a Primary is demoted, one of hello first things that happens is that write access toohello underlying state is revoked.</span></span> <span data-ttu-id="35416-226">Isso leva tooa segundo conjunto de problemas que podem afetar o ciclo de vida de serviço hello.</span><span class="sxs-lookup"><span data-stu-id="35416-226">This leads tooa second set of issues that can impact hello service lifecycle.</span></span> <span data-ttu-id="35416-227">coleções de saudação retorno exceções com base no tempo de saudação e se a réplica hello está sendo movida ou desligar.</span><span class="sxs-lookup"><span data-stu-id="35416-227">hello collections return Exceptions based on hello timing and whether hello replica is being moved or shut down.</span></span> <span data-ttu-id="35416-228">Essas exceções devem ser tratadas corretamente.</span><span class="sxs-lookup"><span data-stu-id="35416-228">These exceptions should be handled correctly.</span></span> <span data-ttu-id="35416-229">As exceções geradas pelo Service Fabric se classificam nas categorias permanentes [(`FabricException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabricexception?view=azure-dotnet) e transitórias [(`FabricTransientException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabrictransientexception?view=azure-dotnet).</span><span class="sxs-lookup"><span data-stu-id="35416-229">Exceptions thrown by Service Fabric fall into permanent [(`FabricException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabricexception?view=azure-dotnet) and transient [(`FabricTransientException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabrictransientexception?view=azure-dotnet) categories.</span></span> <span data-ttu-id="35416-230">Exceções permanentes devem ser registradas e lançadas ao exceções transitórias Olá podem ser repetidas com base em alguma lógica de repetição.</span><span class="sxs-lookup"><span data-stu-id="35416-230">Permanent exceptions should be logged and thrown, while hello transient exceptions may be retried based on some retry logic.</span></span>

<span data-ttu-id="35416-231">Tratamento de exceções de saudação que vêm do uso de saudação `ReliableCollections` em conjunto com eventos de ciclo de vida do serviço é uma parte importante de teste e validação de um serviço confiável.</span><span class="sxs-lookup"><span data-stu-id="35416-231">Handling hello exceptions that come from use of hello `ReliableCollections` in conjunction with service lifecycle events is an important part of testing and validating a Reliable Service.</span></span> <span data-ttu-id="35416-232">Olá recomendação é sempre toorun seu serviço sob carga durante a execução de atualizações e [caos teste](service-fabric-controlled-chaos.md) antes de implantar nunca tooproduction.</span><span class="sxs-lookup"><span data-stu-id="35416-232">hello recommendation is always toorun your service under load while performing upgrades and [chaos testing](service-fabric-controlled-chaos.md) before ever deploying tooproduction.</span></span> <span data-ttu-id="35416-233">Essas etapas básicas ajudam a garantir que o serviço seja implementado corretamente, além de tratar os eventos do ciclo de vida corretamente.</span><span class="sxs-lookup"><span data-stu-id="35416-233">These basic steps help ensure that your service is correctly implemented and handles lifecycle events correctly.</span></span>


## <a name="notes-on-service-lifecycle"></a><span data-ttu-id="35416-234">Observações sobre o ciclo de vida do serviço</span><span class="sxs-lookup"><span data-stu-id="35416-234">Notes on service lifecycle</span></span>
  - <span data-ttu-id="35416-235">Ambos os Olá `RunAsync()` método e hello `CreateServiceReplicaListeners/CreateServiceInstanceListeners` chamadas são opcionais.</span><span class="sxs-lookup"><span data-stu-id="35416-235">Both hello `RunAsync()` method and hello `CreateServiceReplicaListeners/CreateServiceInstanceListeners` calls are optional.</span></span> <span data-ttu-id="35416-236">Um serviço pode ter um deles, ambos ou nenhum.</span><span class="sxs-lookup"><span data-stu-id="35416-236">A service may have one of them, both, or neither.</span></span> <span data-ttu-id="35416-237">Por exemplo, se o serviço de saudação faz seu trabalho em resposta toouser chamadas, não é necessário para que ele tooimplement `RunAsync()`.</span><span class="sxs-lookup"><span data-stu-id="35416-237">For example, if hello service does all its work in response toouser calls, there is no need for it tooimplement `RunAsync()`.</span></span> <span data-ttu-id="35416-238">É necessário apenas os ouvintes de comunicação hello e seu código associado.</span><span class="sxs-lookup"><span data-stu-id="35416-238">Only hello communication listeners and their associated code are necessary.</span></span> <span data-ttu-id="35416-239">Da mesma forma, criando e retornando ouvintes de comunicação é opcional, pois o serviço Olá pode ter apenas em segundo plano toodo de trabalho e então só precisa tooimplement`RunAsync()`</span><span class="sxs-lookup"><span data-stu-id="35416-239">Similarly, creating and returning communication listeners is optional, as hello service may have only background work toodo, and so only needs tooimplement `RunAsync()`</span></span>
  - <span data-ttu-id="35416-240">Ele é válido para um serviço toocomplete `RunAsync()` com êxito e retorno dele.</span><span class="sxs-lookup"><span data-stu-id="35416-240">It is valid for a service toocomplete `RunAsync()` successfully and return from it.</span></span> <span data-ttu-id="35416-241">A conclusão não é uma condição de falha.</span><span class="sxs-lookup"><span data-stu-id="35416-241">Completing is not a failure condition.</span></span> <span data-ttu-id="35416-242">Concluindo `RunAsync()` indica que o trabalho em segundo plano de saudação do serviço de saudação foi concluída.</span><span class="sxs-lookup"><span data-stu-id="35416-242">Completing `RunAsync()` indicates that hello background work of hello service has completed.</span></span> <span data-ttu-id="35416-243">Para serviços confiáveis com monitoração de estado, `RunAsync()` é chamado novamente se a réplica Olá foram rebaixada de tooSecondary primária e, em seguida, promovida tooPrimary voltar.</span><span class="sxs-lookup"><span data-stu-id="35416-243">For stateful reliable services, `RunAsync()` is called again if hello replica were demoted from Primary tooSecondary and then promoted back tooPrimary.</span></span>
  - <span data-ttu-id="35416-244">Se um serviço sair de `RunAsync()` lançando uma exceção inesperada, isso constituirá uma falha.</span><span class="sxs-lookup"><span data-stu-id="35416-244">If a service exits from `RunAsync()` by throwing some unexpected exception, this constitutes a failure.</span></span> <span data-ttu-id="35416-245">o objeto de serviço Olá é desligado e relatou um erro de integridade.</span><span class="sxs-lookup"><span data-stu-id="35416-245">hello service object is shut down and a health error reported.</span></span>
  - <span data-ttu-id="35416-246">Embora não haja nenhum limite de tempo no retorno de um desses métodos, você perde imediatamente Olá capacidade toowrite tooReliable coleções e, portanto, não pode concluir qualquer trabalho real.</span><span class="sxs-lookup"><span data-stu-id="35416-246">While there is no time limit on returning from these methods, you immediately lose hello ability toowrite tooReliable Collections and therefore cannot complete any real work.</span></span> <span data-ttu-id="35416-247">É recomendável que você retorne mais rápido possível após o recebimento da solicitação de cancelamento de saudação.</span><span class="sxs-lookup"><span data-stu-id="35416-247">It is recommended that you return as quickly as possible upon receiving hello cancellation request.</span></span> <span data-ttu-id="35416-248">Se o serviço não responder chamadas de API do toothese em um período razoável que do Service Fabric pode forçar cancelar seu serviço.</span><span class="sxs-lookup"><span data-stu-id="35416-248">If your service does not respond toothese API calls in a reasonable amount of time Service Fabric may forcibly terminate your service.</span></span> <span data-ttu-id="35416-249">Geralmente isso ocorre apenas durante atualizações de aplicativo ou quando um serviço está sendo excluído.</span><span class="sxs-lookup"><span data-stu-id="35416-249">Usually this only happens during application upgrades or when a service is being deleted.</span></span> <span data-ttu-id="35416-250">Esse tempo limite é de 15 minutos por padrão.</span><span class="sxs-lookup"><span data-stu-id="35416-250">This timeout is 15 minutes by default.</span></span>
  - <span data-ttu-id="35416-251">Falhas em Olá `OnCloseAsync()` resultados de caminho em `OnAbort()` sendo chamada que é uma oportunidade de melhor esforço de última chance de saudação serviço tooclean backup e liberar todos os recursos que eles já solicitou.</span><span class="sxs-lookup"><span data-stu-id="35416-251">Failures in hello `OnCloseAsync()` path result in `OnAbort()` being called which is a last-chance best-effort opportunity for hello service tooclean up and release any resources that they have claimed.</span></span>

## <a name="next-steps"></a><span data-ttu-id="35416-252">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="35416-252">Next steps</span></span>
- [<span data-ttu-id="35416-253">Serviços de tooReliable de Introdução</span><span class="sxs-lookup"><span data-stu-id="35416-253">Introduction tooReliable Services</span></span>](service-fabric-reliable-services-introduction.md)
- [<span data-ttu-id="35416-254">Início Rápido dos Serviços Confiáveis</span><span class="sxs-lookup"><span data-stu-id="35416-254">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
- [<span data-ttu-id="35416-255">Uso avançado de Reliable Services</span><span class="sxs-lookup"><span data-stu-id="35416-255">Reliable Services advanced usage</span></span>](service-fabric-reliable-services-advanced-usage.md)
