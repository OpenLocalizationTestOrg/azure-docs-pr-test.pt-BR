---
title: "Resource Manager de Cluster do Service Fabric – integração de gerenciamento | Microsoft Docs"
description: "Uma visão geral dos pontos de integração entre o Gerenciador de Recursos de Cluster e o Gerenciamento do Service Fabric."
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: 
ms.assetid: 956cd0b8-b6e3-4436-a224-8766320e8cd7
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 9601e758e1033b4e2f86c2c230d4f49479fe6f45
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/18/2017
---
# <a name="cluster-resource-manager-integration-with-service-fabric-cluster-management"></a><span data-ttu-id="b9379-103">Integração do Gerenciador de Recursos de Cluster com o gerenciamento de cluster do Service Fabric</span><span class="sxs-lookup"><span data-stu-id="b9379-103">Cluster resource manager integration with Service Fabric cluster management</span></span>
<span data-ttu-id="b9379-104">O Gerenciador de recursos de Cluster do Service Fabric não realiza as atualizações no Service Fabric, mas está envolvido.</span><span class="sxs-lookup"><span data-stu-id="b9379-104">The Service Fabric Cluster Resource Manager doesn't drive upgrades in Service Fabric, but it is involved.</span></span> <span data-ttu-id="b9379-105">A primeira maneira que o Cluster Resource Manager pode ajudar no gerenciamento é rastreando o estado desejado do cluster e dos serviços dentro dele.</span><span class="sxs-lookup"><span data-stu-id="b9379-105">The first way that the Cluster Resource Manager helps with management is by tracking the desired state of the cluster and the services inside it.</span></span> <span data-ttu-id="b9379-106">O Cluster Resource Manager envia relatórios de integridade quando não consegue deixar o cluster na configuração desejada.</span><span class="sxs-lookup"><span data-stu-id="b9379-106">The Cluster Resource Manager sends out health reports when it cannot put the cluster into the desired configuration.</span></span> <span data-ttu-id="b9379-107">Por exemplo, se não houver capacidade suficiente, o Gerenciador de Recursos de Cluster enviará avisos de integridade e erros indicando o problema.</span><span class="sxs-lookup"><span data-stu-id="b9379-107">For example, if there is insufficient capacity the Cluster Resource Manager sends out health warnings and errors indicating the problem.</span></span> <span data-ttu-id="b9379-108">Outra parte de integração tem a ver com a forma como as atualizações funcionam.</span><span class="sxs-lookup"><span data-stu-id="b9379-108">Another piece of integration has to do with how upgrades work.</span></span> <span data-ttu-id="b9379-109">O Gerenciador de Recursos de Cluster altera ligeiramente seu comportamento durante as atualizações.</span><span class="sxs-lookup"><span data-stu-id="b9379-109">The Cluster Resource Manager alters its behavior slightly during upgrades.</span></span>  

## <a name="health-integration"></a><span data-ttu-id="b9379-110">Integração da integridade</span><span class="sxs-lookup"><span data-stu-id="b9379-110">Health integration</span></span>
<span data-ttu-id="b9379-111">O Gerenciador de Recursos de Cluster controla constantemente as regras que você definiu para posicionamento de seus serviços.</span><span class="sxs-lookup"><span data-stu-id="b9379-111">The Cluster Resource Manager constantly tracks the rules you have defined for placing your services.</span></span> <span data-ttu-id="b9379-112">Ele também controla a capacidade restante de cada métrica nos nós no cluster, e no cluster como um todo.</span><span class="sxs-lookup"><span data-stu-id="b9379-112">It also tracks the remaining capacity for each metric on the nodes and in the cluster and in the cluster as a whole.</span></span> <span data-ttu-id="b9379-113">Se ele não puder atender a essas regras ou se não houver capacidade insuficiente, erros e avisos de integridade serão emitidos.</span><span class="sxs-lookup"><span data-stu-id="b9379-113">If it can't satisfy those rules or if there is insufficient capacity, health warnings and errors are emitted.</span></span> <span data-ttu-id="b9379-114">Por exemplo, se um nó estiver acima da capacidade, o Cluster Resource Manager tentará corrigir a situação movendo serviços.</span><span class="sxs-lookup"><span data-stu-id="b9379-114">For example, if a node is over capacity and the Cluster Resource Manager will try to fix the situation by moving services.</span></span> <span data-ttu-id="b9379-115">Se não puder corrigir a situação, ele emitirá um aviso de integridade indicando qual nó está acima da capacidade e para quais métricas.</span><span class="sxs-lookup"><span data-stu-id="b9379-115">If it can't correct the situation it emits a health warning indicating which node is over capacity, and for which metrics.</span></span>

<span data-ttu-id="b9379-116">Outro exemplo de avisos de integridade do Resource Manager são violações de restrições de posicionamento.</span><span class="sxs-lookup"><span data-stu-id="b9379-116">Another example of the Resource Manager's health warnings is violations of placement constraints.</span></span> <span data-ttu-id="b9379-117">Por exemplo, se você tiver definido uma restrição de posicionamento (como `“NodeColor == Blue”`) e o Resource Manager detectar uma violação desta restrição, ele emitirá um aviso de integridade.</span><span class="sxs-lookup"><span data-stu-id="b9379-117">For example, if you have defined a placement constraint (such as `“NodeColor == Blue”`) and the Resource Manager detects a violation of that constraint, it emits a health warning.</span></span> <span data-ttu-id="b9379-118">Isso é válido tanto para restrições personalizadas e padrão (como restrições de Domínio de Falha e Domínio de Atualização).</span><span class="sxs-lookup"><span data-stu-id="b9379-118">This is true for custom constraints and the default constraints (like the Fault Domain and Upgrade Domain constraints).</span></span>

<span data-ttu-id="b9379-119">Eis um exemplo de tal relatório de integridade.</span><span class="sxs-lookup"><span data-stu-id="b9379-119">Here’s an example of one such health report.</span></span> <span data-ttu-id="b9379-120">Nesse caso, o relatório de integridade é voltado para uma das partições do serviço do sistema.</span><span class="sxs-lookup"><span data-stu-id="b9379-120">In this case, the health report is for one of the system service’s partitions.</span></span> <span data-ttu-id="b9379-121">A mensagem de integridade indica quais réplicas dessa partição estão temporariamente empacotadas em Domínios de Atualização insuficientes.</span><span class="sxs-lookup"><span data-stu-id="b9379-121">The health message indicates the replicas of that partition are temporarily packed into too few Upgrade Domains.</span></span>

```posh
PS C:\Users\User > Get-WindowsFabricPartitionHealth -PartitionId '00000000-0000-0000-0000-000000000001'


PartitionId           : 00000000-0000-0000-0000-000000000001
AggregatedHealthState : Warning
UnhealthyEvaluations  :
                        Unhealthy event: SourceId='System.PLB', Property='ReplicaConstraintViolation_UpgradeDomain', HealthState='Warning', ConsiderWarningAsError=false.

ReplicaHealthStates   :
                        ReplicaId             : 130766528804733380
                        AggregatedHealthState : Ok

                        ReplicaId             : 130766528804577821
                        AggregatedHealthState : Ok

                        ReplicaId             : 130766528854889931
                        AggregatedHealthState : Ok

                        ReplicaId             : 130766528804577822
                        AggregatedHealthState : Ok

                        ReplicaId             : 130837073190680024
                        AggregatedHealthState : Ok

HealthEvents          :
                        SourceId              : System.PLB
                        Property              : ReplicaConstraintViolation_UpgradeDomain
                        HealthState           : Warning
                        SequenceNumber        : 130837100116930204
                        SentAt                : 8/10/2015 7:53:31 PM
                        ReceivedAt            : 8/10/2015 7:53:33 PM
                        TTL                   : 00:01:05
                        Description           : The Load Balancer has detected a Constraint Violation for this Replica: fabric:/System/FailoverManagerService Secondary Partition 00000000-0000-0000-0000-000000000001 is
                        violating the Constraint: UpgradeDomain Details: UpgradeDomain ID -- 4, Replica on NodeName -- Node.8 Currently Upgrading -- false Distribution Policy -- Packing
                        RemoveWhenExpired     : True
                        IsExpired             : False
                        Transitions           : Ok->Warning = 8/10/2015 7:13:02 PM, LastError = 1/1/0001 12:00:00 AM
```

<span data-ttu-id="b9379-122">Veja o que a mensagem de integridade está nos dizendo:</span><span class="sxs-lookup"><span data-stu-id="b9379-122">Here's what this health message is telling us is:</span></span>

1. <span data-ttu-id="b9379-123">Todas as réplicas estão íntegras: cada uma tem AggregatedHealthState: OK</span><span class="sxs-lookup"><span data-stu-id="b9379-123">All the replicas themselves are healthy: Each has AggregatedHealthState : Ok</span></span>
2. <span data-ttu-id="b9379-124">No momento, a restrição de distribuição Domínio de Atualização está sendo violada.</span><span class="sxs-lookup"><span data-stu-id="b9379-124">The Upgrade Domain distribution constraint is currently being violated.</span></span> <span data-ttu-id="b9379-125">Isso significa que um determinado Domínio de Atualização tem mais réplicas desta partição do que deveria.</span><span class="sxs-lookup"><span data-stu-id="b9379-125">This means a particular Upgrade Domain has more replicas from this partition than it should.</span></span>
3. <span data-ttu-id="b9379-126">Qual nó contém a réplica que está causando a violação.</span><span class="sxs-lookup"><span data-stu-id="b9379-126">Which node contains the replica causing the violation.</span></span> <span data-ttu-id="b9379-127">Nesse caso, é o nó com o nome "Node.8"</span><span class="sxs-lookup"><span data-stu-id="b9379-127">In this case it's the node with the name "Node.8"</span></span>
4. <span data-ttu-id="b9379-128">Se uma atualização estiver ocorrendo no momento para essa partição ("Atualmente em Atualização - falso")</span><span class="sxs-lookup"><span data-stu-id="b9379-128">Whether an upgrade is currently happening for this partition ("Currently Upgrading -- false")</span></span>
5. <span data-ttu-id="b9379-129">A política de distribuição para esse serviço: "Política de Distribuição -- Empacotamento".</span><span class="sxs-lookup"><span data-stu-id="b9379-129">The distribution policy for this service: "Distribution Policy -- Packing".</span></span> <span data-ttu-id="b9379-130">Isso é controlado pela [política de posicionamento](service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies.md#requiring-replica-distribution-and-disallowing-packing) do `RequireDomainDistribution`.</span><span class="sxs-lookup"><span data-stu-id="b9379-130">This is governed by the `RequireDomainDistribution` [placement policy](service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies.md#requiring-replica-distribution-and-disallowing-packing).</span></span> <span data-ttu-id="b9379-131">"Empacotamento" indica que, nesse caso, DomainDistribution _não_ era necessária, portanto sabemos que a política de posicionamento não era especificada para esse serviço.</span><span class="sxs-lookup"><span data-stu-id="b9379-131">"Packing" indicates that in this case DomainDistribution was _not_ required, so we know that placement policy was not specified for this service.</span></span> 
6. <span data-ttu-id="b9379-132">Quando o relatório ocorreu (10/08/2015 19:13:02)</span><span class="sxs-lookup"><span data-stu-id="b9379-132">When the report happened - 8/10/2015 7:13:02 PM</span></span>

<span data-ttu-id="b9379-133">Informações sobre como isso gera alertas que são disparados na produção, para que você saiba que algo deu errado. Também são usadas para detectar e impedir atualizações inválidas.</span><span class="sxs-lookup"><span data-stu-id="b9379-133">Information like this powers alerts that fire in production to let you know something has gone wrong and is also used to detect and halt bad upgrades.</span></span> <span data-ttu-id="b9379-134">Nesse caso, queremos ver se conseguimos descobrir por que o Resource Manager precisou empacotar as réplicas no Domínio de Atualização.</span><span class="sxs-lookup"><span data-stu-id="b9379-134">In this case, we’d want to see if we can figure out why the Resource Manager had to pack the replicas into the Upgrade Domain.</span></span> <span data-ttu-id="b9379-135">Normalmente, o empacotamento é temporário, pois os nós em outros Domínios de Atualização estavam inativos, por exemplo.</span><span class="sxs-lookup"><span data-stu-id="b9379-135">Usually packing is transient because the nodes in the other Upgrade Domains were down, for example.</span></span>

<span data-ttu-id="b9379-136">Digamos que o Gerenciador de Recursos de Cluster esteja tentando posicionar alguns serviços, mas nenhuma solução parece funcionar.</span><span class="sxs-lookup"><span data-stu-id="b9379-136">Let’s say the Cluster Resource Manager is trying to place some services, but there aren't any solutions that work.</span></span> <span data-ttu-id="b9379-137">Quando os serviços não podem ser posicionados, normalmente é por um dos seguintes motivos:</span><span class="sxs-lookup"><span data-stu-id="b9379-137">When services can't be placed, it is usually for one of the following reasons:</span></span>

1. <span data-ttu-id="b9379-138">Alguma condição temporária impossibilitou o posicionamento correto dessa instância de serviço ou dessa réplica</span><span class="sxs-lookup"><span data-stu-id="b9379-138">Some transient condition has made it impossible to place this service instance or replica correctly</span></span>
2. <span data-ttu-id="b9379-139">Os requisitos de posicionamento do serviço não podem ser atendidos.</span><span class="sxs-lookup"><span data-stu-id="b9379-139">The service’s placement requirements are unsatisfiable.</span></span>

<span data-ttu-id="b9379-140">Nesses casos, os relatórios de integridade do Gerenciador de Recursos de Cluster ajudarão você a determinar por que o serviço não pode ser posicionado.</span><span class="sxs-lookup"><span data-stu-id="b9379-140">In these cases, health reports from the Cluster Resource Manager help you determine why the service can’t be placed.</span></span> <span data-ttu-id="b9379-141">Chamamos esse processo de sequência de eliminação de restrição.</span><span class="sxs-lookup"><span data-stu-id="b9379-141">We call this process the constraint elimination sequence.</span></span> <span data-ttu-id="b9379-142">Durante o processo, o sistema percorre as restrições configuradas que afetam o serviço e os registros que eliminam.</span><span class="sxs-lookup"><span data-stu-id="b9379-142">During it, the system walks through the configured constraints affecting the service and records what they eliminate.</span></span> <span data-ttu-id="b9379-143">Dessa forma, quando os serviços não podem ser posicionados, você pode ver quais nós foram eliminados e por quê.</span><span class="sxs-lookup"><span data-stu-id="b9379-143">This way when services aren’t able to be placed, you can see which nodes were eliminated and why.</span></span>

## <a name="constraint-types"></a><span data-ttu-id="b9379-144">Tipos de restrição</span><span class="sxs-lookup"><span data-stu-id="b9379-144">Constraint types</span></span>
<span data-ttu-id="b9379-145">Vamos falar sobre cada uma das diferentes restrições nesses relatórios de integridade.</span><span class="sxs-lookup"><span data-stu-id="b9379-145">Let’s talk about each of the different constraints in these health reports.</span></span> <span data-ttu-id="b9379-146">Você verá mensagens de integridade relacionadas a essas restrições quando não for possível posicionar as réplicas.</span><span class="sxs-lookup"><span data-stu-id="b9379-146">You will see health messages related to these constraints when replicas can't be placed.</span></span>

* <span data-ttu-id="b9379-147">**ReplicaExclusionStatic** e **ReplicaExclusionDynamic**: essas restrições indicam que uma solução foi rejeitada porque dois objetos de serviço da mesma partição precisariam ser colocadas no mesmo nó.</span><span class="sxs-lookup"><span data-stu-id="b9379-147">**ReplicaExclusionStatic** and **ReplicaExclusionDynamic**: These constraints indicates that a solution was rejected because two service objects from the same partition would have to be placed on the same node.</span></span> <span data-ttu-id="b9379-148">Isso não é permitido, pois a falha desse nó afetaria demais nessa partição.</span><span class="sxs-lookup"><span data-stu-id="b9379-148">This isn’t allowed because then failure of that node would overly impact that partition.</span></span> <span data-ttu-id="b9379-149">ReplicaExclusionStatic e ReplicaExclusionDynamic são regras quase idênticas, e as diferenças não importam.</span><span class="sxs-lookup"><span data-stu-id="b9379-149">ReplicaExclusionStatic and ReplicaExclusionDynamic are almost the same rule and the differences don't really matter.</span></span> <span data-ttu-id="b9379-150">Se você estiver vendo uma sequência de eliminação de restrição contendo a restrição ReplicaExclusionStatic ou ReplicaExclusionDynamic, o Cluster Resource Manager considerará que não existem nós válidos suficientes.</span><span class="sxs-lookup"><span data-stu-id="b9379-150">If you are seeing a constraint elimination sequence containing either the ReplicaExclusionStatic or ReplicaExclusionDynamic constraint, the Cluster Resource Manager thinks that there aren’t enough nodes.</span></span> <span data-ttu-id="b9379-151">Isso exige que as soluções restantes usem esses posicionamentos inválidos que não têm permissão.</span><span class="sxs-lookup"><span data-stu-id="b9379-151">This requires remaining solutions to use these invalid placements which are disallowed.</span></span> <span data-ttu-id="b9379-152">As outras restrições na sequência normalmente nos contarão o motivo de os nós estarem sendo eliminados em primeiro lugar.</span><span class="sxs-lookup"><span data-stu-id="b9379-152">The other constraints in the sequence will usually tell us why nodes are being eliminated in the first place.</span></span>
* <span data-ttu-id="b9379-153">**PlacementConstraint**: se você encontrar essa mensagem, significa que eliminamos alguns nós porque eles não correspondiam a restrições de posicionamento do serviço.</span><span class="sxs-lookup"><span data-stu-id="b9379-153">**PlacementConstraint**: If you see this message, it means that we eliminated some nodes because they didn’t match the service’s placement constraints.</span></span> <span data-ttu-id="b9379-154">Rastreamos as restrições de posicionamento configuradas atualmente como parte dessa mensagem.</span><span class="sxs-lookup"><span data-stu-id="b9379-154">We trace out the currently configured placement constraints as a part of this message.</span></span> <span data-ttu-id="b9379-155">Isso é normal se houver restrições de posicionamento em vigor.</span><span class="sxs-lookup"><span data-stu-id="b9379-155">This is normal if you have a placement constraint defined.</span></span> <span data-ttu-id="b9379-156">No entanto, se a restrição de posicionamento estiver causando incorretamente a eliminação de muitos nós, isso será notado aqui.</span><span class="sxs-lookup"><span data-stu-id="b9379-156">However, if placement constraint is incorrectly causing too many nodes to be eliminated this is how you would notice.</span></span>
* <span data-ttu-id="b9379-157">**NodeCapacity**: essa restrição significa que o Gerenciador de Recursos de Cluster não conseguiu posicionar as réplicas nos nós indicados, pois isso faria com que o nó ficasse acima da capacidade.</span><span class="sxs-lookup"><span data-stu-id="b9379-157">**NodeCapacity**: This constraint means that the Cluster Resource Manager couldn’t place the replicas on the indicated nodes because that would put them over capacity.</span></span>
* <span data-ttu-id="b9379-158">**Affinity**: essa restrição indica que não é possível colocar a réplica nos nós afetados, pois isso causaria uma violação da restrição de afinidade.</span><span class="sxs-lookup"><span data-stu-id="b9379-158">**Affinity**: This constraint indicates that we couldn’t place the replica on the affected nodes since it would cause a violation of the affinity constraint.</span></span> <span data-ttu-id="b9379-159">Veja mais informações sobre afinidade [neste artigo](service-fabric-cluster-resource-manager-advanced-placement-rules-affinity.md)</span><span class="sxs-lookup"><span data-stu-id="b9379-159">More information on affinity is in [this article](service-fabric-cluster-resource-manager-advanced-placement-rules-affinity.md)</span></span>
* <span data-ttu-id="b9379-160">**FaultDomain** e **UpgradeDomain**: essa restrição elimina nós se o posicionamento da réplica nos nós indicados causar empacotamento em um domínio de atualização ou de falha específico.</span><span class="sxs-lookup"><span data-stu-id="b9379-160">**FaultDomain** and **UpgradeDomain**: This constraint eliminates nodes if placing the replica on the indicated nodes would cause packing in a particular fault or upgrade domain.</span></span> <span data-ttu-id="b9379-161">Há vários exemplos que discutem essa restrição no tópico sobre [restrições de domínio de falha e de atualização e o comportamento resultante](service-fabric-cluster-resource-manager-cluster-description.md)</span><span class="sxs-lookup"><span data-stu-id="b9379-161">Several examples discussing this constraint are presented in the topic on [fault and upgrade domain constraints and resulting behavior](service-fabric-cluster-resource-manager-cluster-description.md)</span></span>
* <span data-ttu-id="b9379-162">**PreferredLocation**: normalmente, você não veria essa restrição removendo os nós da solução, já que ela é executada como uma otimização por padrão.</span><span class="sxs-lookup"><span data-stu-id="b9379-162">**PreferredLocation**: You shouldn’t normally see this constraint removing nodes from the solution since it runs as an optimization by default.</span></span> <span data-ttu-id="b9379-163">Além disso, a restrição de local preferencial também está presente durante as atualizações.</span><span class="sxs-lookup"><span data-stu-id="b9379-163">The preferred location constraint is also present during upgrades.</span></span> <span data-ttu-id="b9379-164">Durante a atualização, ela é usada para mover os serviços para onde estavam quando a atualização foi iniciada.</span><span class="sxs-lookup"><span data-stu-id="b9379-164">During upgrade it is used to move services back to where they were when the upgrade started.</span></span>

## <a name="blocklisting-nodes"></a><span data-ttu-id="b9379-165">Incluir os nós em lista de bloqueio</span><span class="sxs-lookup"><span data-stu-id="b9379-165">Blocklisting Nodes</span></span>
<span data-ttu-id="b9379-166">Outra mensagem de integridade reportada pelo Gerenciador de Recursos de Cluster é quando os nós são incluídos em uma lista de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="b9379-166">Another health message the Cluster Resource Manager reports is when nodes are blocklisted.</span></span> <span data-ttu-id="b9379-167">Você pode pensar na inclusão em uma lista de bloqueio como uma restrição temporária aplicada automaticamente a você.</span><span class="sxs-lookup"><span data-stu-id="b9379-167">You can think of blocklisting as a temporary constraint that is automatically applied for you.</span></span> <span data-ttu-id="b9379-168">Os nós são incluídos na lista de bloqueio quando sofrem falhas repetidas ao iniciar instâncias desse tipo de serviço.</span><span class="sxs-lookup"><span data-stu-id="b9379-168">Nodes get blocklisted when they experience repeated failures when launching instances of that service type.</span></span> <span data-ttu-id="b9379-169">Os nós são incluídos em uma lista de bloqueio de acordo com o tipo de serviço.</span><span class="sxs-lookup"><span data-stu-id="b9379-169">Nodes are blocklisted on a per-service-type basis.</span></span> <span data-ttu-id="b9379-170">Um nó pode ser incluído em uma lista de bloqueio para um tipo de serviço, mas não outro.</span><span class="sxs-lookup"><span data-stu-id="b9379-170">A node may be blocklisted for one service type but not another.</span></span> 

<span data-ttu-id="b9379-171">Você verá a inclusão em uma lista de bloqueio ocorrer com frequência durante o desenvolvimento: alguns bugs fazem com que o host de serviço falhe na inicialização.</span><span class="sxs-lookup"><span data-stu-id="b9379-171">You'll see blocklisting kick in often during development: some bug causes your service host to crash on startup.</span></span> <span data-ttu-id="b9379-172">O Service Fabric tenta criar o host de serviço algumas vezes, e a falha continua ocorrendo.</span><span class="sxs-lookup"><span data-stu-id="b9379-172">Service Fabric tries to create the service host a few times, and the failure keeps occurring.</span></span> <span data-ttu-id="b9379-173">Após algumas tentativas, o nó é incluído em uma lista de bloqueio, e o Gerenciador de Recursos de Cluster tentará criar o serviço em outro lugar.</span><span class="sxs-lookup"><span data-stu-id="b9379-173">After a few attempts, the node gets blocklisted, and the Cluster Resource Manager will try to create the service elsewhere.</span></span> <span data-ttu-id="b9379-174">Se essa falha continuar acontecendo em vários nós, talvez todos os nós válidos no cluster acabem bloqueados.</span><span class="sxs-lookup"><span data-stu-id="b9379-174">If that failure keeps happening on multiple nodes, it's possible that all of the valid nodes in the cluster end up blocked.</span></span> <span data-ttu-id="b9379-175">A inclusão na lista de bloqueio também pode remover vários nós não conseguem iniciar o serviço a fim de atender à escala desejada.</span><span class="sxs-lookup"><span data-stu-id="b9379-175">Blocklisting cna also remove so many nodes that not enough can successfully launch the service to meet the desired scale.</span></span> <span data-ttu-id="b9379-176">Normalmente, você verá erros ou avisos adicionais do Gerenciador de Recursos de Cluster, indicando que o serviço está abaixo da contagem desejada de réplicas ou de instâncias, bem como mensagens de integridade indicando o motivo da falha que está gerando a inclusão na lista de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="b9379-176">You'll typically see additional errors or warnings from the Cluster Resource Manager indicating that the service is below the desired replica or instance count, as well as health messages indicating what the failure is that's leading to the blocklisting in the first place.</span></span>

<span data-ttu-id="b9379-177">A inclusão na lista de bloqueio não é uma condição permanente.</span><span class="sxs-lookup"><span data-stu-id="b9379-177">Blocklisting is not a permanent condition.</span></span> <span data-ttu-id="b9379-178">Após alguns minutos, o nó é removido da lista de bloqueios, e o Service Fabric pode ativar novamente os serviços nesse nó.</span><span class="sxs-lookup"><span data-stu-id="b9379-178">After a few minutes, the node is removed from the blocklist and Service Fabric may activate the services on that node again.</span></span> <span data-ttu-id="b9379-179">Se os serviços continuarem falhando, o nó será incluído na lista de bloqueio para esse tipo de serviço novamente.</span><span class="sxs-lookup"><span data-stu-id="b9379-179">If services continue to fail, the node is blocklisted for that service type again.</span></span> 

### <a name="constraint-priorities"></a><span data-ttu-id="b9379-180">Prioridades de restrição</span><span class="sxs-lookup"><span data-stu-id="b9379-180">Constraint priorities</span></span>

> [!WARNING]
> <span data-ttu-id="b9379-181">A alteração das prioridades de restrição não é recomendada e pode ter efeitos adversos consideráveis em seu cluster.</span><span class="sxs-lookup"><span data-stu-id="b9379-181">Changing constraint priorities is not recommended and may have significant adverse effects on your cluster.</span></span> <span data-ttu-id="b9379-182">As informações abaixo são fornecidas para referência das prioridades de restrição padrão e seu comportamento.</span><span class="sxs-lookup"><span data-stu-id="b9379-182">The below information is provided for reference of the default constraint priorities and their behavior.</span></span> 
>

<span data-ttu-id="b9379-183">Em todas essas restrições, você pode ter pensado “Ei, acho que restrições de domínio de falha são a coisa mais importante em meu sistema.</span><span class="sxs-lookup"><span data-stu-id="b9379-183">With all of these constraints, you may have been thinking “Hey – I think that fault domain constraints are the most important thing in my system.</span></span> <span data-ttu-id="b9379-184">Para garantir a não violação da restrição de domínio de falha, estou disposto(a) a violar outras restrições."</span><span class="sxs-lookup"><span data-stu-id="b9379-184">In order to ensure the fault domain constraint isn't violated, I’m willing to violate other constraints.”</span></span>

<span data-ttu-id="b9379-185">As restrições podem ser configuradas com níveis de prioridade diferentes.</span><span class="sxs-lookup"><span data-stu-id="b9379-185">Constraints can be configured with different priority levels.</span></span> <span data-ttu-id="b9379-186">Estes são:</span><span class="sxs-lookup"><span data-stu-id="b9379-186">These are:</span></span>

   - <span data-ttu-id="b9379-187">"inflexível" (0)</span><span class="sxs-lookup"><span data-stu-id="b9379-187">“hard” (0)</span></span>
   - <span data-ttu-id="b9379-188">"flexível" (1)</span><span class="sxs-lookup"><span data-stu-id="b9379-188">“soft” (1)</span></span>
   - <span data-ttu-id="b9379-189">"otimização” (2)</span><span class="sxs-lookup"><span data-stu-id="b9379-189">“optimization” (2)</span></span>
   - <span data-ttu-id="b9379-190">"desativado" (-1).</span><span class="sxs-lookup"><span data-stu-id="b9379-190">“off” (-1).</span></span> 
   
<span data-ttu-id="b9379-191">A maioria das restrições é configurada como inflexível por padrão.</span><span class="sxs-lookup"><span data-stu-id="b9379-191">Most of the constraints are configured as hard constraints by default.</span></span>

<span data-ttu-id="b9379-192">A alteração da prioridade das restrições é incomum.</span><span class="sxs-lookup"><span data-stu-id="b9379-192">Changing the priority of constraints is uncommon.</span></span> <span data-ttu-id="b9379-193">Às vezes, era necessário alterar as prioridades de restrição, normalmente para solucionar alguns bugs ou comportamento que estava afetando o ambiente.</span><span class="sxs-lookup"><span data-stu-id="b9379-193">There have been times where constraint priorities needed to change, usually to work around some other bug or behavior that was impacting the environment.</span></span> <span data-ttu-id="b9379-194">Em geral, a flexibilidade da infraestrutura de prioridade da restrição funcionou muito bem, mas ela não é necessário com tanta frequência.</span><span class="sxs-lookup"><span data-stu-id="b9379-194">Generally the flexibility of the constraint priority infrastructure has worked very well, but it isn't needed often.</span></span> <span data-ttu-id="b9379-195">Na maioria das vezes, tudo fica em suas prioridades padrão.</span><span class="sxs-lookup"><span data-stu-id="b9379-195">Most of the time everything sits at their default priorities.</span></span> 

<span data-ttu-id="b9379-196">A existência dos níveis de prioridade não significa que uma certa restrição _será_ violada, nem que sempre será atendida.</span><span class="sxs-lookup"><span data-stu-id="b9379-196">The priority levels don't mean that a given constraint _will_ be violated, nor that it will always be met.</span></span> <span data-ttu-id="b9379-197">As prioridades de restrição definem uma ordem de imposição das restrições.</span><span class="sxs-lookup"><span data-stu-id="b9379-197">Constraint priorities define an order in which constraints are enforced.</span></span> <span data-ttu-id="b9379-198">As prioridades definem as compensações quando não é possível atender a todas as restrições.</span><span class="sxs-lookup"><span data-stu-id="b9379-198">Priorities define the tradeoffs when it is impossible to satisfy all constraints.</span></span> <span data-ttu-id="b9379-199">Geralmente, todas as restrições podem ser atendidas, exceto se algo a mais estiver ocorrendo no ambiente.</span><span class="sxs-lookup"><span data-stu-id="b9379-199">Usually all the constraints can be satisfied unless there's something else going on in the environment.</span></span> <span data-ttu-id="b9379-200">Entre os exemplos de cenários que causarão violações de restrição estão as restrições conflitantes ou muitas falhas simultâneas.</span><span class="sxs-lookup"><span data-stu-id="b9379-200">Some examples of scenarios that will lead to constraint violations are conflicting constraints, or large numbers of concurrent failures.</span></span>

<span data-ttu-id="b9379-201">Em situações avançadas, é possível alterar as prioridades de restrição.</span><span class="sxs-lookup"><span data-stu-id="b9379-201">In advanced situations, you can change the constraint priorities.</span></span> <span data-ttu-id="b9379-202">Por exemplo, digamos que você queira garantir que a afinidade seja sempre violada quando for necessário solucionar problemas de capacidade do nó.</span><span class="sxs-lookup"><span data-stu-id="b9379-202">For example, say you wanted to ensure that affinity would always be violated when necessary to solve node capacity issues.</span></span> <span data-ttu-id="b9379-203">Para fazer isso, você poderia definir a prioridade da restrição de afinidade como “flexível” (1) e deixar a restrição de capacidade definida como “inflexível” (0).</span><span class="sxs-lookup"><span data-stu-id="b9379-203">To achieve this, you could set the priority of the affinity constraint to “soft” (1) and leave the capacity constraint set to “hard” (0).</span></span>

<span data-ttu-id="b9379-204">Os valores de prioridade padrão para as diferentes restrições são especificados na configuração a seguir:</span><span class="sxs-lookup"><span data-stu-id="b9379-204">The default priority values for the different constraints are specified in the following config:</span></span>

<span data-ttu-id="b9379-205">ClusterManifest.xml</span><span class="sxs-lookup"><span data-stu-id="b9379-205">ClusterManifest.xml</span></span>

```xml
        <Section Name="PlacementAndLoadBalancing">
            <Parameter Name="PlacementConstraintPriority" Value="0" />
            <Parameter Name="CapacityConstraintPriority" Value="0" />
            <Parameter Name="AffinityConstraintPriority" Value="0" />
            <Parameter Name="FaultDomainConstraintPriority" Value="0" />
            <Parameter Name="UpgradeDomainConstraintPriority" Value="1" />
            <Parameter Name="PreferredLocationConstraintPriority" Value="2" />
        </Section>
```

<span data-ttu-id="b9379-206">via ClusterConfig.json para implantações Autônomas ou Template.json para clusters hospedados pelo Azure:</span><span class="sxs-lookup"><span data-stu-id="b9379-206">via ClusterConfig.json for Standalone deployments or Template.json for Azure hosted clusters:</span></span>

```json
"fabricSettings": [
  {
    "name": "PlacementAndLoadBalancing",
    "parameters": [
      {
          "name": "PlacementConstraintPriority",
          "value": "0"
      },
      {
          "name": "CapacityConstraintPriority",
          "value": "0"
      },
      {
          "name": "AffinityConstraintPriority",
          "value": "0"
      },
      {
          "name": "FaultDomainConstraintPriority",
          "value": "0"
      },
      {
          "name": "UpgradeDomainConstraintPriority",
          "value": "1"
      },
      {
          "name": "PreferredLocationConstraintPriority",
          "value": "2"
      }
    ]
  }
]
```

## <a name="fault-domain-and-upgrade-domain-constraints"></a><span data-ttu-id="b9379-207">Restrições de domínio de falha e de atualização</span><span class="sxs-lookup"><span data-stu-id="b9379-207">Fault domain and upgrade domain constraints</span></span>
<span data-ttu-id="b9379-208">O Gerenciador de Recursos de Cluster deseja manter os serviços distribuídos entre domínios de falha e de atualização.</span><span class="sxs-lookup"><span data-stu-id="b9379-208">The Cluster Resource Manager wants to keep services spread out among fault and upgrade domains.</span></span> <span data-ttu-id="b9379-209">Ele simula isso como uma restrição dentro do mecanismo do Gerenciador de Recursos de Cluster.</span><span class="sxs-lookup"><span data-stu-id="b9379-209">It models this as a constraint inside the Cluster Resource Manager’s engine.</span></span> <span data-ttu-id="b9379-210">Para saber mais sobre como eles são usados e o comportamento específico, confira o artigo na [configuração de cluster](service-fabric-cluster-resource-manager-cluster-description.md#fault-and-upgrade-domain-constraints-and-resulting-behavior).</span><span class="sxs-lookup"><span data-stu-id="b9379-210">For more information on how they are used and their specific behavior, check out the article on [cluster configuration](service-fabric-cluster-resource-manager-cluster-description.md#fault-and-upgrade-domain-constraints-and-resulting-behavior).</span></span>

<span data-ttu-id="b9379-211">O Gerenciador de Recursos de Cluster pode precisar empacotar algumas réplicas em um domínio de atualização para lidar com atualizações, falhas ou outras violações de restrição.</span><span class="sxs-lookup"><span data-stu-id="b9379-211">The Cluster Resource Manager may need to pack a couple replicas into an upgrade domain in order to deal with upgrades, failures, or other constraint violations.</span></span> <span data-ttu-id="b9379-212">O empacotamento dentro de domínios de falha ou de atualização normalmente ocorre somente quando há várias falhas ou outra variação no sistema que impede o posicionamento correto.</span><span class="sxs-lookup"><span data-stu-id="b9379-212">Packing into fault or upgrade domains normally happens only when there are several failures or other churn in the system preventing correct placement.</span></span> <span data-ttu-id="b9379-213">Se você quiser evitar o empacotamento mesmo durante essas situações, você pode utilizar a [política de posicionamento](service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies.md#requiring-replica-distribution-and-disallowing-packing) do `RequireDomainDistribution`.</span><span class="sxs-lookup"><span data-stu-id="b9379-213">If you wish to prevent packing even during these situations, you can utilize the `RequireDomainDistribution` [placement policy](service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies.md#requiring-replica-distribution-and-disallowing-packing).</span></span> <span data-ttu-id="b9379-214">Observe que isso pode afetar a disponibilidade e a confiabilidade do serviço como um efeito colateral, portanto, considere com cuidado.</span><span class="sxs-lookup"><span data-stu-id="b9379-214">Note that this may affect service availability and reliability as a side effect, so consider it carefully.</span></span>

<span data-ttu-id="b9379-215">Se o ambiente estiver configurado corretamente, todas as restrições serão totalmente respeitadas, mesmo durante as atualizações.</span><span class="sxs-lookup"><span data-stu-id="b9379-215">If the environment is configured correctly, all constraints are fully respected, even during upgrades.</span></span> <span data-ttu-id="b9379-216">O mais importante é que o Gerenciador de Recursos de Cluster esteja observando suas restrições.</span><span class="sxs-lookup"><span data-stu-id="b9379-216">The key thing is that the Cluster Resource Manager is watching out for your constraints.</span></span> <span data-ttu-id="b9379-217">Ao detectar uma violação, ele imediatamente informa e tenta corrigir o problema.</span><span class="sxs-lookup"><span data-stu-id="b9379-217">When it detects a violation it immediately reports it and tries to correct the issue.</span></span>

## <a name="the-preferred-location-constraint"></a><span data-ttu-id="b9379-218">A restrição do local preferencial</span><span class="sxs-lookup"><span data-stu-id="b9379-218">The preferred location constraint</span></span>
<span data-ttu-id="b9379-219">A restrição PreferredLocation é um pouco diferente, pois tem dois usos diferentes.</span><span class="sxs-lookup"><span data-stu-id="b9379-219">The PreferredLocation constraint is a little different, as it has two different uses.</span></span> <span data-ttu-id="b9379-220">Uma utilização dessa restrição ocorre durante as atualizações de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="b9379-220">One use of this constraint is during application upgrades.</span></span> <span data-ttu-id="b9379-221">O Gerenciador de Recursos de Cluster gerencia automaticamente essa restrição durante as atualizações.</span><span class="sxs-lookup"><span data-stu-id="b9379-221">The Cluster Resource Manager automatically manages this constraint during upgrades.</span></span> <span data-ttu-id="b9379-222">Ele é usado para garantir que, após a conclusão das atualizações, as réplicas retornem aos seus locais inicias.</span><span class="sxs-lookup"><span data-stu-id="b9379-222">It is used to ensure that when upgrades are complete that replicas return to their initial locations.</span></span> <span data-ttu-id="b9379-223">Outro uso da restrição PreferredLocation destina-se à [`PreferredPrimaryDomain` política de posicionamento](service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies.md) do.</span><span class="sxs-lookup"><span data-stu-id="b9379-223">The other use of the PreferredLocation constraint is for the [`PreferredPrimaryDomain` placement policy](service-fabric-cluster-resource-manager-advanced-placement-rules-placement-policies.md).</span></span> <span data-ttu-id="b9379-224">Ambos são otimizações e, então, a restrição PreferredLocation é a única restrição definida como "Otimização" por padrão.</span><span class="sxs-lookup"><span data-stu-id="b9379-224">Both of these are optimizations, and hence the PreferredLocation constraint is the only constraint set to "Optimization" by default.</span></span>

## <a name="upgrades"></a><span data-ttu-id="b9379-225">Atualizações</span><span class="sxs-lookup"><span data-stu-id="b9379-225">Upgrades</span></span>
<span data-ttu-id="b9379-226">O Cluster Resource Manager também ajuda durante atualizações de aplicativos e clusters, quando então ele tem dois trabalhos:</span><span class="sxs-lookup"><span data-stu-id="b9379-226">The Cluster Resource Manager also helps during application and cluster upgrades, during which it has two jobs:</span></span>

* <span data-ttu-id="b9379-227">verificar se as regras do cluster não foram comprometidos</span><span class="sxs-lookup"><span data-stu-id="b9379-227">ensure that the rules of the cluster are not compromised</span></span>
* <span data-ttu-id="b9379-228">tentar ajudar a atualização a ocorrer sem problemas</span><span class="sxs-lookup"><span data-stu-id="b9379-228">try to help the upgrade go smoothly</span></span>

### <a name="keep-enforcing-the-rules"></a><span data-ttu-id="b9379-229">Manter a imposição das regras</span><span class="sxs-lookup"><span data-stu-id="b9379-229">Keep enforcing the rules</span></span>
<span data-ttu-id="b9379-230">O principal a ser observado são se as regras, restrições rígidas sobre coisas como restrições de posicionamento e capacidades, ainda são impostas durante as atualizações.</span><span class="sxs-lookup"><span data-stu-id="b9379-230">The main thing to be aware of is that the rules – the strict constraints like placement constraints and capacities - are still enforced during upgrades.</span></span> <span data-ttu-id="b9379-231">Restrições de posicionamento garantem que suas cargas de trabalho serão executadas apenas onde elas são permitidas, mesmo durante atualizações.</span><span class="sxs-lookup"><span data-stu-id="b9379-231">Placement constraints ensure that your workloads only run where they are allowed to, even during upgrades.</span></span> <span data-ttu-id="b9379-232">Quando os serviços forem altamente restritos, as atualizações podem demorar mais.</span><span class="sxs-lookup"><span data-stu-id="b9379-232">When services are highly constrained, upgrades can take longer.</span></span> <span data-ttu-id="b9379-233">Quando o serviço, ou o nó onde ele está em execução, ficar inativo devido a uma atualização, você terá algumas opções.</span><span class="sxs-lookup"><span data-stu-id="b9379-233">When the service or the node it is running on is brought down for an update there may be few options for where it can go.</span></span>

### <a name="smart-replacements"></a><span data-ttu-id="b9379-234">Substituições inteligentes</span><span class="sxs-lookup"><span data-stu-id="b9379-234">Smart replacements</span></span>
<span data-ttu-id="b9379-235">Quando uma atualização é iniciada, o Resource Manager tira um instantâneo da disposição atual do cluster.</span><span class="sxs-lookup"><span data-stu-id="b9379-235">When an upgrade starts, the Resource Manager takes a snapshot of the current arrangement of the cluster.</span></span> <span data-ttu-id="b9379-236">À medida que cada Domínio de Atualização for concluído, ele tentará retornar os serviços que estavam nesse Domínio de Atualização para a organização original.</span><span class="sxs-lookup"><span data-stu-id="b9379-236">As each Upgrade Domain completes, it attempts to return the services that were in that Upgrade Domain to their original arrangement.</span></span> <span data-ttu-id="b9379-237">Dessa forma, há no máximo duas transições para um serviço durante a atualização.</span><span class="sxs-lookup"><span data-stu-id="b9379-237">This way there are at most two transitions for a service during the upgrade.</span></span> <span data-ttu-id="b9379-238">Há uma movimentação para fora do nó afetado e uma movimentação para dentro.</span><span class="sxs-lookup"><span data-stu-id="b9379-238">There is one move out of the affected node and one move back in.</span></span> <span data-ttu-id="b9379-239">Retornar o cluster ou serviço ao estado anterior à atualização também garante que a atualização não afete o layout do cluster.</span><span class="sxs-lookup"><span data-stu-id="b9379-239">Returning the cluster or service to how it was before the upgrade also ensures the upgrade doesn’t impact the layout of the cluster.</span></span> 

### <a name="reduced-churn"></a><span data-ttu-id="b9379-240">Variação reduzida</span><span class="sxs-lookup"><span data-stu-id="b9379-240">Reduced churn</span></span>
<span data-ttu-id="b9379-241">Outra coisa que acontece durante as atualizações é que o Gerenciador de Recursos de Cluster desativa o balanceamento.</span><span class="sxs-lookup"><span data-stu-id="b9379-241">Another thing that happens during upgrades is that the Cluster Resource Manager turns off balancing.</span></span> <span data-ttu-id="b9379-242">Impedir o balanceamento impede reações desnecessárias à atualização em si, como a movimentação dos serviços para nós que foram esvaziados para a atualização.</span><span class="sxs-lookup"><span data-stu-id="b9379-242">Preventing balancing prevents unnecessary reactions to the upgrade itself, like moving services into nodes that were emptied for the upgrade.</span></span> <span data-ttu-id="b9379-243">Se a atualização em questão for uma atualização de Cluster, então o cluster inteiro não poderá ser balanceado durante a atualização.</span><span class="sxs-lookup"><span data-stu-id="b9379-243">If the upgrade in question is a Cluster upgrade, then the entire cluster is not balanced during the upgrade.</span></span> <span data-ttu-id="b9379-244">As verificações de restrição permanecem ativas, somente a movimentação com base no balanceamento proativo de métricas é desabilitada.</span><span class="sxs-lookup"><span data-stu-id="b9379-244">Constraint checks stay active, only movement based on the proactive balancing of metrics is disabled.</span></span>

### <a name="buffered-capacity--upgrade"></a><span data-ttu-id="b9379-245">Capacidade de buffer e atualização</span><span class="sxs-lookup"><span data-stu-id="b9379-245">Buffered Capacity & Upgrade</span></span>
<span data-ttu-id="b9379-246">Em geral, convém concluir a atualização mesmo se o cluster estiver sob restrição ou quase cheio.</span><span class="sxs-lookup"><span data-stu-id="b9379-246">Generally you want the upgrade to complete even if the cluster is constrained or close to full.</span></span> <span data-ttu-id="b9379-247">Ser capaz de gerenciar a capacidade do cluster é ainda mais importante do que o normal.</span><span class="sxs-lookup"><span data-stu-id="b9379-247">Managing the capacity of the cluster is even more important during upgrades than usual.</span></span> <span data-ttu-id="b9379-248">Dependendo do número de domínios de atualização, entre cinco e 20% da capacidade devem ser migradas à medida que a atualização percorre o cluster.</span><span class="sxs-lookup"><span data-stu-id="b9379-248">Depending on the number of upgrade domains, between 5 and 20 percent of capacity must be migrated as the upgrade rolls through the cluster.</span></span> <span data-ttu-id="b9379-249">Esse trabalho precisa ir para algum lugar.</span><span class="sxs-lookup"><span data-stu-id="b9379-249">That work has to go somewhere.</span></span> <span data-ttu-id="b9379-250">É aqui que a noção de [capacidades de buffer](service-fabric-cluster-resource-manager-cluster-description.md#buffered-capacity) é útil.</span><span class="sxs-lookup"><span data-stu-id="b9379-250">This is where the notion of [buffered capacities](service-fabric-cluster-resource-manager-cluster-description.md#buffered-capacity) is useful.</span></span> <span data-ttu-id="b9379-251">A capacidade de buffer é respeitada durante a operação normal.</span><span class="sxs-lookup"><span data-stu-id="b9379-251">Buffered capacity is respected during normal operation.</span></span> <span data-ttu-id="b9379-252">O Gerenciador de Recursos de Cluster pode preencher os nós até sua capacidade total (consumindo o buffer) durante as atualizações, se for necessário.</span><span class="sxs-lookup"><span data-stu-id="b9379-252">The Cluster Resource Manager may fill nodes up to their total capacity (consuming the buffer) during upgrades if necessary.</span></span>

## <a name="next-steps"></a><span data-ttu-id="b9379-253">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="b9379-253">Next steps</span></span>
* <span data-ttu-id="b9379-254">Comece do princípio e [veja uma introdução ao Resource Manager de Cluster do Service Fabric](service-fabric-cluster-resource-manager-introduction.md)</span><span class="sxs-lookup"><span data-stu-id="b9379-254">Start from the beginning and [get an Introduction to the Service Fabric Cluster Resource Manager](service-fabric-cluster-resource-manager-introduction.md)</span></span>
