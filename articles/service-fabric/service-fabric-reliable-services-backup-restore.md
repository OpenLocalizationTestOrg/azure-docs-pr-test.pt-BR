---
title: "Backup e restauração do Service Fabric | Microsoft Docs"
description: "Documentação conceitual de backup e restauração do Service Fabric"
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: subramar,jessebenson
ms.assetid: 91ea6ca4-cc2a-4155-9823-dcbd0b996349
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/18/2017
ms.author: mcoskun
ms.openlocfilehash: 4242962e7e03053ef25f198a0b2f6c8012e693eb
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/29/2017
---
# <a name="back-up-and-restore-reliable-services-and-reliable-actors"></a><span data-ttu-id="de49f-103">Fazer backup e restaurar Reliable Services e Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="de49f-103">Back up and restore Reliable Services and Reliable Actors</span></span>
<span data-ttu-id="de49f-104">O Azure Service Fabric é uma plataforma de alta disponibilidade que replica o estado em vários nós a fim de manter essa alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="de49f-104">Azure Service Fabric is a high-availability platform that replicates the state across multiple nodes to maintain this high availability.</span></span>  <span data-ttu-id="de49f-105">Portanto, mesmo se um nó do cluster falhar, os serviços continuarão disponíveis.</span><span class="sxs-lookup"><span data-stu-id="de49f-105">Thus, even if one node in the cluster fails, the services continue to be available.</span></span> <span data-ttu-id="de49f-106">Embora essa redundância interna fornecida pela plataforma possa ser suficiente para algumas pessoas, em certos casos é recomendável fazer o backup dos dados do serviço (em um repositório externo).</span><span class="sxs-lookup"><span data-stu-id="de49f-106">While this in-built redundancy provided by the platform may be sufficient for some, in certain cases it is desirable for the service to back up data (to an external store).</span></span>

> [!NOTE]
> <span data-ttu-id="de49f-107">É essencial fazer backup e restaurar seus dados (e testar se funcionam conforme esperado) para que você possa se recuperar de cenários de perda de dados.</span><span class="sxs-lookup"><span data-stu-id="de49f-107">It is critical to backup and restore your data (and test that it works as expected) so you can recover from data loss scenarios.</span></span>
> 
> 

<span data-ttu-id="de49f-108">Por exemplo, convém fazer o backup dos dados de um serviço para se proteger nos seguintes cenários:</span><span class="sxs-lookup"><span data-stu-id="de49f-108">For example, a service may want to back up data in order to protect from the following scenarios:</span></span>

- <span data-ttu-id="de49f-109">No caso de perda permanente de um cluster inteiro do Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="de49f-109">In the event of the permanent loss of an entire Service Fabric cluster.</span></span>
- <span data-ttu-id="de49f-110">Perda permanente da maioria das réplicas de uma partição de serviço</span><span class="sxs-lookup"><span data-stu-id="de49f-110">Permanent loss of a majority of the replicas of a service partition</span></span>
- <span data-ttu-id="de49f-111">Erros administrativos nos quais o estado é acidentalmente excluído ou corrompido.</span><span class="sxs-lookup"><span data-stu-id="de49f-111">Administrative errors whereby the state accidentally gets deleted or corrupted.</span></span> <span data-ttu-id="de49f-112">Por exemplo, isso pode ocorrer quando um administrador com privilégios suficientes exclui o serviço por engano.</span><span class="sxs-lookup"><span data-stu-id="de49f-112">For example, this may happen if an administrator with sufficient privilege erroneously deletes the service.</span></span>
- <span data-ttu-id="de49f-113">Bugs no serviço que venham a corromper os dados.</span><span class="sxs-lookup"><span data-stu-id="de49f-113">Bugs in the service that cause data corruption.</span></span> <span data-ttu-id="de49f-114">Por exemplo, isso pode ocorrer quando uma atualização de código de serviço inicia a gravação de dados com falha em uma coleção confiável.</span><span class="sxs-lookup"><span data-stu-id="de49f-114">For example, this may happen when a service code upgrade starts writing faulty data to a Reliable Collection.</span></span> <span data-ttu-id="de49f-115">Nesse caso, convém reverter o código e os dados para um estado anterior.</span><span class="sxs-lookup"><span data-stu-id="de49f-115">In such a case, both the code and the data may have to be reverted to an earlier state.</span></span>
- <span data-ttu-id="de49f-116">Processamento de dados offline.</span><span class="sxs-lookup"><span data-stu-id="de49f-116">Offline data processing.</span></span> <span data-ttu-id="de49f-117">Talvez seja conveniente processar no modo offline os dados de business intelligence que ocorrem separadamente do serviço que gera os dados.</span><span class="sxs-lookup"><span data-stu-id="de49f-117">It might be convenient to have offline processing of data for business intelligence that happens separately from the service that generates the data.</span></span>

<span data-ttu-id="de49f-118">O recurso de Backup/Restauração permite que os serviços criados na API de Reliable Services criem e restaurem os backups.</span><span class="sxs-lookup"><span data-stu-id="de49f-118">The Backup/Restore feature allows services built on the Reliable Services API to create and restore backups.</span></span> <span data-ttu-id="de49f-119">As APIs de backup fornecidas pela plataforma permitem fazer backups do estado de uma partição de serviço, sem bloquear operações de leitura ou gravação.</span><span class="sxs-lookup"><span data-stu-id="de49f-119">The backup APIs provided by the platform allow backup(s) of a service partition's state, without blocking read or write operations.</span></span> <span data-ttu-id="de49f-120">As APIs de restauração permitem que o estado de uma partição de serviço seja restaurado de um backup escolhido.</span><span class="sxs-lookup"><span data-stu-id="de49f-120">The restore APIs allow a service partition's state to be restored from a chosen backup.</span></span>

## <a name="types-of-backup"></a><span data-ttu-id="de49f-121">Tipos de Backup</span><span class="sxs-lookup"><span data-stu-id="de49f-121">Types of Backup</span></span>
<span data-ttu-id="de49f-122">Há duas opções de backup: Completo e Incremental.</span><span class="sxs-lookup"><span data-stu-id="de49f-122">There are two backup options: Full and Incremental.</span></span>
<span data-ttu-id="de49f-123">Um backup completo é um backup que contém todos os dados necessários para recriar o estado da réplica: pontos de verificação e todos os registros de log.</span><span class="sxs-lookup"><span data-stu-id="de49f-123">A full backup is a backup that contains all the data required to recreate the state of the replica: checkpoints and all log records.</span></span>
<span data-ttu-id="de49f-124">Como ele tem os pontos de verificação e o log, um backup completo pode ser restaurado por si só.</span><span class="sxs-lookup"><span data-stu-id="de49f-124">Since it has the checkpoints and the log, a full backup can be restored by itself.</span></span>

<span data-ttu-id="de49f-125">O problema com backups completos surge quando os pontos de verificação são grandes.</span><span class="sxs-lookup"><span data-stu-id="de49f-125">The problem with full backups arises when the checkpoints are large.</span></span>
<span data-ttu-id="de49f-126">Por exemplo, uma réplica que tem 16 GB de estado terá pontos de verificação que podem chegar a aproximadamente 16 GB.</span><span class="sxs-lookup"><span data-stu-id="de49f-126">For example, a replica that has 16 GB of state will have checkpoints that add up approximately to 16 GB.</span></span>
<span data-ttu-id="de49f-127">Caso tenhamos um Objetivo de Ponto de Recuperação de cinco minutos, deve-se fazer backup da réplica a cada cinco minutos.</span><span class="sxs-lookup"><span data-stu-id="de49f-127">If we have a Recovery Point Objective of five minutes, the replica needs to be backed up every five minutes.</span></span>
<span data-ttu-id="de49f-128">Cada vez que o backup for feito, será necessário copiar 16 GB de pontos de verificação além de 50 MB (configurável usando `CheckpointThresholdInMB`) em logs.</span><span class="sxs-lookup"><span data-stu-id="de49f-128">Each time it backs up it needs to copy 16 GB of checkpoints in addition to 50 MB (configurable using `CheckpointThresholdInMB`) worth of logs.</span></span>

![Exemplo de Backup Completo.](media/service-fabric-reliable-services-backup-restore/FullBackupExample.PNG)

<span data-ttu-id="de49f-130">A solução para esse problema é fazer backups incrementais, em que o backup contém apenas os registros de log alterados desde o último backup.</span><span class="sxs-lookup"><span data-stu-id="de49f-130">The solution to this problem is incremental backups, where backup only contains the changed log records since the last backup.</span></span>

![Exemplo de Backup Incremental.](media/service-fabric-reliable-services-backup-restore/IncrementalBackupExample.PNG)

<span data-ttu-id="de49f-132">Como os backups incrementais são apenas as alterações desde o último backup (não incluem os pontos de verificação), eles tendem a ser mais rápidos, mas não podem ser restaurados por conta própria.</span><span class="sxs-lookup"><span data-stu-id="de49f-132">Since incremental backups are only changes since the last backup (does not include the checkpoints), they tend to be faster but they cannot be restored on their own.</span></span>
<span data-ttu-id="de49f-133">Para restaurar um backup incremental, a cadeia de backup inteira será necessária.</span><span class="sxs-lookup"><span data-stu-id="de49f-133">To restore an incremental backup, the entire backup chain is required.</span></span>
<span data-ttu-id="de49f-134">Uma cadeia de backup é uma cadeia de backups, começando com um backup completo e seguido por um número de backups incrementais contíguos.</span><span class="sxs-lookup"><span data-stu-id="de49f-134">A backup chain is a chain of backups starting with a full backup and followed by a number of contiguous incremental backups.</span></span>

## <a name="backup-reliable-services"></a><span data-ttu-id="de49f-135">Fazer backup de Reliable Services</span><span class="sxs-lookup"><span data-stu-id="de49f-135">Backup Reliable Services</span></span>
<span data-ttu-id="de49f-136">O autor do serviço tem controle total sobre quando realizar backups e onde os backups serão armazenados.</span><span class="sxs-lookup"><span data-stu-id="de49f-136">The service author has full control of when to make backups and where backups will be stored.</span></span>

<span data-ttu-id="de49f-137">Para iniciar um backup, o serviço precisa invocar a função de membro herdado `BackupAsync`.</span><span class="sxs-lookup"><span data-stu-id="de49f-137">To start a backup, the service needs to invoke the inherited member function `BackupAsync`.</span></span>  
<span data-ttu-id="de49f-138">Os backups somente podem ser realizados a partir de réplicas primárias e exigem a concessão do status de gravação.</span><span class="sxs-lookup"><span data-stu-id="de49f-138">Backups can be made only from primary replicas, and they require write status to be granted.</span></span>

<span data-ttu-id="de49f-139">Conforme mostrado abaixo, `BackupAsync` captura um objeto `BackupDescription`, em que é possível especificar um backup completo ou incremental, bem como uma função de retorno de chamada, `Func<< BackupInfo, CancellationToken, Task<bool>>>`, que será invocada quando a pasta de backup tiver sido criada localmente e estiver pronta para ser movida para algum armazenamento externo.</span><span class="sxs-lookup"><span data-stu-id="de49f-139">As shown below, `BackupAsync` takes in a `BackupDescription` object, where one can specify a full or incremental backup, as well as a callback function, `Func<< BackupInfo, CancellationToken, Task<bool>>>` that is invoked when the backup folder has been created locally and is ready to be moved out to some external storage.</span></span>

```csharp

BackupDescription myBackupDescription = new BackupDescription(backupOption.Incremental,this.BackupCallbackAsync);

await this.BackupAsync(myBackupDescription);

```

<span data-ttu-id="de49f-140">Uma solicitação para fazer um backup incremental pode falhar com `FabricMissingFullBackupException`.</span><span class="sxs-lookup"><span data-stu-id="de49f-140">Request to take an incremental backup can fail with `FabricMissingFullBackupException`.</span></span> <span data-ttu-id="de49f-141">Esta exceção indica que uma das seguintes ações está ocorrendo:</span><span class="sxs-lookup"><span data-stu-id="de49f-141">This exception indicates that one of the following things is happening:</span></span>

- <span data-ttu-id="de49f-142">a réplica nunca realizou backup completo desde que se tornou primária,</span><span class="sxs-lookup"><span data-stu-id="de49f-142">the replica has never taken a full backup since it has become primary,</span></span>
- <span data-ttu-id="de49f-143">alguns dos registros de log desde o último backup foram truncados ou</span><span class="sxs-lookup"><span data-stu-id="de49f-143">some of the log records since the last backup has been truncated or</span></span>
- <span data-ttu-id="de49f-144">a réplica ultrapassou o limite `MaxAccumulatedBackupLogSizeInMB`.</span><span class="sxs-lookup"><span data-stu-id="de49f-144">replica passed the `MaxAccumulatedBackupLogSizeInMB` limit.</span></span>

<span data-ttu-id="de49f-145">Os usuários podem aumentar a probabilidade de conseguirem fazer backups incrementais configurando `MinLogSizeInMB` ou `TruncationThresholdFactor`.</span><span class="sxs-lookup"><span data-stu-id="de49f-145">Users can increase the likelihood of being able to do incremental backups by configuring `MinLogSizeInMB` or `TruncationThresholdFactor`.</span></span>
<span data-ttu-id="de49f-146">Observe que aumentar esses valores aumentará a utilização de disco por réplica.</span><span class="sxs-lookup"><span data-stu-id="de49f-146">Note that increasing these values increases the per replica disk usage.</span></span>
<span data-ttu-id="de49f-147">Para mais informações, confira [Configuração do Reliable Services](service-fabric-reliable-services-configuration.md)</span><span class="sxs-lookup"><span data-stu-id="de49f-147">For more information, see [Reliable Services Configuration](service-fabric-reliable-services-configuration.md)</span></span>

<span data-ttu-id="de49f-148">`BackupInfo` fornece informações sobre o backup, incluindo a localização da pasta em que o tempo de execução salvou o backup (`BackupInfo.Directory`).</span><span class="sxs-lookup"><span data-stu-id="de49f-148">`BackupInfo` provides information regarding the backup, including the location of the folder where the runtime saved the backup (`BackupInfo.Directory`).</span></span> <span data-ttu-id="de49f-149">A função de retorno de chamada pode mover `BackupInfo.Directory` para um repositório externo ou para outro local.</span><span class="sxs-lookup"><span data-stu-id="de49f-149">The callback function can move the `BackupInfo.Directory` to an external store or another location.</span></span>  <span data-ttu-id="de49f-150">Além disso, esta função retorna um booliano que indica se ele foi capaz de mover a pasta de backup para seu local de destino.</span><span class="sxs-lookup"><span data-stu-id="de49f-150">This function also returns a bool that indicates whether it was able to successfully move the backup folder to its target location.</span></span>

<span data-ttu-id="de49f-151">O código a seguir demonstra como o método `BackupCallbackAsync` pode ser usado para carregar o backup no Armazenamento do Azure:</span><span class="sxs-lookup"><span data-stu-id="de49f-151">The following code demonstrates how the `BackupCallbackAsync` method can be used to upload the backup to Azure Storage:</span></span>

```csharp
private async Task<bool> BackupCallbackAsync(BackupInfo backupInfo, CancellationToken cancellationToken)
{
    var backupId = Guid.NewGuid();

    await externalBackupStore.UploadBackupFolderAsync(backupInfo.Directory, backupId, cancellationToken);

    return true;
}
```

<span data-ttu-id="de49f-152">No exemplo acima, `ExternalBackupStore` é a classe de exemplo usada para fazer a interface com o Armazenamento de Blobs do Azure e `UploadBackupFolderAsync` é o método que compacta a pasta e a coloca no repositório de Blob do Azure.</span><span class="sxs-lookup"><span data-stu-id="de49f-152">In the preceeding example, `ExternalBackupStore` is the sample class that is used to interface with Azure Blob storage, and `UploadBackupFolderAsync` is the method that compresses the folder and places it in the Azure Blob store.</span></span>

<span data-ttu-id="de49f-153">Observe que:</span><span class="sxs-lookup"><span data-stu-id="de49f-153">Note that:</span></span>

  - <span data-ttu-id="de49f-154">Pode haver apenas uma operação de backup em execução por réplica em um determinado momento.</span><span class="sxs-lookup"><span data-stu-id="de49f-154">There can be only one backup operation in-flight per replica at any given time.</span></span> <span data-ttu-id="de49f-155">Fazer mais de uma chamada `BackupAsync` por vez gerará `FabricBackupInProgressException` para limitar os backups em andamento a um.</span><span class="sxs-lookup"><span data-stu-id="de49f-155">More than one `BackupAsync` call at a time will throw `FabricBackupInProgressException` to limit inflight backups to one.</span></span>
  - <span data-ttu-id="de49f-156">Se uma réplica passar por failover enquanto um backup estiver em andamento, talvez o backup não tenha sido concluído.</span><span class="sxs-lookup"><span data-stu-id="de49f-156">If a replica fails over while a backup is in progress, the backup may not have been completed.</span></span> <span data-ttu-id="de49f-157">Portanto, após a conclusão do failover, é responsabilidade do serviço reiniciar o backup invocando `BackupAsync` conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="de49f-157">Thus, once the failover finishes, it is the service's responsibility to restart the backup by invoking `BackupAsync` as necessary.</span></span>

## <a name="restore-reliable-services"></a><span data-ttu-id="de49f-158">Restaurar Reliable Services</span><span class="sxs-lookup"><span data-stu-id="de49f-158">Restore Reliable Services</span></span>
<span data-ttu-id="de49f-159">Em geral, os casos em que você talvez precise executar uma operação de restauração se enquadram em uma destas categorias:</span><span class="sxs-lookup"><span data-stu-id="de49f-159">In general, the cases when you might need to perform a restore operation fall into one of these categories:</span></span>

  - <span data-ttu-id="de49f-160">A partição do serviço perdeu os dados.</span><span class="sxs-lookup"><span data-stu-id="de49f-160">The service partition lost data.</span></span> <span data-ttu-id="de49f-161">Por exemplo, o disco de duas entre três réplicas de uma partição (incluindo a réplica primária) é corrompido ou apagado.</span><span class="sxs-lookup"><span data-stu-id="de49f-161">For example, the disk for two out of three replicas for a partition (including the primary replica) gets corrupted or wiped.</span></span> <span data-ttu-id="de49f-162">Pode ser necessário que a nova réplica primária restaure os dados a partir de um backup.</span><span class="sxs-lookup"><span data-stu-id="de49f-162">The new primary may need to restore data from a backup.</span></span>
  - <span data-ttu-id="de49f-163">O serviço inteiro é perdido.</span><span class="sxs-lookup"><span data-stu-id="de49f-163">The entire service is lost.</span></span> <span data-ttu-id="de49f-164">Por exemplo, um administrador remove todo o serviço e, portanto, o serviço e os dados precisam ser restaurados.</span><span class="sxs-lookup"><span data-stu-id="de49f-164">For example, an administrator removes the entire service and thus the service and the data need to be restored.</span></span>
  - <span data-ttu-id="de49f-165">O serviço replica dados corrompidos de aplicativo (por exemplo, devido a um bug de aplicativo).</span><span class="sxs-lookup"><span data-stu-id="de49f-165">The service replicated corrupt application data (e.g., because of an application bug).</span></span> <span data-ttu-id="de49f-166">Nesse caso, o serviço precisa ser atualizado ou revertido para remover a causa do dano, e os dados não corrompidos precisam ser restaurados.</span><span class="sxs-lookup"><span data-stu-id="de49f-166">In this case, the service has to be upgraded or reverted to remove the cause of the corruption, and non-corrupt data has to be restored.</span></span>

<span data-ttu-id="de49f-167">Embora muitas abordagens sejam possíveis, oferecemos alguns exemplos sobre como usar `RestoreAsync` para se recuperar dos cenários acima.</span><span class="sxs-lookup"><span data-stu-id="de49f-167">While many approaches are possible, we offer some examples on using `RestoreAsync` to recover from the above scenarios.</span></span>

## <a name="partition-data-loss-in-reliable-services"></a><span data-ttu-id="de49f-168">Perda de dados de partição em Reliable Services</span><span class="sxs-lookup"><span data-stu-id="de49f-168">Partition data loss in Reliable Services</span></span>
<span data-ttu-id="de49f-169">Nesse caso, o tempo de execução detectaria automaticamente a perda de dados e invocaria a API `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="de49f-169">In this case, the runtime would automatically detect the data loss and invoke the `OnDataLossAsync` API.</span></span>

<span data-ttu-id="de49f-170">O autor do serviço precisa executar o seguinte para fazer a recuperação:</span><span class="sxs-lookup"><span data-stu-id="de49f-170">The service author needs to perform the following to recover:</span></span>

  - <span data-ttu-id="de49f-171">Substitua o método da classe base virtual `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="de49f-171">Override the virtual base class method `OnDataLossAsync`.</span></span>
  - <span data-ttu-id="de49f-172">Localize o último backup no local externo que contém backups do serviço.</span><span class="sxs-lookup"><span data-stu-id="de49f-172">Find the latest backup in the external location that contains the service's backups.</span></span>
  - <span data-ttu-id="de49f-173">Baixe o backup mais recente (e descompacte o backup na pasta de backup se ele tiver sido compactado).</span><span class="sxs-lookup"><span data-stu-id="de49f-173">Download the latest backup (and uncompress the backup into the backup folder if it was compressed).</span></span>
  - <span data-ttu-id="de49f-174">O método `OnDataLossAsync` fornece um `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="de49f-174">The `OnDataLossAsync` method provides a `RestoreContext`.</span></span> <span data-ttu-id="de49f-175">Chame a API `RestoreAsync` no `RestoreContext` fornecido.</span><span class="sxs-lookup"><span data-stu-id="de49f-175">Call the `RestoreAsync` API on the provided `RestoreContext`.</span></span>
  - <span data-ttu-id="de49f-176">Retorna verdadeiro se a restauração foi um sucesso.</span><span class="sxs-lookup"><span data-stu-id="de49f-176">Return true if the restoration was a success.</span></span>

<span data-ttu-id="de49f-177">Veja a seguir um exemplo de implementação do método `OnDataLossAsync`:</span><span class="sxs-lookup"><span data-stu-id="de49f-177">Following is an example implementation of the `OnDataLossAsync` method:</span></span>

```csharp
protected override async Task<bool> OnDataLossAsync(RestoreContext restoreCtx, CancellationToken cancellationToken)
{
    var backupFolder = await this.externalBackupStore.DownloadLastBackupAsync(cancellationToken);

    var restoreDescription = new RestoreDescription(backupFolder);

    await restoreCtx.RestoreAsync(restoreDescription);

    return true;
}
```

<span data-ttu-id="de49f-178">O `RestoreDescription` passado para a chamada `RestoreContext.RestoreAsync` contém um membro chamado `BackupFolderPath`.</span><span class="sxs-lookup"><span data-stu-id="de49f-178">`RestoreDescription` passed in to the `RestoreContext.RestoreAsync` call contains a member called `BackupFolderPath`.</span></span>
<span data-ttu-id="de49f-179">Ao restaurar um único backup completo, esse `BackupFolderPath` deve ser definido como o caminho local da pasta que contém o backup completo.</span><span class="sxs-lookup"><span data-stu-id="de49f-179">When restoring a single full backup, this `BackupFolderPath` should be set to the local path of the folder that contains your full backup.</span></span>
<span data-ttu-id="de49f-180">Ao restaurar um backup completo e um número de backups incrementais, `BackupFolderPath` deve ser definido como o caminho local da pasta que contém não apenas o backup completo, mas também todos os backups incrementais.</span><span class="sxs-lookup"><span data-stu-id="de49f-180">When restoring a full backup and a number of incremental backups, `BackupFolderPath` should be set to the local path of the folder that not only contains the full backup, but also all the incremental backups.</span></span>
<span data-ttu-id="de49f-181">A chamada `RestoreAsync` poderá lançar `FabricMissingFullBackupException` se o fornecido `BackupFolderPath` não contiver um backup completo.</span><span class="sxs-lookup"><span data-stu-id="de49f-181">`RestoreAsync` call can throw `FabricMissingFullBackupException` if the `BackupFolderPath` provided does not contain a full backup.</span></span>
<span data-ttu-id="de49f-182">Ela também poderá lançar `ArgumentException` se `BackupFolderPath` tiver uma cadeia quebrada de backups incrementais.</span><span class="sxs-lookup"><span data-stu-id="de49f-182">It can also throw `ArgumentException` if `BackupFolderPath` has a broken chain of incremental backups.</span></span>
<span data-ttu-id="de49f-183">Por exemplo, se ele contiver o backup completo, o primeiro e o terceiro backup incremental, mas não o segundo backup incremental.</span><span class="sxs-lookup"><span data-stu-id="de49f-183">For example, if it contains the full backup, the first incremental and the third incremental backup but no the second incremental backup.</span></span>

> [!NOTE]
> <span data-ttu-id="de49f-184">O RestorePolicy é definido como Seguro por padrão.</span><span class="sxs-lookup"><span data-stu-id="de49f-184">The RestorePolicy is set to Safe by default.</span></span>  <span data-ttu-id="de49f-185">Isso significa que a API `RestoreAsync` falhará com ArgumentException se detectar que a pasta de backups contém um estado mais antigo ou igual ao estado contido nesta réplica.</span><span class="sxs-lookup"><span data-stu-id="de49f-185">This means that the `RestoreAsync` API will fail with ArgumentException if it detects that the backup folder contains a state that is older than or equal to the state contained in this replica.</span></span>  <span data-ttu-id="de49f-186">`RestorePolicy.Force` pode ser usado para ignorar essa verificação de segurança.</span><span class="sxs-lookup"><span data-stu-id="de49f-186">`RestorePolicy.Force` can be used to skip this safety check.</span></span> <span data-ttu-id="de49f-187">Isso é especificado como parte de `RestoreDescription`.</span><span class="sxs-lookup"><span data-stu-id="de49f-187">This is specified as part of `RestoreDescription`.</span></span>
> 

## <a name="deleted-or-lost-service"></a><span data-ttu-id="de49f-188">Serviço perdido ou excluído</span><span class="sxs-lookup"><span data-stu-id="de49f-188">Deleted or lost service</span></span>
<span data-ttu-id="de49f-189">Se um serviço for removido, primeiro recrie o serviço antes de restaurar os dados.</span><span class="sxs-lookup"><span data-stu-id="de49f-189">If a service is removed, you must first re-create the service before the data can be restored.</span></span>  <span data-ttu-id="de49f-190">É importante criar o serviço com a mesma configuração, por exemplo, esquema de particionamento, para que os dados possam ser restaurados perfeitamente.</span><span class="sxs-lookup"><span data-stu-id="de49f-190">It is important to create the service with the same configuration, e.g., partitioning scheme, so that the data can be restored seamlessly.</span></span>  <span data-ttu-id="de49f-191">Quando o serviço estiver funcionando, a API para restauração de dados (`OnDataLossAsync` acima) precisará ser invocada em todas as partições desse serviço.</span><span class="sxs-lookup"><span data-stu-id="de49f-191">Once the service is up, the API to restore data (`OnDataLossAsync` above) has to be invoked on every partition of this service.</span></span> <span data-ttu-id="de49f-192">Uma maneira de fazer isso é usar `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` em cada partição.</span><span class="sxs-lookup"><span data-stu-id="de49f-192">One way of achieving this is by using `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` on every partition.</span></span>  

<span data-ttu-id="de49f-193">Neste ponto, a implementação é igual à do cenário anterior.</span><span class="sxs-lookup"><span data-stu-id="de49f-193">From this point, implementation is the same as the above scenario.</span></span> <span data-ttu-id="de49f-194">Cada partição deve restaurar o backup mais recente relevante do armazenamento externo.</span><span class="sxs-lookup"><span data-stu-id="de49f-194">Each partition needs to restore the latest relevant backup from the external store.</span></span> <span data-ttu-id="de49f-195">Uma limitação é que a ID de partição pode ter sido alterada, uma vez que o tempo de execução cria IDs de partição dinamicamente.</span><span class="sxs-lookup"><span data-stu-id="de49f-195">One caveat is that the partition ID may have now changed, since the runtime creates partition IDs dynamically.</span></span> <span data-ttu-id="de49f-196">Portanto, o serviço precisa armazenar o nome do serviço e as informações de partição apropriadas para identificar o backup correto mais recente para restauração em cada partição.</span><span class="sxs-lookup"><span data-stu-id="de49f-196">Thus, the service needs to store the appropriate partition information and service name to identify the correct latest backup to restore from for each partition.</span></span>

> [!NOTE]
> <span data-ttu-id="de49f-197">Não é recomendável usar `FabricClient.ServiceManager.InvokeDataLossAsync` em cada partição para restaurar o serviço inteiro, visto que isso pode corromper o estado do cluster.</span><span class="sxs-lookup"><span data-stu-id="de49f-197">It is not recommended to use `FabricClient.ServiceManager.InvokeDataLossAsync` on each partition to restore the entire service, since that may corrupt your cluster state.</span></span>
> 

## <a name="replication-of-corrupt-application-data"></a><span data-ttu-id="de49f-198">Replicação de dados de aplicativo corrompidos</span><span class="sxs-lookup"><span data-stu-id="de49f-198">Replication of corrupt application data</span></span>
<span data-ttu-id="de49f-199">Se a atualização de aplicativo implantado recentemente tiver um bug, poderá causar corrupção de dados.</span><span class="sxs-lookup"><span data-stu-id="de49f-199">If the newly deployed application upgrade has a bug, that may cause corruption of data.</span></span> <span data-ttu-id="de49f-200">Por exemplo, uma atualização de aplicativo pode começar a atualizar todos os registros de número de telefone em um dicionário confiável com um código de área inválido.</span><span class="sxs-lookup"><span data-stu-id="de49f-200">For example, an application upgrade may start to update every phone number record in a Reliable Dictionary with an invalid area code.</span></span>  <span data-ttu-id="de49f-201">Nesse caso, os números de telefone inválidos serão replicados, uma vez que o Service Fabric não tem conhecimento da natureza dos dados que estão sendo armazenados.</span><span class="sxs-lookup"><span data-stu-id="de49f-201">In this case, the invalid phone numbers will be replicated since Service Fabric is not aware of the nature of the data that is being stored.</span></span>

<span data-ttu-id="de49f-202">A primeira coisa a ser feita depois de detectar um bug tão sério e que causa a corrupção de dados é congelar o serviço no nível do aplicativo e, se possível, atualizar para a versão do código do aplicativo que não tenha o bug.</span><span class="sxs-lookup"><span data-stu-id="de49f-202">The first thing to do after you detect such an egregious bug that causes data corruption is to freeze the service at the application level and, if possible, upgrade to the version of the application code that does not have the bug.</span></span>  <span data-ttu-id="de49f-203">No entanto, mesmo depois que o código do serviço é corrigido, os dados ainda podem estar corrompidos e, portanto, talvez seja necessário restaurá-los.</span><span class="sxs-lookup"><span data-stu-id="de49f-203">However, even after the service code is fixed, the data may still be corrupt and thus data may need to be restored.</span></span>  <span data-ttu-id="de49f-204">Nesses casos, talvez não seja suficiente restaurar o backup mais recente, uma vez que os backups mais recentes também podem estar corrompidos.</span><span class="sxs-lookup"><span data-stu-id="de49f-204">In such cases, it may not be sufficient to restore the latest backup, since the latest backups may also be corrupt.</span></span>  <span data-ttu-id="de49f-205">Assim, você precisa localizar o backup mais recente realizado antes de os dados serem corrompidos.</span><span class="sxs-lookup"><span data-stu-id="de49f-205">Thus, you have to find the last backup that was made before the data got corrupted.</span></span>

<span data-ttu-id="de49f-206">Caso não saiba ao certo quais backups estão corrompidos, implemente um novo cluster do Service Fabric e restaure os backups das partições afetadas, assim como o cenário descrito anteriormente para "Serviço excluído ou interrompido".</span><span class="sxs-lookup"><span data-stu-id="de49f-206">If you are not sure which backups are corrupt, you could deploy a new Service Fabric cluster and restore the backups of affected partitions just like the above "Deleted or lost service" scenario.</span></span>  <span data-ttu-id="de49f-207">Para cada partição, comece a restaurar os backups a partir do mais recente.</span><span class="sxs-lookup"><span data-stu-id="de49f-207">For each partition, start restoring the backups from the most recent to the least.</span></span> <span data-ttu-id="de49f-208">Caso encontre um backup sem danos, mova ou exclua todos os outros backups mais recentes dessa partição.</span><span class="sxs-lookup"><span data-stu-id="de49f-208">Once you find a backup that does not have the corruption, move/delete all backups of this partition that were more recent (than that backup).</span></span> <span data-ttu-id="de49f-209">Repita esse processo para cada partição.</span><span class="sxs-lookup"><span data-stu-id="de49f-209">Repeat this process for each partition.</span></span> <span data-ttu-id="de49f-210">Agora, quando `OnDataLossAsync` for chamado na partição do cluster de produção, o último backup localizado no repositório externo será aquele escolhido pelo processo acima.</span><span class="sxs-lookup"><span data-stu-id="de49f-210">Now, when `OnDataLossAsync` is called on the partition in the production cluster, the last backup found in the external store will be the one picked by the above process.</span></span>

<span data-ttu-id="de49f-211">Agora, as etapas na seção "Serviço perdido ou excluído" podem ser usadas para restaurar o estado do serviço para o estado anterior à corrupção do estado pelo código com bug.</span><span class="sxs-lookup"><span data-stu-id="de49f-211">Now, the steps in the "Deleted or lost service" section can be used to restore the state of the service to the state before the buggy code corrupted the state.</span></span>

<span data-ttu-id="de49f-212">Observe que:</span><span class="sxs-lookup"><span data-stu-id="de49f-212">Note that:</span></span>

  - <span data-ttu-id="de49f-213">Sempre que você restaura, há uma chance do backup restaurado ser mais antigo do que o estado da partição antes de os dados serem perdidos.</span><span class="sxs-lookup"><span data-stu-id="de49f-213">When you restore, there is a chance that the backup being restored is older than the state of the partition before the data was lost.</span></span> <span data-ttu-id="de49f-214">Por isso, essa restauração deve ser usada apenas como último recurso para recuperar o máximo possível de dados.</span><span class="sxs-lookup"><span data-stu-id="de49f-214">Because of this, you should restore only as a last resort to recover as much data as possible.</span></span>
  - <span data-ttu-id="de49f-215">A cadeia de caracteres que representa o caminho da pasta de backup e os caminhos dos arquivos dentro da pasta de backup podem ser maiores do que 255 caracteres, dependendo do caminho de FabricDataRoot e do comprimento do nome do Tipo de Aplicativo.</span><span class="sxs-lookup"><span data-stu-id="de49f-215">The string that represents the backup folder path and the paths of files inside the backup folder can be greater than 255 characters, depending on the FabricDataRoot path and Application Type name's length.</span></span> <span data-ttu-id="de49f-216">Isso pode fazer com que alguns métodos .NET, como `Directory.Move`, lancem a exceção `PathTooLongException`.</span><span class="sxs-lookup"><span data-stu-id="de49f-216">This can cause some .NET methods, like `Directory.Move`, to throw the `PathTooLongException` exception.</span></span> <span data-ttu-id="de49f-217">Uma solução alternativa é chamar diretamente as APIs do kernel32, como `CopyFile`.</span><span class="sxs-lookup"><span data-stu-id="de49f-217">One workaround is to directly call kernel32 APIs, like `CopyFile`.</span></span>

## <a name="backup-and-restore-reliable-actors"></a><span data-ttu-id="de49f-218">Fazer backup e restaurar Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="de49f-218">Backup and restore Reliable Actors</span></span>


<span data-ttu-id="de49f-219">A Estrutura Reliable Actors foi criada com base nos Reliable Services.</span><span class="sxs-lookup"><span data-stu-id="de49f-219">Reliable Actors Framework is built on top of Reliable Services.</span></span> <span data-ttu-id="de49f-220">O ActorService que hospeda os atores é um serviço confiável com estado.</span><span class="sxs-lookup"><span data-stu-id="de49f-220">The ActorService which hosts the actor(s) is a stateful reliable service.</span></span> <span data-ttu-id="de49f-221">Desse modo, toda a funcionalidade de backup e restauração disponível em Reliable Services também está disponível em Reliable Actors (exceto comportamentos que são específicos do provedor de estado).</span><span class="sxs-lookup"><span data-stu-id="de49f-221">Hence, all the backup and restore functionality available in Reliable Services is also available to Reliable Actors (except behaviors that are state provider specific).</span></span> <span data-ttu-id="de49f-222">Uma vez que os backups serão usados por partição, será feito backup dos estados de todos os atores nessa partição (e a restauração é semelhante e acontecerá de acordo com a partição).</span><span class="sxs-lookup"><span data-stu-id="de49f-222">Since backups will be taken on a per-partition basis, states for all actors in that partition will be backed up (and restoration is similar and will happen on a per-partition basis).</span></span> <span data-ttu-id="de49f-223">Para executar backup/restauração, o proprietário do serviço deve criar uma classe de serviço de ator personalizada derivada da classe ActorService e depois fazer backup/restauração semelhante para os Reliable Services, como descrito acima nas seções anteriores.</span><span class="sxs-lookup"><span data-stu-id="de49f-223">To perform backup/restore, the service owner should create a custom actor service class that derives from ActorService class and then do backup/restore similar to Reliable Services as described above in previous sections.</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo)
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="de49f-224">Quando você cria uma classe de serviço de ator personalizada, também é preciso registrá-la ao registrar o ator.</span><span class="sxs-lookup"><span data-stu-id="de49f-224">When you create a custom actor service class, you need to register that as well when registering the actor.</span></span>

```csharp
ActorRuntime.RegisterActorAsync<MyActor>(
   (context, typeInfo) => new MyCustomActorService(context, typeInfo)).GetAwaiter().GetResult();
```

<span data-ttu-id="de49f-225">O provedor de estado padrão para Reliable Actors é `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="de49f-225">The default state provider for Reliable Actors is `KvsActorStateProvider`.</span></span> <span data-ttu-id="de49f-226">O backup incremental não é habilitado por padrão para `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="de49f-226">Incremental backup is not enabled by default for `KvsActorStateProvider`.</span></span> <span data-ttu-id="de49f-227">Você pode habilitar o backup incremental criando `KvsActorStateProvider` com a configuração apropriada em seu construtor e, em seguida, passando-o ao construtor ActorService, conforme mostrado no seguinte trecho de código:</span><span class="sxs-lookup"><span data-stu-id="de49f-227">You can enable incremental backup by creating `KvsActorStateProvider` with the appropriate setting in its constructor and then passing it to ActorService constructor as shown in following code snippet:</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo, null, null, new KvsActorStateProvider(true)) // Enable incremental backup
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="de49f-228">Após a habilitação do backup incremental, fazer um backup incremental pode falhar com FabricMissingFullBackupException por um dos seguintes motivos, sendo preciso realizar um backup completo antes de usar backups incrementais:</span><span class="sxs-lookup"><span data-stu-id="de49f-228">After incremental backup has been enabled, taking an incremental backup can fail with FabricMissingFullBackupException for one of following reasons and you will need to take a full backup before taking incremental backup(s):</span></span>

  - <span data-ttu-id="de49f-229">Um backup completo da réplica nunca foi feito desde que esta se tornou primária.</span><span class="sxs-lookup"><span data-stu-id="de49f-229">The replica has never taken a full backup since it became primary.</span></span>
  - <span data-ttu-id="de49f-230">Alguns dos registros de log foram truncados desde que o último backup foi feito.</span><span class="sxs-lookup"><span data-stu-id="de49f-230">Some of the log records were truncated since last backup was taken.</span></span>

<span data-ttu-id="de49f-231">Quando o backup incremental é habilitado, `KvsActorStateProvider` não usa o buffer circular para gerenciar seus registros de log e o trunca periodicamente.</span><span class="sxs-lookup"><span data-stu-id="de49f-231">When incremental backup is enabled, `KvsActorStateProvider` does not use circular buffer to manage its log records and periodically truncates it.</span></span> <span data-ttu-id="de49f-232">Se nenhum backup for feito pelo usuário por um período de 45 minutos, o sistema automaticamente truncará os registros de log.</span><span class="sxs-lookup"><span data-stu-id="de49f-232">If no backup is taken by user for a period of 45 minutes, the system automatically truncates the log records.</span></span> <span data-ttu-id="de49f-233">Esse intervalo pode ser configurado especificando `logTrunctationIntervalInMinutes` no construtor `KvsActorStateProvider` (semelhante à habilitação do backup incremental).</span><span class="sxs-lookup"><span data-stu-id="de49f-233">This interval can be configured by specifying `logTrunctationIntervalInMinutes` in `KvsActorStateProvider` constructor (similar to when enabling incremental backup).</span></span> <span data-ttu-id="de49f-234">Os registros de log também poderão ser truncados se a réplica primária precisar criar outra réplica enviando todos os seus dados.</span><span class="sxs-lookup"><span data-stu-id="de49f-234">The log records may also get truncated if primary replica need to build another replica by sending all its data.</span></span>

<span data-ttu-id="de49f-235">Ao fazer a restauração usando uma cadeia de backup, semelhante aos Reliable Services, BackupFolderPath deve conter subdiretórios com um subdiretório contendo o backup completo e outros subdiretórios contendo backups incrementais.</span><span class="sxs-lookup"><span data-stu-id="de49f-235">When doing restore from a backup chain, similar to Reliable Services, the BackupFolderPath should contain subdirectories with one subdirectory containing full backup and others subdirectories containing incremental backup(s).</span></span> <span data-ttu-id="de49f-236">A API de restauração acionará FabricException com a mensagem de erro apropriada se a validação da cadeia de backup falhar.</span><span class="sxs-lookup"><span data-stu-id="de49f-236">The restore API will throw FabricException with appropriate error message if the backup chain validation fails.</span></span> 

> [!NOTE]
> <span data-ttu-id="de49f-237">Atualmente, `KvsActorStateProvider` ignora a opção RestorePolicy.Safe.</span><span class="sxs-lookup"><span data-stu-id="de49f-237">`KvsActorStateProvider` currently ignores the option RestorePolicy.Safe.</span></span> <span data-ttu-id="de49f-238">O suporte a esse recurso está planejado para uma versão futura.</span><span class="sxs-lookup"><span data-stu-id="de49f-238">Support for this feature is planned in an upcoming release.</span></span>
> 

## <a name="testing-backup-and-restore"></a><span data-ttu-id="de49f-239">Testando o backup e a restauração</span><span class="sxs-lookup"><span data-stu-id="de49f-239">Testing Backup and Restore</span></span>
<span data-ttu-id="de49f-240">É importante garantir que o backup dos dados críticos esteja sendo feito e que os dados possam ser restaurados desse backup.</span><span class="sxs-lookup"><span data-stu-id="de49f-240">It is important to ensure that critical data is being backed up, and can be restored from.</span></span> <span data-ttu-id="de49f-241">Isso pode ser feito invocando o cmdlet `Start-ServiceFabricPartitionDataLoss` no PowerShell, que pode induzir à perda de dados em uma determinada partição para testar se a funcionalidade de backup e restauração de dados para seu serviço está funcionando conforme o esperado.</span><span class="sxs-lookup"><span data-stu-id="de49f-241">This can be done by invoking the `Start-ServiceFabricPartitionDataLoss` cmdlet in PowerShell that can induce data loss in a particular partition to test whether the data backup and restore functionality for your service is working as expected.</span></span>  <span data-ttu-id="de49f-242">Também é possível invocar de modo programático a perda de dados e fazer a restauração a partir desse evento.</span><span class="sxs-lookup"><span data-stu-id="de49f-242">It is also possible to programmatically invoke data loss and restore from that event as well.</span></span>

> [!NOTE]
> <span data-ttu-id="de49f-243">Você pode encontrar um exemplo de implementação da funcionalidade de backup e restauração no Aplicativo de Referência da Web no GitHub.</span><span class="sxs-lookup"><span data-stu-id="de49f-243">You can find a sample implementation of backup and restore functionality in the Web Reference App on GitHub.</span></span> <span data-ttu-id="de49f-244">Examine o serviço `Inventory.Service` obter mais detalhes.</span><span class="sxs-lookup"><span data-stu-id="de49f-244">Please look at the `Inventory.Service` service for more details.</span></span>
> 
> 

## <a name="under-the-hood-more-details-on-backup-and-restore"></a><span data-ttu-id="de49f-245">Nos bastidores: mais detalhes sobre backup e restauração</span><span class="sxs-lookup"><span data-stu-id="de49f-245">Under the hood: more details on backup and restore</span></span>
<span data-ttu-id="de49f-246">Veja mais alguns detalhes sobre backup e restauração.</span><span class="sxs-lookup"><span data-stu-id="de49f-246">Here's some more details on backup and restore.</span></span>

### <a name="backup"></a><span data-ttu-id="de49f-247">Backup</span><span class="sxs-lookup"><span data-stu-id="de49f-247">Backup</span></span>
<span data-ttu-id="de49f-248">O Gerenciador de Estado Confiável permite a criação de backups consistentes sem bloquear as operações de leitura e gravação.</span><span class="sxs-lookup"><span data-stu-id="de49f-248">The Reliable State Manager provides the ability to create consistent backups without blocking any read or write operations.</span></span> <span data-ttu-id="de49f-249">Para fazer isso, ele utiliza um mecanismo de ponto de verificação e persistência de log.</span><span class="sxs-lookup"><span data-stu-id="de49f-249">To do so, it utilizes a checkpoint and log persistence mechanism.</span></span>  <span data-ttu-id="de49f-250">O Gerenciador de Estado Confiável usa pontos de verificação (leves) difusos em determinados pontos para aliviar a pressão do log transacional e melhorar os tempos de recuperação.</span><span class="sxs-lookup"><span data-stu-id="de49f-250">The Reliable State Manager takes fuzzy (lightweight) checkpoints at certain points to relieve pressure from the transactional log and improve recovery times.</span></span>  <span data-ttu-id="de49f-251">Quando `BackupAsync` é chamado, o Gerenciador de Estado Confiável instrui todos os objetos Reliable a copiar seus arquivos de ponto de verificação mais recentes em uma pasta de backup local.</span><span class="sxs-lookup"><span data-stu-id="de49f-251">When `BackupAsync` is called, the Reliable State Manager instructs all Reliable objects to copy their latest checkpoint files to a local backup folder.</span></span>  <span data-ttu-id="de49f-252">Em seguida, o Gerenciador de Estado Confiável copia todos os registros de log, desde o "ponteiro inicial" até o registro de log mais recente, na pasta de backup.</span><span class="sxs-lookup"><span data-stu-id="de49f-252">Then, the Reliable State Manager copies all log records, starting from the "start pointer" to the latest log record into the backup folder.</span></span>  <span data-ttu-id="de49f-253">Como todos os registros de log, até o mais recente, são incluídos no backup e o Gerenciador de Estado Confiável preserva o registro em log write-ahead, o Gerenciador de Estado Confiável garante que todas as transações confirmadas (`CommitAsync` retornou com êxito) sejam incluídas no backup.</span><span class="sxs-lookup"><span data-stu-id="de49f-253">Since all the log records up to the latest log record are included in the backup and the Reliable State Manager preserves write-ahead logging, the Reliable State Manager guarantees that all transactions that are committed (`CommitAsync` has returned successfully) are included in the backup.</span></span>

<span data-ttu-id="de49f-254">As transações confirmadas após `BackupAsync` ser chamado podem ou não estar no backup.</span><span class="sxs-lookup"><span data-stu-id="de49f-254">Any transaction that commits after `BackupAsync` has been called may or may not be in the backup.</span></span>  <span data-ttu-id="de49f-255">Após o preenchimento da pasta de backup local pela plataforma (ou seja, o backup local é concluído pelo tempo de execução), o retorno de chamada de backup do serviço é invocado.</span><span class="sxs-lookup"><span data-stu-id="de49f-255">Once the local backup folder has been populated by the platform (i.e., local backup is completed by the runtime), the service's backup callback is invoked.</span></span>  <span data-ttu-id="de49f-256">Esse retorno de chamada é responsável por mover a pasta de backups para um local externo, por exemplo, o Armazenamento do Azure.</span><span class="sxs-lookup"><span data-stu-id="de49f-256">This callback is responsible for moving the backup folder to an external location such as Azure Storage.</span></span>

### <a name="restore"></a><span data-ttu-id="de49f-257">Restaurar</span><span class="sxs-lookup"><span data-stu-id="de49f-257">Restore</span></span>
<span data-ttu-id="de49f-258">O Gerenciador de Estado Confiável permite a restauração de um backup usando a API `RestoreAsync`.</span><span class="sxs-lookup"><span data-stu-id="de49f-258">The Reliable State Manager provides the ability to restore from a backup by using the `RestoreAsync` API.</span></span>  
<span data-ttu-id="de49f-259">O método `RestoreAsync` em `RestoreContext` pode ser chamado somente dentro do método `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="de49f-259">The `RestoreAsync` method on `RestoreContext` can be called only inside the `OnDataLossAsync` method.</span></span>
<span data-ttu-id="de49f-260">O bool retornado por `OnDataLossAsync` indica se o serviço restaurou seu estado de uma fonte externa.</span><span class="sxs-lookup"><span data-stu-id="de49f-260">The bool returned by `OnDataLossAsync` indicates whether the service restored its state from an external source.</span></span>
<span data-ttu-id="de49f-261">Se `OnDataLossAsync` retornar true, o Service Fabric recompilará todas as outras réplicas a partir da primária.</span><span class="sxs-lookup"><span data-stu-id="de49f-261">If the `OnDataLossAsync` returns true, Service Fabric will rebuild all other replicas from this primary.</span></span> <span data-ttu-id="de49f-262">O Service Fabric garante que as réplicas que receberão a chamada `OnDataLossAsync` primeiro façam a transição para a função primária, mas não recebam status de leitura ou de gravação.</span><span class="sxs-lookup"><span data-stu-id="de49f-262">Service Fabric ensures that replicas that will receive `OnDataLossAsync` call first transition to the primary role but are not granted read status or write status.</span></span>
<span data-ttu-id="de49f-263">Isso significa que, para os implementadores de StatefulService, `RunAsync` não será chamado até que `OnDataLossAsync` seja concluído com êxito.</span><span class="sxs-lookup"><span data-stu-id="de49f-263">This implies that for StatefulService implementers, `RunAsync` will not be called until `OnDataLossAsync` finishes successfully.</span></span>
<span data-ttu-id="de49f-264">Em seguida, `OnDataLossAsync` será invocado na nova primária.</span><span class="sxs-lookup"><span data-stu-id="de49f-264">Then, `OnDataLossAsync` will be invoked on the new primary.</span></span>
<span data-ttu-id="de49f-265">A API continua sendo chamada, até que um serviço conclua essa API com êxito, retornando verdadeiro ou falso, e conclua a reconfiguração relevante.</span><span class="sxs-lookup"><span data-stu-id="de49f-265">Until a service completes this API successfully (by returning true or false) and finishes the relevant reconfiguration, the API will keep being called one at a time.</span></span>

<span data-ttu-id="de49f-266">Primeiro, `RestoreAsync` descarta todos os estados existentes na réplica primária na qual foi chamado.</span><span class="sxs-lookup"><span data-stu-id="de49f-266">`RestoreAsync` first drops all existing state in the primary replica that it was called on.</span></span>  
<span data-ttu-id="de49f-267">Depois, o Gerenciador de Estado Confiável cria todos os objetos Reliable que existem na pasta de backup.</span><span class="sxs-lookup"><span data-stu-id="de49f-267">Then the Reliable State Manager creates all the Reliable objects that exist in the backup folder.</span></span>  
<span data-ttu-id="de49f-268">Em seguida, os objetos Reliable são instruídos a restaurar a partir dos pontos de verificação na pasta de backup.</span><span class="sxs-lookup"><span data-stu-id="de49f-268">Next, the Reliable objects are instructed to restore from their checkpoints in the backup folder.</span></span>  
<span data-ttu-id="de49f-269">Finalmente, o Gerenciador de Reliable State recupera seu próprio estado a partir dos registros de log na pasta de backup e executa a recuperação.</span><span class="sxs-lookup"><span data-stu-id="de49f-269">Finally, the Reliable State Manager recovers its own state from the log records in the backup folder and performs recovery.</span></span>  
<span data-ttu-id="de49f-270">Como parte do processo de recuperação, as operações que começaram do "ponto de partida" e confirmaram os registros de log na pasta de backup são reproduzidas aos objetos Reliable.</span><span class="sxs-lookup"><span data-stu-id="de49f-270">As part of the recovery process, operations starting from the "starting point" that have commit log records in the backup folder are replayed to the Reliable objects.</span></span>  
<span data-ttu-id="de49f-271">Essa etapa garante que o estado recuperado seja consistente.</span><span class="sxs-lookup"><span data-stu-id="de49f-271">This step ensures that the recovered state is consistent.</span></span>

## <a name="next-steps"></a><span data-ttu-id="de49f-272">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="de49f-272">Next steps</span></span>
  - [<span data-ttu-id="de49f-273">Coleções Confiáveis</span><span class="sxs-lookup"><span data-stu-id="de49f-273">Reliable Collections</span></span>](service-fabric-work-with-reliable-collections.md)
  - [<span data-ttu-id="de49f-274">Início Rápido dos Serviços Confiáveis</span><span class="sxs-lookup"><span data-stu-id="de49f-274">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
  - [<span data-ttu-id="de49f-275">Notificações do Reliable Services</span><span class="sxs-lookup"><span data-stu-id="de49f-275">Reliable Services notifications</span></span>](service-fabric-reliable-services-notifications.md)
  - [<span data-ttu-id="de49f-276">Configuração do Reliable Services</span><span class="sxs-lookup"><span data-stu-id="de49f-276">Reliable Services configuration</span></span>](service-fabric-reliable-services-configuration.md)
  - [<span data-ttu-id="de49f-277">Referência do desenvolvedor para Coleções Confiáveis</span><span class="sxs-lookup"><span data-stu-id="de49f-277">Developer reference for Reliable Collections</span></span>](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)

