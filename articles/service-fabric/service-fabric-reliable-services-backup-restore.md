---
title: "aaaService malha Backup e restauração | Microsoft Docs"
description: "Documentação conceitual de backup e restauração do Service Fabric"
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: subramar,jessebenson
ms.assetid: 91ea6ca4-cc2a-4155-9823-dcbd0b996349
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/18/2017
ms.author: mcoskun
ms.openlocfilehash: e502b59c84999c3fe825167383f00a5ebd70c9b5
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/06/2017
---
# <a name="back-up-and-restore-reliable-services-and-reliable-actors"></a><span data-ttu-id="b9dff-103">Fazer backup e restaurar Reliable Services e Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="b9dff-103">Back up and restore Reliable Services and Reliable Actors</span></span>
<span data-ttu-id="b9dff-104">Malha do serviço do Azure é uma plataforma de alta disponibilidade que replica estado Olá entre vários toomaintain de nós esta alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="b9dff-104">Azure Service Fabric is a high-availability platform that replicates hello state across multiple nodes toomaintain this high availability.</span></span>  <span data-ttu-id="b9dff-105">Assim, mesmo se um nó no cluster Olá falha, os serviços de saudação continuam toobe disponível.</span><span class="sxs-lookup"><span data-stu-id="b9dff-105">Thus, even if one node in hello cluster fails, hello services continue toobe available.</span></span> <span data-ttu-id="b9dff-106">Embora essa redundância integrados fornecida pela plataforma de saudação pode ser suficiente para alguns, em certos casos é desejável para Olá serviço tooback backup de dados (tooan repositório externo).</span><span class="sxs-lookup"><span data-stu-id="b9dff-106">While this in-built redundancy provided by hello platform may be sufficient for some, in certain cases it is desirable for hello service tooback up data (tooan external store).</span></span>

> [!NOTE]
> <span data-ttu-id="b9dff-107">É crítico toobackup e restaurar seus dados (e teste funciona conforme o esperado) para que possa se recuperar de cenários de perda de dados.</span><span class="sxs-lookup"><span data-stu-id="b9dff-107">It is critical toobackup and restore your data (and test that it works as expected) so you can recover from data loss scenarios.</span></span>
> 
> 

<span data-ttu-id="b9dff-108">Por exemplo, um serviço pode querer tooback backup de dados em ordem tooprotect de saudação os seguintes cenários:</span><span class="sxs-lookup"><span data-stu-id="b9dff-108">For example, a service may want tooback up data in order tooprotect from hello following scenarios:</span></span>

- <span data-ttu-id="b9dff-109">No evento de saudação do perda permanente de saudação de um cluster do Service Fabric inteiro.</span><span class="sxs-lookup"><span data-stu-id="b9dff-109">In hello event of hello permanent loss of an entire Service Fabric cluster.</span></span>
- <span data-ttu-id="b9dff-110">Perda permanente da maioria das réplicas de saudação de uma partição de serviço</span><span class="sxs-lookup"><span data-stu-id="b9dff-110">Permanent loss of a majority of hello replicas of a service partition</span></span>
- <span data-ttu-id="b9dff-111">Erros administrativos no qual estado Olá acidentalmente obtém excluído ou corrompido.</span><span class="sxs-lookup"><span data-stu-id="b9dff-111">Administrative errors whereby hello state accidentally gets deleted or corrupted.</span></span> <span data-ttu-id="b9dff-112">Por exemplo, isso pode ocorrer se um administrador com privilégios suficientes erroneamente exclui o serviço de saudação.</span><span class="sxs-lookup"><span data-stu-id="b9dff-112">For example, this may happen if an administrator with sufficient privilege erroneously deletes hello service.</span></span>
- <span data-ttu-id="b9dff-113">Erros no serviço Olá corromper os dados.</span><span class="sxs-lookup"><span data-stu-id="b9dff-113">Bugs in hello service that cause data corruption.</span></span> <span data-ttu-id="b9dff-114">Por exemplo, isso pode acontecer quando uma atualização do serviço de código começa a gravar dados defeituoso tooa coleção confiável.</span><span class="sxs-lookup"><span data-stu-id="b9dff-114">For example, this may happen when a service code upgrade starts writing faulty data tooa Reliable Collection.</span></span> <span data-ttu-id="b9dff-115">Nesse caso, ambos Olá código e dados de saudação podem ter toobe revertido tooan estado anterior.</span><span class="sxs-lookup"><span data-stu-id="b9dff-115">In such a case, both hello code and hello data may have toobe reverted tooan earlier state.</span></span>
- <span data-ttu-id="b9dff-116">Processamento de dados offline.</span><span class="sxs-lookup"><span data-stu-id="b9dff-116">Offline data processing.</span></span> <span data-ttu-id="b9dff-117">Talvez seja conveniente toohave o processamento offline de dados de business intelligence que acontece separadamente do serviço de saudação que gera dados saudação.</span><span class="sxs-lookup"><span data-stu-id="b9dff-117">It might be convenient toohave offline processing of data for business intelligence that happens separately from hello service that generates hello data.</span></span>

<span data-ttu-id="b9dff-118">o recurso de Backup/restauração Olá permite que os serviços criados na Olá confiável API de serviços toocreate e restaurar backups.</span><span class="sxs-lookup"><span data-stu-id="b9dff-118">hello Backup/Restore feature allows services built on hello Reliable Services API toocreate and restore backups.</span></span> <span data-ttu-id="b9dff-119">Olá APIs de backup fornecidas pela plataforma Olá permitem que um ou mais backups de estado de uma partição de serviço, sem bloqueio de leitura ou de operações de gravação.</span><span class="sxs-lookup"><span data-stu-id="b9dff-119">hello backup APIs provided by hello platform allow backup(s) of a service partition's state, without blocking read or write operations.</span></span> <span data-ttu-id="b9dff-120">APIs de restauração Olá permitir toobe de estado de uma partição serviço restaurado de um backup escolhido.</span><span class="sxs-lookup"><span data-stu-id="b9dff-120">hello restore APIs allow a service partition's state toobe restored from a chosen backup.</span></span>

## <a name="types-of-backup"></a><span data-ttu-id="b9dff-121">Tipos de Backup</span><span class="sxs-lookup"><span data-stu-id="b9dff-121">Types of Backup</span></span>
<span data-ttu-id="b9dff-122">Há duas opções de backup: Completo e Incremental.</span><span class="sxs-lookup"><span data-stu-id="b9dff-122">There are two backup options: Full and Incremental.</span></span>
<span data-ttu-id="b9dff-123">Um backup completo é um backup que contém todos os dados necessários Olá toorecreate Olá a estado da réplica Olá: pontos de verificação e todos os registros de log.</span><span class="sxs-lookup"><span data-stu-id="b9dff-123">A full backup is a backup that contains all hello data required toorecreate hello state of hello replica: checkpoints and all log records.</span></span>
<span data-ttu-id="b9dff-124">Desde que ele tem pontos de verificação hello e log hello, um backup completo pode ser restaurado por si só.</span><span class="sxs-lookup"><span data-stu-id="b9dff-124">Since it has hello checkpoints and hello log, a full backup can be restored by itself.</span></span>

<span data-ttu-id="b9dff-125">problema de saudação com backups completos surge quando os pontos de verificação de saudação são grandes.</span><span class="sxs-lookup"><span data-stu-id="b9dff-125">hello problem with full backups arises when hello checkpoints are large.</span></span>
<span data-ttu-id="b9dff-126">Por exemplo, uma réplica com 16 GB de estado terá pontos de verificação que somam aproximadamente too16 GB.</span><span class="sxs-lookup"><span data-stu-id="b9dff-126">For example, a replica that has 16 GB of state will have checkpoints that add up approximately too16 GB.</span></span>
<span data-ttu-id="b9dff-127">Se houver um objetivo de ponto de recuperação de cinco minutos, a réplica de saudação precisa toobe backup a cada cinco minutos.</span><span class="sxs-lookup"><span data-stu-id="b9dff-127">If we have a Recovery Point Objective of five minutes, hello replica needs toobe backed up every five minutes.</span></span>
<span data-ttu-id="b9dff-128">Cada vez que ele faz o backup precisa toocopy 16 GB de pontos de verificação Além disso too50 MB (configurável usando `CheckpointThresholdInMB`) a partir de logs.</span><span class="sxs-lookup"><span data-stu-id="b9dff-128">Each time it backs up it needs toocopy 16 GB of checkpoints in addition too50 MB (configurable using `CheckpointThresholdInMB`) worth of logs.</span></span>

![Exemplo de Backup Completo.](media/service-fabric-reliable-services-backup-restore/FullBackupExample.PNG)

<span data-ttu-id="b9dff-130">problema de toothis solução Olá é backups incrementais, onde backup contém apenas registros de log Olá alterado desde o último backup de saudação.</span><span class="sxs-lookup"><span data-stu-id="b9dff-130">hello solution toothis problem is incremental backups, where backup only contains hello changed log records since hello last backup.</span></span>

![Exemplo de Backup Incremental.](media/service-fabric-reliable-services-backup-restore/IncrementalBackupExample.PNG)

<span data-ttu-id="b9dff-132">Como os backups incrementais são apenas as alterações feitas desde o último backup de saudação (não inclui pontos de verificação de saudação), eles tendem a toobe mais rápido, mas eles não podem ser restaurados por conta própria.</span><span class="sxs-lookup"><span data-stu-id="b9dff-132">Since incremental backups are only changes since hello last backup (does not include hello checkpoints), they tend toobe faster but they cannot be restored on their own.</span></span>
<span data-ttu-id="b9dff-133">toorestore um backup incremental, toda a cadeia de backup Olá é necessária.</span><span class="sxs-lookup"><span data-stu-id="b9dff-133">toorestore an incremental backup, hello entire backup chain is required.</span></span>
<span data-ttu-id="b9dff-134">Uma cadeia de backup é uma cadeia de backups, começando com um backup completo e seguido por um número de backups incrementais contíguos.</span><span class="sxs-lookup"><span data-stu-id="b9dff-134">A backup chain is a chain of backups starting with a full backup and followed by a number of contiguous incremental backups.</span></span>

## <a name="backup-reliable-services"></a><span data-ttu-id="b9dff-135">Fazer backup de Reliable Services</span><span class="sxs-lookup"><span data-stu-id="b9dff-135">Backup Reliable Services</span></span>
<span data-ttu-id="b9dff-136">Olá, autor de serviço tem controle total sobre quando toomake backups e onde os backups serão armazenados.</span><span class="sxs-lookup"><span data-stu-id="b9dff-136">hello service author has full control of when toomake backups and where backups will be stored.</span></span>

<span data-ttu-id="b9dff-137">toostart um backup, Olá serviço precisa de função de membro Olá herdada tooinvoke `BackupAsync`.</span><span class="sxs-lookup"><span data-stu-id="b9dff-137">toostart a backup, hello service needs tooinvoke hello inherited member function `BackupAsync`.</span></span>  
<span data-ttu-id="b9dff-138">Os backups podem ser feitos somente de réplicas primárias e eles requerem toobe de status de gravação concedido.</span><span class="sxs-lookup"><span data-stu-id="b9dff-138">Backups can be made only from primary replicas, and they require write status toobe granted.</span></span>

<span data-ttu-id="b9dff-139">Conforme mostrado abaixo, `BackupAsync` assume um `BackupDescription` objeto, onde um pode especificar um backup completo ou incremental, bem como uma função de retorno de chamada, `Func<< BackupInfo, CancellationToken, Task<bool>>>` que é invocada quando a pasta de backup Olá foi criada localmente e está pronto toobe movido toosome armazenamento externo.</span><span class="sxs-lookup"><span data-stu-id="b9dff-139">As shown below, `BackupAsync` takes in a `BackupDescription` object, where one can specify a full or incremental backup, as well as a callback function, `Func<< BackupInfo, CancellationToken, Task<bool>>>` that is invoked when hello backup folder has been created locally and is ready toobe moved out toosome external storage.</span></span>

```csharp

BackupDescription myBackupDescription = new BackupDescription(backupOption.Incremental,this.BackupCallbackAsync);

await this.BackupAsync(myBackupDescription);

```

<span data-ttu-id="b9dff-140">Solicitação tootake um backup incremental pode falhar com `FabricMissingFullBackupException`.</span><span class="sxs-lookup"><span data-stu-id="b9dff-140">Request tootake an incremental backup can fail with `FabricMissingFullBackupException`.</span></span> <span data-ttu-id="b9dff-141">Esta exceção indica que uma saudação coisas a seguir está ocorrendo:</span><span class="sxs-lookup"><span data-stu-id="b9dff-141">This exception indicates that one of hello following things is happening:</span></span>

- <span data-ttu-id="b9dff-142">réplica Olá nunca tem feito um backup completo desde que ele se tornou primário,</span><span class="sxs-lookup"><span data-stu-id="b9dff-142">hello replica has never taken a full backup since it has become primary,</span></span>
- <span data-ttu-id="b9dff-143">alguns dos Olá registros de log desde o último backup de saudação foi truncado ou</span><span class="sxs-lookup"><span data-stu-id="b9dff-143">some of hello log records since hello last backup has been truncated or</span></span>
- <span data-ttu-id="b9dff-144">réplica passada Olá `MaxAccumulatedBackupLogSizeInMB` limite.</span><span class="sxs-lookup"><span data-stu-id="b9dff-144">replica passed hello `MaxAccumulatedBackupLogSizeInMB` limit.</span></span>

<span data-ttu-id="b9dff-145">Os usuários podem aumentar a probabilidade de saudação de ser capaz de toodo backups incrementais, configurando `MinLogSizeInMB` ou `TruncationThresholdFactor`.</span><span class="sxs-lookup"><span data-stu-id="b9dff-145">Users can increase hello likelihood of being able toodo incremental backups by configuring `MinLogSizeInMB` or `TruncationThresholdFactor`.</span></span>
<span data-ttu-id="b9dff-146">Observe que esses valores de aumento aumenta Olá por uso de disco de réplica.</span><span class="sxs-lookup"><span data-stu-id="b9dff-146">Note that increasing these values increases hello per replica disk usage.</span></span>
<span data-ttu-id="b9dff-147">Para mais informações, confira [Configuração do Reliable Services](service-fabric-reliable-services-configuration.md)</span><span class="sxs-lookup"><span data-stu-id="b9dff-147">For more information, see [Reliable Services Configuration](service-fabric-reliable-services-configuration.md)</span></span>

<span data-ttu-id="b9dff-148">`BackupInfo`Fornece informações sobre backup hello, incluindo a localização da pasta Olá onde o tempo de execução de saudação salvo backup Olá Olá (`BackupInfo.Directory`).</span><span class="sxs-lookup"><span data-stu-id="b9dff-148">`BackupInfo` provides information regarding hello backup, including hello location of hello folder where hello runtime saved hello backup (`BackupInfo.Directory`).</span></span> <span data-ttu-id="b9dff-149">função de retorno de chamada Hello pode mover Olá `BackupInfo.Directory` tooan repositório externo ou em outro local.</span><span class="sxs-lookup"><span data-stu-id="b9dff-149">hello callback function can move hello `BackupInfo.Directory` tooan external store or another location.</span></span>  <span data-ttu-id="b9dff-150">Essa função também retorna um booleano que indica se ele foi o local de destino de tooits toosuccessfully capaz de mover Olá pasta de backup.</span><span class="sxs-lookup"><span data-stu-id="b9dff-150">This function also returns a bool that indicates whether it was able toosuccessfully move hello backup folder tooits target location.</span></span>

<span data-ttu-id="b9dff-151">Olá código a seguir demonstra como Olá `BackupCallbackAsync` método pode ser usado tooupload de saudação backup tooAzure armazenamento:</span><span class="sxs-lookup"><span data-stu-id="b9dff-151">hello following code demonstrates how hello `BackupCallbackAsync` method can be used tooupload hello backup tooAzure Storage:</span></span>

```csharp
private async Task<bool> BackupCallbackAsync(BackupInfo backupInfo, CancellationToken cancellationToken)
{
    var backupId = Guid.NewGuid();

    await externalBackupStore.UploadBackupFolderAsync(backupInfo.Directory, backupId, cancellationToken);

    return true;
}
```

<span data-ttu-id="b9dff-152">No exemplo anterior de hello, `ExternalBackupStore` é Olá exemplo toointerface usado com o armazenamento de BLOBs do Azure, e `UploadBackupFolderAsync` é o método hello que compacta pasta hello e coloca-o no repositório de Blob do Azure hello.</span><span class="sxs-lookup"><span data-stu-id="b9dff-152">In hello preceeding example, `ExternalBackupStore` is hello sample class that is used toointerface with Azure Blob storage, and `UploadBackupFolderAsync` is hello method that compresses hello folder and places it in hello Azure Blob store.</span></span>

<span data-ttu-id="b9dff-153">Observe que:</span><span class="sxs-lookup"><span data-stu-id="b9dff-153">Note that:</span></span>

  - <span data-ttu-id="b9dff-154">Pode haver apenas uma operação de backup em execução por réplica em um determinado momento.</span><span class="sxs-lookup"><span data-stu-id="b9dff-154">There can be only one backup operation in-flight per replica at any given time.</span></span> <span data-ttu-id="b9dff-155">Mais de um `BackupAsync` chamada em um momento lançará `FabricBackupInProgressException` toolimit inflight backups tooone.</span><span class="sxs-lookup"><span data-stu-id="b9dff-155">More than one `BackupAsync` call at a time will throw `FabricBackupInProgressException` toolimit inflight backups tooone.</span></span>
  - <span data-ttu-id="b9dff-156">Se uma réplica falhar enquanto um backup está em andamento, backup Olá pode não ter sido completada.</span><span class="sxs-lookup"><span data-stu-id="b9dff-156">If a replica fails over while a backup is in progress, hello backup may not have been completed.</span></span> <span data-ttu-id="b9dff-157">Portanto, quando Olá failover termina, é backup de saudação do serviço Olá responsabilidade toorestart invocando `BackupAsync` conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="b9dff-157">Thus, once hello failover finishes, it is hello service's responsibility toorestart hello backup by invoking `BackupAsync` as necessary.</span></span>

## <a name="restore-reliable-services"></a><span data-ttu-id="b9dff-158">Restaurar Reliable Services</span><span class="sxs-lookup"><span data-stu-id="b9dff-158">Restore Reliable Services</span></span>
<span data-ttu-id="b9dff-159">Em geral, casos hello quando tooperform uma operação de restauração pode ser necessário se encaixam em uma dessas categorias:</span><span class="sxs-lookup"><span data-stu-id="b9dff-159">In general, hello cases when you might need tooperform a restore operation fall into one of these categories:</span></span>

  - <span data-ttu-id="b9dff-160">serviço de saudação particionar dados perdidos.</span><span class="sxs-lookup"><span data-stu-id="b9dff-160">hello service partition lost data.</span></span> <span data-ttu-id="b9dff-161">Por exemplo, disco Olá para dois dos três réplicas para uma partição (inclusive a réplica primária Olá) obtém corrompido ou apagado.</span><span class="sxs-lookup"><span data-stu-id="b9dff-161">For example, hello disk for two out of three replicas for a partition (including hello primary replica) gets corrupted or wiped.</span></span> <span data-ttu-id="b9dff-162">novo primário de saudação talvez seja necessário toorestore dados de um backup.</span><span class="sxs-lookup"><span data-stu-id="b9dff-162">hello new primary may need toorestore data from a backup.</span></span>
  - <span data-ttu-id="b9dff-163">todo o serviço Olá será perdido.</span><span class="sxs-lookup"><span data-stu-id="b9dff-163">hello entire service is lost.</span></span> <span data-ttu-id="b9dff-164">Por exemplo, um administrador remove todo o serviço hello e dessa forma, o serviço hello e dados saudação precisam toobe restaurado.</span><span class="sxs-lookup"><span data-stu-id="b9dff-164">For example, an administrator removes hello entire service and thus hello service and hello data need toobe restored.</span></span>
  - <span data-ttu-id="b9dff-165">serviço de saudação replicado dados corrompidos de aplicativo (por exemplo, devido a um erro de aplicativo).</span><span class="sxs-lookup"><span data-stu-id="b9dff-165">hello service replicated corrupt application data (e.g., because of an application bug).</span></span> <span data-ttu-id="b9dff-166">Nesse caso, Olá serviço toobe atualizado ou tooremove revertido Olá causa danos hello e dados corrompidos não tem toobe restaurado.</span><span class="sxs-lookup"><span data-stu-id="b9dff-166">In this case, hello service has toobe upgraded or reverted tooremove hello cause of hello corruption, and non-corrupt data has toobe restored.</span></span>

<span data-ttu-id="b9dff-167">Embora muitas abordagens são possíveis, oferecemos alguns exemplos sobre como usar `RestoreAsync` toorecover de saudação acima cenários.</span><span class="sxs-lookup"><span data-stu-id="b9dff-167">While many approaches are possible, we offer some examples on using `RestoreAsync` toorecover from hello above scenarios.</span></span>

## <a name="partition-data-loss-in-reliable-services"></a><span data-ttu-id="b9dff-168">Perda de dados de partição em Reliable Services</span><span class="sxs-lookup"><span data-stu-id="b9dff-168">Partition data loss in Reliable Services</span></span>
<span data-ttu-id="b9dff-169">Nesse caso, o tempo de execução de saudação seria automaticamente detectar a perda de dados hello e invocar Olá `OnDataLossAsync` API.</span><span class="sxs-lookup"><span data-stu-id="b9dff-169">In this case, hello runtime would automatically detect hello data loss and invoke hello `OnDataLossAsync` API.</span></span>

<span data-ttu-id="b9dff-170">autor de serviço Olá precisa Olá tooperform toorecover a seguir:</span><span class="sxs-lookup"><span data-stu-id="b9dff-170">hello service author needs tooperform hello following toorecover:</span></span>

  - <span data-ttu-id="b9dff-171">Substituir o método da classe base virtual hello `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="b9dff-171">Override hello virtual base class method `OnDataLossAsync`.</span></span>
  - <span data-ttu-id="b9dff-172">Encontre hello mais recente backup no local de externo de saudação que contém os backups do serviço de saudação.</span><span class="sxs-lookup"><span data-stu-id="b9dff-172">Find hello latest backup in hello external location that contains hello service's backups.</span></span>
  - <span data-ttu-id="b9dff-173">Baixar o backup mais recente da saudação (e descompactar backup Olá na pasta de backup Olá se ela foi compactada).</span><span class="sxs-lookup"><span data-stu-id="b9dff-173">Download hello latest backup (and uncompress hello backup into hello backup folder if it was compressed).</span></span>
  - <span data-ttu-id="b9dff-174">Olá `OnDataLossAsync` método fornece uma `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="b9dff-174">hello `OnDataLossAsync` method provides a `RestoreContext`.</span></span> <span data-ttu-id="b9dff-175">Chamar hello `RestoreAsync` API em Olá fornecido `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="b9dff-175">Call hello `RestoreAsync` API on hello provided `RestoreContext`.</span></span>
  - <span data-ttu-id="b9dff-176">Retorna VERDADEIRO se a restauração Olá tiver êxito.</span><span class="sxs-lookup"><span data-stu-id="b9dff-176">Return true if hello restoration was a success.</span></span>

<span data-ttu-id="b9dff-177">A seguir está um exemplo de implementação de saudação `OnDataLossAsync` método:</span><span class="sxs-lookup"><span data-stu-id="b9dff-177">Following is an example implementation of hello `OnDataLossAsync` method:</span></span>

```csharp
protected override async Task<bool> OnDataLossAsync(RestoreContext restoreCtx, CancellationToken cancellationToken)
{
    var backupFolder = await this.externalBackupStore.DownloadLastBackupAsync(cancellationToken);

    var restoreDescription = new RestoreDescription(backupFolder);

    await restoreCtx.RestoreAsync(restoreDescription);

    return true;
}
```

<span data-ttu-id="b9dff-178">`RestoreDescription`passado toohello `RestoreContext.RestoreAsync` chamada contém um membro chamado `BackupFolderPath`.</span><span class="sxs-lookup"><span data-stu-id="b9dff-178">`RestoreDescription` passed in toohello `RestoreContext.RestoreAsync` call contains a member called `BackupFolderPath`.</span></span>
<span data-ttu-id="b9dff-179">Ao restaurar um backup completo único, isso `BackupFolderPath` toohello o caminho local da pasta de saudação que contém o backup completo deve ser definido.</span><span class="sxs-lookup"><span data-stu-id="b9dff-179">When restoring a single full backup, this `BackupFolderPath` should be set toohello local path of hello folder that contains your full backup.</span></span>
<span data-ttu-id="b9dff-180">Ao restaurar um backup completo e um número de backups incrementais, `BackupFolderPath` deve ser definido como toohello o caminho local da pasta de saudação que contém não apenas o backup completo do hello, mas também todos os Olá backups incrementais.</span><span class="sxs-lookup"><span data-stu-id="b9dff-180">When restoring a full backup and a number of incremental backups, `BackupFolderPath` should be set toohello local path of hello folder that not only contains hello full backup, but also all hello incremental backups.</span></span>
<span data-ttu-id="b9dff-181">`RestoreAsync`chamada pode lançar `FabricMissingFullBackupException` se hello `BackupFolderPath` fornecido não contém um backup completo.</span><span class="sxs-lookup"><span data-stu-id="b9dff-181">`RestoreAsync` call can throw `FabricMissingFullBackupException` if hello `BackupFolderPath` provided does not contain a full backup.</span></span>
<span data-ttu-id="b9dff-182">Ela também poderá lançar `ArgumentException` se `BackupFolderPath` tiver uma cadeia quebrada de backups incrementais.</span><span class="sxs-lookup"><span data-stu-id="b9dff-182">It can also throw `ArgumentException` if `BackupFolderPath` has a broken chain of incremental backups.</span></span>
<span data-ttu-id="b9dff-183">Por exemplo, se ele contiver Olá backup completo, primeiro Olá incremental e Olá terceiro backup incremental, mas nenhum backup incremental segundo de saudação.</span><span class="sxs-lookup"><span data-stu-id="b9dff-183">For example, if it contains hello full backup, hello first incremental and hello third incremental backup but no hello second incremental backup.</span></span>

> [!NOTE]
> <span data-ttu-id="b9dff-184">Olá RestorePolicy é definido tooSafe por padrão.</span><span class="sxs-lookup"><span data-stu-id="b9dff-184">hello RestorePolicy is set tooSafe by default.</span></span>  <span data-ttu-id="b9dff-185">Isso significa que Olá `RestoreAsync` API falhará com ArgumentException se ele detectar a pasta backup Olá contiver um estado que é o estado de toohello mais antigos do que ou igual contido nesta réplica.</span><span class="sxs-lookup"><span data-stu-id="b9dff-185">This means that hello `RestoreAsync` API will fail with ArgumentException if it detects that hello backup folder contains a state that is older than or equal toohello state contained in this replica.</span></span>  <span data-ttu-id="b9dff-186">`RestorePolicy.Force`pode ser usado tooskip essa verificação de segurança.</span><span class="sxs-lookup"><span data-stu-id="b9dff-186">`RestorePolicy.Force` can be used tooskip this safety check.</span></span> <span data-ttu-id="b9dff-187">Isso é especificado como parte de `RestoreDescription`.</span><span class="sxs-lookup"><span data-stu-id="b9dff-187">This is specified as part of `RestoreDescription`.</span></span>
> 

## <a name="deleted-or-lost-service"></a><span data-ttu-id="b9dff-188">Serviço perdido ou excluído</span><span class="sxs-lookup"><span data-stu-id="b9dff-188">Deleted or lost service</span></span>
<span data-ttu-id="b9dff-189">Se um serviço for removido, você deve primeiro novamente criar hello serviço antes de saudação dados podem ser restaurados.</span><span class="sxs-lookup"><span data-stu-id="b9dff-189">If a service is removed, you must first re-create hello service before hello data can be restored.</span></span>  <span data-ttu-id="b9dff-190">É importante toocreate Olá serviço com hello a mesma configuração, por exemplo, o particionamento de esquema, para que Olá dados pode ser restaurada perfeitamente.</span><span class="sxs-lookup"><span data-stu-id="b9dff-190">It is important toocreate hello service with hello same configuration, e.g., partitioning scheme, so that hello data can be restored seamlessly.</span></span>  <span data-ttu-id="b9dff-191">Após o serviço de hello, Olá dados toorestore de API (`OnDataLossAsync` acima) tem toobe invocado em todas as partições deste serviço.</span><span class="sxs-lookup"><span data-stu-id="b9dff-191">Once hello service is up, hello API toorestore data (`OnDataLossAsync` above) has toobe invoked on every partition of this service.</span></span> <span data-ttu-id="b9dff-192">Uma maneira de fazer isso é usar `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` em cada partição.</span><span class="sxs-lookup"><span data-stu-id="b9dff-192">One way of achieving this is by using `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` on every partition.</span></span>  

<span data-ttu-id="b9dff-193">Desse ponto, a implementação é Olá igual a saudação acima cenário.</span><span class="sxs-lookup"><span data-stu-id="b9dff-193">From this point, implementation is hello same as hello above scenario.</span></span> <span data-ttu-id="b9dff-194">Cada partição deve toorestore hello mais recente relevantes backup do armazenamento externo hello.</span><span class="sxs-lookup"><span data-stu-id="b9dff-194">Each partition needs toorestore hello latest relevant backup from hello external store.</span></span> <span data-ttu-id="b9dff-195">Uma limitação é partição Olá que ID pode agora alterou, como tempo de execução Olá cria IDs de partição dinamicamente.</span><span class="sxs-lookup"><span data-stu-id="b9dff-195">One caveat is that hello partition ID may have now changed, since hello runtime creates partition IDs dynamically.</span></span> <span data-ttu-id="b9dff-196">Assim, Olá serviço precisa de informações de partição apropriado Olá toostore e serviço nome tooidentify Olá correta mais recente backup toorestore de para cada partição.</span><span class="sxs-lookup"><span data-stu-id="b9dff-196">Thus, hello service needs toostore hello appropriate partition information and service name tooidentify hello correct latest backup toorestore from for each partition.</span></span>

> [!NOTE]
> <span data-ttu-id="b9dff-197">Não é recomendável toouse `FabricClient.ServiceManager.InvokeDataLossAsync` em cada partição toorestore Olá todo o serviço, desde que pode corromper o estado do cluster.</span><span class="sxs-lookup"><span data-stu-id="b9dff-197">It is not recommended toouse `FabricClient.ServiceManager.InvokeDataLossAsync` on each partition toorestore hello entire service, since that may corrupt your cluster state.</span></span>
> 

## <a name="replication-of-corrupt-application-data"></a><span data-ttu-id="b9dff-198">Replicação de dados de aplicativo corrompidos</span><span class="sxs-lookup"><span data-stu-id="b9dff-198">Replication of corrupt application data</span></span>
<span data-ttu-id="b9dff-199">Se a atualização de aplicativo hello recentemente implantado tem um bug, que podem causar corrupção de dados.</span><span class="sxs-lookup"><span data-stu-id="b9dff-199">If hello newly deployed application upgrade has a bug, that may cause corruption of data.</span></span> <span data-ttu-id="b9dff-200">Por exemplo, uma atualização de aplicativo pode iniciar tooupdate cada registro do número de telefone em um dicionário confiável com o código de área é inválido.</span><span class="sxs-lookup"><span data-stu-id="b9dff-200">For example, an application upgrade may start tooupdate every phone number record in a Reliable Dictionary with an invalid area code.</span></span>  <span data-ttu-id="b9dff-201">Nesse caso, os números de telefone inválidos hello serão replicados pois Service Fabric não está ciente da natureza de saudação do dados Olá que estão sendo armazenados.</span><span class="sxs-lookup"><span data-stu-id="b9dff-201">In this case, hello invalid phone numbers will be replicated since Service Fabric is not aware of hello nature of hello data that is being stored.</span></span>

<span data-ttu-id="b9dff-202">Olá primeiro toodo após detectar tal um bug atribuiremos que faz com que a corrupção de dados é toofreeze Olá serviço no nível do aplicativo hello e, se possível, atualize a versão toohello saudação do código do aplicativo que não tenha o bug hello.</span><span class="sxs-lookup"><span data-stu-id="b9dff-202">hello first thing toodo after you detect such an egregious bug that causes data corruption is toofreeze hello service at hello application level and, if possible, upgrade toohello version of hello application code that does not have hello bug.</span></span>  <span data-ttu-id="b9dff-203">No entanto, mesmo depois que o código de serviço Olá é fixo, dados saudação ainda podem estar corrompidos e, portanto, os dados podem ter toobe restaurado.</span><span class="sxs-lookup"><span data-stu-id="b9dff-203">However, even after hello service code is fixed, hello data may still be corrupt and thus data may need toobe restored.</span></span>  <span data-ttu-id="b9dff-204">Nesses casos, pode não ser suficiente toorestore Olá backup mais recente, desde que os backups mais recentes Olá também podem estar corrompidos.</span><span class="sxs-lookup"><span data-stu-id="b9dff-204">In such cases, it may not be sufficient toorestore hello latest backup, since hello latest backups may also be corrupt.</span></span>  <span data-ttu-id="b9dff-205">Portanto, você tem toofind Olá último backup feito antes Olá dados foi corrompido.</span><span class="sxs-lookup"><span data-stu-id="b9dff-205">Thus, you have toofind hello last backup that was made before hello data got corrupted.</span></span>

<span data-ttu-id="b9dff-206">Se você não tiver certeza de que os backups estão corrompidos, você pode implantar um novo cluster do Service Fabric e restaure os backups de saudação de partições afetadas como Olá acima "Serviço perdido ou excluído" cenário.</span><span class="sxs-lookup"><span data-stu-id="b9dff-206">If you are not sure which backups are corrupt, you could deploy a new Service Fabric cluster and restore hello backups of affected partitions just like hello above "Deleted or lost service" scenario.</span></span>  <span data-ttu-id="b9dff-207">Para cada partição, inicie a restauração de backups de saudação do toohello mais recente Olá menos.</span><span class="sxs-lookup"><span data-stu-id="b9dff-207">For each partition, start restoring hello backups from hello most recent toohello least.</span></span> <span data-ttu-id="b9dff-208">Depois de encontrar um backup que não possui corrupção hello, mover/excluir todos os backups que estavam mais recentes (que esse backup) dessa partição.</span><span class="sxs-lookup"><span data-stu-id="b9dff-208">Once you find a backup that does not have hello corruption, move/delete all backups of this partition that were more recent (than that backup).</span></span> <span data-ttu-id="b9dff-209">Repita esse processo para cada partição.</span><span class="sxs-lookup"><span data-stu-id="b9dff-209">Repeat this process for each partition.</span></span> <span data-ttu-id="b9dff-210">Agora, quando `OnDataLossAsync` é chamado na partição de saudação em cluster de produção de hello, Olá último backup encontrado em Olá externo repositório será Olá um separado por Olá acima de processo.</span><span class="sxs-lookup"><span data-stu-id="b9dff-210">Now, when `OnDataLossAsync` is called on hello partition in hello production cluster, hello last backup found in hello external store will be hello one picked by hello above process.</span></span>

<span data-ttu-id="b9dff-211">Agora, Olá etapas hello "Serviço perdido ou excluído" seção pode ser usada toorestore estado de saudação do estado do serviço de saudação toohello antes de um código com bug Olá corrompido estado hello.</span><span class="sxs-lookup"><span data-stu-id="b9dff-211">Now, hello steps in hello "Deleted or lost service" section can be used toorestore hello state of hello service toohello state before hello buggy code corrupted hello state.</span></span>

<span data-ttu-id="b9dff-212">Observe que:</span><span class="sxs-lookup"><span data-stu-id="b9dff-212">Note that:</span></span>

  - <span data-ttu-id="b9dff-213">Quando você restaurar, é a possibilidade de Olá backup está sendo restaurado há mais antigo do que o estado de saudação da partição Olá antes Olá dados foram perdidos.</span><span class="sxs-lookup"><span data-stu-id="b9dff-213">When you restore, there is a chance that hello backup being restored is older than hello state of hello partition before hello data was lost.</span></span> <span data-ttu-id="b9dff-214">Por isso, você deve restaurar apenas como um último toorecover de recurso como a quantidade de dados possível.</span><span class="sxs-lookup"><span data-stu-id="b9dff-214">Because of this, you should restore only as a last resort toorecover as much data as possible.</span></span>
  - <span data-ttu-id="b9dff-215">Olá a cadeia de caracteres que representa o caminho da pasta de backup de saudação e hello caminhos de arquivos dentro da pasta de backup Olá podem ser maiores que 255 caracteres, dependendo do caminho de FabricDataRoot hello e o comprimento do nome do tipo de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="b9dff-215">hello string that represents hello backup folder path and hello paths of files inside hello backup folder can be greater than 255 characters, depending on hello FabricDataRoot path and Application Type name's length.</span></span> <span data-ttu-id="b9dff-216">Isso pode causar alguns métodos do .NET, como `Directory.Move`, Olá toothrow `PathTooLongException` exceção.</span><span class="sxs-lookup"><span data-stu-id="b9dff-216">This can cause some .NET methods, like `Directory.Move`, toothrow hello `PathTooLongException` exception.</span></span> <span data-ttu-id="b9dff-217">Uma solução alternativa é toodirectly chamar APIs kernel32, como `CopyFile`.</span><span class="sxs-lookup"><span data-stu-id="b9dff-217">One workaround is toodirectly call kernel32 APIs, like `CopyFile`.</span></span>

## <a name="backup-and-restore-reliable-actors"></a><span data-ttu-id="b9dff-218">Fazer backup e restaurar Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="b9dff-218">Backup and restore Reliable Actors</span></span>


<span data-ttu-id="b9dff-219">A Estrutura Reliable Actors foi criada com base nos Reliable Services.</span><span class="sxs-lookup"><span data-stu-id="b9dff-219">Reliable Actors Framework is built on top of Reliable Services.</span></span> <span data-ttu-id="b9dff-220">Olá ActorService que hospeda Olá actor(s) é um serviço confiável com monitoração de estado.</span><span class="sxs-lookup"><span data-stu-id="b9dff-220">hello ActorService which hosts hello actor(s) is a stateful reliable service.</span></span> <span data-ttu-id="b9dff-221">Portanto, todos Olá backup e restauração funcionalidade disponível nos serviços confiáveis também atores tooReliable disponíveis (exceto comportamentos que são específicas do provedor de estado).</span><span class="sxs-lookup"><span data-stu-id="b9dff-221">Hence, all hello backup and restore functionality available in Reliable Services is also available tooReliable Actors (except behaviors that are state provider specific).</span></span> <span data-ttu-id="b9dff-222">Uma vez que os backups serão usados por partição, será feito backup dos estados de todos os atores nessa partição (e a restauração é semelhante e acontecerá de acordo com a partição).</span><span class="sxs-lookup"><span data-stu-id="b9dff-222">Since backups will be taken on a per-partition basis, states for all actors in that partition will be backed up (and restoration is similar and will happen on a per-partition basis).</span></span> <span data-ttu-id="b9dff-223">tooperform backup/restauração, o proprietário do serviço Olá deve criar uma classe de serviço de ator personalizado que deriva da classe ActorService e, em seguida, backup/restauração tooReliable semelhante serviços, conforme descritos nas seções anteriores.</span><span class="sxs-lookup"><span data-stu-id="b9dff-223">tooperform backup/restore, hello service owner should create a custom actor service class that derives from ActorService class and then do backup/restore similar tooReliable Services as described above in previous sections.</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo)
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="b9dff-224">Quando você cria uma classe de serviço de ator personalizado, é necessário tooregister que também ao registrar o ator hello.</span><span class="sxs-lookup"><span data-stu-id="b9dff-224">When you create a custom actor service class, you need tooregister that as well when registering hello actor.</span></span>

```csharp
ActorRuntime.RegisterActorAsync<MyActor>(
   (context, typeInfo) => new MyCustomActorService(context, typeInfo)).GetAwaiter().GetResult();
```

<span data-ttu-id="b9dff-225">provedor de estado saudação padrão para Reliable Actors é `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="b9dff-225">hello default state provider for Reliable Actors is `KvsActorStateProvider`.</span></span> <span data-ttu-id="b9dff-226">O backup incremental não é habilitado por padrão para `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="b9dff-226">Incremental backup is not enabled by default for `KvsActorStateProvider`.</span></span> <span data-ttu-id="b9dff-227">Você pode habilitar o backup incremental criando `KvsActorStateProvider` com hello adequado definindo no seu construtor e, em seguida, passando-o construtor tooActorService conforme mostrado no trecho de código a seguir:</span><span class="sxs-lookup"><span data-stu-id="b9dff-227">You can enable incremental backup by creating `KvsActorStateProvider` with hello appropriate setting in its constructor and then passing it tooActorService constructor as shown in following code snippet:</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo, null, null, new KvsActorStateProvider(true)) // Enable incremental backup
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="b9dff-228">Após a habilitação do backup incremental, fazer um backup incremental pode falhar com FabricMissingFullBackupException por um dos seguintes motivos e você precisará tootake um backup completo antes de colocar um ou mais backups incremental:</span><span class="sxs-lookup"><span data-stu-id="b9dff-228">After incremental backup has been enabled, taking an incremental backup can fail with FabricMissingFullBackupException for one of following reasons and you will need tootake a full backup before taking incremental backup(s):</span></span>

  - <span data-ttu-id="b9dff-229">réplica Olá nunca obteve um backup completo quando ele se tornou primário.</span><span class="sxs-lookup"><span data-stu-id="b9dff-229">hello replica has never taken a full backup since it became primary.</span></span>
  - <span data-ttu-id="b9dff-230">Alguns dos registros de log Olá foram truncadas desde o último backup foi feito.</span><span class="sxs-lookup"><span data-stu-id="b9dff-230">Some of hello log records were truncated since last backup was taken.</span></span>

<span data-ttu-id="b9dff-231">Quando o backup incremental é habilitado, `KvsActorStateProvider` não usa buffer circular toomanage seu log de registros e trunca periodicamente.</span><span class="sxs-lookup"><span data-stu-id="b9dff-231">When incremental backup is enabled, `KvsActorStateProvider` does not use circular buffer toomanage its log records and periodically truncates it.</span></span> <span data-ttu-id="b9dff-232">Se nenhum backup é feito por usuário por um período de 45 minutos, o sistema Olá trunca automaticamente registros de log de saudação.</span><span class="sxs-lookup"><span data-stu-id="b9dff-232">If no backup is taken by user for a period of 45 minutes, hello system automatically truncates hello log records.</span></span> <span data-ttu-id="b9dff-233">Esse intervalo pode ser configurado com a especificação de `logTrunctationIntervalInMinutes` na `KvsActorStateProvider` construtor (semelhante toowhen habilitar o backup incremental).</span><span class="sxs-lookup"><span data-stu-id="b9dff-233">This interval can be configured by specifying `logTrunctationIntervalInMinutes` in `KvsActorStateProvider` constructor (similar toowhen enabling incremental backup).</span></span> <span data-ttu-id="b9dff-234">registros de log Olá também podem obter truncados se a réplica primária precisa toobuild outra réplica enviando todos os seus dados.</span><span class="sxs-lookup"><span data-stu-id="b9dff-234">hello log records may also get truncated if primary replica need toobuild another replica by sending all its data.</span></span>

<span data-ttu-id="b9dff-235">Ao fazer a restauração a partir de uma cadeia de backup, serviços tooReliable semelhantes, Olá BackupFolderPath deve conter subdiretórios com um subdiretório contendo backup completo e outros subdiretórios que contém um ou mais backups incremental.</span><span class="sxs-lookup"><span data-stu-id="b9dff-235">When doing restore from a backup chain, similar tooReliable Services, hello BackupFolderPath should contain subdirectories with one subdirectory containing full backup and others subdirectories containing incremental backup(s).</span></span> <span data-ttu-id="b9dff-236">API de restauração Olá lançará FabricException com a mensagem de erro apropriada se houver falha na validação da cadeia de backup de saudação.</span><span class="sxs-lookup"><span data-stu-id="b9dff-236">hello restore API will throw FabricException with appropriate error message if hello backup chain validation fails.</span></span> 

> [!NOTE]
> <span data-ttu-id="b9dff-237">`KvsActorStateProvider`Atualmente, ignora a opção de saudação RestorePolicy.Safe.</span><span class="sxs-lookup"><span data-stu-id="b9dff-237">`KvsActorStateProvider` currently ignores hello option RestorePolicy.Safe.</span></span> <span data-ttu-id="b9dff-238">O suporte a esse recurso está planejado para uma versão futura.</span><span class="sxs-lookup"><span data-stu-id="b9dff-238">Support for this feature is planned in an upcoming release.</span></span>
> 

## <a name="testing-backup-and-restore"></a><span data-ttu-id="b9dff-239">Testando o backup e a restauração</span><span class="sxs-lookup"><span data-stu-id="b9dff-239">Testing Backup and Restore</span></span>
<span data-ttu-id="b9dff-240">É importante tooensure que dados críticos está sendo feitos e podem ser restaurados.</span><span class="sxs-lookup"><span data-stu-id="b9dff-240">It is important tooensure that critical data is being backed up, and can be restored from.</span></span> <span data-ttu-id="b9dff-241">Isso pode ser feito por meio de invocação Olá `Start-ServiceFabricPartitionDataLoss` cmdlet do PowerShell que pode provocar perda de dados em uma determinada partição tootest se dados saudação de backup e restaurar a funcionalidade para o serviço está funcionando conforme o esperado.</span><span class="sxs-lookup"><span data-stu-id="b9dff-241">This can be done by invoking hello `Start-ServiceFabricPartitionDataLoss` cmdlet in PowerShell that can induce data loss in a particular partition tootest whether hello data backup and restore functionality for your service is working as expected.</span></span>  <span data-ttu-id="b9dff-242">Também é possível tooprogrammatically invocar a perda de dados e restaurar a partir desse evento também.</span><span class="sxs-lookup"><span data-stu-id="b9dff-242">It is also possible tooprogrammatically invoke data loss and restore from that event as well.</span></span>

> [!NOTE]
> <span data-ttu-id="b9dff-243">Você pode encontrar um exemplo da implementação de backup e restaurar a funcionalidade em Olá aplicativo de referência da Web no GitHub.</span><span class="sxs-lookup"><span data-stu-id="b9dff-243">You can find a sample implementation of backup and restore functionality in hello Web Reference App on GitHub.</span></span> <span data-ttu-id="b9dff-244">Examine a saudação `Inventory.Service` serviço para obter mais detalhes.</span><span class="sxs-lookup"><span data-stu-id="b9dff-244">Please look at hello `Inventory.Service` service for more details.</span></span>
> 
> 

## <a name="under-hello-hood-more-details-on-backup-and-restore"></a><span data-ttu-id="b9dff-245">Bastidores Olá: para obter mais detalhes sobre o backup e restauração</span><span class="sxs-lookup"><span data-stu-id="b9dff-245">Under hello hood: more details on backup and restore</span></span>
<span data-ttu-id="b9dff-246">Veja mais alguns detalhes sobre backup e restauração.</span><span class="sxs-lookup"><span data-stu-id="b9dff-246">Here's some more details on backup and restore.</span></span>

### <a name="backup"></a><span data-ttu-id="b9dff-247">Backup</span><span class="sxs-lookup"><span data-stu-id="b9dff-247">Backup</span></span>
<span data-ttu-id="b9dff-248">Olá Gerenciador de estado confiável fornece backups consistentes do hello capacidade toocreate sem bloquear qualquer ler ou gravar operações.</span><span class="sxs-lookup"><span data-stu-id="b9dff-248">hello Reliable State Manager provides hello ability toocreate consistent backups without blocking any read or write operations.</span></span> <span data-ttu-id="b9dff-249">toodo assim, ele utiliza um mecanismo de persistência do ponto de verificação e log.</span><span class="sxs-lookup"><span data-stu-id="b9dff-249">toodo so, it utilizes a checkpoint and log persistence mechanism.</span></span>  <span data-ttu-id="b9dff-250">Olá Gerenciador de estado confiável usa difusas pontos de verificação (lightweight) em determinados pressão de toorelieve pontos do log transacional hello e melhorar os tempos de recuperação.</span><span class="sxs-lookup"><span data-stu-id="b9dff-250">hello Reliable State Manager takes fuzzy (lightweight) checkpoints at certain points toorelieve pressure from hello transactional log and improve recovery times.</span></span>  <span data-ttu-id="b9dff-251">Quando `BackupAsync` é chamado, Olá Gerenciador de estado confiável instrui toocopy de todos os objetos confiável seu último ponto de verificação arquivos tooa pasta backup local.</span><span class="sxs-lookup"><span data-stu-id="b9dff-251">When `BackupAsync` is called, hello Reliable State Manager instructs all Reliable objects toocopy their latest checkpoint files tooa local backup folder.</span></span>  <span data-ttu-id="b9dff-252">Em seguida, Olá Gerenciador de estado confiável copia todos os registros de log, começando pela hello "iniciar o ponteiro" toohello último registro de log na pasta de backup hello.</span><span class="sxs-lookup"><span data-stu-id="b9dff-252">Then, hello Reliable State Manager copies all log records, starting from hello "start pointer" toohello latest log record into hello backup folder.</span></span>  <span data-ttu-id="b9dff-253">Como todos os registros de log Olá toohello registro de log mais recente são incluídos no backup hello e Gerenciador de estado confiável de saudação preserva o log write-ahead, Olá Gerenciador de estado confiável garante que todas as transações que são confirmadas (`CommitAsync` retornou com êxito) são incluídos no backup de saudação.</span><span class="sxs-lookup"><span data-stu-id="b9dff-253">Since all hello log records up toohello latest log record are included in hello backup and hello Reliable State Manager preserves write-ahead logging, hello Reliable State Manager guarantees that all transactions that are committed (`CommitAsync` has returned successfully) are included in hello backup.</span></span>

<span data-ttu-id="b9dff-254">Qualquer transação confirmada após `BackupAsync` foi chamado pode ou não estejam no backup hello.</span><span class="sxs-lookup"><span data-stu-id="b9dff-254">Any transaction that commits after `BackupAsync` has been called may or may not be in hello backup.</span></span>  <span data-ttu-id="b9dff-255">Depois que a pasta de backup local Olá foi preenchida pela plataforma hello (ou seja, o backup local é concluído pelo tempo de execução de saudação), retorno de chamada de backup do serviço de saudação é invocado.</span><span class="sxs-lookup"><span data-stu-id="b9dff-255">Once hello local backup folder has been populated by hello platform (i.e., local backup is completed by hello runtime), hello service's backup callback is invoked.</span></span>  <span data-ttu-id="b9dff-256">Esse retorno de chamada é responsável por mover Olá pasta de backup tooan local externo, como o armazenamento do Azure.</span><span class="sxs-lookup"><span data-stu-id="b9dff-256">This callback is responsible for moving hello backup folder tooan external location such as Azure Storage.</span></span>

### <a name="restore"></a><span data-ttu-id="b9dff-257">Restaurar</span><span class="sxs-lookup"><span data-stu-id="b9dff-257">Restore</span></span>
<span data-ttu-id="b9dff-258">Olá Gerenciador de estado confiável fornece Olá toorestore de capacidade de um backup usando Olá `RestoreAsync` API.</span><span class="sxs-lookup"><span data-stu-id="b9dff-258">hello Reliable State Manager provides hello ability toorestore from a backup by using hello `RestoreAsync` API.</span></span>  
<span data-ttu-id="b9dff-259">Olá `RestoreAsync` método `RestoreContext` pode ser chamado somente no hello `OnDataLossAsync` método.</span><span class="sxs-lookup"><span data-stu-id="b9dff-259">hello `RestoreAsync` method on `RestoreContext` can be called only inside hello `OnDataLossAsync` method.</span></span>
<span data-ttu-id="b9dff-260">Olá bool retornado por `OnDataLossAsync` indica se o serviço de saudação restaurado a seu estado de uma fonte externa.</span><span class="sxs-lookup"><span data-stu-id="b9dff-260">hello bool returned by `OnDataLossAsync` indicates whether hello service restored its state from an external source.</span></span>
<span data-ttu-id="b9dff-261">Se hello `OnDataLossAsync` retorna true, o Service Fabric reconstruirá todas as outras réplicas desse primário.</span><span class="sxs-lookup"><span data-stu-id="b9dff-261">If hello `OnDataLossAsync` returns true, Service Fabric will rebuild all other replicas from this primary.</span></span> <span data-ttu-id="b9dff-262">Service Fabric garante que receberão as réplicas `OnDataLossAsync` chamar a função primária do primeiro transição toohello, mas não são legíveis concedeu status ou gravar o status.</span><span class="sxs-lookup"><span data-stu-id="b9dff-262">Service Fabric ensures that replicas that will receive `OnDataLossAsync` call first transition toohello primary role but are not granted read status or write status.</span></span>
<span data-ttu-id="b9dff-263">Isso significa que, para os implementadores de StatefulService, `RunAsync` não será chamado até que `OnDataLossAsync` seja concluído com êxito.</span><span class="sxs-lookup"><span data-stu-id="b9dff-263">This implies that for StatefulService implementers, `RunAsync` will not be called until `OnDataLossAsync` finishes successfully.</span></span>
<span data-ttu-id="b9dff-264">Em seguida, `OnDataLossAsync` será invocado no novo primário de saudação.</span><span class="sxs-lookup"><span data-stu-id="b9dff-264">Then, `OnDataLossAsync` will be invoked on hello new primary.</span></span>
<span data-ttu-id="b9dff-265">Até que um serviço é concluída essa API com êxito (retornando true ou false) e conclusão da reconfiguração relevantes Olá, Olá API será manter sendo chamado um de cada vez.</span><span class="sxs-lookup"><span data-stu-id="b9dff-265">Until a service completes this API successfully (by returning true or false) and finishes hello relevant reconfiguration, hello API will keep being called one at a time.</span></span>

<span data-ttu-id="b9dff-266">`RestoreAsync`primeiro descarta todos os estados existentes na réplica primária de saudação que ele foi chamado em.</span><span class="sxs-lookup"><span data-stu-id="b9dff-266">`RestoreAsync` first drops all existing state in hello primary replica that it was called on.</span></span>  
<span data-ttu-id="b9dff-267">Olá Gerenciador de estado confiável cria todos os objetos de saudação confiável que existem na pasta de backup hello.</span><span class="sxs-lookup"><span data-stu-id="b9dff-267">Then hello Reliable State Manager creates all hello Reliable objects that exist in hello backup folder.</span></span>  
<span data-ttu-id="b9dff-268">Em seguida, objetos confiável Olá são instruções toorestore dos seus pontos de verificação na pasta de backup hello.</span><span class="sxs-lookup"><span data-stu-id="b9dff-268">Next, hello Reliable objects are instructed toorestore from their checkpoints in hello backup folder.</span></span>  
<span data-ttu-id="b9dff-269">Por fim, Olá Gerenciador de estado confiável recupera seu próprio estado Olá dos registros de log na pasta de backup hello e executa a recuperação.</span><span class="sxs-lookup"><span data-stu-id="b9dff-269">Finally, hello Reliable State Manager recovers its own state from hello log records in hello backup folder and performs recovery.</span></span>  
<span data-ttu-id="b9dff-270">Como parte do processo de recuperação Olá, hello "ponto de partida" a partir de operações que têm registros de log de confirmação na pasta de backup de saudação são objetos confiável toohello reproduzido.</span><span class="sxs-lookup"><span data-stu-id="b9dff-270">As part of hello recovery process, operations starting from hello "starting point" that have commit log records in hello backup folder are replayed toohello Reliable objects.</span></span>  
<span data-ttu-id="b9dff-271">Essa etapa garante que Olá estado recuperado é consistente.</span><span class="sxs-lookup"><span data-stu-id="b9dff-271">This step ensures that hello recovered state is consistent.</span></span>

## <a name="next-steps"></a><span data-ttu-id="b9dff-272">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="b9dff-272">Next steps</span></span>
  - [<span data-ttu-id="b9dff-273">Coleções Confiáveis</span><span class="sxs-lookup"><span data-stu-id="b9dff-273">Reliable Collections</span></span>](service-fabric-work-with-reliable-collections.md)
  - [<span data-ttu-id="b9dff-274">Início Rápido dos Serviços Confiáveis</span><span class="sxs-lookup"><span data-stu-id="b9dff-274">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
  - [<span data-ttu-id="b9dff-275">Notificações do Reliable Services</span><span class="sxs-lookup"><span data-stu-id="b9dff-275">Reliable Services notifications</span></span>](service-fabric-reliable-services-notifications.md)
  - [<span data-ttu-id="b9dff-276">Configuração do Reliable Services</span><span class="sxs-lookup"><span data-stu-id="b9dff-276">Reliable Services configuration</span></span>](service-fabric-reliable-services-configuration.md)
  - [<span data-ttu-id="b9dff-277">Referência do desenvolvedor para Coleções Confiáveis</span><span class="sxs-lookup"><span data-stu-id="b9dff-277">Developer reference for Reliable Collections</span></span>](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)

