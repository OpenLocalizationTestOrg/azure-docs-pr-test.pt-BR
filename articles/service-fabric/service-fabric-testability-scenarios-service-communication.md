---
title: "Possibilidade de teste: comunicação de serviço | Microsoft Docs"
description: "As comunicação entre serviços é um ponto de integração essencial de um aplicativo da Malha do Serviço. Este artigo aborda as considerações de design e as técnicas de teste."
services: service-fabric
documentationcenter: .net
author: vturecek
manager: timlt
editor: 
ms.assetid: 017557df-fb59-4e4a-a65d-2732f29255b8
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 06/29/2017
ms.author: vturecek
ms.openlocfilehash: c182cc2062ada40029504de5b2b64b021c614ce6
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="service-fabric-testability-scenarios-service-communication"></a><span data-ttu-id="9fb03-104">Cenários de Possibilidade de Teste do Service Fabric: Comunicação do serviço</span><span class="sxs-lookup"><span data-stu-id="9fb03-104">Service Fabric testability scenarios: Service communication</span></span>
<span data-ttu-id="9fb03-105">Os estilos de arquitetura orientada a serviços e microsserviços surgem naturalmente no Azure Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="9fb03-105">Microservices and service-oriented architectural styles surface naturally in Azure Service Fabric.</span></span> <span data-ttu-id="9fb03-106">Nesses tipos de arquiteturas distribuídas, os aplicativos de microsserviço divididos em componentes são compostos normalmente por vários serviços que precisam se comunicar.</span><span class="sxs-lookup"><span data-stu-id="9fb03-106">In these types of distributed architectures, componentized microservice applications are typically composed of multiple services that need to talk to each other.</span></span> <span data-ttu-id="9fb03-107">Mesmo nos casos mais simples, há geralmente pelo menos um serviço Web sem estado e um serviço de armazenamento de dados com estado que precisam se comunicar.</span><span class="sxs-lookup"><span data-stu-id="9fb03-107">In even the simplest cases, you generally have at least a stateless web service and a stateful data storage service that need to communicate.</span></span>

<span data-ttu-id="9fb03-108">A comunicação entre os serviços é um ponto de integração essencial de um aplicativo, já que cada serviço expõe uma API remota para outros serviços.</span><span class="sxs-lookup"><span data-stu-id="9fb03-108">Service-to-service communication is a critical integration point of an application, because each service exposes a remote API to other services.</span></span> <span data-ttu-id="9fb03-109">Trabalhar com um conjunto de limites de API que envolve E/S geralmente exige algum cuidado e uma boa quantidade de teste e validação.</span><span class="sxs-lookup"><span data-stu-id="9fb03-109">Working with a set of API boundaries that involves I/O generally requires some care, with a good amount of testing and validation.</span></span>

<span data-ttu-id="9fb03-110">Há várias considerações a serem feitas quando esses limites de serviço são conectados em um sistema distribuído:</span><span class="sxs-lookup"><span data-stu-id="9fb03-110">There are numerous considerations to make when these service boundaries are wired together in a distributed system:</span></span>

* <span data-ttu-id="9fb03-111">*Protocolo de transporte*.</span><span class="sxs-lookup"><span data-stu-id="9fb03-111">*Transport protocol*.</span></span> <span data-ttu-id="9fb03-112">Você usará HTTP para maior interoperabilidade, ou um protocolo binário personalizado para taxa de transferência máxima?</span><span class="sxs-lookup"><span data-stu-id="9fb03-112">Will you use HTTP for increased interoperability, or a custom binary protocol for maximum throughput?</span></span>
* <span data-ttu-id="9fb03-113">*Manipulação de erros*.</span><span class="sxs-lookup"><span data-stu-id="9fb03-113">*Error handling*.</span></span> <span data-ttu-id="9fb03-114">Como os erros transitórios e permanentes serão tratados?</span><span class="sxs-lookup"><span data-stu-id="9fb03-114">How will permanent and transient errors be handled?</span></span> <span data-ttu-id="9fb03-115">O que acontecerá quando um serviço for movido para um nó diferente?</span><span class="sxs-lookup"><span data-stu-id="9fb03-115">What will happen when a service moves to a different node?</span></span>
* <span data-ttu-id="9fb03-116">*Tempos limite e latência*.</span><span class="sxs-lookup"><span data-stu-id="9fb03-116">*Timeouts and latency*.</span></span> <span data-ttu-id="9fb03-117">Em aplicativos com várias camadas, como cada camada de serviço lidará com a latência por meio da pilha e até o usuário?</span><span class="sxs-lookup"><span data-stu-id="9fb03-117">In multitiered applications, how will each service layer handle latency through the stack and to the user?</span></span>

<span data-ttu-id="9fb03-118">Se você usa um dos componentes integrados de comunicação de serviço fornecidos pelo Service Fabric ou compila seu próprio, testar as interações entre os serviços é fundamental para garantir a resiliência em seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="9fb03-118">Whether you use one of the built-in service communication components provided by Service Fabric or you build your own, testing the interactions between your services is critical to ensuring resiliency in your application.</span></span>

## <a name="prepare-for-services-to-move"></a><span data-ttu-id="9fb03-119">Preparar-se para mover os serviços</span><span class="sxs-lookup"><span data-stu-id="9fb03-119">Prepare for services to move</span></span>
<span data-ttu-id="9fb03-120">As instâncias do serviço podem se movimentar com o tempo.</span><span class="sxs-lookup"><span data-stu-id="9fb03-120">Service instances may move around over time.</span></span> <span data-ttu-id="9fb03-121">Isso acontece especialmente quando são configuradas com métricas de carga para balanceamento personalizado e ideal de recursos.</span><span class="sxs-lookup"><span data-stu-id="9fb03-121">This is especially true when they are configured with load metrics for custom-tailored optimal resource balancing.</span></span> <span data-ttu-id="9fb03-122">O Service Fabric move suas instâncias de serviço a fim de maximizar a disponibilidade até mesmo durante atualizações, failovers, expansão e outras situações que ocorrem durante o tempo de vida de um sistema distribuído.</span><span class="sxs-lookup"><span data-stu-id="9fb03-122">Service Fabric moves your service instances to maximize their availability even during upgrades, failovers, scale-out, and other situations that occur over the lifetime of a distributed system.</span></span>

<span data-ttu-id="9fb03-123">À medida que os serviços se movimentam pelo cluster, seus clientes e outros serviços devem estar preparados para lidar com dois cenários ao conversar com um serviço:</span><span class="sxs-lookup"><span data-stu-id="9fb03-123">As services move around in the cluster, your clients and other services should be prepared to handle two scenarios when they talk to a service:</span></span>

* <span data-ttu-id="9fb03-124">A instância do serviço ou réplica da partição foi movida desde a última vez que você conversou com ela.</span><span class="sxs-lookup"><span data-stu-id="9fb03-124">The service instance or partition replica has moved since the last time you talked to it.</span></span> <span data-ttu-id="9fb03-125">Essa é uma parte normal do ciclo de vida do serviço e deve acontecer durante o tempo de vida do seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="9fb03-125">This is a normal part of a service lifecycle, and it should be expected to happen during the lifetime of your application.</span></span>
* <span data-ttu-id="9fb03-126">A instância do serviço ou a réplica da partição está se movimentando.</span><span class="sxs-lookup"><span data-stu-id="9fb03-126">The service instance or partition replica is in the process of moving.</span></span> <span data-ttu-id="9fb03-127">Embora o failover de um serviço de um nó para outro ocorra rapidamente na Malha do Serviço, pode haver um atraso na disponibilidade se o componente de comunicação do serviço iniciar de forma lenta.</span><span class="sxs-lookup"><span data-stu-id="9fb03-127">Although failover of a service from one node to another occurs very quickly in Service Fabric, there may be a delay in availability if the communication component of your service is slow to start.</span></span>

<span data-ttu-id="9fb03-128">A manipulação tranquila desses cenários é importante para um sistema em execução adequada.</span><span class="sxs-lookup"><span data-stu-id="9fb03-128">Handling these scenarios gracefully is important for a smooth-running system.</span></span> <span data-ttu-id="9fb03-129">Para fazer isso, lembre-se que:</span><span class="sxs-lookup"><span data-stu-id="9fb03-129">To do so, keep in mind that:</span></span>

* <span data-ttu-id="9fb03-130">Todos os serviços aos quais é possível se conectar têm um *endereço* no qual escutam (por exemplo, HTTP ou WebSockets).</span><span class="sxs-lookup"><span data-stu-id="9fb03-130">Every service that can be connected to has an *address* that it listens on (for example, HTTP or WebSockets).</span></span> <span data-ttu-id="9fb03-131">Quando uma instância de serviço ou partição se move, altera seu ponto de extremidade do endereço.</span><span class="sxs-lookup"><span data-stu-id="9fb03-131">When a service instance or partition moves, its address endpoint changes.</span></span> <span data-ttu-id="9fb03-132">(É movido para um nó diferente com um endereço IP diferente). Se você estiver usando os componentes integrados de comunicação, eles manipularão a nova resolução dos endereços de serviço para você.</span><span class="sxs-lookup"><span data-stu-id="9fb03-132">(It moves to a different node with a different IP address.) If you're using the built-in communication components, they will handle re-resolving service addresses for you.</span></span>
* <span data-ttu-id="9fb03-133">Pode haver um aumento temporário na latência do serviço à medida que a instância do serviço começa sua escuta novamente.</span><span class="sxs-lookup"><span data-stu-id="9fb03-133">There may be a temporary increase in service latency as the service instance starts up its listener again.</span></span> <span data-ttu-id="9fb03-134">Isso depende da rapidez com que serviço abre após a movimentação da instância do serviço.</span><span class="sxs-lookup"><span data-stu-id="9fb03-134">This depends on how quickly the service opens the listener after the service instance is moved.</span></span>
* <span data-ttu-id="9fb03-135">Quaisquer conexões existentes precisam ser fechadas e reabertas quando o serviço for aberto em um novo nó.</span><span class="sxs-lookup"><span data-stu-id="9fb03-135">Any existing connections need to be closed and reopened after the service opens on a new node.</span></span> <span data-ttu-id="9fb03-136">Um desligamento ou reinicialização de nó proporciona tempo para o desligamento correto das conexões existentes.</span><span class="sxs-lookup"><span data-stu-id="9fb03-136">A graceful node shutdown or restart allows time for existing connections to be shut down gracefully.</span></span>

### <a name="test-it-move-service-instances"></a><span data-ttu-id="9fb03-137">Teste: Mover instâncias do serviço</span><span class="sxs-lookup"><span data-stu-id="9fb03-137">Test it: Move service instances</span></span>
<span data-ttu-id="9fb03-138">Usando ferramentas de Possibilidade de Teste do Service Fabric, é possível criar um cenário de teste para testar essas situações de maneiras diferentes:</span><span class="sxs-lookup"><span data-stu-id="9fb03-138">By using Service Fabric's testability tools, you can author a test scenario to test these situations in different ways:</span></span>

1. <span data-ttu-id="9fb03-139">Mova a réplica primária de um serviço com estado.</span><span class="sxs-lookup"><span data-stu-id="9fb03-139">Move a stateful service's primary replica.</span></span>
   
    <span data-ttu-id="9fb03-140">A réplica primária de uma partição de serviço com estado pode ser movida por vários motivos.</span><span class="sxs-lookup"><span data-stu-id="9fb03-140">The primary replica of a stateful service partition can be moved for any number of reasons.</span></span> <span data-ttu-id="9fb03-141">Use isso para direcionar a réplica primária de uma partição específica para ver como os serviços reagem à movimentação de uma maneira muito controlada.</span><span class="sxs-lookup"><span data-stu-id="9fb03-141">Use this to target the primary replica of a specific partition to see how your services react to the move in a very controlled manner.</span></span>
   
    ```powershell
   
    PS > Move-ServiceFabricPrimaryReplica -PartitionId 6faa4ffa-521a-44e9-8351-dfca0f7e0466 -ServiceName fabric:/MyApplication/MyService
   
    ```
2. <span data-ttu-id="9fb03-142">Parar um nó.</span><span class="sxs-lookup"><span data-stu-id="9fb03-142">Stop a node.</span></span>
   
    <span data-ttu-id="9fb03-143">Quando um nó for interrompido, o Service Fabric moverá todas as instâncias ou partições de serviço que estavam nesse nó para um dos nós disponíveis no cluster.</span><span class="sxs-lookup"><span data-stu-id="9fb03-143">When a node is stopped, Service Fabric moves all of the service instances or partitions that were on that node to one of the other available nodes in the cluster.</span></span> <span data-ttu-id="9fb03-144">Use isso para testar uma situação na qual um nó é perdido em seu cluster e todas as instâncias e réplicas do serviço nesse nó precisam ser movidas.</span><span class="sxs-lookup"><span data-stu-id="9fb03-144">Use this to test a situation where a node is lost from your cluster and all of the service instances and replicas on that node have to move.</span></span>
   
    <span data-ttu-id="9fb03-145">Pode-se interromper um nó usando o cmdlet **Stop-ServiceFabricNode** PowerShell:</span><span class="sxs-lookup"><span data-stu-id="9fb03-145">You can stop a node by using the PowerShell **Stop-ServiceFabricNode** cmdlet:</span></span>
   
    ```powershell
   
    PS > Restart-ServiceFabricNode -NodeName Node_1
   
    ```

## <a name="maintain-service-availability"></a><span data-ttu-id="9fb03-146">Manter a disponibilidade do serviço</span><span class="sxs-lookup"><span data-stu-id="9fb03-146">Maintain service availability</span></span>
<span data-ttu-id="9fb03-147">O Service Fabric é uma plataforma projetada para fornecer alta disponibilidade para seus serviços.</span><span class="sxs-lookup"><span data-stu-id="9fb03-147">As a platform, Service Fabric is designed to provide high availability of your services.</span></span> <span data-ttu-id="9fb03-148">Em casos extremos, porém, os problemas de infraestrutura subjacentes ainda podem causar indisponibilidade.</span><span class="sxs-lookup"><span data-stu-id="9fb03-148">But in extreme cases, underlying infrastructure problems can still cause unavailability.</span></span> <span data-ttu-id="9fb03-149">Também é importante fazer um teste para esses cenários.</span><span class="sxs-lookup"><span data-stu-id="9fb03-149">It is important to test for these scenarios, too.</span></span>

<span data-ttu-id="9fb03-150">Serviços com estado usam um sistema baseado em quorum para replicar o estado a fim de obter alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="9fb03-150">Stateful services use a quorum-based system to replicate state for high availability.</span></span> <span data-ttu-id="9fb03-151">Isso significa que um quorum de réplicas precisa estar disponível a fim de executar operações de gravação.</span><span class="sxs-lookup"><span data-stu-id="9fb03-151">This means that a quorum of replicas needs to be available to perform write operations.</span></span> <span data-ttu-id="9fb03-152">Em casos raros, como em uma falha generalizada de hardware, talvez um quorum de réplicas não esteja disponível.</span><span class="sxs-lookup"><span data-stu-id="9fb03-152">In rare cases, such as a widespread hardware failure, a quorum of replicas may not be available.</span></span> <span data-ttu-id="9fb03-153">Nesses casos, você não poderá executar operações de gravação, mas ainda conseguirá executar operações de leitura.</span><span class="sxs-lookup"><span data-stu-id="9fb03-153">In these cases, you will not be able to perform write operations, but you will still be able to perform read operations.</span></span>

### <a name="test-it-write-operation-unavailability"></a><span data-ttu-id="9fb03-154">Teste: Indisponibilidade da operação de gravação</span><span class="sxs-lookup"><span data-stu-id="9fb03-154">Test it: Write operation unavailability</span></span>
<span data-ttu-id="9fb03-155">Ao usar as ferramentas de possibilidade de teste no Service Fabric, pode-se injetar uma falha que induza a perda de quorum como teste.</span><span class="sxs-lookup"><span data-stu-id="9fb03-155">By using the testability tools in Service Fabric, you can inject a fault that induces quorum loss as a test.</span></span> <span data-ttu-id="9fb03-156">Embora tal cenário seja raro, é importante que os clientes e serviços que dependem do serviço com estado sejam preparados para lidar com situações nas quais não podem fazer solicitações de gravação para ele.</span><span class="sxs-lookup"><span data-stu-id="9fb03-156">Although such a scenario is rare, it is important that clients and services that depend on a stateful service are prepared to handle situations where they cannot make write requests to it.</span></span> <span data-ttu-id="9fb03-157">Também é importante que o próprio serviço com estado reconheça essa possibilidade e possa comunicá-la adequadamente aos chamadores.</span><span class="sxs-lookup"><span data-stu-id="9fb03-157">It is also important that the stateful service itself is aware of this possibility and can gracefully communicate it to callers.</span></span>

<span data-ttu-id="9fb03-158">É possível induzir a perda de quorum usando o cmdlet **Invoke-ServiceFabricPartitionQuorumLoss** PowerShell:</span><span class="sxs-lookup"><span data-stu-id="9fb03-158">You can induce quorum loss by using the PowerShell **Invoke-ServiceFabricPartitionQuorumLoss** cmdlet:</span></span>

```powershell

PS > Invoke-ServiceFabricPartitionQuorumLoss -ServiceName fabric:/Myapplication/MyService -QuorumLossMode QuorumReplicas -QuorumLossDurationInSeconds 20

```

<span data-ttu-id="9fb03-159">Neste exemplo, definimos `QuorumLossMode` como `QuorumReplicas` para indicar que desejamos induzir perda de quórum sem interromper todas as réplicas.</span><span class="sxs-lookup"><span data-stu-id="9fb03-159">In this example, we set `QuorumLossMode` to `QuorumReplicas` to indicate that we want to induce quorum loss without taking down all replicas.</span></span> <span data-ttu-id="9fb03-160">Dessa forma, as operações de leitura ainda são possíveis.</span><span class="sxs-lookup"><span data-stu-id="9fb03-160">This way, read operations are still possible.</span></span> <span data-ttu-id="9fb03-161">Para testar um cenário no qual uma partição inteira não está disponível, você pode definir essa opção como `AllReplicas`.</span><span class="sxs-lookup"><span data-stu-id="9fb03-161">To test a scenario where an entire partition is unavailable, you can set this switch to `AllReplicas`.</span></span>

## <a name="next-steps"></a><span data-ttu-id="9fb03-162">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="9fb03-162">Next steps</span></span>
[<span data-ttu-id="9fb03-163">Saiba mais sobre as ações de possibilidade de teste</span><span class="sxs-lookup"><span data-stu-id="9fb03-163">Learn more about testability actions</span></span>](service-fabric-testability-actions.md)

[<span data-ttu-id="9fb03-164">Saiba mais sobre os cenários de possibilidade de teste</span><span class="sxs-lookup"><span data-stu-id="9fb03-164">Learn more about testability scenarios</span></span>](service-fabric-testability-scenarios.md)

