---
title: "Usando o Elasticsearch como um repositório de rastreamento do aplicativo do Service Fabric | Microsoft Docs"
description: Descreve como os aplicativos do Service Fabric podem usar o Elasticsearch e o Kibana para armazenar, indexar e pesquisar os rastreamentos do aplicativo (logs)
services: service-fabric
documentationcenter: .net
author: karolz-ms
manager: adegeo
editor: 
ms.assetid: e59b0c39-e468-4d9e-b453-d5f2a8ad20d8
ms.service: service-fabric
ms.devlang: dotNet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 04/07/2017
ms.author: karolz@microsoft.com
redirect_url: /azure/service-fabric/service-fabric-diagnostics-event-aggregation-eventflow
ms.openlocfilehash: 2d2ceceea131b41ad1a1735aaa2a859d035ab098
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="use-elasticsearch-as-a-service-fabric-application-trace-store"></a><span data-ttu-id="fc427-103">Usar o Elasticsearch como um repositório de rastreamento do aplicativo Service Fabric</span><span class="sxs-lookup"><span data-stu-id="fc427-103">Use Elasticsearch as a Service Fabric application trace store</span></span>
## <a name="introduction"></a><span data-ttu-id="fc427-104">Introdução</span><span class="sxs-lookup"><span data-stu-id="fc427-104">Introduction</span></span>
<span data-ttu-id="fc427-105">Este artigo descreve como os aplicativos do [Azure Service Fabric](https://azure.microsoft.com/documentation/services/service-fabric/) podem usar o **Elasticsearch** e o **Kibana** para armazenamento de rastreamento do aplicativo, indexação e pesquisa.</span><span class="sxs-lookup"><span data-stu-id="fc427-105">This article describes how [Azure Service Fabric](https://azure.microsoft.com/documentation/services/service-fabric/) applications can use **Elasticsearch** and **Kibana** for application trace storage, indexing, and search.</span></span> <span data-ttu-id="fc427-106">[Elasticsearch](https://www.elastic.co/guide/index.html) é um mecanismo de análise e pesquisa em tempo real escalonável, distribuído de software livre adequado para essa tarefa.</span><span class="sxs-lookup"><span data-stu-id="fc427-106">[Elasticsearch](https://www.elastic.co/guide/index.html) is an open-source, distributed, and scalable real-time search and analytics engine that is well-suited for this task.</span></span> <span data-ttu-id="fc427-107">Ele pode ser instalado em máquinas virtuais Windows ou Linux em execução no Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="fc427-107">It can be installed on Windows and Linux virtual machines running in Microsoft Azure.</span></span> <span data-ttu-id="fc427-108">O Elasticsearch pode processar de maneira eficiente os rastreamentos *estruturados* produzidos usando tecnologias como **ETW (Rastreamento de Eventos para Windows)**.</span><span class="sxs-lookup"><span data-stu-id="fc427-108">Elasticsearch can efficiently process *structured* traces produced using technologies such as **Event Tracing for Windows (ETW)**.</span></span>

<span data-ttu-id="fc427-109">O ETW é usado pelo tempo de execução do Service Fabric para originar informações de diagnóstico (rastreamentos).</span><span class="sxs-lookup"><span data-stu-id="fc427-109">ETW is used by Service Fabric runtime to source diagnostic information (traces).</span></span> <span data-ttu-id="fc427-110">É o método recomendado para aplicativos de Service Fabric para a originar suas informações de diagnóstico também.</span><span class="sxs-lookup"><span data-stu-id="fc427-110">It is the recommended method for Service Fabric applications to source their diagnostic information, too.</span></span> <span data-ttu-id="fc427-111">Usar o mesmo mecanismo possibilita correlacionar os rastreamentos fornecidos pelo aplicativo e pelo tempo de execução e facilita a solução de problemas.</span><span class="sxs-lookup"><span data-stu-id="fc427-111">Using the same mechanism allows for correlation between runtime-supplied and application-supplied traces and makes troubleshooting easier.</span></span> <span data-ttu-id="fc427-112">Os modelos de projeto de Malha de Serviço no Visual Studio incluem uma API de log (baseada na classe .NET **EventSource** ) que emite rastreamentos ETW por padrão.</span><span class="sxs-lookup"><span data-stu-id="fc427-112">Service Fabric project templates in Visual Studio include a logging API (based on the .NET **EventSource** class) that emits ETW traces by default.</span></span> <span data-ttu-id="fc427-113">Para obter uma visão geral do rastreamento de aplicativo do Service Fabric usando o ETW, consulte [Monitorar e diagnosticar serviços em uma configuração de desenvolvimento do computador local](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md).</span><span class="sxs-lookup"><span data-stu-id="fc427-113">For a general overview of Service Fabric application tracing using ETW, see [Monitoring and diagnosing services in a local machine development setup](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md).</span></span>

<span data-ttu-id="fc427-114">Para os rastreamentos que aparecerão em Elasticsearch, eles precisam ser capturados nos nós de cluster do Service Fabric em tempo real (enquanto o aplicativo estiver em execução) e enviados ao ponto de extremidade Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="fc427-114">For the traces to show up in Elasticsearch, they need to be captured at the Service Fabric cluster nodes in real time (while the application is running) and sent to an Elasticsearch endpoint.</span></span> <span data-ttu-id="fc427-115">Há duas opções principais para a captura de rastreamento:</span><span class="sxs-lookup"><span data-stu-id="fc427-115">There are two major options for trace capturing:</span></span>

* <span data-ttu-id="fc427-116">**Captura de rastreamento dentro do processo**</span><span class="sxs-lookup"><span data-stu-id="fc427-116">**In-process trace capturing**</span></span>  
  <span data-ttu-id="fc427-117">o aplicativo, ou mais precisamente, o processo de serviço, é responsável por enviar os dados de diagnóstico para o repositório de rastreamento (Elasticsearch).</span><span class="sxs-lookup"><span data-stu-id="fc427-117">The application, or more precisely, service process, is responsible for sending out the diagnostic data to the trace store (Elasticsearch).</span></span>
* <span data-ttu-id="fc427-118">**Captura de rastreamento fora do processo**</span><span class="sxs-lookup"><span data-stu-id="fc427-118">**Out-of-process trace capturing**</span></span>  
  <span data-ttu-id="fc427-119">um agente separado captura rastreamentos dos processos de serviço e os envia para o repositório de rastreamento.</span><span class="sxs-lookup"><span data-stu-id="fc427-119">A separate agent is capturing traces from the service process or processes and sending them to the trace store.</span></span>

<span data-ttu-id="fc427-120">A seguir, descreveremos como configurar o Elasticsearch no Azure, discutiremos os prós e contras de ambas as opções de captura e explicaremos como configurar um serviço do Service Fabric para enviar dados para o Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="fc427-120">Below, we describe how to set up Elasticsearch on Azure, discuss the pros and cons for both capture options, and explain how to configure a Service Fabric service to send data to Elasticsearch.</span></span>

## <a name="set-up-elasticsearch-on-azure"></a><span data-ttu-id="fc427-121">Configurar o Elasticsearch no Azure</span><span class="sxs-lookup"><span data-stu-id="fc427-121">Set up Elasticsearch on Azure</span></span>
<span data-ttu-id="fc427-122">A maneira mais simples de configurar o serviço Elasticsearch no Azure é por meio de [**modelos do Azure Resource Manager**](../azure-resource-manager/resource-group-overview.md).</span><span class="sxs-lookup"><span data-stu-id="fc427-122">The most straightforward way to set up the Elasticsearch service on Azure is through [**Azure Resource Manager templates**](../azure-resource-manager/resource-group-overview.md).</span></span> <span data-ttu-id="fc427-123">Um [modelo do Gerenciador de Recursos do Azure de início rápido para Elasticsearch](https://github.com/Azure/azure-quickstart-templates/tree/master/elasticsearch) abrangente está disponível no repositório de modelos de início rápido do Azure.</span><span class="sxs-lookup"><span data-stu-id="fc427-123">A comprehensive [Quickstart Azure Resource Manager template for Elasticsearch](https://github.com/Azure/azure-quickstart-templates/tree/master/elasticsearch) is available from Azure Quickstart templates repository.</span></span> <span data-ttu-id="fc427-124">Este modelo usa contas de armazenamento separada para as unidades de escala (grupos de nós).</span><span class="sxs-lookup"><span data-stu-id="fc427-124">This template uses separate storage accounts for scale units (groups of nodes).</span></span> <span data-ttu-id="fc427-125">Ele também pode provisionar nós de cliente e servidor separados com configurações diferentes e vários números de discos de dados anexados.</span><span class="sxs-lookup"><span data-stu-id="fc427-125">It can also provision separate client and server nodes with different configurations and various numbers of data disks attached.</span></span>

<span data-ttu-id="fc427-126">Aqui, usaremos outro modelo, chamado **ES-MultiNode** do [repositório de ferramentas de diagnóstico do Azure](https://github.com/Azure/azure-diagnostics-tools).</span><span class="sxs-lookup"><span data-stu-id="fc427-126">Here, we use another template, called **ES-MultiNode** from the [Azure diagnostic tools repository](https://github.com/Azure/azure-diagnostics-tools).</span></span> <span data-ttu-id="fc427-127">Esse modelo é mais fácil de usar e cria um cluster do Elasticsearch protegido pela autenticação HTTP básica.</span><span class="sxs-lookup"><span data-stu-id="fc427-127">This template is easier to use, and it creates an Elasticsearch cluster protected by HTTP basic authentication.</span></span> <span data-ttu-id="fc427-128">Antes de continuar, baixe o repositório do GitHub em seu computador (clonando o repositório ou baixando um arquivo zip).</span><span class="sxs-lookup"><span data-stu-id="fc427-128">Before you proceed, download the repository from GitHub to your machine (by either cloning the repository or downloading a zip file).</span></span> <span data-ttu-id="fc427-129">O modelo ES-MultiNode está localizado na pasta com o mesmo nome.</span><span class="sxs-lookup"><span data-stu-id="fc427-129">The ES-MultiNode template is located in the folder with the same name.</span></span>

### <a name="prepare-a-machine-to-run-elasticsearch-installation-scripts"></a><span data-ttu-id="fc427-130">Preparar um computador para executar scripts de instalação do ElasticSearch</span><span class="sxs-lookup"><span data-stu-id="fc427-130">Prepare a machine to run Elasticsearch installation scripts</span></span>
<span data-ttu-id="fc427-131">A maneira mais fácil de usar o modelo ES-MultiNode é por meio de um script fornecido pelo Azure PowerShell chamado `CreateElasticSearchCluster`.</span><span class="sxs-lookup"><span data-stu-id="fc427-131">The easiest way to use the ES-MultiNode template is through a provided Azure PowerShell script called `CreateElasticSearchCluster`.</span></span> <span data-ttu-id="fc427-132">Para usar esse script, você precisará instalar os módulos do PowerShell e uma ferramenta chamada **openssl**.</span><span class="sxs-lookup"><span data-stu-id="fc427-132">To use this script, you need to install PowerShell modules and a tool called **openssl**.</span></span> <span data-ttu-id="fc427-133">Essa ferramenta é necessária para criar uma chave SSH que pode ser usada para administrar o cluster do Elasticsearch remotamente.</span><span class="sxs-lookup"><span data-stu-id="fc427-133">The latter is needed for creating an SSH key that can be used to administer your Elasticsearch cluster remotely.</span></span>

<span data-ttu-id="fc427-134">`CreateElasticSearchCluster` foi desenvolvido para facilitar o uso com o modelo ES-MultiNode em um computador com o Windows.</span><span class="sxs-lookup"><span data-stu-id="fc427-134">`CreateElasticSearchCluster` script is designed for ease of use with the ES-MultiNode template from a Windows machine.</span></span> <span data-ttu-id="fc427-135">É possível usar o modelo em um computador diferente do Windows, mas esse cenário está além do escopo deste artigo.</span><span class="sxs-lookup"><span data-stu-id="fc427-135">It is possible to use the template on a non-Windows machine, but that scenario is beyond the scope of this article.</span></span>

1. <span data-ttu-id="fc427-136">Se você ainda não os tiver instalado, instale os [**módulos do Azure PowerShell**](http://aka.ms/webpi-azps).</span><span class="sxs-lookup"><span data-stu-id="fc427-136">If you haven't installed them already, install [**Azure PowerShell modules**](http://aka.ms/webpi-azps).</span></span> <span data-ttu-id="fc427-137">Quando solicitado, clique em **Executar** e em **Instalar**.</span><span class="sxs-lookup"><span data-stu-id="fc427-137">When prompted, click **Run**, then **Install**.</span></span> <span data-ttu-id="fc427-138">O Azure PowerShell 1.3 ou mais recente é necessário.</span><span class="sxs-lookup"><span data-stu-id="fc427-138">Azure PowerShell 1.3 or newer is required.</span></span>
2. <span data-ttu-id="fc427-139">A ferramenta **openssl** está incluída na distribuição de [**Git para Windows**](http://www.git-scm.com/downloads).</span><span class="sxs-lookup"><span data-stu-id="fc427-139">The **openssl** tool is included in the distribution of [**Git for Windows**](http://www.git-scm.com/downloads).</span></span> <span data-ttu-id="fc427-140">Se ainda não tiver feito isso, instale agora o [Git para Windows](http://www.git-scm.com/downloads) .</span><span class="sxs-lookup"><span data-stu-id="fc427-140">If you have not done so already, install [Git for Windows](http://www.git-scm.com/downloads) now.</span></span> <span data-ttu-id="fc427-141">(As opções de instalação padrão estão OK.)</span><span class="sxs-lookup"><span data-stu-id="fc427-141">(The default installation options are OK.)</span></span>
3. <span data-ttu-id="fc427-142">Supondo que o Git foi instalado, mas não incluído no caminho do sistema, abra uma janela do Microsoft Azure PowerShell e execute os seguintes comandos:</span><span class="sxs-lookup"><span data-stu-id="fc427-142">Assuming that Git has been installed but not included in the system path, open a Microsoft Azure PowerShell window and run the following commands:</span></span>
   
    ```powershell
    $ENV:PATH += ";<Git installation folder>\usr\bin"
    $ENV:OPENSSL_CONF = "<Git installation folder>\usr\ssl\openssl.cnf"
    ```
   
    <span data-ttu-id="fc427-143">Substitua o `<Git installation folder>` pelo local do Git em seu computador; o padrão é **"C:\Program Files\Git"**.</span><span class="sxs-lookup"><span data-stu-id="fc427-143">Replace the `<Git installation folder>` with the Git location on your machine; the default is **"C:\Program Files\Git"**.</span></span> <span data-ttu-id="fc427-144">Observe o caractere ponto e vírgula no início do primeiro caminho.</span><span class="sxs-lookup"><span data-stu-id="fc427-144">Note the semicolon character at the beginning of the first path.</span></span>
4. <span data-ttu-id="fc427-145">Verifique se você está conectado ao Azure (por meio do cmdlet [`Add-AzureRmAccount`](https://msdn.microsoft.com/library/mt619267.aspx) ) e se a assinatura que deve ser usada para criar o cluster do Elastic Search foi selecionada.</span><span class="sxs-lookup"><span data-stu-id="fc427-145">Ensure that you are logged on to Azure (via [`Add-AzureRmAccount`](https://msdn.microsoft.com/library/mt619267.aspx) cmdlet) and that you have selected the subscription that should be used to create your Elastic Search cluster.</span></span> <span data-ttu-id="fc427-146">Você pode verificar se a assinatura correta foi selecionada usando os cmdlets `Get-AzureRmContext` e `Get-AzureRmSubscription`.</span><span class="sxs-lookup"><span data-stu-id="fc427-146">You can verify that correct subscription is selected using `Get-AzureRmContext` and `Get-AzureRmSubscription` cmdlets.</span></span>
5. <span data-ttu-id="fc427-147">Se você ainda não fez isso, altere o diretório atual para a pasta ES-MultiNode.</span><span class="sxs-lookup"><span data-stu-id="fc427-147">If you haven't done so already, change the current directory to the ES-MultiNode folder.</span></span>

### <a name="run-the-createelasticsearchcluster-script"></a><span data-ttu-id="fc427-148">Executar o script CreateElasticSearchCluster</span><span class="sxs-lookup"><span data-stu-id="fc427-148">Run the CreateElasticSearchCluster script</span></span>
<span data-ttu-id="fc427-149">Antes de executar o script, abra o arquivo `azuredeploy-parameters.json` e verifique ou forneça valores para os parâmetros do script.</span><span class="sxs-lookup"><span data-stu-id="fc427-149">Before you run the script, open the `azuredeploy-parameters.json` file and verify or provide values for the script parameters.</span></span> <span data-ttu-id="fc427-150">Os parâmetros a seguir são fornecidos:</span><span class="sxs-lookup"><span data-stu-id="fc427-150">The following parameters are provided:</span></span>

| <span data-ttu-id="fc427-151">Nome do Parâmetro</span><span class="sxs-lookup"><span data-stu-id="fc427-151">Parameter Name</span></span> | <span data-ttu-id="fc427-152">Descrição</span><span class="sxs-lookup"><span data-stu-id="fc427-152">Description</span></span> |
| --- | --- |
| <span data-ttu-id="fc427-153">dnsNameForLoadBalancerIP</span><span class="sxs-lookup"><span data-stu-id="fc427-153">dnsNameForLoadBalancerIP</span></span> |<span data-ttu-id="fc427-154">Esse é o nome que será usado para criar o nome DNS publicamente visível para o cluster do Elastic Search (anexando o domínio da região do Azure ao nome fornecido).</span><span class="sxs-lookup"><span data-stu-id="fc427-154">The name that is used to create the publicly visible DNS name for the Elastic Search cluster (by appending the Azure region domain to the provided name).</span></span> <span data-ttu-id="fc427-155">Por exemplo, se esse valor de parâmetro é "myBigCluster" e a região do Azure escolhida é Oeste dos EUA, o nome DNS resultante para o cluster é myBigCluster.westus.cloudapp.azure.com.</span><span class="sxs-lookup"><span data-stu-id="fc427-155">For example, if this parameter value is "myBigCluster" and the chosen Azure region is West US, the resulting DNS name for the cluster is myBigCluster.westus.cloudapp.azure.com.</span></span> <br /><br /><span data-ttu-id="fc427-156">Esse nome também servirá como uma raiz para nomes de vários artefatos associados ao cluster do Elastic Search, como os nomes de nó de dados.</span><span class="sxs-lookup"><span data-stu-id="fc427-156">This name also serves as a root name for many artifacts associated with the Elastic Search cluster, such as data node names.</span></span> |
| <span data-ttu-id="fc427-157">adminUsername</span><span class="sxs-lookup"><span data-stu-id="fc427-157">adminUsername</span></span> |<span data-ttu-id="fc427-158">O nome da conta de administrador para gerenciar o cluster do Elastic Search (as chaves SSH correspondentes são geradas automaticamente).</span><span class="sxs-lookup"><span data-stu-id="fc427-158">The name of the administrator account for managing the Elastic Search cluster (corresponding SSH keys are generated automatically).</span></span> |
| <span data-ttu-id="fc427-159">dataNodeCount</span><span class="sxs-lookup"><span data-stu-id="fc427-159">dataNodeCount</span></span> |<span data-ttu-id="fc427-160">O número de nós no cluster do Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="fc427-160">The number of nodes in the Elastic Search cluster.</span></span> <span data-ttu-id="fc427-161">A versão atual do script não faz distinção entre nós de dados e consultas; todos os nós executam as duas funções.</span><span class="sxs-lookup"><span data-stu-id="fc427-161">The current version of the script does not distinguish between data and query nodes; all nodes play both roles.</span></span> <span data-ttu-id="fc427-162">O valor padrão é 3 nós.</span><span class="sxs-lookup"><span data-stu-id="fc427-162">Defaults to 3 nodes.</span></span> |
| <span data-ttu-id="fc427-163">dataDiskSize</span><span class="sxs-lookup"><span data-stu-id="fc427-163">dataDiskSize</span></span> |<span data-ttu-id="fc427-164">O tamanho dos discos de dados (em GB) que será alocado para cada nó de dados.</span><span class="sxs-lookup"><span data-stu-id="fc427-164">The size of data disks (in GB) that is allocated for each data node.</span></span> <span data-ttu-id="fc427-165">Cada nó receberá 4 discos de dados, dedicados exclusivamente ao serviço Elastic Search.</span><span class="sxs-lookup"><span data-stu-id="fc427-165">Each node receives 4 data disks, exclusively dedicated to Elastic Search service.</span></span> |
| <span data-ttu-id="fc427-166">region</span><span class="sxs-lookup"><span data-stu-id="fc427-166">region</span></span> |<span data-ttu-id="fc427-167">O nome da região do Azure onde o cluster do Elasticsearch deve estar localizado.</span><span class="sxs-lookup"><span data-stu-id="fc427-167">The name of Azure region where the Elastic Search cluster should be located.</span></span> |
| <span data-ttu-id="fc427-168">esUserName</span><span class="sxs-lookup"><span data-stu-id="fc427-168">esUserName</span></span> |<span data-ttu-id="fc427-169">O nome de usuário que é configurado para ter acesso ao cluster do Elastic Search (sujeito à autenticação HTTP básica).</span><span class="sxs-lookup"><span data-stu-id="fc427-169">The user name of the user that is configured to have access to ES cluster (subject to HTTP basic authentication).</span></span> <span data-ttu-id="fc427-170">A senha não faz parte do arquivo de parâmetros e deverá ser fornecida quando o script `CreateElasticSearchCluster` for invocado.</span><span class="sxs-lookup"><span data-stu-id="fc427-170">The password is not part of parameters file and must be provided when `CreateElasticSearchCluster` script is invoked.</span></span> |
| <span data-ttu-id="fc427-171">vmSizeDataNodes</span><span class="sxs-lookup"><span data-stu-id="fc427-171">vmSizeDataNodes</span></span> |<span data-ttu-id="fc427-172">O tamanho da máquina virtual do Azure para nós do cluster do Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="fc427-172">The Azure virtual machine size for Elastic Search cluster nodes.</span></span> <span data-ttu-id="fc427-173">O padrão é Standard_D2.</span><span class="sxs-lookup"><span data-stu-id="fc427-173">Defaults to Standard_D2.</span></span> |

<span data-ttu-id="fc427-174">Agora você está pronto para executar os aplicativos.</span><span class="sxs-lookup"><span data-stu-id="fc427-174">Now you are ready to run the script.</span></span> <span data-ttu-id="fc427-175">Emita o seguinte comando:</span><span class="sxs-lookup"><span data-stu-id="fc427-175">Issue the following command:</span></span>

```powershell
CreateElasticSearchCluster -ResourceGroupName <es-group-name> -Region <azure-region> -EsPassword <es-password>
```

<span data-ttu-id="fc427-176">onde</span><span class="sxs-lookup"><span data-stu-id="fc427-176">where</span></span> 

| <span data-ttu-id="fc427-177">Nome do parâmetro do script</span><span class="sxs-lookup"><span data-stu-id="fc427-177">Script Parameter Name</span></span> | <span data-ttu-id="fc427-178">Descrição</span><span class="sxs-lookup"><span data-stu-id="fc427-178">Description</span></span> |
| --- | --- |
| `<es-group-name>` |<span data-ttu-id="fc427-179">O nome do grupo de recursos do Azure que conterá todos os recursos do cluster do Elastic Search.</span><span class="sxs-lookup"><span data-stu-id="fc427-179">The name of the Azure resource group that will contain all Elastic Search cluster resources.</span></span> |
| `<azure-region>` |<span data-ttu-id="fc427-180">O nome da região do Azure em que o cluster do Elastic Search deve ser criado.</span><span class="sxs-lookup"><span data-stu-id="fc427-180">The name of the Azure region where the Elastic Search cluster should be created.</span></span> |
| `<es-password>` |<span data-ttu-id="fc427-181">A senha para o usuário do Elastic Search.</span><span class="sxs-lookup"><span data-stu-id="fc427-181">The password for the Elastic Search user.</span></span> |

> [!NOTE]
> <span data-ttu-id="fc427-182">Se você esquecer de fazer logon no Azure (`Add-AzureRmAccount`), receberá uma NullReferenceException do cmdlet Test-AzureResourceGroup.</span><span class="sxs-lookup"><span data-stu-id="fc427-182">If you get a NullReferenceException from the Test-AzureResourceGroup cmdlet, you have forgotten to log on to Azure (`Add-AzureRmAccount`).</span></span>
> 
> 

<span data-ttu-id="fc427-183">Se você receber um erro de execução do script e você determinar que o erro foi causado por um valor de parâmetro de modelo errado, corrija o arquivo de parâmetro e executar o script novamente com um nome de grupo de recursos diferente.</span><span class="sxs-lookup"><span data-stu-id="fc427-183">If you get an error from running the script and you determine that the error was caused by a wrong template parameter value, correct the parameter file and run the script again with a different resource group name.</span></span> <span data-ttu-id="fc427-184">Você também pode reutilizar o mesmo nome de grupo de recursos e fazer com que o script limpe o antigo adicionando o parâmetro `-RemoveExistingResourceGroup` à invocação do script.</span><span class="sxs-lookup"><span data-stu-id="fc427-184">You can also reuse the same resource group name and have the script clean up the old one by adding the `-RemoveExistingResourceGroup` parameter to the script invocation.</span></span>

### <a name="result-of-running-the-createelasticsearchcluster-script"></a><span data-ttu-id="fc427-185">Resultado da execução do script CreateElasticSearchCluster</span><span class="sxs-lookup"><span data-stu-id="fc427-185">Result of running the CreateElasticSearchCluster script</span></span>
<span data-ttu-id="fc427-186">Depois de executar o script `CreateElasticSearchCluster` , os seguintes artefatos principais serão criados.</span><span class="sxs-lookup"><span data-stu-id="fc427-186">After you run the `CreateElasticSearchCluster` script, the following main artifacts will be created.</span></span> <span data-ttu-id="fc427-187">Para esse exemplo, vamos supor que você tenha usado "myBigCluster" como o valor do parâmetro `dnsNameForLoadBalancerIP` e a região onde você criou o cluster é Oeste dos EUA.</span><span class="sxs-lookup"><span data-stu-id="fc427-187">For this example we assume that you have used "myBigCluster" as the value of the `dnsNameForLoadBalancerIP` parameter and that the region where you created the cluster is West US.</span></span>

| <span data-ttu-id="fc427-188">Artefato</span><span class="sxs-lookup"><span data-stu-id="fc427-188">Artifact</span></span> | <span data-ttu-id="fc427-189">Nome, local e comentários</span><span class="sxs-lookup"><span data-stu-id="fc427-189">Name, location, and remarks</span></span> |
| --- | --- |
| <span data-ttu-id="fc427-190">Chave SSH para administração remota</span><span class="sxs-lookup"><span data-stu-id="fc427-190">SSH key for remote administration</span></span> |<span data-ttu-id="fc427-191">arquivo myBigCluster.key (no diretório onde o CreateElasticSearchCluster foi executado).</span><span class="sxs-lookup"><span data-stu-id="fc427-191">myBigCluster.key file (in the directory from which the CreateElasticSearchCluster was run).</span></span> <br /><br /><span data-ttu-id="fc427-192">Esse arquivo de chave pode ser usado para conectar o nó de administração e (por meio do nó de administração) a nós de dados do cluster.</span><span class="sxs-lookup"><span data-stu-id="fc427-192">This key file can be used to connect to the admin node and (through the admin node) to data nodes in the cluster.</span></span> |
| <span data-ttu-id="fc427-193">Nó de Admin</span><span class="sxs-lookup"><span data-stu-id="fc427-193">Admin node</span></span> |<span data-ttu-id="fc427-194">myBigCluster-admin.westus.cloudapp.azure.com </span><span class="sxs-lookup"><span data-stu-id="fc427-194">myBigCluster-admin.westus.cloudapp.azure.com</span></span> <br /><br /><span data-ttu-id="fc427-195">Uma VM dedicada para a administração remota do cluster do Elasticsearch, a única que permite conexões SSH externas.</span><span class="sxs-lookup"><span data-stu-id="fc427-195">A dedicated VM for remote Elasticsearch cluster administration--the only one that allows external SSH connections.</span></span> <span data-ttu-id="fc427-196">Ela é executada na mesma rede virtual que todos os nós de cluster Elasticsearch, mas não executa serviços do Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="fc427-196">It runs on the same virtual network as all the Elasticsearch cluster nodes, but it does not run any Elasticsearch services.</span></span> |
| <span data-ttu-id="fc427-197">Nós de dados</span><span class="sxs-lookup"><span data-stu-id="fc427-197">Data nodes</span></span> |<span data-ttu-id="fc427-198">myBigCluster1 ...</span><span class="sxs-lookup"><span data-stu-id="fc427-198">myBigCluster1 …</span></span> <span data-ttu-id="fc427-199">myBigCluster*N*</span><span class="sxs-lookup"><span data-stu-id="fc427-199">myBigCluster*N*</span></span> <br /><br /><span data-ttu-id="fc427-200">Os nós de dados que estão executando os serviços Elasticsearch e Kibana.</span><span class="sxs-lookup"><span data-stu-id="fc427-200">Data nodes that are running Elasticsearch and Kibana services.</span></span> <span data-ttu-id="fc427-201">Você pode se conectar via SSH para cada nó, mas somente via o nó de administração.</span><span class="sxs-lookup"><span data-stu-id="fc427-201">You can connect via SSH to each node, but only via the admin node.</span></span> |
| <span data-ttu-id="fc427-202">Cluster Elasticsearch</span><span class="sxs-lookup"><span data-stu-id="fc427-202">Elasticsearch cluster</span></span> |<span data-ttu-id="fc427-203">http://myBigCluster.westus.cloudapp.azure.com/es/</span><span class="sxs-lookup"><span data-stu-id="fc427-203">http://myBigCluster.westus.cloudapp.azure.com/es/</span></span> <br /><br /><span data-ttu-id="fc427-204">O ponto de extremidade principal para o cluster do Elasticsearch (observe o sufixo /es).</span><span class="sxs-lookup"><span data-stu-id="fc427-204">The primary endpoint for the Elasticsearch cluster (note the /es suffix).</span></span> <span data-ttu-id="fc427-205">Ele é protegido por autenticação HTTP básica (as credenciais eram os parâmetros esUserName/esPassword especificados do modelo ES-MultiNode).</span><span class="sxs-lookup"><span data-stu-id="fc427-205">It is protected by basic HTTP authentication (the credentials were the specified esUserName/esPassword parameters of the ES-MultiNode template).</span></span> <span data-ttu-id="fc427-206">O cluster também tem o plug-in de cabeçalho instalada (http://myBigCluster.westus.cloudapp.azure.com/es/_plugin/head) para administração de cluster básico.</span><span class="sxs-lookup"><span data-stu-id="fc427-206">The cluster has also the head plug-in installed (http://myBigCluster.westus.cloudapp.azure.com/es/_plugin/head) for basic cluster administration.</span></span> |
| <span data-ttu-id="fc427-207">Serviço Kibana</span><span class="sxs-lookup"><span data-stu-id="fc427-207">Kibana service</span></span> |<span data-ttu-id="fc427-208">http://myBigCluster.westus.cloudapp.azure.com</span><span class="sxs-lookup"><span data-stu-id="fc427-208">http://myBigCluster.westus.cloudapp.azure.com</span></span> <br /><br /><span data-ttu-id="fc427-209">O serviço Kibana está configurado para mostrar dados do cluster do Elasticsearch criado.</span><span class="sxs-lookup"><span data-stu-id="fc427-209">The Kibana service is set up to show data from the created Elasticsearch cluster.</span></span> <span data-ttu-id="fc427-210">Ele é protegido pelas mesmas credenciais de autenticação como o próprio cluster.</span><span class="sxs-lookup"><span data-stu-id="fc427-210">It is protected by the same authentication credentials as the cluster itself.</span></span> |

## <a name="in-process-versus-out-of-process-trace-capturing"></a><span data-ttu-id="fc427-211">Captura de rastreamento dentro do processo versus fora do processo</span><span class="sxs-lookup"><span data-stu-id="fc427-211">In-process versus out-of-process trace capturing</span></span>
<span data-ttu-id="fc427-212">Na introdução mencionamos duas maneiras fundamentais de coleta de dados de diagnóstico: dentro do processo e fora de processo.</span><span class="sxs-lookup"><span data-stu-id="fc427-212">In the introduction, we mentioned two fundamental ways of collecting diagnostic data: in-process and out-of-process.</span></span> <span data-ttu-id="fc427-213">Cada uma tem suas vantagens e desvantagens.</span><span class="sxs-lookup"><span data-stu-id="fc427-213">Each has strengths and weaknesses.</span></span>

<span data-ttu-id="fc427-214">As vantagens da **captura de rastreamento dentro do processo** incluem:</span><span class="sxs-lookup"><span data-stu-id="fc427-214">Advantages of the **in-process trace capturing** include:</span></span>

1. <span data-ttu-id="fc427-215">*Fácil Configuração e implantação*</span><span class="sxs-lookup"><span data-stu-id="fc427-215">*Easy configuration and deployment*</span></span>
   
   * <span data-ttu-id="fc427-216">A configuração de coleta de dados de diagnóstico é apenas uma parte da configuração do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="fc427-216">The configuration of diagnostic data collection is just part of the application configuration.</span></span> <span data-ttu-id="fc427-217">É fácil sempre mantê-la "sincronizada" com o restante do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="fc427-217">It is easy to always keep it "in sync" with the rest of the application.</span></span>
   * <span data-ttu-id="fc427-218">A configuração por aplicativo ou por serviço é facilmente realizável.</span><span class="sxs-lookup"><span data-stu-id="fc427-218">Per-application or per-service configuration is easily achievable.</span></span>
   * <span data-ttu-id="fc427-219">A captura de rastreamento fora do processo normalmente requer a implantação e a configuração separadas do agente de diagnóstico, que é uma tarefa administrativa extra e uma possível fonte de erros.</span><span class="sxs-lookup"><span data-stu-id="fc427-219">Out-of-process trace capturing usually requires a separate deployment and configuration of the diagnostic agent, which is an extra administrative task and a potential source of errors.</span></span> <span data-ttu-id="fc427-220">Geralmente, a tecnologia de agente específico permite apenas uma instância do agente de por máquina virtual (nó).</span><span class="sxs-lookup"><span data-stu-id="fc427-220">The particular agent technology often allows only one instance of the agent per virtual machine (node).</span></span> <span data-ttu-id="fc427-221">Isso significa que a configuração para a coleção da configuração de diagnóstico é compartilhada entre todos os aplicativos e serviços em execução nesse nó.</span><span class="sxs-lookup"><span data-stu-id="fc427-221">This means that configuration for the collection of the diagnostic configuration is shared among all applications and services running on that node.</span></span>
2. <span data-ttu-id="fc427-222">*Flexibilidade*</span><span class="sxs-lookup"><span data-stu-id="fc427-222">*Flexibility*</span></span>
   
   * <span data-ttu-id="fc427-223">O aplicativo pode enviar os dados sempre que eles forem necessários, desde que exista uma biblioteca de cliente que ofereça suporte ao sistema de armazenamento de dados de destino.</span><span class="sxs-lookup"><span data-stu-id="fc427-223">The application can send the data wherever it needs to go, as long as there is a client library that supports the targeted data storage system.</span></span> <span data-ttu-id="fc427-224">Novos coletores podem ser adicionados conforme desejado.</span><span class="sxs-lookup"><span data-stu-id="fc427-224">New sinks can be added as desired.</span></span>
   * <span data-ttu-id="fc427-225">Regras de captura complexa, filtragem e agregação de dados podem ser implementadas.</span><span class="sxs-lookup"><span data-stu-id="fc427-225">Complex capture, filtering, and data-aggregation rules can be implemented.</span></span>
   * <span data-ttu-id="fc427-226">Uma capturar de rastreamento fora do processo geralmente é limitada pelos coletores de dados para os quais o agente oferece suporte.</span><span class="sxs-lookup"><span data-stu-id="fc427-226">An out-of-process trace capturing is often limited by the data sinks that the agent supports.</span></span> <span data-ttu-id="fc427-227">Alguns agentes são extensíveis.</span><span class="sxs-lookup"><span data-stu-id="fc427-227">Some agents are extensible.</span></span>
3. <span data-ttu-id="fc427-228">*Acesso a dados de aplicativos internos e contexto*</span><span class="sxs-lookup"><span data-stu-id="fc427-228">*Access to internal application data and context*</span></span>
   
   * <span data-ttu-id="fc427-229">O subsistema de diagnóstico em execução dentro do processo de serviço/do aplicativo pode facilmente aumentar os rastreamentos com informações contextuais.</span><span class="sxs-lookup"><span data-stu-id="fc427-229">The diagnostic subsystem running inside the application/service process can easily augment the traces with contextual information.</span></span>
   * <span data-ttu-id="fc427-230">Na abordagem fora de processo, os dados devem ser enviados a um agente por meio de um mecanismo de comunicação entre processos, como Rastreamento de Eventos para Windows.</span><span class="sxs-lookup"><span data-stu-id="fc427-230">In the out-of-process approach, the data must be sent to an agent via some inter-process communication mechanism, such as Event Tracing for Windows.</span></span> <span data-ttu-id="fc427-231">Esse mecanismo pode impor limitações adicionais.</span><span class="sxs-lookup"><span data-stu-id="fc427-231">This mechanism could impose additional limitations.</span></span>

<span data-ttu-id="fc427-232">As vantagens da **captura de rastreamento fora do processo** incluem:</span><span class="sxs-lookup"><span data-stu-id="fc427-232">Advantages of the **out-of-process trace capturing** include:</span></span>

1. <span data-ttu-id="fc427-233">*A capacidade de monitorar aplicativos e coletar despejos de memória*</span><span class="sxs-lookup"><span data-stu-id="fc427-233">*The ability to monitor the application and collect crash dumps*</span></span>
   
   * <span data-ttu-id="fc427-234">A captura de rastreamento dentro do processo pode não ser bem-sucedida se o aplicativo não puder ser iniciado ou falhar.</span><span class="sxs-lookup"><span data-stu-id="fc427-234">In-process trace capturing may be unsuccessful if the application fails to start or crashes.</span></span> <span data-ttu-id="fc427-235">Um agente independente tem muito mais chances de capturar informações de solução de problemas cruciais.</span><span class="sxs-lookup"><span data-stu-id="fc427-235">An independent agent has a much better chance of capturing crucial troubleshooting information.</span></span><br /><br />
2. <span data-ttu-id="fc427-236">*Maturidade, eficiência e desempenho comprovados*</span><span class="sxs-lookup"><span data-stu-id="fc427-236">*Maturity, robustness, and proven performance*</span></span>
   
   * <span data-ttu-id="fc427-237">Um agente desenvolvido pelo fornecedor da plataforma (como o agente do Diagnóstico do Microsoft Azure) foi submetido a rigorosos testes em situações adversas.</span><span class="sxs-lookup"><span data-stu-id="fc427-237">An agent developed by a platform vendor (such as a Microsoft Azure Diagnostics agent) has been subject to rigorous testing and battle-hardening.</span></span>
   * <span data-ttu-id="fc427-238">Com a captura de rastreamento dentro do processo deve ser tomado cuidado para garantir que a atividade de envio de dados de diagnóstico de um processo de aplicativo não interfere nas tarefas principais do aplicativo ou apresenta problemas de desempenho ou intervalo.</span><span class="sxs-lookup"><span data-stu-id="fc427-238">With in-process trace capturing, care must be taken to ensure that the activity of sending diagnostic data from an application process does not interfere with the application's main tasks or introduce timing or performance problems.</span></span> <span data-ttu-id="fc427-239">Um agente independente em execução é menos propenso a esses problemas e é especificamente concebido para limitar seu impacto no sistema.</span><span class="sxs-lookup"><span data-stu-id="fc427-239">An independently running agent is less prone to these issues and is specifically designed to limit its impact on the system.</span></span>

<span data-ttu-id="fc427-240">É possível combinar e aproveitar ambas as abordagens.</span><span class="sxs-lookup"><span data-stu-id="fc427-240">It is possible to combine and benefit from both approaches.</span></span> <span data-ttu-id="fc427-241">Na verdade, essa pode ser a melhor solução para muitos aplicativos.</span><span class="sxs-lookup"><span data-stu-id="fc427-241">Indeed, it might be the best solution for many applications.</span></span>

<span data-ttu-id="fc427-242">Aqui, utilizamos a **biblioteca Microsoft.Diagnostic.Listeners** e a captura de rastreamento dentro do processo para enviar dados de um aplicativo do Service Fabric para um cluster do Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="fc427-242">Here, we use the **Microsoft.Diagnostic.Listeners library** and the in-process trace capturing to send data from a Service Fabric application to an Elasticsearch cluster.</span></span>

## <a name="use-the-listeners-library-to-send-diagnostic-data-to-elasticsearch"></a><span data-ttu-id="fc427-243">Usar a biblioteca Listeners para enviar dados de diagnóstico para o Elasticsearch</span><span class="sxs-lookup"><span data-stu-id="fc427-243">Use the Listeners library to send diagnostic data to Elasticsearch</span></span>
<span data-ttu-id="fc427-244">A biblioteca Microsoft.Diagnostic.Listeners faz parte do aplicativo Service Fabric de exemplo PartyCluster.</span><span class="sxs-lookup"><span data-stu-id="fc427-244">The Microsoft.Diagnostic.Listeners library is part of PartyCluster sample Service Fabric application.</span></span> <span data-ttu-id="fc427-245">Para usá-lo:</span><span class="sxs-lookup"><span data-stu-id="fc427-245">To use it:</span></span>

1. <span data-ttu-id="fc427-246">Baixe [o exemplo PartyCluster](https://github.com/Azure-Samples/service-fabric-dotnet-management-party-cluster) do GitHub.</span><span class="sxs-lookup"><span data-stu-id="fc427-246">Download [the PartyCluster sample](https://github.com/Azure-Samples/service-fabric-dotnet-management-party-cluster) from GitHub.</span></span>
2. <span data-ttu-id="fc427-247">Copie os projetos Microsoft.Diagnostics.Listeners e Microsoft.Diagnostics.Listeners.Fabric (pastas inteiras) do diretório do exemplo PartyCluster para a pasta de solução do aplicativo que deve enviar os dados para o Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="fc427-247">Copy the Microsoft.Diagnostics.Listeners and Microsoft.Diagnostics.Listeners.Fabric projects (whole folders) from the PartyCluster sample directory to the solution folder of the application that is supposed to send the data to Elasticsearch.</span></span>
3. <span data-ttu-id="fc427-248">Abra a solução de destino, clique com o botão direito do mouse no nó de solução no Gerenciador de Soluções e escolha **Adicionar Projeto Existente**.</span><span class="sxs-lookup"><span data-stu-id="fc427-248">Open the target solution, right-click the solution node in the Solution Explorer, and choose **Add Existing Project**.</span></span> <span data-ttu-id="fc427-249">Adicione o projeto Microsoft.Diagnostics.Listeners à solução.</span><span class="sxs-lookup"><span data-stu-id="fc427-249">Add the Microsoft.Diagnostics.Listeners project to the solution.</span></span> <span data-ttu-id="fc427-250">Repita o mesmo para o projeto Microsoft.Diagnostics.Listeners.Fabric.</span><span class="sxs-lookup"><span data-stu-id="fc427-250">Repeat the same for the Microsoft.Diagnostics.Listeners.Fabric project.</span></span>
4. <span data-ttu-id="fc427-251">Adicione uma referência de projeto de seus projetos de serviço aos dois projetos adicionados.</span><span class="sxs-lookup"><span data-stu-id="fc427-251">Add a project reference from your service project(s) to the two added projects.</span></span> <span data-ttu-id="fc427-252">(Cada serviço que deve enviar dados para o Elasticsearch deve referenciar Microsoft.Diagnostics.EventListeners e Microsoft.Diagnostics.EventListeners.Fabric).</span><span class="sxs-lookup"><span data-stu-id="fc427-252">(Each service that is supposed to send data to Elasticsearch should reference Microsoft.Diagnostics.EventListeners and Microsoft.Diagnostics.EventListeners.Fabric).</span></span>
   
    ![Referências de projeto às bibliotecas Microsoft.Diagnostics.EventListeners e Microsoft.Diagnostics.EventListeners.Fabric][1]

### <a name="service-fabric-general-availability-release-and-microsoftdiagnosticstracing-nuget-package"></a><span data-ttu-id="fc427-254">A versão de Disponibilidade Geral do Service Fabric e o pacote Nuget Microsoft.Diagnostics.Tracing</span><span class="sxs-lookup"><span data-stu-id="fc427-254">Service Fabric General Availability release and Microsoft.Diagnostics.Tracing Nuget package</span></span>
<span data-ttu-id="fc427-255">Os aplicativos criados com a versão de Disponibilidade Geral do Service Fabric (2.0.135, lançada em 31 de março de 2016) são voltados para o **.NET Framework 4.5.2**.</span><span class="sxs-lookup"><span data-stu-id="fc427-255">Applications built with Service Fabric General Availability release (2.0.135, released March 31, 2016) target **.NET Framework 4.5.2**.</span></span> <span data-ttu-id="fc427-256">Essa é a versão mais recente do .NET Framework compatível com o Azure no momento da versão de Disponibilidade Geral.</span><span class="sxs-lookup"><span data-stu-id="fc427-256">This version is the highest version of the .NET Framework supported by Azure at the time of the GA release.</span></span> <span data-ttu-id="fc427-257">Infelizmente, essa versão do Framework não tem determinadas APIs EventListener que a biblioteca Microsoft.Diagnostics.Listeners precisa.</span><span class="sxs-lookup"><span data-stu-id="fc427-257">Unfortunately, this version of the framework lacks certain EventListener APIs that the Microsoft.Diagnostics.Listeners library needs.</span></span> <span data-ttu-id="fc427-258">Como o EventSource (o componente que forma a base de APIs de registro em aplicativos do Fabric) e o EventListener são rigidamente integrados, cada projeto que usa a biblioteca Microsoft.Diagnostics.Listeners deve usar uma implementação alternativa de EventSource.</span><span class="sxs-lookup"><span data-stu-id="fc427-258">Because EventSource (the component that forms the basis of logging APIs in Fabric applications) and EventListener are tightly coupled, every project that uses the Microsoft.Diagnostics.Listeners library must use an alternative implementation of EventSource.</span></span> <span data-ttu-id="fc427-259">Essa implementação é fornecida pelo **pacote Nuget Microsoft.Diagnostics.Tracing**criado pela Microsoft.</span><span class="sxs-lookup"><span data-stu-id="fc427-259">This implementation is provided by the **Microsoft.Diagnostics.Tracing Nuget package**, authored by Microsoft.</span></span> <span data-ttu-id="fc427-260">O pacote é totalmente compatível com versões anteriores do EventSource incluído na estrutura, portanto, não deve ser necessária nenhuma alteração de código que não as alterações de namespace referenciado.</span><span class="sxs-lookup"><span data-stu-id="fc427-260">The package is fully backward-compatible with EventSource included in the framework, so no code changes should be necessary other than referenced namespace changes.</span></span>

<span data-ttu-id="fc427-261">Para começar a usar a implementação Microsoft.Diagnostics.Tracing da classe EventSource, siga estas etapas para cada projeto de serviço que precisa para enviar dados ao Elasticsearch:</span><span class="sxs-lookup"><span data-stu-id="fc427-261">To start using the Microsoft.Diagnostics.Tracing implementation of the EventSource class, follow these steps for each service project that needs to send data to Elasticsearch:</span></span>

1. <span data-ttu-id="fc427-262">Clique com o botão direito do mouse no projeto de serviço e escolha **Gerenciar Pacotes Nuget**.</span><span class="sxs-lookup"><span data-stu-id="fc427-262">Right-click on the service project and choose **Manage Nuget Packages**.</span></span>
2. <span data-ttu-id="fc427-263">Mude para a origem do pacote nuget.org (se ainda não estiver selecionada) e procure por "**Microsoft.Diagnostics.Tracing**".</span><span class="sxs-lookup"><span data-stu-id="fc427-263">Switch to the nuget.org package source (if it is not already selected) and search for "**Microsoft.Diagnostics.Tracing**".</span></span>
3. <span data-ttu-id="fc427-264">Instale o pacote `Microsoft.Diagnostics.Tracing.EventSource` (e suas dependências).</span><span class="sxs-lookup"><span data-stu-id="fc427-264">Install the `Microsoft.Diagnostics.Tracing.EventSource` package (and its dependencies).</span></span>
4. <span data-ttu-id="fc427-265">Abra arquivo **ServiceEventSource.cs** ou **ActorEventSource.cs** no seu projeto de serviço e substitua a diretiva `using System.Diagnostics.Tracing` no começo do arquivo pela diretiva `using Microsoft.Diagnostics.Tracing`.</span><span class="sxs-lookup"><span data-stu-id="fc427-265">Open the **ServiceEventSource.cs** or **ActorEventSource.cs** file in your service project and replace the `using System.Diagnostics.Tracing` directive on top of the file with the `using Microsoft.Diagnostics.Tracing` directive.</span></span>

<span data-ttu-id="fc427-266">Estas etapas não serão necessárias depois que o **.NET Framework 4.6** for compatível com o Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="fc427-266">These steps will not be necessary once the **.NET Framework 4.6** is supported by Microsoft Azure.</span></span>

### <a name="elasticsearch-listener-instantiation-and-configuration"></a><span data-ttu-id="fc427-267">Configuração e instanciação de ouvinte de Elasticsearch</span><span class="sxs-lookup"><span data-stu-id="fc427-267">Elasticsearch listener instantiation and configuration</span></span>
<span data-ttu-id="fc427-268">A etapa final para enviar dados de diagnóstico ao Elasticsearch é criar uma instância de `ElasticSearchListener` e configurá-la com dados de conexão do Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="fc427-268">The final step for sending diagnostic data to Elasticsearch is to create an instance of `ElasticSearchListener` and configure it with Elasticsearch connection data.</span></span> <span data-ttu-id="fc427-269">O ouvinte captura automaticamente todos os eventos gerados por meio de classes EventSource definidas no projeto de serviço.</span><span class="sxs-lookup"><span data-stu-id="fc427-269">The listener automatically captures all events raised via EventSource classes defined in the service project.</span></span> <span data-ttu-id="fc427-270">Ele precisa estar ativo durante o tempo de vida do serviço, portanto, o melhor lugar para criá-lo é no código de inicialização do serviço.</span><span class="sxs-lookup"><span data-stu-id="fc427-270">It needs to be alive during the lifetime of the service, so the best place to create it is in the service initialization code.</span></span> <span data-ttu-id="fc427-271">Aqui está como o código de inicialização para um serviço sem estado pode parecer após as alterações necessárias (as adições estão destacadas nos comentários começando com `****`):</span><span class="sxs-lookup"><span data-stu-id="fc427-271">Here is how the initialization code for a stateless service could look after the necessary changes (additions pointed out in comments starting with `****`):</span></span>

```csharp
using System;
using System.Diagnostics;
using System.Fabric;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.ServiceFabric.Services.Runtime;

// **** Add the following directives
using Microsoft.Diagnostics.EventListeners;
using Microsoft.Diagnostics.EventListeners.Fabric;

namespace Stateless1
{
    internal static class Program
    {
        /// <summary>
        /// This is the entry point of the service host process.
        /// </summary>        
        private static void Main()
        {
            try
            {
                // **** Instantiate ElasticSearchListener
                var configProvider = new FabricConfigurationProvider("ElasticSearchEventListener");
                ElasticSearchListener esListener = null;
                if (configProvider.HasConfiguration)
                {
                    esListener = new ElasticSearchListener(configProvider, new FabricHealthReporter("ElasticSearchEventListener"));
                }

                // The ServiceManifest.XML file defines one or more service type names.
                // Registering a service maps a service type name to a .NET type.
                // When Service Fabric creates an instance of this service type,
                // an instance of the class is created in this host process.

                ServiceRuntime.RegisterServiceAsync("Stateless1Type", 
                    context => new Stateless1(context)).GetAwaiter().GetResult();

                ServiceEventSource.Current.ServiceTypeRegistered(Process.GetCurrentProcess().Id, typeof(Stateless1).Name);

                // Prevents this host process from terminating so services keep running.
                Thread.Sleep(Timeout.Infinite);

                // **** Ensure that the ElasticSearchListner instance is not garbage-collected prematurely
                GC.KeepAlive(esListener);
            }
            catch (Exception e)
            {
                ServiceEventSource.Current.ServiceHostInitializationFailed(e);
                throw;
            }
        }
    }
}
```

<span data-ttu-id="fc427-272">Os dados de conexão do Elasticsearch devem ser colocados em uma seção separada no arquivo de configuração de serviço (**PackageRoot\Config\Settings.xml**).</span><span class="sxs-lookup"><span data-stu-id="fc427-272">Elasticsearch connection data should be put in a separate section in the service configuration file (**PackageRoot\Config\Settings.xml**).</span></span> <span data-ttu-id="fc427-273">O nome da seção deve corresponder ao valor passado para o construtor `FabricConfigurationProvider` , por exemplo:</span><span class="sxs-lookup"><span data-stu-id="fc427-273">The name of the section must correspond to the value passed to the `FabricConfigurationProvider` constructor, for example:</span></span>

```xml
<Section Name="ElasticSearchEventListener">
  <Parameter Name="serviceUri" Value="http://myBigCluster.westus.cloudapp.azure.com/es/" />
  <Parameter Name="userName" Value="(ES user name)" />
  <Parameter Name="password" Value="(ES user password)" />
  <Parameter Name="indexNamePrefix" Value="myapp" />
</Section>
```
<span data-ttu-id="fc427-274">Os valores dos parâmetros `serviceUri`, `userName` e `password` correspondem ao endereço do ponto de extremidade do cluster Elasticsearch, ao nome de usuário Elasticsearch e senha, respectivamente.</span><span class="sxs-lookup"><span data-stu-id="fc427-274">The values of `serviceUri`, `userName` and `password` parameters correspond to the Elasticsearch cluster endpoint address, Elasticsearch user name, and password, respectively.</span></span> <span data-ttu-id="fc427-275">`indexNamePrefix` é o prefixo para índices do Elasticsearch; a biblioteca Microsoft.Diagnostics.Listeners cria um novo índice para seus dados diariamente.</span><span class="sxs-lookup"><span data-stu-id="fc427-275">`indexNamePrefix` is the prefix for Elasticsearch indexes; the Microsoft.Diagnostics.Listeners library creates a new index for its data daily.</span></span>

### <a name="verification"></a><span data-ttu-id="fc427-276">Verificação</span><span class="sxs-lookup"><span data-stu-id="fc427-276">Verification</span></span>
<span data-ttu-id="fc427-277">É isso!</span><span class="sxs-lookup"><span data-stu-id="fc427-277">That's it!</span></span> <span data-ttu-id="fc427-278">Agora sempre que o serviço for executado, ele será iniciado enviando rastreamentos para o serviço de Elasticsearch especificado na configuração.</span><span class="sxs-lookup"><span data-stu-id="fc427-278">Now, whenever the service is run, it starts sending traces to the Elasticsearch service specified in the configuration.</span></span> <span data-ttu-id="fc427-279">Você pode verificar isso abrindo a interface do usuário do Kibana associada à instância de Elasticsearch de destino.</span><span class="sxs-lookup"><span data-stu-id="fc427-279">You can verify this by opening the Kibana UI associated with the target Elasticsearch instance.</span></span> <span data-ttu-id="fc427-280">Em nosso exemplo, o endereço da página é http://myBigCluster.westus.cloudapp.azure.com/.</span><span class="sxs-lookup"><span data-stu-id="fc427-280">In our example, the page address is http://myBigCluster.westus.cloudapp.azure.com/.</span></span> <span data-ttu-id="fc427-281">Verifique se os índices com o prefixo do nome escolhido para a instância `ElasticSearchListener` realmente foram criados e preenchidos com dados.</span><span class="sxs-lookup"><span data-stu-id="fc427-281">Check that indexes with the name prefix chosen for the `ElasticSearchListener` instance have indeed been created and populated with data.</span></span>

![Kibana mostrando os eventos do aplicativo PartyCluster][2]

## <a name="next-steps"></a><span data-ttu-id="fc427-283">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="fc427-283">Next steps</span></span>
* [<span data-ttu-id="fc427-284">Saiba mais sobre o diagnóstico e monitoramento de um serviço da Malha de Serviço</span><span class="sxs-lookup"><span data-stu-id="fc427-284">Learn more about diagnosing and monitoring a Service Fabric service</span></span>](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md)

<!--Image references-->
[1]: ./media/service-fabric-diagnostics-how-to-use-elasticsearch/listener-lib-references.png
[2]: ./media/service-fabric-diagnostics-how-to-use-elasticsearch/kibana.png
