---
title: aaaService Gerenciador de recursos de Cluster de malha - afinidade | Microsoft Docs
description: "Visão geral da configuração de afinidade para os Serviços do Service Fabric"
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: 
ms.assetid: 678073e1-d08d-46c4-a811-826e70aba6c4
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 7dc9b6d9c18d9d615d39cff7de9d7cba1c040474
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/06/2017
---
# <a name="configuring-and-using-service-affinity-in-service-fabric"></a><span data-ttu-id="77338-103">Configurando e usando a afinidade de serviço no Service Fabric</span><span class="sxs-lookup"><span data-stu-id="77338-103">Configuring and using service affinity in Service Fabric</span></span>
<span data-ttu-id="77338-104">Afinidade é um controle que é fornecido principalmente toohelp facilidade Olá transição de aplicativos monolíticos maiores em nuvem e microservices Olá.</span><span class="sxs-lookup"><span data-stu-id="77338-104">Affinity is a control that is provided mainly toohelp ease hello transition of larger monolithic applications into hello cloud and microservices world.</span></span> <span data-ttu-id="77338-105">Ele também é usado como uma otimização para melhorar o desempenho de saudação de serviços, embora assim pode ter efeitos colaterais.</span><span class="sxs-lookup"><span data-stu-id="77338-105">It is also used as an optimization for improving hello performance of services, although doing so can have side effects.</span></span>

<span data-ttu-id="77338-106">Digamos que você está colocando um aplicativo maior, ou que não foi projetado apenas com microservices em mente, tooService malha (ou qualquer ambiente distribuído).</span><span class="sxs-lookup"><span data-stu-id="77338-106">Let’s say you’re bringing a larger app, or one that just wasn’t designed with microservices in mind, tooService Fabric (or any distributed environment).</span></span> <span data-ttu-id="77338-107">Esse tipo de transição é comum.</span><span class="sxs-lookup"><span data-stu-id="77338-107">This type of transition is common.</span></span> <span data-ttu-id="77338-108">Iniciar levantar Olá todo app no ambiente Olá, empacotá-la e tornando-se de que ele está funcionando normalmente.</span><span class="sxs-lookup"><span data-stu-id="77338-108">You start by lifting hello entire app into hello environment, packaging it, and making sure it is running smoothly.</span></span> <span data-ttu-id="77338-109">Em seguida, iniciar dividi-los em diferentes serviços menores do que todos os falar tooeach outros.</span><span class="sxs-lookup"><span data-stu-id="77338-109">Then you start breaking it down into different smaller services that all talk tooeach other.</span></span>

<span data-ttu-id="77338-110">Finalmente, você pode achar que o aplicativo hello está apresentando alguns problemas.</span><span class="sxs-lookup"><span data-stu-id="77338-110">Eventually you may find that hello application is experiencing some issues.</span></span> <span data-ttu-id="77338-111">problemas de saudação geralmente se encaixam em uma dessas categorias:</span><span class="sxs-lookup"><span data-stu-id="77338-111">hello issues usually fall into one of these categories:</span></span>

1. <span data-ttu-id="77338-112">Algum componente X no aplicativo monolítico Olá tinha uma dependência não documentada no componente Y e é ativada apenas esses componentes em serviços separados.</span><span class="sxs-lookup"><span data-stu-id="77338-112">Some component X in hello monolithic app had an undocumented dependency on component Y, and you just turned those components into separate services.</span></span> <span data-ttu-id="77338-113">Desde que esses serviços estão em execução em diferentes nós de cluster de saudação, eles são desfeitos.</span><span class="sxs-lookup"><span data-stu-id="77338-113">Since these services are now running on different nodes in hello cluster, they're broken.</span></span>
2. <span data-ttu-id="77338-114">Esses componentes se comunicam por meio de (pipes nomeados locais | memória compartilhada | arquivos no disco) e o que realmente precisam toobe capaz de toowrite tooa compartilhado local recursos por motivos de desempenho no momento.</span><span class="sxs-lookup"><span data-stu-id="77338-114">These components communicate via (local named pipes | shared memory | files on disk) and they really need toobe able toowrite tooa shared local resource for performance reasons right now.</span></span> <span data-ttu-id="77338-115">Talvez essa forte dependência seja removida mais tarde.</span><span class="sxs-lookup"><span data-stu-id="77338-115">That hard dependency gets removed later, maybe.</span></span>
3. <span data-ttu-id="77338-116">Tudo está bem, mas acontece que esses dois componentes são, na prática, verborrágicos/dependentes do desempenho.</span><span class="sxs-lookup"><span data-stu-id="77338-116">Everything is fine, but it turns out that these two components are actually chatty/performance sensitive.</span></span> <span data-ttu-id="77338-117">Quando eles são movidos para serviços separados, o desempenho do aplicativo geral despenca ou a latência aumenta.</span><span class="sxs-lookup"><span data-stu-id="77338-117">When they moved them into separate services overall application performance tanked or latency increased.</span></span> <span data-ttu-id="77338-118">Como resultado, hello geral do aplicativo não atende às expectativas.</span><span class="sxs-lookup"><span data-stu-id="77338-118">As a result, hello overall application is not meeting expectations.</span></span>

<span data-ttu-id="77338-119">Nesses casos, não quiser toolose nosso trabalho refatoração e não quiser toogo toohello back monolito.</span><span class="sxs-lookup"><span data-stu-id="77338-119">In these cases, we don’t want toolose our refactoring work, and don’t want toogo back toohello monolith.</span></span> <span data-ttu-id="77338-120">última condição de saudação ainda pode ser desejável como uma otimização simples.</span><span class="sxs-lookup"><span data-stu-id="77338-120">hello last condition may even be desirable as a plain optimization.</span></span> <span data-ttu-id="77338-121">No entanto, até que podemos pode recriar Olá componentes toowork naturalmente como serviços (ou podemos resolver as expectativas de desempenho de saudação alguma outra forma), vamos tooneed algum sentido de localidade.</span><span class="sxs-lookup"><span data-stu-id="77338-121">However, until we can redesign hello components toowork naturally as services (or until we can solve hello performance expectations some other way) we're going tooneed some sense of locality.</span></span>

<span data-ttu-id="77338-122">Quais toodo?</span><span class="sxs-lookup"><span data-stu-id="77338-122">What toodo?</span></span> <span data-ttu-id="77338-123">Bem, você poderia tentar ativar a afinidade.</span><span class="sxs-lookup"><span data-stu-id="77338-123">Well, you could try turning on affinity.</span></span>

## <a name="how-tooconfigure-affinity"></a><span data-ttu-id="77338-124">Como tooconfigure afinidade</span><span class="sxs-lookup"><span data-stu-id="77338-124">How tooconfigure affinity</span></span>
<span data-ttu-id="77338-125">tooset a afinidade, você definir uma relação de afinidade entre dois serviços diferentes.</span><span class="sxs-lookup"><span data-stu-id="77338-125">tooset up affinity, you define an affinity relationship between two different services.</span></span> <span data-ttu-id="77338-126">Você pode pensar na afinidade como se estivesse "apontando" um serviço para outro e dizendo "Este serviço só pode ser executado quando esse serviço estiver em execução".</span><span class="sxs-lookup"><span data-stu-id="77338-126">You can think of affinity as “pointing” one service at another and saying “This service can only run where that service is running.”</span></span> <span data-ttu-id="77338-127">Às vezes, nos referimos tooaffinity como uma relação pai/filho (onde você apontar filho Olá pai Olá).</span><span class="sxs-lookup"><span data-stu-id="77338-127">Sometimes we refer tooaffinity as a parent/child relationship (where you point hello child at hello parent).</span></span> <span data-ttu-id="77338-128">Afinidade assegura que as réplicas de saudação ou instâncias de um serviço são colocadas em Olá mesmo nós como o de outro serviço.</span><span class="sxs-lookup"><span data-stu-id="77338-128">Affinity ensures that hello replicas or instances of one service are placed on hello same nodes as those of another service.</span></span>

```csharp
ServiceCorrelationDescription affinityDescription = new ServiceCorrelationDescription();
affinityDescription.Scheme = ServiceCorrelationScheme.Affinity;
affinityDescription.ServiceName = new Uri("fabric:/otherApplication/parentService");
serviceDescription.Correlations.Add(affinityDescription);
await fabricClient.ServiceManager.CreateServiceAsync(serviceDescription);
```

> [!NOTE]
> <span data-ttu-id="77338-129">Um serviço filho só pode participar de uma única relação de afinidade.</span><span class="sxs-lookup"><span data-stu-id="77338-129">A child service can only participate in a single affinity relationship.</span></span> <span data-ttu-id="77338-130">Se você quisesse Olá filho toobe relacionado tootwo pai serviços ao mesmo tempo, você tem duas opções:</span><span class="sxs-lookup"><span data-stu-id="77338-130">If you wanted hello child toobe affinitized tootwo parent services at once you have a couple options:</span></span>
> - <span data-ttu-id="77338-131">Inverter relações hello (tiver parentService1 e parentService2 ponto no serviço de filho atual Olá), ou</span><span class="sxs-lookup"><span data-stu-id="77338-131">Reverse hello relationships (have parentService1 and parentService2 point at hello current child service), or</span></span>
> - <span data-ttu-id="77338-132">Designar um dos pais hello como um hub por convenção e ter todos os serviços de ponto de serviço.</span><span class="sxs-lookup"><span data-stu-id="77338-132">Designate one of hello parents as a hub by convention and have all services point at that service.</span></span> 
>
> <span data-ttu-id="77338-133">Olá resultante comportamento de posicionamento no cluster Olá deve ser Olá mesmo.</span><span class="sxs-lookup"><span data-stu-id="77338-133">hello resulting placement behavior in hello cluster should be hello same.</span></span>
>

## <a name="different-affinity-options"></a><span data-ttu-id="77338-134">Diferentes opções de afinidade</span><span class="sxs-lookup"><span data-stu-id="77338-134">Different affinity options</span></span>
<span data-ttu-id="77338-135">A afinidade é representada por meio de um dos vários esquemas de correlação e tem dois modos diferentes.</span><span class="sxs-lookup"><span data-stu-id="77338-135">Affinity is represented via one of several correlation schemes, and has two different modes.</span></span> <span data-ttu-id="77338-136">Olá o modo mais comum de afinidade é o que chamamos de NonAlignedAffinity.</span><span class="sxs-lookup"><span data-stu-id="77338-136">hello most common mode of affinity is what we call NonAlignedAffinity.</span></span> <span data-ttu-id="77338-137">Em NonAlignedAffinity, Olá réplicas ou instâncias de serviços diferentes Olá são colocadas em Olá mesmo nós.</span><span class="sxs-lookup"><span data-stu-id="77338-137">In NonAlignedAffinity, hello replicas or instances of hello different services are placed on hello same nodes.</span></span> <span data-ttu-id="77338-138">Olá, outro modo é AlignedAffinity.</span><span class="sxs-lookup"><span data-stu-id="77338-138">hello other mode is AlignedAffinity.</span></span> <span data-ttu-id="77338-139">A Afinidade Alinhada é útil apenas com serviços com estado.</span><span class="sxs-lookup"><span data-stu-id="77338-139">Aligned Affinity is useful only with stateful services.</span></span> <span data-ttu-id="77338-140">Configuração de monitoração de estado dois serviços toohave alinhado afinidade assegura que primárias Olá desses serviços são colocadas em Olá mesmo nós de cada outro.</span><span class="sxs-lookup"><span data-stu-id="77338-140">Configuring two stateful services toohave aligned affinity ensures that hello primaries of those services are placed on hello same nodes as each other.</span></span> <span data-ttu-id="77338-141">Ele também faz com que cada par de secundários para esses serviços toobe colocada em Olá mesmo nós.</span><span class="sxs-lookup"><span data-stu-id="77338-141">It also causes each pair of secondaries for those services toobe placed on hello same nodes.</span></span> <span data-ttu-id="77338-142">Também é possível (embora menos comum) tooconfigure NonAlignedAffinity para serviços com monitoração de estado.</span><span class="sxs-lookup"><span data-stu-id="77338-142">It is also possible (though less common) tooconfigure NonAlignedAffinity for stateful services.</span></span> <span data-ttu-id="77338-143">Para NonAlignedAffinity, diferentes réplicas de saudação do hello dois serviços com monitoração de estado será executado no hello nós mesmos, mas seus primárias poderiam acabar em nós diferentes.</span><span class="sxs-lookup"><span data-stu-id="77338-143">For NonAlignedAffinity, hello different replicas of hello two stateful services would run on hello same nodes, but their primaries could end up on different nodes.</span></span>

<span data-ttu-id="77338-144"><center>
![Modos de afinidade e seus efeitos][Image1]
</center></span><span class="sxs-lookup"><span data-stu-id="77338-144"><center>
![Affinity Modes and Their Effects][Image1]
</center></span></span>

### <a name="best-effort-desired-state"></a><span data-ttu-id="77338-145">Estado desejado de melhor esforço</span><span class="sxs-lookup"><span data-stu-id="77338-145">Best effort desired state</span></span>
<span data-ttu-id="77338-146">Uma relação de afinidade é considerada um melhor esforço.</span><span class="sxs-lookup"><span data-stu-id="77338-146">An affinity relationship is best effort.</span></span> <span data-ttu-id="77338-147">Ele não fornece Olá mesmas garantias de confiabilidade, em execução no hello mesmo processo executável faz ou de colocação.</span><span class="sxs-lookup"><span data-stu-id="77338-147">It does not provide hello same guarantees of collocation or reliability that running in hello same executable process does.</span></span> <span data-ttu-id="77338-148">Serviços de saudação em um relacionamento de afinidade são fundamentalmente diferentes entidades que podem falhar e ser movidas independentemente.</span><span class="sxs-lookup"><span data-stu-id="77338-148">hello services in an affinity relationship are fundamentally different entities that can fail and be moved independently.</span></span> <span data-ttu-id="77338-149">Uma relação de afinidade também pode ser interrompida, embora essas interrupções sejam temporárias.</span><span class="sxs-lookup"><span data-stu-id="77338-149">An affinity relationship could also break, though these breaks are temporary.</span></span> <span data-ttu-id="77338-150">Por exemplo, as limitações de capacidade podem significar que apenas alguns dos objetos de serviço de saudação na relação de afinidade Olá podem se ajustar em um determinado nó.</span><span class="sxs-lookup"><span data-stu-id="77338-150">For example, capacity limitations may mean that only some of hello service objects in hello affinity relationship can fit on a given node.</span></span> <span data-ttu-id="77338-151">Nesses casos, embora não exista uma relação de afinidade no lugar, ele não pode ser imposto vencimento toohello outras restrições.</span><span class="sxs-lookup"><span data-stu-id="77338-151">In these cases even though there's an affinity relationship in place, it can't be enforced due toohello other constraints.</span></span> <span data-ttu-id="77338-152">Se for possível toodo assim, violação Olá será corrigida automaticamente mais tarde.</span><span class="sxs-lookup"><span data-stu-id="77338-152">If it is possible toodo so, hello violation is automatically corrected later.</span></span>

### <a name="chains-vs-stars"></a><span data-ttu-id="77338-153">Cadeias vs. estrelas</span><span class="sxs-lookup"><span data-stu-id="77338-153">Chains vs. stars</span></span>
<span data-ttu-id="77338-154">Hoje Olá Gerenciador de recursos de Cluster não é capaz de toomodel cadeias de relações de afinidade.</span><span class="sxs-lookup"><span data-stu-id="77338-154">Today hello Cluster Resource Manager isn't able toomodel chains of affinity relationships.</span></span> <span data-ttu-id="77338-155">Isso significa que um serviço filho em um relacionamento de afinidade não pode ser pai em outro relacionamento de afinidade.</span><span class="sxs-lookup"><span data-stu-id="77338-155">What this means is that a service that is a child in one affinity relationship can’t be a parent in another affinity relationship.</span></span> <span data-ttu-id="77338-156">Se você quiser toomodel esse tipo de relação, você tem efetivamente toomodel-lo como uma estrela, em vez de uma cadeia.</span><span class="sxs-lookup"><span data-stu-id="77338-156">If you want toomodel this type of relationship, you effectively have toomodel it as a star, rather than a chain.</span></span> <span data-ttu-id="77338-157">toomove de estrela de tooa uma cadeia, filho na extremidade inferior Olá seria pai do filho do pai toohello primeiro.</span><span class="sxs-lookup"><span data-stu-id="77338-157">toomove from a chain tooa star, hello bottommost child would be parented toohello first child’s parent instead.</span></span> <span data-ttu-id="77338-158">Dependendo da organização de saudação de seus serviços, você pode ter toodo esse procedimento várias vezes.</span><span class="sxs-lookup"><span data-stu-id="77338-158">Depending on hello arrangement of your services, you may have toodo this multiple times.</span></span> <span data-ttu-id="77338-159">Se não houver nenhum serviço pai natural, você pode ter toocreate um que funciona como um espaço reservado.</span><span class="sxs-lookup"><span data-stu-id="77338-159">If there's no natural parent service, you may have toocreate one that serves as a placeholder.</span></span> <span data-ttu-id="77338-160">Dependendo dos requisitos, talvez você queira toolook em [grupos de aplicativos](service-fabric-cluster-resource-manager-application-groups.md).</span><span class="sxs-lookup"><span data-stu-id="77338-160">Depending on your requirements, you may also want toolook into [Application Groups](service-fabric-cluster-resource-manager-application-groups.md).</span></span>

<span data-ttu-id="77338-161"><center>
![Cadeias vs. Estrelas no hello contexto de relações de afinidade][Image2]
</center></span><span class="sxs-lookup"><span data-stu-id="77338-161"><center>
![Chains vs. Stars in hello Context of Affinity Relationships][Image2]
</center></span></span>

<span data-ttu-id="77338-162">Outro toonote coisa sobre relações de afinidade de hoje é que eles são direcionais.</span><span class="sxs-lookup"><span data-stu-id="77338-162">Another thing toonote about affinity relationships today is that they are directional.</span></span> <span data-ttu-id="77338-163">Isso significa que a regra afinidade Olá impõe somente criança Olá colocada com pai hello.</span><span class="sxs-lookup"><span data-stu-id="77338-163">This means that hello affinity rule only enforces that hello child placed with hello parent.</span></span> <span data-ttu-id="77338-164">Ela não garante que pai hello está localizado com filho hello.</span><span class="sxs-lookup"><span data-stu-id="77338-164">It does not ensure that hello parent is located with hello child.</span></span> <span data-ttu-id="77338-165">Também é importante toonote que Olá relacionamento de afinidade não pode ser perfeito ou instantaneamente imposta como serviços diferentes com diferentes ciclos de vida e podem falhar e mover independentemente.</span><span class="sxs-lookup"><span data-stu-id="77338-165">It is also important toonote that hello affinity relationship can't be perfect or instantly enforced since different services have with different lifecycles and can fail and move independently.</span></span> <span data-ttu-id="77338-166">Por exemplo, digamos que pai Olá repentinamente Falha ao nó tooanother porque ele falhou.</span><span class="sxs-lookup"><span data-stu-id="77338-166">For example, let's say hello parent suddenly fails over tooanother node because it crashed.</span></span> <span data-ttu-id="77338-167">Olá Gerenciador de recursos de Cluster e o identificador de Gerenciador de Failover Olá failover em primeiro lugar, como manter os serviços de hello, consistente e disponível é a prioridade de saudação.</span><span class="sxs-lookup"><span data-stu-id="77338-167">hello Cluster Resource Manager and Failover Manager handle hello failover first, since keeping hello services up, consistent, and available is hello priority.</span></span> <span data-ttu-id="77338-168">Após a conclusão do failover Olá, relação de afinidade Olá for interrompida, mas Olá Gerenciador de recursos de Cluster considera que tudo está bem até que observa que filho Olá não é localizado com pai hello.</span><span class="sxs-lookup"><span data-stu-id="77338-168">Once hello failover completes, hello affinity relationship is broken, but hello Cluster Resource Manager thinks everything is fine until it notices that hello child is not located with hello parent.</span></span> <span data-ttu-id="77338-169">Esses tipos de verificações são executados periodicamente.</span><span class="sxs-lookup"><span data-stu-id="77338-169">These sorts of checks are performed periodically.</span></span> <span data-ttu-id="77338-170">Mais informações sobre como Olá Gerenciador de recursos de Cluster avalia as restrições estão disponíveis em [neste artigo](service-fabric-cluster-resource-manager-management-integration.md#constraint-types), e [este](service-fabric-cluster-resource-manager-balancing.md) fala mais sobre como tooconfigure Olá cadência na qual essas restrições são avaliada.</span><span class="sxs-lookup"><span data-stu-id="77338-170">More information on how hello Cluster Resource Manager evaluates constraints is available in [this article](service-fabric-cluster-resource-manager-management-integration.md#constraint-types), and [this one](service-fabric-cluster-resource-manager-balancing.md) talks more about how tooconfigure hello cadence on which these constraints are evaluated.</span></span>   


### <a name="partitioning-support"></a><span data-ttu-id="77338-171">Suporte ao particionamento</span><span class="sxs-lookup"><span data-stu-id="77338-171">Partitioning support</span></span>
<span data-ttu-id="77338-172">Olá coisa final toonotice sobre a afinidade é que relações de afinidade não há suporte para onde o pai de saudação é particionada.</span><span class="sxs-lookup"><span data-stu-id="77338-172">hello final thing toonotice about affinity is that affinity relationships aren’t supported where hello parent is partitioned.</span></span> <span data-ttu-id="77338-173">Serviços pai particionados podem vir a ter suporte, mas atualmente isso não é permitido.</span><span class="sxs-lookup"><span data-stu-id="77338-173">Partitioned parent services may be supported eventually, but today it is not allowed.</span></span>

## <a name="next-steps"></a><span data-ttu-id="77338-174">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="77338-174">Next steps</span></span>
- <span data-ttu-id="77338-175">Para saber mais sobre como configurar os serviços, [Saiba mais sobre como configurar serviços](service-fabric-cluster-resource-manager-configure-services.md)</span><span class="sxs-lookup"><span data-stu-id="77338-175">For more information on configuring services, [Learn about configuring Services](service-fabric-cluster-resource-manager-configure-services.md)</span></span>
- <span data-ttu-id="77338-176">toolimit serviços tooa um conjunto pequeno de máquinas ou agregação carga Olá de serviços, use [grupos de aplicativos](service-fabric-cluster-resource-manager-application-groups.md)</span><span class="sxs-lookup"><span data-stu-id="77338-176">toolimit services tooa small set of machines or aggregating hello load of services, use [Application Groups](service-fabric-cluster-resource-manager-application-groups.md)</span></span>

[Image1]:./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resrouce-manager-affinity-modes.png
[Image2]:./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resource-manager-chains-vs-stars.png