---
title: "Resource Manager de Cluster do Service Fabric – afinidade | Microsoft Docs"
description: "Visão geral da configuração de afinidade para os Serviços do Service Fabric"
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: 
ms.assetid: 678073e1-d08d-46c4-a811-826e70aba6c4
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 3efda4ee4016245668e5da431d7b8868a21c790e
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/18/2017
---
# <a name="configuring-and-using-service-affinity-in-service-fabric"></a><span data-ttu-id="cc345-103">Configurando e usando a afinidade de serviço no Service Fabric</span><span class="sxs-lookup"><span data-stu-id="cc345-103">Configuring and using service affinity in Service Fabric</span></span>
<span data-ttu-id="cc345-104">A afinidade é um controle fornecido principalmente para ajudar a facilitar a transição de aplicativos monolíticos maiores para a nuvem e o mundo de microsserviços.</span><span class="sxs-lookup"><span data-stu-id="cc345-104">Affinity is a control that is provided mainly to help ease the transition of larger monolithic applications into the cloud and microservices world.</span></span> <span data-ttu-id="cc345-105">Ela também é usada como uma otimização para melhorar o desempenho de serviços, embora fazer isso possa ter efeitos colaterais.</span><span class="sxs-lookup"><span data-stu-id="cc345-105">It is also used as an optimization for improving the performance of services, although doing so can have side effects.</span></span>

<span data-ttu-id="cc345-106">Digamos que você esteja levando um aplicativo maior ou que simplesmente não tenha sido desenvolvido pensando nos microsserviços, para o Service Fabric (ou para qualquer ambiente distribuído).</span><span class="sxs-lookup"><span data-stu-id="cc345-106">Let’s say you’re bringing a larger app, or one that just wasn’t designed with microservices in mind, to Service Fabric (or any distributed environment).</span></span> <span data-ttu-id="cc345-107">Esse tipo de transição é comum.</span><span class="sxs-lookup"><span data-stu-id="cc345-107">This type of transition is common.</span></span> <span data-ttu-id="cc345-108">Comece levantando o aplicativo inteiro no ambiente, empacotando-o e certificando-se de que ele esteja sendo executado perfeitamente.</span><span class="sxs-lookup"><span data-stu-id="cc345-108">You start by lifting the entire app into the environment, packaging it, and making sure it is running smoothly.</span></span> <span data-ttu-id="cc345-109">Em seguida, comece a dividi-lo em serviços menores diferentes que se comunicam entre si.</span><span class="sxs-lookup"><span data-stu-id="cc345-109">Then you start breaking it down into different smaller services that all talk to each other.</span></span>

<span data-ttu-id="cc345-110">Por fim, você pode descobrir que o aplicativo está apresentando alguns problemas.</span><span class="sxs-lookup"><span data-stu-id="cc345-110">Eventually you may find that the application is experiencing some issues.</span></span> <span data-ttu-id="cc345-111">Os problemas normalmente se encaixam em uma destas categorias:</span><span class="sxs-lookup"><span data-stu-id="cc345-111">The issues usually fall into one of these categories:</span></span>

1. <span data-ttu-id="cc345-112">Algum componente X no aplicativo monolítico tinha uma dependência não documentada no componente Y, e você acabou de transformar esses componentes em serviços separados.</span><span class="sxs-lookup"><span data-stu-id="cc345-112">Some component X in the monolithic app had an undocumented dependency on component Y, and you just turned those components into separate services.</span></span> <span data-ttu-id="cc345-113">Uma vez que agora esses serviços estão sendo executados em diferentes nós do cluster, eles estão desvinculados.</span><span class="sxs-lookup"><span data-stu-id="cc345-113">Since these services are now running on different nodes in the cluster, they're broken.</span></span>
2. <span data-ttu-id="cc345-114">Esses componentes se comunicam via (pipes nomeados locais | memória compartilhada | arquivos no disco) e eles realmente precisam conseguir gravar em um recurso local compartilhado por motivos de desempenho neste momento.</span><span class="sxs-lookup"><span data-stu-id="cc345-114">These components communicate via (local named pipes | shared memory | files on disk) and they really need to be able to write to a shared local resource for performance reasons right now.</span></span> <span data-ttu-id="cc345-115">Talvez essa forte dependência seja removida mais tarde.</span><span class="sxs-lookup"><span data-stu-id="cc345-115">That hard dependency gets removed later, maybe.</span></span>
3. <span data-ttu-id="cc345-116">Tudo está bem, mas acontece que esses dois componentes são, na prática, verborrágicos/dependentes do desempenho.</span><span class="sxs-lookup"><span data-stu-id="cc345-116">Everything is fine, but it turns out that these two components are actually chatty/performance sensitive.</span></span> <span data-ttu-id="cc345-117">Quando eles são movidos para serviços separados, o desempenho do aplicativo geral despenca ou a latência aumenta.</span><span class="sxs-lookup"><span data-stu-id="cc345-117">When they moved them into separate services overall application performance tanked or latency increased.</span></span> <span data-ttu-id="cc345-118">Consequentemente, o aplicativo, de modo geral, não está atendendo às expectativas.</span><span class="sxs-lookup"><span data-stu-id="cc345-118">As a result, the overall application is not meeting expectations.</span></span>

<span data-ttu-id="cc345-119">Nesses casos, não queremos perder nosso trabalho de refatoração e não queremos voltar ao monólito.</span><span class="sxs-lookup"><span data-stu-id="cc345-119">In these cases, we don’t want to lose our refactoring work, and don’t want to go back to the monolith.</span></span> <span data-ttu-id="cc345-120">A última condição pode até mesmo ser desejável como uma otimização simples.</span><span class="sxs-lookup"><span data-stu-id="cc345-120">The last condition may even be desirable as a plain optimization.</span></span> <span data-ttu-id="cc345-121">No entanto, até que possamos recriar os componentes para trabalhar naturalmente como serviços (ou até que possamos resolver as expectativas de desempenho de algum modo), vamos precisar de algum senso de localidade.</span><span class="sxs-lookup"><span data-stu-id="cc345-121">However, until we can redesign the components to work naturally as services (or until we can solve the performance expectations some other way) we're going to need some sense of locality.</span></span>

<span data-ttu-id="cc345-122">O que fazer?</span><span class="sxs-lookup"><span data-stu-id="cc345-122">What to do?</span></span> <span data-ttu-id="cc345-123">Bem, você poderia tentar ativar a afinidade.</span><span class="sxs-lookup"><span data-stu-id="cc345-123">Well, you could try turning on affinity.</span></span>

## <a name="how-to-configure-affinity"></a><span data-ttu-id="cc345-124">Como configurar a afinidade</span><span class="sxs-lookup"><span data-stu-id="cc345-124">How to configure affinity</span></span>
<span data-ttu-id="cc345-125">Para configurar a afinidade, você define uma relação de afinidade entre dois serviços diferentes.</span><span class="sxs-lookup"><span data-stu-id="cc345-125">To set up affinity, you define an affinity relationship between two different services.</span></span> <span data-ttu-id="cc345-126">Você pode pensar na afinidade como se estivesse "apontando" um serviço para outro e dizendo "Este serviço só pode ser executado quando esse serviço estiver em execução".</span><span class="sxs-lookup"><span data-stu-id="cc345-126">You can think of affinity as “pointing” one service at another and saying “This service can only run where that service is running.”</span></span> <span data-ttu-id="cc345-127">Às vezes, nos referimos à afinidade como relações entre pai e filho (nas quais você aponta o filho para o pai).</span><span class="sxs-lookup"><span data-stu-id="cc345-127">Sometimes we refer to affinity as a parent/child relationship (where you point the child at the parent).</span></span> <span data-ttu-id="cc345-128">A afinidade garante que as réplicas ou instâncias de um serviço sejam colocadas nos mesmos nós que as de outro serviço.</span><span class="sxs-lookup"><span data-stu-id="cc345-128">Affinity ensures that the replicas or instances of one service are placed on the same nodes as those of another service.</span></span>

```csharp
ServiceCorrelationDescription affinityDescription = new ServiceCorrelationDescription();
affinityDescription.Scheme = ServiceCorrelationScheme.Affinity;
affinityDescription.ServiceName = new Uri("fabric:/otherApplication/parentService");
serviceDescription.Correlations.Add(affinityDescription);
await fabricClient.ServiceManager.CreateServiceAsync(serviceDescription);
```

> [!NOTE]
> <span data-ttu-id="cc345-129">Um serviço filho só pode participar de uma única relação de afinidade.</span><span class="sxs-lookup"><span data-stu-id="cc345-129">A child service can only participate in a single affinity relationship.</span></span> <span data-ttu-id="cc345-130">Se quisesse que o filho tivesse uma relação de afinidade com dois serviços pai de uma vez, você teria duas opções:</span><span class="sxs-lookup"><span data-stu-id="cc345-130">If you wanted the child to be affinitized to two parent services at once you have a couple options:</span></span>
> - <span data-ttu-id="cc345-131">Inverter as relações (fazer com que parentService1 e parentService2 apontem para o serviço filho atual) ou</span><span class="sxs-lookup"><span data-stu-id="cc345-131">Reverse the relationships (have parentService1 and parentService2 point at the current child service), or</span></span>
> - <span data-ttu-id="cc345-132">Designar um dos pais como um hub por convenção e fazer com que todos os serviços apontem para ele.</span><span class="sxs-lookup"><span data-stu-id="cc345-132">Designate one of the parents as a hub by convention and have all services point at that service.</span></span> 
>
> <span data-ttu-id="cc345-133">O comportamento de posicionamento resultante no cluster deve ser o mesmo.</span><span class="sxs-lookup"><span data-stu-id="cc345-133">The resulting placement behavior in the cluster should be the same.</span></span>
>

## <a name="different-affinity-options"></a><span data-ttu-id="cc345-134">Diferentes opções de afinidade</span><span class="sxs-lookup"><span data-stu-id="cc345-134">Different affinity options</span></span>
<span data-ttu-id="cc345-135">A afinidade é representada por meio de um dos vários esquemas de correlação e tem dois modos diferentes.</span><span class="sxs-lookup"><span data-stu-id="cc345-135">Affinity is represented via one of several correlation schemes, and has two different modes.</span></span> <span data-ttu-id="cc345-136">O modo mais comum de afinidade é o que chamamos de NonAlignedAffinity.</span><span class="sxs-lookup"><span data-stu-id="cc345-136">The most common mode of affinity is what we call NonAlignedAffinity.</span></span> <span data-ttu-id="cc345-137">No modo NonAlignedAffinity, as réplicas ou instâncias dos diferentes serviços são colocadas nos mesmos nós.</span><span class="sxs-lookup"><span data-stu-id="cc345-137">In NonAlignedAffinity, the replicas or instances of the different services are placed on the same nodes.</span></span> <span data-ttu-id="cc345-138">Outro modo é o AlignedAffinity.</span><span class="sxs-lookup"><span data-stu-id="cc345-138">The other mode is AlignedAffinity.</span></span> <span data-ttu-id="cc345-139">A Afinidade Alinhada é útil apenas com serviços com estado.</span><span class="sxs-lookup"><span data-stu-id="cc345-139">Aligned Affinity is useful only with stateful services.</span></span> <span data-ttu-id="cc345-140">Configurar dois serviços com estado para afinidade alinhada garante que os primários desses serviços sejam colocados nos mesmos nós um do outro.</span><span class="sxs-lookup"><span data-stu-id="cc345-140">Configuring two stateful services to have aligned affinity ensures that the primaries of those services are placed on the same nodes as each other.</span></span> <span data-ttu-id="cc345-141">Ele também faz com que cada par de secundários desses serviços sejam colocados nos mesmos nós.</span><span class="sxs-lookup"><span data-stu-id="cc345-141">It also causes each pair of secondaries for those services to be placed on the same nodes.</span></span> <span data-ttu-id="cc345-142">Também é possível (embora menos comum) configurar NonAlignedAffinity para serviços com estado.</span><span class="sxs-lookup"><span data-stu-id="cc345-142">It is also possible (though less common) to configure NonAlignedAffinity for stateful services.</span></span> <span data-ttu-id="cc345-143">Para NonAlignedAffinity, as diferentes réplicas dos dois serviços com estado seriam executadas nos mesmos nós, mas suas primárias poderiam acabar em nós diferentes.</span><span class="sxs-lookup"><span data-stu-id="cc345-143">For NonAlignedAffinity, the different replicas of the two stateful services would run on the same nodes, but their primaries could end up on different nodes.</span></span>

<span data-ttu-id="cc345-144"><center>
![Modos de afinidade e seus efeitos][Image1]
</center></span><span class="sxs-lookup"><span data-stu-id="cc345-144"><center>
![Affinity Modes and Their Effects][Image1]
</center></span></span>

### <a name="best-effort-desired-state"></a><span data-ttu-id="cc345-145">Estado desejado de melhor esforço</span><span class="sxs-lookup"><span data-stu-id="cc345-145">Best effort desired state</span></span>
<span data-ttu-id="cc345-146">Uma relação de afinidade é considerada um melhor esforço.</span><span class="sxs-lookup"><span data-stu-id="cc345-146">An affinity relationship is best effort.</span></span> <span data-ttu-id="cc345-147">Ele não fornece as mesmas garantias de colocação ou de confiabilidade fornecidas pela execução no mesmo processo executável.</span><span class="sxs-lookup"><span data-stu-id="cc345-147">It does not provide the same guarantees of collocation or reliability that running in the same executable process does.</span></span> <span data-ttu-id="cc345-148">Os serviços em uma relação de afinidade são basicamente entidades diferentes que podem falhar e serem movidas de modo independente.</span><span class="sxs-lookup"><span data-stu-id="cc345-148">The services in an affinity relationship are fundamentally different entities that can fail and be moved independently.</span></span> <span data-ttu-id="cc345-149">Uma relação de afinidade também pode ser interrompida, embora essas interrupções sejam temporárias.</span><span class="sxs-lookup"><span data-stu-id="cc345-149">An affinity relationship could also break, though these breaks are temporary.</span></span> <span data-ttu-id="cc345-150">Por exemplo, limitações de capacidade podem significar que apenas alguns do objetos de serviço na relação de afinidade podem se ajustar em um determinado nó.</span><span class="sxs-lookup"><span data-stu-id="cc345-150">For example, capacity limitations may mean that only some of the service objects in the affinity relationship can fit on a given node.</span></span> <span data-ttu-id="cc345-151">Nesses casos, embora haja uma relação de afinidade definida, ela não pode ser imposta devido a outras restrições.</span><span class="sxs-lookup"><span data-stu-id="cc345-151">In these cases even though there's an affinity relationship in place, it can't be enforced due to the other constraints.</span></span> <span data-ttu-id="cc345-152">Se for possível fazer isso, a violação será corrigida automaticamente mais tarde.</span><span class="sxs-lookup"><span data-stu-id="cc345-152">If it is possible to do so, the violation is automatically corrected later.</span></span>

### <a name="chains-vs-stars"></a><span data-ttu-id="cc345-153">Cadeias vs. estrelas</span><span class="sxs-lookup"><span data-stu-id="cc345-153">Chains vs. stars</span></span>
<span data-ttu-id="cc345-154">Atualmente, o Gerenciador de Recursos de Cluster não é capaz de modelar cadeias de relações de afinidade.</span><span class="sxs-lookup"><span data-stu-id="cc345-154">Today the Cluster Resource Manager isn't able to model chains of affinity relationships.</span></span> <span data-ttu-id="cc345-155">Isso significa que um serviço filho em um relacionamento de afinidade não pode ser pai em outro relacionamento de afinidade.</span><span class="sxs-lookup"><span data-stu-id="cc345-155">What this means is that a service that is a child in one affinity relationship can’t be a parent in another affinity relationship.</span></span> <span data-ttu-id="cc345-156">Se você quiser modelar esse tipo de relação, será preciso modelá-la efetivamente como uma estrela, e não como uma cadeia.</span><span class="sxs-lookup"><span data-stu-id="cc345-156">If you want to model this type of relationship, you effectively have to model it as a star, rather than a chain.</span></span> <span data-ttu-id="cc345-157">Para passar de uma cadeia para uma estrela, o filho no nível mais baixo seria como pai para o pai do primeiro filho.</span><span class="sxs-lookup"><span data-stu-id="cc345-157">To move from a chain to a star, the bottommost child would be parented to the first child’s parent instead.</span></span> <span data-ttu-id="cc345-158">Dependendo da organização dos seus serviços, você pode ter que fazer isso várias vezes.</span><span class="sxs-lookup"><span data-stu-id="cc345-158">Depending on the arrangement of your services, you may have to do this multiple times.</span></span> <span data-ttu-id="cc345-159">Se não houver serviço pai natural, talvez você tenha que criar um que sirva como um espaço reservado.</span><span class="sxs-lookup"><span data-stu-id="cc345-159">If there's no natural parent service, you may have to create one that serves as a placeholder.</span></span> <span data-ttu-id="cc345-160">Dependendo dos seus requisitos, também pode ser conveniente examinar os [Grupos de Aplicativos](service-fabric-cluster-resource-manager-application-groups.md).</span><span class="sxs-lookup"><span data-stu-id="cc345-160">Depending on your requirements, you may also want to look into [Application Groups](service-fabric-cluster-resource-manager-application-groups.md).</span></span>

<span data-ttu-id="cc345-161"><center>
![Cadeias vs. estrelas no contexto de relações de afinidade][Image2]
</center></span><span class="sxs-lookup"><span data-stu-id="cc345-161"><center>
![Chains vs. Stars in the Context of Affinity Relationships][Image2]
</center></span></span>

<span data-ttu-id="cc345-162">Outra coisa a ser observada sobre as relações atuais de afinidade é que elas são direcionais.</span><span class="sxs-lookup"><span data-stu-id="cc345-162">Another thing to note about affinity relationships today is that they are directional.</span></span> <span data-ttu-id="cc345-163">Isso significa que a regra de afinidade impõe apenas que o filho seja posicionado onde o pai estiver.</span><span class="sxs-lookup"><span data-stu-id="cc345-163">This means that the affinity rule only enforces that the child placed with the parent.</span></span> <span data-ttu-id="cc345-164">Ela não garante que o pai fique localizado com o filho.</span><span class="sxs-lookup"><span data-stu-id="cc345-164">It does not ensure that the parent is located with the child.</span></span> <span data-ttu-id="cc345-165">Também é importante observar que a relação de afinidade não pode ser perfeita ou imposta instantaneamente, pois serviços diferentes têm ciclos de vida diferentes e podem falhar e mover-se independentemente.</span><span class="sxs-lookup"><span data-stu-id="cc345-165">It is also important to note that the affinity relationship can't be perfect or instantly enforced since different services have with different lifecycles and can fail and move independently.</span></span> <span data-ttu-id="cc345-166">Por exemplo, digamos que o pai, de repente, faça failover para outro nó após uma falha.</span><span class="sxs-lookup"><span data-stu-id="cc345-166">For example, let's say the parent suddenly fails over to another node because it crashed.</span></span> <span data-ttu-id="cc345-167">O Gerenciador de Recursos de Cluster e o Gerenciador de Failover lidam com o failover primeiro, pois manter os serviços em atividade, consistentes e disponíveis é a prioridade.</span><span class="sxs-lookup"><span data-stu-id="cc345-167">The Cluster Resource Manager and Failover Manager handle the failover first, since keeping the services up, consistent, and available is the priority.</span></span> <span data-ttu-id="cc345-168">Quando o failover for concluído, a relação de afinidade estará interrompida, mas o Gerenciador de Recursos de Cluster considerará que tudo está indo bem até perceber que o filho não está localizado com o pai.</span><span class="sxs-lookup"><span data-stu-id="cc345-168">Once the failover completes, the affinity relationship is broken, but the Cluster Resource Manager thinks everything is fine until it notices that the child is not located with the parent.</span></span> <span data-ttu-id="cc345-169">Esses tipos de verificações são executados periodicamente.</span><span class="sxs-lookup"><span data-stu-id="cc345-169">These sorts of checks are performed periodically.</span></span> <span data-ttu-id="cc345-170">Mais informações sobre como o Gerenciador de Recursos de Cluster avalia restrições estão disponíveis [neste artigo](service-fabric-cluster-resource-manager-management-integration.md#constraint-types) e [este](service-fabric-cluster-resource-manager-balancing.md) fala mais sobre como configurar a cadência com que essas restrições são avaliadas.</span><span class="sxs-lookup"><span data-stu-id="cc345-170">More information on how the Cluster Resource Manager evaluates constraints is available in [this article](service-fabric-cluster-resource-manager-management-integration.md#constraint-types), and [this one](service-fabric-cluster-resource-manager-balancing.md) talks more about how to configure the cadence on which these constraints are evaluated.</span></span>   


### <a name="partitioning-support"></a><span data-ttu-id="cc345-171">Suporte ao particionamento</span><span class="sxs-lookup"><span data-stu-id="cc345-171">Partitioning support</span></span>
<span data-ttu-id="cc345-172">A observação final sobre a afinidade é que as relações de afinidade não têm suporte quando o pai é particionado.</span><span class="sxs-lookup"><span data-stu-id="cc345-172">The final thing to notice about affinity is that affinity relationships aren’t supported where the parent is partitioned.</span></span> <span data-ttu-id="cc345-173">Serviços pai particionados podem vir a ter suporte, mas atualmente isso não é permitido.</span><span class="sxs-lookup"><span data-stu-id="cc345-173">Partitioned parent services may be supported eventually, but today it is not allowed.</span></span>

## <a name="next-steps"></a><span data-ttu-id="cc345-174">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="cc345-174">Next steps</span></span>
- <span data-ttu-id="cc345-175">Para saber mais sobre como configurar os serviços, [Saiba mais sobre como configurar serviços](service-fabric-cluster-resource-manager-configure-services.md)</span><span class="sxs-lookup"><span data-stu-id="cc345-175">For more information on configuring services, [Learn about configuring Services](service-fabric-cluster-resource-manager-configure-services.md)</span></span>
- <span data-ttu-id="cc345-176">Para limitar os serviços a um pequeno conjunto de computadores ou agregar a carga dos serviços, use [Grupos de aplicativos](service-fabric-cluster-resource-manager-application-groups.md)</span><span class="sxs-lookup"><span data-stu-id="cc345-176">To limit services to a small set of machines or aggregating the load of services, use [Application Groups](service-fabric-cluster-resource-manager-application-groups.md)</span></span>

[Image1]:./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resrouce-manager-affinity-modes.png
[Image2]:./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resource-manager-chains-vs-stars.png