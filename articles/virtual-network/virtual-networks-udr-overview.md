---
title: "Rotas definidas pelo usuário e Encaminhamento IP no Azure | Microsoft Docs"
description: "Saiba como configurar UDR (Rotas definidas pelo usuário) e Encaminhamento de IP para encaminhar o tráfego para as soluções de virtualização da rede no Azure."
services: virtual-network
documentationcenter: na
author: jimdial
manager: timlt
editor: tysonn
ms.assetid: c39076c4-11b7-4b46-a904-817503c4b486
ms.service: virtual-network
ms.devlang: na
ms.topic: get-started-article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 03/15/2016
ms.author: jdial
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 6274e0101f6fb0864c8d1efaef7fcde78b8760c3
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="user-defined-routes-and-ip-forwarding"></a><span data-ttu-id="c73d9-103">Encaminhamento IP e rotas definidas pelo usuário</span><span class="sxs-lookup"><span data-stu-id="c73d9-103">User-defined routes and IP forwarding</span></span>

<span data-ttu-id="c73d9-104">Ao adicionar VMs (máquinas virtuais) a uma VNet (rede virtual) no Azure, você observará que as VMs podem se comunicar automaticamente com outras VMs na rede.</span><span class="sxs-lookup"><span data-stu-id="c73d9-104">When you add virtual machines (VMs) to a virtual network (VNet) in Azure, you will notice that the VMs are able to communicate with each other over the network, automatically.</span></span> <span data-ttu-id="c73d9-105">Não é necessário especificar um gateway, mesmo que as VMs estejam em sub-redes diferentes.</span><span class="sxs-lookup"><span data-stu-id="c73d9-105">You do not need to specify a gateway, even though the VMs are in different subnets.</span></span> <span data-ttu-id="c73d9-106">O mesmo vale para a comunicação entre as VMs para a Internet pública e até mesmo em suas instalações de rede quando houver uma conexão híbrida do Azure para o seu próprio datacenter.</span><span class="sxs-lookup"><span data-stu-id="c73d9-106">The same is true for communication from the VMs to the public Internet, and even to your on-premises network when a hybrid connection from Azure to your own datacenter is present.</span></span>

<span data-ttu-id="c73d9-107">Esse fluxo de comunicação é possível porque o Azure usa uma série de rotas do sistema para definir como o tráfego IP flui.</span><span class="sxs-lookup"><span data-stu-id="c73d9-107">This flow of communication is possible because Azure uses a series of system routes to define how IP traffic flows.</span></span> <span data-ttu-id="c73d9-108">As rotas de sistema controlam o fluxo de comunicação nos seguintes cenários:</span><span class="sxs-lookup"><span data-stu-id="c73d9-108">System routes control the flow of communication in the following scenarios:</span></span>

* <span data-ttu-id="c73d9-109">De dentro da mesma sub-rede.</span><span class="sxs-lookup"><span data-stu-id="c73d9-109">From within the same subnet.</span></span>
* <span data-ttu-id="c73d9-110">De uma sub-rede para outra em uma VNet.</span><span class="sxs-lookup"><span data-stu-id="c73d9-110">From a subnet to another within a VNet.</span></span>
* <span data-ttu-id="c73d9-111">De VMs com a Internet.</span><span class="sxs-lookup"><span data-stu-id="c73d9-111">From VMs to the Internet.</span></span>
* <span data-ttu-id="c73d9-112">De uma VNet para outra VNet por meio de um gateway VPN.</span><span class="sxs-lookup"><span data-stu-id="c73d9-112">From a VNet to another VNet through a VPN gateway.</span></span>
* <span data-ttu-id="c73d9-113">De uma rede virtual para outra rede virtual por meio de emparelhamento de rede virtual (encadeamento de serviço).</span><span class="sxs-lookup"><span data-stu-id="c73d9-113">From a VNet to another VNet through VNet Peering (Service Chaining).</span></span>
* <span data-ttu-id="c73d9-114">De uma VNet à sua rede local por meio de um gateway de VPN.</span><span class="sxs-lookup"><span data-stu-id="c73d9-114">From a VNet to your on-premises network through a VPN gateway.</span></span>

<span data-ttu-id="c73d9-115">A figura a seguir mostra uma configuração simples com uma VNet, duas sub-redes e algumas VMs, juntamente com as rotas do sistema que permitem o fluxo do tráfego IP.</span><span class="sxs-lookup"><span data-stu-id="c73d9-115">The figure below shows a simple setup with a VNet, two subnets, and a few VMs, along with the system routes that allow IP traffic to flow.</span></span>

![Rotas de sistema no Azure](./media/virtual-networks-udr-overview/Figure1.png)

<span data-ttu-id="c73d9-117">Embora o uso de rotas do sistema facilite o tráfego automaticamente para a sua implantação, há casos em que você deseja controlar o roteamento de pacotes por meio de um dispositivo virtual.</span><span class="sxs-lookup"><span data-stu-id="c73d9-117">Although the use of system routes facilitates traffic automatically for your deployment, there are cases in which you want to control the routing of packets through a virtual appliance.</span></span> <span data-ttu-id="c73d9-118">Você pode fazer isso criando rotas definidas pelo usuário que especificam o próximo salto para os pacotes que fluem para uma sub-rede específica indo, então, para o dispositivo virtual e habilitar o encaminhamento de IP para a VM em execução como o dispositivo virtual.</span><span class="sxs-lookup"><span data-stu-id="c73d9-118">You can do so by creating user defined routes that specify the next hop for packets flowing to a specific subnet to go to your virtual appliance instead, and enabling IP forwarding for the VM running as the virtual appliance.</span></span>

<span data-ttu-id="c73d9-119">A figura abaixo mostra um exemplo das rotas definidas pelo usuário e do encaminhamento IP para forçar os pacotes enviados para uma sub-rede de outra a passar por um dispositivo virtual em uma terceira sub-rede.</span><span class="sxs-lookup"><span data-stu-id="c73d9-119">The figure below shows an example of user defined routes and IP forwarding to force packets sent to one subnet from another to go through a virtual appliance on a third subnet.</span></span>

![Rotas de sistema no Azure](./media/virtual-networks-udr-overview/Figure2.png)

> [!IMPORTANT]
> <span data-ttu-id="c73d9-121">Rotas definidas pelo usuário são aplicadas ao tráfego que deixam uma sub-rede de qualquer recurso (como interfaces de rede conectadas às máquinas virtuais) na sub-rede.</span><span class="sxs-lookup"><span data-stu-id="c73d9-121">User-defined routes are applied to traffic leaving a subnet from any resource (such as network interfaces attached to VMs) in the subnet.</span></span> <span data-ttu-id="c73d9-122">Não é possível criar rotas para especificar como o tráfego entra em uma sub-rede a partir da Internet, por exemplo.</span><span class="sxs-lookup"><span data-stu-id="c73d9-122">You cannot create routes to specify how traffic enters a subnet from the Internet, for instance.</span></span> <span data-ttu-id="c73d9-123">O dispositivo para onde você está encaminhando o tráfego não pode estar na mesma sub-rede onde se origina o tráfego.</span><span class="sxs-lookup"><span data-stu-id="c73d9-123">The appliance you are forwarding traffic to cannot be in the same subnet where the traffic originates.</span></span> <span data-ttu-id="c73d9-124">Sempre crie uma sub-rede separada para seus dispositivos.</span><span class="sxs-lookup"><span data-stu-id="c73d9-124">Always create a separate subnet for your appliances.</span></span> 
> 
> 

## <a name="route-resource"></a><span data-ttu-id="c73d9-125">Recurso de rota</span><span class="sxs-lookup"><span data-stu-id="c73d9-125">Route resource</span></span>
<span data-ttu-id="c73d9-126">Os pacotes são roteados através de uma rede TCP/IP com base em uma tabela de rotas definida em cada nó na rede física.</span><span class="sxs-lookup"><span data-stu-id="c73d9-126">Packets are routed over a TCP/IP network based on a route table defined at each node on the physical network.</span></span> <span data-ttu-id="c73d9-127">Uma tabela de rotas é uma coleção de rotas individuais usadas para decidir para onde encaminhar pacotes com base no endereço IP de destino.</span><span class="sxs-lookup"><span data-stu-id="c73d9-127">A route table is a collection of individual routes used to decide where to forward packets based on the destination IP address.</span></span> <span data-ttu-id="c73d9-128">Uma rota consiste no seguinte:</span><span class="sxs-lookup"><span data-stu-id="c73d9-128">A route consists of the following:</span></span>

| <span data-ttu-id="c73d9-129">Propriedade</span><span class="sxs-lookup"><span data-stu-id="c73d9-129">Property</span></span> | <span data-ttu-id="c73d9-130">Descrição</span><span class="sxs-lookup"><span data-stu-id="c73d9-130">Description</span></span> | <span data-ttu-id="c73d9-131">Restrições</span><span class="sxs-lookup"><span data-stu-id="c73d9-131">Constraints</span></span> | <span data-ttu-id="c73d9-132">Considerações</span><span class="sxs-lookup"><span data-stu-id="c73d9-132">Considerations</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="c73d9-133">Prefixo de Endereço</span><span class="sxs-lookup"><span data-stu-id="c73d9-133">Address Prefix</span></span> |<span data-ttu-id="c73d9-134">O CIDR de destino ao qual a rota se aplica, como 10.1.0.0/16.</span><span class="sxs-lookup"><span data-stu-id="c73d9-134">The destination CIDR to which the route applies, such as 10.1.0.0/16.</span></span> |<span data-ttu-id="c73d9-135">Deve ser um intervalo CIDR válido que represente endereços na Internet pública, na rede virtual do Azure ou no datacenter local.</span><span class="sxs-lookup"><span data-stu-id="c73d9-135">Must be a valid CIDR range representing addresses on the public Internet, Azure virtual network, or on-premises datacenter.</span></span> |<span data-ttu-id="c73d9-136">Verifique se o **Prefixo do endereço** não contém o **Endereço do próximo salto**, caso contrário, seus pacotes entrarão em um loop, indo da origem para o próximo salto sem jamais chegar ao destino.</span><span class="sxs-lookup"><span data-stu-id="c73d9-136">Make sure the **Address prefix** does not contain the address for the **Next hop address**, otherwise your packets will enter in a loop going from the source to the next hop without ever reaching the destination.</span></span> |
| <span data-ttu-id="c73d9-137">Tipo do próximo salto</span><span class="sxs-lookup"><span data-stu-id="c73d9-137">Next hop type</span></span> |<span data-ttu-id="c73d9-138">O tipo de salto do Azure ao qual o pacote deve ser enviado.</span><span class="sxs-lookup"><span data-stu-id="c73d9-138">The type of Azure hop the packet should be sent to.</span></span> |<span data-ttu-id="c73d9-139">Deve ser um dos seguintes valores: </span><span class="sxs-lookup"><span data-stu-id="c73d9-139">Must be one of the following values:</span></span> <br/> <span data-ttu-id="c73d9-140">**Rede Virtual**.</span><span class="sxs-lookup"><span data-stu-id="c73d9-140">**Virtual Network**.</span></span> <span data-ttu-id="c73d9-141">Representa a rede virtual local.</span><span class="sxs-lookup"><span data-stu-id="c73d9-141">Represents the local virtual network.</span></span> <span data-ttu-id="c73d9-142">Por exemplo, se você tiver duas sub-redes, 10.1.0.0/16 e 10.2.0.0/16 na mesma rede virtual, a rota para cada sub-rede na tabela de rotas terá um valor do próximo salto da *Rede Virtual*.</span><span class="sxs-lookup"><span data-stu-id="c73d9-142">For instance, if you have two subnets, 10.1.0.0/16 and 10.2.0.0/16 in the same virtual network, the route for each subnet in the route table will have a next hop value of *Virtual Network*.</span></span> <br/> <span data-ttu-id="c73d9-143">**Gateway de Rede Virtual**.</span><span class="sxs-lookup"><span data-stu-id="c73d9-143">**Virtual Network Gateway**.</span></span> <span data-ttu-id="c73d9-144">Representa um Gateway de VPN S2S do Azure.</span><span class="sxs-lookup"><span data-stu-id="c73d9-144">Represents an Azure S2S VPN Gateway.</span></span> <br/> <span data-ttu-id="c73d9-145">**Internet**.</span><span class="sxs-lookup"><span data-stu-id="c73d9-145">**Internet**.</span></span> <span data-ttu-id="c73d9-146">Representa o gateway de Internet padrão fornecido pela Infraestrutura do Azure.</span><span class="sxs-lookup"><span data-stu-id="c73d9-146">Represents the default Internet gateway provided by the Azure Infrastructure.</span></span> <br/> <span data-ttu-id="c73d9-147">**Dispositivo Virtual**.</span><span class="sxs-lookup"><span data-stu-id="c73d9-147">**Virtual Appliance**.</span></span> <span data-ttu-id="c73d9-148">Representa um dispositivo virtual que você adicionou à sua rede virtual do Azure.</span><span class="sxs-lookup"><span data-stu-id="c73d9-148">Represents a virtual appliance you added to your Azure virtual network.</span></span> <br/> <span data-ttu-id="c73d9-149">**None**.</span><span class="sxs-lookup"><span data-stu-id="c73d9-149">**None**.</span></span> <span data-ttu-id="c73d9-150">Representa um buraco negro.</span><span class="sxs-lookup"><span data-stu-id="c73d9-150">Represents a black hole.</span></span> <span data-ttu-id="c73d9-151">Pacotes encaminhados a um buraco negro não serão encaminhados.</span><span class="sxs-lookup"><span data-stu-id="c73d9-151">Packets forwarded to a black hole will not be forwarded at all.</span></span> |<span data-ttu-id="c73d9-152">Considere o uso de uma **Solução de Virtualização** para direcionar o tráfego para uma VM ou para um endereço IP interno do Azure Load Balancer.</span><span class="sxs-lookup"><span data-stu-id="c73d9-152">Consider using **Virtual Appliance** to direct traffic to a VM or Azure Load Balancer internal IP address.</span></span>  <span data-ttu-id="c73d9-153">Esse tipo permite a especificação de um endereço IP, conforme descrito abaixo.</span><span class="sxs-lookup"><span data-stu-id="c73d9-153">This type allows the specification of an IP address as described below.</span></span> <span data-ttu-id="c73d9-154">Considere usar um tipo **None** para impedir que os pacotes sigam para um determinado destino.</span><span class="sxs-lookup"><span data-stu-id="c73d9-154">Consider using a **None** type to stop packets from flowing to a given destination.</span></span> |
| <span data-ttu-id="c73d9-155">Endereço do próximo salto</span><span class="sxs-lookup"><span data-stu-id="c73d9-155">Next hop address</span></span> |<span data-ttu-id="c73d9-156">O endereço do próximo salto contém o endereço IP para o qual os pacotes devem ser encaminhados.</span><span class="sxs-lookup"><span data-stu-id="c73d9-156">The next hop address contains the IP address packets should be forwarded to.</span></span> <span data-ttu-id="c73d9-157">Os valores de próximas salto são permitidos apenas em rotas em que o próximo salto é um *Dispositivo Virtual*.</span><span class="sxs-lookup"><span data-stu-id="c73d9-157">Next hop values are only allowed in routes where the next hop type is *Virtual Appliance*.</span></span> |<span data-ttu-id="c73d9-158">Deve ser um endereço IP acessível na Rede Virtual onde a Rota Definida pelo Usuário é aplicada, sem passar por um **Gateway de Rede Virtual**.</span><span class="sxs-lookup"><span data-stu-id="c73d9-158">Must be an IP address that is reachable within the Virtual Network where the User Defined Route is applied, without going through a **Virtual Network Gateway**.</span></span> <span data-ttu-id="c73d9-159">O endereço IP deve estar na mesma Rede Virtual onde ele é aplicado, ou em uma rede Virtual emparelhada.</span><span class="sxs-lookup"><span data-stu-id="c73d9-159">The IP address has to be on the same Virtual Network where it is applied, or on a peered Virtual Network.</span></span> |<span data-ttu-id="c73d9-160">Se o endereço IP representar uma VM, habilite o [encaminhamento IP](#IP-forwarding) no Azure para a VM.</span><span class="sxs-lookup"><span data-stu-id="c73d9-160">If the IP address represents a VM, make sure you enable [IP forwarding](#IP-forwarding) in Azure for the VM.</span></span> <span data-ttu-id="c73d9-161">Se o endereço IP representa o endereço IP interno do Azure Load Balancer, verifique se você tem uma regra de balanceamento de carga correspondente para cada porta que você deseja fazer o balanceamento de carga.</span><span class="sxs-lookup"><span data-stu-id="c73d9-161">If the IP address represents the internal IP address of Azure Load Balancer, make sure you have a matching load balancing rule for each port you wish to load balance.</span></span>|

<span data-ttu-id="c73d9-162">No Azure PowerShell, alguns dos valores "NextHopType" têm nomes diferentes:</span><span class="sxs-lookup"><span data-stu-id="c73d9-162">In Azure PowerShell some of the "NextHopType" values have different names:</span></span>

* <span data-ttu-id="c73d9-163">A Rede Virtual é VnetLocal</span><span class="sxs-lookup"><span data-stu-id="c73d9-163">Virtual Network is VnetLocal</span></span>
* <span data-ttu-id="c73d9-164">O Gateway de Rede Virtual é VirtualNetworkGateway</span><span class="sxs-lookup"><span data-stu-id="c73d9-164">Virtual Network Gateway is VirtualNetworkGateway</span></span>
* <span data-ttu-id="c73d9-165">O Dispositivo Virtual é VirtualAppliance</span><span class="sxs-lookup"><span data-stu-id="c73d9-165">Virtual Appliance is VirtualAppliance</span></span>
* <span data-ttu-id="c73d9-166">A Internet é Internet</span><span class="sxs-lookup"><span data-stu-id="c73d9-166">Internet is Internet</span></span>
* <span data-ttu-id="c73d9-167">Nenhum é None</span><span class="sxs-lookup"><span data-stu-id="c73d9-167">None is None</span></span>

### <a name="system-routes"></a><span data-ttu-id="c73d9-168">Rotas do sistema</span><span class="sxs-lookup"><span data-stu-id="c73d9-168">System routes</span></span>
<span data-ttu-id="c73d9-169">Cada sub-rede criada em uma rede virtual é associada automaticamente a uma tabela de rota que contém as seguintes regras de rota do sistema:</span><span class="sxs-lookup"><span data-stu-id="c73d9-169">Every subnet created in a virtual network is automatically associated with a route table that contains the following system route rules:</span></span>

* <span data-ttu-id="c73d9-170">**Regra de VNet local**: essa regra é criada automaticamente para todas as sub-redes em uma rede virtual.</span><span class="sxs-lookup"><span data-stu-id="c73d9-170">**Local Vnet Rule**: This rule is automatically created for every subnet in a virtual network.</span></span> <span data-ttu-id="c73d9-171">Ela especifica que há um link direto entre as VMs na VNet e não há nenhum próximo salto intermediário.</span><span class="sxs-lookup"><span data-stu-id="c73d9-171">It specifies that there is a direct link between the VMs in the VNet and there is no intermediate next hop.</span></span>
* <span data-ttu-id="c73d9-172">**Regra local**: essa regra se aplica a todo o tráfego destinado ao intervalo de endereços locais e usa o gateway de VPN como o destino do próximo salto.</span><span class="sxs-lookup"><span data-stu-id="c73d9-172">**On-premises Rule**: This rule applies to all traffic destined to the on-premises address range and uses VPN gateway as the next hop destination.</span></span>
* <span data-ttu-id="c73d9-173">**Regra de Internet**: essa regra manipula todo o tráfego destinado à Internet pública (prefixo de endereço 0.0.0.0/0) e usa o gateway de Internet de infraestrutura como o próximo salto para todo o tráfego destinado à Internet.</span><span class="sxs-lookup"><span data-stu-id="c73d9-173">**Internet Rule**: This rule handles all traffic destined to the public Internet (address prefix 0.0.0.0/0) and uses the infrastructure internet gateway as the next hop for all traffic destined to the Internet.</span></span>

### <a name="user-defined-routes"></a><span data-ttu-id="c73d9-174">Rotas definidas pelo usuário</span><span class="sxs-lookup"><span data-stu-id="c73d9-174">User-defined routes</span></span>
<span data-ttu-id="c73d9-175">Para a maioria dos ambientes, serão necessárias apenas as rotas de sistema já definidas pelo Azure.</span><span class="sxs-lookup"><span data-stu-id="c73d9-175">For most environments you will only need the system routes already defined by Azure.</span></span> <span data-ttu-id="c73d9-176">No entanto, talvez seja necessário criar uma tabela de rotas e adicionar uma ou mais rotas em casos específicos, como:</span><span class="sxs-lookup"><span data-stu-id="c73d9-176">However, you may need to create a route table and add one or more routes in specific cases, such as:</span></span>

* <span data-ttu-id="c73d9-177">Túnel à força para a Internet através de sua rede local.</span><span class="sxs-lookup"><span data-stu-id="c73d9-177">Force tunneling to the Internet via your on-premises network.</span></span>
* <span data-ttu-id="c73d9-178">Uso de dispositivos virtuais em seu ambiente do Azure.</span><span class="sxs-lookup"><span data-stu-id="c73d9-178">Use of virtual appliances in your Azure environment.</span></span>

<span data-ttu-id="c73d9-179">Nos cenários acima, você precisará criar uma tabela de rotas e adicionar rotas definidas pelo usuário a ela.</span><span class="sxs-lookup"><span data-stu-id="c73d9-179">In the scenarios above, you will have to create a route table and add user defined routes to it.</span></span> <span data-ttu-id="c73d9-180">Você pode ter várias tabelas de rotas, e a mesma tabela de rotas pode ser associada a uma ou mais sub-redes.</span><span class="sxs-lookup"><span data-stu-id="c73d9-180">You can have multiple route tables, and the same route table can be associated to one or more subnets.</span></span> <span data-ttu-id="c73d9-181">Cada sub-rede só pode ser associada a uma única tabela de rotas.</span><span class="sxs-lookup"><span data-stu-id="c73d9-181">And each subnet can only be associated to a single route table.</span></span> <span data-ttu-id="c73d9-182">Todas as VMs e serviços em nuvem em uma sub-rede usam a tabela de rotas associada a essa sub-rede.</span><span class="sxs-lookup"><span data-stu-id="c73d9-182">All VMs and cloud services in a subnet use the route table associated to that subnet.</span></span>

<span data-ttu-id="c73d9-183">As sub-redes contam com rotas de sistema até que uma tabela de rotas seja associada à sub-rede.</span><span class="sxs-lookup"><span data-stu-id="c73d9-183">Subnets rely on system routes until a route table is associated to the subnet.</span></span> <span data-ttu-id="c73d9-184">Quando existe uma associação, o roteamento é feito com base em LPM (Correspondência de Prefixo mais Longo) entre as rotas definidas pelo usuário e as rotas de sistema.</span><span class="sxs-lookup"><span data-stu-id="c73d9-184">Once an association exists, routing is done based on Longest Prefix Match (LPM) among both user defined routes and system routes.</span></span> <span data-ttu-id="c73d9-185">Se houver mais de uma rota com a mesma correspondência LPM, uma rota será selecionada com base em sua origem na seguinte ordem:</span><span class="sxs-lookup"><span data-stu-id="c73d9-185">If there is more than one route with the same LPM match then a route is selected based on its origin in the following order:</span></span>

1. <span data-ttu-id="c73d9-186">Rota definida pelo usuário</span><span class="sxs-lookup"><span data-stu-id="c73d9-186">User defined route</span></span>
2. <span data-ttu-id="c73d9-187">Rota BGP (quando o ExpressRoute é usado)</span><span class="sxs-lookup"><span data-stu-id="c73d9-187">BGP route (when ExpressRoute is used)</span></span>
3. <span data-ttu-id="c73d9-188">Rota de sistema</span><span class="sxs-lookup"><span data-stu-id="c73d9-188">System route</span></span>

<span data-ttu-id="c73d9-189">Para saber como criar rotas definidas pelo usuário, veja [Como criar rotas e habilitar o encaminhamento IP no Azure](virtual-network-create-udr-arm-template.md).</span><span class="sxs-lookup"><span data-stu-id="c73d9-189">To learn how to create user defined routes, see [How to Create Routes and Enable IP Forwarding in Azure](virtual-network-create-udr-arm-template.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="c73d9-190">As rotas definidas pelo usuário são aplicadas apenas a VMs do Azure e a serviços de nuvem.</span><span class="sxs-lookup"><span data-stu-id="c73d9-190">User defined routes are only applied to Azure VMs and cloud services.</span></span> <span data-ttu-id="c73d9-191">Por exemplo, se desejar adicionar um dispositivo virtual de firewall entre sua rede local e o Azure, você terá que criar uma rota definida pelo usuário para as tabelas de rotas do Azure que encaminham todo o tráfego direcionado ao espaço de endereço local para o dispositivo virtual.</span><span class="sxs-lookup"><span data-stu-id="c73d9-191">For instance, if you want to add a firewall virtual appliance between your on-premises network and Azure, you will have to create a user defined route for your Azure route tables that forwards all traffic going to the on-premises address space to the virtual appliance.</span></span> <span data-ttu-id="c73d9-192">Você também pode adicionar uma UDR (rota definida pelo usuário) ao GatewaySubnet para encaminhar todo o tráfego do local para o Azure por meio do dispositivo virtual.</span><span class="sxs-lookup"><span data-stu-id="c73d9-192">You can also add a user defined route (UDR) to the GatewaySubnet to forward all traffic from on-premises to Azure through the virtual appliance.</span></span> <span data-ttu-id="c73d9-193">Isso é uma adição recente.</span><span class="sxs-lookup"><span data-stu-id="c73d9-193">This is a recent addition.</span></span>
> 
> 

### <a name="bgp-routes"></a><span data-ttu-id="c73d9-194">Rotas BGP</span><span class="sxs-lookup"><span data-stu-id="c73d9-194">BGP routes</span></span>
<span data-ttu-id="c73d9-195">Se houver uma conexão ExpressRoute entre sua rede local e o Azure, você poderá habilitar o BGP para propagar rotas da rede local para o Azure.</span><span class="sxs-lookup"><span data-stu-id="c73d9-195">If you have an ExpressRoute connection between your on-premises network and Azure, you can enable BGP to propagate routes from your on-premises network to Azure.</span></span> <span data-ttu-id="c73d9-196">Essas rotas BGP são usadas da mesma maneira que as rotas do sistema e as rotas definidas pelo usuário em cada sub-rede do Azure.</span><span class="sxs-lookup"><span data-stu-id="c73d9-196">These BGP routes are used in the same way as system routes and user defined routes in each Azure subnet.</span></span> <span data-ttu-id="c73d9-197">Para obter mais informações, consulte [Introdução ao ExpressRoute](../expressroute/expressroute-introduction.md).</span><span class="sxs-lookup"><span data-stu-id="c73d9-197">For more information see [ExpressRoute Introduction](../expressroute/expressroute-introduction.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="c73d9-198">Você pode configurar seu ambiente do Azure para usar um túnel à força por meio de sua rede local, criando uma rota definida pelo usuário para a sub-rede 0.0.0.0/0 que usa o gateway de VPN como o próximo salto.</span><span class="sxs-lookup"><span data-stu-id="c73d9-198">You can configure your Azure environment to use force tunneling through your on-premises network by creating a user defined route for subnet 0.0.0.0/0 that uses the VPN gateway as the next hop.</span></span> <span data-ttu-id="c73d9-199">No entanto, isso só funcionará se você estiver usando um gateway de VPN, não o ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="c73d9-199">However, this only works if you are using a VPN gateway, not ExpressRoute.</span></span> <span data-ttu-id="c73d9-200">Para o ExpressRoute, o túnel à força é configurado por meio do BGP.</span><span class="sxs-lookup"><span data-stu-id="c73d9-200">For ExpressRoute, forced tunneling is configured through BGP.</span></span>
> 
> 

## <a name="ip-forwarding"></a><span data-ttu-id="c73d9-201">Encaminhamento IP</span><span class="sxs-lookup"><span data-stu-id="c73d9-201">IP forwarding</span></span>
<span data-ttu-id="c73d9-202">Conforme descrito acima, uma das principais razões para criar uma rota definida pelo usuário é encaminhar o tráfego para um dispositivo virtual.</span><span class="sxs-lookup"><span data-stu-id="c73d9-202">As described above, one of the main reasons to create a user defined route is to forward traffic to a virtual appliance.</span></span> <span data-ttu-id="c73d9-203">Um dispositivo virtual é nada mais do que uma VM que executa um aplicativo usado para lidar com o tráfego de rede de alguma forma, como um firewall ou um dispositivo NAT.</span><span class="sxs-lookup"><span data-stu-id="c73d9-203">A virtual appliance is nothing more than a VM that runs an application used to handle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="c73d9-204">Essa VM de dispositivo virtual deve ser capaz de receber o tráfego de entrada não endereçado a si mesma.</span><span class="sxs-lookup"><span data-stu-id="c73d9-204">This virtual appliance VM must be able to receive incoming traffic that is not addressed to itself.</span></span> <span data-ttu-id="c73d9-205">Para permitir que uma VM receba o tráfego endereçado a outros destinos, você deve habilitar o Encaminhamento IP para a VM.</span><span class="sxs-lookup"><span data-stu-id="c73d9-205">To allow a VM to receive traffic addressed to other destinations, you must enable IP Forwarding for the VM.</span></span> <span data-ttu-id="c73d9-206">Esta é uma configuração do Azure, não uma configuração no sistema operacional convidado.</span><span class="sxs-lookup"><span data-stu-id="c73d9-206">This is an Azure setting, not a setting in the guest operating system.</span></span>

## <a name="next-steps"></a><span data-ttu-id="c73d9-207">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="c73d9-207">Next steps</span></span>
* <span data-ttu-id="c73d9-208">Saiba como [criar rotas no modelo de implantação do Gerenciador de Recursos](virtual-network-create-udr-arm-template.md) e associá-las a sub-redes.</span><span class="sxs-lookup"><span data-stu-id="c73d9-208">Learn how to [create routes in the Resource Manager deployment model](virtual-network-create-udr-arm-template.md) and associate them to subnets.</span></span> 
* <span data-ttu-id="c73d9-209">Saiba como [criar rotas no modelo de implantação clássico](virtual-network-create-udr-classic-ps.md) e associá-las a sub-redes.</span><span class="sxs-lookup"><span data-stu-id="c73d9-209">Learn how to [create routes in the classic deployment model](virtual-network-create-udr-classic-ps.md) and associate them to subnets.</span></span>

