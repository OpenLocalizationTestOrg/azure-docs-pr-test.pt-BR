---
title: "aaaHybrid conexão com o aplicativo da camada 2 | Microsoft Docs"
description: "Saiba como toodeploy dispositivos virtuais e UDR toocreate um ambiente de aplicativo de várias camadas no Azure"
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: tysonn
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: jdial
ms.openlocfilehash: 53599862289dbf9c6ab3289b0cb8dda6430f20f7
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/06/2017
---
# <a name="virtual-appliance-scenario"></a><span data-ttu-id="89fc4-103">Cenário de dispositivo virtual</span><span class="sxs-lookup"><span data-stu-id="89fc4-103">Virtual appliance scenario</span></span>
<span data-ttu-id="89fc4-104">Um cenário comum entre o cliente do Azure maior é Olá necessidade tooprovide toohello um aplicativo de duas camadas exposto à Internet, permitindo a camada de voltar de toohello acesso de um datacenter local.</span><span class="sxs-lookup"><span data-stu-id="89fc4-104">A common scenario among larger Azure customer is hello need tooprovide a two-tiered application exposed toohello Internet, while allowing access toohello back tier from an on-premises datacenter.</span></span> <span data-ttu-id="89fc4-105">Este documento orientará você por meio de um cenário usando toodeploy de soluções de virtualização de rede, um Gateway de VPN e rotas de definida pelo usuário (UDR) um ambiente de duas camadas que atenda Olá requisitos a seguir:</span><span class="sxs-lookup"><span data-stu-id="89fc4-105">This document will walk you through a scenario using User Defined Routes (UDR), a VPN Gateway, and network virtual appliances toodeploy a two-tier environment that meets hello following requirements:</span></span>

* <span data-ttu-id="89fc4-106">Aplicativo Web deve ser acessível de Olá somente Internet pública.</span><span class="sxs-lookup"><span data-stu-id="89fc4-106">Web application must be accessible from hello public Internet only.</span></span>
* <span data-ttu-id="89fc4-107">Aplicativo hello hospedagem do servidor Web deve ser capaz de tooaccess um servidor de aplicativos back-end.</span><span class="sxs-lookup"><span data-stu-id="89fc4-107">Web server hosting hello application must be able tooaccess a backend application server.</span></span>
* <span data-ttu-id="89fc4-108">Todo o tráfego de saudação aplicativo da web toohello Internet deve passar por um dispositivo virtual do firewall.</span><span class="sxs-lookup"><span data-stu-id="89fc4-108">All traffic from hello Internet toohello web application must go through a firewall virtual appliance.</span></span> <span data-ttu-id="89fc4-109">Este dispositivo virtual será usado apenas para o tráfego de Internet.</span><span class="sxs-lookup"><span data-stu-id="89fc4-109">This virtual appliance will be used for Internet traffic only.</span></span>
* <span data-ttu-id="89fc4-110">Todo o tráfego direcionado toohello servidor de aplicativos deve passar por um dispositivo virtual do firewall.</span><span class="sxs-lookup"><span data-stu-id="89fc4-110">All traffic going toohello application server must go through a firewall virtual appliance.</span></span> <span data-ttu-id="89fc4-111">Este dispositivo virtual será usado para o servidor final do acesso toohello back-end e vindos de rede do local de saudação por meio de um Gateway de VPN de acesso.</span><span class="sxs-lookup"><span data-stu-id="89fc4-111">This virtual appliance will be used for access toohello backend end server, and access coming in from hello on-premises network via a VPN Gateway.</span></span>
* <span data-ttu-id="89fc4-112">Os administradores devem ser capaz de toomanage Olá firewall soluções de virtualização de seus computadores locais, por meio de um terceiro firewall usado exclusivamente para fins de gerenciamento de dispositivo virtual.</span><span class="sxs-lookup"><span data-stu-id="89fc4-112">Administrators must be able toomanage hello firewall virtual appliances from their on-premises computers, by using a third firewall virtual appliance used exclusively for management purposes.</span></span>

<span data-ttu-id="89fc4-113">Esse é um cenário de DMZ padrão com um DMZ e uma rede protegida.</span><span class="sxs-lookup"><span data-stu-id="89fc4-113">This is a standard DMZ scenario with a DMZ and a protected network.</span></span> <span data-ttu-id="89fc4-114">Esse cenário pode ser criado no Azure usando NSGs, dispositivos virtuais de firewall ou uma combinação de ambos.</span><span class="sxs-lookup"><span data-stu-id="89fc4-114">Such scenario can be constructed in Azure by using NSGs, firewall virtual appliances, or a combination of both.</span></span> <span data-ttu-id="89fc4-115">Olá tabela a seguir mostra alguns dos profissionais hello e os contras entre NSGs e dispositivos virtuais do firewall.</span><span class="sxs-lookup"><span data-stu-id="89fc4-115">hello table below shows some of hello pros and cons between NSGs and firewall virtual appliances.</span></span>

|  | <span data-ttu-id="89fc4-116">Prós</span><span class="sxs-lookup"><span data-stu-id="89fc4-116">Pros</span></span> | <span data-ttu-id="89fc4-117">Contras</span><span class="sxs-lookup"><span data-stu-id="89fc4-117">Cons</span></span> |
| --- | --- | --- |
| <span data-ttu-id="89fc4-118">NSG</span><span class="sxs-lookup"><span data-stu-id="89fc4-118">NSG</span></span> |<span data-ttu-id="89fc4-119">Sem custo.</span><span class="sxs-lookup"><span data-stu-id="89fc4-119">No cost.</span></span> <br/><span data-ttu-id="89fc4-120">Integrado ao RBAC do Azure.</span><span class="sxs-lookup"><span data-stu-id="89fc4-120">Integrated into Azure RBAC.</span></span> <br/><span data-ttu-id="89fc4-121">As regras podem ser criadas em modelos Aa ARM.</span><span class="sxs-lookup"><span data-stu-id="89fc4-121">Rules can be created in ARM templates.</span></span> |<span data-ttu-id="89fc4-122">A complexidade pode variar em ambientes maiores.</span><span class="sxs-lookup"><span data-stu-id="89fc4-122">Complexity could vary in larger environments.</span></span> |
| <span data-ttu-id="89fc4-123">Firewall</span><span class="sxs-lookup"><span data-stu-id="89fc4-123">Firewall</span></span> |<span data-ttu-id="89fc4-124">Controle total sobre o plano de dados.</span><span class="sxs-lookup"><span data-stu-id="89fc4-124">Full control over data plane.</span></span> <br/><span data-ttu-id="89fc4-125">Gerenciamento central por meio do console do firewall.</span><span class="sxs-lookup"><span data-stu-id="89fc4-125">Central management through firewall console.</span></span> |<span data-ttu-id="89fc4-126">Custo do dispositivo de firewall.</span><span class="sxs-lookup"><span data-stu-id="89fc4-126">Cost of firewall appliance.</span></span> <br/><span data-ttu-id="89fc4-127">Não é integrado ao RBAC do Azure.</span><span class="sxs-lookup"><span data-stu-id="89fc4-127">Not integrated with Azure RBAC.</span></span> |

<span data-ttu-id="89fc4-128">solução de saudação abaixo usa o firewall dispositivos virtuais tooimplement um cenário de rede DMZ/protegido.</span><span class="sxs-lookup"><span data-stu-id="89fc4-128">hello solution below uses firewall virtual appliances tooimplement a DMZ/protected network scenario.</span></span>

## <a name="considerations"></a><span data-ttu-id="89fc4-129">Considerações</span><span class="sxs-lookup"><span data-stu-id="89fc4-129">Considerations</span></span>
<span data-ttu-id="89fc4-130">Você pode implantar o ambiente Olá explicado acima no Azure usando os diferentes recursos disponíveis hoje, da seguinte maneira.</span><span class="sxs-lookup"><span data-stu-id="89fc4-130">You can deploy hello environment explained above in Azure using different features available today, as follows.</span></span>

* <span data-ttu-id="89fc4-131">**Rede virtual (VNet)**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-131">**Virtual network (VNet)**.</span></span> <span data-ttu-id="89fc4-132">Uma rede virtual do Azure atua na rede de local de tooan de maneira semelhante e podem ser segmentada em um ou mais isolamento de tráfego tooprovide sub-redes e separação de preocupações.</span><span class="sxs-lookup"><span data-stu-id="89fc4-132">An Azure VNet acts in similar fashion tooan on-premises network, and can be segmented into one or more subnets tooprovide traffic isolation, and separation of concerns.</span></span>
* <span data-ttu-id="89fc4-133">**Dispositivo virtual**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-133">**Virtual appliance**.</span></span> <span data-ttu-id="89fc4-134">Vários parceiros fornecem soluções de virtualização em hello Azure Marketplace que pode ser usado para Olá três firewalls descritos acima.</span><span class="sxs-lookup"><span data-stu-id="89fc4-134">Several partners provide virtual appliances in hello Azure Marketplace that can be used for hello three firewalls described above.</span></span> 
* <span data-ttu-id="89fc4-135">**UDR (Rotas Definidas pelo Usuário)**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-135">**User Defined Routes (UDR)**.</span></span> <span data-ttu-id="89fc4-136">Tabelas de rotas podem conter UDRs usadas por fluxo de saudação toocontrol rede Azure de pacotes em uma rede virtual.</span><span class="sxs-lookup"><span data-stu-id="89fc4-136">Route tables can contain UDRs used by Azure networking toocontrol hello flow of packets within a VNet.</span></span> <span data-ttu-id="89fc4-137">Essas tabelas de rota podem ser aplicadas toosubnets.</span><span class="sxs-lookup"><span data-stu-id="89fc4-137">These route tables can be applied toosubnets.</span></span> <span data-ttu-id="89fc4-138">Um dos recursos mais recentes de saudação no Azure é Olá capacidade tooapply uma tabela de rota toohello GatewaySubnet, fornecendo Olá capacidade tooforward todo o tráfego entra Olá VNet do Azure de uma solução de virtualização de tooa de conexão híbrida.</span><span class="sxs-lookup"><span data-stu-id="89fc4-138">One of hello newest features in Azure is hello ability tooapply a route table toohello GatewaySubnet, providing hello ability tooforward all traffic coming into hello Azure VNet from a hybrid connection tooa virtual appliance.</span></span>
* <span data-ttu-id="89fc4-139">**Encaminhamento IP**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-139">**IP Forwarding**.</span></span> <span data-ttu-id="89fc4-140">Por padrão, o hello Azure mecanismo rede encaminhar pacotes toovirtual placas de interface de rede (NICs) somente se o endereço IP de destino do pacote hello corresponde Olá endereço IP da NIC.</span><span class="sxs-lookup"><span data-stu-id="89fc4-140">By default, hello Azure networking engine forward packets toovirtual network interface cards (NICs) only if hello packet destination IP address matches hello NIC IP address.</span></span> <span data-ttu-id="89fc4-141">Portanto, se um UDR define se um pacote deve ser enviado tooa dado dispositivo virtual, Olá mecanismo de rede do Azure deve cancelar esse pacote.</span><span class="sxs-lookup"><span data-stu-id="89fc4-141">Therefore, if a UDR defines that a packet must be sent tooa given virtual appliance, hello Azure networking engine would drop that packet.</span></span> <span data-ttu-id="89fc4-142">pacote de saudação tooensure é entregue tooa VM (no caso um dispositivo virtual) que não é um destino de saudação real para o pacote de saudação, você precisa tooenable encaminhamento IP para o dispositivo virtual Olá.</span><span class="sxs-lookup"><span data-stu-id="89fc4-142">tooensure hello packet is delivered tooa VM (in this case a virtual appliance) that is not hello actual destination for hello packet, you need tooenable IP Forwarding for hello virtual appliance.</span></span>
* <span data-ttu-id="89fc4-143">**NSGs (Grupos de Segurança de Rede)**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-143">**Network Security Groups (NSGs)**.</span></span> <span data-ttu-id="89fc4-144">exemplo Hello abaixo não faz uso de NSGs, mas você pode usar os NSGs aplicados toohello sub-redes e/ou NICs nessa solução toofurther filtro Olá tráfego entra e sai os NICs e sub-redes.</span><span class="sxs-lookup"><span data-stu-id="89fc4-144">hello example below does not make use of NSGs, but you could use NSGs applied toohello subnets and/or NICs in this solution toofurther filter hello traffic in and out of those subnets and NICs.</span></span>

![Conectividade IPv6](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

<span data-ttu-id="89fc4-146">Neste exemplo, há uma assinatura que contém Olá seguinte:</span><span class="sxs-lookup"><span data-stu-id="89fc4-146">In this example there is a subscription that contains hello following:</span></span>

* <span data-ttu-id="89fc4-147">2 grupos de recursos, não é mostrados no diagrama de saudação.</span><span class="sxs-lookup"><span data-stu-id="89fc4-147">2 resource groups, not shown in hello diagram.</span></span> 
  * <span data-ttu-id="89fc4-148">**ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-148">**ONPREMRG**.</span></span> <span data-ttu-id="89fc4-149">Contém todos os recursos toosimulate necessário uma rede local.</span><span class="sxs-lookup"><span data-stu-id="89fc4-149">Contains all resources necessary toosimulate an on-premises network.</span></span>
  * <span data-ttu-id="89fc4-150">**AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-150">**AZURERG**.</span></span> <span data-ttu-id="89fc4-151">Contém todos os recursos necessários para o ambiente de rede virtual do Azure hello.</span><span class="sxs-lookup"><span data-stu-id="89fc4-151">Contains all resources necessary for hello Azure virtual network environment.</span></span> 
* <span data-ttu-id="89fc4-152">Uma rede virtual denominada **onpremvnet** usado toomimic um datacenter local segmentado como listado abaixo.</span><span class="sxs-lookup"><span data-stu-id="89fc4-152">A VNet named **onpremvnet** used toomimic an on-premises datacenter segmented as listed below.</span></span>
  * <span data-ttu-id="89fc4-153">**onpremsn1**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-153">**onpremsn1**.</span></span> <span data-ttu-id="89fc4-154">Sub-rede que contém uma máquina virtual (VM) que executa o Ubuntu toomimic um servidor de local.</span><span class="sxs-lookup"><span data-stu-id="89fc4-154">Subnet containing a virtual machine (VM) running Ubuntu toomimic an on-premises server.</span></span>
  * <span data-ttu-id="89fc4-155">**onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-155">**onpremsn2**.</span></span> <span data-ttu-id="89fc4-156">Sub-rede que contém uma VM em execução Ubuntu toomimic um computador local usado por um administrador.</span><span class="sxs-lookup"><span data-stu-id="89fc4-156">Subnet containing a VM running Ubuntu toomimic an on-premises computer used by an administrator.</span></span>
* <span data-ttu-id="89fc4-157">Há um dispositivo virtual de firewall denominado **OPFW** na **onpremvnet** usado toomaintain um túnel muito**azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-157">There is one firewall virtual appliance named **OPFW** on **onpremvnet** used toomaintain a tunnel too**azurevnet**.</span></span>
* <span data-ttu-id="89fc4-158">Uma VNet denominada **azurevnet** segmentada como listado abaixo.</span><span class="sxs-lookup"><span data-stu-id="89fc4-158">A VNet named **azurevnet** segmented as listed below.</span></span>
  * <span data-ttu-id="89fc4-159">**azsn1**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-159">**azsn1**.</span></span> <span data-ttu-id="89fc4-160">Subrede firewall externo usado exclusivamente para firewall externo hello.</span><span class="sxs-lookup"><span data-stu-id="89fc4-160">External firewall subnet used exclusively for hello external firewall.</span></span> <span data-ttu-id="89fc4-161">Todo o tráfego da Internet será proveniente desta sub-rede.</span><span class="sxs-lookup"><span data-stu-id="89fc4-161">All Internet traffic will come in through this subnet.</span></span> <span data-ttu-id="89fc4-162">Essa sub-rede contém apenas um firewall externo de toohello NIC vinculado.</span><span class="sxs-lookup"><span data-stu-id="89fc4-162">This subnet only contains a NIC linked toohello external firewall.</span></span>
  * <span data-ttu-id="89fc4-163">**azsn2**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-163">**azsn2**.</span></span> <span data-ttu-id="89fc4-164">Subrede front-end hospeda uma VM em execução como um servidor web que será acessado de saudação à Internet.</span><span class="sxs-lookup"><span data-stu-id="89fc4-164">Front end subnet hosting a VM running as a web server that will be accessed from hello Internet.</span></span>
  * <span data-ttu-id="89fc4-165">**azsn3**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-165">**azsn3**.</span></span> <span data-ttu-id="89fc4-166">Sub-rede de back-end que hospeda uma VM que executa um servidor de aplicativos back-end que será acessado pelo servidor de web de front-end de saudação.</span><span class="sxs-lookup"><span data-stu-id="89fc4-166">Backend subnet hosting a VM running a backend application server that will be accessed by hello front end web server.</span></span>
  * <span data-ttu-id="89fc4-167">**azsn4**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-167">**azsn4**.</span></span> <span data-ttu-id="89fc4-168">A sub-rede de gerenciamento usada exclusivamente tooprovide gerenciamento acesso tooall firewall dispositivos virtuais.</span><span class="sxs-lookup"><span data-stu-id="89fc4-168">Management subnet used exclusively tooprovide management access tooall firewall virtual appliances.</span></span> <span data-ttu-id="89fc4-169">Essa sub-rede contém apenas uma NIC para cada dispositivo virtual firewall usado na solução de saudação.</span><span class="sxs-lookup"><span data-stu-id="89fc4-169">This subnet only contains a NIC for each firewall virtual appliance used in hello solution.</span></span>
  * <span data-ttu-id="89fc4-170">**GatewaySubnet**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-170">**GatewaySubnet**.</span></span> <span data-ttu-id="89fc4-171">Sub-rede de conexão híbrida do Azure necessário para Gateway de VPN e rota expressa conectividade tooprovide entre VNets do Azure e outras redes.</span><span class="sxs-lookup"><span data-stu-id="89fc4-171">Azure hybrid connection subnet required for ExpressRoute and VPN Gateway tooprovide connectivity between Azure VNets and other networks.</span></span> 
* <span data-ttu-id="89fc4-172">Há 3 dispositivos virtuais do firewall em Olá **azurevnet** rede.</span><span class="sxs-lookup"><span data-stu-id="89fc4-172">There are 3 firewall virtual appliances in hello **azurevnet** network.</span></span> 
  * <span data-ttu-id="89fc4-173">**AZF1**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-173">**AZF1**.</span></span> <span data-ttu-id="89fc4-174">Firewall externo exposto toohello Internet pública usando um recurso de endereço IP público no Azure.</span><span class="sxs-lookup"><span data-stu-id="89fc4-174">External firewall exposed toohello public Internet by using a public IP address resource in Azure.</span></span> <span data-ttu-id="89fc4-175">É necessário tooensure possui um modelo de saudação Marketplace ou diretamente de seu fornecedor de dispositivo, que provisiona um dispositivo virtual 3-NIC.</span><span class="sxs-lookup"><span data-stu-id="89fc4-175">You need tooensure you have a template from hello Marketplace, or directly from your appliance vendor, that provisions a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="89fc4-176">**AZF2**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-176">**AZF2**.</span></span> <span data-ttu-id="89fc4-177">Firewall interno usado toocontrol o tráfego entre **azsn2** e **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-177">Internal firewall used toocontrol traffic between **azsn2** and **azsn3**.</span></span> <span data-ttu-id="89fc4-178">Isso também é um dispositivo virtual de 3 NICs.</span><span class="sxs-lookup"><span data-stu-id="89fc4-178">This is also a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="89fc4-179">**AZF3**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-179">**AZF3**.</span></span> <span data-ttu-id="89fc4-180">Firewall de gerenciamento tooadministrators acessível de saudação datacenter local e sub-rede de gerenciamento conectado tooa usado toomanage todos os dispositivos de firewall.</span><span class="sxs-lookup"><span data-stu-id="89fc4-180">Management firewall accessible tooadministrators from hello on-premises datacenter, and connected tooa management subnet used toomanage all firewall appliances.</span></span> <span data-ttu-id="89fc4-181">Você pode encontrar NIC 2 modelos de dispositivo virtual em Olá Marketplace ou solicitar uma diretamente de seu fornecedor de dispositivo.</span><span class="sxs-lookup"><span data-stu-id="89fc4-181">You can find 2-NIC virtual appliance templates in hello Marketplace, or request one directly from your appliance vendor.</span></span>

## <a name="user-defined-routing-udr"></a><span data-ttu-id="89fc4-182">Roteamento definido pelo usuário (UDR)</span><span class="sxs-lookup"><span data-stu-id="89fc4-182">User Defined Routing (UDR)</span></span>
<span data-ttu-id="89fc4-183">Cada sub-rede no Azure pode ser vinculado tooa UDR tabela usada toodefine como tráfego iniciado nessa sub-rede é roteado.</span><span class="sxs-lookup"><span data-stu-id="89fc4-183">Each subnet in Azure can be linked tooa UDR table used toodefine how traffic initiated in that subnet is routed.</span></span> <span data-ttu-id="89fc4-184">Se nenhum UDRs estiverem definidas, o Azure usa padrão rotas tooallow tráfego tooflow de tooanother de uma sub-rede.</span><span class="sxs-lookup"><span data-stu-id="89fc4-184">If no UDRs are defined, Azure uses default routes tooallow traffic tooflow from one subnet tooanother.</span></span> <span data-ttu-id="89fc4-185">toobetter entender UDRs, visite [quais são rotas definidas pelo usuário e encaminhamento IP](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="89fc4-185">toobetter understand UDRs, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="89fc4-186">comunicação tooensure é feita por meio do dispositivo de firewall correto hello, baseado no requisito de última de saudação acima, você precisa toocreate Olá seguinte tabela de rota contendo UDRs em **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-186">tooensure communication is done through hello right firewall appliance, based on hello last requirement above, you need toocreate hello following route table containing UDRs in **azurevnet**.</span></span>

### <a name="azgwudr"></a><span data-ttu-id="89fc4-187">azgwudr</span><span class="sxs-lookup"><span data-stu-id="89fc4-187">azgwudr</span></span>
<span data-ttu-id="89fc4-188">Nesse cenário, Olá somente tráfego que flui de tooAzure local será usado toomanage Olá firewalls conectando-se muito**AZF3**, e que o tráfego deve passar pelo firewall interno de Olá, **AZF2**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-188">In this scenario, hello only traffic flowing from on-premises tooAzure will be used toomanage hello firewalls by connecting too**AZF3**, and that traffic must go through hello internal firewall, **AZF2**.</span></span> <span data-ttu-id="89fc4-189">Portanto, apenas uma rota é necessária em Olá **GatewaySubnet** conforme mostrado abaixo.</span><span class="sxs-lookup"><span data-stu-id="89fc4-189">Therefore, only one route is necessary in hello **GatewaySubnet** as shown below.</span></span>

| <span data-ttu-id="89fc4-190">Destino</span><span class="sxs-lookup"><span data-stu-id="89fc4-190">Destination</span></span> | <span data-ttu-id="89fc4-191">Próximo salto</span><span class="sxs-lookup"><span data-stu-id="89fc4-191">Next hop</span></span> | <span data-ttu-id="89fc4-192">Explicação</span><span class="sxs-lookup"><span data-stu-id="89fc4-192">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="89fc4-193">10.0.4.0/24</span><span class="sxs-lookup"><span data-stu-id="89fc4-193">10.0.4.0/24</span></span> |<span data-ttu-id="89fc4-194">10.0.3.11</span><span class="sxs-lookup"><span data-stu-id="89fc4-194">10.0.3.11</span></span> |<span data-ttu-id="89fc4-195">Permite que o firewall de gerenciamento local tráfego tooreach **AZF3**</span><span class="sxs-lookup"><span data-stu-id="89fc4-195">Allows on-premises traffic tooreach management firewall **AZF3**</span></span> |

### <a name="azsn2udr"></a><span data-ttu-id="89fc4-196">azsn2udr</span><span class="sxs-lookup"><span data-stu-id="89fc4-196">azsn2udr</span></span>
| <span data-ttu-id="89fc4-197">Destino</span><span class="sxs-lookup"><span data-stu-id="89fc4-197">Destination</span></span> | <span data-ttu-id="89fc4-198">Próximo salto</span><span class="sxs-lookup"><span data-stu-id="89fc4-198">Next hop</span></span> | <span data-ttu-id="89fc4-199">Explicação</span><span class="sxs-lookup"><span data-stu-id="89fc4-199">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="89fc4-200">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="89fc4-200">10.0.3.0/24</span></span> |<span data-ttu-id="89fc4-201">10.0.2.11</span><span class="sxs-lookup"><span data-stu-id="89fc4-201">10.0.2.11</span></span> |<span data-ttu-id="89fc4-202">Permite que a sub-rede de back-end do tráfego toohello hospeda o servidor de aplicativo hello por meio de **AZF2**</span><span class="sxs-lookup"><span data-stu-id="89fc4-202">Allows traffic toohello backend subnet hosting hello application server through **AZF2**</span></span> |
| <span data-ttu-id="89fc4-203">0.0.0.0/0</span><span class="sxs-lookup"><span data-stu-id="89fc4-203">0.0.0.0/0</span></span> |<span data-ttu-id="89fc4-204">10.0.2.10</span><span class="sxs-lookup"><span data-stu-id="89fc4-204">10.0.2.10</span></span> |<span data-ttu-id="89fc4-205">Permite que todos os outros toobe do tráfego roteado por **AZF1**</span><span class="sxs-lookup"><span data-stu-id="89fc4-205">Allows all other traffic toobe routed through **AZF1**</span></span> |

### <a name="azsn3udr"></a><span data-ttu-id="89fc4-206">azsn3udr</span><span class="sxs-lookup"><span data-stu-id="89fc4-206">azsn3udr</span></span>
| <span data-ttu-id="89fc4-207">Destino</span><span class="sxs-lookup"><span data-stu-id="89fc4-207">Destination</span></span> | <span data-ttu-id="89fc4-208">Próximo salto</span><span class="sxs-lookup"><span data-stu-id="89fc4-208">Next hop</span></span> | <span data-ttu-id="89fc4-209">Explicação</span><span class="sxs-lookup"><span data-stu-id="89fc4-209">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="89fc4-210">10.0.2.0/24</span><span class="sxs-lookup"><span data-stu-id="89fc4-210">10.0.2.0/24</span></span> |<span data-ttu-id="89fc4-211">10.0.3.10</span><span class="sxs-lookup"><span data-stu-id="89fc4-211">10.0.3.10</span></span> |<span data-ttu-id="89fc4-212">Permite que o tráfego muito**azsn2** tooflow do servidor Web toohello de servidor do aplicativo por meio de **AZF2**</span><span class="sxs-lookup"><span data-stu-id="89fc4-212">Allows traffic too**azsn2** tooflow from app server toohello webserver through **AZF2**</span></span> |

<span data-ttu-id="89fc4-213">Você também precisa toocreate tabelas de rotas para sub-redes Olá **onpremvnet** toomimic Olá datacenter local.</span><span class="sxs-lookup"><span data-stu-id="89fc4-213">You also need toocreate route tables for hello subnets in **onpremvnet** toomimic hello on-premises datacenter.</span></span>

### <a name="onpremsn1udr"></a><span data-ttu-id="89fc4-214">onpremsn1udr</span><span class="sxs-lookup"><span data-stu-id="89fc4-214">onpremsn1udr</span></span>
| <span data-ttu-id="89fc4-215">Destino</span><span class="sxs-lookup"><span data-stu-id="89fc4-215">Destination</span></span> | <span data-ttu-id="89fc4-216">Próximo salto</span><span class="sxs-lookup"><span data-stu-id="89fc4-216">Next hop</span></span> | <span data-ttu-id="89fc4-217">Explicação</span><span class="sxs-lookup"><span data-stu-id="89fc4-217">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="89fc4-218">192.168.2.0/24</span><span class="sxs-lookup"><span data-stu-id="89fc4-218">192.168.2.0/24</span></span> |<span data-ttu-id="89fc4-219">192.168.1.4</span><span class="sxs-lookup"><span data-stu-id="89fc4-219">192.168.1.4</span></span> |<span data-ttu-id="89fc4-220">Permite que o tráfego muito**onpremsn2** por meio de **OPFW**</span><span class="sxs-lookup"><span data-stu-id="89fc4-220">Allows traffic too**onpremsn2** through **OPFW**</span></span> |

### <a name="onpremsn2udr"></a><span data-ttu-id="89fc4-221">onpremsn2udr</span><span class="sxs-lookup"><span data-stu-id="89fc4-221">onpremsn2udr</span></span>
| <span data-ttu-id="89fc4-222">Destino</span><span class="sxs-lookup"><span data-stu-id="89fc4-222">Destination</span></span> | <span data-ttu-id="89fc4-223">Próximo salto</span><span class="sxs-lookup"><span data-stu-id="89fc4-223">Next hop</span></span> | <span data-ttu-id="89fc4-224">Explicação</span><span class="sxs-lookup"><span data-stu-id="89fc4-224">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="89fc4-225">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="89fc4-225">10.0.3.0/24</span></span> |<span data-ttu-id="89fc4-226">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="89fc4-226">192.168.2.4</span></span> |<span data-ttu-id="89fc4-227">Permite que o tráfego toohello feito sub-rede no Azure por meio de **OPFW**</span><span class="sxs-lookup"><span data-stu-id="89fc4-227">Allows traffic toohello backed subnet in Azure through **OPFW**</span></span> |
| <span data-ttu-id="89fc4-228">192.168.1.0/24</span><span class="sxs-lookup"><span data-stu-id="89fc4-228">192.168.1.0/24</span></span> |<span data-ttu-id="89fc4-229">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="89fc4-229">192.168.2.4</span></span> |<span data-ttu-id="89fc4-230">Permite que o tráfego muito**onpremsn1** por meio de **OPFW**</span><span class="sxs-lookup"><span data-stu-id="89fc4-230">Allows traffic too**onpremsn1** through **OPFW**</span></span> |

## <a name="ip-forwarding"></a><span data-ttu-id="89fc4-231">encaminhamento IP</span><span class="sxs-lookup"><span data-stu-id="89fc4-231">IP Forwarding</span></span>
<span data-ttu-id="89fc4-232">UDR e encaminhamento de IP são recursos que você pode usar em combinação tooallow dispositivos virtuais toobe usado toocontrol fluxo de tráfego em uma rede virtual do Azure.</span><span class="sxs-lookup"><span data-stu-id="89fc4-232">UDR and IP Forwarding are features that you can use in combination tooallow virtual appliances toobe used toocontrol traffic flow in an Azure VNet.</span></span>  <span data-ttu-id="89fc4-233">Um dispositivo virtual é nada mais que uma VM que executa um tráfego de rede do aplicativo usado toohandle de alguma forma, como um firewall ou um dispositivo NAT.</span><span class="sxs-lookup"><span data-stu-id="89fc4-233">A virtual appliance is nothing more than a VM that runs an application used toohandle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="89fc4-234">Este dispositivo virtual que VM deve ser capaz de tooreceive tráfego de entrada que é não resolvidos tooitself.</span><span class="sxs-lookup"><span data-stu-id="89fc4-234">This virtual appliance VM must be able tooreceive incoming traffic that is not addressed tooitself.</span></span> <span data-ttu-id="89fc4-235">tooallow um tráfego de tooreceive VM endereçado tooother destinos, você deve habilitar o encaminhamento IP para Olá VM.</span><span class="sxs-lookup"><span data-stu-id="89fc4-235">tooallow a VM tooreceive traffic addressed tooother destinations, you must enable IP Forwarding for hello VM.</span></span> <span data-ttu-id="89fc4-236">Este é um Azure configuração, não é uma configuração no sistema de operacional convidado hello.</span><span class="sxs-lookup"><span data-stu-id="89fc4-236">This is an Azure setting, not a setting in hello guest operating system.</span></span> <span data-ttu-id="89fc4-237">Seu dispositivo virtual ainda necessidades toorun algum tipo de aplicativo toohandle Olá tráfego de entrada e encaminhá-lo adequadamente.</span><span class="sxs-lookup"><span data-stu-id="89fc4-237">Your virtual appliance still needs toorun some type of application toohandle hello incoming traffic, and route it appropriately.</span></span>

<span data-ttu-id="89fc4-238">toolearn mais sobre o encaminhamento de IP, visite [quais são rotas definidas pelo usuário e encaminhamento IP](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="89fc4-238">toolearn more about IP Forwarding, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="89fc4-239">Por exemplo, imagine que você tenha Olá após a instalação em uma rede virtual do Azure:</span><span class="sxs-lookup"><span data-stu-id="89fc4-239">As an example, imagine you have hello following setup in an Azure vnet:</span></span>

* <span data-ttu-id="89fc4-240">A sub-rede **onpremsn1** contém uma VM denominada **onpremvm1**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-240">Subnet **onpremsn1** contains a VM named **onpremvm1**.</span></span>
* <span data-ttu-id="89fc4-241">A sub-rede **onpremsn2** contém uma VM chamada **onpremvm2**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-241">Subnet **onpremsn2** contains a VM named **onpremvm2**.</span></span>
* <span data-ttu-id="89fc4-242">Um dispositivo virtual denominado **OPFW** está conectado muito**onpremsn1** e **onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-242">A virtual appliance named **OPFW** is connected too**onpremsn1** and **onpremsn2**.</span></span>
* <span data-ttu-id="89fc4-243">Uma rota definida pelo usuário vinculado muito**onpremsn1** Especifica que todo o tráfego muito**onpremsn2** devem ser enviadas muito**OPFW**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-243">A user defined route linked too**onpremsn1** specifies that all traffic too**onpremsn2** must be sent too**OPFW**.</span></span>

<span data-ttu-id="89fc4-244">No ponto, se **onpremvm1** tenta uma conexão com a tooestablish **onpremvm2**, hello UDR será usado e o tráfego será enviado muito**OPFW** como próximo salto de saudação.</span><span class="sxs-lookup"><span data-stu-id="89fc4-244">At this point, if **onpremvm1** tries tooestablish a connection with **onpremvm2**, hello UDR will be used and traffic will be sent too**OPFW** as hello next hop.</span></span> <span data-ttu-id="89fc4-245">Tenha em mente que Olá destino real do pacote não está sendo alterada, ela ainda apresenta **onpremvm2** é o destino de saudação.</span><span class="sxs-lookup"><span data-stu-id="89fc4-245">Keep in mind that hello actual packet destination is not being changed, it still says **onpremvm2** is hello destination.</span></span> 

<span data-ttu-id="89fc4-246">Sem o encaminhamento IP habilitado para **OPFW**, Olá lógica de rede virtual do Azure descartará o pacote hello, desde que ela só permita que pacotes enviado de toobe tooa VM se hello o endereço IP da VM é o destino de Olá para pacote de saudação.</span><span class="sxs-lookup"><span data-stu-id="89fc4-246">Without IP Forwarding enabled for **OPFW**, hello Azure virtual networking logic will drop hello packets, since it only allows packets toobe sent tooa VM if hello VM’s IP address is hello destination for hello packet.</span></span>

<span data-ttu-id="89fc4-247">Com o encaminhamento IP, Olá lógica da rede virtual do Azure encaminhará Olá pacotes tooOPFW, sem alterar seu endereço de destino original.</span><span class="sxs-lookup"><span data-stu-id="89fc4-247">With IP Forwarding, hello Azure virtual network logic will forward hello packets tooOPFW, without changing its original destination address.</span></span> <span data-ttu-id="89fc4-248">**OPFW** deve manipular pacotes de saudação e determinar quais toodo com eles.</span><span class="sxs-lookup"><span data-stu-id="89fc4-248">**OPFW** must handle hello packets and determine what toodo with them.</span></span>

<span data-ttu-id="89fc4-249">Para o cenário de saudação acima toowork, você deve habilitar o encaminhamento IP nas NICs hello para **OPFW**, **AZF1**, **AZF2**, e **AZF3** que são usados para roteamento de (todas as NICs exceto Olá aqueles toohello vinculado gerenciamento sub-rede).</span><span class="sxs-lookup"><span data-stu-id="89fc4-249">For hello scenario above toowork, you must enable IP Forwarding on hello NICs for **OPFW**, **AZF1**, **AZF2**, and **AZF3** that are used for routing (all NICs except hello ones linked toohello management subnet).</span></span> 

## <a name="firewall-rules"></a><span data-ttu-id="89fc4-250">Regras de firewall</span><span class="sxs-lookup"><span data-stu-id="89fc4-250">Firewall Rules</span></span>
<span data-ttu-id="89fc4-251">Conforme descrito acima, somente encaminhamento de IP garante que os pacotes são enviados a dispositivos virtuais toohello.</span><span class="sxs-lookup"><span data-stu-id="89fc4-251">As described above, IP Forwarding only ensures packets are sent toohello virtual appliances.</span></span> <span data-ttu-id="89fc4-252">Seu dispositivo ainda precisa toodecide que toodo com esses pacotes.</span><span class="sxs-lookup"><span data-stu-id="89fc4-252">Your appliance still needs toodecide what toodo with those packets.</span></span> <span data-ttu-id="89fc4-253">Cenário de saudação acima, você precisará Olá toocreate seguindo as regras em seus dispositivos:</span><span class="sxs-lookup"><span data-stu-id="89fc4-253">In hello scenario above, you will need toocreate hello following rules in your appliances:</span></span>

### <a name="opfw"></a><span data-ttu-id="89fc4-254">OPFW</span><span class="sxs-lookup"><span data-stu-id="89fc4-254">OPFW</span></span>
<span data-ttu-id="89fc4-255">OPFW representa um dispositivo local que contém a saudação regras a seguir:</span><span class="sxs-lookup"><span data-stu-id="89fc4-255">OPFW represents an on-premises device containing hello following rules:</span></span>

* <span data-ttu-id="89fc4-256">**Rota**: todo o tráfego too10.0.0.0/16 (**azurevnet**) deve ser enviado por meio de túnel **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-256">**Route**: All traffic too10.0.0.0/16 (**azurevnet**) must be sent through tunnel **ONPREMAZURE**.</span></span>
* <span data-ttu-id="89fc4-257">**Política**: permitir todo o tráfego bidirecional entre **port2** e **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-257">**Policy**: Allow all bidirectional traffic between **port2** and **ONPREMAZURE**.</span></span>

### <a name="azf1"></a><span data-ttu-id="89fc4-258">AZF1</span><span class="sxs-lookup"><span data-stu-id="89fc4-258">AZF1</span></span>
<span data-ttu-id="89fc4-259">AZF1 representa um dispositivo virtual do Azure que contém a saudação regras a seguir:</span><span class="sxs-lookup"><span data-stu-id="89fc4-259">AZF1 represents an Azure virtual appliance containing hello following rules:</span></span>

* <span data-ttu-id="89fc4-260">**Política**: permitir todo o tráfego bidirecional entre **port1** e **port2**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-260">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

### <a name="azf2"></a><span data-ttu-id="89fc4-261">AZF2</span><span class="sxs-lookup"><span data-stu-id="89fc4-261">AZF2</span></span>
<span data-ttu-id="89fc4-262">AZF2 representa um dispositivo virtual do Azure que contém a saudação regras a seguir:</span><span class="sxs-lookup"><span data-stu-id="89fc4-262">AZF2 represents an Azure virtual appliance containing hello following rules:</span></span>

* <span data-ttu-id="89fc4-263">**Rota**: todo o tráfego too10.0.0.0/16 (**onpremvnet**) deve ser enviado de endereço IP de gateway do Azure toohello (ou seja, 10.0.0.1) por meio de **port1**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-263">**Route**: All traffic too10.0.0.0/16 (**onpremvnet**) must be sent toohello Azure gateway IP address (i.e. 10.0.0.1) through **port1**.</span></span>
* <span data-ttu-id="89fc4-264">**Política**: permitir todo o tráfego bidirecional entre **port1** e **port2**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-264">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

## <a name="network-security-groups-nsgs"></a><span data-ttu-id="89fc4-265">Grupos de segurança de rede (NSG)</span><span class="sxs-lookup"><span data-stu-id="89fc4-265">Network Security Groups (NSGs)</span></span>
<span data-ttu-id="89fc4-266">Nesse cenário, os NSGs não estão sendo usados.</span><span class="sxs-lookup"><span data-stu-id="89fc4-266">In this scenario, NSGs are not being used.</span></span> <span data-ttu-id="89fc4-267">No entanto, você pode aplicar os NSGs tooeach toorestrict entrado e saído o tráfego de sub-rede.</span><span class="sxs-lookup"><span data-stu-id="89fc4-267">However, you could apply NSGs tooeach subnet toorestrict incoming and outgoing traffic.</span></span> <span data-ttu-id="89fc4-268">Por exemplo, você pode aplicar Olá sub-rede toohello FW externa regras NSG a seguir.</span><span class="sxs-lookup"><span data-stu-id="89fc4-268">For instance, you could apply hello following NSG rules toohello external FW subnet.</span></span>

<span data-ttu-id="89fc4-269">**Entrada**</span><span class="sxs-lookup"><span data-stu-id="89fc4-269">**Incoming**</span></span>

* <span data-ttu-id="89fc4-270">Permitir todo o tráfego TCP de saudação Internet tooport 80 em qualquer máquina virtual na sub-rede hello.</span><span class="sxs-lookup"><span data-stu-id="89fc4-270">Allow all TCP traffic from hello Internet tooport 80 on any VM in hello subnet.</span></span>
* <span data-ttu-id="89fc4-271">Nega todo o tráfego de saudação à Internet.</span><span class="sxs-lookup"><span data-stu-id="89fc4-271">Deny all other traffic from hello Internet.</span></span>

<span data-ttu-id="89fc4-272">**Saída**</span><span class="sxs-lookup"><span data-stu-id="89fc4-272">**Outgoing**</span></span>

* <span data-ttu-id="89fc4-273">Nega todas as toohello de tráfego da Internet.</span><span class="sxs-lookup"><span data-stu-id="89fc4-273">Deny all traffic toohello Internet.</span></span>

## <a name="high-level-steps"></a><span data-ttu-id="89fc4-274">Etapas de alto nível</span><span class="sxs-lookup"><span data-stu-id="89fc4-274">High level steps</span></span>
<span data-ttu-id="89fc4-275">toodeploy neste cenário, siga Olá etapas de nível superior abaixo.</span><span class="sxs-lookup"><span data-stu-id="89fc4-275">toodeploy this scenario, follow hello high level steps below.</span></span>

1. <span data-ttu-id="89fc4-276">Logon tooyour assinatura do Azure.</span><span class="sxs-lookup"><span data-stu-id="89fc4-276">Login tooyour Azure Subscription.</span></span>
2. <span data-ttu-id="89fc4-277">Se você quiser toodeploy uma saudação de toomimic VNet rede local, provisionar os recursos de saudação que fazem parte do **ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-277">If you want toodeploy a VNet toomimic hello on-premises network, provision hello resources that are part of **ONPREMRG**.</span></span>
3. <span data-ttu-id="89fc4-278">Provisionar recursos de saudação que fazem parte do **AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-278">Provision hello resources that are part of **AZURERG**.</span></span>
4. <span data-ttu-id="89fc4-279">Encapsulamento Olá provisionar **onpremvnet** muito**azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-279">Provision hello tunnel from **onpremvnet** too**azurevnet**.</span></span>
5. <span data-ttu-id="89fc4-280">Depois que todos os recursos forem provisionados, faça logon muito**onpremvm2** e a conectividade do ping 10.0.3.101 tootest entre **onpremsn2** e **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="89fc4-280">Once all resources are provisioned, log on too**onpremvm2** and ping 10.0.3.101 tootest connectivity between **onpremsn2** and **azsn3**.</span></span>

