---
title: "Conexão híbrida com o aplicativo de 2 camadas | Microsoft Docs"
description: "Aprenda a implantar dispositivos virtuais e UDR para criar um ambiente de aplicativo de várias camadas no Azure"
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: tysonn
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: jdial
ms.openlocfilehash: 8e464348660114f5e99b4739bb7761b7e53ebf99
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="virtual-appliance-scenario"></a><span data-ttu-id="63eec-103">Cenário de dispositivo virtual</span><span class="sxs-lookup"><span data-stu-id="63eec-103">Virtual appliance scenario</span></span>
<span data-ttu-id="63eec-104">Um cenário comum entre os maiores clientes do Azure é a necessidade de fornecer um aplicativo de duas camadas exposto à Internet, permitindo acesso para a camada traseira de um datacenter local.</span><span class="sxs-lookup"><span data-stu-id="63eec-104">A common scenario among larger Azure customer is the need to provide a two-tiered application exposed to the Internet, while allowing access to the back tier from an on-premises datacenter.</span></span> <span data-ttu-id="63eec-105">Este documento explica um cenário usando UDR (Rotas Definidas pelo Usuário), um Gateway de VPN e dispositivos virtuais de rede para implantar um ambiente de duas camadas que atende aos seguintes requisitos:</span><span class="sxs-lookup"><span data-stu-id="63eec-105">This document will walk you through a scenario using User Defined Routes (UDR), a VPN Gateway, and network virtual appliances to deploy a two-tier environment that meets the following requirements:</span></span>

* <span data-ttu-id="63eec-106">O aplicativo Web deve ser acessível somente pela Internet pública.</span><span class="sxs-lookup"><span data-stu-id="63eec-106">Web application must be accessible from the public Internet only.</span></span>
* <span data-ttu-id="63eec-107">O servidor Web que hospeda o aplicativo deve ser capaz de acessar um servidor de aplicativos back-end.</span><span class="sxs-lookup"><span data-stu-id="63eec-107">Web server hosting the application must be able to access a backend application server.</span></span>
* <span data-ttu-id="63eec-108">Todo o tráfego da Internet para o aplicativo Web deve passar por um dispositivo virtual de firewall.</span><span class="sxs-lookup"><span data-stu-id="63eec-108">All traffic from the Internet to the web application must go through a firewall virtual appliance.</span></span> <span data-ttu-id="63eec-109">Este dispositivo virtual será usado apenas para o tráfego de Internet.</span><span class="sxs-lookup"><span data-stu-id="63eec-109">This virtual appliance will be used for Internet traffic only.</span></span>
* <span data-ttu-id="63eec-110">Todo o tráfego indo para o servidor de aplicativos deve passar por um dispositivo virtual de firewall.</span><span class="sxs-lookup"><span data-stu-id="63eec-110">All traffic going to the application server must go through a firewall virtual appliance.</span></span> <span data-ttu-id="63eec-111">Este dispositivo virtual será usado para acesso ao servidor de back-end e para acesso proveniente da rede local por meio de um Gateway de VPN.</span><span class="sxs-lookup"><span data-stu-id="63eec-111">This virtual appliance will be used for access to the backend end server, and access coming in from the on-premises network via a VPN Gateway.</span></span>
* <span data-ttu-id="63eec-112">Os administradores devem ser capazes de gerenciar os dispositivos virtuais de firewall em seus computadores locais usando um terceiro dispositivo virtual de firewall usado exclusivamente para fins de gerenciamento.</span><span class="sxs-lookup"><span data-stu-id="63eec-112">Administrators must be able to manage the firewall virtual appliances from their on-premises computers, by using a third firewall virtual appliance used exclusively for management purposes.</span></span>

<span data-ttu-id="63eec-113">Esse é um cenário de DMZ padrão com um DMZ e uma rede protegida.</span><span class="sxs-lookup"><span data-stu-id="63eec-113">This is a standard DMZ scenario with a DMZ and a protected network.</span></span> <span data-ttu-id="63eec-114">Esse cenário pode ser criado no Azure usando NSGs, dispositivos virtuais de firewall ou uma combinação de ambos.</span><span class="sxs-lookup"><span data-stu-id="63eec-114">Such scenario can be constructed in Azure by using NSGs, firewall virtual appliances, or a combination of both.</span></span> <span data-ttu-id="63eec-115">A tabela a seguir mostra alguns dos prós e contras entre NSGs e dispositivos virtuais de firewall.</span><span class="sxs-lookup"><span data-stu-id="63eec-115">The table below shows some of the pros and cons between NSGs and firewall virtual appliances.</span></span>

|  | <span data-ttu-id="63eec-116">Prós</span><span class="sxs-lookup"><span data-stu-id="63eec-116">Pros</span></span> | <span data-ttu-id="63eec-117">Contras</span><span class="sxs-lookup"><span data-stu-id="63eec-117">Cons</span></span> |
| --- | --- | --- |
| <span data-ttu-id="63eec-118">NSG</span><span class="sxs-lookup"><span data-stu-id="63eec-118">NSG</span></span> |<span data-ttu-id="63eec-119">Sem custo.</span><span class="sxs-lookup"><span data-stu-id="63eec-119">No cost.</span></span> <br/><span data-ttu-id="63eec-120">Integrado ao RBAC do Azure.</span><span class="sxs-lookup"><span data-stu-id="63eec-120">Integrated into Azure RBAC.</span></span> <br/><span data-ttu-id="63eec-121">As regras podem ser criadas em modelos Aa ARM.</span><span class="sxs-lookup"><span data-stu-id="63eec-121">Rules can be created in ARM templates.</span></span> |<span data-ttu-id="63eec-122">A complexidade pode variar em ambientes maiores.</span><span class="sxs-lookup"><span data-stu-id="63eec-122">Complexity could vary in larger environments.</span></span> |
| <span data-ttu-id="63eec-123">Firewall</span><span class="sxs-lookup"><span data-stu-id="63eec-123">Firewall</span></span> |<span data-ttu-id="63eec-124">Controle total sobre o plano de dados.</span><span class="sxs-lookup"><span data-stu-id="63eec-124">Full control over data plane.</span></span> <br/><span data-ttu-id="63eec-125">Gerenciamento central por meio do console do firewall.</span><span class="sxs-lookup"><span data-stu-id="63eec-125">Central management through firewall console.</span></span> |<span data-ttu-id="63eec-126">Custo do dispositivo de firewall.</span><span class="sxs-lookup"><span data-stu-id="63eec-126">Cost of firewall appliance.</span></span> <br/><span data-ttu-id="63eec-127">Não é integrado ao RBAC do Azure.</span><span class="sxs-lookup"><span data-stu-id="63eec-127">Not integrated with Azure RBAC.</span></span> |

<span data-ttu-id="63eec-128">A solução a seguir usa dispositivos virtuais do firewall para implementar um cenário de rede DMZ/protegido.</span><span class="sxs-lookup"><span data-stu-id="63eec-128">The solution below uses firewall virtual appliances to implement a DMZ/protected network scenario.</span></span>

## <a name="considerations"></a><span data-ttu-id="63eec-129">Considerações</span><span class="sxs-lookup"><span data-stu-id="63eec-129">Considerations</span></span>
<span data-ttu-id="63eec-130">Você pode implantar o ambiente explicado anteriormente no Azure usando da seguinte maneira diferentes recursos disponíveis hoje.</span><span class="sxs-lookup"><span data-stu-id="63eec-130">You can deploy the environment explained above in Azure using different features available today, as follows.</span></span>

* <span data-ttu-id="63eec-131">**Rede virtual (VNet)**.</span><span class="sxs-lookup"><span data-stu-id="63eec-131">**Virtual network (VNet)**.</span></span> <span data-ttu-id="63eec-132">Uma VNet do Azure funciona de maneira semelhante a uma rede local e pode ser segmentada em uma ou mais sub-redes para fornecer isolamento de tráfego e separação de preocupações.</span><span class="sxs-lookup"><span data-stu-id="63eec-132">An Azure VNet acts in similar fashion to an on-premises network, and can be segmented into one or more subnets to provide traffic isolation, and separation of concerns.</span></span>
* <span data-ttu-id="63eec-133">**Dispositivo virtual**.</span><span class="sxs-lookup"><span data-stu-id="63eec-133">**Virtual appliance**.</span></span> <span data-ttu-id="63eec-134">Vários parceiros fornecem dispositivos virtuais no Azure Marketplace que podem ser usados para os três firewalls descritos acima.</span><span class="sxs-lookup"><span data-stu-id="63eec-134">Several partners provide virtual appliances in the Azure Marketplace that can be used for the three firewalls described above.</span></span> 
* <span data-ttu-id="63eec-135">**UDR (Rotas Definidas pelo Usuário)**.</span><span class="sxs-lookup"><span data-stu-id="63eec-135">**User Defined Routes (UDR)**.</span></span> <span data-ttu-id="63eec-136">As tabelas de rotas podem conter UDRs usadas pela rede do Azure para controlar o fluxo de pacotes em uma VNet.</span><span class="sxs-lookup"><span data-stu-id="63eec-136">Route tables can contain UDRs used by Azure networking to control the flow of packets within a VNet.</span></span> <span data-ttu-id="63eec-137">Essas tabelas de rotas podem ser aplicadas a sub-redes.</span><span class="sxs-lookup"><span data-stu-id="63eec-137">These route tables can be applied to subnets.</span></span> <span data-ttu-id="63eec-138">Um dos recursos mais recentes no Azure é a capacidade de aplicar uma tabela de rotas para o GatewaySubnet, fornecendo a capacidade de encaminhar todo o tráfego de entrada da VNet do Azure de uma conexão híbrida para um dispositivo virtual.</span><span class="sxs-lookup"><span data-stu-id="63eec-138">One of the newest features in Azure is the ability to apply a route table to the GatewaySubnet, providing the ability to forward all traffic coming into the Azure VNet from a hybrid connection to a virtual appliance.</span></span>
* <span data-ttu-id="63eec-139">**Encaminhamento IP**.</span><span class="sxs-lookup"><span data-stu-id="63eec-139">**IP Forwarding**.</span></span> <span data-ttu-id="63eec-140">Por padrão, o mecanismo de rede do Azure encaminhará pacotes a NICs (placas de interface de rede virtual) somente se o endereço IP de destino do pacote corresponder ao endereço IP da NIC.</span><span class="sxs-lookup"><span data-stu-id="63eec-140">By default, the Azure networking engine forward packets to virtual network interface cards (NICs) only if the packet destination IP address matches the NIC IP address.</span></span> <span data-ttu-id="63eec-141">Portanto, se uma UDR definir que um pacote deverá ser enviado para um determinado dispositivo virtual, o mecanismo de rede do Azure deverá remover esse pacote.</span><span class="sxs-lookup"><span data-stu-id="63eec-141">Therefore, if a UDR defines that a packet must be sent to a given virtual appliance, the Azure networking engine would drop that packet.</span></span> <span data-ttu-id="63eec-142">Para garantir que o pacote seja entregue a uma VM (no caso, um dispositivo virtual) que não seja o destino real do pacote, você precisará habilitar o encaminhamento IP para o dispositivo virtual.</span><span class="sxs-lookup"><span data-stu-id="63eec-142">To ensure the packet is delivered to a VM (in this case a virtual appliance) that is not the actual destination for the packet, you need to enable IP Forwarding for the virtual appliance.</span></span>
* <span data-ttu-id="63eec-143">**NSGs (Grupos de Segurança de Rede)**.</span><span class="sxs-lookup"><span data-stu-id="63eec-143">**Network Security Groups (NSGs)**.</span></span> <span data-ttu-id="63eec-144">O exemplo a seguir não faz uso de NSGs, mas você pode usar os NSGs aplicados às sub-redes e/ou NICs nesta solução para filtrar ainda mais o tráfego de entrada e saída dessas NICs e sub-redes.</span><span class="sxs-lookup"><span data-stu-id="63eec-144">The example below does not make use of NSGs, but you could use NSGs applied to the subnets and/or NICs in this solution to further filter the traffic in and out of those subnets and NICs.</span></span>

![Conectividade IPv6](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

<span data-ttu-id="63eec-146">Neste exemplo, há uma assinatura que contém o seguinte:</span><span class="sxs-lookup"><span data-stu-id="63eec-146">In this example there is a subscription that contains the following:</span></span>

* <span data-ttu-id="63eec-147">2 grupos de recursos, não mostrados no diagrama.</span><span class="sxs-lookup"><span data-stu-id="63eec-147">2 resource groups, not shown in the diagram.</span></span> 
  * <span data-ttu-id="63eec-148">**ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="63eec-148">**ONPREMRG**.</span></span> <span data-ttu-id="63eec-149">Contém todos os recursos necessários para simular uma rede local.</span><span class="sxs-lookup"><span data-stu-id="63eec-149">Contains all resources necessary to simulate an on-premises network.</span></span>
  * <span data-ttu-id="63eec-150">**AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="63eec-150">**AZURERG**.</span></span> <span data-ttu-id="63eec-151">Contém todos os recursos necessários para o ambiente de rede virtual do Azure.</span><span class="sxs-lookup"><span data-stu-id="63eec-151">Contains all resources necessary for the Azure virtual network environment.</span></span> 
* <span data-ttu-id="63eec-152">Uma VNet denominada **onpremvnet** usada para imitar um datacenter local segmentado como listado abaixo.</span><span class="sxs-lookup"><span data-stu-id="63eec-152">A VNet named **onpremvnet** used to mimic an on-premises datacenter segmented as listed below.</span></span>
  * <span data-ttu-id="63eec-153">**onpremsn1**.</span><span class="sxs-lookup"><span data-stu-id="63eec-153">**onpremsn1**.</span></span> <span data-ttu-id="63eec-154">A sub-rede que contém uma VM (máquina virtual) executando o Ubuntu para simular um servidor local.</span><span class="sxs-lookup"><span data-stu-id="63eec-154">Subnet containing a virtual machine (VM) running Ubuntu to mimic an on-premises server.</span></span>
  * <span data-ttu-id="63eec-155">**onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="63eec-155">**onpremsn2**.</span></span> <span data-ttu-id="63eec-156">A sub-rede que contém uma VM executando o Ubuntu para simular um computador local usado por um administrador.</span><span class="sxs-lookup"><span data-stu-id="63eec-156">Subnet containing a VM running Ubuntu to mimic an on-premises computer used by an administrator.</span></span>
* <span data-ttu-id="63eec-157">Há um dispositivo virtual de firewall denominado **OPFW** em **onpremvnet** usado para manter um túnel para **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="63eec-157">There is one firewall virtual appliance named **OPFW** on **onpremvnet** used to maintain a tunnel to **azurevnet**.</span></span>
* <span data-ttu-id="63eec-158">Uma VNet denominada **azurevnet** segmentada como listado abaixo.</span><span class="sxs-lookup"><span data-stu-id="63eec-158">A VNet named **azurevnet** segmented as listed below.</span></span>
  * <span data-ttu-id="63eec-159">**azsn1**.</span><span class="sxs-lookup"><span data-stu-id="63eec-159">**azsn1**.</span></span> <span data-ttu-id="63eec-160">A sub-rede de firewall externo usada exclusivamente para o firewall externo.</span><span class="sxs-lookup"><span data-stu-id="63eec-160">External firewall subnet used exclusively for the external firewall.</span></span> <span data-ttu-id="63eec-161">Todo o tráfego da Internet será proveniente desta sub-rede.</span><span class="sxs-lookup"><span data-stu-id="63eec-161">All Internet traffic will come in through this subnet.</span></span> <span data-ttu-id="63eec-162">Essa sub-rede contém apenas uma NIC associada ao firewall externo.</span><span class="sxs-lookup"><span data-stu-id="63eec-162">This subnet only contains a NIC linked to the external firewall.</span></span>
  * <span data-ttu-id="63eec-163">**azsn2**.</span><span class="sxs-lookup"><span data-stu-id="63eec-163">**azsn2**.</span></span> <span data-ttu-id="63eec-164">A sub-rede de front-end hospeda uma VM em execução como um servidor Web que será acessado da Internet.</span><span class="sxs-lookup"><span data-stu-id="63eec-164">Front end subnet hosting a VM running as a web server that will be accessed from the Internet.</span></span>
  * <span data-ttu-id="63eec-165">**azsn3**.</span><span class="sxs-lookup"><span data-stu-id="63eec-165">**azsn3**.</span></span> <span data-ttu-id="63eec-166">A sub-rede de back-end hospeda uma VM que executa um servidor de aplicativos de back-end que será acessado pelo servidor Web de front-end.</span><span class="sxs-lookup"><span data-stu-id="63eec-166">Backend subnet hosting a VM running a backend application server that will be accessed by the front end web server.</span></span>
  * <span data-ttu-id="63eec-167">**azsn4**.</span><span class="sxs-lookup"><span data-stu-id="63eec-167">**azsn4**.</span></span> <span data-ttu-id="63eec-168">A sub-rede de gerenciamento usada exclusivamente para fornecer acesso de gerenciamento para todos os dispositivos virtuais do firewall.</span><span class="sxs-lookup"><span data-stu-id="63eec-168">Management subnet used exclusively to provide management access to all firewall virtual appliances.</span></span> <span data-ttu-id="63eec-169">Essa sub-rede contém apenas uma NIC para cada dispositivo virtual de firewall usado na solução.</span><span class="sxs-lookup"><span data-stu-id="63eec-169">This subnet only contains a NIC for each firewall virtual appliance used in the solution.</span></span>
  * <span data-ttu-id="63eec-170">**GatewaySubnet**.</span><span class="sxs-lookup"><span data-stu-id="63eec-170">**GatewaySubnet**.</span></span> <span data-ttu-id="63eec-171">A sub-rede de conexão híbrida do Azure necessária para o Gateway de VPN e o ExpressRoute para fornecer conectividade entre VNets do Azure e outras redes.</span><span class="sxs-lookup"><span data-stu-id="63eec-171">Azure hybrid connection subnet required for ExpressRoute and VPN Gateway to provide connectivity between Azure VNets and other networks.</span></span> 
* <span data-ttu-id="63eec-172">Há 3 dispositivos virtuais de firewall na rede **azurevnet** .</span><span class="sxs-lookup"><span data-stu-id="63eec-172">There are 3 firewall virtual appliances in the **azurevnet** network.</span></span> 
  * <span data-ttu-id="63eec-173">**AZF1**.</span><span class="sxs-lookup"><span data-stu-id="63eec-173">**AZF1**.</span></span> <span data-ttu-id="63eec-174">Firewall externo exposto à Internet pública usando um recurso de endereço IP público do Azure.</span><span class="sxs-lookup"><span data-stu-id="63eec-174">External firewall exposed to the public Internet by using a public IP address resource in Azure.</span></span> <span data-ttu-id="63eec-175">Você precisa garantir que tem um modelo do Marketplace, ou diretamente do seu fornecedor de dispositivo, que provisiona um dispositivo virtual de 3 NICs.</span><span class="sxs-lookup"><span data-stu-id="63eec-175">You need to ensure you have a template from the Marketplace, or directly from your appliance vendor, that provisions a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="63eec-176">**AZF2**.</span><span class="sxs-lookup"><span data-stu-id="63eec-176">**AZF2**.</span></span> <span data-ttu-id="63eec-177">Firewall interno usado para controlar o tráfego entre **azsn2** e **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="63eec-177">Internal firewall used to control traffic between **azsn2** and **azsn3**.</span></span> <span data-ttu-id="63eec-178">Isso também é um dispositivo virtual de 3 NICs.</span><span class="sxs-lookup"><span data-stu-id="63eec-178">This is also a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="63eec-179">**AZF3**.</span><span class="sxs-lookup"><span data-stu-id="63eec-179">**AZF3**.</span></span> <span data-ttu-id="63eec-180">O firewall de gerenciamento acessível aos administradores do datacenter local e conectado a uma sub-rede de gerenciamento usada para gerenciar todos os dispositivos de firewall.</span><span class="sxs-lookup"><span data-stu-id="63eec-180">Management firewall accessible to administrators from the on-premises datacenter, and connected to a management subnet used to manage all firewall appliances.</span></span> <span data-ttu-id="63eec-181">Você pode encontrar modelos de dispositivo virtual de 2 NICs no Marketplace ou solicitar uma diretamente do seu fornecedor de dispositivo.</span><span class="sxs-lookup"><span data-stu-id="63eec-181">You can find 2-NIC virtual appliance templates in the Marketplace, or request one directly from your appliance vendor.</span></span>

## <a name="user-defined-routing-udr"></a><span data-ttu-id="63eec-182">Roteamento definido pelo usuário (UDR)</span><span class="sxs-lookup"><span data-stu-id="63eec-182">User Defined Routing (UDR)</span></span>
<span data-ttu-id="63eec-183">Cada sub-rede no Azure pode ser vinculada a uma tabela UDR usada para definir como o tráfego iniciado na sub-rede é roteado.</span><span class="sxs-lookup"><span data-stu-id="63eec-183">Each subnet in Azure can be linked to a UDR table used to define how traffic initiated in that subnet is routed.</span></span> <span data-ttu-id="63eec-184">Se nenhum UDR for definido, o Azure usará as rotas padrão para permitir que o tráfego flua de uma sub-rede para outra.</span><span class="sxs-lookup"><span data-stu-id="63eec-184">If no UDRs are defined, Azure uses default routes to allow traffic to flow from one subnet to another.</span></span> <span data-ttu-id="63eec-185">Para entender melhor os UDRs, visite [O que são Rotas Definidas pelo Usuário e Encaminhamento de IP](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="63eec-185">To better understand UDRs, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="63eec-186">Para garantir a comunicação seja feita por meio do dispositivo de firewall correto, com base no último requisito acima, você precisará criar a seguinte tabela de rotas contendo UDRs em **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="63eec-186">To ensure communication is done through the right firewall appliance, based on the last requirement above, you need to create the following route table containing UDRs in **azurevnet**.</span></span>

### <a name="azgwudr"></a><span data-ttu-id="63eec-187">azgwudr</span><span class="sxs-lookup"><span data-stu-id="63eec-187">azgwudr</span></span>
<span data-ttu-id="63eec-188">Nesse cenário, o único tráfego fluindo do local para o Azure será usado para gerenciar os firewalls se conectando ao **AZF3** e esse tráfego deve passar pelo firewall interno, **AZF2**.</span><span class="sxs-lookup"><span data-stu-id="63eec-188">In this scenario, the only traffic flowing from on-premises to Azure will be used to manage the firewalls by connecting to **AZF3**, and that traffic must go through the internal firewall, **AZF2**.</span></span> <span data-ttu-id="63eec-189">Portanto, é necessária apenas uma rota no **GatewaySubnet** conforme mostrado abaixo.</span><span class="sxs-lookup"><span data-stu-id="63eec-189">Therefore, only one route is necessary in the **GatewaySubnet** as shown below.</span></span>

| <span data-ttu-id="63eec-190">Destino</span><span class="sxs-lookup"><span data-stu-id="63eec-190">Destination</span></span> | <span data-ttu-id="63eec-191">Próximo salto</span><span class="sxs-lookup"><span data-stu-id="63eec-191">Next hop</span></span> | <span data-ttu-id="63eec-192">Explicação</span><span class="sxs-lookup"><span data-stu-id="63eec-192">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="63eec-193">10.0.4.0/24</span><span class="sxs-lookup"><span data-stu-id="63eec-193">10.0.4.0/24</span></span> |<span data-ttu-id="63eec-194">10.0.3.11</span><span class="sxs-lookup"><span data-stu-id="63eec-194">10.0.3.11</span></span> |<span data-ttu-id="63eec-195">Permite que tráfego local alcance o gerenciamento de firewall **AZF3**</span><span class="sxs-lookup"><span data-stu-id="63eec-195">Allows on-premises traffic to reach management firewall **AZF3**</span></span> |

### <a name="azsn2udr"></a><span data-ttu-id="63eec-196">azsn2udr</span><span class="sxs-lookup"><span data-stu-id="63eec-196">azsn2udr</span></span>
| <span data-ttu-id="63eec-197">Destino</span><span class="sxs-lookup"><span data-stu-id="63eec-197">Destination</span></span> | <span data-ttu-id="63eec-198">Próximo salto</span><span class="sxs-lookup"><span data-stu-id="63eec-198">Next hop</span></span> | <span data-ttu-id="63eec-199">Explicação</span><span class="sxs-lookup"><span data-stu-id="63eec-199">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="63eec-200">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="63eec-200">10.0.3.0/24</span></span> |<span data-ttu-id="63eec-201">10.0.2.11</span><span class="sxs-lookup"><span data-stu-id="63eec-201">10.0.2.11</span></span> |<span data-ttu-id="63eec-202">Permite tráfego para a sub-rede de back-end que hospeda o servidor de aplicativos por meio do **AZF2**</span><span class="sxs-lookup"><span data-stu-id="63eec-202">Allows traffic to the backend subnet hosting the application server through **AZF2**</span></span> |
| <span data-ttu-id="63eec-203">0.0.0.0/0</span><span class="sxs-lookup"><span data-stu-id="63eec-203">0.0.0.0/0</span></span> |<span data-ttu-id="63eec-204">10.0.2.10</span><span class="sxs-lookup"><span data-stu-id="63eec-204">10.0.2.10</span></span> |<span data-ttu-id="63eec-205">Permite que todos os outros tráfegos sejam roteados por meio do **AZF1**</span><span class="sxs-lookup"><span data-stu-id="63eec-205">Allows all other traffic to be routed through **AZF1**</span></span> |

### <a name="azsn3udr"></a><span data-ttu-id="63eec-206">azsn3udr</span><span class="sxs-lookup"><span data-stu-id="63eec-206">azsn3udr</span></span>
| <span data-ttu-id="63eec-207">Destino</span><span class="sxs-lookup"><span data-stu-id="63eec-207">Destination</span></span> | <span data-ttu-id="63eec-208">Próximo salto</span><span class="sxs-lookup"><span data-stu-id="63eec-208">Next hop</span></span> | <span data-ttu-id="63eec-209">Explicação</span><span class="sxs-lookup"><span data-stu-id="63eec-209">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="63eec-210">10.0.2.0/24</span><span class="sxs-lookup"><span data-stu-id="63eec-210">10.0.2.0/24</span></span> |<span data-ttu-id="63eec-211">10.0.3.10</span><span class="sxs-lookup"><span data-stu-id="63eec-211">10.0.3.10</span></span> |<span data-ttu-id="63eec-212">Permite que o tráfego **azsn2** ao flua do servidor de aplicativos para o servidor Web por meio do **AZF2**</span><span class="sxs-lookup"><span data-stu-id="63eec-212">Allows traffic to **azsn2** to flow from app server to the webserver through **AZF2**</span></span> |

<span data-ttu-id="63eec-213">Você também precisa criar tabelas de rotas para as sub-redes em **onpremvnet** simularem o datacenter local.</span><span class="sxs-lookup"><span data-stu-id="63eec-213">You also need to create route tables for the subnets in **onpremvnet** to mimic the on-premises datacenter.</span></span>

### <a name="onpremsn1udr"></a><span data-ttu-id="63eec-214">onpremsn1udr</span><span class="sxs-lookup"><span data-stu-id="63eec-214">onpremsn1udr</span></span>
| <span data-ttu-id="63eec-215">Destino</span><span class="sxs-lookup"><span data-stu-id="63eec-215">Destination</span></span> | <span data-ttu-id="63eec-216">Próximo salto</span><span class="sxs-lookup"><span data-stu-id="63eec-216">Next hop</span></span> | <span data-ttu-id="63eec-217">Explicação</span><span class="sxs-lookup"><span data-stu-id="63eec-217">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="63eec-218">192.168.2.0/24</span><span class="sxs-lookup"><span data-stu-id="63eec-218">192.168.2.0/24</span></span> |<span data-ttu-id="63eec-219">192.168.1.4</span><span class="sxs-lookup"><span data-stu-id="63eec-219">192.168.1.4</span></span> |<span data-ttu-id="63eec-220">Permite o tráfego para **onpremsn2** por meio do **OPFW**</span><span class="sxs-lookup"><span data-stu-id="63eec-220">Allows traffic to **onpremsn2** through **OPFW**</span></span> |

### <a name="onpremsn2udr"></a><span data-ttu-id="63eec-221">onpremsn2udr</span><span class="sxs-lookup"><span data-stu-id="63eec-221">onpremsn2udr</span></span>
| <span data-ttu-id="63eec-222">Destino</span><span class="sxs-lookup"><span data-stu-id="63eec-222">Destination</span></span> | <span data-ttu-id="63eec-223">Próximo salto</span><span class="sxs-lookup"><span data-stu-id="63eec-223">Next hop</span></span> | <span data-ttu-id="63eec-224">Explicação</span><span class="sxs-lookup"><span data-stu-id="63eec-224">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="63eec-225">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="63eec-225">10.0.3.0/24</span></span> |<span data-ttu-id="63eec-226">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="63eec-226">192.168.2.4</span></span> |<span data-ttu-id="63eec-227">Permite o tráfego para a sub-rede com suporte no Azure por meio de **OPFW**</span><span class="sxs-lookup"><span data-stu-id="63eec-227">Allows traffic to the backed subnet in Azure through **OPFW**</span></span> |
| <span data-ttu-id="63eec-228">192.168.1.0/24</span><span class="sxs-lookup"><span data-stu-id="63eec-228">192.168.1.0/24</span></span> |<span data-ttu-id="63eec-229">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="63eec-229">192.168.2.4</span></span> |<span data-ttu-id="63eec-230">Permite o tráfego para **onpremsn1** por meio do **OPFW**</span><span class="sxs-lookup"><span data-stu-id="63eec-230">Allows traffic to **onpremsn1** through **OPFW**</span></span> |

## <a name="ip-forwarding"></a><span data-ttu-id="63eec-231">encaminhamento IP</span><span class="sxs-lookup"><span data-stu-id="63eec-231">IP Forwarding</span></span>
<span data-ttu-id="63eec-232">UDR e encaminhamento IP são recursos que podem ser usados em combinação para permitir que dispositivos virtuais sejam usados para controlar o fluxo de tráfego em uma rede virtual do Azure.</span><span class="sxs-lookup"><span data-stu-id="63eec-232">UDR and IP Forwarding are features that you can use in combination to allow virtual appliances to be used to control traffic flow in an Azure VNet.</span></span>  <span data-ttu-id="63eec-233">Um dispositivo virtual é nada mais do que uma VM que executa um aplicativo usado para lidar com o tráfego de rede de alguma forma, como um firewall ou um dispositivo NAT.</span><span class="sxs-lookup"><span data-stu-id="63eec-233">A virtual appliance is nothing more than a VM that runs an application used to handle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="63eec-234">Essa VM de dispositivo virtual deve ser capaz de receber o tráfego de entrada não endereçado a si mesma.</span><span class="sxs-lookup"><span data-stu-id="63eec-234">This virtual appliance VM must be able to receive incoming traffic that is not addressed to itself.</span></span> <span data-ttu-id="63eec-235">Para permitir que uma VM receba o tráfego endereçado a outros destinos, você deve habilitar o Encaminhamento IP para a VM.</span><span class="sxs-lookup"><span data-stu-id="63eec-235">To allow a VM to receive traffic addressed to other destinations, you must enable IP Forwarding for the VM.</span></span> <span data-ttu-id="63eec-236">Esta é uma configuração do Azure, não uma configuração no sistema operacional convidado.</span><span class="sxs-lookup"><span data-stu-id="63eec-236">This is an Azure setting, not a setting in the guest operating system.</span></span> <span data-ttu-id="63eec-237">O dispositivo virtual ainda precisa executar algum tipo de aplicativo para tratar o tráfego de entrada e roteá-la adequadamente.</span><span class="sxs-lookup"><span data-stu-id="63eec-237">Your virtual appliance still needs to run some type of application to handle the incoming traffic, and route it appropriately.</span></span>

<span data-ttu-id="63eec-238">Para saber mais sobre Encaminhamento de IP, visite [O que são Rotas Definidas pelo Usuário e Encaminhamento de IP?](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="63eec-238">To learn more about IP Forwarding, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="63eec-239">Por exemplo, imagine que você tenha a seguinte configuração em uma VNet do Azure:</span><span class="sxs-lookup"><span data-stu-id="63eec-239">As an example, imagine you have the following setup in an Azure vnet:</span></span>

* <span data-ttu-id="63eec-240">A sub-rede **onpremsn1** contém uma VM denominada **onpremvm1**.</span><span class="sxs-lookup"><span data-stu-id="63eec-240">Subnet **onpremsn1** contains a VM named **onpremvm1**.</span></span>
* <span data-ttu-id="63eec-241">A sub-rede **onpremsn2** contém uma VM chamada **onpremvm2**.</span><span class="sxs-lookup"><span data-stu-id="63eec-241">Subnet **onpremsn2** contains a VM named **onpremvm2**.</span></span>
* <span data-ttu-id="63eec-242">Um dispositivo virtual denominado **OPFW** é conectado a **onpremsn1** e **onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="63eec-242">A virtual appliance named **OPFW** is connected to **onpremsn1** and **onpremsn2**.</span></span>
* <span data-ttu-id="63eec-243">Uma rota definida pelo usuário vinculado a **onpremsn1** especifica que todo o tráfego para **onpremsn2** devem ser enviado ao **OPFW**.</span><span class="sxs-lookup"><span data-stu-id="63eec-243">A user defined route linked to **onpremsn1** specifies that all traffic to **onpremsn2** must be sent to **OPFW**.</span></span>

<span data-ttu-id="63eec-244">Nesse ponto, se **onpremvm1** tentar estabelecer uma conexão com **onpremvm2**, será usado o UDR e o tráfego será enviado para **OPFW** como o próximo salto.</span><span class="sxs-lookup"><span data-stu-id="63eec-244">At this point, if **onpremvm1** tries to establish a connection with **onpremvm2**, the UDR will be used and traffic will be sent to **OPFW** as the next hop.</span></span> <span data-ttu-id="63eec-245">Tenha em mente que o destino do pacote real não está sendo alterado, ainda diz **onpremvm2** no destino.</span><span class="sxs-lookup"><span data-stu-id="63eec-245">Keep in mind that the actual packet destination is not being changed, it still says **onpremvm2** is the destination.</span></span> 

<span data-ttu-id="63eec-246">Sem o encaminhamento IP habilitado para **OPFW**, a lógica de rede virtual do Azure removerá os pacotes, já que só permitirá que os pacotes sejam enviados a uma VM se o endereço IP da VM for o destino para o pacote.</span><span class="sxs-lookup"><span data-stu-id="63eec-246">Without IP Forwarding enabled for **OPFW**, the Azure virtual networking logic will drop the packets, since it only allows packets to be sent to a VM if the VM’s IP address is the destination for the packet.</span></span>

<span data-ttu-id="63eec-247">Com o encaminhamento de IP, a lógica de rede virtual do Azure encaminhará os pacotes para OPFW, sem alterar seu endereço de destino original.</span><span class="sxs-lookup"><span data-stu-id="63eec-247">With IP Forwarding, the Azure virtual network logic will forward the packets to OPFW, without changing its original destination address.</span></span> <span data-ttu-id="63eec-248">**OPFW** deve lidar com os pacotes e determinar o que fazer com eles.</span><span class="sxs-lookup"><span data-stu-id="63eec-248">**OPFW** must handle the packets and determine what to do with them.</span></span>

<span data-ttu-id="63eec-249">Para o cenário acima para funcionar, você deve habilitar o encaminhamento de IP em NICs de **OPFW**, **AZF1**, **AZF2**, e **AZF3** que são usadas para rotear (todas as NICs exceto aquelas vinculadas à subrede de gerenciamento).</span><span class="sxs-lookup"><span data-stu-id="63eec-249">For the scenario above to work, you must enable IP Forwarding on the NICs for **OPFW**, **AZF1**, **AZF2**, and **AZF3** that are used for routing (all NICs except the ones linked to the management subnet).</span></span> 

## <a name="firewall-rules"></a><span data-ttu-id="63eec-250">Regras de firewall</span><span class="sxs-lookup"><span data-stu-id="63eec-250">Firewall Rules</span></span>
<span data-ttu-id="63eec-251">Conforme descrito acima, somente encaminhamento de IP garante que os pacotes sejam enviados para os dispositivos virtuais.</span><span class="sxs-lookup"><span data-stu-id="63eec-251">As described above, IP Forwarding only ensures packets are sent to the virtual appliances.</span></span> <span data-ttu-id="63eec-252">O dispositivo ainda precisa decidir o que fazer com esses pacotes.</span><span class="sxs-lookup"><span data-stu-id="63eec-252">Your appliance still needs to decide what to do with those packets.</span></span> <span data-ttu-id="63eec-253">No cenário acima, você precisa criar as seguintes regras em seus dispositivos:</span><span class="sxs-lookup"><span data-stu-id="63eec-253">In the scenario above, you will need to create the following rules in your appliances:</span></span>

### <a name="opfw"></a><span data-ttu-id="63eec-254">OPFW</span><span class="sxs-lookup"><span data-stu-id="63eec-254">OPFW</span></span>
<span data-ttu-id="63eec-255">OPFW representa um dispositivo local que contém as seguintes regras:</span><span class="sxs-lookup"><span data-stu-id="63eec-255">OPFW represents an on-premises device containing the following rules:</span></span>

* <span data-ttu-id="63eec-256">**Rota**: todo o tráfego para 10.0.0.0/16 (**azurevnet**) deve ser enviado pelo túnel **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="63eec-256">**Route**: All traffic to 10.0.0.0/16 (**azurevnet**) must be sent through tunnel **ONPREMAZURE**.</span></span>
* <span data-ttu-id="63eec-257">**Política**: permitir todo o tráfego bidirecional entre **port2** e **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="63eec-257">**Policy**: Allow all bidirectional traffic between **port2** and **ONPREMAZURE**.</span></span>

### <a name="azf1"></a><span data-ttu-id="63eec-258">AZF1</span><span class="sxs-lookup"><span data-stu-id="63eec-258">AZF1</span></span>
<span data-ttu-id="63eec-259">O AZF1 representa um dispositivo virtual do Azure que contém as seguintes regras:</span><span class="sxs-lookup"><span data-stu-id="63eec-259">AZF1 represents an Azure virtual appliance containing the following rules:</span></span>

* <span data-ttu-id="63eec-260">**Política**: permitir todo o tráfego bidirecional entre **port1** e **port2**.</span><span class="sxs-lookup"><span data-stu-id="63eec-260">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

### <a name="azf2"></a><span data-ttu-id="63eec-261">AZF2</span><span class="sxs-lookup"><span data-stu-id="63eec-261">AZF2</span></span>
<span data-ttu-id="63eec-262">O AZF2 representa um dispositivo virtual do Azure que contém as seguintes regras:</span><span class="sxs-lookup"><span data-stu-id="63eec-262">AZF2 represents an Azure virtual appliance containing the following rules:</span></span>

* <span data-ttu-id="63eec-263">**Rota**: todo o tráfego para 10.0.0.0/16 (**onpremvnet**) deve ser enviado para o endereço IP do gateway do Azure (ou seja, 10.0.0.1) por meio de **port1**.</span><span class="sxs-lookup"><span data-stu-id="63eec-263">**Route**: All traffic to 10.0.0.0/16 (**onpremvnet**) must be sent to the Azure gateway IP address (i.e. 10.0.0.1) through **port1**.</span></span>
* <span data-ttu-id="63eec-264">**Política**: permitir todo o tráfego bidirecional entre **port1** e **port2**.</span><span class="sxs-lookup"><span data-stu-id="63eec-264">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

## <a name="network-security-groups-nsgs"></a><span data-ttu-id="63eec-265">Grupos de segurança de rede (NSG)</span><span class="sxs-lookup"><span data-stu-id="63eec-265">Network Security Groups (NSGs)</span></span>
<span data-ttu-id="63eec-266">Nesse cenário, os NSGs não estão sendo usados.</span><span class="sxs-lookup"><span data-stu-id="63eec-266">In this scenario, NSGs are not being used.</span></span> <span data-ttu-id="63eec-267">No entanto, você pode aplicar NSGs a cada sub-rede para restringir o tráfego de entrada e saído.</span><span class="sxs-lookup"><span data-stu-id="63eec-267">However, you could apply NSGs to each subnet to restrict incoming and outgoing traffic.</span></span> <span data-ttu-id="63eec-268">Por exemplo, você pode aplicar as seguintes regras de NSG à sub-rede FW externa.</span><span class="sxs-lookup"><span data-stu-id="63eec-268">For instance, you could apply the following NSG rules to the external FW subnet.</span></span>

<span data-ttu-id="63eec-269">**Entrada**</span><span class="sxs-lookup"><span data-stu-id="63eec-269">**Incoming**</span></span>

* <span data-ttu-id="63eec-270">Permita todo o tráfego TCP da Internet para a porta 80 em qualquer VM na sub-rede.</span><span class="sxs-lookup"><span data-stu-id="63eec-270">Allow all TCP traffic from the Internet to port 80 on any VM in the subnet.</span></span>
* <span data-ttu-id="63eec-271">Negue todos os outros tráfegos da Internet.</span><span class="sxs-lookup"><span data-stu-id="63eec-271">Deny all other traffic from the Internet.</span></span>

<span data-ttu-id="63eec-272">**Saída**</span><span class="sxs-lookup"><span data-stu-id="63eec-272">**Outgoing**</span></span>

* <span data-ttu-id="63eec-273">Negue todo tráfego para a Internet.</span><span class="sxs-lookup"><span data-stu-id="63eec-273">Deny all traffic to the Internet.</span></span>

## <a name="high-level-steps"></a><span data-ttu-id="63eec-274">Etapas de alto nível</span><span class="sxs-lookup"><span data-stu-id="63eec-274">High level steps</span></span>
<span data-ttu-id="63eec-275">Para implantar este cenário, siga as etapas de alto nível abaixo.</span><span class="sxs-lookup"><span data-stu-id="63eec-275">To deploy this scenario, follow the high level steps below.</span></span>

1. <span data-ttu-id="63eec-276">Faça logon na sua Assinatura do Azure.</span><span class="sxs-lookup"><span data-stu-id="63eec-276">Login to your Azure Subscription.</span></span>
2. <span data-ttu-id="63eec-277">Se você desejar implantar uma VNet para imitar a rede local, provisione os recursos que fazem parte do **ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="63eec-277">If you want to deploy a VNet to mimic the on-premises network, provision the resources that are part of **ONPREMRG**.</span></span>
3. <span data-ttu-id="63eec-278">Provisione os recursos que fazem parte do **AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="63eec-278">Provision the resources that are part of **AZURERG**.</span></span>
4. <span data-ttu-id="63eec-279">Provisionar o túnel de **onpremvnet** para **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="63eec-279">Provision the tunnel from **onpremvnet** to **azurevnet**.</span></span>
5. <span data-ttu-id="63eec-280">Depois que todos os recursos forem provisionados, faça logon em **onpremvm2** e faça ping do 10.0.3.101 para testar a conectividade entre **onpremsn2** e **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="63eec-280">Once all resources are provisioned, log on to **onpremvm2** and ping 10.0.3.101 to test connectivity between **onpremsn2** and **azsn3**.</span></span>

