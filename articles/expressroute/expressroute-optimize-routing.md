---
title: 'Otimizar o roteamento de ExpressRoute: Azure | Microsoft Docs'
description: "Esta página fornece detalhes sobre como otimizar o roteamento quando houver mais de um circuito do ExpressRoute que se conecta entre a Microsoft e a rede corporativa."
documentationcenter: na
services: expressroute
author: charwen
manager: carmonm
editor: 
ms.assetid: fca53249-d9c3-4cff-8916-f8749386a4dd
ms.service: expressroute
ms.devlang: na
ms.topic: get-started-article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 04/06/2017
ms.author: charwen
ms.openlocfilehash: c3a85b9445d69330c3f6c7d298169efddb6ecca0
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="optimize-expressroute-routing"></a><span data-ttu-id="9d2a5-103">Otimizar o roteamento do ExpressRoute</span><span class="sxs-lookup"><span data-stu-id="9d2a5-103">Optimize ExpressRoute Routing</span></span>
<span data-ttu-id="9d2a5-104">Quando você tem vários circuitos de ExpressRoute, tem mais de um caminho para se conectar à Microsoft.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-104">When you have multiple ExpressRoute circuits, you have more than one path to connect to Microsoft.</span></span> <span data-ttu-id="9d2a5-105">Portanto, pode ocorrer um roteamento abaixo do ideal, ou seja, o tráfego pode levar um caminho mais longo para acessar a Microsoft e esta para acessar a sua rede.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-105">As a result, suboptimal routing may happen - that is, your traffic may take a longer path to reach Microsoft, and Microsoft to your network.</span></span> <span data-ttu-id="9d2a5-106">Quanto maior o caminho de rede, maior será a latência.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-106">The longer the network path, the higher the latency.</span></span> <span data-ttu-id="9d2a5-107">A latência tem impacto direto na experiência de usuário e no desempenho do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-107">Latency has direct impact on application performance and user experience.</span></span> <span data-ttu-id="9d2a5-108">Este artigo ilustra esse problema e explica como otimizar o roteamento usando tecnologias de roteamento padrão.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-108">This article will illustrate this problem and explain how to optimize routing using the standard routing technologies.</span></span>

## <a name="suboptimal-routing-from-customer-to-microsoft"></a><span data-ttu-id="9d2a5-109">Roteamento abaixo do ideal do cliente para a Microsoft</span><span class="sxs-lookup"><span data-stu-id="9d2a5-109">Suboptimal routing from customer to Microsoft</span></span>
<span data-ttu-id="9d2a5-110">Vamos examinar o problema de roteamento usando um exemplo.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-110">Let's take a close look at the routing problem by an example.</span></span> <span data-ttu-id="9d2a5-111">Imagine que você tem dois escritórios nos EUA, um em Los Angeles e um em Nova York.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-111">Imagine you have two offices in the US, one in Los Angeles and one in New York.</span></span> <span data-ttu-id="9d2a5-112">Seus escritórios estão conectados em uma WAN (rede de longa distância), que pode ser sua própria rede backbone ou VPN de IP do provedor de serviços.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-112">Your offices are connected on a Wide Area Network (WAN), which can be either your own backbone network or your service provider's IP VPN.</span></span> <span data-ttu-id="9d2a5-113">Você tem dois circuitos de ExpressRoute, um no Oeste dos EUA e outro no Leste dos EUA, que também estão conectados à WAN.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-113">You have two ExpressRoute circuits, one in US West and one in US East, that are also connected on the WAN.</span></span> <span data-ttu-id="9d2a5-114">Obviamente, você tem dois caminhos para se conectar à rede da Microsoft.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-114">Obviously, you have two paths to connect to the Microsoft network.</span></span> <span data-ttu-id="9d2a5-115">Agora imagine que você tem a implantação do Azure (por exemplo, o Serviço de Aplicativo do Azure) no Oeste dos EUA e no Leste dos EUA.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-115">Now imagine you have Azure deployment (for example, Azure App Service) in both US West and US East.</span></span> <span data-ttu-id="9d2a5-116">Sua intenção é conectar seus usuários em Los Angeles ao Azure no Oeste dos EUA e seus usuários em Nova York ao Azure no Leste dos EUA porque seu administrador de serviço anuncia que os usuários em cada escritório acessarão os serviços do Azure mais próximos para uma melhor experiência.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-116">Your intention is to connect your users in Los Angeles to Azure US West and your users in New York to Azure US East because your service admin advertises that users in each office access the nearby Azure services for optimal experiences.</span></span> <span data-ttu-id="9d2a5-117">Infelizmente, o plano funciona bem para os usuários da Costa Leste, mas não para os usuários da Costa Oeste.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-117">Unfortunately, the plan works out well for the east coast users but not for the west coast users.</span></span> <span data-ttu-id="9d2a5-118">A causa do problema é a seguinte:</span><span class="sxs-lookup"><span data-stu-id="9d2a5-118">The cause of the problem is the following.</span></span> <span data-ttu-id="9d2a5-119">Em cada circuito do ExpressRoute, anunciamos a você tanto o prefixo do Azure no Leste dos EUA (23.100.0.0/16) quanto o prefixo do Azure no Oeste dos EUA (13.100.0.0/16).</span><span class="sxs-lookup"><span data-stu-id="9d2a5-119">On each ExpressRoute circuit, we advertise to you both the prefix in Azure US East (23.100.0.0/16) and the prefix in Azure US West (13.100.0.0/16).</span></span> <span data-ttu-id="9d2a5-120">Se você não souber qual prefixo é de que região, não conseguirá tratá-los de maneira diferente.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-120">If you don't know which prefix is from which region, you are not able to treat it differently.</span></span> <span data-ttu-id="9d2a5-121">Sua rede WAN pode pensar que ambos os prefixos são mais próximos do Leste dos EUA que do Oeste dos EUA e, portanto, rotear os usuários de ambos os escritórios para o circuito de ExpressRoute no Leste dos EUA.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-121">Your WAN network may think both of the prefixes are closer to US East than US West and therefore route both office users to the ExpressRoute circuit in US East.</span></span> <span data-ttu-id="9d2a5-122">No final, você terá muitos usuários insatisfeitos no escritório de Los Angeles.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-122">In the end, you will have many unhappy users in the Los Angeles office.</span></span>

![Problema de ExpressRoute, Caso 1 - qualidade inferior de roteamento do cliente para a Microsoft](./media/expressroute-optimize-routing/expressroute-case1-problem.png)

### <a name="solution-use-bgp-communities"></a><span data-ttu-id="9d2a5-124">Solução: usar comunidades BGP</span><span class="sxs-lookup"><span data-stu-id="9d2a5-124">Solution: use BGP Communities</span></span>
<span data-ttu-id="9d2a5-125">Para otimizar o roteamento nos dois usuários, você precisa saber qual é o prefixo do Azure no Oeste dos EUA e no Leste dos EUA.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-125">To optimize routing for both office users, you need to know which prefix is from Azure US West and which from Azure US East.</span></span> <span data-ttu-id="9d2a5-126">Nós codificamos essas informações usando [Valores da Comunidade BGP](expressroute-routing.md).</span><span class="sxs-lookup"><span data-stu-id="9d2a5-126">We encode this information by using [BGP Community values](expressroute-routing.md).</span></span> <span data-ttu-id="9d2a5-127">Atribuímos um valor de Comunidade BGP exclusivo para cada região do Azure, por exemplo, "12076:51004" para o Leste dos EUA, "12076:51006" para o Oeste dos EUA.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-127">We've assigned a unique BGP Community value to each Azure region, e.g. "12076:51004" for US East, "12076:51006" for US West.</span></span> <span data-ttu-id="9d2a5-128">Agora que você sabe que prefixo é de que região do Azure, pode configurar qual circuito de ExpressRoute deve ser preferencial.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-128">Now that you know which prefix is from which Azure region, you can configure which ExpressRoute circuit should be preferred.</span></span> <span data-ttu-id="9d2a5-129">Como usamos o BGP para trocar informações de roteamento, você pode usar a preferência de local do BGP para influenciar o roteamento.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-129">Because we use the BGP to exchange routing info, you can use BGP's Local Preference to influence routing.</span></span> <span data-ttu-id="9d2a5-130">Em nosso exemplo, você pode atribuir um valor maior de preferência de local a 13.100.0.0/16 no Oeste dos EUA que no Leste dos EUA e, da mesma forma, um valor mais alto de preferência de local a 23.100.0.0/16 no Leste dos EUA que no Oeste dos EUA.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-130">In our example, you can assign a higher local preference value to 13.100.0.0/16 in US West than in US East, and similarly, a higher local preference value to 23.100.0.0/16 in US East than in US West.</span></span> <span data-ttu-id="9d2a5-131">Essa configuração fará com que, quando ambos os caminhos para a Microsoft estiverem disponíveis, os usuários em Los Angeles usarão o circuito de ExpressRoute no Oeste dos EUA para se conectar ao Azure no Oeste dos EUA e os usuários em Nova York usarão o ExpressRoute no Leste dos EUA para se conectar ao Azure no Leste dos EUA.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-131">This configuration will make sure that, when both paths to Microsoft are available, your users in Los Angeles will take the ExpressRoute circuit in US West to connect to Azure US West whereas your users in New York take the ExpressRoute in US East to Azure US East.</span></span> <span data-ttu-id="9d2a5-132">O roteamento é otimizado em ambos os lados.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-132">Routing is optimized on both sides.</span></span> 

![Solução de ExpressRoute, Caso 1 - usar Comunidades BGP](./media/expressroute-optimize-routing/expressroute-case1-solution.png)

> [!NOTE]
> <span data-ttu-id="9d2a5-134">A mesma técnica, usando a Preferência Local, pode ser aplicada ao roteamento de cliente para Rede Virtual do Azure.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-134">The same technique, using Local Preference, can be applied to routing from customer to Azure Virtual Network.</span></span> <span data-ttu-id="9d2a5-135">Não marcamos o valor da Comunidade BGP para os prefixos anunciados do Azure para a rede.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-135">We don't tag BGP Community value to the prefixes advertised from Azure to your network.</span></span> <span data-ttu-id="9d2a5-136">No entanto, como você sabe qual implantação da Rede Virtual está próxima de qual escritório, pode configurar os roteadores adequadamente para preferir um circuito do ExpressRoute em vez do outro.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-136">However, since you know which of your Virtual Network deployment is close to which of your office, you can configure your routers accordingly to prefer one ExpressRoute circuit to another.</span></span>
>
>

## <a name="suboptimal-routing-from-microsoft-to-customer"></a><span data-ttu-id="9d2a5-137">Roteamento abaixo do ideal da Microsoft para o cliente</span><span class="sxs-lookup"><span data-stu-id="9d2a5-137">Suboptimal routing from Microsoft to customer</span></span>
<span data-ttu-id="9d2a5-138">Aqui está outro exemplo em que conexões da Microsoft usam um caminho mais longo para acessar a sua rede.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-138">Here is another example where connections from Microsoft take a longer path to reach your network.</span></span> <span data-ttu-id="9d2a5-139">Nesse caso, você usa servidores Exchange locais e o Exchange Online em um [ambiente híbrido](https://technet.microsoft.com/library/jj200581%28v=exchg.150%29.aspx).</span><span class="sxs-lookup"><span data-stu-id="9d2a5-139">In this case, you use on-premises Exchange servers and Exchange Online in a [hybrid environment](https://technet.microsoft.com/library/jj200581%28v=exchg.150%29.aspx).</span></span> <span data-ttu-id="9d2a5-140">Seus escritórios estão conectados a uma WAN.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-140">Your offices are connected to a WAN.</span></span> <span data-ttu-id="9d2a5-141">Você anuncia os prefixos dos seus servidores locais nos dois escritórios à Microsoft por meio de dois circuitos de ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-141">You advertise the prefixes of your on-premises servers in both of your offices to Microsoft through the two ExpressRoute circuits.</span></span> <span data-ttu-id="9d2a5-142">O Exchange Online irá iniciar conexões com os servidores locais em situações como migração de caixa de correio.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-142">Exchange Online will initiate connections to the on-premises servers in cases such as mailbox migration.</span></span> <span data-ttu-id="9d2a5-143">Infelizmente, a conexão com o escritório de Los Angeles é roteada para o circuito do ExpressRoute no Leste dos EUA antes de percorrer o continente inteiro de volta à Costa Oeste.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-143">Unfortunately, the connection to your Los Angeles office is routed to the ExpressRoute circuit in US East before traversing the entire continent back to the west coast.</span></span> <span data-ttu-id="9d2a5-144">A causa do problema é semelhante à do primeiro caso.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-144">The cause of the problem is similar to the first one.</span></span> <span data-ttu-id="9d2a5-145">Sem qualquer dica, a rede da Microsoft não pode determinar qual prefixo do cliente está próximo ao Leste dos EUA e qual está próximo ao Oeste dos EUA.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-145">Without any hint, the Microsoft network can't tell which customer prefix is close to US East and which one is close to US West.</span></span> <span data-ttu-id="9d2a5-146">Ela acaba escolhendo o caminho errado para seu escritório em Los Angeles.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-146">It happens to pick the wrong path to your office in Los Angeles.</span></span>

![ExpressRoute, Caso 2 - qualidade inferior de roteamento da Microsoft para o cliente](./media/expressroute-optimize-routing/expressroute-case2-problem.png)

### <a name="solution-use-as-path-prepending"></a><span data-ttu-id="9d2a5-148">Solução: usar precedência de caminho AS</span><span class="sxs-lookup"><span data-stu-id="9d2a5-148">Solution: use AS PATH prepending</span></span>
<span data-ttu-id="9d2a5-149">Há duas soluções para o problema.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-149">There are two solutions to the problem.</span></span> <span data-ttu-id="9d2a5-150">A primeira é simplesmente anunciar o prefixo local para o escritório de Los Angeles, 177.2.0.0/31 no circuito de ExpressRoute no Oeste dos EUA e o prefixo local para o escritório de Nova York, 177.2.0.2/31, no circuito de ExpressRoute no Leste dos EUA.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-150">The first one is that you simply advertise your on-premises prefix for your Los Angeles office, 177.2.0.0/31, on the ExpressRoute circuit in US West and your on-premises prefix for your New York office, 177.2.0.2/31, on the ExpressRoute circuit in US East.</span></span> <span data-ttu-id="9d2a5-151">Como resultado, sobra apenas um caminho para a Microsoft se conectar a cada um dos seus escritórios.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-151">As a result, there is only one path for Microsoft to connect to each of your offices.</span></span> <span data-ttu-id="9d2a5-152">Não há nenhuma ambiguidade e o roteamento é otimizado.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-152">There is no ambiguity and routing is optimized.</span></span> <span data-ttu-id="9d2a5-153">Com esse design, você precisa pensar sobre a estratégia de failover.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-153">With this design, you need to think about your failover strategy.</span></span> <span data-ttu-id="9d2a5-154">Se o caminho para a Microsoft pelo ExpressRoute for interrompido, você precisa fazer com que o Exchange Online ainda possa se conectar aos servidores locais.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-154">In the event that the path to Microsoft via ExpressRoute is broken, you need to make sure that Exchange Online can still connect to your on-premises servers.</span></span> 

<span data-ttu-id="9d2a5-155">A segunda solução é continuar a anunciar ambos os prefixos em ambos os circuitos do ExpressRoute e, além disso, fornecer uma dica de qual prefixo é mais próximo de qual escritório.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-155">The second solution is that you continue to advertise both of the prefixes on both ExpressRoute circuits, and in addition you give us a hint of which prefix is close to which one of your offices.</span></span> <span data-ttu-id="9d2a5-156">Como damos suporte a precedência de caminho AS do BGP, você pode configurar do caminho AS para o prefixo a fim de influenciar o roteamento.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-156">Because we support BGP AS Path prepending, you can configure the AS Path for your prefix to influence routing.</span></span> <span data-ttu-id="9d2a5-157">Neste exemplo, você pode aumentar o caminho AS de 172.2.0.0/31 no Leste dos EUA para que passemos a preferir circuito do ExpressRoute no Oeste dos EUA para o tráfego destinado a esse prefixo (já que a nossa rede pensará que o caminho para esse prefixo é mais curto nesse lado).</span><span class="sxs-lookup"><span data-stu-id="9d2a5-157">In this example, you can lengthen the AS PATH for 172.2.0.0/31 in US East so that we will prefer the ExpressRoute circuit in US West for traffic destined for this prefix (as our network will think the path to this prefix is shorter in the west).</span></span> <span data-ttu-id="9d2a5-158">Da mesma forma, você pode aumentar o caminho AS de 172.2.0.2/31 no Oeste dos EUA para que vejamos o circuito do ExpressRoute no Leste dos EUA como preferencial.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-158">Similarly you can lengthen the AS PATH for 172.2.0.2/31 in US West so that we'll prefer the ExpressRoute circuit in US East.</span></span> <span data-ttu-id="9d2a5-159">O roteamento é otimizado para ambos os escritórios.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-159">Routing is optimized for both offices.</span></span> <span data-ttu-id="9d2a5-160">Com esse design, se um circuito do ExpressRoute for interrompido, o Exchange Online poderá ainda acessá-lo por meio de outro circuito do ExpressRoute e sua WAN.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-160">With this design, if one ExpressRoute circuit is broken, Exchange Online can still reach you via another ExpressRoute circuit and your WAN.</span></span> 

> [!IMPORTANT]
> <span data-ttu-id="9d2a5-161">Removemos números AS particulares no caminho AS para os prefixos recebidos no Microsoft Peering.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-161">We remove private AS numbers in the AS PATH for the prefixes received on Microsoft Peering.</span></span> <span data-ttu-id="9d2a5-162">Você precisa anexar números AS públicos como números no caminho AS para influenciar o roteamento para o Microsoft Peering.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-162">You need to append public AS numbers in the AS PATH to influence routing for Microsoft Peering.</span></span>
> 
> 

![Solução de ExpressRoute, caso 2 - usar precedência de AS PATH](./media/expressroute-optimize-routing/expressroute-case2-solution.png)

> [!NOTE]
> <span data-ttu-id="9d2a5-164">Embora os exemplos fornecidos aqui sejam para a Microsoft e os emparelhamentos Públicos, oferecemos suporte para os mesmos recursos do emparelhamento Privado.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-164">While the examples given here are for Microsoft and Public peerings, we do support the same capabilities for the Private peering.</span></span> <span data-ttu-id="9d2a5-165">Além disso, o prefixo AS Path funciona em um único circuito do ExpressRoute para influenciar a seleção dos caminhos primário e secundário.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-165">Also, the AS Path prepending works within one single ExpressRoute circuit, to influence the selection of the primary and secondary paths.</span></span>
> 
> 

## <a name="suboptimal-routing-between-virtual-networks"></a><span data-ttu-id="9d2a5-166">Qualidade inferior de roteamento entre redes virtuais</span><span class="sxs-lookup"><span data-stu-id="9d2a5-166">Suboptimal routing between virtual networks</span></span>
<span data-ttu-id="9d2a5-167">Com o ExpressRoute, você pode habilitar a comunicação de Rede Virtual a Rede Virtual (que também é conhecida como "VNet") vinculando-as a um circuito do ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-167">With ExpressRoute, you can enable Virtual Network to Virtual Network (which is also known as "VNet") communication by linking them to an ExpressRoute circuit.</span></span> <span data-ttu-id="9d2a5-168">Quando você os vincula a vários circuitos do ExpressRoute, o roteamento abaixo do ideal pode ocorrer entre as redes virtuais.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-168">When you link them to multiple ExpressRoute circuits, suboptimal routing can happen between the VNets.</span></span> <span data-ttu-id="9d2a5-169">Vamos considerar um exemplo.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-169">Let's consider an example.</span></span> <span data-ttu-id="9d2a5-170">Você tem dois circuitos de ExpressRoute, um no Oeste dos EUA e outro no Leste dos EUA.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-170">You have two ExpressRoute circuits, one in US West and one in US East.</span></span> <span data-ttu-id="9d2a5-171">Em cada região, você tem duas VNets.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-171">In each region, you have two VNets.</span></span> <span data-ttu-id="9d2a5-172">Os servidores Web são implantados em uma VNet e os servidores de aplicativos na outra.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-172">Your web servers are deployed in one VNet and application servers in the other.</span></span> <span data-ttu-id="9d2a5-173">Para redundância, você pode vincular as duas redes virtuais em cada região ao circuito do ExpressRoute local e ao circuito do ExpressRoute remoto.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-173">For redundancy, you link the two VNets in each region to both the local ExpressRoute circuit and the remote ExpressRoute circuit.</span></span> <span data-ttu-id="9d2a5-174">Como pode ser visto abaixo, de cada VNet, há dois caminhos para a outra VNet.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-174">As can be seen below, from each VNet there are two paths to the other VNet.</span></span> <span data-ttu-id="9d2a5-175">As VNets não sabem qual circuito do ExpressRoute é local e qual é remoto.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-175">The VNets don't know which ExpressRoute circuit is local and which one is remote.</span></span> <span data-ttu-id="9d2a5-176">Consequentemente, como realizam o roteamento ECMP (Equal-Cost-Multi-Path) para fazer o balanceamento de carga de tráfego entre VNets, alguns fluxos de tráfego usarão o caminho mais longo e são roteados no circuito do ExpressRoute remoto.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-176">Consequently as they do Equal-Cost-Multi-Path (ECMP) routing to load-balance inter-VNet traffic, some traffic flows will take the longer path and get routed at the remote ExpressRoute circuit.</span></span>

![ExpressRoute, Caso 3 - qualidade inferior de roteamento entre redes virtuais](./media/expressroute-optimize-routing/expressroute-case3-problem.png)

### <a name="solution-assign-a-high-weight-to-local-connection"></a><span data-ttu-id="9d2a5-178">Solução: atribuir um peso alto à conexão local</span><span class="sxs-lookup"><span data-stu-id="9d2a5-178">Solution: assign a high weight to local connection</span></span>
<span data-ttu-id="9d2a5-179">A solução é simples.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-179">The solution is simple.</span></span> <span data-ttu-id="9d2a5-180">Como você sabe onde as redes virtuais e os circuitos estão, pode indicar qual caminho cada VNet deve preferir.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-180">Since you know where the VNets and the circuits are, you can tell us which path each VNet should prefer.</span></span> <span data-ttu-id="9d2a5-181">Especificamente para esse exemplo, você atribui um peso mais alto à conexão local do que à conexão remota (consulte o exemplo de configuração [aqui](expressroute-howto-linkvnet-arm.md#modify-a-virtual-network-connection)).</span><span class="sxs-lookup"><span data-stu-id="9d2a5-181">Specifically for this example, you assign a higher weight to the local connection than to the remote connection (see the configuration example [here](expressroute-howto-linkvnet-arm.md#modify-a-virtual-network-connection)).</span></span> <span data-ttu-id="9d2a5-182">Quando uma VNet receber o prefixo da outra VNet em várias conexões, ela preferirá a conexão com o peso mais alto para enviar o tráfego destinado a esse prefixo.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-182">When a VNet receives the prefix of the other VNet on multiple connections it will prefer the connection with the highest weight to send traffic destined for that prefix.</span></span>

![Solução de ExpressRoute, Caso 3 - atribuir peso alto à conexão local](./media/expressroute-optimize-routing/expressroute-case3-solution.png)

> [!NOTE]
> <span data-ttu-id="9d2a5-184">Você também poderá influenciar o roteamento da VNet à rede local se tiver vários circuitos do ExpressRoute, configurando o peso de uma conexão em vez de aplicar AS PATH para prefixação, uma técnica descrita no segundo cenário acima.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-184">You can also influence routing from VNet to your on-premises network, if you have multiple ExpressRoute circuits, by configuring the weight of a connection instead of applying AS PATH prepending, a technique described in the second scenario above.</span></span> <span data-ttu-id="9d2a5-185">Para cada prefixo, sempre veremos o peso de conexão antes do comprimento do Caminho AS ao decidir como enviar o tráfego.</span><span class="sxs-lookup"><span data-stu-id="9d2a5-185">For each prefix, we will always look at the connection weight before the AS Path length when deciding how to send traffic.</span></span>
>
>
