---
title: "Saída JSON para o Stream Analytics | Microsoft Docs"
description: "Saiba como o Stream Analytics pode direcionar o Azure Cosmos DB para uma saída em JSON, para arquivamento de dados e consultas de baixa latência em dados JSON não estruturados."
keywords: "Saída em JSON"
documentationcenter: 
services: stream-analytics,documentdb
author: samacha
manager: jhubbard
editor: cgronlun
ms.assetid: 5d2a61a6-0dbf-4f1b-80af-60a80eb25dd1
ms.service: stream-analytics
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: data-services
ms.date: 03/28/2017
ms.author: samacha
ms.openlocfilehash: cc80b0080c806541362a1ef2d71b95862bd51ca2
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/29/2017
---
# <a name="target-azure-cosmos-db-for-json-output-from-stream-analytics"></a><span data-ttu-id="5801b-104">Direcionar o Azure Cosmos DB para uma saída em JSON no Stream Analytics</span><span class="sxs-lookup"><span data-stu-id="5801b-104">Target Azure Cosmos DB for JSON output from Stream Analytics</span></span>
<span data-ttu-id="5801b-105">O Stream Analytics pode direcionar o [Azure Cosmos DB](https://azure.microsoft.com/services/documentdb/) para uma saída em JSON, possibilitando o arquivamento de dados e consultas de baixa latência em dados JSON não estruturados.</span><span class="sxs-lookup"><span data-stu-id="5801b-105">Stream Analytics can target [Azure Cosmos DB](https://azure.microsoft.com/services/documentdb/) for JSON output, enabling data archiving and low-latency queries on unstructured JSON data.</span></span> <span data-ttu-id="5801b-106">Este documento aborda algumas práticas recomendadas para implementar essa configuração.</span><span class="sxs-lookup"><span data-stu-id="5801b-106">This document covers some best practices for implementing this configuration.</span></span>

<span data-ttu-id="5801b-107">Para aqueles que não estão familiarizados com o Cosmos DB, consulte [Roteiro de aprendizagem do Azure Cosmos DB](https://azure.microsoft.com/documentation/learning-paths/documentdb/) para obter uma introdução.</span><span class="sxs-lookup"><span data-stu-id="5801b-107">For those who are unfamiliar with Cosmos DB, take a look at [Azure Cosmos DB’s learning path](https://azure.microsoft.com/documentation/learning-paths/documentdb/) to get started.</span></span> 

<span data-ttu-id="5801b-108">Observação: atualmente, não há suporte para coleções do Cosmos DB baseados na API do Mongo DB.</span><span class="sxs-lookup"><span data-stu-id="5801b-108">Note: Mongo DB API based Cosmos DB collections is currently not supported.</span></span> 

## <a name="basics-of-cosmos-db-as-an-output-target"></a><span data-ttu-id="5801b-109">Conceitos básicos do Cosmos DB como um destino de saída</span><span class="sxs-lookup"><span data-stu-id="5801b-109">Basics of Cosmos DB as an output target</span></span>
<span data-ttu-id="5801b-110">A saída do Azure Cosmos DB no Stream Analytics permite a gravação dos resultados do processamento de fluxo como uma saída em JSON nas coleções do Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="5801b-110">The Azure Cosmos DB output in Stream Analytics enables writing your stream processing results as JSON output into your Cosmos DB collection(s).</span></span> <span data-ttu-id="5801b-111">O Stream Analytics não cria coleções em seu banco de dados, em vez disso, ele exige a criação delas antecipadamente.</span><span class="sxs-lookup"><span data-stu-id="5801b-111">Stream Analytics does not create collections in your database, instead requiring you to create them upfront.</span></span> <span data-ttu-id="5801b-112">Isso serve para que os custos de cobrança das coleções de Cosmos DB sejam transparentes e para que você possa ajustar o desempenho, a consistência e a capacidade de suas coleções diretamente com as [APIs do Cosmos DB](https://msdn.microsoft.com/library/azure/dn781481.aspx).</span><span class="sxs-lookup"><span data-stu-id="5801b-112">This is so that the billing costs of Cosmos DB collections are transparent to you, and so that you can tune the performance, consistency and capacity of your collections directly using the [Cosmos DB APIs](https://msdn.microsoft.com/library/azure/dn781481.aspx).</span></span> <span data-ttu-id="5801b-113">Recomendamos o uso de um Banco de Dados do Cosmos DB por trabalho de streaming, a fim de separar logicamente as coleções de um trabalho de streaming.</span><span class="sxs-lookup"><span data-stu-id="5801b-113">We recommend using one Cosmos DB Database per streaming job to logically separate your collections for a streaming job.</span></span>

<span data-ttu-id="5801b-114">Algumas das opções de coleção do Cosmos DB são detalhadas abaixo.</span><span class="sxs-lookup"><span data-stu-id="5801b-114">Some of the Cosmos DB collection options are detailed below.</span></span>

## <a name="tune-consistency-availability-and-latency"></a><span data-ttu-id="5801b-115">Ajustar a consistência, a disponibilidade e a latência</span><span class="sxs-lookup"><span data-stu-id="5801b-115">Tune consistency, availability, and latency</span></span>
<span data-ttu-id="5801b-116">Para atender aos requisitos do aplicativo, o Cosmos DB permite o ajuste do banco de dados e das coleções, além de compensações entre consistência, disponibilidade e latência.</span><span class="sxs-lookup"><span data-stu-id="5801b-116">To match your application requirements, Cosmos DB allows you to fine tune the database and collections and make trade-offs between consistency, availability and latency.</span></span> <span data-ttu-id="5801b-117">Dependendo dos níveis de consistência de leitura exigidos pelo seu cenário em relação à latência de leitura e de gravação, você poderá escolher um nível de consistência em sua conta de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="5801b-117">Depending on what levels of read consistency your scenario needs against read and write latency, you can choose a consistency level on your database account.</span></span> <span data-ttu-id="5801b-118">Também por padrão, o Cosmos DB habilita a indexação síncrona em cada operação CRUD da coleção.</span><span class="sxs-lookup"><span data-stu-id="5801b-118">Also by default, Cosmos DB enables synchronous indexing on each CRUD operation to your collection.</span></span> <span data-ttu-id="5801b-119">Essa é outra opção útil para controlar o desempenho de leitura/gravação no Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="5801b-119">This is another useful option to control the write/read performance in Cosmos DB.</span></span> <span data-ttu-id="5801b-120">Para saber mais sobre esse tópico, confira o artigo [Alterar os níveis de consistência do banco de dados e de consulta](../documentdb/documentdb-consistency-levels.md) .</span><span class="sxs-lookup"><span data-stu-id="5801b-120">For further information on this topic, review the [change your database and query consistency levels](../documentdb/documentdb-consistency-levels.md) article.</span></span>

## <a name="upserts-from-stream-analytics"></a><span data-ttu-id="5801b-121">Inserções e atualizações a partir do Stream Analytics</span><span class="sxs-lookup"><span data-stu-id="5801b-121">Upserts from Stream Analytics</span></span>
<span data-ttu-id="5801b-122">A integração do Stream Analytics ao Cosmos DB permite inserir ou atualizar registros na coleção do Cosmos DB de acordo com determinada coluna de ID do Documento.</span><span class="sxs-lookup"><span data-stu-id="5801b-122">Stream Analytics integration with Cosmos DB allows you to insert or update records in your Cosmos DB collection based on a given Document ID column.</span></span> <span data-ttu-id="5801b-123">Isso também é chamado de *Upsert*.</span><span class="sxs-lookup"><span data-stu-id="5801b-123">This is also referred to as an *Upsert*.</span></span>

<span data-ttu-id="5801b-124">O Stream Analytics utiliza uma abordagem Upsert otimista, na qual as atualizações são feitas somente quando a inserção falha devido a um conflito de ID do Documento.</span><span class="sxs-lookup"><span data-stu-id="5801b-124">Stream Analytics utilizes an optimistic Upsert approach, where updates are only done when insert fails due to a Document ID conflict.</span></span> <span data-ttu-id="5801b-125">Essa atualização é executada pelo Stream Analytics como um PATCH. Assim, é possível realizar atualizações parciais no documento, ou seja, a adição de novas propriedades ou a substituição de uma propriedade existente é executada de forma incremental.</span><span class="sxs-lookup"><span data-stu-id="5801b-125">This update is performed by Stream Analytics as a PATCH, so it enables partial updates to the document, i.e. addition of new properties or replacing an existing property is performed incrementally.</span></span> <span data-ttu-id="5801b-126">Observe que as alterações nos valores de propriedades de matriz em seu documento JSON resultam na substituição de toda a matriz, ou seja, a matriz não é mesclada.</span><span class="sxs-lookup"><span data-stu-id="5801b-126">Note that changes in the values of array properties in your JSON document result in the entire array getting overwritten, i.e. the array is not merged.</span></span>

## <a name="data-partitioning-in-cosmos-db"></a><span data-ttu-id="5801b-127">Particionamento de dados no Cosmos DB</span><span class="sxs-lookup"><span data-stu-id="5801b-127">Data partitioning in Cosmos DB</span></span>
<span data-ttu-id="5801b-128">As [coleções particionadas](../cosmos-db/partition-data.md) do Cosmos DB são a abordagem recomendada para particionar os dados.</span><span class="sxs-lookup"><span data-stu-id="5801b-128">Cosmos DB [partitioned collections](../cosmos-db/partition-data.md) are the recommended approach for partitioning your data.</span></span> 

<span data-ttu-id="5801b-129">Para coleções individuais do Cosmos DB, o Stream Analytics ainda permite particionar os dados de acordo com os padrões de consulta e as necessidades de desempenho do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="5801b-129">For single Cosmos DB collections, Stream Analytics still allows you to partition your data based on both the query patterns and performance needs of your application.</span></span> <span data-ttu-id="5801b-130">Cada coleção pode conter até 10 GB de dados (máximo) e, atualmente, não há uma maneira de escalar verticalmente (ou estourar) uma coleção.</span><span class="sxs-lookup"><span data-stu-id="5801b-130">Each collection may contain up to 10GB of data (maximum) and currently there is no way to scale up (or overflow) a collection.</span></span> <span data-ttu-id="5801b-131">Para dimensionamento, o Stream Analytics permite que você grave várias coleções com um determinado prefixo (veja os detalhes de uso abaixo).</span><span class="sxs-lookup"><span data-stu-id="5801b-131">For scaling out, Stream Analytics allows you to write to multiple collections with a given prefix (see usage details below).</span></span> <span data-ttu-id="5801b-132">O Stream Analytics usa a estratégia de [Resolvedor de Partição Hash](https://msdn.microsoft.com/library/azure/microsoft.azure.documents.partitioning.hashpartitionresolver.aspx) consistente com base na coluna PartitionKey fornecida pelo usuário para particionar seus registros de saída.</span><span class="sxs-lookup"><span data-stu-id="5801b-132">Stream Analytics uses the consistent [Hash Partition Resolver](https://msdn.microsoft.com/library/azure/microsoft.azure.documents.partitioning.hashpartitionresolver.aspx) strategy based on the user provided PartitionKey column to partition its output records.</span></span> <span data-ttu-id="5801b-133">O número de coleções com o prefixo especificado na hora de início do trabalho de streaming é usado como a contagem de partições de saída, nas quais o trabalho grava em paralelo (Coleções do Cosmos DB = Partições de Saída).</span><span class="sxs-lookup"><span data-stu-id="5801b-133">The number of collections with the given prefix at the streaming job’s start time is used as the output partition count, to which the job writes to in parallel (Cosmos DB Collections = Output Partitions).</span></span> <span data-ttu-id="5801b-134">Para uma coleção individual com indexação lenta que realiza apenas inserções, é possível esperar uma produtividade de gravação de cerca de 0,4 MB/s.</span><span class="sxs-lookup"><span data-stu-id="5801b-134">For a single collection with lazy indexing doing only inserts, about 0.4 MB/s write throughput can be expected.</span></span> <span data-ttu-id="5801b-135">O uso de várias coleções permite alcançar maior produtividade e maior capacidade.</span><span class="sxs-lookup"><span data-stu-id="5801b-135">Using multiple collections can allow you to achieve higher throughput and increased capacity.</span></span>

<span data-ttu-id="5801b-136">Se você pretender aumentar a contagem de partições no futuro, talvez seja necessário interromper seu trabalho, reparticionar os dados de suas coleções existentes em novas coleções e reiniciar o trabalho do Stream Analytics.</span><span class="sxs-lookup"><span data-stu-id="5801b-136">If you intend to increase the partition count in the future, you may need to stop your job, repartition the data from your existing collections into new collections and then restart the Stream Analytics job.</span></span> <span data-ttu-id="5801b-137">Incluiremos mais detalhes sobre como usar PartitionResolver e o novo particionamento, junto com um exemplo de código, em uma próxima postagem.</span><span class="sxs-lookup"><span data-stu-id="5801b-137">More details on using PartitionResolver and re-partitioning along with sample code, will be included in a follow-up post.</span></span> <span data-ttu-id="5801b-138">O artigo [Particionamento e escala no Cosmos DB](../documentdb/documentdb-partition-data.md) também apresenta detalhes sobre isso.</span><span class="sxs-lookup"><span data-stu-id="5801b-138">The article [Partitioning and scaling in Cosmos DB](../documentdb/documentdb-partition-data.md) also provides details on this.</span></span>

## <a name="cosmos-db-settings-for-json-output"></a><span data-ttu-id="5801b-139">Configurações do Cosmos DB para saída em JSON</span><span class="sxs-lookup"><span data-stu-id="5801b-139">Cosmos DB settings for JSON output</span></span>
<span data-ttu-id="5801b-140">A criação do Cosmos DB como uma saída no Stream Analytics gera uma solicitação de informações, conforme mostrado abaixo.</span><span class="sxs-lookup"><span data-stu-id="5801b-140">Creating Cosmos DB as an output in Stream Analytics generates a prompt for information as seen below.</span></span> <span data-ttu-id="5801b-141">Esta seção fornece uma explicação da definição de propriedades.</span><span class="sxs-lookup"><span data-stu-id="5801b-141">This section provides an explanation of the properties definition.</span></span>

<span data-ttu-id="5801b-142">Coleção particionada</span><span class="sxs-lookup"><span data-stu-id="5801b-142">Partitioned Collection</span></span> | <span data-ttu-id="5801b-143">Várias coleções de “partição única”</span><span class="sxs-lookup"><span data-stu-id="5801b-143">Multiple “Single Partition” collections</span></span>
---|---
![tela de saída do stream analytics do banco de dados de documentos](media/stream-analytics-documentdb-output/stream-analytics-documentdb-output-1.png) |  ![tela de saída do stream analytics do banco de dados de documentos](media/stream-analytics-documentdb-output/stream-analytics-documentdb-output-2.png)


  
> [!NOTE]
> <span data-ttu-id="5801b-146">O cenário **Várias coleções de “partição única”** requer uma chave de partição e é uma configuração com suporte.</span><span class="sxs-lookup"><span data-stu-id="5801b-146">The **Multiple “Single Partition” collections** scenario requires a partition key and is a supported configuration.</span></span> 

* <span data-ttu-id="5801b-147">**Alias de Saída** : um alias para se referir a essa saída em sua consulta ASA</span><span class="sxs-lookup"><span data-stu-id="5801b-147">**Output Alias** – An alias to refer this output in your ASA query</span></span>  
* <span data-ttu-id="5801b-148">**Nome da Conta** – o nome ou o URI do ponto de extremidade da conta do Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="5801b-148">**Account Name** – The name or endpoint URI of the Cosmos DB account.</span></span>  
* <span data-ttu-id="5801b-149">**Chave de Conta** – a chave de acesso compartilhado da conta do Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="5801b-149">**Account Key** – The shared access key for the Cosmos DB account.</span></span>  
* <span data-ttu-id="5801b-150">**Banco de Dados** – o nome do banco de dados do Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="5801b-150">**Database** – The Cosmos DB database name.</span></span>  
* <span data-ttu-id="5801b-151">**Padrão do Nome de Coleção** – O nome da coleção ou seu padrão que será usado para as coleções.</span><span class="sxs-lookup"><span data-stu-id="5801b-151">**Collection Name Pattern** – The collection name or their pattern for the collections to be used.</span></span> <span data-ttu-id="5801b-152">O formato de nome da coleção pode ser construído com o token {partição} opcional, em que as partições começam em 0.</span><span class="sxs-lookup"><span data-stu-id="5801b-152">The collection name format can be constructed using the optional {partition} token, where partitions start from 0.</span></span> <span data-ttu-id="5801b-153">A seguir estão as entradas válidas de exemplo:</span><span class="sxs-lookup"><span data-stu-id="5801b-153">Following are sample valid inputs:</span></span>  
  <span data-ttu-id="5801b-154">1\) MyCollection – uma coleção denominada “MyCollection” deve existir.</span><span class="sxs-lookup"><span data-stu-id="5801b-154">1\) MyCollection – One collection named “MyCollection” must exist.</span></span>  
  <span data-ttu-id="5801b-155">2\) MyCollection{partition} – estas coleções devem existir – "MyCollection0”, “MyCollection1”, “MyCollection2” e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="5801b-155">2\) MyCollection{partition} – Such collections must exist– "MyCollection0”, “MyCollection1”, “MyCollection2” and so on.</span></span>  
* <span data-ttu-id="5801b-156">**Chave de Partição** — opcional.</span><span class="sxs-lookup"><span data-stu-id="5801b-156">**Partition Key** – Optional.</span></span> <span data-ttu-id="5801b-157">Isso só será necessário se você estiver usando um token {partition} no seu padrão de nome de coleção.</span><span class="sxs-lookup"><span data-stu-id="5801b-157">This is only needed if you are using a {parition} token in your collection name pattern.</span></span> <span data-ttu-id="5801b-158">O nome do campo nos eventos de saída usado para especificar a chave para o particionamento de saída em várias coleções.</span><span class="sxs-lookup"><span data-stu-id="5801b-158">The name of the field in output events used to specify the key for partitioning output across collections.</span></span> <span data-ttu-id="5801b-159">Para uma saída de coleção única, nenhuma coluna de saída arbitrária pode ser usada, por exemplo, PartitionId.</span><span class="sxs-lookup"><span data-stu-id="5801b-159">For single collection output, any arbitrary output column can be used e.g. PartitionId.</span></span>  
* <span data-ttu-id="5801b-160">**ID do Documento** : opcional.</span><span class="sxs-lookup"><span data-stu-id="5801b-160">**Document ID** – Optional.</span></span> <span data-ttu-id="5801b-161">O nome do campo em eventos de saída usado para especificar a chave primária que serve de base para as operações de inserção ou atualização.</span><span class="sxs-lookup"><span data-stu-id="5801b-161">The name of the field in output events used to specify the primary key on which insert or update operations are based.</span></span>  
