---
title: "Planejar a rede para replicação do Hyper-V (com o System Center VMM) para o Azure com o Azure Site Recovery | Microsoft Docs"
description: "Este artigo aborda o planejamento de rede necessário ao replicar VMs do Hyper-V (com VMM) para o Azure"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: 41c3c83e-6b1a-496a-8179-498c552ef0c7
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 07/23/2017
ms.author: raynew
ms.openlocfilehash: ef87cd82b021e40f0da05142878daff245cd9c62
ms.sourcegitcommit: 422efcbac5b6b68295064bd545132fcc98349d01
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/29/2017
---
# <a name="step-4-plan-networking-for-hyper-v-with-vmm-to-azure-replication"></a><span data-ttu-id="00b1e-103">Etapa 4: Planejar a rede para replicação do Hyper-V (com VMM) para o Azure</span><span class="sxs-lookup"><span data-stu-id="00b1e-103">Step 4: Plan networking for Hyper-V (with VMM) to Azure replication</span></span>

<span data-ttu-id="00b1e-104">Depois de executar o [planejamento de capacidade](vmm-to-azure-walkthrough-capacity.md) (se você estiver fazendo uma implantação completa), leia este artigo para saber mais sobre as considerações de planejamento de rede quando estiver replicando VMs Hyper-V locais nas nuvens do System Center Virtual Machine Manager (VMM) para o Azure, usando o serviço [Azure Site Recovery](site-recovery-overview.md).</span><span class="sxs-lookup"><span data-stu-id="00b1e-104">After performing [capacity planning](vmm-to-azure-walkthrough-capacity.md) (if you're doing a full deployment), read this article to learn about network planning considerations when replicating on-premises Hyper-V VMs in System Center Virtual Machine Manager (VMM) clouds to Azure, using the [Azure Site Recovery](site-recovery-overview.md) service.</span></span>

<span data-ttu-id="00b1e-105">Publique eventuais comentários no final deste artigo ou no [Fórum dos Serviços de Recuperação do Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span><span class="sxs-lookup"><span data-stu-id="00b1e-105">Post any comments at the bottom of this article, or ask questions in the [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span></span>


## <a name="network-mapping-for-replication-to-azure"></a><span data-ttu-id="00b1e-106">Mapeamento de rede para replicação do Azure</span><span class="sxs-lookup"><span data-stu-id="00b1e-106">Network mapping for replication to Azure</span></span>

<span data-ttu-id="00b1e-107">Mapeamento de rede é usado ao replicar máquinas virtuais do Hyper-V (gerenciados no VMM) no Azure.</span><span class="sxs-lookup"><span data-stu-id="00b1e-107">Network mapping is used when replicating Hyper-V VMs (managed in VMM) to Azure.</span></span> <span data-ttu-id="00b1e-108">O mapeamento de rede mapeia entre as redes de VM em um servidor VMM de origem e as redes do Azure de destino.</span><span class="sxs-lookup"><span data-stu-id="00b1e-108">Network mapping maps between VM networks on a source VMM server, and target Azure networks.</span></span> <span data-ttu-id="00b1e-109">Mapeamento faz o seguinte:</span><span class="sxs-lookup"><span data-stu-id="00b1e-109">Mapping does the following:</span></span>

- <span data-ttu-id="00b1e-110">**Conexão de rede**— depois do failover, todas as VMs do Azure replicadas estejam conectadas à rede mapeada do Azure.</span><span class="sxs-lookup"><span data-stu-id="00b1e-110">**Network connection**—After failover, all replicated Azure VMs are connected to the mapped Azure network.</span></span> <span data-ttu-id="00b1e-111">Todas as máquinas que passarem por failover na mesma rede poderão se conectar entre si, independentemente do plano de recuperação em que estão.</span><span class="sxs-lookup"><span data-stu-id="00b1e-111">All machines which fail over on the same network can connect to each other, even if they failed over in different recovery plans.</span></span>
- <span data-ttu-id="00b1e-112">**Gateway de rede**— se um gateway de rede for configurado na rede Azure de destino, as máquinas virtuais poderão conectar-se a outras máquinas virtuais locais na rede local mapeada.</span><span class="sxs-lookup"><span data-stu-id="00b1e-112">**Network gateway**—If a network gateway is set up on the target Azure network, VMs can connect to other on-premises virtual machines in the mapped on-premised network.</span></span>

### <a name="prepare-vmm-for-network-mapping"></a><span data-ttu-id="00b1e-113">Preparar VMM para mapeamento de rede</span><span class="sxs-lookup"><span data-stu-id="00b1e-113">Prepare VMM for network mapping</span></span>

<span data-ttu-id="00b1e-114">Prepare o VMM para o mapeamento de rede da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="00b1e-114">Prepare VMM for network mapping as follows:</span></span>

1. <span data-ttu-id="00b1e-115">Se você não tiver uma, prepare uma [rede lógica do VMM](https://docs.microsoft.com/system-center/vmm/network-logical) associado à nuvem em que os hosts do Hyper-V estão localizados.</span><span class="sxs-lookup"><span data-stu-id="00b1e-115">If you don't have one, prepare a [VMM logical network](https://docs.microsoft.com/system-center/vmm/network-logical) that's associated with the cloud in which the Hyper-V hosts are located.</span></span>
2. <span data-ttu-id="00b1e-116">Se você não tiver uma, crie uma [rede de VM](https://docs.microsoft.com/system-center/vmm/network-virtual) vinculada à rede lógica que você preparou acima.</span><span class="sxs-lookup"><span data-stu-id="00b1e-116">If you don't have one, created a [VM network](https://docs.microsoft.com/system-center/vmm/network-virtual) linked to the logical network you prepared above.</span></span>
3. <span data-ttu-id="00b1e-117">Conecte VMs no servidor/cluster do host do Hyper-V na nuvem do VMM, para a rede da VM.</span><span class="sxs-lookup"><span data-stu-id="00b1e-117">Connect VMs on the Hyper-V host server/cluster in the VMM cloud, to the VM network.</span></span>

 
<span data-ttu-id="00b1e-118">Observe que:</span><span class="sxs-lookup"><span data-stu-id="00b1e-118">Note that:</span></span> 
- <span data-ttu-id="00b1e-119">As novas VMs são adicionadas à rede VM de origem serão conectadas à rede do Azure mapeada quando a replicação ocorrer.</span><span class="sxs-lookup"><span data-stu-id="00b1e-119">New VMs are added to the source VM network are connected to the mapped Azure network when replication occurs.</span></span>
- <span data-ttu-id="00b1e-120">Se a rede de destino tiver várias sub-redes e uma dessas sub-redes tiver o mesmo nome que a sub-rede em que a máquina virtual de origem está localizada, a máquina virtual de réplica será conectada à sub-rede de destino após o failover.</span><span class="sxs-lookup"><span data-stu-id="00b1e-120">If the target network has multiple subnets, and one of those subnets has the same name as subnet on which the source virtual machine is located, then the replica virtual machine connects to that target subnet after failover.</span></span>
- <span data-ttu-id="00b1e-121">Se não houver uma sub-rede de destino com um nome correspondente, a máquina virtual será conectada à primeira sub-rede na rede.</span><span class="sxs-lookup"><span data-stu-id="00b1e-121">If there’s no target subnet with a matching name, the virtual machine connects to the first subnet in the network.</span></span>
- <span data-ttu-id="00b1e-122">Prepare uma rede do Azure e configure mapeamentos de rede da mesma maneira que implantaria o cenário.</span><span class="sxs-lookup"><span data-stu-id="00b1e-122">You prepare an Azure network, and set up network mappings, as you deploy the scenario.</span></span>

## <a name="connecting-to-azure-vms-after-failover"></a><span data-ttu-id="00b1e-123">Conexão com VMs do Azure após o failover</span><span class="sxs-lookup"><span data-stu-id="00b1e-123">Connecting to Azure VMs after failover</span></span>

<span data-ttu-id="00b1e-124">Ao planejar sua estratégia de replicação e failover, uma das principais questões é como se conectar à VM do Azure após o failover.</span><span class="sxs-lookup"><span data-stu-id="00b1e-124">When planning your replication and failover strategy, one of the key questions is how to connect to the Azure VM after failover.</span></span> <span data-ttu-id="00b1e-125">Há algumas opções ao criar sua estratégia de rede para VMs de réplica do Azure:</span><span class="sxs-lookup"><span data-stu-id="00b1e-125">There are a couple of choices when designing your network strategy for replica Azure VMs:</span></span>

- <span data-ttu-id="00b1e-126">**Usar outro endereço IP**: você pode optar por usar outro intervalo de endereços IP para a rede VM replicada do Azure.</span><span class="sxs-lookup"><span data-stu-id="00b1e-126">**Use a different IP address**: You can select to use a different IP address range for the replicated Azure VM network.</span></span> <span data-ttu-id="00b1e-127">Nesse cenário, a VM obtém um novo endereço IP após o failover e uma atualização de DNS é necessária.</span><span class="sxs-lookup"><span data-stu-id="00b1e-127">In this scenario the VM gets a new IP address after failover, and a DNS update is required.</span></span>
- <span data-ttu-id="00b1e-128">**Manter o mesmo endereço IP**: talvez você deseje usar o mesmo intervalo de endereços IP da rede primária local para a rede do Azure após o failover.</span><span class="sxs-lookup"><span data-stu-id="00b1e-128">**Retain the same IP address**: You might want to use the same IP address range as that in your primary on-premises network, for the Azure network after failover.</span></span>  <span data-ttu-id="00b1e-129">Manter os mesmos endereços IP simplifica a recuperação, reduzindo problemas relacionados à rede após o failover.</span><span class="sxs-lookup"><span data-stu-id="00b1e-129">Keeping the same IP addresses simplifies the recovery by reducing network related issues after failover.</span></span> <span data-ttu-id="00b1e-130">No entanto, quando você estiver replicando para o Azure, precisará atualizar as rotas com o novo local dos endereços IP após o failover.</span><span class="sxs-lookup"><span data-stu-id="00b1e-130">However, when you're replicating to Azure, you will need to update routes with the new location of the IP addresses after failover.</span></span>


## <a name="retain-ip-addresses"></a><span data-ttu-id="00b1e-131">Manter os endereços IP</span><span class="sxs-lookup"><span data-stu-id="00b1e-131">Retain IP addresses</span></span>

<span data-ttu-id="00b1e-132">O Site Recovery fornece a capacidade de manter endereços IP fixos durante o failover para o Azure, com um failover de sub-rede.</span><span class="sxs-lookup"><span data-stu-id="00b1e-132">Site Recovery provides the capability to retain fixed IP addresses when failing over to Azure, with a subnet failover.</span></span>

<span data-ttu-id="00b1e-133">Com o failover de sub-rede, uma sub-rede específica está presente no Site 1 ou Site 2, mas nunca em ambos os sites ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="00b1e-133">With subnet failover, a specific subnet is present at Site 1 or Site 2, but never at both sites simultaneously.</span></span> <span data-ttu-id="00b1e-134">Para manter o espaço de endereço IP no caso de um failover, de forma programática, faça com que a infraestrutura do roteador mova as sub-redes de um site para outro.</span><span class="sxs-lookup"><span data-stu-id="00b1e-134">In order to maintain the IP address space in the event of a failover, you programmatically arrange for the router infrastructure to move the subnets from one site to another.</span></span> <span data-ttu-id="00b1e-135">Durante o failover, as sub-redes são movidas com as VMs protegidas associadas.</span><span class="sxs-lookup"><span data-stu-id="00b1e-135">During failover, the subnets move with the associated protected VMs.</span></span> <span data-ttu-id="00b1e-136">A principal desvantagem é que, em caso de falha, você precisa mover toda a sub-rede.</span><span class="sxs-lookup"><span data-stu-id="00b1e-136">The main drawback is that in the event of a failure, you have to move the whole subnet.</span></span>



### <a name="failover-example"></a><span data-ttu-id="00b1e-137">Exemplo de failover</span><span class="sxs-lookup"><span data-stu-id="00b1e-137">Failover example</span></span>

<span data-ttu-id="00b1e-138">Vejamos um exemplo de failover para o Azure.</span><span class="sxs-lookup"><span data-stu-id="00b1e-138">Let's look at an example for failover to Azure.</span></span>

- <span data-ttu-id="00b1e-139">Uma organização fictícia, o Woodgrove Bank, tem uma infraestrutura local que hospeda seus aplicativos de negócios.</span><span class="sxs-lookup"><span data-stu-id="00b1e-139">A ficticious company, Woodgrove Bank, has an on-premises infrastructure hosting their business apps.</span></span> <span data-ttu-id="00b1e-140">Seus aplicativos móveis são hospedados no Azure.</span><span class="sxs-lookup"><span data-stu-id="00b1e-140">Their mobile applications are hosted on Azure.</span></span>
- <span data-ttu-id="00b1e-141">A conectividade entre as VMs do Woodgrove Bank no Azure e os servidores locais é fornecida por uma conexão (VPN) site a site entre a rede de borda local e a rede virtual do Azure.</span><span class="sxs-lookup"><span data-stu-id="00b1e-141">Connectivity between Woodgrove Bank VMs in Azure and on-premises servers is provided by a site-to-site (VPN) connection between the on-premises edge network and the Azure virtual network.</span></span>
- <span data-ttu-id="00b1e-142">Essa VPN significa que a rede virtual da empresa no Azure aparece como uma extensão de sua rede local.</span><span class="sxs-lookup"><span data-stu-id="00b1e-142">This VPN means that the company's virtual network in Azure appears as an extension of their on-premises network.</span></span>
- <span data-ttu-id="00b1e-143">O Woodgrove deseja usar o Site Recovery para replicar as cargas de trabalho locais para o Azure.</span><span class="sxs-lookup"><span data-stu-id="00b1e-143">Woodgrove wants to use Site Recovery to replicate on-premises workloads to Azure.</span></span>
 - <span data-ttu-id="00b1e-144">O Woodgrove precisa lidar com aplicativos e configurações que dependem de endereços IP embutidos em código e, portanto, precisa reter endereços IP para seus aplicativos após o failover para o Azure.</span><span class="sxs-lookup"><span data-stu-id="00b1e-144">Woodgrove has to deal with applications and configurations which depend on hard-coded IP addresses, and thus need to retain IP addresses for their applications after failover to Azure.</span></span>
 - <span data-ttu-id="00b1e-145">O Woodgrove atribuiu endereços IP do intervalo 172.16.1.0/24 a 172.16.2.0/24 aos seus recursos em execução no Azure.</span><span class="sxs-lookup"><span data-stu-id="00b1e-145">Woodgrove has assigned IP addresses from range 172.16.1.0/24, 172.16.2.0/24 to its resources running in Azure.</span></span>


<span data-ttu-id="00b1e-146">Para que o Woodgrove consiga replicar suas VMs para o Azure, ao mesmo tempo que mantém os endereços IP, veja o que a empresa precisa fazer:</span><span class="sxs-lookup"><span data-stu-id="00b1e-146">For Woodgrove to be able to replicate its VMs to Azure while retaining the IP addresses, here's what the company needs to do:</span></span>

1. <span data-ttu-id="00b1e-147">Crie uma rede virtual do Azure.</span><span class="sxs-lookup"><span data-stu-id="00b1e-147">Create an Azure virtual network.</span></span> <span data-ttu-id="00b1e-148">Ela deve ser uma extensão da rede local, de forma que os aplicativos possam fazer failover de forma ininterrupta.</span><span class="sxs-lookup"><span data-stu-id="00b1e-148">It should be an extension of the on-premises network, so that applications can fail over seamlessly.</span></span>
2. <span data-ttu-id="00b1e-149">O Azure permite que você adicione a conectividade VPN site a site, além da conectividade ponto a site, às redes virtuais criadas no Azure.</span><span class="sxs-lookup"><span data-stu-id="00b1e-149">Azure allows you to add site-to-site VPN connectivity, in addition to point-to-site connectivity to the virtual networks created in Azure.</span></span>
3. <span data-ttu-id="00b1e-150">Ao configurar a conexão site a site, na rede do Azure, você poderá encaminhar o tráfego para a localização local (rede local) somente se o intervalo de endereços IP for diferente do intervalo de endereços IP local.</span><span class="sxs-lookup"><span data-stu-id="00b1e-150">When setting up the site-to-site connection, in the Azure network, you can route traffic to the on-premises location (local-network) only if the IP address range is different from the on-premises IP address range.</span></span>
    - <span data-ttu-id="00b1e-151">Isso ocorre porque o Azure não dá suporte a sub-redes ampliadas.</span><span class="sxs-lookup"><span data-stu-id="00b1e-151">This is because Azure doesn’t support stretched subnets.</span></span> <span data-ttu-id="00b1e-152">Portanto, se você tiver uma sub-rede 192.168.1.0/24 local, não poderá adicionar uma rede local 192.168.1.0/24 à rede do Azure.</span><span class="sxs-lookup"><span data-stu-id="00b1e-152">So if you have subnet 192.168.1.0/24 on-premises, you can’t add a local-network 192.168.1.0/24 in the Azure network.</span></span>
    - <span data-ttu-id="00b1e-153">Isso é esperado, porque o Azure não reconhece que não há nenhuma VM ativa na sub-rede e que a sub-rede está sendo criada apenas para fins de recuperação de desastre.</span><span class="sxs-lookup"><span data-stu-id="00b1e-153">This is expected because Azure doesn’t know that there are no active VMs in the subnet, and that the subnet is being created for disaster recovery only.</span></span>
    - <span data-ttu-id="00b1e-154">Para poder encaminhar o tráfego de rede corretamente para fora de uma rede do Azure, as sub-redes na rede e a rede local não devem entrar em conflito.</span><span class="sxs-lookup"><span data-stu-id="00b1e-154">To be able to correctly route network traffic out of an Azure network the subnets in the network and the local-network mustn't conflict.</span></span>

![Antes do failover da sub-rede](./media/vmm-to-azure-walkthrough-network/network-design7.png)

### <a name="before-failover"></a><span data-ttu-id="00b1e-156">Antes do failover</span><span class="sxs-lookup"><span data-stu-id="00b1e-156">Before failover</span></span>

1. <span data-ttu-id="00b1e-157">Crie uma rede adicional (por exemplo, uma Rede de Recuperação).</span><span class="sxs-lookup"><span data-stu-id="00b1e-157">Create an additional network (for example Recovery Network).</span></span> <span data-ttu-id="00b1e-158">Essa é a rede na qual as VMs com failover são criadas.</span><span class="sxs-lookup"><span data-stu-id="00b1e-158">This is the network in which failed over VMs are created.</span></span>
2. <span data-ttu-id="00b1e-159">Para garantir que o endereço IP de um computador é mantido após um failover, nas propriedades da VM > **Configurar**, especifique o mesmo endereço IP que a VM tem no local e clique em **Salvar**.</span><span class="sxs-lookup"><span data-stu-id="00b1e-159">To ensure that the IP address for a VM is retained after a failover, in the VM properties > **Configure**, specify the same IP address that the VM has on-premises, and click **Save**.</span></span>
3. <span data-ttu-id="00b1e-160">Quando a VM passar por failover, o Azure Site Recovery atribuirá o endereço IP fornecido a ele.</span><span class="sxs-lookup"><span data-stu-id="00b1e-160">When the VM is failed over, Azure Site Recovery will assign the provided IP address to it.</span></span>

    ![Propriedades da rede](./media/vmm-to-azure-walkthrough-network/network-design8.png)

4. <span data-ttu-id="00b1e-162">Depois que o failover for disparado e as VMs forem criadas no Azure com o endereço IP solicitado, você poderá se conectar à rede usando uma [conexão Vnet a Vnet](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md).</span><span class="sxs-lookup"><span data-stu-id="00b1e-162">After failover is trigger is triggered, and the VMs are created in Azure with the required IP address, you can connect to the network using a [Vnet to Vnet vonnection](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md).</span></span> <span data-ttu-id="00b1e-163">Essa ação pode ser inserida em um script.</span><span class="sxs-lookup"><span data-stu-id="00b1e-163">This action can be scripted.</span></span>
5. <span data-ttu-id="00b1e-164">As rotas precisam ser modificadas de maneira apropriada, para refletir que 192.168.1.0/24 agora foi movido para o Azure.</span><span class="sxs-lookup"><span data-stu-id="00b1e-164">Routes need to be appropriately modified, to reflect that 192.168.1.0/24 has now moved to Azure.</span></span>

    ![Após o failover da sub-rede](./media/vmm-to-azure-walkthrough-network/network-design9.png)

### <a name="after-failover"></a><span data-ttu-id="00b1e-166">Após o failover</span><span class="sxs-lookup"><span data-stu-id="00b1e-166">After failover</span></span>

<span data-ttu-id="00b1e-167">Caso você não tenha uma rede do Azure, conforme ilustrado acima, poderá criar uma conexão VPN site a site entre o site primário e o Azure, após o failover.</span><span class="sxs-lookup"><span data-stu-id="00b1e-167">If you don't have an Azure network as illustrated above, you can create a site-to-site VPN connection between your primary site and Azure, after failvoer.</span></span>

## <a name="change-ip-addresses"></a><span data-ttu-id="00b1e-168">Alterar os endereços IP</span><span class="sxs-lookup"><span data-stu-id="00b1e-168">Change IP addresses</span></span>

<span data-ttu-id="00b1e-169">Esta [postagem no blog](http://azure.microsoft.com/blog/2014/09/04/networking-infrastructure-setup-for-microsoft-azure-as-a-disaster-recovery-site/) explica como configurar a infraestrutura de rede do Azure quando você não precisa reter os endereços IP após o failover.</span><span class="sxs-lookup"><span data-stu-id="00b1e-169">This [blog post](http://azure.microsoft.com/blog/2014/09/04/networking-infrastructure-setup-for-microsoft-azure-as-a-disaster-recovery-site/) explains how to set up the Azure networking infrastructure when you don't need to retain IP addresses after failover.</span></span> <span data-ttu-id="00b1e-170">Ela começa com uma descrição do aplicativo, explica como configurar a rede local e no Azure e termina com informações sobre como executar failovers.</span><span class="sxs-lookup"><span data-stu-id="00b1e-170">It starts with an application description, looks at how to set up networking on-premises and in Azure, and concludes with information about running failovers.</span></span>  

## <a name="next-steps"></a><span data-ttu-id="00b1e-171">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="00b1e-171">Next steps</span></span>

<span data-ttu-id="00b1e-172">Ir para a [Etapa 5: Preparar o Azure](vmm-to-azure-walkthrough-prepare-azure.md)</span><span class="sxs-lookup"><span data-stu-id="00b1e-172">Go to [Step 5: Prepare Azure](vmm-to-azure-walkthrough-prepare-azure.md)</span></span>
