---
title: "Solucionar problemas de dimensionamento automático com conjunto de dimensionamento de máquinas virtuais | Microsoft Docs"
description: "Solução de problemas de dimensionamento automático com conjuntos de escala de máquina virtual. Compreenda os problemas típicos encontrados e como resolvê-los."
services: virtual-machine-scale-sets
documentationcenter: 
author: gbowerman
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: c7d87b72-ee24-4e52-9377-a42f337f76fa
ms.service: virtual-machine-scale-sets
ms.workload: na
ms.tgt_pltfrm: windows
ms.devlang: na
ms.topic: article
ms.date: 10/28/2016
ms.author: guybo
ms.openlocfilehash: bd45a0fb99a77851aa7b91d23bd4b830b6f5cc7b
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="troubleshooting-autoscale-with-virtual-machine-scale-sets"></a><span data-ttu-id="b8d50-104">Solução de problemas do dimensionamento automático com conjuntos de escala de máquina virtual</span><span class="sxs-lookup"><span data-stu-id="b8d50-104">Troubleshooting autoscale with Virtual Machine Scale Sets</span></span>
<span data-ttu-id="b8d50-105">**Problema**: você criou uma infraestrutura de dimensionamento automático no Azure Resource Manager usando Conjuntos de Dimensionamento de VMs, por exemplo implantando um modelo como este: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale – suas regras de escala estão definidas e ele funciona muito bem, exceto que, independentemente da carga colocada nas VMs, ele não usa dimensionamento automático.</span><span class="sxs-lookup"><span data-stu-id="b8d50-105">**Problem** – you’ve created an autoscaling infrastructure in Azure Resource Manager using VM Scale Sets –  for example by deploying a template like this: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale  – you have your scale rules defined and it works great, except that no matter how much load you put on the VMs, it won’t autoscale.</span></span>

## <a name="troubleshooting-steps"></a><span data-ttu-id="b8d50-106">Etapas para solucionar problemas</span><span class="sxs-lookup"><span data-stu-id="b8d50-106">Troubleshooting steps</span></span>
<span data-ttu-id="b8d50-107">Alguns aspectos a serem considerados incluem:</span><span class="sxs-lookup"><span data-stu-id="b8d50-107">Some things to consider include:</span></span>

* <span data-ttu-id="b8d50-108">Quantos núcleos cada VM tem e você está carregando cada núcleo?</span><span class="sxs-lookup"><span data-stu-id="b8d50-108">How many cores does each VM have, and are you loading each core?</span></span>
  <span data-ttu-id="b8d50-109">O modelo de Início Rápido do Azure de exemplo acima tem um script do_work.php, que carrega um único núcleo.</span><span class="sxs-lookup"><span data-stu-id="b8d50-109">The example Azure Quickstart template above has a do_work.php script, which loads a single core.</span></span> <span data-ttu-id="b8d50-110">Se você estiver usando uma VM de tamanho maior do que o de uma VM de núcleo único, como Standard_A1 ou D1, é necessário executar essa carga várias vezes.</span><span class="sxs-lookup"><span data-stu-id="b8d50-110">If you’re using a VM bigger than a single core VM size like Standard_A1 or D1 then you’d need to run this load multiple times.</span></span> <span data-ttu-id="b8d50-111">Verifique quantos núcleos suas VMs têm conferindo [Tamanhos para máquinas virtuais do Windows no Azure](../virtual-machines/windows/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)</span><span class="sxs-lookup"><span data-stu-id="b8d50-111">Check how many cores your VMs by reviewing [Sizes for Windows virtual machines in Azure](../virtual-machines/windows/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)</span></span>
* <span data-ttu-id="b8d50-112">Quantas VMs há no conjunto de VM escala, e você está balhando em cada uma delas?</span><span class="sxs-lookup"><span data-stu-id="b8d50-112">How many VMs in the VM Scale Set, are you doing work on each one?</span></span>
  
    <span data-ttu-id="b8d50-113">Um evento de escala horizontal só ocorrerá quando a CPU média em **todas** as VMs em um conjunto de escala exceder o valor de limite além do tempo interno definido nas regras de dimensionamento automático.</span><span class="sxs-lookup"><span data-stu-id="b8d50-113">A scale out event will only take place when the average CPU across **all** the VMs in a scale set exceeds the threshold value, over the time internal defined in the autoscale rules.</span></span>
* <span data-ttu-id="b8d50-114">Você perdeu algum evento de escala?</span><span class="sxs-lookup"><span data-stu-id="b8d50-114">Did you miss any scale events?</span></span>
  
    <span data-ttu-id="b8d50-115">Verifique os logs de auditoria no Portal do Azure sobre os eventos de escala.</span><span class="sxs-lookup"><span data-stu-id="b8d50-115">Check the audit logs in the Azure portal for scale events.</span></span> <span data-ttu-id="b8d50-116">Pode ter ocorrido uma escala ou redução vertical que foi perdida.</span><span class="sxs-lookup"><span data-stu-id="b8d50-116">Maybe there was a scale up and a scale down which was missed.</span></span> <span data-ttu-id="b8d50-117">Você pode filtrar por “Escala”.</span><span class="sxs-lookup"><span data-stu-id="b8d50-117">You can filter by “Scale”..</span></span>
  
    ![Logs de Auditoria][audit]
* <span data-ttu-id="b8d50-119">Os limites de escala e redução são diferentes o suficiente?</span><span class="sxs-lookup"><span data-stu-id="b8d50-119">Are your scale-in and scale-out thresholds sufficiently different?</span></span>
  
    <span data-ttu-id="b8d50-120">Suponha que você definiu uma regra para escalar horizontalmente quando a CPU média for maior que 50% durante 5 minutos e reduzir horizontalmente quando a CPU média for menor que 50%.</span><span class="sxs-lookup"><span data-stu-id="b8d50-120">Suppose you set a rule to scale out when average CPU is greater than 50% over 5 minutes, and to scale in when average CPU is less than 50%.</span></span> <span data-ttu-id="b8d50-121">Isso causaria um problema de "oscilação" quando uso da CPU estiver perto desse limite, com ações de escala constantemente aumentando e diminuindo o tamanho do conjunto.</span><span class="sxs-lookup"><span data-stu-id="b8d50-121">This would cause a “flapping” problem when CPU usage is close to this threshold, with scale actions constantly increasing and decreasing the size of the set.</span></span> <span data-ttu-id="b8d50-122">Por isso, o serviço de dimensionamento automático tenta impedir “oscilações”, que pode se manifestar como o impedimento do dimensionamento.</span><span class="sxs-lookup"><span data-stu-id="b8d50-122">Because of this, the autoscale service tries to prevent “flapping”, which can manifest as not scaling.</span></span> <span data-ttu-id="b8d50-123">Portanto, verifique se seus limites de escala e redução são diferentes o suficiente para que exista algum espaço entre os dimensionamentos.</span><span class="sxs-lookup"><span data-stu-id="b8d50-123">Therefore make sure your scale-out and scale-in thresholds are sufficiently different to allow some space in between scaling.</span></span>
* <span data-ttu-id="b8d50-124">Você criou seu próprio modelo JSON?</span><span class="sxs-lookup"><span data-stu-id="b8d50-124">Did you write your own JSON template?</span></span>
  
    <span data-ttu-id="b8d50-125">É fácil cometer erros, portanto, comece com um modelo como o mostrado acima, com funcionamento comprovado, e faça pequenas alterações incrementais.</span><span class="sxs-lookup"><span data-stu-id="b8d50-125">It is easy to make mistakes, so start with a template like the one above which is proven to work, and make small incremental changes.</span></span> 
* <span data-ttu-id="b8d50-126">Você consegue aumentar ou reduzir horizontalmente?</span><span class="sxs-lookup"><span data-stu-id="b8d50-126">Can you manually scale in or out?</span></span>
  
    <span data-ttu-id="b8d50-127">Tente reimplantar o recurso do conjunto de escala de VM com uma configuração de "capacidade" diferente para alterar o número de VMs manualmente.</span><span class="sxs-lookup"><span data-stu-id="b8d50-127">Try redeploying the VM Scale Set resource with a different “capacity” setting to change the number of VMs manually.</span></span> <span data-ttu-id="b8d50-128">Um modelo de exemplo para fazer isso está aqui: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-scale-existing - pode ser necessário editar o modelo para garantir que ele possua o mesmo tamanho de máquina que o Conjunto de Dimensionamento usa.</span><span class="sxs-lookup"><span data-stu-id="b8d50-128">An example template to do this is here: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-scale-existing – you may need to edit the template to make sure it has the same machine size as your Scale Set is using.</span></span> <span data-ttu-id="b8d50-129">Se for possível alterar o número de VMs manualmente, você saberá que o problema é isolado ao dimensionamento automático.</span><span class="sxs-lookup"><span data-stu-id="b8d50-129">If you can successfully change the number of VMs manually, then you know the problem is isolated to autoscale.</span></span>
* <span data-ttu-id="b8d50-130">Verifique seus recursos Microsoft.Compute/virtualMachineScaleSet e Microsoft.Insights no [Gerenciador de Recursos do Azure](https://resources.azure.com/)</span><span class="sxs-lookup"><span data-stu-id="b8d50-130">Check your Microsoft.Compute/virtualMachineScaleSet, and Microsoft.Insights resources in the [Azure Resource Explorer](https://resources.azure.com/)</span></span>
  
    <span data-ttu-id="b8d50-131">Essa é uma ferramenta indispensável de solução de problemas que mostra o estado dos seus recursos do Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="b8d50-131">This is an indispensable troubleshooting tool which shows you the state of your Azure Resource Manager resources.</span></span> <span data-ttu-id="b8d50-132">Clique na sua assinatura e examine o Grupo de Recursos em que você está solucionando problemas.</span><span class="sxs-lookup"><span data-stu-id="b8d50-132">Click on your subscription and look at the Resource Group you are troubleshooting.</span></span> <span data-ttu-id="b8d50-133">No Provedor de recursos de computação, examine o conjunto de escala de VM criado e verifique a Exibição de Instância, que mostra o estado de uma implantação.</span><span class="sxs-lookup"><span data-stu-id="b8d50-133">Under the Compute resource provider look at the VM Scale Set you created and check the Instance View, which shows you the state of a deployment.</span></span> <span data-ttu-id="b8d50-134">Verifique também a exibição de instância de VMs no conjunto de escala de VM.</span><span class="sxs-lookup"><span data-stu-id="b8d50-134">Also check the instance view of VMs in the VM Scale Set.</span></span> <span data-ttu-id="b8d50-135">Vá para o provedor de recursos Microsoft.Insights e verifique se as regras de dimensionamento automático parecem corretas.</span><span class="sxs-lookup"><span data-stu-id="b8d50-135">Then go into the Microsoft.Insights resource provider and check the autoscale rules look good.</span></span>
* <span data-ttu-id="b8d50-136">A extensão de Diagnóstico está funcionando e emitindo os dados de desempenho?</span><span class="sxs-lookup"><span data-stu-id="b8d50-136">Is the Diagnostic extension working and emitting performance data?</span></span>
  
    <span data-ttu-id="b8d50-137">**Atualização:** O dimensionamento automático do Azure foi aperfeiçoado para usar um pipeline de métricas baseado em host que não requer mais a instalação de uma extensão de diagnóstico.</span><span class="sxs-lookup"><span data-stu-id="b8d50-137">**Update:** Azure autoscale has been enhanced to use a host based metrics pipeline which no longer requires a diagnostics extension to be installed.</span></span> <span data-ttu-id="b8d50-138">Isso significa que os próximos parágrafos já não se aplicam se você criar um aplicativo de dimensionamento automático usando o novo pipeline.</span><span class="sxs-lookup"><span data-stu-id="b8d50-138">This means the next few paragraphs no longer apply if you create an autoscaling application using the new pipeline.</span></span> <span data-ttu-id="b8d50-139">Este é um exemplo de modelos do Azure que foram convertidos para usar o pipeline do host: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale.</span><span class="sxs-lookup"><span data-stu-id="b8d50-139">An example of Azure templates which have been converted to use the host pipeline is: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale.</span></span> 
  
    <span data-ttu-id="b8d50-140">A utilização de métricas baseada em host para o dimensionamento automático é melhor pelos seguintes motivos:</span><span class="sxs-lookup"><span data-stu-id="b8d50-140">Using host based metrics for autoscale is better for the following reasons:</span></span>
  
  * <span data-ttu-id="b8d50-141">Menos partes móveis, já que não é necessário instalação de nenhuma extensão de diagnóstico.</span><span class="sxs-lookup"><span data-stu-id="b8d50-141">Fewer moving parts as no diagnostics extensions need to be installed.</span></span>
  * <span data-ttu-id="b8d50-142">Modelos mais simples.</span><span class="sxs-lookup"><span data-stu-id="b8d50-142">Simpler templates.</span></span> <span data-ttu-id="b8d50-143">Basta adicionar informações de regras de dimensionamento automático em um modelo de conjunto de dimensionamento existente.</span><span class="sxs-lookup"><span data-stu-id="b8d50-143">Just add insights autoscale rules to an existing scale set template.</span></span>
  * <span data-ttu-id="b8d50-144">Relatórios mais confiáveis e inicialização mais rápida de novas VMs.</span><span class="sxs-lookup"><span data-stu-id="b8d50-144">More reliable reporting and faster launching of new VMs.</span></span>
    
    <span data-ttu-id="b8d50-145">Os únicos motivos pelos quais você desejaria continuar usando uma extensão de diagnóstico seria se você precisasse de relatório ou dimensionamento de diagnósticos de memória.</span><span class="sxs-lookup"><span data-stu-id="b8d50-145">The only reasons you might want to keep using a diagnostic extension would be if you need memory diagnostics reporting/scaling.</span></span> <span data-ttu-id="b8d50-146">Métricas baseadas em host não fornecem relatório de memória.</span><span class="sxs-lookup"><span data-stu-id="b8d50-146">Host based metrics doesn't report memory.</span></span>
    
    <span data-ttu-id="b8d50-147">Com isso em mente, só é necessário seguir na leitura deste artigo se você ainda estiver usando extensões de diagnóstico para o dimensionamento automático.</span><span class="sxs-lookup"><span data-stu-id="b8d50-147">With that in mind, only follow the rest of this article if you are still using diagnostic extensions for your autoscaling.</span></span>
    
    <span data-ttu-id="b8d50-148">O dimensionamento automático no Azure Resource Manager pode trabalhar (mas não precisa mais) por meio de uma extensão de VM chamada a Extensão de Diagnóstico.</span><span class="sxs-lookup"><span data-stu-id="b8d50-148">Autoscale in Azure Resource Manager can work (but no longer has to) by means of a VM extension called the Diagnostics Extension.</span></span> <span data-ttu-id="b8d50-149">Emite dados de desempenho para uma conta de armazenamento definida no modelo.</span><span class="sxs-lookup"><span data-stu-id="b8d50-149">It emits performance data to a storage account you define in the template.</span></span> <span data-ttu-id="b8d50-150">Esses dados são então agregados pelo serviço do Azure Monitor.</span><span class="sxs-lookup"><span data-stu-id="b8d50-150">This data is then aggregated by the Azure Monitor service.</span></span>
    
    <span data-ttu-id="b8d50-151">Se o serviço do Insights não puderem ler os dados de VMs, ele deverá enviar um email, se as VMs ficarem inativas, por exemplo, por isso verifique seu email (aquele especificado ao criar a conta do Azure).</span><span class="sxs-lookup"><span data-stu-id="b8d50-151">If the Insights service can’t read data from the VMs, it is supposed to send you an email – for example if the VMs were down, so check your email (the one you specified when creating the Azure account).</span></span>
    
    <span data-ttu-id="b8d50-152">Também é possível examinar os dados você mesmo.</span><span class="sxs-lookup"><span data-stu-id="b8d50-152">You can also go and look at the data yourself.</span></span> <span data-ttu-id="b8d50-153">Examine a conta de armazenamento do Azure usando um gerenciador de nuvem.</span><span class="sxs-lookup"><span data-stu-id="b8d50-153">Look at the Azure storage account using a cloud explorer.</span></span> <span data-ttu-id="b8d50-154">Usando o [Visual Studio Cloud Explorer](https://visualstudiogallery.msdn.microsoft.com/aaef6e67-4d99-40bc-aacf-662237db85a2), por exemplo, faça logon e escolha a assinatura do Azure que você está usando e o nome da conta de armazenamento de Diagnóstico referenciada na definição da extensão de Diagnóstico no seu modelo de implantação.</span><span class="sxs-lookup"><span data-stu-id="b8d50-154">For example using the [Visual Studio Cloud Explorer](https://visualstudiogallery.msdn.microsoft.com/aaef6e67-4d99-40bc-aacf-662237db85a2), log in and pick the Azure subscription you’re using, and the Diagnostics storage account name referenced in the Diagnostics extension definition in your deployment template..</span></span>
    
    ![Gerenciador de Nuvem][explorer]
    
    <span data-ttu-id="b8d50-156">Aqui você verá um monte de tabelas em que os dados de cada VM estão sendo armazenados.</span><span class="sxs-lookup"><span data-stu-id="b8d50-156">Here you will see a bunch of tables where the data from each VM is being stored.</span></span> <span data-ttu-id="b8d50-157">Usando o Linux e a métrica de CPU como exemplo, procure linhas mais recentes.</span><span class="sxs-lookup"><span data-stu-id="b8d50-157">Taking Linux and the CPU metric as an example, look at the most recent rows.</span></span> <span data-ttu-id="b8d50-158">O Visual Studio Cloud Explorer dá suporte a uma linguagem de consulta para que você possa executar uma consulta como “Timestamp gt datetime’2016-02-02T21:20:00Z’” para obter com certeza os eventos mais recentes (supondo que o fuso horário é UTC).</span><span class="sxs-lookup"><span data-stu-id="b8d50-158">The Visual Studio cloud explorer supports a query language so you can run a query like “Timestamp gt datetime’2016-02-02T21:20:00Z’” to make sure you get the most recent events (assume time is in UTC).</span></span> <span data-ttu-id="b8d50-159">Os dados exibidos correspondem às regras de escala que você configurou?</span><span class="sxs-lookup"><span data-stu-id="b8d50-159">Does the data you see in there correspond to the scale rules you set up?</span></span> <span data-ttu-id="b8d50-160">No exemplo abaixo, a CPU do computador 20 começou a aumentar para 100% nos últimos 5 minutos.</span><span class="sxs-lookup"><span data-stu-id="b8d50-160">In the example below, the CPU for machine 20 started increasing to 100% over the last 5 minutes..</span></span>
    
    ![Tabelas de Armazenamento][tables]
    
    <span data-ttu-id="b8d50-162">Se os dados não estiverem lá, isso significará que o problema está na extensão de diagnóstico em execução nas VMs.</span><span class="sxs-lookup"><span data-stu-id="b8d50-162">If the data is not there, then it implies the problem is with the diagnostic extension running in the VMs.</span></span> <span data-ttu-id="b8d50-163">Se os dados estiverem lá, isso significará que há um problema com as suas regras de escala ou com o serviço do Insights.</span><span class="sxs-lookup"><span data-stu-id="b8d50-163">If the data is there, it implies there is either a problem with your scale rules, or with the Insights service.</span></span> <span data-ttu-id="b8d50-164">Verifique o [Status do Azure](https://azure.microsoft.com/status/).</span><span class="sxs-lookup"><span data-stu-id="b8d50-164">Check [Azure Status](https://azure.microsoft.com/status/).</span></span>
    
    <span data-ttu-id="b8d50-165">Depois que você passou por essas etapas, se ainda estiver tendo problemas de dimensionamento automático, pode tentar os fóruns no [MSDN](https://social.msdn.microsoft.com/forums/azure/home?category=windowsazureplatform%2Cazuremarketplace%2Cwindowsazureplatformctp), ou o [Stack Overflow](http://stackoverflow.com/questions/tagged/azure) ou abrir uma chamada de suporte.</span><span class="sxs-lookup"><span data-stu-id="b8d50-165">Once you’ve been through these steps, if you are still having autoscale problems you could try the forums on [MSDN](https://social.msdn.microsoft.com/forums/azure/home?category=windowsazureplatform%2Cazuremarketplace%2Cwindowsazureplatformctp), or [Stack overflow](http://stackoverflow.com/questions/tagged/azure), or log a support call.</span></span> <span data-ttu-id="b8d50-166">Prepare-se para compartilhar o modelo e uma exibição dos dados de desempenho.</span><span class="sxs-lookup"><span data-stu-id="b8d50-166">Be prepared to share the template and a view of the performance data.</span></span>

[audit]: ./media/virtual-machine-scale-sets-troubleshoot/image3.png
[explorer]: ./media/virtual-machine-scale-sets-troubleshoot/image1.png
[tables]: ./media/virtual-machine-scale-sets-troubleshoot/image4.png
