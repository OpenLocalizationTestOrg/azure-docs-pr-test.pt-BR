---
title: "Sistema de mensagens assíncronas do Barramento de Serviço | Microsoft Docs"
description: "Descrição da mensagem assíncrona do Barramento de Serviço do Azure."
services: service-bus-messaging
documentationcenter: na
author: sethmanheim
manager: timlt
editor: 
ms.assetid: f1435549-e1f2-40cb-a280-64ea07b39fc7
ms.service: service-bus-messaging
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 04/19/2017
ms.author: sethm
ms.openlocfilehash: 95d6f295ba145a55fe4ed3fc7c6f627c9d419a3c
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="asynchronous-messaging-patterns-and-high-availability"></a><span data-ttu-id="89620-103">Padrões de mensagens assíncronas e alta disponibilidade</span><span class="sxs-lookup"><span data-stu-id="89620-103">Asynchronous messaging patterns and high availability</span></span>

<span data-ttu-id="89620-104">O serviço de mensagens assíncrono pode ser implementado de diversas maneiras diferentes.</span><span class="sxs-lookup"><span data-stu-id="89620-104">Asynchronous messaging can be implemented in a variety of different ways.</span></span> <span data-ttu-id="89620-105">Com filas, tópicos e assinaturas, o Barramento de Serviço do Azure dá suporte ao assincronismo por meio de um mecanismo de encaminhamento e repositório.</span><span class="sxs-lookup"><span data-stu-id="89620-105">With queues, topics, and subscriptions, Azure Service Bus supports asynchronism via a store and forward mechanism.</span></span> <span data-ttu-id="89620-106">Na operação normal (síncrona), você envia mensagens para filas e tópicos e recebe mensagens de filas e assinaturas.</span><span class="sxs-lookup"><span data-stu-id="89620-106">In normal (synchronous) operation, you send messages to queues and topics, and receive messages from queues and subscriptions.</span></span> <span data-ttu-id="89620-107">Os aplicativos escritos por você dependem de essas entidades estarem sempre disponíveis.</span><span class="sxs-lookup"><span data-stu-id="89620-107">Applications you write depend on these entities always being available.</span></span> <span data-ttu-id="89620-108">Quando a integridade da entidade é alterada, devido a diversas circunstâncias, é necessário ter uma maneira de fornecer uma entidade de capacidade reduzida que possa atender à maioria das necessidades.</span><span class="sxs-lookup"><span data-stu-id="89620-108">When the entity health changes, due to a variety of circumstances, you need a way to provide a reduced capability entity that can satisfy most needs.</span></span>

<span data-ttu-id="89620-109">Os aplicativos normalmente usam padrões de mensagens assíncronas para habilitar diversos cenários de comunicação.</span><span class="sxs-lookup"><span data-stu-id="89620-109">Applications typically use asynchronous messaging patterns to enable a number of communication scenarios.</span></span> <span data-ttu-id="89620-110">Você pode criar aplicativos nos quais clientes podem enviar mensagens a serviços, mesmo quando o serviço não está em execução.</span><span class="sxs-lookup"><span data-stu-id="89620-110">You can build applications in which clients can send messages to services, even when the service is not running.</span></span> <span data-ttu-id="89620-111">Para os aplicativos que têm intermitência de comunicações, uma fila pode ajudar a normalizar a carga, fornecendo um lugar para um buffer de comunicações.</span><span class="sxs-lookup"><span data-stu-id="89620-111">For applications that experience bursts of communications, a queue can help level the load by providing a place to buffer communications.</span></span> <span data-ttu-id="89620-112">Finalmente, você pode obter um balanceador de carga simples, mas eficaz, para distribuir mensagens em vários computadores.</span><span class="sxs-lookup"><span data-stu-id="89620-112">Finally, you can get a simple but effective load balancer to distribute messages across multiple machines.</span></span>

<span data-ttu-id="89620-113">Para manter a disponibilidade de qualquer uma dessas entidades, considere as várias formas diferentes pelas quais essas entidades podem parecer indisponíveis para um sistema de mensagens durável.</span><span class="sxs-lookup"><span data-stu-id="89620-113">In order to maintain availability of any of these entities, consider a number of different ways in which these entities can appear unavailable for a durable messaging system.</span></span> <span data-ttu-id="89620-114">Em termos gerais, vemos a entidade se tornar indisponível para os aplicativos que escrevemos das seguintes maneiras:</span><span class="sxs-lookup"><span data-stu-id="89620-114">Generally speaking, we see the entity become unavailable to applications we write in the following different ways:</span></span>

* <span data-ttu-id="89620-115">Não é possível enviar mensagens.</span><span class="sxs-lookup"><span data-stu-id="89620-115">Unable to send messages.</span></span>
* <span data-ttu-id="89620-116">Não é possível receber mensagens.</span><span class="sxs-lookup"><span data-stu-id="89620-116">Unable to receive messages.</span></span>
* <span data-ttu-id="89620-117">Não é possível gerenciar entidades (criar, recuperar, atualizar ou excluir entidades).</span><span class="sxs-lookup"><span data-stu-id="89620-117">Unable to manage entities (create, retrieve, update, or delete entities).</span></span>
* <span data-ttu-id="89620-118">Não é possível entrar em contato com o serviço.</span><span class="sxs-lookup"><span data-stu-id="89620-118">Unable to contact the service.</span></span>

<span data-ttu-id="89620-119">Para cada uma dessas falhas, existem modos de falhas diferentes que habilitam um aplicativo a continuar a executar o trabalho em algum nível de capacidade reduzida.</span><span class="sxs-lookup"><span data-stu-id="89620-119">For each of these failures, different failure modes exist that enable an application to continue to perform work at some level of reduced capability.</span></span> <span data-ttu-id="89620-120">Por exemplo, um sistema que pode enviar mensagens, mas não recebê-las, ainda pode receber pedidos de clientes, mas não pode processar esses pedidos.</span><span class="sxs-lookup"><span data-stu-id="89620-120">For example, a system that can send messages but not receive them can still receive orders from customers but cannot process those orders.</span></span> <span data-ttu-id="89620-121">Este tópico aborda problemas potenciais que podem ocorrer e como eles são atenuados.</span><span class="sxs-lookup"><span data-stu-id="89620-121">This topic discusses potential issues that can occur, and how those issues are mitigated.</span></span> <span data-ttu-id="89620-122">O Barramento de Serviço introduziu diversas mitigações que você deverá aceitar, e este tópico também descreve as regras que regem o uso dessas mitigações que exigem aceitação.</span><span class="sxs-lookup"><span data-stu-id="89620-122">Service Bus has introduced a number of mitigations which you must opt into, and this topic also discusses the rules governing the use of those opt-in mitigations.</span></span>

## <a name="reliability-in-service-bus"></a><span data-ttu-id="89620-123">Confiabilidade no Barramento de Serviço</span><span class="sxs-lookup"><span data-stu-id="89620-123">Reliability in Service Bus</span></span>
<span data-ttu-id="89620-124">Há diversas maneiras de lidar com problemas de mensagens e entidades, e há diretrizes que regem o uso apropriado dessas mitigações.</span><span class="sxs-lookup"><span data-stu-id="89620-124">There are several ways to handle message and entity issues, and there are guidelines governing the appropriate use of those mitigations.</span></span> <span data-ttu-id="89620-125">Para entender as diretrizes, primeiro você deve entender o que pode falhar no Barramento de Serviço.</span><span class="sxs-lookup"><span data-stu-id="89620-125">To understand the guidelines, you must first understand what can fail in Service Bus.</span></span> <span data-ttu-id="89620-126">Devido ao design de sistemas do Azure, todos esses problemas tendem a ter vida curta.</span><span class="sxs-lookup"><span data-stu-id="89620-126">Due to the design of Azure systems, all of these issues tend to be short-lived.</span></span> <span data-ttu-id="89620-127">Em um alto nível, as diferentes causas de indisponibilidade ocorrem da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="89620-127">At a high level, the different causes of unavailability appear as follows:</span></span>

* <span data-ttu-id="89620-128">A limitação de um sistema externo do qual o Barramento de Serviço depende.</span><span class="sxs-lookup"><span data-stu-id="89620-128">Throttling from an external system on which Service Bus depends.</span></span> <span data-ttu-id="89620-129">A limitação ocorre devido a interações com os recursos de computação e armazenamento.</span><span class="sxs-lookup"><span data-stu-id="89620-129">Throttling occurs from interactions with storage and compute resources.</span></span>
* <span data-ttu-id="89620-130">Problema para um sistema do qual o Barramento de Serviço depende.</span><span class="sxs-lookup"><span data-stu-id="89620-130">Issue for a system on which Service Bus depends.</span></span> <span data-ttu-id="89620-131">Por exemplo, determinado armazenamento pode encontrar problemas.</span><span class="sxs-lookup"><span data-stu-id="89620-131">For example, a given part of storage can encounter issues.</span></span>
* <span data-ttu-id="89620-132">Falha do Barramento de Serviço em um único subsistema.</span><span class="sxs-lookup"><span data-stu-id="89620-132">Failure of Service Bus on single subsystem.</span></span> <span data-ttu-id="89620-133">Nessa situação, um nó de computação pode entrar em um estado inconsistente e deve se reiniciar sozinho, fazendo com que todas as entidades a que ele serve tenham a carga equilibrada para outros nós.</span><span class="sxs-lookup"><span data-stu-id="89620-133">In this situation, a compute node can get into an inconsistent state and must restart itself, causing all entities it serves to load balance to other nodes.</span></span> <span data-ttu-id="89620-134">Por sua vez, isso pode causar um curto período de processamento de mensagens lento.</span><span class="sxs-lookup"><span data-stu-id="89620-134">This in turn can cause a short period of slow message processing.</span></span>
* <span data-ttu-id="89620-135">Falha do Barramento de Serviço em um datacenter do Azure.</span><span class="sxs-lookup"><span data-stu-id="89620-135">Failure of Service Bus within an Azure datacenter.</span></span> <span data-ttu-id="89620-136">Essa é uma "falha catastrófica" durante a qual o sistema não pode ser acessado por vários minutos ou algumas horas.</span><span class="sxs-lookup"><span data-stu-id="89620-136">This is a "catastrophic failure" during which the system is unreachable for many minutes or a few hours.</span></span>

> [!NOTE]
> <span data-ttu-id="89620-137">O termo **armazenamento** pode significar Armazenamento do Azure e SQL Azure.</span><span class="sxs-lookup"><span data-stu-id="89620-137">The term **storage** can mean both Azure Storage and SQL Azure.</span></span>
> 
> 

<span data-ttu-id="89620-138">O Barramento de Serviço contém várias mitigações para esses problemas.</span><span class="sxs-lookup"><span data-stu-id="89620-138">Service Bus contains a number of mitigations for these issues.</span></span> <span data-ttu-id="89620-139">As seções a seguir discutem cada problema e as respectivas mitigações.</span><span class="sxs-lookup"><span data-stu-id="89620-139">The following sections discuss each issue and their respective mitigations.</span></span>

### <a name="throttling"></a><span data-ttu-id="89620-140">Limitação</span><span class="sxs-lookup"><span data-stu-id="89620-140">Throttling</span></span>
<span data-ttu-id="89620-141">Com o Barramento de Serviço, a limitação possibilita o gerenciamento cooperativo de taxa de mensagens.</span><span class="sxs-lookup"><span data-stu-id="89620-141">With Service Bus, throttling enables cooperative message rate management.</span></span> <span data-ttu-id="89620-142">Cada nó individual do Barramento de Serviço hospeda várias entidades.</span><span class="sxs-lookup"><span data-stu-id="89620-142">Each individual Service Bus node houses many entities.</span></span> <span data-ttu-id="89620-143">Cada uma dessas entidades faz demandas ao sistema em termos de CPU, memória, armazenamento e outros aspectos.</span><span class="sxs-lookup"><span data-stu-id="89620-143">Each of those entities makes demands on the system in terms of CPU, memory, storage, and other facets.</span></span> <span data-ttu-id="89620-144">Quando qualquer um desses aspectos detecta uso que excede os limites definidos, o Barramento de Serviço pode negar determinada solicitação.</span><span class="sxs-lookup"><span data-stu-id="89620-144">When any of these facets detects usage that exceeds defined thresholds, Service Bus can deny a given request.</span></span> <span data-ttu-id="89620-145">O chamador recebe um [ServerBusyException][ServerBusyException] e faz nova tentativa após 10 segundos.</span><span class="sxs-lookup"><span data-stu-id="89620-145">The caller receives a [ServerBusyException][ServerBusyException] and retries after 10 seconds.</span></span>

<span data-ttu-id="89620-146">Como uma mitigação, o código deve ler o erro e interromper repetições da mensagem por pelo menos 10 segundos.</span><span class="sxs-lookup"><span data-stu-id="89620-146">As a mitigation, the code must read the error and halt any retries of the message for at least 10 seconds.</span></span> <span data-ttu-id="89620-147">Como o erro pode ocorrer em partes do aplicativo cliente, espera-se que cada parte dele execute independentemente a lógica de repetição.</span><span class="sxs-lookup"><span data-stu-id="89620-147">Since the error can happen across pieces of the customer application, it is expected that each piece independently executes the retry logic.</span></span> <span data-ttu-id="89620-148">O código pode reduzir a probabilidade de restrição, habilitando o particionamento em uma fila ou um tópico.</span><span class="sxs-lookup"><span data-stu-id="89620-148">The code can reduce the probability of being throttled by enabling partitioning on a queue or topic.</span></span>

### <a name="issue-for-an-azure-dependency"></a><span data-ttu-id="89620-149">Problema para uma dependência do Azure</span><span class="sxs-lookup"><span data-stu-id="89620-149">Issue for an Azure dependency</span></span>
<span data-ttu-id="89620-150">Ocasionalmente, outros componentes do Azure podem ter problemas de serviço.</span><span class="sxs-lookup"><span data-stu-id="89620-150">Other components within Azure can occasionally have service issues.</span></span> <span data-ttu-id="89620-151">Por exemplo, quando um sistema que usa o Barramento de Serviço está sendo atualizado, esse sistema pode ter os recursos reduzidos temporariamente.</span><span class="sxs-lookup"><span data-stu-id="89620-151">For example, when a system that Service Bus uses is being upgraded, that system can temporarily experience reduced capabilities.</span></span> <span data-ttu-id="89620-152">Para resolver esses tipos de problemas, o Barramento de Serviço investiga e implementa mitigações regularmente.</span><span class="sxs-lookup"><span data-stu-id="89620-152">To work around these types of issues, Service Bus regularly investigates and implements mitigations.</span></span> <span data-ttu-id="89620-153">Ocorrem efeitos colaterais dessas mitigações.</span><span class="sxs-lookup"><span data-stu-id="89620-153">Side effects of these mitigations do appear.</span></span> <span data-ttu-id="89620-154">Por exemplo, para lidar com problemas temporários com armazenamento, o Barramento de Serviço implementa um sistema que permite que operações de envio de mensagem funcionem constantemente.</span><span class="sxs-lookup"><span data-stu-id="89620-154">For example, to handle transient issues with storage, Service Bus implements a system that allows message send operations to work consistently.</span></span> <span data-ttu-id="89620-155">Devido à natureza da mitigação, uma mensagem enviada pode levar até 15 minutos para ser exibida na fila ou assinatura afetada e estar pronta para uma operação de recebimento.</span><span class="sxs-lookup"><span data-stu-id="89620-155">Due to the nature of the mitigation, a sent message can take up to 15 minutes to appear in the affected queue or subscription and be ready for a receive operation.</span></span> <span data-ttu-id="89620-156">Em termos gerais, a maioria das entidades não enfrentará esse problema.</span><span class="sxs-lookup"><span data-stu-id="89620-156">Generally speaking, most entities will not experience this issue.</span></span> <span data-ttu-id="89620-157">No entanto, devido ao número de entidades no Barramento de Serviço no Azure, essa mitigação às vezes é necessária para um pequeno subconjunto de clientes do Barramento de Serviço.</span><span class="sxs-lookup"><span data-stu-id="89620-157">However, given the number of entities in Service Bus within Azure, this mitigation is sometimes needed for a small subset of Service Bus customers.</span></span>

### <a name="service-bus-failure-on-a-single-subsystem"></a><span data-ttu-id="89620-158">Falha do Barramento de Serviço em um único subsistema</span><span class="sxs-lookup"><span data-stu-id="89620-158">Service Bus failure on a single subsystem</span></span>
<span data-ttu-id="89620-159">Com qualquer aplicativo, circunstâncias podem fazer com que um componente interno do Barramento de Serviço se torne inconsistente.</span><span class="sxs-lookup"><span data-stu-id="89620-159">With any application, circumstances can cause an internal component of Service Bus to become inconsistent.</span></span> <span data-ttu-id="89620-160">Quando o Barramento de Serviço detecta isso, ele coleta dados do aplicativo para ajudar a diagnosticar o que aconteceu.</span><span class="sxs-lookup"><span data-stu-id="89620-160">When Service Bus detects this, it collects data from the application to aid in diagnosing what happened.</span></span> <span data-ttu-id="89620-161">Depois que os dados são coletados, o aplicativo é reiniciado em uma tentativa de retorná-lo a um estado consistente.</span><span class="sxs-lookup"><span data-stu-id="89620-161">Once the data is collected, the application is restarted in an attempt to return it to a consistent state.</span></span> <span data-ttu-id="89620-162">Esse processo acontece rapidamente e resulta em uma entidade que parece estar disponível por alguns minutos, embora os tempos de inatividade típicos sejam mais curtos.</span><span class="sxs-lookup"><span data-stu-id="89620-162">This process happens fairly quickly, and results in an entity appearing to be unavailable for up to a few minutes, though typical down times are much shorter.</span></span>

<span data-ttu-id="89620-163">Nesses casos, o aplicativo cliente gera uma exceção [System.TimeoutException][System.TimeoutException] ou [MessagingException][MessagingException].</span><span class="sxs-lookup"><span data-stu-id="89620-163">In these cases, the client application generates a [System.TimeoutException][System.TimeoutException] or [MessagingException][MessagingException] exception.</span></span> <span data-ttu-id="89620-164">O SDK do Barramento de Serviço contém uma mitigação para esse problema na forma de lógica de repetição de cliente automatizada.</span><span class="sxs-lookup"><span data-stu-id="89620-164">Service Bus contains a mitigation for this issue in the form of automated client retry logic.</span></span> <span data-ttu-id="89620-165">Depois que o período de repetição se esgota e a mensagem não é entregue, você pode explorar usando outros recursos, como [namespaces emparelhados][paired namespaces].</span><span class="sxs-lookup"><span data-stu-id="89620-165">Once the retry period is exhausted and the message is not delivered, you can explore using other features such as [paired namespaces][paired namespaces].</span></span> <span data-ttu-id="89620-166">Namespaces emparelhados têm outras restrições que são abordadas neste artigo.</span><span class="sxs-lookup"><span data-stu-id="89620-166">Paired namespaces have other caveats that are discussed in that article.</span></span>

### <a name="failure-of-service-bus-within-an-azure-datacenter"></a><span data-ttu-id="89620-167">Falha do Barramento de Serviço em um datacenter do Azure</span><span class="sxs-lookup"><span data-stu-id="89620-167">Failure of Service Bus within an Azure datacenter</span></span>
<span data-ttu-id="89620-168">O motivo mais provável para uma falha em um datacenter do Azure é uma implantação de atualização com falha do Barramento de Serviço ou um sistema dependente.</span><span class="sxs-lookup"><span data-stu-id="89620-168">The most probable reason for a failure in an Azure datacenter is a failed upgrade deployment of Service Bus or a dependent system.</span></span> <span data-ttu-id="89620-169">À medida que a plataforma amadureceu, a probabilidade desse tipo de falha foi reduzida.</span><span class="sxs-lookup"><span data-stu-id="89620-169">As the platform has matured, the likelihood of this type of failure has diminished.</span></span> <span data-ttu-id="89620-170">Uma falha do datacenter também pode acontecer por razões que incluem o seguinte:</span><span class="sxs-lookup"><span data-stu-id="89620-170">A datacenter failure can also happen for reasons that include the following:</span></span>

* <span data-ttu-id="89620-171">Falta de energia (a fonte de energia e a geração de energia ficam indisponíveis).</span><span class="sxs-lookup"><span data-stu-id="89620-171">Electrical outage (power supply and generating power disappear).</span></span>
* <span data-ttu-id="89620-172">Conectividade (interrupção da Internet entre o cliente e o Azure).</span><span class="sxs-lookup"><span data-stu-id="89620-172">Connectivity (internet break between your clients and Azure).</span></span>

<span data-ttu-id="89620-173">Em ambos os casos, um desastre natural ou humano causou o problema.</span><span class="sxs-lookup"><span data-stu-id="89620-173">In both cases, a natural or man-made disaster caused the issue.</span></span> <span data-ttu-id="89620-174">Para solucionar esse problema e garantir que ainda possa enviar mensagens, você pode usar [namespaces emparelhados][paired namespaces] para possibilitar que as mensagens sejam enviadas a um segundo local enquanto o local principal se torna íntegro novamente.</span><span class="sxs-lookup"><span data-stu-id="89620-174">To work around this and make sure that you can still send messages, you can use [paired namespaces][paired namespaces] to enable messages to be sent to a second location while the primary location is made healthy again.</span></span> <span data-ttu-id="89620-175">Para saber mais, confira [Práticas recomendadas para isolar aplicativos contra interrupções e desastres do Barramento de Serviço][Best practices for insulating applications against Service Bus outages and disasters].</span><span class="sxs-lookup"><span data-stu-id="89620-175">For more information, see [Best practices for insulating applications against Service Bus outages and disasters][Best practices for insulating applications against Service Bus outages and disasters].</span></span>

## <a name="paired-namespaces"></a><span data-ttu-id="89620-176">Namespaces emparelhados</span><span class="sxs-lookup"><span data-stu-id="89620-176">Paired namespaces</span></span>
<span data-ttu-id="89620-177">O recurso de [namespaces emparelhados][paired namespaces] dá suporte a cenários em que uma entidade do Barramento de Serviço ou uma implantação em um datacenter se torna indisponível.</span><span class="sxs-lookup"><span data-stu-id="89620-177">The [paired namespaces][paired namespaces] feature supports scenarios in which a Service Bus entity or deployment within a data center becomes unavailable.</span></span> <span data-ttu-id="89620-178">Embora esse evento ocorra raramente, sistemas distribuídos ainda devem estar preparados para lidar com os piores cenários.</span><span class="sxs-lookup"><span data-stu-id="89620-178">While this event occurs infrequently, distributed systems still must be prepared to handle worst case scenarios.</span></span> <span data-ttu-id="89620-179">Normalmente, esse evento acontece porque algum elemento dos quais o Barramento de Serviço depende está enfrentando um problema de curto prazo.</span><span class="sxs-lookup"><span data-stu-id="89620-179">Typically, this event happens because some element on which Service Bus depends is experiencing a short-term issue.</span></span> <span data-ttu-id="89620-180">Para manter a disponibilidade do aplicativo durante uma interrupção, os usuários do Barramento de Serviço podem usar dois namespaces separados, preferencialmente em datacenters separados, para hospedar suas entidades de mensagens.</span><span class="sxs-lookup"><span data-stu-id="89620-180">To maintain application availability during an outage, Service Bus users can use two separate namespaces, preferably in separate data centers, to host their messaging entities.</span></span> <span data-ttu-id="89620-181">O restante desta seção usa a seguinte terminologia:</span><span class="sxs-lookup"><span data-stu-id="89620-181">The remainder of this section uses the following terminology:</span></span>

* <span data-ttu-id="89620-182">Namespace principal: o namespace com o qual seu aplicativo interage para operações de envio e recebimento.</span><span class="sxs-lookup"><span data-stu-id="89620-182">Primary namespace: The namespace with which your application interacts, for send and receive operations.</span></span>
* <span data-ttu-id="89620-183">Namespace secundário: o namespace que atua como um backup para o namespace principal.</span><span class="sxs-lookup"><span data-stu-id="89620-183">Secondary namespace: The namespace that acts as a backup to the primary namespace.</span></span> <span data-ttu-id="89620-184">A lógica de aplicativo não interage com esse namespace.</span><span class="sxs-lookup"><span data-stu-id="89620-184">Application logic does not interact with this namespace.</span></span>
* <span data-ttu-id="89620-185">Intervalo de failover: o tempo necessário para aceitar falhas normais antes que o aplicativo alterne do namespace principal para o namespace secundário.</span><span class="sxs-lookup"><span data-stu-id="89620-185">Failover interval: The amount of time to accept normal failures before the application switches from the primary namespace to the secondary namespace.</span></span>

<span data-ttu-id="89620-186">Namespaces emparelhados dão suporte à *disponibilidade de envio*.</span><span class="sxs-lookup"><span data-stu-id="89620-186">Paired namespaces support *send availability*.</span></span> <span data-ttu-id="89620-187">A disponibilidade de envio preserva a capacidade de enviar mensagens.</span><span class="sxs-lookup"><span data-stu-id="89620-187">Send availability preserves the ability to send messages.</span></span> <span data-ttu-id="89620-188">Para usar a disponibilidade de envio, seu aplicativo deve atender aos seguintes requisitos:</span><span class="sxs-lookup"><span data-stu-id="89620-188">To use send availability, your application must meet the following requirements:</span></span>

1. <span data-ttu-id="89620-189">As mensagens são recebidas apenas do namespace principal.</span><span class="sxs-lookup"><span data-stu-id="89620-189">Messages are only received from the primary namespace.</span></span>
2. <span data-ttu-id="89620-190">As mensagens enviadas a determinada fila ou tópico podem chegar fora de ordem.</span><span class="sxs-lookup"><span data-stu-id="89620-190">Messages sent to a given queue or topic might arrive out of order.</span></span>
3. <span data-ttu-id="89620-191">As mensagens em uma sessão podem chegar fora de ordem.</span><span class="sxs-lookup"><span data-stu-id="89620-191">Messages within a session might arrive out of order.</span></span> <span data-ttu-id="89620-192">Essa é uma falha de funcionalidade normal das sessões.</span><span class="sxs-lookup"><span data-stu-id="89620-192">This is a break from normal functionality of sessions.</span></span> <span data-ttu-id="89620-193">Isso significa que seu aplicativo usa sessões para mensagens agrupadas logicamente.</span><span class="sxs-lookup"><span data-stu-id="89620-193">This means that your application uses sessions to logically group messages.</span></span>
4. <span data-ttu-id="89620-194">O estado da sessão é mantido somente no namespace principal.</span><span class="sxs-lookup"><span data-stu-id="89620-194">Session state is only maintained on the primary namespace.</span></span>
5. <span data-ttu-id="89620-195">A fila principal pode ficar online e começar a aceitar mensagens antes de a fila secundária entregar todas as mensagens à fila principal.</span><span class="sxs-lookup"><span data-stu-id="89620-195">The primary queue can come online and start accepting messages before the secondary queue delivers all messages into the primary queue.</span></span>

<span data-ttu-id="89620-196">As seções a seguir discutem as APIs e como as APIs são implementadas e mostra um código de exemplo que usa o recurso.</span><span class="sxs-lookup"><span data-stu-id="89620-196">The following sections discuss the APIs, how the APIs are implemented, and shows sample code that uses the feature.</span></span> <span data-ttu-id="89620-197">Observe que há implicações de cobranças associadas a esse recurso.</span><span class="sxs-lookup"><span data-stu-id="89620-197">Note that there are billing implications associated with this feature.</span></span>

### <a name="the-messagingfactorypairnamespaceasync-api"></a><span data-ttu-id="89620-198">A API MessagingFactory.PairNamespaceAsync</span><span class="sxs-lookup"><span data-stu-id="89620-198">The MessagingFactory.PairNamespaceAsync API</span></span>
<span data-ttu-id="89620-199">O recurso de namespaces emparelhados inclui o método [PairNamespaceAsync][PairNamespaceAsync] na classe [Microsoft.ServiceBus.Messaging.MessagingFactory][Microsoft.ServiceBus.Messaging.MessagingFactory]:</span><span class="sxs-lookup"><span data-stu-id="89620-199">The paired namespaces feature includes the [PairNamespaceAsync][PairNamespaceAsync] method on the [Microsoft.ServiceBus.Messaging.MessagingFactory][Microsoft.ServiceBus.Messaging.MessagingFactory] class:</span></span>

```csharp
public Task PairNamespaceAsync(PairedNamespaceOptions options);
```

<span data-ttu-id="89620-200">Quando a tarefa é concluída, o emparelhamento do namespace também é concluído e está pronto para atuar em qualquer [MessageReceiver][MessageReceiver], [QueueClient][QueueClient] ou [TopicClient][TopicClient] criado com a instância [MessagingFactory][MessagingFactory].</span><span class="sxs-lookup"><span data-stu-id="89620-200">When the task completes, the namespace pairing is also complete and ready to act upon for any [MessageReceiver][MessageReceiver], [QueueClient][QueueClient], or [TopicClient][TopicClient] created with the [MessagingFactory][MessagingFactory] instance.</span></span> <span data-ttu-id="89620-201">[Microsoft.ServiceBus.Messaging.PairedNamespaceOptions][Microsoft.ServiceBus.Messaging.PairedNamespaceOptions] é a classe base para os diferentes tipos de emparelhamento que estão disponíveis com um objeto [MessagingFactory][MessagingFactory].</span><span class="sxs-lookup"><span data-stu-id="89620-201">[Microsoft.ServiceBus.Messaging.PairedNamespaceOptions][Microsoft.ServiceBus.Messaging.PairedNamespaceOptions] is the base class for the different types of pairing that are available with a [MessagingFactory][MessagingFactory] object.</span></span> <span data-ttu-id="89620-202">Atualmente, a única classe derivada é uma que se chama [SendAvailabilityPairedNamespaceOptions][SendAvailabilityPairedNamespaceOptions], que implementa os requisitos de disponibilidade de envio.</span><span class="sxs-lookup"><span data-stu-id="89620-202">Currently, the only derived class is one named [SendAvailabilityPairedNamespaceOptions][SendAvailabilityPairedNamespaceOptions], which implements the send availability requirements.</span></span> <span data-ttu-id="89620-203">[SendAvailabilityPairedNamespaceOptions][SendAvailabilityPairedNamespaceOptions] tem um conjunto de construtores que se baseiam uns nos outros.</span><span class="sxs-lookup"><span data-stu-id="89620-203">[SendAvailabilityPairedNamespaceOptions][SendAvailabilityPairedNamespaceOptions] has a set of constructors that build on each other.</span></span> <span data-ttu-id="89620-204">Observando o construtor com a maioria dos parâmetros, você pode compreender o comportamento de outros construtores.</span><span class="sxs-lookup"><span data-stu-id="89620-204">Looking at the constructor with the most parameters, you can understand the behavior of the other constructors.</span></span>

```csharp
public SendAvailabilityPairedNamespaceOptions(
    NamespaceManager secondaryNamespaceManager,
    MessagingFactory messagingFactory,
    int backlogQueueCount,
    TimeSpan failoverInterval,
    bool enableSyphon)
```

<span data-ttu-id="89620-205">Esses parâmetros têm os seguintes significados:</span><span class="sxs-lookup"><span data-stu-id="89620-205">These parameters have the following meanings:</span></span>

* <span data-ttu-id="89620-206">*secondaryNamespaceManager*: uma instância inicializada de [NamespaceManager][NamespaceManager] para o namespace secundário que o método [PairNamespaceAsync][PairNamespaceAsync] pode usar para configurar o namespace secundário.</span><span class="sxs-lookup"><span data-stu-id="89620-206">*secondaryNamespaceManager*: An initialized [NamespaceManager][NamespaceManager] instance for the secondary namespace that the [PairNamespaceAsync][PairNamespaceAsync] method can use to set up the secondary namespace.</span></span> <span data-ttu-id="89620-207">O gerenciador de namespace é usado para obter a lista de filas no namespace e garantir que as filas obrigatórias de lista de pendências existam.</span><span class="sxs-lookup"><span data-stu-id="89620-207">The namespace manager is used to obtain the list of queues in the namespace and to make sure that the required backlog queues exist.</span></span> <span data-ttu-id="89620-208">Se essas filas não existirem, elas serão criadas.</span><span class="sxs-lookup"><span data-stu-id="89620-208">If those queues do not exist, they are created.</span></span> <span data-ttu-id="89620-209">[NamespaceManager][NamespaceManager] requer a capacidade de criar um token com a declaração **Manage**.</span><span class="sxs-lookup"><span data-stu-id="89620-209">[NamespaceManager][NamespaceManager] requires the ability to create a token with the **Manage** claim.</span></span>
* <span data-ttu-id="89620-210">*messagingFactory*: a instância de [MessagingFactory][MessagingFactory] para o namespace secundário.</span><span class="sxs-lookup"><span data-stu-id="89620-210">*messagingFactory*: The [MessagingFactory][MessagingFactory] instance for the secondary namespace.</span></span> <span data-ttu-id="89620-211">O objeto [MessagingFactory][MessagingFactory] é usado para enviar e, se a propriedade [EnableSyphon][EnableSyphon] estiver definida como **true**, receber mensagens de filas de lista de pendências.</span><span class="sxs-lookup"><span data-stu-id="89620-211">The [MessagingFactory][MessagingFactory] object is used to send and, if the [EnableSyphon][EnableSyphon] property is set to **true**, receive messages from the backlog queues.</span></span>
* <span data-ttu-id="89620-212">*backlogQueueCount*: o número de filas de lista de pendências a serem criadas.</span><span class="sxs-lookup"><span data-stu-id="89620-212">*backlogQueueCount*: The number of backlog queues to create.</span></span> <span data-ttu-id="89620-213">Esse valor deve ser pelo menos 1.</span><span class="sxs-lookup"><span data-stu-id="89620-213">This value must be at least 1.</span></span> <span data-ttu-id="89620-214">Ao serem enviadas mensagens à lista de pendências, umas dessas filas é escolhida aleatoriamente.</span><span class="sxs-lookup"><span data-stu-id="89620-214">When sending messages to the backlog, one of these queues is randomly chosen.</span></span> <span data-ttu-id="89620-215">Se você definir o valor como 1, somente uma fila poderá ser usada.</span><span class="sxs-lookup"><span data-stu-id="89620-215">If you set the value to 1, then only one queue can ever be used.</span></span> <span data-ttu-id="89620-216">Quando isso acontece e a fila de lista de pendências gera erros, o cliente não pode tentar uma fila de lista de pendências diferente e pode não enviar a mensagem.</span><span class="sxs-lookup"><span data-stu-id="89620-216">When this happens and the one backlog queue generates errors, the client is not able to try a different backlog queue and may fail to send your message.</span></span> <span data-ttu-id="89620-217">É recomendável definir esse valor como algum valor maior e usar como padrão o valor de 10.</span><span class="sxs-lookup"><span data-stu-id="89620-217">We recommend setting this value to some larger value and default the value to 10.</span></span> <span data-ttu-id="89620-218">Você pode alterar isso para um valor maior ou menor, dependendo de quantos dados seu aplicativo envia por dia.</span><span class="sxs-lookup"><span data-stu-id="89620-218">You can change this to a higher or lower value depending on how much data your application sends per day.</span></span> <span data-ttu-id="89620-219">Cada fila de lista de pendências pode manter até 5 GB de mensagens.</span><span class="sxs-lookup"><span data-stu-id="89620-219">Each backlog queue can hold up to 5 GB of messages.</span></span>
* <span data-ttu-id="89620-220">*failoverInterval*: o tempo durante o qual você aceitará falhas no namespace principal antes de alternar qualquer entidade para o namespace secundário.</span><span class="sxs-lookup"><span data-stu-id="89620-220">*failoverInterval*: The amount of time during which you will accept failures on the primary namespace before switching any single entity over to the secondary namespace.</span></span> <span data-ttu-id="89620-221">Os failovers ocorrem em entidades individuais.</span><span class="sxs-lookup"><span data-stu-id="89620-221">Failovers occur on an entity-by-entity basis.</span></span> <span data-ttu-id="89620-222">Entidades em um único namespace frequentemente estão em nós diferentes no Barramento de Serviço.</span><span class="sxs-lookup"><span data-stu-id="89620-222">Entities in a single namespace frequently live in different nodes within Service Bus.</span></span> <span data-ttu-id="89620-223">Uma falha em uma entidade não implica falha em outra.</span><span class="sxs-lookup"><span data-stu-id="89620-223">A failure in one entity does not imply a failure in another.</span></span> <span data-ttu-id="89620-224">Você pode definir esse valor como [System.TimeSpan.Zero][System.TimeSpan.Zero] para realizar o failover para o secundário imediatamente após a primeira falha não transitória.</span><span class="sxs-lookup"><span data-stu-id="89620-224">You can set this value to [System.TimeSpan.Zero][System.TimeSpan.Zero] to failover to the secondary immediately after your first, non-transient failure.</span></span> <span data-ttu-id="89620-225">Falhas que disparam o temporizador de failover são qualquer [MessagingException][MessagingException] em que a propriedade [IsTransient][IsTransient] é falsa ou um [System.TimeoutException][System.TimeoutException].</span><span class="sxs-lookup"><span data-stu-id="89620-225">Failures that trigger the failover timer are any [MessagingException][MessagingException] in which the [IsTransient][IsTransient] property is false, or a [System.TimeoutException][System.TimeoutException].</span></span> <span data-ttu-id="89620-226">Outras exceções, como [UnauthorizedAccessException][UnauthorizedAccessException], não causam o failover, pois indicam que o cliente está configurado incorretamente.</span><span class="sxs-lookup"><span data-stu-id="89620-226">Other exceptions, such as [UnauthorizedAccessException][UnauthorizedAccessException] do not cause failover, because they indicate that the client is configured incorrectly.</span></span> <span data-ttu-id="89620-227">Um [ServerBusyException][ServerBusyException] não causa failover porque o padrão correto é esperar 10 segundos e, em seguida, enviar a mensagem novamente.</span><span class="sxs-lookup"><span data-stu-id="89620-227">A [ServerBusyException][ServerBusyException] does not cause failover because the correct pattern is to wait 10 seconds, then send the message again.</span></span>
* <span data-ttu-id="89620-228">*enableSyphon*: indica que esse emparelhamento específico também deve encaminhar mensagens do namespace secundário de volta ao namespace primário.</span><span class="sxs-lookup"><span data-stu-id="89620-228">*enableSyphon*: Indicates that this particular pairing should also syphon messages from the secondary namespace back to the primary namespace.</span></span> <span data-ttu-id="89620-229">Em geral, aplicativos que enviam mensagens devem definir esse valor como **false**; aplicativos que recebem mensagens devem definir esse valor como **true**.</span><span class="sxs-lookup"><span data-stu-id="89620-229">In general, applications that send messages should set this value to **false**; applications that receive messages should set this value to **true**.</span></span> <span data-ttu-id="89620-230">A razão disso é que, com frequência, há menos receptores de mensagens do que remetentes de mensagens.</span><span class="sxs-lookup"><span data-stu-id="89620-230">The reason for this is that frequently, there are fewer message receivers than message senders.</span></span> <span data-ttu-id="89620-231">Dependendo do número de destinatários, você pode optar por ter uma única instância do aplicativo lidando com as tarefas de encaminhamento.</span><span class="sxs-lookup"><span data-stu-id="89620-231">Depending on the number of receivers, you can choose to have a single application instance handle the syphon duties.</span></span> <span data-ttu-id="89620-232">Usar muitos receptores tem implicações de cobranças para cada fila de lista de pendências.</span><span class="sxs-lookup"><span data-stu-id="89620-232">Using many receivers has billing implications for each backlog queue.</span></span>

<span data-ttu-id="89620-233">Para usar o código, crie uma instância principal de [MessagingFactory][MessagingFactory], uma instância secundária de [MessagingFactory][MessagingFactory], uma instância secundária de [NamespaceManager][NamespaceManager] e uma instância de [SendAvailabilityPairedNamespaceOptions][SendAvailabilityPairedNamespaceOptions].</span><span class="sxs-lookup"><span data-stu-id="89620-233">To use the code, create a primary [MessagingFactory][MessagingFactory] instance, a secondary [MessagingFactory][MessagingFactory] instance, a secondary [NamespaceManager][NamespaceManager] instance, and a [SendAvailabilityPairedNamespaceOptions][SendAvailabilityPairedNamespaceOptions] instance.</span></span> <span data-ttu-id="89620-234">A chamada pode ser tão simples quanto o seguinte exemplo:</span><span class="sxs-lookup"><span data-stu-id="89620-234">The call can be as simple as the following:</span></span>

```csharp
SendAvailabilityPairedNamespaceOptions sendAvailabilityOptions = new SendAvailabilityPairedNamespaceOptions(secondaryNamespaceManager, secondary);
primary.PairNamespaceAsync(sendAvailabilityOptions).Wait();
```

<span data-ttu-id="89620-235">Quando a tarefa retornada pelo método [PairNamespaceAsync][PairNamespaceAsync] for concluída, tudo está configurado e pronto para uso.</span><span class="sxs-lookup"><span data-stu-id="89620-235">When the task returned by the [PairNamespaceAsync][PairNamespaceAsync] method completes, everything is set up and ready to use.</span></span> <span data-ttu-id="89620-236">Antes que a tarefa seja retornada, você pode não ter concluído todo o trabalho de segundo plano necessário para que o emparelhamento funcione corretamente.</span><span class="sxs-lookup"><span data-stu-id="89620-236">Before the task is returned, you may not have completed all of the background work necessary for the pairing to work right.</span></span> <span data-ttu-id="89620-237">Como resultado, você não deve começar a enviar mensagens até que a tarefa seja retornada.</span><span class="sxs-lookup"><span data-stu-id="89620-237">As a result, you should not start sending messages until the task returns.</span></span> <span data-ttu-id="89620-238">Se alguma falha ocorrer, como credenciais inválidas ou falha ao criar filas de listas de pendências, essas exceções serão geradas quando a tarefa for concluída.</span><span class="sxs-lookup"><span data-stu-id="89620-238">If any failures occurred, such as bad credentials, or failure to create the backlog queues, those exceptions will be thrown once the task completes.</span></span> <span data-ttu-id="89620-239">Depois que a tarefa for retornada, verifique se as filas foram encontradas ou criadas examinando a propriedade [BacklogQueueCount][BacklogQueueCount] em sua instância de [SendAvailabilityPairedNamespaceOptions][SendAvailabilityPairedNamespaceOptions].</span><span class="sxs-lookup"><span data-stu-id="89620-239">Once the task returns, verify that the queues were found or created by examining the [BacklogQueueCount][BacklogQueueCount] property on your [SendAvailabilityPairedNamespaceOptions][SendAvailabilityPairedNamespaceOptions] instance.</span></span> <span data-ttu-id="89620-240">No código anterior, essa operação aparece da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="89620-240">For the preceding code, that operation appears as follows:</span></span>

```csharp
if (sendAvailabilityOptions.BacklogQueueCount < 1)
{
    // Handle case where no queues were created.
}
```

## <a name="next-steps"></a><span data-ttu-id="89620-241">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="89620-241">Next steps</span></span>
<span data-ttu-id="89620-242">Agora que você aprendeu os conceitos básicos sobre mensagens assíncronas no Barramento de Serviço, leia mais detalhes sobre [namespaces emparelhados][paired namespaces].</span><span class="sxs-lookup"><span data-stu-id="89620-242">Now that you've learned the basics of asynchronous messaging in Service Bus, read more details about [paired namespaces][paired namespaces].</span></span>

[ServerBusyException]: /dotnet/api/microsoft.servicebus.messaging.serverbusyexception
[System.TimeoutException]: https://msdn.microsoft.com/library/system.timeoutexception.aspx
[MessagingException]: /dotnet/api/microsoft.servicebus.messaging.messagingexception
[Best practices for insulating applications against Service Bus outages and disasters]: service-bus-outages-disasters.md
[Microsoft.ServiceBus.Messaging.MessagingFactory]: /dotnet/api/microsoft.servicebus.messaging.messagingfactory
[MessageReceiver]: /dotnet/api/microsoft.servicebus.messaging.messagereceiver
[QueueClient]: /dotnet/api/microsoft.servicebus.messaging.queueclient
[TopicClient]: /dotnet/api/microsoft.servicebus.messaging.topicclient
[Microsoft.ServiceBus.Messaging.PairedNamespaceOptions]: /dotnet/api/microsoft.servicebus.messaging.pairednamespaceoptions
[MessagingFactory]: /dotnet/api/microsoft.servicebus.messaging.messagingfactory
[SendAvailabilityPairedNamespaceOptions]: /dotnet/api/microsoft.servicebus.messaging.sendavailabilitypairednamespaceoptions
[NamespaceManager]: /dotnet/api/microsoft.servicebus.namespacemanager
[PairNamespaceAsync]: /dotnet/api/microsoft.servicebus.messaging.messagingfactory#Microsoft_ServiceBus_Messaging_MessagingFactory_PairNamespaceAsync_Microsoft_ServiceBus_Messaging_PairedNamespaceOptions_
[EnableSyphon]: /dotnet/api/microsoft.servicebus.messaging.sendavailabilitypairednamespaceoptions#Microsoft_ServiceBus_Messaging_SendAvailabilityPairedNamespaceOptions_EnableSyphon
[System.TimeSpan.Zero]: https://msdn.microsoft.com/library/system.timespan.zero.aspx
[IsTransient]: /dotnet/api/microsoft.servicebus.messaging.messagingexception#Microsoft_ServiceBus_Messaging_MessagingException_IsTransient
[UnauthorizedAccessException]: https://msdn.microsoft.com/library/system.unauthorizedaccessexception.aspx
[BacklogQueueCount]: /dotnet/api/microsoft.servicebus.messaging.sendavailabilitypairednamespaceoptions?redirectedfrom=MSDN#Microsoft_ServiceBus_Messaging_SendAvailabilityPairedNamespaceOptions_BacklogQueueCount
[paired namespaces]: service-bus-paired-namespaces.md
