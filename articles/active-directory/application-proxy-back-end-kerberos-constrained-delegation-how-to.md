---
title: "aaaHow tooconfigure um aplicativo de Proxy de aplicativo toouse delegação restrita de Kerberos | Microsoft Docs"
description: "Como tooconfigure delegação restrita de Kerberos para um aplicativo de Proxy de aplicativo do Azure AD."
services: active-directory
documentationcenter: 
author: ajamess
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/11/2017
ms.author: asteen
ms.openlocfilehash: 93dac264ff1d3b99dead1d9c759c37c59373cbd4
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/06/2017
---
# <a name="how-tooconfigure-an-application-proxy-application-toouse-kerberos-constrained-delegation"></a><span data-ttu-id="9f195-103">Como tooconfigure um aplicativo de Proxy de aplicativo toouse delegação restrita de Kerberos</span><span class="sxs-lookup"><span data-stu-id="9f195-103">How tooconfigure an Application Proxy application toouse Kerberos Constrained Delegation</span></span>

<span data-ttu-id="9f195-104">Olá métodos disponíveis para a obtenção de SSO toopublished aplicativos podem variar um pouco de tooapplication do aplicativo e uma das opções de saudação que o Proxy de aplicativo do Azure oferece direita sem necessidade de saudação é a delegação restrita de Kerberos (KCD).</span><span class="sxs-lookup"><span data-stu-id="9f195-104">hello methods available for achieving SSO toopublished applications can somewhat vary from application tooapplication and one of hello options that Azure Application Proxy offers right out of hello box, is Kerberos Constrained Delegation (KCD).</span></span> <span data-ttu-id="9f195-105">Isso é onde um host do conector é configurado tooperform restringido de kerberos authentication toobackend aplicativos, em nome dos usuários.</span><span class="sxs-lookup"><span data-stu-id="9f195-105">This is where a connector host is configured tooperform constrained kerberos authentication toobackend applications, on behalf of users.</span></span>

<span data-ttu-id="9f195-106">procedimento real de saudação para habilitar o KCD é relativamente simples e normalmente requer não mais do que uma compreensão geral dos Olá vários componentes e fluxo de autenticação que facilita o SSO.</span><span class="sxs-lookup"><span data-stu-id="9f195-106">hello actual procedure for enabling KCD is relatively straightforward and typically requires no more than a general understanding of hello various components and authentication flow that facilitates SSO.</span></span> <span data-ttu-id="9f195-107">Localizando boas fontes de informações toohelp solucionar cenários onde o KCD SSO não funciona conforme o esperado, podem ser esparsas.</span><span class="sxs-lookup"><span data-stu-id="9f195-107">Finding good sources of information toohelp troubleshoot scenarios where KCD SSO doesn’t function as expected, can be sparse.</span></span>

<span data-ttu-id="9f195-108">Dessa forma, este artigo tenta tooprovide um único ponto de referência que deve ajudar a solucionar e corrigir automaticamente alguns dos problemas mais comuns de saudação que podemos ver.</span><span class="sxs-lookup"><span data-stu-id="9f195-108">As such, this article attempts tooprovide a single point of reference that should help troubleshoot and self-remediate some of hello most common issues that we see.</span></span> <span data-ttu-id="9f195-109">No hello orientações adicionais do mesmo oferta de tempo para diagnosticar hello mais complexo e problemática de implementação.</span><span class="sxs-lookup"><span data-stu-id="9f195-109">At hello same time offer additional guidance for diagnosing hello more complex and troubled of implementation.</span></span>

<span data-ttu-id="9f195-110">Observe que este artigo faz Olá seguintes suposições:</span><span class="sxs-lookup"><span data-stu-id="9f195-110">note that this article makes hello following assumptions:</span></span>

-   <span data-ttu-id="9f195-111">Proxy de aplicativo do Azure foi implantado como por nossa [documentação](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) e aplicativos de KCD toonon acesso geral está funcionando conforme o esperado.</span><span class="sxs-lookup"><span data-stu-id="9f195-111">Azure Application Proxy has been deployed as per our [documentation](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) and general access toonon KCD applications is working as expected.</span></span>

-   <span data-ttu-id="9f195-112">Olá aplicativo de destino publicado baseia-se na implementação do IIS e da Microsoft do kerberos.</span><span class="sxs-lookup"><span data-stu-id="9f195-112">hello published target application is based on IIS and Microsoft’s implementation of kerberos.</span></span>

-   <span data-ttu-id="9f195-113">hosts de servidor e aplicativo Hello residam em um único domínio do Active Directory.</span><span class="sxs-lookup"><span data-stu-id="9f195-113">hello server and application hosts reside in a single Active Directory domain.</span></span> <span data-ttu-id="9f195-114">Informações detalhadas sobre entre cenários de floresta e de domínio podem ser encontradas em nosso [documento técnico de KCD](http://aka.ms/KCDPaper).</span><span class="sxs-lookup"><span data-stu-id="9f195-114">Detailed information on cross domain and forest scenarios can be found in our [KCD whitepaper](http://aka.ms/KCDPaper).</span></span>

-   <span data-ttu-id="9f195-115">Olá assunto aplicativo é publicado em um Azure locatário com pré-autenticação habilitada e os usuários são esperados tooAzure tooauthenticate por meio de formulários de autenticação baseada em.</span><span class="sxs-lookup"><span data-stu-id="9f195-115">hello subject application is published in an Azure tenant with pre-authentication enabled, and users are expected tooauthenticate tooAzure via forms based authentication.</span></span> <span data-ttu-id="9f195-116">Cenários de autenticação de cliente avançados não são cobertos por este artigo, mas ser adicionados em algum momento no futuro de saudação.</span><span class="sxs-lookup"><span data-stu-id="9f195-116">Rich client authentication scenarios are not covered by this article, but be added at some point in hello future.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="9f195-117">Pré-requisitos</span><span class="sxs-lookup"><span data-stu-id="9f195-117">Prerequisites</span></span>

<span data-ttu-id="9f195-118">Proxy de aplicativo do Azure pode ser implantado em praticamente qualquer tipo de infraestrutura ou arquiteturas de ambiente e hello sem dúvida variam de tooorganization da organização.</span><span class="sxs-lookup"><span data-stu-id="9f195-118">Azure Application Proxy can be deployed into pretty much any type of infrastructure or environment and hello architectures no doubt vary from organization tooorganization.</span></span> <span data-ttu-id="9f195-119">Uma das causas mais comuns de saudação do KCD relacionados a problemas não são ambientes hello, mas simples configurações incorreta ou supervisão geral.</span><span class="sxs-lookup"><span data-stu-id="9f195-119">One of hello most common causes of KCD related issues are not hello environments themselves, but rather simple mis-configurations, or general oversight.</span></span>

<span data-ttu-id="9f195-120">Por esse motivo, nosso conselho é sempre toostart, certificando-se de ter atendido todos os pré-requisitos Olá dispostos em nosso principal [usando KCD SSO com o artigo de Proxy de aplicativo hello](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) antes de iniciar de solução de problemas.</span><span class="sxs-lookup"><span data-stu-id="9f195-120">For this reason, our advice is always toostart by making sure you have met all hello pre-requisites laid out in our main [Using KCD SSO with hello Application Proxy article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) before starting troubleshooting.</span></span>

<span data-ttu-id="9f195-121">Particularmente Olá seção Configurar o KCD em 2012R2, pois isso emprega uma abordagem fundamentalmente diferente de tooconfiguring KCD em versões anteriores do Windows, mas também enquanto estiver sendo atento várias outras considerações:</span><span class="sxs-lookup"><span data-stu-id="9f195-121">Particularly hello section on configuring KCD on 2012R2, as this employs a fundamentally different approach tooconfiguring KCD on previous versions of Windows, but also while being mindful of several other considerations:</span></span>

-   <span data-ttu-id="9f195-122">Não é incomum um tooopen de servidor membro do domínio uma caixa de diálogo de canal seguro com um controlador de domínio específico.</span><span class="sxs-lookup"><span data-stu-id="9f195-122">It is not uncommon for a domain member server tooopen a secure channel dialog with a specific domain controller.</span></span> <span data-ttu-id="9f195-123">Mova tooanother diálogo a qualquer momento, para que hosts de conector geralmente não devem ser toocommunicate capaz de toobeing restrito com controladores de domínio do site local somente específico.</span><span class="sxs-lookup"><span data-stu-id="9f195-123">Then move tooanother dialog at any given time, so connector hosts should generally not be restricted toobeing able toocommunicate with only specific local site DCs.</span></span>

-   <span data-ttu-id="9f195-124">Toohello semelhante acima ponto, entre domínios cenários dependem de referências para direcionam um tooDCs de host do conector que ficam fora do perímetro da rede local de saudação.</span><span class="sxs-lookup"><span data-stu-id="9f195-124">Similar toohello above point, cross domain scenarios rely on referrals that direct a connector host tooDCs that may reside outside of hello local network perimeter.</span></span> <span data-ttu-id="9f195-125">Nesse cenário, é igualmente importante toomake-se de que também permite tráfego em diante tooDCs que representam a outros domínios do respectivos, caso contrário, a delegação falhar.</span><span class="sxs-lookup"><span data-stu-id="9f195-125">In this scenario it is equally important toomake sure you are also allowing traffic onwards tooDCs that represent other respective domains, or else delegation fail.</span></span>

-   <span data-ttu-id="9f195-126">Sempre que possível, você deve evitar colocar todos os dispositivos IDS/IPS ativos entre hosts de conector e controladores de domínio, pois esses são às vezes intrusivos demais e interferem com o tráfego RPC de núcleo</span><span class="sxs-lookup"><span data-stu-id="9f195-126">Where possible, you should avoid placing any active IPS/IDS devices between connector hosts and DCs, as these are sometimes over intrusive and interfere with core RPC traffic</span></span>

<span data-ttu-id="9f195-127">Quanto gostaríamos tooresolve problemas rapidamente e com eficiência, pode levar tempo, portanto sempre que possível você deve tentar e teste delegação hello mais simples de cenários.</span><span class="sxs-lookup"><span data-stu-id="9f195-127">As much as we’d like tooresolve issues quickly and effectively, it can take time, so where possible you should try and test delegation in hello simplest of scenarios.</span></span> <span data-ttu-id="9f195-128">Olá mais variáveis que você introduz, hello mais você pode ter toocontend com.</span><span class="sxs-lookup"><span data-stu-id="9f195-128">hello more variables you introduce, hello more you may have toocontend with.</span></span> <span data-ttu-id="9f195-129">Por exemplo, limitar seu teste tooa único conector gastar tempo e conectores adicionais podem ser adicionados depois problemas Olá foi resolvido.</span><span class="sxs-lookup"><span data-stu-id="9f195-129">For example, limiting your testing tooa single connector can save valuable time, and additional connectors can be added after hello issues has been resolved.</span></span>

<span data-ttu-id="9f195-130">Alguns fatores ambientais podem também estar contribuindo problema tooan, novamente se possível, tente e minimiza Olá arquitetura tooa mínimo para teste.</span><span class="sxs-lookup"><span data-stu-id="9f195-130">Some environmental factors may also be contributing tooan issue, so again if possible try and minimize hello architecture tooa bare minimum for testing.</span></span> <span data-ttu-id="9f195-131">Por exemplo, o firewall interno configurado incorretamente ACLs não são incomuns, portanto, se possível ter todo o tráfego de um conector permitido diretamente por meio de controladores de domínio toohello e aplicativo de back-end.</span><span class="sxs-lookup"><span data-stu-id="9f195-131">For example, misconfigured internal firewall ACLs are not uncommon, so if possible have all traffic from a connector allowed straight through toohello DCs and backend application.</span></span> 

<span data-ttu-id="9f195-132">Na verdade Olá absoluto melhor lugar tooposition os conectores é fechar como destinos de tootheir como pode ser.</span><span class="sxs-lookup"><span data-stu-id="9f195-132">Actually hello absolute best place tooposition connectors is as close tootheir targets as can be.</span></span> <span data-ttu-id="9f195-133">Ter um firewall embutido durante testes simplesmente adiciona complexidade desnecessária e apenas pode prolongar as investigações.</span><span class="sxs-lookup"><span data-stu-id="9f195-133">Having a firewall sat inline whilst testing simply adds unnecessary complexity, and could just prolong your investigations.</span></span>

<span data-ttu-id="9f195-134">Portanto, então o que constitui um problema KCD?</span><span class="sxs-lookup"><span data-stu-id="9f195-134">So, what constitutes a KCD problem anyway?</span></span> <span data-ttu-id="9f195-135">Bem, há várias indicações clássicas de SSO KCD com falha e hello sinais primeiro de um problema geralmente se manifestam em Olá navegador.</span><span class="sxs-lookup"><span data-stu-id="9f195-135">Well, there several classic indications of KCD SSO failing and hello first signs of an issue usually manifest themselves in hello browser.</span></span>

   ![Erro de configuração do KCD incorreto](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic1.png)

   ![Falha devido a permissões toomissing de autorização](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic2.png)

<span data-ttu-id="9f195-138">todos os que lembre Olá sintoma mesmo falhando tooperform SSO e, consequentemente, negando Olá aplicativo de toohello de acesso do usuário.</span><span class="sxs-lookup"><span data-stu-id="9f195-138">all which bear hello same symptom of failing tooperform SSO, and consequently denying hello user access toohello application.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="9f195-139">Solucionar problemas</span><span class="sxs-lookup"><span data-stu-id="9f195-139">Troubleshooting</span></span>

<span data-ttu-id="9f195-140">Como solucionar, em seguida, dependem de problema hello e observado sintomas.</span><span class="sxs-lookup"><span data-stu-id="9f195-140">How you then troubleshoot depend on hello issue and observed symptoms.</span></span> <span data-ttu-id="9f195-141">Antes de continuar ainda mais seria sugerimos Olá seguindo os links, pois eles contêm informações úteis que você ainda não pode ter vindo em:</span><span class="sxs-lookup"><span data-stu-id="9f195-141">Before going any further we would suggest hello following links, as they contain useful information you may not yet have come across:</span></span>

-   [<span data-ttu-id="9f195-142">Solucionar problemas e mensagens de erro do Application Proxy</span><span class="sxs-lookup"><span data-stu-id="9f195-142">Troubleshoot Application Proxy problems and error messages</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot)

-   [<span data-ttu-id="9f195-143">Sintomas e erros de Kerberos</span><span class="sxs-lookup"><span data-stu-id="9f195-143">Kerberos errors and symptoms</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot#kerberos-errors)

-   [<span data-ttu-id="9f195-144">Trabalhando com o SSO as identidades locais e na nuvem não são idênticas</span><span class="sxs-lookup"><span data-stu-id="9f195-144">Working with SSO when on-premises and cloud identities are not identical</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd#working-with-sso-when-on-premises-and-cloud-identities-are-not-identical)

<span data-ttu-id="9f195-145">Se você tiver isso agora, em seguida, hello principal problema definitivamente existe.</span><span class="sxs-lookup"><span data-stu-id="9f195-145">If you’ve got this far, then hello main issue definitely exists.</span></span> <span data-ttu-id="9f195-146">Você precisa toodig mais profunda, portanto iniciar separando o fluxo de saudação em três estágios distintos que você pode solucionar problemas.</span><span class="sxs-lookup"><span data-stu-id="9f195-146">You need toodig deeper, so start by separating hello flow into three distinct stages that you can troubleshoot.</span></span>

<span data-ttu-id="9f195-147">**Pré-autenticação de cliente** -tooAzure por meio de um navegador de autenticação do usuário externo hello.</span><span class="sxs-lookup"><span data-stu-id="9f195-147">**Client pre-authentication** - hello external user authenticating tooAzure via a browser.</span></span>

<span data-ttu-id="9f195-148">Ser capaz de toopre-autenticar tooAzure é obrigatório para KCD SSO toofunction.</span><span class="sxs-lookup"><span data-stu-id="9f195-148">Being able toopre-authenticate tooAzure is imperative for KCD SSO toofunction.</span></span> <span data-ttu-id="9f195-149">Isso deverá ser testado e abordado primeiro, se houver algum problema.</span><span class="sxs-lookup"><span data-stu-id="9f195-149">This should be tested and addressed first, if there are any issues.</span></span> <span data-ttu-id="9f195-150">Observe que a fase de pré-autenticação Olá não tem nenhuma relação tooKCD ou hello aplicativo publicado.</span><span class="sxs-lookup"><span data-stu-id="9f195-150">Note that hello pre-authentication stage has no relation tooKCD or hello published application.</span></span> <span data-ttu-id="9f195-151">Ele deve ser relativamente fácil toocorrect quaisquer discrepâncias por integridade verificar conta de entidade Olá existe no Azure, e que não é desabilitadom/bloqueado.</span><span class="sxs-lookup"><span data-stu-id="9f195-151">It should be fairly easy toocorrect any discrepancies by sanity checking hello subject account exists in Azure, and that it is not disabled/blocked.</span></span> <span data-ttu-id="9f195-152">resposta de erro Olá no navegador de saudação é geralmente suficientemente descritivo toounderstand hello.</span><span class="sxs-lookup"><span data-stu-id="9f195-152">hello error response in hello browser is usually descriptive enough toounderstand hello cause.</span></span> <span data-ttu-id="9f195-153">Se você não tiver certeza, você também pode verificar nossos outros tooverify de documentos de solução de problemas.</span><span class="sxs-lookup"><span data-stu-id="9f195-153">You can also check our other Troubleshoot docs tooverify if you aren’t sure.</span></span>

<span data-ttu-id="9f195-154">**Serviço de delegação** -Olá conector de Proxy do Azure obtendo uma kerberos tíquete de serviço de um KDC (Centro de distribuição de Kerberos), em nome dos usuários.</span><span class="sxs-lookup"><span data-stu-id="9f195-154">**Delegation service** - hello Azure Proxy connector obtaining a kerberos service ticket from a KDC (Kerberos Distribution Center), on behalf of users.</span></span>

<span data-ttu-id="9f195-155">as comunicações externas de saudação entre cliente hello e hello Azure front-end não devem ter nenhuma relevância em KCD natureza, além de garantir que ele funciona.</span><span class="sxs-lookup"><span data-stu-id="9f195-155">hello external communications between hello client and hello Azure front end should have no bearing on KCD whatsoever, other than ensuring that it works.</span></span> <span data-ttu-id="9f195-156">Isso é para que Olá serviço Proxy do Azure pode ser fornecido com uma ID de usuário válida que ser tooobtain usado um tíquete kerberos.</span><span class="sxs-lookup"><span data-stu-id="9f195-156">This is so hello Azure Proxy service can be provided with a valid user ID that be used tooobtain a kerberos ticket.</span></span> <span data-ttu-id="9f195-157">Sem isso, KCD não é possível e falharia.</span><span class="sxs-lookup"><span data-stu-id="9f195-157">Without this KCD is not possible and would fail.</span></span>

<span data-ttu-id="9f195-158">Conforme mencionado anteriormente, mensagens de erro do navegador Olá geralmente fornecem algumas dicas BOM por que as coisas estão falhando.</span><span class="sxs-lookup"><span data-stu-id="9f195-158">As mentioned previously, hello browser error messages usually provide some good clues on why things are failing.</span></span> <span data-ttu-id="9f195-159">Verifique se toonote Olá ID da atividade e o carimbo de hora em resposta Olá porque isso permite eventos de tooactual toocorrelate Olá comportamento no log de eventos do Proxy do Azure hello.</span><span class="sxs-lookup"><span data-stu-id="9f195-159">Make sure toonote down hello activity ID and timestamp in hello response as this allow you toocorrelate hello behavior tooactual events in hello Azure Proxy event log.</span></span>

   ![Erro de configuração do KCD incorreto](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic3.png)

<span data-ttu-id="9f195-161">E Olá Olá vistas log de eventos deve ser visto como eventos 13019 ou 12027 as entradas correspondentes.</span><span class="sxs-lookup"><span data-stu-id="9f195-161">And hello corresponding entries seen hello event log would be seen as events 13019 or 12027.</span></span> <span data-ttu-id="9f195-162">Você pode encontrar os logs de eventos do conector no hello **Applications and Services Logs** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Conector**&gt;**Admin**.</span><span class="sxs-lookup"><span data-stu-id="9f195-162">You can find hello connector event logs in **Applications and Services Logs** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connector**&gt;**Admin**.</span></span>

   ![Evento 13019 do log de eventos do Application Proxy](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic4.png)

   ![Evento 12027 do log de eventos do Application Proxy](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic5.png)

-   <span data-ttu-id="9f195-165">Usar um registro no DNS interno para o endereço do aplicativo hello e não um CName</span><span class="sxs-lookup"><span data-stu-id="9f195-165">Use an A record in your internal DNS for hello application’s address, and not a CName</span></span>

-   <span data-ttu-id="9f195-166">Confirmar novamente a host conector Olá recebeu Olá direitos toodelegate toohello designado SPN da conta de destino e que **usar qualquer protocolo de autenticação** está selecionado.</span><span class="sxs-lookup"><span data-stu-id="9f195-166">Re-confirm that hello connector host has been granted hello rights toodelegate toohello designated target account’s SPN, and that **Use any authentication protocol** is selected.</span></span> <span data-ttu-id="9f195-167">Isso é abordado em nosso [artigo de configuração de SSO](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) principal</span><span class="sxs-lookup"><span data-stu-id="9f195-167">This is covered in our main [SSO configuration article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span></span>

-   <span data-ttu-id="9f195-168">Verifique se há apenas uma única instância de saudação SPN existente no AD, emitindo um **setspn - x** em um prompt de cmd em qualquer host de membro de domínio</span><span class="sxs-lookup"><span data-stu-id="9f195-168">Verify that there is only a single instance of hello SPN in existence in AD by issuing a **setspn -x** from a cmd prompt on any domain member host</span></span>

-   <span data-ttu-id="9f195-169">Verificar toosee se uma política de domínio está sendo imposta Olá toolimit [tamanho máximo de tokens emitidos kerberos](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), pois esse conector de saudação impedir Obtenha um token se encontrado toobe excessiva</span><span class="sxs-lookup"><span data-stu-id="9f195-169">Check toosee if a domain policy is being enforced toolimit hello [max size of issued kerberos tokens](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), as this prevent hello connector from obtaining a token if found toobe excessive</span></span>

<span data-ttu-id="9f195-170">Um rastreamento de rede captura trocas de saudação entre o host do conector hello e um domínio do KDC, em seguida, seria a próxima etapa recomendada Olá na obtenção do mais baixo nível obter detalhes sobre problemas Olá.</span><span class="sxs-lookup"><span data-stu-id="9f195-170">A network trace capturing hello exchanges between hello connector host and a domain KDC would then be hello next best step in obtaining more low level detail on hello issues.</span></span> <span data-ttu-id="9f195-171">Você pode encontrar isso no [documento de resolução de problemas para aprofundamento](https://aka.ms/proxytshootpaper).</span><span class="sxs-lookup"><span data-stu-id="9f195-171">You can find this in [deep dive Troubleshoot paper](https://aka.ms/proxytshootpaper).</span></span>

<span data-ttu-id="9f195-172">Se o registro for boa, você verá um evento em logs de saudação informando que a autenticação falhou devido a aplicativo toohello retornando um 401.</span><span class="sxs-lookup"><span data-stu-id="9f195-172">If ticketing looks good, you should see an event in hello logs stating that authentication failed due toohello application returning a 401.</span></span> <span data-ttu-id="9f195-173">Isso geralmente indica que esse aplicativo de destino Olá rejeitando seu tíquete, para prosseguir com hello após o próximo estágio.</span><span class="sxs-lookup"><span data-stu-id="9f195-173">This typically indicates that hello target application rejecting your ticket, so proceed with hello following next stage.</span></span>

<span data-ttu-id="9f195-174">**Aplicativo de destino** -consumidor Olá de tíquete do kerberos Olá fornecido pelo conector Olá</span><span class="sxs-lookup"><span data-stu-id="9f195-174">**Target application** - hello consumer of hello kerberos ticket provided by hello connector</span></span>

<span data-ttu-id="9f195-175">Esse conector de saudação do estágio é esperado toohave enviado um backend de toohello de tíquete de serviço kerberos, como um cabeçalho na primeira solicitação de aplicativo hello.</span><span class="sxs-lookup"><span data-stu-id="9f195-175">At this stage hello connector is expected toohave sent a kerberos service ticket toohello backend, as a header within hello first application request.</span></span>

-   <span data-ttu-id="9f195-176">Usando o aplicativo de hello URL interna definido no portal de hello, validar que o aplicativo hello está acessível diretamente do navegador Olá no host do conector de saudação.</span><span class="sxs-lookup"><span data-stu-id="9f195-176">Using hello application’s internal URL defined in hello portal, validate that hello application is accessible directly from hello browser on hello connector host.</span></span> <span data-ttu-id="9f195-177">Em seguida, você pode fazer logon com êxito.</span><span class="sxs-lookup"><span data-stu-id="9f195-177">Then you can login successfully.</span></span> <span data-ttu-id="9f195-178">Detalhes sobre como fazer isso podem ser encontrados na página de solução de problemas do conector hello.</span><span class="sxs-lookup"><span data-stu-id="9f195-178">Details on doing this can be found on hello connector Troubleshoot page.</span></span>

-   <span data-ttu-id="9f195-179">Ainda no host do conector hello, confirme que a autenticação entre o navegador Olá Olá e aplicativo hello está usando kerberos, seguindo um destes procedimentos hello:</span><span class="sxs-lookup"><span data-stu-id="9f195-179">Still on hello connector host, confirm that hello authentication between hello browser and hello application is using kerberos, by doing one of hello following:</span></span>

1.  <span data-ttu-id="9f195-180">Executar ferramentas de desenvolvimento (**F12**) no Internet Explorer, ou use [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) do host do conector hello.</span><span class="sxs-lookup"><span data-stu-id="9f195-180">Run Dev tools(**F12**) in Internet Explorer, or use [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) from hello connector host.</span></span> <span data-ttu-id="9f195-181">Vá toohello aplicativo usando a URL interna Olá e inspecionar Olá oferecido cabeçalhos de autorização WWW retornados na resposta de saudação do aplicativo hello, tooensure o negotiate ou kerberos está presente.</span><span class="sxs-lookup"><span data-stu-id="9f195-181">Go toohello application using hello internal URL, and inspect hello offered WWW authorization headers returned in hello response from hello application, tooensure that either negotiate or kerberos is present.</span></span> <span data-ttu-id="9f195-182">Um blob de kerberos subsequentes retornado na resposta de saudação do hello navegador toohello aplicativos iniciam normalmente com **YII**, portanto, esta é uma boa indicação de kerberos está em execução.</span><span class="sxs-lookup"><span data-stu-id="9f195-182">A subsequent kerberos blob returned in hello response from hello browser toohello application typically start with **YII**, so this is a good indication of kerberos being in play.</span></span> <span data-ttu-id="9f195-183">NTLM em Olá outro lado sempre começam com **TlRMTVNTUAAB**, que lê NTLMSSP ao decodificar da Base64.</span><span class="sxs-lookup"><span data-stu-id="9f195-183">NTLM on hello other hand always start with **TlRMTVNTUAAB**, which reads NTLMSSP when decoded from Base64.</span></span> <span data-ttu-id="9f195-184">Se você vir **TlRMTVNTUAAB** no início de saudação do blob hello, isso significa que o Kerberos é **não** disponíveis.</span><span class="sxs-lookup"><span data-stu-id="9f195-184">If you see **TlRMTVNTUAAB** at hello start of hello blob, this means that Kerberos is **not** available.</span></span> <span data-ttu-id="9f195-185">Se você não vê isso, é provável que o Kerberos esteja disponível.</span><span class="sxs-lookup"><span data-stu-id="9f195-185">If you don’t see this, Kerberos is likely available.</span></span>

  * <span data-ttu-id="9f195-186">Observe que se usar o Fiddler, esse método exigiria desabilitar temporariamente a proteção estendida na configuração do aplicativo hello no IIS.</span><span class="sxs-lookup"><span data-stu-id="9f195-186">Note, if using Fiddler, this method would require temporarily disabling extended protection on hello application’s config in IIS.</span></span>

     ![Janela de inspeção da rede do navegador](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic6.png)

    <span data-ttu-id="9f195-188">*Figura:* uma vez que isso não começa com TIRMTVNTUAAB, este é um exemplo de que o Kerberos está disponível.</span><span class="sxs-lookup"><span data-stu-id="9f195-188">*Figure:* Since this does not start with TIRMTVNTUAAB, this is an example that Kerberos is available.</span></span> <span data-ttu-id="9f195-189">Este é um exemplo de um Blob de Kerberos que não começa com YII.</span><span class="sxs-lookup"><span data-stu-id="9f195-189">This is an example of a Kerberos Blob that doesn’t start with YII.</span></span>

2.  <span data-ttu-id="9f195-190">Remova temporariamente o NTLM da lista de provedores de saudação no IIS site e acesso de aplicativo diretamente do IE no host de conector.</span><span class="sxs-lookup"><span data-stu-id="9f195-190">Temporarily remove NTLM from hello providers list on IIS site and access app directly from IE on connector host.</span></span> <span data-ttu-id="9f195-191">NTLM não mais na lista de provedores de saudação, você deve estar tooaccess capaz de aplicativo de hello usando apenas o Kerberos.</span><span class="sxs-lookup"><span data-stu-id="9f195-191">With NTLM no longer in hello providers list, you should be able tooaccess hello application using Kerberos only.</span></span> <span data-ttu-id="9f195-192">Se isso falhar, isso indica que há um problema com a configuração do aplicativo hello e a autenticação Kerberos não está funcionando.</span><span class="sxs-lookup"><span data-stu-id="9f195-192">If this fails, then that suggests that there is a problem with hello application’s configuration and Kerberos authentication is not functioning.</span></span>

<span data-ttu-id="9f195-193">Se Kerberos não estiver disponível, a autenticação do aplicativo de verificação Olá negociam as configurações no IIS toomake-se de que é listada mais alto, com NTLM apenas abaixo dela.</span><span class="sxs-lookup"><span data-stu-id="9f195-193">If Kerberos is not available, then check hello application’s authentication settings in IIS toomake sure negotiate is listed topmost, with NTLM just beneath it.</span></span> <span data-ttu-id="9f195-194">(Não Negotiate: kerberos ou Negotiate: PKU2U).</span><span class="sxs-lookup"><span data-stu-id="9f195-194">(Not Negotiate:kerberos or Negotiate:PKU2U).</span></span> <span data-ttu-id="9f195-195">Só continue se Kerberos está funcional.</span><span class="sxs-lookup"><span data-stu-id="9f195-195">Only continue if Kerberos is functional.</span></span>

   ![Fornecedores de autenticação do Windows](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic7.png)
   
-   <span data-ttu-id="9f195-197">Com o Kerberos e NTLM no lugar, permite agora desabilitar temporariamente a pré-autenticação para o aplicativo hello no portal de saudação.</span><span class="sxs-lookup"><span data-stu-id="9f195-197">With Kerberos and NTLM in place, lets now temporarily disable pre-authentication for hello application in hello portal.</span></span> <span data-ttu-id="9f195-198">Veja se você pode acessá-lo de saudação à internet usando a URL externa de saudação.</span><span class="sxs-lookup"><span data-stu-id="9f195-198">See if you can access it from hello internet using hello external URL.</span></span> <span data-ttu-id="9f195-199">Você deve ser tooauthenticate solicitada e deve ser capaz de toodo para Olá mesmo conta Olá usado em etapa anterior.</span><span class="sxs-lookup"><span data-stu-id="9f195-199">You should be prompted tooauthenticate and should be able toodo so with hello same account used in hello previous step.</span></span> <span data-ttu-id="9f195-200">Caso contrário, isso indica um problema com o aplicativo de back-end hello e não KCD afinal.</span><span class="sxs-lookup"><span data-stu-id="9f195-200">If not, this indicates a problem with hello backend application and not KCD at all.</span></span>

-   <span data-ttu-id="9f195-201">Agora, habilite novamente o pré-autenticação no portal de saudação e autenticar por meio do Azure, na tentativa de aplicativo de toohello tooconnect por meio de sua URL externa.</span><span class="sxs-lookup"><span data-stu-id="9f195-201">Now re-enable pre-authentication in hello portal and authenticate through Azure by attempting tooconnect toohello application via it’s external URL.</span></span> <span data-ttu-id="9f195-202">Se tiver falhado SSO, você verá uma mensagem de erro proibido no navegador hello, além de evento 13022 no log de saudação:</span><span class="sxs-lookup"><span data-stu-id="9f195-202">If SSO has failed, then you should see a forbidden error message in hello browser, plus event 13022 in hello log:</span></span>

    <span data-ttu-id="9f195-203">*Conector de Proxy de aplicativo Microsoft AAD não pode autenticar o usuário Olá porque o servidor de back-end Olá responde tooKerberos tentativas de autenticação com um erro HTTP 401.*</span><span class="sxs-lookup"><span data-stu-id="9f195-203">*Microsoft AAD Application Proxy Connector cannot authenticate hello user because hello backend server responds tooKerberos authentication attempts with an HTTP 401 error.*</span></span>

    ![Erro proibido HTTTP 401](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic8.png)

-   <span data-ttu-id="9f195-205">Verifique o pool de aplicativos do hello IIS aplicativo tooensure Olá configurado é configurado toouse Olá mesma conta Olá SPN foi configurada no AD, navegando no IIS conforme ilustrado abaixo</span><span class="sxs-lookup"><span data-stu-id="9f195-205">Check hello IIS application tooensure hello configured application pool is configured toouse hello same account that hello SPN has been configured against in AD, by navigating in IIS as illustrated below</span></span>

    ![Janela de configuração de aplicativo IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic9.png)

    <span data-ttu-id="9f195-207">Depois que você sabe a identidade hello, emita o seguinte de saudação de um toomake de prompt de cmd se que essa conta definitivamente está configurada com hello SPN em questão.</span><span class="sxs-lookup"><span data-stu-id="9f195-207">Once you know hello identity, issue hello following from a cmd prompt toomake sure this account is definitely configured with hello SPN in question.</span></span> <span data-ttu-id="9f195-208">Por exemplo, **setspn – q http/spn.wacketywack.com**</span><span class="sxs-lookup"><span data-stu-id="9f195-208">For example,  **setspn – q http/spn.wacketywack.com**</span></span>

    ![Janela de comando SetSPN](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic10.png)

-   <span data-ttu-id="9f195-210">Verifique que Olá SPN definido nas configurações do aplicativo hello no portal de saudação é Olá mesmo SPN configurado na conta de destino AD Olá em uso por pool de aplicativos do aplicativo hello</span><span class="sxs-lookup"><span data-stu-id="9f195-210">Check that hello SPN defined against hello application’s settings in hello portal is hello same SPN that is configured against hello target AD account in use by hello application’s app pool</span></span>

   ![Configuração de SPN no portal do Azure](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic11.png)
   
-   <span data-ttu-id="9f195-212">Vá para o IIS e selecione Olá **Editor de configuração** opção para o aplicativo hello e navegue muito**system.webServer/security/authentication/windowsAuthentication** toomake-se de que **UseAppPoolCredentials** é definido tootrue</span><span class="sxs-lookup"><span data-stu-id="9f195-212">Go into IIS and select hello **Configuration Editor** option for hello application, and navigate too**system.webServer/security/authentication/windowsAuthentication** toomake sure that **UseAppPoolCredentials** is set tootrue</span></span>

   ![Opção de credencial de pools de aplicativo da configuração do IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic12.png)

<span data-ttu-id="9f195-214">Enquanto estiver sendo útil para melhorar o desempenho de saudação de operações do Kerberos, sair do modo de Kernel habilitado também faz com que o tíquete Olá para hello solicitado toobe serviço descriptografado usando a conta do computador.</span><span class="sxs-lookup"><span data-stu-id="9f195-214">While being useful in improving hello performance of Kerberos operations, leaving Kernel mode enabled also causes hello ticket for hello requested service toobe decrypted using machine account.</span></span> <span data-ttu-id="9f195-215">Isso também é chamado de sistema Local do hello, então ter quebra de tootrue este conjunto KCD quando o aplicativo hello está hospedado em vários servidores em um farm.</span><span class="sxs-lookup"><span data-stu-id="9f195-215">This is also called hello Local system, so having this set tootrue break KCD when hello application is hosted across multiple servers in a farm.</span></span>

-   <span data-ttu-id="9f195-216">Como uma verificação adicional, você também pode desejar Olá toodisable **estendida** proteção muito.</span><span class="sxs-lookup"><span data-stu-id="9f195-216">As an additional check, you may also want toodisable hello **Extended** protection too.</span></span> <span data-ttu-id="9f195-217">Foram encontrados cenários onde isso mostrou toobreak KCD quando habilitado em configurações muito específicas, em que um aplicativo é publicado como uma subpasta do site da Web padrão de saudação.</span><span class="sxs-lookup"><span data-stu-id="9f195-217">There have been encountered scenarios where this has proved toobreak KCD when enabled in very specific configurations, where an application is published as a sub folder of hello Default Web site.</span></span> <span data-ttu-id="9f195-218">Esse em si está configurado para autenticação anônima, deixando as caixas de diálogo todo Olá acinzentadas sugerindo objetos filho não seriam herdar as configurações ativas.</span><span class="sxs-lookup"><span data-stu-id="9f195-218">This itself is configured for Anonymous authentication only, leaving hello entire dialogs greyed out suggesting child objects would not be inheriting any active settings.</span></span> <span data-ttu-id="9f195-219">Mas, onde possível sempre recomendamos com esta configuração habilitada, portanto por todos os de forma de teste, mas não se esqueça de toorestore este tooenabled.</span><span class="sxs-lookup"><span data-stu-id="9f195-219">But where possible we would always recommend having this enabled, so by all means test, but don’t forget toorestore this tooenabled.</span></span>

<span data-ttu-id="9f195-220">Essas verificações adicionais devem ter colocá-lo no toostart de rastrear usando o aplicativo publicado.</span><span class="sxs-lookup"><span data-stu-id="9f195-220">These additional checks should have put you on track toostart using your published application.</span></span> <span data-ttu-id="9f195-221">Você pode ir em frente e aceleração conectores adicionais também serão configurado toodelegate, mas se houver nenhuma outra seria sugerimos uma leitura de nosso passo a passo técnica mais detalhada [guia completo de saudação para aplicativo do AD do Azure de solução de problemas Proxy](https://aka.ms/proxytshootpaper)</span><span class="sxs-lookup"><span data-stu-id="9f195-221">You can go ahead and spin up additional connectors that are also configured toodelegate, but if things are no further then we would suggest a read of our more in-depth technical walkthrough [hello complete guide for Troubleshoot Azure AD Application Proxy](https://aka.ms/proxytshootpaper)</span></span>

<span data-ttu-id="9f195-222">Se você ainda não é possível tooprogress seu problema, suporte deve ser maior que tooassist feliz e continuar aqui.</span><span class="sxs-lookup"><span data-stu-id="9f195-222">If you’re still unable tooprogress your issue, support would be more than happy tooassist and continue from here.</span></span> <span data-ttu-id="9f195-223">Crie um tíquete de suporte diretamente no portal de saudação e tentará alcançar nossos engenheiros tooyou.</span><span class="sxs-lookup"><span data-stu-id="9f195-223">Create a support ticket directly within hello portal and our engineers will reach out tooyou.</span></span>

## <a name="other-scenarios"></a><span data-ttu-id="9f195-224">Outros cenários</span><span class="sxs-lookup"><span data-stu-id="9f195-224">Other scenarios</span></span>

-   <span data-ttu-id="9f195-225">Proxy de aplicativo do Azure solicita um tíquete Kerberos antes de enviar seu aplicativo tooan de solicitação.</span><span class="sxs-lookup"><span data-stu-id="9f195-225">Azure Application Proxy requests a Kerberos ticket before sending its request tooan application.</span></span> <span data-ttu-id="9f195-226">Alguns aplicativos de terceiros 3º como Tableau servidor não deseja que esse método de autenticação e em vez disso, espera hello mais convencional negociações tootake lugar.</span><span class="sxs-lookup"><span data-stu-id="9f195-226">Some 3rd party applications such as Tableau Server do not like this method of authenticating, and rather expects hello more conventional negotiations tootake place,.</span></span> <span data-ttu-id="9f195-227">Olá primeira solicitação é anônima, permitindo Olá aplicativo toorespond com tipos de autenticação de saudação que ele oferece suporte a um 401.</span><span class="sxs-lookup"><span data-stu-id="9f195-227">hello first request is anonymous, allowing hello application toorespond with hello authentication types that it supports through a 401.</span></span>

-   <span data-ttu-id="9f195-228">Autenticação com salto duplo – comumente usado em cenários nos quais um aplicativo é hierárquico, com um back-end e front-end, ambos exigindo autenticação, como o Serviços de Relatórios SQL.</span><span class="sxs-lookup"><span data-stu-id="9f195-228">Double hop authentication - Commonly used in scenarios where an application is tiered, with a backend and front end, both requiring authentication, such as SQL Reporting Services.</span></span>

## <a name="next-steps"></a><span data-ttu-id="9f195-229">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="9f195-229">Next steps</span></span>
[<span data-ttu-id="9f195-230">Configurar a KCD (delegação Restrita de Kerberos) em um domínio gerenciado</span><span class="sxs-lookup"><span data-stu-id="9f195-230">Configure kerberos constrained delegation (KCD) on a managed domain</span></span>](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-enable-kcd)
