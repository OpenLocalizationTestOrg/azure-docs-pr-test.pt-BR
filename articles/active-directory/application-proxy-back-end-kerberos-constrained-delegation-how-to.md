---
title: "Como configurar um aplicativo de Application Proxy para usar a delegação restrita de Kerberos | Microsoft Docs"
description: "Habilitar a delegação restrita de kerberos com base em recursos para o conector de Application Proxy do Azure AD."
services: active-directory
documentationcenter: 
author: ajamess
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/11/2017
ms.author: asteen
ms.openlocfilehash: 3a768c30cb874d42d7b4fbd2eeaa6c0e23904e10
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/03/2017
---
# <a name="how-to-configure-an-application-proxy-application-to-use-kerberos-constrained-delegation"></a><span data-ttu-id="5d3e0-103">Como configurar um aplicativo de Application Proxy para usar a delegação restrita de Kerberos</span><span class="sxs-lookup"><span data-stu-id="5d3e0-103">How to configure an Application Proxy application to use Kerberos Constrained Delegation</span></span>

<span data-ttu-id="5d3e0-104">Os métodos disponíveis para atingir o SSO para aplicativos publicados pode variar um pouco de aplicativo para aplicativo e uma das opções que o Application Proxy do Azure oferece é a delegação restrita de Kerberos (KCD).</span><span class="sxs-lookup"><span data-stu-id="5d3e0-104">The methods available for achieving SSO to published applications can somewhat vary from application to application and one of the options that Azure Application Proxy offers right out of the box, is Kerberos Constrained Delegation (KCD).</span></span> <span data-ttu-id="5d3e0-105">É onde um host do conector é configurado para realizar a autenticação restrita de kerberos para aplicativos de back-end, em nome dos usuários.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-105">This is where a connector host is configured to perform constrained kerberos authentication to backend applications, on behalf of users.</span></span>

<span data-ttu-id="5d3e0-106">O procedimento real para habilitar o KCD é relativamente simples e geralmente exige não mais do que uma compreensão geral dos vários componentes e fluxo de autenticação que facilita o SSO.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-106">The actual procedure for enabling KCD is relatively straightforward and typically requires no more than a general understanding of the various components and authentication flow that facilitates SSO.</span></span> <span data-ttu-id="5d3e0-107">Localizar boas fontes de informações para ajudar a solucionar cenários em que o KCD SSO não funciona conforme o esperado, pode ser esparso.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-107">Finding good sources of information to help troubleshoot scenarios where KCD SSO doesn’t function as expected, can be sparse.</span></span>

<span data-ttu-id="5d3e0-108">Assim, este artigo tenta fornecer um único ponto de referência que deve ajudar a solucionar problemas e solucionar alguns dos problemas mais comuns que vemos por conta própria.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-108">As such, this article attempts to provide a single point of reference that should help troubleshoot and self-remediate some of the most common issues that we see.</span></span> <span data-ttu-id="5d3e0-109">Ao mesmo tempo oferece orientações adicionais para diagnóstico da implementação mais complexa e com problemas.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-109">At the same time offer additional guidance for diagnosing the more complex and troubled of implementation.</span></span>

<span data-ttu-id="5d3e0-110">observe que este artigo pressupõe o seguinte:</span><span class="sxs-lookup"><span data-stu-id="5d3e0-110">note that this article makes the following assumptions:</span></span>

-   <span data-ttu-id="5d3e0-111">Application Proxy do Azure foi implantado de acordo com nossa [documentação](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) e o acesso geral a aplicativos que não são KCD não está funcionando conforme o esperado.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-111">Azure Application Proxy has been deployed as per our [documentation](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) and general access to non KCD applications is working as expected.</span></span>

-   <span data-ttu-id="5d3e0-112">O aplicativo de destino publicado baseia-se na implementação do kerberos da IIS e da Microsoft.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-112">The published target application is based on IIS and Microsoft’s implementation of kerberos.</span></span>

-   <span data-ttu-id="5d3e0-113">Os hosts de servidor e aplicativo residem em um único domínio do Active Directory.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-113">The server and application hosts reside in a single Active Directory domain.</span></span> <span data-ttu-id="5d3e0-114">Informações detalhadas sobre entre cenários de floresta e de domínio podem ser encontradas em nosso [documento técnico de KCD](http://aka.ms/KCDPaper).</span><span class="sxs-lookup"><span data-stu-id="5d3e0-114">Detailed information on cross domain and forest scenarios can be found in our [KCD whitepaper](http://aka.ms/KCDPaper).</span></span>

-   <span data-ttu-id="5d3e0-115">O aplicativo de assunto é publicado no Azure locatário com pré-autenticação habilitado e os usuários devem autenticar no Azure por meio da autenticação baseada em formulários.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-115">The subject application is published in an Azure tenant with pre-authentication enabled, and users are expected to authenticate to Azure via forms based authentication.</span></span> <span data-ttu-id="5d3e0-116">Cenários de autenticação de cliente avançados não são cobertos por este artigo, mas são adicionados em algum momento no futuro.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-116">Rich client authentication scenarios are not covered by this article, but be added at some point in the future.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="5d3e0-117">Pré-requisitos</span><span class="sxs-lookup"><span data-stu-id="5d3e0-117">Prerequisites</span></span>

<span data-ttu-id="5d3e0-118">Application Proxy do Azure pode ser implantado em praticamente qualquer tipo de ambiente ou infraestrutura, e as arquiteturas sem dúvida variam de acordo com a empresa.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-118">Azure Application Proxy can be deployed into pretty much any type of infrastructure or environment and the architectures no doubt vary from organization to organization.</span></span> <span data-ttu-id="5d3e0-119">Uma das causas mais comuns de problemas relacionados a KCD não são os ambientes em si, mas simples configurações ou supervisões incorretas.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-119">One of the most common causes of KCD related issues are not the environments themselves, but rather simple mis-configurations, or general oversight.</span></span>

<span data-ttu-id="5d3e0-120">Por esse motivo, nosso conselho é sempre iniciar, certificando-se de ter atendido todos os pré-requisitos dispostos em nosso artigo principal [Usando KCD SSO com o Application Proxy](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd), antes de iniciar a solução de problemas.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-120">For this reason, our advice is always to start by making sure you have met all the pre-requisites laid out in our main [Using KCD SSO with the Application Proxy article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) before starting troubleshooting.</span></span>

<span data-ttu-id="5d3e0-121">Particularmente, a seção sobre como configurar o KCD em 2012R2, pois isso emprega uma abordagem fundamentalmente diferente para configurar o KCD em versões anteriores do Windows, mas também enquanto estiver sendo atento a várias outras considerações:</span><span class="sxs-lookup"><span data-stu-id="5d3e0-121">Particularly the section on configuring KCD on 2012R2, as this employs a fundamentally different approach to configuring KCD on previous versions of Windows, but also while being mindful of several other considerations:</span></span>

-   <span data-ttu-id="5d3e0-122">Não é incomum que um servidor membro do domínio abra uma caixa de diálogo de canal seguro com um controlador de domínio específico.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-122">It is not uncommon for a domain member server to open a secure channel dialog with a specific domain controller.</span></span> <span data-ttu-id="5d3e0-123">Então passe para outra caixa de diálogo a qualquer momento, de modo que hosts de conector geralmente não devem estar restritos a poderem comunicar-se apenas com os DCs locais.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-123">Then move to another dialog at any given time, so connector hosts should generally not be restricted to being able to communicate with only specific local site DCs.</span></span>

-   <span data-ttu-id="5d3e0-124">Semelhante ao ponto acima, cenários entre domínios dependem de referências para direcionarem um host de conector para controladores de domínio que estejam fora do perímetro da rede local.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-124">Similar to the above point, cross domain scenarios rely on referrals that direct a connector host to DCs that may reside outside of the local network perimeter.</span></span> <span data-ttu-id="5d3e0-125">Neste cenário é igualmente importante garantir que também permita tráfego para os controladores de domínio que representam outros respectivos domínios ou falha de delegação else.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-125">In this scenario it is equally important to make sure you are also allowing traffic onwards to DCs that represent other respective domains, or else delegation fail.</span></span>

-   <span data-ttu-id="5d3e0-126">Sempre que possível, você deve evitar colocar todos os dispositivos IDS/IPS ativos entre hosts de conector e controladores de domínio, pois esses são às vezes intrusivos demais e interferem com o tráfego RPC de núcleo</span><span class="sxs-lookup"><span data-stu-id="5d3e0-126">Where possible, you should avoid placing any active IPS/IDS devices between connector hosts and DCs, as these are sometimes over intrusive and interfere with core RPC traffic</span></span>

<span data-ttu-id="5d3e0-127">Nós gostaríamos de resolver problemas rapidamente e com eficiência, mas isso pode levar tempo, então, onde for possível, teste a delegação no mais simples dos cenários de delegação.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-127">As much as we’d like to resolve issues quickly and effectively, it can take time, so where possible you should try and test delegation in the simplest of scenarios.</span></span> <span data-ttu-id="5d3e0-128">Quanto mais variáveis você introduzir, com mais você pode ter que lidar.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-128">The more variables you introduce, the more you may have to contend with.</span></span> <span data-ttu-id="5d3e0-129">Por exemplo, limitar seus testes a um único conector pode economizar tempo valioso e conectores adicionais podem ser adicionados depois que os problemas tiverem sido resolvidos.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-129">For example, limiting your testing to a single connector can save valuable time, and additional connectors can be added after the issues has been resolved.</span></span>

<span data-ttu-id="5d3e0-130">Alguns fatores ambientais também podem estar contribuindo para um problema, então novamente, se possível, tente minimizar a arquitetura a um mínimo para testes.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-130">Some environmental factors may also be contributing to an issue, so again if possible try and minimize the architecture to a bare minimum for testing.</span></span> <span data-ttu-id="5d3e0-131">Por exemplo, as ACLs de firewall internas mal configuradas não são incomuns, portanto, se possível, tenha todo o tráfego de um conector permitido direto para os controles de domínio e o aplicativo de back-end.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-131">For example, misconfigured internal firewall ACLs are not uncommon, so if possible have all traffic from a connector allowed straight through to the DCs and backend application.</span></span> 

<span data-ttu-id="5d3e0-132">Na verdade, o melhor local absoluto para posicionar os conectores é mais próximo possível de seus destinos.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-132">Actually the absolute best place to position connectors is as close to their targets as can be.</span></span> <span data-ttu-id="5d3e0-133">Ter um firewall embutido durante testes simplesmente adiciona complexidade desnecessária e apenas pode prolongar as investigações.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-133">Having a firewall sat inline whilst testing simply adds unnecessary complexity, and could just prolong your investigations.</span></span>

<span data-ttu-id="5d3e0-134">Portanto, então o que constitui um problema KCD?</span><span class="sxs-lookup"><span data-stu-id="5d3e0-134">So, what constitutes a KCD problem anyway?</span></span> <span data-ttu-id="5d3e0-135">Bem, há várias indicações clássicas de KCD SSO falhando e os primeiros sinais de um problema geralmente se manifestam no navegador.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-135">Well, there several classic indications of KCD SSO failing and the first signs of an issue usually manifest themselves in the browser.</span></span>

   ![Erro de configuração do KCD incorreto](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic1.png)

   ![A autorização falhou devido à falta de permissões](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic2.png)

<span data-ttu-id="5d3e0-138">todos que tenham o mesmo sintoma de falha ao executar o SSO e, consequentemente, negando o acesso do usuário para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-138">all which bear the same symptom of failing to perform SSO, and consequently denying the user access to the application.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="5d3e0-139">Solucionar problemas</span><span class="sxs-lookup"><span data-stu-id="5d3e0-139">Troubleshooting</span></span>

<span data-ttu-id="5d3e0-140">Como você soluciona depende do problema e dos sintomas observados.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-140">How you then troubleshoot depend on the issue and observed symptoms.</span></span> <span data-ttu-id="5d3e0-141">Antes de prosseguir, sugerimos os seguintes links, pois contêm informações úteis que você ainda não encontrou:</span><span class="sxs-lookup"><span data-stu-id="5d3e0-141">Before going any further we would suggest the following links, as they contain useful information you may not yet have come across:</span></span>

-   [<span data-ttu-id="5d3e0-142">Solucionar problemas e mensagens de erro do Application Proxy</span><span class="sxs-lookup"><span data-stu-id="5d3e0-142">Troubleshoot Application Proxy problems and error messages</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot)

-   [<span data-ttu-id="5d3e0-143">Sintomas e erros de Kerberos</span><span class="sxs-lookup"><span data-stu-id="5d3e0-143">Kerberos errors and symptoms</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot#kerberos-errors)

-   [<span data-ttu-id="5d3e0-144">Trabalhando com o SSO as identidades locais e na nuvem não são idênticas</span><span class="sxs-lookup"><span data-stu-id="5d3e0-144">Working with SSO when on-premises and cloud identities are not identical</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd#working-with-sso-when-on-premises-and-cloud-identities-are-not-identical)

<span data-ttu-id="5d3e0-145">Se você chegou até aqui, então, agora, o problema principal definitivamente existe.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-145">If you’ve got this far, then the main issue definitely exists.</span></span> <span data-ttu-id="5d3e0-146">Você precisa se aprofundar, portanto, comece separando o fluxo em três estágios distintos que você pode solucionar.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-146">You need to dig deeper, so start by separating the flow into three distinct stages that you can troubleshoot.</span></span>

<span data-ttu-id="5d3e0-147">**Pré-autenticação de cliente** – o usuário externo realizando autenticação no Azure por meio de um navegador.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-147">**Client pre-authentication** - The external user authenticating to Azure via a browser.</span></span>

<span data-ttu-id="5d3e0-148">Ser capaz de autenticar previamente no Azure é obrigatório para KCD SSO funcionar.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-148">Being able to pre-authenticate to Azure is imperative for KCD SSO to function.</span></span> <span data-ttu-id="5d3e0-149">Isso deverá ser testado e abordado primeiro, se houver algum problema.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-149">This should be tested and addressed first, if there are any issues.</span></span> <span data-ttu-id="5d3e0-150">Observe que a fase de pré-autenticação não tem nenhuma relação com o KCD ou o aplicativo publicado.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-150">Note that the pre-authentication stage has no relation to KCD or the published application.</span></span> <span data-ttu-id="5d3e0-151">Deve ser bastante fácil corrigir discrepâncias por meio da verificação de integridade da conta, se ela existe no Azure, e se ela não está desabilitada/bloqueada.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-151">It should be fairly easy to correct any discrepancies by sanity checking the subject account exists in Azure, and that it is not disabled/blocked.</span></span> <span data-ttu-id="5d3e0-152">A resposta de erro no navegador é normalmente descritiva para entender a causa.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-152">The error response in the browser is usually descriptive enough to understand the cause.</span></span> <span data-ttu-id="5d3e0-153">Você também poderá verificar nossos outros documentos de solução de problemas para verificar, se você não tiver certeza.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-153">You can also check our other Troubleshoot docs to verify if you aren’t sure.</span></span>

<span data-ttu-id="5d3e0-154">**Serviço de delegação** – o conector de Proxy do Azure obtendo um tíquete de serviço do kerberos por meio de um KDC (Centro de distribuição de Kerberos), em nome dos usuários.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-154">**Delegation service** - The Azure Proxy connector obtaining a kerberos service ticket from a KDC (Kerberos Distribution Center), on behalf of users.</span></span>

<span data-ttu-id="5d3e0-155">As comunicações externas entre o cliente e o front-end do Azure não devem ter nenhuma influência sobre o KCD, a não ser garantir que ele funciona.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-155">The external communications between the client and the Azure front end should have no bearing on KCD whatsoever, other than ensuring that it works.</span></span> <span data-ttu-id="5d3e0-156">Isso é para que o serviço de Proxy do Azure possa ser fornecido com uma ID de usuário válida que ser usada para obter um tíquete do kerberos.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-156">This is so the Azure Proxy service can be provided with a valid user ID that be used to obtain a kerberos ticket.</span></span> <span data-ttu-id="5d3e0-157">Sem isso, KCD não é possível e falharia.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-157">Without this KCD is not possible and would fail.</span></span>

<span data-ttu-id="5d3e0-158">Conforme mencionado anteriormente, as mensagens de erro do navegador geralmente fornecem algumas boas dicas do por que as coisas estão falhando.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-158">As mentioned previously, the browser error messages usually provide some good clues on why things are failing.</span></span> <span data-ttu-id="5d3e0-159">Certifique-se de observar a ID da atividade e o carimbo de data/hora na resposta, pois isso lhe permite correlacionar o comportamento à reais eventos no log de eventos do Proxy do Azure.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-159">Make sure to note down the activity ID and timestamp in the response as this allow you to correlate the behavior to actual events in the Azure Proxy event log.</span></span>

   ![Erro de configuração do KCD incorreto](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic3.png)

<span data-ttu-id="5d3e0-161">E as entradas correspondentes visualizadas no log de eventos seria visualizadas como eventos 13019 ou 12027.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-161">And the corresponding entries seen the event log would be seen as events 13019 or 12027.</span></span> <span data-ttu-id="5d3e0-162">Você pode encontrar os logs de eventos do conector em **Logs de aplicativos e serviços**&gt;**Microsoft**&gt;**AadApplicationProxy**&gt;**Conector**&gt;**Admin**.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-162">You can find the connector event logs in **Applications and Services Logs** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connector**&gt;**Admin**.</span></span>

   ![Evento 13019 do log de eventos do Application Proxy](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic4.png)

   ![Evento 12027 do log de eventos do Application Proxy](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic5.png)

-   <span data-ttu-id="5d3e0-165">Usar um registro A no seu DNS interno para o endereço do aplicativo, e não um CName</span><span class="sxs-lookup"><span data-stu-id="5d3e0-165">Use an A record in your internal DNS for the application’s address, and not a CName</span></span>

-   <span data-ttu-id="5d3e0-166">Confirme que o host do conector tenha recebido direitos para delegar para o SPN da conta de destino designada e que **Usar qualquer protocolo de autenticação** esteja selecionado.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-166">Re-confirm that the connector host has been granted the rights to delegate to the designated target account’s SPN, and that **Use any authentication protocol** is selected.</span></span> <span data-ttu-id="5d3e0-167">Isso é abordado em nosso [artigo de configuração de SSO](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) principal</span><span class="sxs-lookup"><span data-stu-id="5d3e0-167">This is covered in our main [SSO configuration article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span></span>

-   <span data-ttu-id="5d3e0-168">Verifique se há apenas uma única instância do SPN em existência no AD, emitindo um **setspn -x** em um prompt de comando em qualquer host de membro de domínio</span><span class="sxs-lookup"><span data-stu-id="5d3e0-168">Verify that there is only a single instance of the SPN in existence in AD by issuing a **setspn -x** from a cmd prompt on any domain member host</span></span>

-   <span data-ttu-id="5d3e0-169">Verifique se uma política de domínio está sendo imposta para limitar o [máximo de tamanho de tokens de kerberos emitidos](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), pois isso impede que o conector obtenha um token se considerado excessivo</span><span class="sxs-lookup"><span data-stu-id="5d3e0-169">Check to see if a domain policy is being enforced to limit the [max size of issued kerberos tokens](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), as this prevent the connector from obtaining a token if found to be excessive</span></span>

<span data-ttu-id="5d3e0-170">Um rastreamento de rede capturando as trocas entre o host de conector e um domínio de KDC seria a próxima etapa recomendada na obtenção de detalhes de nível mais baixo sobre os problemas.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-170">A network trace capturing the exchanges between the connector host and a domain KDC would then be the next best step in obtaining more low level detail on the issues.</span></span> <span data-ttu-id="5d3e0-171">Você pode encontrar isso no [documento de resolução de problemas para aprofundamento](https://aka.ms/proxytshootpaper).</span><span class="sxs-lookup"><span data-stu-id="5d3e0-171">You can find this in [deep dive Troubleshoot paper](https://aka.ms/proxytshootpaper).</span></span>

<span data-ttu-id="5d3e0-172">Se o tíquete parece bom, você verá um evento nos logs, indicando que a autenticação falhou devido ao aplicativo que retorna um 401.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-172">If ticketing looks good, you should see an event in the logs stating that authentication failed due to the application returning a 401.</span></span> <span data-ttu-id="5d3e0-173">Isso geralmente indica que o aplicativo de destino rejeita seu tíquete, então continue com o próximo estágio a seguir.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-173">This typically indicates that the target application rejecting your ticket, so proceed with the following next stage.</span></span>

<span data-ttu-id="5d3e0-174">**Aplicativo de destino** – o consumidor do tíquete do kerberos fornecido pelo conector</span><span class="sxs-lookup"><span data-stu-id="5d3e0-174">**Target application** - The consumer of the kerberos ticket provided by the connector</span></span>

<span data-ttu-id="5d3e0-175">Nesse estágio, é esperado que o conector tenha enviado um tíquete de serviço do kerberos para o back-end, como um cabeçalho dentro da primeira solicitação de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-175">At this stage the connector is expected to have sent a kerberos service ticket to the backend, as a header within the first application request.</span></span>

-   <span data-ttu-id="5d3e0-176">Usando a URL do aplicativo interno definida no portal, valide que o aplicativo é acessível diretamente do navegador no host do conector.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-176">Using the application’s internal URL defined in the portal, validate that the application is accessible directly from the browser on the connector host.</span></span> <span data-ttu-id="5d3e0-177">Em seguida, você pode fazer logon com êxito.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-177">Then you can login successfully.</span></span> <span data-ttu-id="5d3e0-178">Detalhes sobre como fazer isso podem ser encontrados na página de solução de problemas do conector.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-178">Details on doing this can be found on the connector Troubleshoot page.</span></span>

-   <span data-ttu-id="5d3e0-179">Ainda no host do conector, confirme se a autenticação entre o navegador e o aplicativo está usando kerberos, seguindo um destes procedimentos:</span><span class="sxs-lookup"><span data-stu-id="5d3e0-179">Still on the connector host, confirm that the authentication between the browser and the application is using kerberos, by doing one of the following:</span></span>

1.  <span data-ttu-id="5d3e0-180">Execute as ferramentas de desenvolvimento (**F12**) no Internet Explorer, ou use [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) do host de conector.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-180">Run Dev tools(**F12**) in Internet Explorer, or use [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) from the connector host.</span></span> <span data-ttu-id="5d3e0-181">Vá para o aplicativo usando a URL interna e inspecione os cabeçalhos de autorização WWW oferecidos e retornados na resposta do aplicativo, para garantir que negotiate ou kerberos está presente.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-181">Go to the application using the internal URL, and inspect the offered WWW authorization headers returned in the response from the application, to ensure that either negotiate or kerberos is present.</span></span> <span data-ttu-id="5d3e0-182">Um blob de kerberos subsequente retornado na resposta do navegador para o aplicativo geralmente começa com **YII**, portanto, isso é uma boa indicação do kerberos em execução.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-182">A subsequent kerberos blob returned in the response from the browser to the application typically start with **YII**, so this is a good indication of kerberos being in play.</span></span> <span data-ttu-id="5d3e0-183">NTLM, por outro lado, sempre começa com **TlRMTVNTUAAB**, que lê NTLMSSP quando decodificado da Base64.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-183">NTLM on the other hand always start with **TlRMTVNTUAAB**, which reads NTLMSSP when decoded from Base64.</span></span> <span data-ttu-id="5d3e0-184">Se você vê **TlRMTVNTUAAB** no início do blob, isso significa que o Kerberos **não** está disponível.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-184">If you see **TlRMTVNTUAAB** at the start of the blob, this means that Kerberos is **not** available.</span></span> <span data-ttu-id="5d3e0-185">Se você não vê isso, é provável que o Kerberos esteja disponível.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-185">If you don’t see this, Kerberos is likely available.</span></span>

  * <span data-ttu-id="5d3e0-186">Observe que, ao usar o Fiddler, esse método precisa desabilitar temporariamente a proteção estendida na configuração do aplicativo no IIS.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-186">Note, if using Fiddler, this method would require temporarily disabling extended protection on the application’s config in IIS.</span></span>

     ![Janela de inspeção da rede do navegador](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic6.png)

    <span data-ttu-id="5d3e0-188">*Figura:* uma vez que isso não começa com TIRMTVNTUAAB, este é um exemplo de que o Kerberos está disponível.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-188">*Figure:* Since this does not start with TIRMTVNTUAAB, this is an example that Kerberos is available.</span></span> <span data-ttu-id="5d3e0-189">Este é um exemplo de um Blob de Kerberos que não começa com YII.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-189">This is an example of a Kerberos Blob that doesn’t start with YII.</span></span>

2.  <span data-ttu-id="5d3e0-190">Remova temporariamente NTLM na lista de provedores no IIS local e aplicativo de acesso diretamente do IE no host do conector.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-190">Temporarily remove NTLM from the providers list on IIS site and access app directly from IE on connector host.</span></span> <span data-ttu-id="5d3e0-191">Com NTLM não mais na lista de provedores, você deve ser capaz de acessar o aplicativo usando apenas o Kerberos.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-191">With NTLM no longer in the providers list, you should be able to access the application using Kerberos only.</span></span> <span data-ttu-id="5d3e0-192">Se isso falhar, isso indicará que há um problema com a configuração do aplicativo e a autenticação de Kerberos não está funcionando.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-192">If this fails, then that suggests that there is a problem with the application’s configuration and Kerberos authentication is not functioning.</span></span>

<span data-ttu-id="5d3e0-193">Se o Kerberos não estiver disponível, verifique as configurações de autenticação do aplicativo no IIS para verificar se negotiate está listado na parte superior, com NTLM logo abaixo dele.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-193">If Kerberos is not available, then check the application’s authentication settings in IIS to make sure negotiate is listed topmost, with NTLM just beneath it.</span></span> <span data-ttu-id="5d3e0-194">(Não Negotiate: kerberos ou Negotiate: PKU2U).</span><span class="sxs-lookup"><span data-stu-id="5d3e0-194">(Not Negotiate:kerberos or Negotiate:PKU2U).</span></span> <span data-ttu-id="5d3e0-195">Só continue se Kerberos está funcional.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-195">Only continue if Kerberos is functional.</span></span>

   ![Fornecedores de autenticação do Windows](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic7.png)
   
-   <span data-ttu-id="5d3e0-197">Com o Kerberos e NTLM implementados, permite agora desabilitar temporariamente a pré-autenticação para o aplicativo no portal.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-197">With Kerberos and NTLM in place, lets now temporarily disable pre-authentication for the application in the portal.</span></span> <span data-ttu-id="5d3e0-198">Veja se você pode acessá-lo pela Internet usando a URL externa.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-198">See if you can access it from the internet using the external URL.</span></span> <span data-ttu-id="5d3e0-199">Você deve ser solicitado a autenticar e deve ser capaz de fazer isso com a mesma conta usada na etapa anterior.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-199">You should be prompted to authenticate and should be able to do so with the same account used in the previous step.</span></span> <span data-ttu-id="5d3e0-200">Caso contrário, isso indica um problema com o aplicativo de back-end e não KCD todo.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-200">If not, this indicates a problem with the backend application and not KCD at all.</span></span>

-   <span data-ttu-id="5d3e0-201">Agora reabilite a pré-autenticação no portal e autentique por meio do Azure, tentando se conectar ao aplicativo por meio de sua URL externa.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-201">Now re-enable pre-authentication in the portal and authenticate through Azure by attempting to connect to the application via it’s external URL.</span></span> <span data-ttu-id="5d3e0-202">Se houver falha em SSO, você verá uma mensagem de erro proibido do navegador, além de evento 13022 no log:</span><span class="sxs-lookup"><span data-stu-id="5d3e0-202">If SSO has failed, then you should see a forbidden error message in the browser, plus event 13022 in the log:</span></span>

    <span data-ttu-id="5d3e0-203">*Conector do Application Proxy do Microsoft AAD não pode autenticar o usuário porque o servidor back-end responde às tentativas de autenticação do Kerberos com um erro HTTP 401.*</span><span class="sxs-lookup"><span data-stu-id="5d3e0-203">*Microsoft AAD Application Proxy Connector cannot authenticate the user because the backend server responds to Kerberos authentication attempts with an HTTP 401 error.*</span></span>

    ![Erro proibido HTTTP 401](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic8.png)

-   <span data-ttu-id="5d3e0-205">Verifique o aplicativo do IIS para garantir que o pool de aplicativos configurado esteja configurado para usar a mesma conta que o SPN foi configurado no AD, navegando no IIS, conforme ilustrado abaixo</span><span class="sxs-lookup"><span data-stu-id="5d3e0-205">Check the IIS application to ensure the configured application pool is configured to use the same account that the SPN has been configured against in AD, by navigating in IIS as illustrated below</span></span>

    ![Janela de configuração de aplicativo IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic9.png)

    <span data-ttu-id="5d3e0-207">Se você souber a identidade, execute o seguinte em um prompt de comando para verificar se essa conta está definitivamente configurada com o SPN em questão.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-207">Once you know the identity, issue the following from a cmd prompt to make sure this account is definitely configured with the SPN in question.</span></span> <span data-ttu-id="5d3e0-208">Por exemplo, **setspn – q http/spn.wacketywack.com**</span><span class="sxs-lookup"><span data-stu-id="5d3e0-208">For example,  **setspn – q http/spn.wacketywack.com**</span></span>

    ![Janela de comando SetSPN](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic10.png)

-   <span data-ttu-id="5d3e0-210">Verifique se o SPN definido nas configurações do aplicativo no portal é o mesmo SPN configurado em relação à conta do AD de destino usando o pool de aplicativos do aplicativo</span><span class="sxs-lookup"><span data-stu-id="5d3e0-210">Check that the SPN defined against the application’s settings in the portal is the same SPN that is configured against the target AD account in use by the application’s app pool</span></span>

   ![Configuração de SPN no portal do Azure](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic11.png)
   
-   <span data-ttu-id="5d3e0-212">Vá para o IIS e selecione a opção do **Editor de configuração** para o aplicativo e navegue até **system.webServer/security/authentication/windowsAuthentication** para certificar-se de que **UseAppPoolCredentials** está definido como verdadeiro</span><span class="sxs-lookup"><span data-stu-id="5d3e0-212">Go into IIS and select the **Configuration Editor** option for the application, and navigate to **system.webServer/security/authentication/windowsAuthentication** to make sure that **UseAppPoolCredentials** is set to true</span></span>

   ![Opção de credencial de pools de aplicativo da configuração do IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic12.png)

<span data-ttu-id="5d3e0-214">Embora seja útil para melhorar o desempenho das operações de Kerberos, deixar o modo de Kernel habilitado também faz com que a permissão para que o serviço solicitado seja descriptografada com a conta do computador.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-214">While being useful in improving the performance of Kerberos operations, leaving Kernel mode enabled also causes the ticket for the requested service to be decrypted using machine account.</span></span> <span data-ttu-id="5d3e0-215">Isso também é chamado de sistema Local, então, ter essa definição como verdadeira quebra o KCD quando o aplicativo é hospedado em vários servidores em uma fazenda.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-215">This is also called the Local system, so having this set to true break KCD when the application is hosted across multiple servers in a farm.</span></span>

-   <span data-ttu-id="5d3e0-216">Como uma verificação adicional, você também pode ser necessário desabilitar a proteção **estendida** também.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-216">As an additional check, you may also want to disable the **Extended** protection too.</span></span> <span data-ttu-id="5d3e0-217">Foram encontrados cenários em que isso mostrou quebrar o KCD quando habilitado em configurações muito específicas, em que um aplicativo é publicado como uma subpasta do site da Web padrão.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-217">There have been encountered scenarios where this has proved to break KCD when enabled in very specific configurations, where an application is published as a sub folder of the Default Web site.</span></span> <span data-ttu-id="5d3e0-218">Esse em si é configurado para autenticação anônima, deixando as caixas de diálogo todas em cinza, sugerindo que objetos filho não iriam herdar as configurações ativas.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-218">This itself is configured for Anonymous authentication only, leaving the entire dialogs greyed out suggesting child objects would not be inheriting any active settings.</span></span> <span data-ttu-id="5d3e0-219">Mas onde possível, sempre recomendamos ter esse recurso habilitado, então, de qualquer forma, faça o teste, mas não se esqueça de restaurar para habilitado.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-219">But where possible we would always recommend having this enabled, so by all means test, but don’t forget to restore this to enabled.</span></span>

<span data-ttu-id="5d3e0-220">Essas verificações adicionais devem ter colocado você no caminho certo para começar a usar seu aplicativo publicado.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-220">These additional checks should have put you on track to start using your published application.</span></span> <span data-ttu-id="5d3e0-221">Você pode prosseguir e criar conectores adicionais que também são configurados para delegar, mas, caso não haja nenhum outro, sugerimos uma leitura de nosso passo a passo técnico mais aprofundado, [O guia completo para Solucionar Problemas do Application Proxy do Azure AD](https://aka.ms/proxytshootpaper)</span><span class="sxs-lookup"><span data-stu-id="5d3e0-221">You can go ahead and spin up additional connectors that are also configured to delegate, but if things are no further then we would suggest a read of our more in-depth technical walkthrough [The complete guide for Troubleshoot Azure AD Application Proxy](https://aka.ms/proxytshootpaper)</span></span>

<span data-ttu-id="5d3e0-222">Se você ainda não conseguir progredir no problema, o suporte ficará mais do que feliz em ajudar e continuar daqui.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-222">If you’re still unable to progress your issue, support would be more than happy to assist and continue from here.</span></span> <span data-ttu-id="5d3e0-223">Crie um tíquete de suporte diretamente dentro do portal e nossos engenheiros vão entrar em contato.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-223">Create a support ticket directly within the portal and our engineers will reach out to you.</span></span>

## <a name="other-scenarios"></a><span data-ttu-id="5d3e0-224">Outros cenários</span><span class="sxs-lookup"><span data-stu-id="5d3e0-224">Other scenarios</span></span>

-   <span data-ttu-id="5d3e0-225">Application Proxy do Azure solicita um tíquete do Kerberos antes de enviar a solicitação para um aplicativo.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-225">Azure Application Proxy requests a Kerberos ticket before sending its request to an application.</span></span> <span data-ttu-id="5d3e0-226">Alguns aplicativos de terceiros, como Tableau Server, não gostam deste método de autenticação, e em vez disso, esperam que as negociações mais convencionais ocorram.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-226">Some 3rd party applications such as Tableau Server do not like this method of authenticating, and rather expects the more conventional negotiations to take place,.</span></span> <span data-ttu-id="5d3e0-227">A primeira solicitação é anônima, permitindo que o aplicativo responda com os tipos de autenticação que ele oferece suporte através de um 401.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-227">The first request is anonymous, allowing the application to respond with the authentication types that it supports through a 401.</span></span>

-   <span data-ttu-id="5d3e0-228">Autenticação com salto duplo – comumente usado em cenários nos quais um aplicativo é hierárquico, com um back-end e front-end, ambos exigindo autenticação, como o Serviços de Relatórios SQL.</span><span class="sxs-lookup"><span data-stu-id="5d3e0-228">Double hop authentication - Commonly used in scenarios where an application is tiered, with a backend and front end, both requiring authentication, such as SQL Reporting Services.</span></span>

## <a name="next-steps"></a><span data-ttu-id="5d3e0-229">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="5d3e0-229">Next steps</span></span>
[<span data-ttu-id="5d3e0-230">Configurar a KCD (delegação Restrita de Kerberos) em um domínio gerenciado</span><span class="sxs-lookup"><span data-stu-id="5d3e0-230">Configure kerberos constrained delegation (KCD) on a managed domain</span></span>](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-enable-kcd)
