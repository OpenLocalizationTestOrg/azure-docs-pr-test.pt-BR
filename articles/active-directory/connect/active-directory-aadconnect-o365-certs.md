---
title: "Renovação de certificado para usuários do Office 365 e do Azure AD | Microsoft Azure"
description: "Este artigo explica aos usuários do Office 365 como resolver problemas com emails que notificam sobre a renovação de um certificado."
services: active-directory
documentationcenter: 
author: billmath
manager: femila
editor: curtand
ms.assetid: 543b7dc1-ccc9-407f-85a1-a9944c0ba1be
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/12/2017
ms.author: billmath
ms.openlocfilehash: 7f1a3303eff9c413602e745b702baa659343eba6
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/03/2017
---
# <a name="renew-federation-certificates-for-office-365-and-azure-active-directory"></a><span data-ttu-id="dda74-103">Renovar certificados de federação para o Office 365 e o Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="dda74-103">Renew federation certificates for Office 365 and Azure Active Directory</span></span>
## <a name="overview"></a><span data-ttu-id="dda74-104">Visão geral</span><span class="sxs-lookup"><span data-stu-id="dda74-104">Overview</span></span>
<span data-ttu-id="dda74-105">Para a federação bem-sucedida entre o Azure AD (Azure Active Directory) e o AD FS (Serviços de Federação do Active Directory), os certificados usados pelo AD FS para assinar tokens de segurança no Azure AD devem corresponder ao que está configurado no Azure AD.</span><span class="sxs-lookup"><span data-stu-id="dda74-105">For successful federation between Azure Active Directory (Azure AD) and Active Directory Federation Services (AD FS), the certificates used by AD FS to sign security tokens to Azure AD should match what is configured in Azure AD.</span></span> <span data-ttu-id="dda74-106">Qualquer incompatibilidade pode interromper a relação de confiança.</span><span class="sxs-lookup"><span data-stu-id="dda74-106">Any mismatch can lead to broken trust.</span></span> <span data-ttu-id="dda74-107">O Azure AD garante que essas informações sejam mantidas em sincronia quando você implanta o AD FS e o Proxy de Aplicativo Web (para acesso à extranet).</span><span class="sxs-lookup"><span data-stu-id="dda74-107">Azure AD ensures that this information is kept in sync when you deploy AD FS and Web Application Proxy (for extranet access).</span></span>

<span data-ttu-id="dda74-108">Este artigo fornece informações adicionais para o gerenciamento de seus certificados de assinatura de token e as mantém em sincronia com o Azure AD nestes casos:</span><span class="sxs-lookup"><span data-stu-id="dda74-108">This article provides you additional information to manage your token signing certificates and keep them in sync with Azure AD, in the following cases:</span></span>

* <span data-ttu-id="dda74-109">Você não está implantando o Proxy de Aplicativo Web e, assim, os metadados de federação não estão disponíveis na extranet.</span><span class="sxs-lookup"><span data-stu-id="dda74-109">You are not deploying the Web Application Proxy, and therefore the federation metadata is not available in the extranet.</span></span>
* <span data-ttu-id="dda74-110">Você não está usando a configuração padrão do AD FS para certificados de assinatura de token.</span><span class="sxs-lookup"><span data-stu-id="dda74-110">You are not using the default configuration of AD FS for token signing certificates.</span></span>
* <span data-ttu-id="dda74-111">Você está usando um provedor de identidade de terceiros.</span><span class="sxs-lookup"><span data-stu-id="dda74-111">You are using a third-party identity provider.</span></span>

## <a name="default-configuration-of-ad-fs-for-token-signing-certificates"></a><span data-ttu-id="dda74-112">Configuração padrão do AD FS para certificados de assinatura de token</span><span class="sxs-lookup"><span data-stu-id="dda74-112">Default configuration of AD FS for token signing certificates</span></span>
<span data-ttu-id="dda74-113">Os certificados de assinatura de token e de descriptografia de token geralmente são autoassinados e têm validade de um ano.</span><span class="sxs-lookup"><span data-stu-id="dda74-113">The token signing and token decrypting certificates are usually self-signed certificates, and are good for one year.</span></span> <span data-ttu-id="dda74-114">Por padrão, o AD FS inclui um processo de renovação automática chamado **AutoCertificateRollover**.</span><span class="sxs-lookup"><span data-stu-id="dda74-114">By default, AD FS includes an auto-renewal process called **AutoCertificateRollover**.</span></span> <span data-ttu-id="dda74-115">Se você estiver usando o AD FS 2.0 ou posterior, o Office 365 e o Azure AD atualizarão automaticamente o certificado antes que ele expire.</span><span class="sxs-lookup"><span data-stu-id="dda74-115">If you are using AD FS 2.0 or later, Office 365 and Azure AD automatically update your certificate before it expires.</span></span>

### <a name="renewal-notification-from-the-office-365-portal-or-an-email"></a><span data-ttu-id="dda74-116">Notificação de renovação do portal do Office 365 ou um email</span><span class="sxs-lookup"><span data-stu-id="dda74-116">Renewal notification from the Office 365 portal or an email</span></span>
> [!NOTE]
> <span data-ttu-id="dda74-117">Se você recebeu um email ou uma notificação no portal solicitando a renovação do certificado do Office, confira [Gerenciamento de alterações para certificados de assinatura de token](#managecerts) para saber se precisa tomar alguma providência.</span><span class="sxs-lookup"><span data-stu-id="dda74-117">If you received an email or a portal notification asking you to renew your certificate for Office, see [Managing changes to token signing certificates](#managecerts) to check if you need to take any action.</span></span> <span data-ttu-id="dda74-118">A Microsoft está ciente de um possível problema que pode levar ao envio de notificações para renovação de certificados, mesmo quando nenhuma ação é necessária.</span><span class="sxs-lookup"><span data-stu-id="dda74-118">Microsoft is aware of a possible issue that can lead to notifications for certificate renewal being sent, even when no action is required.</span></span>
>
>

<span data-ttu-id="dda74-119">O Azure AD tenta monitorar os metadados de federação e atualizar os certificados de assinatura de token como indicado pelos metadados.</span><span class="sxs-lookup"><span data-stu-id="dda74-119">Azure AD attempts to monitor the federation metadata, and update the token signing certificates as indicated by this metadata.</span></span> <span data-ttu-id="dda74-120">Trinta dias antes da expiração dos certificados de assinatura de token, o Azure AD verifica se há novos certificados disponíveis por meio de sondagem dos metadados de federação.</span><span class="sxs-lookup"><span data-stu-id="dda74-120">30 days before the expiration of the token signing certificates, Azure AD checks if new certificates are available by polling the federation metadata.</span></span>

* <span data-ttu-id="dda74-121">Se ele puder sondar os metadados de federação e recuperar os novos certificados com êxito, nenhuma notificação por email ou aviso no portal do Office 365 será emitido para o usuário.</span><span class="sxs-lookup"><span data-stu-id="dda74-121">If it can successfully poll the federation metadata and retrieve the new certificates, no email notification or warning in the Office 365 portal is issued to the user.</span></span>
* <span data-ttu-id="dda74-122">Se não for possível recuperar os novos certificados de assinatura de token, porque os metadados de Federação não estão acessíveis ou a substituição automática de certificado não está habilitada, o Azure AD enviará uma notificação por email e um aviso no portal do Office 365.</span><span class="sxs-lookup"><span data-stu-id="dda74-122">If it cannot retrieve the new token signing certificates, either because the federation metadata is not reachable or automatic certificate rollover is not enabled, Azure AD issues an email notification and a warning in the Office 365 portal.</span></span>

![Notificação do portal do Office 365](./media/active-directory-aadconnect-o365-certs/notification.png)

> [!IMPORTANT]
> <span data-ttu-id="dda74-124">Se você estiver usando o AD FS para garantir a continuidade de negócios, verifique se seus servidores têm as atualizações a seguir para que não ocorram falhas de autenticação causadas por problemas conhecidos.</span><span class="sxs-lookup"><span data-stu-id="dda74-124">If you are using AD FS, to ensure business continuity, please verify that your servers have the following updates so that authentication failures for known issues do not occur.</span></span> <span data-ttu-id="dda74-125">Isso reduz os problemas conhecidos de servidor de proxy do AD FS para essa renovação e períodos futuros de renovação:</span><span class="sxs-lookup"><span data-stu-id="dda74-125">This mitigates known AD FS proxy server issues for this renewal and future renewal periods:</span></span>
>
> <span data-ttu-id="dda74-126">Server 2012 R2 - [Pacote cumulativo de atualizações do Windows Server de maio de 2014](http://support.microsoft.com/kb/2955164)</span><span class="sxs-lookup"><span data-stu-id="dda74-126">Server 2012 R2 - [Windows Server May 2014 rollup](http://support.microsoft.com/kb/2955164)</span></span>
>
> <span data-ttu-id="dda74-127">Server 2008 R2 e 2012 - [falha de autenticação por meio do proxy no Windows Server 2008 ou no Windows 2012 R2 SP1](http://support.microsoft.com/kb/3094446)</span><span class="sxs-lookup"><span data-stu-id="dda74-127">Server 2008 R2 and 2012 - [Authentication through proxy fails in Windows Server 2012 or Windows 2008 R2 SP1](http://support.microsoft.com/kb/3094446)</span></span>
>
>

## <span data-ttu-id="dda74-128">Verifique se os certificados precisam ser atualizados <a name="managecerts"></a></span><span class="sxs-lookup"><span data-stu-id="dda74-128">Check if the certificates need to be updated <a name="managecerts"></a></span></span>
### <a name="step-1-check-the-autocertificaterollover-state"></a><span data-ttu-id="dda74-129">Etapa 1: verificar o estado de AutoCertificateRollover</span><span class="sxs-lookup"><span data-stu-id="dda74-129">Step 1: Check the AutoCertificateRollover state</span></span>
<span data-ttu-id="dda74-130">No servidor do AD FS, abra o PowerShell.</span><span class="sxs-lookup"><span data-stu-id="dda74-130">On your AD FS server, open PowerShell.</span></span> <span data-ttu-id="dda74-131">Verifique se o valor AutoCertificateRollover está definido como True.</span><span class="sxs-lookup"><span data-stu-id="dda74-131">Check that the AutoCertificateRollover value is set to True.</span></span>

    Get-Adfsproperties

![AutoCertificateRollover](./media/active-directory-aadconnect-o365-certs/autocertrollover.png)

>[!NOTE] 
><span data-ttu-id="dda74-133">Se você estiver usando o AD FS 2.0, primeiro execute Add-Pssnapin Microsoft.Adfs.Powershell.</span><span class="sxs-lookup"><span data-stu-id="dda74-133">If you are using AD FS 2.0, first run Add-Pssnapin Microsoft.Adfs.Powershell.</span></span>

### <a name="step-2-confirm-that-ad-fs-and-azure-ad-are-in-sync"></a><span data-ttu-id="dda74-134">Etapa 2: confirmar se o AD FS e o Azure AD estão em sincronia</span><span class="sxs-lookup"><span data-stu-id="dda74-134">Step 2: Confirm that AD FS and Azure AD are in sync</span></span>
<span data-ttu-id="dda74-135">No servidor do AD FS, abra o prompt do Powershell do Azure AD e conecte-se ao Azure AD.</span><span class="sxs-lookup"><span data-stu-id="dda74-135">On your AD FS server, open the Azure AD PowerShell prompt, and connect to Azure AD.</span></span>

> [!NOTE]
> <span data-ttu-id="dda74-136">Você pode baixar o PowerShell do Azure AD [aqui](https://technet.microsoft.com/library/jj151815.aspx).</span><span class="sxs-lookup"><span data-stu-id="dda74-136">You can download Azure AD PowerShell [here](https://technet.microsoft.com/library/jj151815.aspx).</span></span>
>
>

    Connect-MsolService

<span data-ttu-id="dda74-137">Verifique os certificados configurados no AD FS e as propriedades de confiança do Azure AD para o domínio especificado.</span><span class="sxs-lookup"><span data-stu-id="dda74-137">Check the certificates configured in AD FS and Azure AD trust properties for the specified domain.</span></span>

    Get-MsolFederationProperty -DomainName <domain.name> | FL Source, TokenSigningCertificate

![Get-MsolFederationProperty](./media/active-directory-aadconnect-o365-certs/certsync.png)

<span data-ttu-id="dda74-139">Se as impressões digitais em ambas as saídas forem correspondentes, isso indicará que os certificados estão em sincronia com o Azure AD.</span><span class="sxs-lookup"><span data-stu-id="dda74-139">If the thumbprints in both the outputs match, your certificates are in sync with Azure AD.</span></span>

### <a name="step-3-check-if-your-certificate-is-about-to-expire"></a><span data-ttu-id="dda74-140">Etapa 3: verificar se o certificado está prestes a expirar</span><span class="sxs-lookup"><span data-stu-id="dda74-140">Step 3: Check if your certificate is about to expire</span></span>
<span data-ttu-id="dda74-141">Na saída de Get-MsolFederationProperty ou de Get-AdfsCertificate, verifique a data em "Não Após".</span><span class="sxs-lookup"><span data-stu-id="dda74-141">In the output of either Get-MsolFederationProperty or Get-AdfsCertificate, check for the date under "Not After."</span></span> <span data-ttu-id="dda74-142">Se a data for inferior a daqui a 30 dias, você deverá executar a ação.</span><span class="sxs-lookup"><span data-stu-id="dda74-142">If the date is less than 30 days away, you should take action.</span></span>

| <span data-ttu-id="dda74-143">AutoCertificateRollover</span><span class="sxs-lookup"><span data-stu-id="dda74-143">AutoCertificateRollover</span></span> | <span data-ttu-id="dda74-144">Certificados em sincronia com o Azure AD</span><span class="sxs-lookup"><span data-stu-id="dda74-144">Certificates in sync with Azure AD</span></span> | <span data-ttu-id="dda74-145">Os metadados de federação do AD FS estão acessíveis publicamente</span><span class="sxs-lookup"><span data-stu-id="dda74-145">Federation metadata is publicly accessible</span></span> | <span data-ttu-id="dda74-146">Validade</span><span class="sxs-lookup"><span data-stu-id="dda74-146">Validity</span></span> | <span data-ttu-id="dda74-147">Ação</span><span class="sxs-lookup"><span data-stu-id="dda74-147">Action</span></span> |
|:---:|:---:|:---:|:---:|:---:|
| <span data-ttu-id="dda74-148">Sim</span><span class="sxs-lookup"><span data-stu-id="dda74-148">Yes</span></span> |<span data-ttu-id="dda74-149">Sim</span><span class="sxs-lookup"><span data-stu-id="dda74-149">Yes</span></span> |<span data-ttu-id="dda74-150">Sim</span><span class="sxs-lookup"><span data-stu-id="dda74-150">Yes</span></span> |- |<span data-ttu-id="dda74-151">Nenhuma ação necessária.</span><span class="sxs-lookup"><span data-stu-id="dda74-151">No action needed.</span></span> <span data-ttu-id="dda74-152">Confira [Renovar o certificado de assinatura de token automaticamente](#autorenew).</span><span class="sxs-lookup"><span data-stu-id="dda74-152">See [Renew token signing certificate automatically](#autorenew).</span></span> |
| <span data-ttu-id="dda74-153">Sim</span><span class="sxs-lookup"><span data-stu-id="dda74-153">Yes</span></span> |<span data-ttu-id="dda74-154">Não</span><span class="sxs-lookup"><span data-stu-id="dda74-154">No</span></span> |- |<span data-ttu-id="dda74-155">Menos de 15 dias</span><span class="sxs-lookup"><span data-stu-id="dda74-155">Less than 15 days</span></span> |<span data-ttu-id="dda74-156">Renovar imediatamente.</span><span class="sxs-lookup"><span data-stu-id="dda74-156">Renew immediately.</span></span> <span data-ttu-id="dda74-157">Confira [Renovar manualmente o certificado de assinatura de token ](#manualrenew).</span><span class="sxs-lookup"><span data-stu-id="dda74-157">See [Renew token signing certificate manually](#manualrenew).</span></span> |
| <span data-ttu-id="dda74-158">Não</span><span class="sxs-lookup"><span data-stu-id="dda74-158">No</span></span> |- |- |<span data-ttu-id="dda74-159">Menos de 30 dias</span><span class="sxs-lookup"><span data-stu-id="dda74-159">Less than 30 days</span></span> |<span data-ttu-id="dda74-160">Renovar imediatamente.</span><span class="sxs-lookup"><span data-stu-id="dda74-160">Renew immediately.</span></span> <span data-ttu-id="dda74-161">Confira [Renovar manualmente o certificado de assinatura de token ](#manualrenew).</span><span class="sxs-lookup"><span data-stu-id="dda74-161">See [Renew token signing certificate manually](#manualrenew).</span></span> |

<span data-ttu-id="dda74-162">\[-] Não importa</span><span class="sxs-lookup"><span data-stu-id="dda74-162">\[-]  Does not matter</span></span>

## <span data-ttu-id="dda74-163">Renovar o certificado de assinatura de token automaticamente (recomendado) <a name="autorenew"></a></span><span class="sxs-lookup"><span data-stu-id="dda74-163">Renew the token signing certificate automatically (recommended) <a name="autorenew"></a></span></span>
<span data-ttu-id="dda74-164">Você não precisará executar nenhuma etapa manual se os seguintes itens forem verdadeiros:</span><span class="sxs-lookup"><span data-stu-id="dda74-164">You don't need to perform any manual steps if both of the following are true:</span></span>

* <span data-ttu-id="dda74-165">Você já implantou o Proxy de Aplicativo Web, que pode habilitar o acesso a metadados de federação da extranet.</span><span class="sxs-lookup"><span data-stu-id="dda74-165">You have deployed Web Application Proxy, which can enable access to the federation metadata from the extranet.</span></span>
* <span data-ttu-id="dda74-166">Você está usando a configuração padrão do AD FS (AutoCertificateRollover está habilitado).</span><span class="sxs-lookup"><span data-stu-id="dda74-166">You are using the AD FS default configuration (AutoCertificateRollover is enabled).</span></span>

<span data-ttu-id="dda74-167">Verifique o seguinte para confirmar se o certificado pode ser atualizado automaticamente.</span><span class="sxs-lookup"><span data-stu-id="dda74-167">Check the following to confirm that the certificate can be automatically updated.</span></span>

<span data-ttu-id="dda74-168">**1. A propriedade AutoCertificateRollover do AD FS deve ser definida como True.**</span><span class="sxs-lookup"><span data-stu-id="dda74-168">**1. The AD FS property AutoCertificateRollover must be set to True.**</span></span> <span data-ttu-id="dda74-169">Isso indica que o AD FS gerará automaticamente novos certificados de assinatura de token e de descriptografia de token antes da expiração dos antigos.</span><span class="sxs-lookup"><span data-stu-id="dda74-169">This indicates that AD FS will automatically generate new token signing and token decryption certificates, before the old ones expire.</span></span>

<span data-ttu-id="dda74-170">**2. Os metadados de federação do AD FS estão acessíveis publicamente.**</span><span class="sxs-lookup"><span data-stu-id="dda74-170">**2. The AD FS federation metadata is publicly accessible.**</span></span> <span data-ttu-id="dda74-171">Verifique se os metadados de federação são acessíveis publicamente, navegando até a seguinte URL em um computador na Internet pública (fora da rede corporativa):</span><span class="sxs-lookup"><span data-stu-id="dda74-171">Check that your federation metadata is publicly accessible by navigating to the following URL from a computer on the public internet (off of the corporate network):</span></span>

<span data-ttu-id="dda74-172">https://(your_FS_name)/federationmetadata/2007-06/federationmetadata.xml</span><span class="sxs-lookup"><span data-stu-id="dda74-172">https://(your_FS_name)/federationmetadata/2007-06/federationmetadata.xml</span></span>

<span data-ttu-id="dda74-173">em que `(your_FS_name) `é substituído pelo nome de host de serviço de federação que sua organização usa, por exemplo, fs.contoso.com.</span><span class="sxs-lookup"><span data-stu-id="dda74-173">where `(your_FS_name) `is replaced with the federation service host name your organization uses, such as fs.contoso.com.</span></span>  <span data-ttu-id="dda74-174">Se você puder verificar ambas as configurações com êxito, não terá de fazer mais nada.</span><span class="sxs-lookup"><span data-stu-id="dda74-174">If you are able to verify both of these settings successfully, you do not have to do anything else.</span></span>  

<span data-ttu-id="dda74-175">Exemplo: https://fs.contoso.com/federationmetadata/2007-06/federationmetadata.xml</span><span class="sxs-lookup"><span data-stu-id="dda74-175">Example: https://fs.contoso.com/federationmetadata/2007-06/federationmetadata.xml</span></span>

## <span data-ttu-id="dda74-176">Renovar manualmente o certificado de assinatura de token <a name="manualrenew"></a></span><span class="sxs-lookup"><span data-stu-id="dda74-176">Renew the token signing certificate manually <a name="manualrenew"></a></span></span>
<span data-ttu-id="dda74-177">Você pode optar por renovar os certificados de assinatura de token manualmente.</span><span class="sxs-lookup"><span data-stu-id="dda74-177">You may choose to renew the token signing certificates manually.</span></span> <span data-ttu-id="dda74-178">Por exemplo, os seguintes cenários podem funcionar melhor para a renovação manual:</span><span class="sxs-lookup"><span data-stu-id="dda74-178">For example, the following scenarios might work better for manual renewal:</span></span>

* <span data-ttu-id="dda74-179">Os certificados de assinatura de token não são certificados autoassinados.</span><span class="sxs-lookup"><span data-stu-id="dda74-179">Token signing certificates are not self-signed certificates.</span></span> <span data-ttu-id="dda74-180">O motivo mais comum para isso é que sua organização gerencia certificados do AD FS inscritos de uma autoridade de certificação organizacional.</span><span class="sxs-lookup"><span data-stu-id="dda74-180">The most common reason for this is that your organization manages AD FS certificates enrolled from an organizational certificate authority.</span></span>
* <span data-ttu-id="dda74-181">A segurança de rede não permite que os metadados de federação fiquem publicamente disponíveis.</span><span class="sxs-lookup"><span data-stu-id="dda74-181">Network security does not allow the federation metadata to be publicly available.</span></span>

<span data-ttu-id="dda74-182">Nesses cenários, sempre que atualizar os certificados de assinatura de token, você também deverá atualizar seu domínio do Office 365 usando o comando Update-MsolFederatedDomain do PowerShell.</span><span class="sxs-lookup"><span data-stu-id="dda74-182">In these scenarios, every time you update the token signing certificates, you must also update your Office 365 domain by using the PowerShell command, Update-MsolFederatedDomain.</span></span>

### <a name="step-1-ensure-that-ad-fs-has-new-token-signing-certificates"></a><span data-ttu-id="dda74-183">Etapa 1: verifique se o AD FS tem novos certificados de assinatura de token</span><span class="sxs-lookup"><span data-stu-id="dda74-183">Step 1: Ensure that AD FS has new token signing certificates</span></span>
<span data-ttu-id="dda74-184">**Configuração não padrão**</span><span class="sxs-lookup"><span data-stu-id="dda74-184">**Non-default configuration**</span></span>

<span data-ttu-id="dda74-185">Se estiver usando uma configuração não padrão do AD FS (em que **AutoCertificateRollover** está definido como **False**), você provavelmente está usando certificados personalizados (não autoassinados).</span><span class="sxs-lookup"><span data-stu-id="dda74-185">If you are using a non-default configuration of AD FS (where **AutoCertificateRollover** is set to **False**), you are probably using custom certificates (not self-signed).</span></span> <span data-ttu-id="dda74-186">Para obter mais informações sobre como renovar os certificados de assinatura de token do AD FS, confira [Orientação para os clientes que não usam certificados autoassinados do AD FS](https://msdn.microsoft.com/library/azure/JJ933264.aspx#BKMK_NotADFSCert).</span><span class="sxs-lookup"><span data-stu-id="dda74-186">For more information about how to renew the AD FS token signing certificates, see [Guidance for customers not using AD FS self-signed certificates](https://msdn.microsoft.com/library/azure/JJ933264.aspx#BKMK_NotADFSCert).</span></span>

<span data-ttu-id="dda74-187">**Os metadados de federação não estão disponíveis publicamente**</span><span class="sxs-lookup"><span data-stu-id="dda74-187">**Federation metadata is not publicly available**</span></span>

<span data-ttu-id="dda74-188">Por outro lado, se **AutoCertificateRollover** estiver definido como **True**, mas se os metadados de federação não estiverem acessíveis publicamente, primeiro verifique se novos certificados de assinatura de token foram gerados pelo AD FS.</span><span class="sxs-lookup"><span data-stu-id="dda74-188">On the other hand, if **AutoCertificateRollover** is set to **True**, but your federation metadata is not publicly accessible, first make sure that new token signing certificates have been generated by AD FS.</span></span> <span data-ttu-id="dda74-189">Confirme se você tem os novos certificados de assinatura de token por meio das seguintes etapas:</span><span class="sxs-lookup"><span data-stu-id="dda74-189">Confirm you have new token signing certificates by taking the following steps:</span></span>

1. <span data-ttu-id="dda74-190">Verifique se você fez logon no servidor do AD FS primário.</span><span class="sxs-lookup"><span data-stu-id="dda74-190">Verify that you are logged on to the primary AD FS server.</span></span>
2. <span data-ttu-id="dda74-191">Verifique os certificados de autenticação atuais no AD FS abrindo uma janela Comando do PowerShell e executando o seguinte comando:</span><span class="sxs-lookup"><span data-stu-id="dda74-191">Check the current signing certificates in AD FS by opening a PowerShell command window, and running the following command:</span></span>

    <span data-ttu-id="dda74-192">PS C:\>Get-ADFSCertificate –CertificateType token-signing</span><span class="sxs-lookup"><span data-stu-id="dda74-192">PS C:\>Get-ADFSCertificate –CertificateType token-signing</span></span>

   > [!NOTE]
   > <span data-ttu-id="dda74-193">Se estiver usando o AD FS 2.0, você deverá executar Add-Pssnapin Microsoft.Adfs.Powershell primeiro.</span><span class="sxs-lookup"><span data-stu-id="dda74-193">If you are using AD FS 2.0, you should run Add-Pssnapin Microsoft.Adfs.Powershell first.</span></span>
   >
   >
3. <span data-ttu-id="dda74-194">Examine a saída do comando em todos os certificados listados.</span><span class="sxs-lookup"><span data-stu-id="dda74-194">Look at the command output at any certificates listed.</span></span> <span data-ttu-id="dda74-195">Se o AD FS tiver gerado um novo certificado, você verá dois certificados na saída: um para o qual o valor **IsPrimary** é **True** e a data **NotAfter** está dentro de cinco dias e um para o qual **IsPrimary** é **False** e **NotAfter** está cerca de um ano no futuro.</span><span class="sxs-lookup"><span data-stu-id="dda74-195">If AD FS has generated a new certificate, you should see two certificates in the output: one for which the **IsPrimary** value is **True** and the **NotAfter** date is within 5 days, and one for which **IsPrimary** is **False** and **NotAfter** is about a year in the future.</span></span>
4. <span data-ttu-id="dda74-196">Se você vir apenas um certificado e a data **NotAfter** for dentro de cinco dias, precisará gerar um novo certificado.</span><span class="sxs-lookup"><span data-stu-id="dda74-196">If you only see one certificate, and the **NotAfter** date is within 5 days, you need to generate a new certificate.</span></span>
5. <span data-ttu-id="dda74-197">Para gerar um novo certificado, execute o seguinte comando em um prompt de comando do PowerShell: `PS C:\>Update-ADFSCertificate –CertificateType token-signing`.</span><span class="sxs-lookup"><span data-stu-id="dda74-197">To generate a new certificate, execute the following command at a PowerShell command prompt: `PS C:\>Update-ADFSCertificate –CertificateType token-signing`.</span></span>
6. <span data-ttu-id="dda74-198">Verifique a atualização executando o seguinte comando novamente: PS C:\>Get-ADFSCertificate –CertificateType token-signing</span><span class="sxs-lookup"><span data-stu-id="dda74-198">Verify the update by running the following command again: PS C:\>Get-ADFSCertificate –CertificateType token-signing</span></span>

<span data-ttu-id="dda74-199">Dois certificados deverão ser listados agora, um dos quais tem uma data **NotAfter** de aproximadamente um ano no futuro e para o qual o valor **IsPrimary** é **False**.</span><span class="sxs-lookup"><span data-stu-id="dda74-199">Two certificates should be listed now, one of which has a **NotAfter** date of approximately one year in the future, and for which the **IsPrimary** value is **False**.</span></span>

### <a name="step-2-update-the-new-token-signing-certificates-for-the-office-365-trust"></a><span data-ttu-id="dda74-200">Etapa 2: atualizar os novos certificados de assinatura de token para a relação de confiança do Office 365</span><span class="sxs-lookup"><span data-stu-id="dda74-200">Step 2: Update the new token signing certificates for the Office 365 trust</span></span>
<span data-ttu-id="dda74-201">Atualize o Office 365 com os novos certificados de assinatura de token a serem usados para a relação de confiança, da maneira a seguir.</span><span class="sxs-lookup"><span data-stu-id="dda74-201">Update Office 365 with the new token signing certificates to be used for the trust, as follows.</span></span>

1. <span data-ttu-id="dda74-202">Abra o Módulo Microsoft Azure Active Directory para Windows PowerShell.</span><span class="sxs-lookup"><span data-stu-id="dda74-202">Open the Microsoft Azure Active Directory Module for Windows PowerShell.</span></span>
2. <span data-ttu-id="dda74-203">Execute $cred = Get-Credential.</span><span class="sxs-lookup"><span data-stu-id="dda74-203">Run $cred=Get-Credential.</span></span> <span data-ttu-id="dda74-204">Quando este cmdlet solicitar credenciais, digite as credenciais da conta de administrador de serviços de nuvem.</span><span class="sxs-lookup"><span data-stu-id="dda74-204">When this cmdlet prompts you for credentials, type your cloud service administrator account credentials.</span></span>
3. <span data-ttu-id="dda74-205">Execute Connect-MsolService –Credential $cred.</span><span class="sxs-lookup"><span data-stu-id="dda74-205">Run Connect-MsolService –Credential $cred.</span></span> <span data-ttu-id="dda74-206">Esse cmdlet conecta você ao serviço de nuvem.</span><span class="sxs-lookup"><span data-stu-id="dda74-206">This cmdlet connects you to the cloud service.</span></span> <span data-ttu-id="dda74-207">A criação de um contexto que conecta você ao serviço de nuvem é necessária antes de executar qualquer um dos cmdlets adicionais instalados pela ferramenta.</span><span class="sxs-lookup"><span data-stu-id="dda74-207">Creating a context that connects you to the cloud service is required before running any of the additional cmdlets installed by the tool.</span></span>
4. <span data-ttu-id="dda74-208">Se você estiver executando esses comandos em um computador que não seja o servidor de federação primário do AD FS, execute Set-MSOLAdfscontext -Computer <AD FS primary server>, em que <AD FS primary server> é o nome FQDN interno do servidor primário do AD FS.</span><span class="sxs-lookup"><span data-stu-id="dda74-208">If you are running these commands on a computer that is not the AD FS primary federation server, run Set-MSOLAdfscontext -Computer <AD FS primary server>, where <AD FS primary server> is the internal FQDN name of the primary AD FS server.</span></span> <span data-ttu-id="dda74-209">Esse cmdlet cria um contexto que conecta você ao AD FS.</span><span class="sxs-lookup"><span data-stu-id="dda74-209">This cmdlet creates a context that connects you to AD FS.</span></span>
5. <span data-ttu-id="dda74-210">Execute Update-MSOLFederatedDomain –DomainName <domain>.</span><span class="sxs-lookup"><span data-stu-id="dda74-210">Run Update-MSOLFederatedDomain –DomainName <domain>.</span></span> <span data-ttu-id="dda74-211">Esse cmdlet atualiza as configurações do AD FS no serviço de nuvem e configura a relação de confiança entre os dois.</span><span class="sxs-lookup"><span data-stu-id="dda74-211">This cmdlet updates the settings from AD FS into the cloud service, and configures the trust relationship between the two.</span></span>

> [!NOTE]
> <span data-ttu-id="dda74-212">Se você precisar oferecer suporte a vários domínios de nível superior, como contoso.com e fabrikam.com, deve usar a opção **SupportMultipleDomain** com todos os cmdlets.</span><span class="sxs-lookup"><span data-stu-id="dda74-212">If you need to support multiple top-level domains, such as contoso.com and fabrikam.com, you must use the **SupportMultipleDomain** switch with any cmdlets.</span></span> <span data-ttu-id="dda74-213">Para obter mais informações, veja [Suporte para vários domínios de nível superior](active-directory-aadconnect-multiple-domains.md).</span><span class="sxs-lookup"><span data-stu-id="dda74-213">For more information, see [Support for Multiple Top Level Domains](active-directory-aadconnect-multiple-domains.md).</span></span>
>
>

## <span data-ttu-id="dda74-214">Reparar a relação de confiança do Azure AD usando o Azure AD Connect <a name="connectrenew"></a></span><span class="sxs-lookup"><span data-stu-id="dda74-214">Repair Azure AD trust by using Azure AD Connect <a name="connectrenew"></a></span></span>
<span data-ttu-id="dda74-215">Se tiver configurado o farm do AD FS e a relação de confiança do Azure AD usando o Azure AD Connect, você poderá usar o Azure AD Connect para detectar se precisa realizar alguma ação para seus certificados de assinatura de token.</span><span class="sxs-lookup"><span data-stu-id="dda74-215">If you configured your AD FS farm and Azure AD trust by using Azure AD Connect, you can use Azure AD Connect to detect if you need to take any action for your token signing certificates.</span></span> <span data-ttu-id="dda74-216">Se precisar renovar os certificados, você poderá usar o Azure AD Connect para fazê-lo.</span><span class="sxs-lookup"><span data-stu-id="dda74-216">If you need to renew the certificates, you can use Azure AD Connect to do so.</span></span>

<span data-ttu-id="dda74-217">Para obter mais informações, confira [Reparar a relação de confiança](active-directory-aadconnect-federation-management.md).</span><span class="sxs-lookup"><span data-stu-id="dda74-217">For more information, see [Repairing the trust](active-directory-aadconnect-federation-management.md).</span></span>
