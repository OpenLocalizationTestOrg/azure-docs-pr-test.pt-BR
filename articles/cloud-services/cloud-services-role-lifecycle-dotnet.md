---
title: "Tratar eventos de ciclo de vida do Serviço de Nuvem | Microsoft Docs"
description: "Saiba como os métodos de ciclo de vida de uma função de Serviço de Nuvem podem ser usados no .NET"
services: cloud-services
documentationcenter: .net
author: Thraka
manager: timlt
editor: 
ms.assetid: 39b30acd-57b9-48b7-a7c4-40ea3430e451
ms.service: cloud-services
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/18/2017
ms.author: adegeo
ms.openlocfilehash: eb78c05df3b3cdf3887334c11bdabd5cebb74747
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/03/2017
---
# <a name="customize-the-lifecycle-of-a-web-or-worker-role-in-net"></a><span data-ttu-id="08abb-103">Personalizar o ciclo de vida de uma função Web ou de trabalho no .NET</span><span class="sxs-lookup"><span data-stu-id="08abb-103">Customize the Lifecycle of a Web or Worker role in .NET</span></span>
<span data-ttu-id="08abb-104">Quando você cria uma função de trabalho, estende a classe [RoleEntryPoint](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.aspx) que oferece métodos a serem substituídos, permitindo que você responda a eventos de ciclo de vida.</span><span class="sxs-lookup"><span data-stu-id="08abb-104">When you create a worker role, you extend the [RoleEntryPoint](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.aspx) class which provides methods for you to override that let you respond to lifecycle events.</span></span> <span data-ttu-id="08abb-105">Para funções Web, essa classe é opcional e, portanto, deve ser usada para responder a eventos de ciclo de vida.</span><span class="sxs-lookup"><span data-stu-id="08abb-105">For web roles this class is optional, so you must use it to respond to lifecycle events.</span></span>

## <a name="extend-the-roleentrypoint-class"></a><span data-ttu-id="08abb-106">Estender a classe RoleEntryPoint</span><span class="sxs-lookup"><span data-stu-id="08abb-106">Extend the RoleEntryPoint class</span></span>
<span data-ttu-id="08abb-107">A classe [RoleEntryPoint](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.aspx) inclui métodos chamados pelo Azure quando ele **inicia**, **executa** ou **para** uma função Web ou de trabalho.</span><span class="sxs-lookup"><span data-stu-id="08abb-107">The [RoleEntryPoint](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.aspx) class includes methods that are called by Azure when it **starts**, **runs**, or **stops** a web or worker role.</span></span> <span data-ttu-id="08abb-108">Opcionalmente, você pode substituir esses métodos para gerenciar a inicialização de função, as sequências de desligamento de função ou o thread de execução da função.</span><span class="sxs-lookup"><span data-stu-id="08abb-108">You can optionally override these methods to manage role initialization, role shutdown sequences, or the execution thread of the role.</span></span> 

<span data-ttu-id="08abb-109">Ao estender **RoleEntryPoint**, você deverá estar ciente dos seguintes comportamentos dos métodos:</span><span class="sxs-lookup"><span data-stu-id="08abb-109">When extending **RoleEntryPoint**, you should be aware of the following behaviors of the methods:</span></span>

* <span data-ttu-id="08abb-110">Os métodos [OnStart](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstart.aspx) e [OnStop](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx) retornam um valor booliano e, portanto, é possível retornar **false** desses métodos.</span><span class="sxs-lookup"><span data-stu-id="08abb-110">The [OnStart](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstart.aspx) and [OnStop](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx) methods return a boolean value, so it is possible to return **false** from these methods.</span></span>
  
   <span data-ttu-id="08abb-111">Se seu código retornar **false**, o processo da função será encerrado abruptamente, sem executar nenhuma sequência de desligamento que possa existir.</span><span class="sxs-lookup"><span data-stu-id="08abb-111">If your code returns **false**, the role process is abruptly terminated, without running any shutdown sequence you may have in place.</span></span> <span data-ttu-id="08abb-112">Em geral, você deve evitar o retorno de **false** do método **OnStart**.</span><span class="sxs-lookup"><span data-stu-id="08abb-112">In general, you should avoid returning **false** from the **OnStart** method.</span></span>
* <span data-ttu-id="08abb-113">Qualquer exceção não capturada em uma sobrecarga de um método **RoleEntryPoint** será tratada como uma exceção sem tratamento.</span><span class="sxs-lookup"><span data-stu-id="08abb-113">Any uncaught exception within an overload of a **RoleEntryPoint** method is treated as an unhandled exception.</span></span>
  
   <span data-ttu-id="08abb-114">Se ocorrer uma exceção em um dos métodos do ciclo de vida, o Azure acionará o evento [UnhandledException](https://msdn.microsoft.com/library/system.appdomain.unhandledexception.aspx) e o processo será encerrado.</span><span class="sxs-lookup"><span data-stu-id="08abb-114">If an exception occurs within one of the lifecycle methods, Azure will raise the [UnhandledException](https://msdn.microsoft.com/library/system.appdomain.unhandledexception.aspx) event, and then the process is terminated.</span></span> <span data-ttu-id="08abb-115">Depois que sua função ficar offline, ela será reiniciada pelo Azure.</span><span class="sxs-lookup"><span data-stu-id="08abb-115">After your role has been taken offline, it will be restarted by Azure.</span></span> <span data-ttu-id="08abb-116">Quando ocorre uma exceção não tratada, o evento [Stopping](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx) não é acionado e o método **OnStop** não é chamado.</span><span class="sxs-lookup"><span data-stu-id="08abb-116">When an unhandled exception occurs, the [Stopping](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx) event is not raised, and the **OnStop** method is not called.</span></span>

<span data-ttu-id="08abb-117">Se a sua função não for iniciada, ou se estiver reciclando os estados de inicialização, ocupado e de parada, seu código pode estar lançando uma exceção sem tratamento em um dos eventos do ciclo de vida sempre que a função é reiniciada.</span><span class="sxs-lookup"><span data-stu-id="08abb-117">If your role does not start, or is recycling between the initializing, busy, and stopping states, your code may be throwing an unhandled exception within one of the lifecycle events each time the role restarts.</span></span> <span data-ttu-id="08abb-118">Nesse caso, use o evento [UnhandledException](https://msdn.microsoft.com/library/system.appdomain.unhandledexception.aspx) para determinar a causa da exceção e tratá-la adequadamente.</span><span class="sxs-lookup"><span data-stu-id="08abb-118">In this case, use the [UnhandledException](https://msdn.microsoft.com/library/system.appdomain.unhandledexception.aspx) event to determine the cause of the exception and handle it appropriately.</span></span> <span data-ttu-id="08abb-119">Sua função também pode estar retornando do método [Run](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.run.aspx) , que faz com que a função reinicie.</span><span class="sxs-lookup"><span data-stu-id="08abb-119">Your role may also be returning from the [Run](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.run.aspx) method, which causes the role to restart.</span></span> <span data-ttu-id="08abb-120">Para obter mais informações sobre os estados de implantação, confira [Problemas comuns que causam a reciclagem de funções](cloud-services-troubleshoot-common-issues-which-cause-roles-recycle.md).</span><span class="sxs-lookup"><span data-stu-id="08abb-120">For more information about deployment states, see [Common Issues Which Cause Roles to Recycle](cloud-services-troubleshoot-common-issues-which-cause-roles-recycle.md).</span></span>

> [!NOTE]
> <span data-ttu-id="08abb-121">Se você estiver usando as **Ferramentas do Azure para o Microsoft Visual Studio** para desenvolver seu aplicativo, os modelos de projeto de função estenderão automaticamente a classe **RoleEntryPoint** para você nos arquivos *WebRole.cs* e *WorkerRole.cs*.</span><span class="sxs-lookup"><span data-stu-id="08abb-121">If you are using the **Azure Tools for Microsoft Visual Studio** to develop your application, the role project templates automatically extend the **RoleEntryPoint** class for you, in the *WebRole.cs* and *WorkerRole.cs* files.</span></span>
> 
> 

## <a name="onstart-method"></a><span data-ttu-id="08abb-122">Método OnStart</span><span class="sxs-lookup"><span data-stu-id="08abb-122">OnStart method</span></span>
<span data-ttu-id="08abb-123">O método **OnStart** é chamado quando sua instância de função é colocada online pelo Azure.</span><span class="sxs-lookup"><span data-stu-id="08abb-123">The **OnStart** method is called when your role instance is brought online by Azure.</span></span> <span data-ttu-id="08abb-124">Durante a execução do código OnStart, a instância de função é marcada como **Ocupada** e o balanceador de carga não direcionará nenhum tráfego externo para ela.</span><span class="sxs-lookup"><span data-stu-id="08abb-124">While the OnStart code is executing, the role instance is marked as **Busy** and no external traffic will be directed to it by the load balancer.</span></span> <span data-ttu-id="08abb-125">Você pode substituir esse método para executar um trabalho de inicialização, como a implementação de manipuladores de eventos e a inicialização do [Diagnóstico do Azure](cloud-services-how-to-monitor.md).</span><span class="sxs-lookup"><span data-stu-id="08abb-125">You can override this method to perform initialization work, such as implementing event handlers and starting [Azure Diagnostics](cloud-services-how-to-monitor.md).</span></span>

<span data-ttu-id="08abb-126">Se **OnStart** retornar **true**, a instância será inicializada com êxito e o Azure chamará o método **RoleEntryPoint.Run**.</span><span class="sxs-lookup"><span data-stu-id="08abb-126">If **OnStart** returns **true**, the instance is successfully initialized and Azure calls the **RoleEntryPoint.Run** method.</span></span> <span data-ttu-id="08abb-127">Se **OnStart** retornar **false**, a função será imediatamente encerrada sem executar nenhuma sequência de desligamento planejada.</span><span class="sxs-lookup"><span data-stu-id="08abb-127">If **OnStart** returns **false**, the role terminates immediately, without executing any planned shutdown sequences.</span></span>

<span data-ttu-id="08abb-128">O exemplo de código a seguir mostra como substituir o método **OnStart** .</span><span class="sxs-lookup"><span data-stu-id="08abb-128">The following code example shows how to override the **OnStart** method.</span></span> <span data-ttu-id="08abb-129">Esse método configura e inicia um monitor de diagnóstico quando a instância de função é iniciada e configura uma transferência de dados de log para uma conta de armazenamento:</span><span class="sxs-lookup"><span data-stu-id="08abb-129">This method configures and starts a diagnostic monitor when the role instance starts and sets up a transfer of logging data to a storage account:</span></span>

```csharp
public override bool OnStart()
{
    var config = DiagnosticMonitor.GetDefaultInitialConfiguration();

    config.DiagnosticInfrastructureLogs.ScheduledTransferLogLevelFilter = LogLevel.Error;
    config.DiagnosticInfrastructureLogs.ScheduledTransferPeriod = TimeSpan.FromMinutes(5);

    DiagnosticMonitor.Start("DiagnosticsConnectionString", config);

    return true;
}
```

## <a name="onstop-method"></a><span data-ttu-id="08abb-130">Método OnStop</span><span class="sxs-lookup"><span data-stu-id="08abb-130">OnStop method</span></span>
<span data-ttu-id="08abb-131">O método **OnStop** será chamado depois que uma instância de função tiver sido colocada offline pelo Azure e antes que o processo tenha sido encerrado.</span><span class="sxs-lookup"><span data-stu-id="08abb-131">The **OnStop** method is called after a role instance has been taken offline by Azure and before the process exits.</span></span> <span data-ttu-id="08abb-132">Você pode substituir esse método para chamar o código necessário para que a instância de função seja desligada corretamente.</span><span class="sxs-lookup"><span data-stu-id="08abb-132">You can override this method to call code required for your role instance to cleanly shut down.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="08abb-133">A execução do código no método **OnStop** tem um tempo limitado para ser encerrado quando chamado por motivos diferentes de um desligamento iniciado pelo usuário.</span><span class="sxs-lookup"><span data-stu-id="08abb-133">Code running in the **OnStop** method has a limited time to finish when it is called for reasons other than a user-initiated shutdown.</span></span> <span data-ttu-id="08abb-134">Depois de decorrido esse tempo, o processo é encerrado e você deve garantir que o código do método **OnStop** possa ser executado rapidamente ou tolere não ser executado para ser concluído.</span><span class="sxs-lookup"><span data-stu-id="08abb-134">After this time elapses, the process is terminated, so you must make sure that code in the **OnStop** method can run quickly or tolerates not running to completion.</span></span> <span data-ttu-id="08abb-135">O método **OnStop** é chamado depois que o evento **Stopping** é acionado.</span><span class="sxs-lookup"><span data-stu-id="08abb-135">The **OnStop** method is called after the **Stopping** event is raised.</span></span>
> 
> 

## <a name="run-method"></a><span data-ttu-id="08abb-136">Método Run</span><span class="sxs-lookup"><span data-stu-id="08abb-136">Run method</span></span>
<span data-ttu-id="08abb-137">Você pode substituir o método **Run** para implementar um thread de execução longa para sua instância de função.</span><span class="sxs-lookup"><span data-stu-id="08abb-137">You can override the **Run** method to implement a long-running thread for your role instance.</span></span>

<span data-ttu-id="08abb-138">A substituição do método **Run** não é necessária; a implementação padrão inicia um thread em suspensão permanente.</span><span class="sxs-lookup"><span data-stu-id="08abb-138">Overriding the **Run** method is not required; the default implementation starts a thread that sleeps forever.</span></span> <span data-ttu-id="08abb-139">Se você substituir o método **Run** , seu código deverá ser bloqueado indefinidamente.</span><span class="sxs-lookup"><span data-stu-id="08abb-139">If you do override the **Run** method, your code should block indefinitely.</span></span> <span data-ttu-id="08abb-140">Se o método **Run** retornar, a função será reciclada normalmente de forma automática; em outras palavras, o Azure aciona o evento **Stopping** e chama o método **OnStop** para que as sequências de desligamento possam ser executadas antes que a função fique offline.</span><span class="sxs-lookup"><span data-stu-id="08abb-140">If the **Run** method returns, the role is automatically gracefully recycled; in other words, Azure raises the **Stopping** event and calls the **OnStop** method so that your shutdown sequences may be executed before the role is taken offline.</span></span>

### <a name="implementing-the-aspnet-lifecycle-methods-for-a-web-role"></a><span data-ttu-id="08abb-141">Implementando os métodos de ciclo de vida do ASP.NET para uma função Web</span><span class="sxs-lookup"><span data-stu-id="08abb-141">Implementing the ASP.NET lifecycle methods for a web role</span></span>
<span data-ttu-id="08abb-142">Você pode usar os métodos de ciclo de vida do ASP.NET além daqueles fornecidos pela classe **RoleEntryPoint** para gerenciar sequências de inicialização e de desligamento para uma função Web.</span><span class="sxs-lookup"><span data-stu-id="08abb-142">You can use the ASP.NET lifecycle methods, in addition to those provided by the **RoleEntryPoint** class, to manage initialization and shutdown sequences for a web role.</span></span> <span data-ttu-id="08abb-143">Isso poderá ser útil para fins de compatibilidade se você estiver portando um aplicativo ASP.NET existente para o Azure.</span><span class="sxs-lookup"><span data-stu-id="08abb-143">This may be useful for compatibility purposes if you are porting an existing ASP.NET application to Azure.</span></span> <span data-ttu-id="08abb-144">Os métodos de ciclo de vida do ASP.NET são chamados de dentro dos métodos **RoleEntryPoint** .</span><span class="sxs-lookup"><span data-stu-id="08abb-144">The ASP.NET lifecycle methods are called from within the **RoleEntryPoint** methods.</span></span> <span data-ttu-id="08abb-145">O método **Application\_Start** é chamado após o término do método **RoleEntryPoint.OnStart**.</span><span class="sxs-lookup"><span data-stu-id="08abb-145">The **Application\_Start** method is called after the **RoleEntryPoint.OnStart** method finishes.</span></span> <span data-ttu-id="08abb-146">O método **Application\_End** é chamado antes da chamada ao método **RoleEntryPoint.OnStop**.</span><span class="sxs-lookup"><span data-stu-id="08abb-146">The **Application\_End** method is called before the **RoleEntryPoint.OnStop** method is called.</span></span>

## <a name="next-steps"></a><span data-ttu-id="08abb-147">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="08abb-147">Next steps</span></span>
<span data-ttu-id="08abb-148">Saiba como [criar um pacote de serviços de nuvem](cloud-services-model-and-package.md).</span><span class="sxs-lookup"><span data-stu-id="08abb-148">Learn how to [create a cloud service package](cloud-services-model-and-package.md).</span></span>

