---
title: "Preparando seu ambiente para fazer backup de máquinas virtuais do Azure | Microsoft Docs"
description: "Verificar se o ambiente está preparado para fazer backup de máquinas virtuais no Azure"
services: backup
documentationcenter: 
author: markgalioto
manager: carmonn
editor: 
keywords: backups; fazendo backup;
ms.assetid: 238ab93b-8acc-4262-81b7-ce930f76a662
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 4/25/2017
ms.author: markgal;trinadhk;
ms.openlocfilehash: 072efdccaa8df5d430314d753a437b524986b53c
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="prepare-your-environment-to-back-up-azure-virtual-machines"></a><span data-ttu-id="5e7c8-104">Preparar o seu ambiente para o backup das máquinas virtuais do Azure</span><span class="sxs-lookup"><span data-stu-id="5e7c8-104">Prepare your environment to back up Azure virtual machines</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="5e7c8-105">Modelo do Gerenciador de Recursos</span><span class="sxs-lookup"><span data-stu-id="5e7c8-105">Resource Manager model</span></span>](backup-azure-arm-vms-prepare.md)
> * [<span data-ttu-id="5e7c8-106">Modelo clássico</span><span class="sxs-lookup"><span data-stu-id="5e7c8-106">Classic model</span></span>](backup-azure-vms-prepare.md)
>
>

<span data-ttu-id="5e7c8-107">Antes de poder fazer backup de uma máquina virtual (VM) do Azure, há três condições que devem existir.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-107">Before you can back up an Azure virtual machine (VM), there are three conditions that must exist.</span></span>

* <span data-ttu-id="5e7c8-108">Você precisa criar um cofre de backup ou identificar um cofre de backup existente *na mesma região da VM*.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-108">You need to create a backup vault or identify an existing backup vault *in the same region as your VM*.</span></span>
* <span data-ttu-id="5e7c8-109">Estabeleça a conectividade de rede entre os endereços de Internet públicos do Azure e os pontos de extremidade do armazenamento do Azure.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-109">Establish network connectivity between the Azure public Internet addresses and the Azure storage endpoints.</span></span>
* <span data-ttu-id="5e7c8-110">Instale o agente de VM na VM.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-110">Install the VM agent on the VM.</span></span>

<span data-ttu-id="5e7c8-111">Se você souber que essas condições já existem em seu ambiente, prossiga para o [artigo Fazer backup das suas VMs](backup-azure-vms.md).</span><span class="sxs-lookup"><span data-stu-id="5e7c8-111">If you know these conditions already exist in your environment then proceed to the [Back up your VMs article](backup-azure-vms.md).</span></span> <span data-ttu-id="5e7c8-112">Caso contrário, continue a ler este artigo. Ele guiará você pelas etapas da preparação do seu ambiente para o backup de uma VM do Azure.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-112">Otherwise, read on, this article will lead you through the steps to prepare your environment to back up an Azure VM.</span></span>

##<a name="supported-operating-system-for-backup"></a><span data-ttu-id="5e7c8-113">Versões de sistema operacional com suporte para backup</span><span class="sxs-lookup"><span data-stu-id="5e7c8-113">Supported operating system for backup</span></span>
 * <span data-ttu-id="5e7c8-114">**Linux**: o Backup do Azure dá suporte a [uma lista de distribuições endossadas pelo Azure](../virtual-machines/linux/endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) exceto o principal sistema operacional Linux.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-114">**Linux**: Azure Backup supports [a list of distributions that are endorsed by Azure](../virtual-machines/linux/endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) except Core OS Linux.</span></span> <span data-ttu-id="5e7c8-115">_Outras distribuições personalizadas do Linux também devem funcionar, contanto que o agente de VM esteja disponível na máquina virtual e exista suporte para Python. No entanto, não endossamos essas distribuições para backup._</span><span class="sxs-lookup"><span data-stu-id="5e7c8-115">_Other Bring-Your-Own-Linux distributions also might work as long as the VM agent is available on the virtual machine and support for Python exists. However, we do not endorse those distributions for backup._</span></span>
 * <span data-ttu-id="5e7c8-116">**Windows Server**: não há suporte para versões anteriores ao Windows Server 2008 R2.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-116">**Windows Server**:  Versions older than Windows Server 2008 R2 are not supported.</span></span>


## <a name="limitations-when-backing-up-and-restoring-a-vm"></a><span data-ttu-id="5e7c8-117">Limitações durante o backup e a restauração de uma VM</span><span class="sxs-lookup"><span data-stu-id="5e7c8-117">Limitations when backing up and restoring a VM</span></span>
> [!NOTE]
> <span data-ttu-id="5e7c8-118">O Azure tem dois modelos de implantação para criar e trabalhar com recursos: [Gerenciador de Recursos e Clássico](../azure-resource-manager/resource-manager-deployment-model.md).</span><span class="sxs-lookup"><span data-stu-id="5e7c8-118">Azure has two deployment models for creating and working with resources: [Resource Manager and classic](../azure-resource-manager/resource-manager-deployment-model.md).</span></span> <span data-ttu-id="5e7c8-119">A lista a seguir fornece as limitações durante a implantação no modelo clássico.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-119">The following list provides the limitations when deploying in the classic model.</span></span>
>
>

* <span data-ttu-id="5e7c8-120">Não há suporte para o backup de máquinas virtuais com mais de 16 discos de dados.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-120">Backing up virtual machines with more than 16 data disks is not supported.</span></span>
* <span data-ttu-id="5e7c8-121">Não há suporte para o backup de máquinas virtuais com um endereço IP reservado e nenhum ponto de extremidade definido.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-121">Backing up virtual machines with a reserved IP address and no defined endpoint is not supported.</span></span>
* <span data-ttu-id="5e7c8-122">Os dados de backup não incluem unidades de rede montadas anexadas à VM.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-122">Backup data doesn't include network mounted drives attached to VM.</span></span>
* <span data-ttu-id="5e7c8-123">Não há suporte para a substituição de uma máquina virtual existente durante a restauração.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-123">Replacing an existing virtual machine during restore is not supported.</span></span> <span data-ttu-id="5e7c8-124">Primeiro, exclua a máquina virtual existente e todos os discos associados e, em seguida, restaure os dados do backup.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-124">First delete the existing virtual machine and any associated disks, and then restore the data from backup.</span></span>
* <span data-ttu-id="5e7c8-125">Não há suporte para backup e restauração entre regiões.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-125">Cross-region backup and restore is not supported.</span></span>
* <span data-ttu-id="5e7c8-126">O backup de máquinas virtuais usando o serviço Backup do Azure tem suporte em todas as regiões públicas do Azure (confira a [lista de verificação](https://azure.microsoft.com/regions/#services) de regiões com suporte).</span><span class="sxs-lookup"><span data-stu-id="5e7c8-126">Backing up virtual machines by using the Azure Backup service is supported in all public regions of Azure (see the [checklist](https://azure.microsoft.com/regions/#services) of supported regions).</span></span> <span data-ttu-id="5e7c8-127">Se a região que você procura ainda não tem suporte, ela não aparecerá na lista suspensa durante a criação de cofre.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-127">If the region that you are looking for is unsupported today, it will not appear in the dropdown list during vault creation.</span></span>
* <span data-ttu-id="5e7c8-128">O backup de máquinas virtuais usando o serviço Backup do Azure tem suporte somente para determinadas versões de sistema operacional:</span><span class="sxs-lookup"><span data-stu-id="5e7c8-128">Backing up virtual machines by using the Azure Backup service is supported only for select operating system versions:</span></span>
* <span data-ttu-id="5e7c8-129">A restauração de uma VM DC (controladora de domínio) que é parte de uma configuração multi-DC tem suporte somente usando o PowerShell.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-129">Restoring a domain controller (DC) VM that is part of a multi-DC configuration is supported only through PowerShell.</span></span> <span data-ttu-id="5e7c8-130">Leia mais sobre [como restaurar um controlador de domínio com vários DCs](backup-azure-restore-vms.md#restoring-domain-controller-vms)</span><span class="sxs-lookup"><span data-stu-id="5e7c8-130">Read more about [restoring a multi-DC domain controller](backup-azure-restore-vms.md#restoring-domain-controller-vms).</span></span>
* <span data-ttu-id="5e7c8-131">Apenas há suporte para a restauração de máquinas virtuais que têm as seguintes configurações de rede especial por meio do PowerShell.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-131">Restoring virtual machines that have the following special network configurations is supported only through PowerShell.</span></span> <span data-ttu-id="5e7c8-132">Máquinas virtuais que você criar usando o fluxo de trabalho de restauração na interface do usuário não terão essas configurações de rede depois que a operação de restauração for concluída.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-132">VMs that you create by using the restore workflow in the UI will not have these network configurations after the restore operation is complete.</span></span> <span data-ttu-id="5e7c8-133">Para saber mais, confira [Restaurando VMs com configurações de rede especiais](backup-azure-restore-vms.md#restoring-vms-with-special-network-configurations).</span><span class="sxs-lookup"><span data-stu-id="5e7c8-133">To learn more, see [Restoring VMs with special network configurations](backup-azure-restore-vms.md#restoring-vms-with-special-network-configurations).</span></span>
  * <span data-ttu-id="5e7c8-134">Máquinas virtuais sob configuração do balanceador de carga (interno e externo)</span><span class="sxs-lookup"><span data-stu-id="5e7c8-134">Virtual machines under load balancer configuration (internal and external)</span></span>
  * <span data-ttu-id="5e7c8-135">Máquinas virtuais com vários endereços IP reservados</span><span class="sxs-lookup"><span data-stu-id="5e7c8-135">Virtual machines with multiple reserved IP addresses</span></span>
  * <span data-ttu-id="5e7c8-136">Máquinas virtuais com vários adaptadores de rede</span><span class="sxs-lookup"><span data-stu-id="5e7c8-136">Virtual machines with multiple network adapters</span></span>

## <a name="create-a-backup-vault-for-a-vm"></a><span data-ttu-id="5e7c8-137">Criar um cofre de backup para uma VM</span><span class="sxs-lookup"><span data-stu-id="5e7c8-137">Create a backup vault for a VM</span></span>
<span data-ttu-id="5e7c8-138">O cofre de backup é uma entidade que armazena todos os pontos de backups e recuperação que foram criados ao longo do tempo.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-138">A backup vault is an entity that stores all the backups and recovery points that have been created over time.</span></span> <span data-ttu-id="5e7c8-139">O cofre de backup também contém as políticas de backup que serão aplicadas às máquinas virtuais que passarão pelo backup.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-139">The backup vault also contains the backup policies that will be applied to the virtual machines being backed up.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="5e7c8-140">A partir de março de 2017, você não poderá mais usar o portal clássico para criar os cofres de Backup.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-140">Starting March 2017, you can no longer use the classic portal to create Backup vaults.</span></span> <span data-ttu-id="5e7c8-141">Ainda há suporte para os cofres de Backup existentes, e é possível [usar o Azure PowerShell para criar os Cofres de Backup](./backup-client-automation-classic.md#create-a-backup-vault).</span><span class="sxs-lookup"><span data-stu-id="5e7c8-141">Existing Backup vaults are still supported, and it is possible to [use Azure PowerShell to create Backup vaults](./backup-client-automation-classic.md#create-a-backup-vault).</span></span> <span data-ttu-id="5e7c8-142">No entanto, a Microsoft recomenda a criação de cofres dos Serviços de Recuperação para todas as implantações, pois aperfeiçoamentos futuros só se aplicam aos cofres dos Serviços de Recuperação.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-142">However, Microsoft recommends you create Recovery Services vaults for all deployments because future enhancements apply to Recovery Services vaults, only.</span></span>


<span data-ttu-id="5e7c8-143">Esta imagem mostra os relacionamentos entre as várias entidades do Backup do Azure: ![Entidades e relacionamentos do Backup do Azure](./media/backup-azure-vms-prepare/vault-policy-vm.png)</span><span class="sxs-lookup"><span data-stu-id="5e7c8-143">This image shows the relationships between the various Azure Backup entities: ![Azure Backup entities and relationships](./media/backup-azure-vms-prepare/vault-policy-vm.png)</span></span>



## <a name="network-connectivity"></a><span data-ttu-id="5e7c8-144">Conectividade de rede</span><span class="sxs-lookup"><span data-stu-id="5e7c8-144">Network connectivity</span></span>
<span data-ttu-id="5e7c8-145">Para gerenciar os instantâneos de VM, a extensão de backup precisa de conectividade com os endereços IP públicos do Azure.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-145">In order to manage the VM snapshots, the backup extension needs connectivity to the Azure public IP addresses.</span></span> <span data-ttu-id="5e7c8-146">Sem a conexão correta com a Internet, as solicitações HTTP da máquina virtual atingirão o tempo limite e a operação de backup falhará.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-146">Without the right Internet connectivity, the virtual machine's HTTP requests time out and the backup operation fails.</span></span> <span data-ttu-id="5e7c8-147">Se sua implantação possui restrições de acesso em vigor (por meio de um NSG, Grupo de Segurança de Rede, por exemplo), escolha uma destas opções para fornecer um caminho livre para o tráfego de backup:</span><span class="sxs-lookup"><span data-stu-id="5e7c8-147">If your deployment has access restrictions in place (through a network security group (NSG), for example), then choose one of these options for providing a clear path for backup traffic:</span></span>

* <span data-ttu-id="5e7c8-148">[Lista de autorizados de intervalos de IP de datacenter do Azure](http://www.microsoft.com/en-us/download/details.aspx?id=41653) : consulte o artigo para obter instruções sobre como colocar os endereços IP na lista de autorizados.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-148">[Whitelist the Azure datacenter IP ranges](http://www.microsoft.com/en-us/download/details.aspx?id=41653) - see the article for instructions on how to whitelist the IP addresses.</span></span>
* <span data-ttu-id="5e7c8-149">Implante um servidor de proxy HTTP para rotear o tráfego.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-149">Deploy an HTTP proxy server for routing traffic.</span></span>

<span data-ttu-id="5e7c8-150">Ao decidir qual opção usar, desvantagens entre a capacidade de gerenciamento, controle granular e custo.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-150">When deciding which option to use, the trade-offs are between manageability, granular control, and cost.</span></span>

| <span data-ttu-id="5e7c8-151">Opção</span><span class="sxs-lookup"><span data-stu-id="5e7c8-151">Option</span></span> | <span data-ttu-id="5e7c8-152">Vantagens</span><span class="sxs-lookup"><span data-stu-id="5e7c8-152">Advantages</span></span> | <span data-ttu-id="5e7c8-153">Desvantagens</span><span class="sxs-lookup"><span data-stu-id="5e7c8-153">Disadvantages</span></span> |
| --- | --- | --- |
| <span data-ttu-id="5e7c8-154">Intervalos de IPs na lista de autorizados</span><span class="sxs-lookup"><span data-stu-id="5e7c8-154">Whitelist IP ranges</span></span> |<span data-ttu-id="5e7c8-155">Sem custo adicional.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-155">No additional costs.</span></span><br><br><span data-ttu-id="5e7c8-156">Para habilitar o acesso em NSG, use o cmdlet <i>Set-AzureNetworkSecurityRule</i>.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-156">For opening access in an NSG, use the <i>Set-AzureNetworkSecurityRule</i> cmdlet.</span></span> |<span data-ttu-id="5e7c8-157">É complexo para gerenciar, já que os intervalos de IP afetados mudam com o tempo.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-157">Complex to manage as the impacted IP ranges change over time.</span></span><br><br><span data-ttu-id="5e7c8-158">Fornece acesso ao Azure por completo, não somente ao Armazenamento.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-158">Provides access to the whole of Azure, and not just Storage.</span></span> |
| <span data-ttu-id="5e7c8-159">Proxy HTTP</span><span class="sxs-lookup"><span data-stu-id="5e7c8-159">HTTP proxy</span></span> |<span data-ttu-id="5e7c8-160">É permitido o controle granular no proxy em relação às URLs de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-160">Granular control in the proxy over the storage URLs allowed.</span></span> <span data-ttu-id="5e7c8-161">Para um controle granular de instalação no proxy, o padrão de URL https://\*.blob.core.windows.net/\* deve ser colocado na lista de permissões.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-161">To setup granular control in the proxy, https://\*.blob.core.windows.net/\* URL Pattern needs to be whitelisted.</span></span> <span data-ttu-id="5e7c8-162">Para colocar na lista de permissões somente a conta de armazenamento usada pela VM, o padrão de URL https://\<storageAccount\>.blob.core.windows.net/\* deve ser colocado na lista de permissões.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-162">To whitelist only the storage account used by the VM, https://\<storageAccount\>.blob.core.windows.net/\* URL pattern needs to be whitelisted.</span></span> <br><span data-ttu-id="5e7c8-163">Único ponto de acesso à Internet para VMs.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-163">Single point of Internet access to VMs.</span></span><br><span data-ttu-id="5e7c8-164">Não está sujeito a alterações do endereço IP do Azure</span><span class="sxs-lookup"><span data-stu-id="5e7c8-164">Not subject to Azure IP address changes.</span></span> |<span data-ttu-id="5e7c8-165">Custos adicionais para a execução de uma VM com o software do proxy</span><span class="sxs-lookup"><span data-stu-id="5e7c8-165">Additional costs for running a VM with the proxy software.</span></span> |

### <a name="whitelist-the-azure-datacenter-ip-ranges"></a><span data-ttu-id="5e7c8-166">lista de autorizados de intervalos de IP de datacenter do Azure</span><span class="sxs-lookup"><span data-stu-id="5e7c8-166">Whitelist the Azure datacenter IP ranges</span></span>
<span data-ttu-id="5e7c8-167">Para colocar os intervalos IP do datacenter do Azure na lista de autorizados, consulte o [site do Azure](http://www.microsoft.com/en-us/download/details.aspx?id=41653) para obter detalhes sobre os intervalos de IP e as instruções.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-167">To whitelist the Azure datacenter IP ranges, please see the [Azure website](http://www.microsoft.com/en-us/download/details.aspx?id=41653) for details on the IP ranges, and instructions.</span></span>

### <a name="using-an-http-proxy-for-vm-backups"></a><span data-ttu-id="5e7c8-168">Usando um proxy HTTP para backups de uma VM</span><span class="sxs-lookup"><span data-stu-id="5e7c8-168">Using an HTTP proxy for VM backups</span></span>
<span data-ttu-id="5e7c8-169">Ao fazer backup de uma VM, a extensão de backup na VM envia os comandos de gerenciamento de instantâneo para o Armazenamento do Azure usando a API de HTTPS.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-169">When backing up a VM, the backup extension on the VM sends the snapshot management commands to Azure Storage using an HTTPS API.</span></span> <span data-ttu-id="5e7c8-170">Roteie o tráfego da extensão de backup por meio do proxy HTTP, pois ele é o único componente configurado para dar acesso à Internet pública.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-170">Route the backup extension traffic through the HTTP proxy since it is the only component configured for access to the public Internet.</span></span>

> [!NOTE]
> <span data-ttu-id="5e7c8-171">Não há recomendações do software de proxy a serem usadas.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-171">There is no recommendation for the proxy software that should be used.</span></span> <span data-ttu-id="5e7c8-172">Escolha um proxy que tenha permanência de saída e que seja compatível com as etapas de configuração abaixo.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-172">Ensure that you pick a proxy that has outbound stickiness and which is compatible with the configuration steps below.</span></span> <span data-ttu-id="5e7c8-173">Certifique-se de os softwares de terceiros não modificam as configurações de proxy</span><span class="sxs-lookup"><span data-stu-id="5e7c8-173">Make sure third party softwares do not modify the proxy settings</span></span>
>
>

<span data-ttu-id="5e7c8-174">A imagem de exemplo abaixo mostra as três etapas de configuração necessárias para usar um proxy HTTP:</span><span class="sxs-lookup"><span data-stu-id="5e7c8-174">The example image below shows the three configuration steps necessary to use an HTTP proxy:</span></span>

* <span data-ttu-id="5e7c8-175">A VM de aplicativo roteia todo o tráfego HTTP voltado para a Internet pública por meio da VM do Proxy.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-175">App VM routes all HTTP traffic bound for the public Internet through Proxy VM.</span></span>
* <span data-ttu-id="5e7c8-176">A VM do Proxy permite a passagem do tráfego de entrada de VMs na rede virtual.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-176">Proxy VM allows incoming traffic from VMs in the virtual network.</span></span>
* <span data-ttu-id="5e7c8-177">O NSG (Grupo de Segurança de Rede) chamado bloqueio de NSF precisa de uma regra de segurança para permitir a passagem de tráfego de Internet da VM do Proxy.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-177">The Network Security Group (NSG) named NSF-lockdown needs a security rule allowing outbound Internet traffic from Proxy VM.</span></span>

![Diagrama de implantação de proxy HTTP com NSG](./media/backup-azure-vms-prepare/nsg-with-http-proxy.png)

<span data-ttu-id="5e7c8-179">Para usar um proxy HTTP para se comunicar com a Internet pública, siga estas etapas:</span><span class="sxs-lookup"><span data-stu-id="5e7c8-179">To use an HTTP proxy to communicating to the public Internet, follow these steps:</span></span>

#### <a name="step-1-configure-outgoing-network-connections"></a><span data-ttu-id="5e7c8-180">Etapa 1.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-180">Step 1.</span></span> <span data-ttu-id="5e7c8-181">Configurar conexões de rede de saída</span><span class="sxs-lookup"><span data-stu-id="5e7c8-181">Configure outgoing network connections</span></span>
###### <a name="for-windows-machines"></a><span data-ttu-id="5e7c8-182">Para computadores Windows</span><span class="sxs-lookup"><span data-stu-id="5e7c8-182">For Windows machines</span></span>
<span data-ttu-id="5e7c8-183">Isso definirá a configuração do servidor de proxy para a Conta do Sistema Local.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-183">This will setup proxy server configuration for Local System Account.</span></span>

1. <span data-ttu-id="5e7c8-184">Baixe o [PsExec](https://technet.microsoft.com/sysinternals/bb897553)</span><span class="sxs-lookup"><span data-stu-id="5e7c8-184">Download [PsExec](https://technet.microsoft.com/sysinternals/bb897553)</span></span>
2. <span data-ttu-id="5e7c8-185">Execute o seguinte comando no prompt com privilégios elevados,</span><span class="sxs-lookup"><span data-stu-id="5e7c8-185">Run following command from elevated prompt,</span></span>

     ```
     psexec -i -s "c:\Program Files\Internet Explorer\iexplore.exe"
     ```
     <span data-ttu-id="5e7c8-186">Isso abrirá a janela do Internet Explorer.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-186">It will open internet explorer window.</span></span>
3. <span data-ttu-id="5e7c8-187">Acesse Ferramentas -> Opções da Internet -> Conexões -> Configurações de LAN.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-187">Go to Tools -> Internet Options -> Connections -> LAN settings.</span></span>
4. <span data-ttu-id="5e7c8-188">Verifique as configurações de proxy para a conta do Sistema.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-188">Verify proxy settings for System account.</span></span> <span data-ttu-id="5e7c8-189">Defina o IP e a porta do proxy.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-189">Set Proxy IP and port.</span></span>
5. <span data-ttu-id="5e7c8-190">Feche o Internet Explorer.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-190">Close Internet Explorer.</span></span>

<span data-ttu-id="5e7c8-191">Isso configurará um proxy de todo o computador e será usado para qualquer tráfego de saída HTTP/HTTPS.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-191">This will set up a machine-wide proxy configuration, and will be used for any outgoing HTTP/HTTPS traffic.</span></span>

<span data-ttu-id="5e7c8-192">Se você configurou um servidor de proxy em uma conta de usuário atual (não uma Conta do Sistema Local), use o script a seguir para aplicá-la ao SYSTEMACCOUNT:</span><span class="sxs-lookup"><span data-stu-id="5e7c8-192">If you have setup a proxy server on a current user account(not a Local System Account), use the following script to apply them to SYSTEMACCOUNT:</span></span>

```
   $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections"
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name DefaultConnectionSettings -Value $obj.DefaultConnectionSettings
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name SavedLegacySettings -Value $obj.SavedLegacySettings
   $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings"
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name ProxyEnable -Value $obj.ProxyEnable
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name Proxyserver -Value $obj.Proxyserver
```

> [!NOTE]
> <span data-ttu-id="5e7c8-193">Se você vir "(407) Autenticação de Proxy Necessária" no log do servidor proxy, verifique se a configuração da sua autenticação está correta.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-193">If you observe "(407)Proxy Authentication Required" in proxy server log, check your authentication is setup correctly.</span></span>
>
>

###### <a name="for-linux-machines"></a><span data-ttu-id="5e7c8-194">Para computadores Linux</span><span class="sxs-lookup"><span data-stu-id="5e7c8-194">For Linux machines</span></span>
<span data-ttu-id="5e7c8-195">Adicione a seguinte linha ao arquivo ```/etc/environment``` :</span><span class="sxs-lookup"><span data-stu-id="5e7c8-195">Add the following line to the ```/etc/environment``` file:</span></span>

```
http_proxy=http://<proxy IP>:<proxy port>
```

<span data-ttu-id="5e7c8-196">Adicione as linhas abaixo ao arquivo ```/etc/waagent.conf``` :</span><span class="sxs-lookup"><span data-stu-id="5e7c8-196">Add the following lines to the ```/etc/waagent.conf``` file:</span></span>

```
HttpProxy.Host=<proxy IP>
HttpProxy.Port=<proxy port>
```

#### <a name="step-2-allow-incoming-connections-on-the-proxy-server"></a><span data-ttu-id="5e7c8-197">Etapa 2.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-197">Step 2.</span></span> <span data-ttu-id="5e7c8-198">Permitir conexões de entrada no servidor de proxy:</span><span class="sxs-lookup"><span data-stu-id="5e7c8-198">Allow incoming connections on the proxy server:</span></span>
1. <span data-ttu-id="5e7c8-199">No servidor proxy, abra o Firewall do Windows.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-199">On the proxy server, open Windows Firewall.</span></span> <span data-ttu-id="5e7c8-200">A maneira mais fácil de acessar o firewall é procurar o Firewall do Windows com Segurança Avançada.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-200">The easiest way to access the firewall is to search for Windows Firewall with Advanced Security.</span></span>

    ![Abrir o Firewall](./media/backup-azure-vms-prepare/firewall-01.png)
2. <span data-ttu-id="5e7c8-202">No diálogo Firewall do Windows, clique com o botão direito do mouse em **Regras de Entrada** e clique em **Nova Regra...**.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-202">In the Windows Firewall dialog, right-click  **Inbound Rules** and click **New Rule...**.</span></span>

    ![Criar uma nova regra](./media/backup-azure-vms-prepare/firewall-02.png)
3. <span data-ttu-id="5e7c8-204">No **Assistente para Nova Regra de Entrada**, selecione a opção **Personalizar** para **Tipo de Regra** e clique em **Avançar**.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-204">In the **New Inbound Rule Wizard**, choose the **Custom** option for the **Rule Type** and click **Next**.</span></span>
4. <span data-ttu-id="5e7c8-205">Na página para selecionar **Programa**, escolha **Todos os Programas** e clique em **Avançar**.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-205">On the page to select the **Program**, choose **All Programs** and click **Next**.</span></span>
5. <span data-ttu-id="5e7c8-206">Na página **Protocolo e Portas**, insira as seguintes informações e clique em **Avançar**:</span><span class="sxs-lookup"><span data-stu-id="5e7c8-206">On the **Protocol and Ports** page, enter the following information and click **Next**:</span></span>

    ![Criar uma nova regra](./media/backup-azure-vms-prepare/firewall-03.png)

   * <span data-ttu-id="5e7c8-208">para *Tipo de protocolo*, escolha *TCP*</span><span class="sxs-lookup"><span data-stu-id="5e7c8-208">for *Protocol type* choose *TCP*</span></span>
   * <span data-ttu-id="5e7c8-209">para *Porta local*, escolha *Portas Específicas*, no campo abaixo especifique o ```<Proxy Port>``` que foi configurado.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-209">for *Local port* choose *Specific Ports*, in the field below specify the ```<Proxy Port>``` that has been configured.</span></span>
   * <span data-ttu-id="5e7c8-210">para *Porta remota*, escolha *Todas as Portas*</span><span class="sxs-lookup"><span data-stu-id="5e7c8-210">for *Remote port* select *All Ports*</span></span>

     <span data-ttu-id="5e7c8-211">Para o restante do assistente, clique até o fim e dê um nome a essa regra.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-211">For the rest of the wizard, click all the way to the end and give this rule a name.</span></span>

#### <a name="step-3-add-an-exception-rule-to-the-nsg"></a><span data-ttu-id="5e7c8-212">Etapa 3.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-212">Step 3.</span></span> <span data-ttu-id="5e7c8-213">Adicionar uma regra de exceção ao NSG:</span><span class="sxs-lookup"><span data-stu-id="5e7c8-213">Add an exception rule to the NSG:</span></span>
<span data-ttu-id="5e7c8-214">Em um prompt de comando do Azure PowerShell, digite o seguinte comando:</span><span class="sxs-lookup"><span data-stu-id="5e7c8-214">In an Azure PowerShell command prompt, enter the following command:</span></span>

<span data-ttu-id="5e7c8-215">O comando a seguir adiciona uma exceção ao NSG.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-215">The following command adds an exception to the NSG.</span></span> <span data-ttu-id="5e7c8-216">Essa exceção permite a passagem de tráfego TCP de qualquer porta em 10.0.0.5 para qualquer endereço da Internet na porta 80 (HTTP) ou 443 (HTTPS).</span><span class="sxs-lookup"><span data-stu-id="5e7c8-216">This exception allows TCP traffic from any port on 10.0.0.5 to any Internet address on port 80 (HTTP) or 443 (HTTPS).</span></span> <span data-ttu-id="5e7c8-217">Se você exigir uma porta específica na Internet pública, adicione-a também ao ```-DestinationPortRange``` .</span><span class="sxs-lookup"><span data-stu-id="5e7c8-217">If you require a specific port in the public Internet, be sure to add that port to the ```-DestinationPortRange``` as well.</span></span>

```
Get-AzureNetworkSecurityGroup -Name "NSG-lockdown" |
Set-AzureNetworkSecurityRule -Name "allow-proxy " -Action Allow -Protocol TCP -Type Outbound -Priority 200 -SourceAddressPrefix "10.0.0.5/32" -SourcePortRange "*" -DestinationAddressPrefix Internet -DestinationPortRange "80-443"
```

<span data-ttu-id="5e7c8-218">*Verifique se você substituiu os nomes no exemplo com os detalhes adequados para a implantação.*</span><span class="sxs-lookup"><span data-stu-id="5e7c8-218">*Ensure that you replace the names in the example with the details appropriate to your deployment.*</span></span>

## <a name="vm-agent"></a><span data-ttu-id="5e7c8-219">Agente de VM</span><span class="sxs-lookup"><span data-stu-id="5e7c8-219">VM agent</span></span>
<span data-ttu-id="5e7c8-220">Antes de iniciar o backup da máquina virtual do Azure, verifique se o agente de VM do Azure está instalado corretamente na máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-220">Before you can back up the Azure virtual machine, you should ensure that the Azure VM agent is correctly installed on the virtual machine.</span></span> <span data-ttu-id="5e7c8-221">Como o agente de VM é um componente opcional no momento em que a máquina virtual é criada, verifique se a caixa de seleção do Agente de VM está marcada antes que a máquina virtual seja provisionada.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-221">Since the VM agent is an optional component at the time that the virtual machine is created, ensure that the check box for the VM agent is selected before the virtual machine is provisioned.</span></span>

### <a name="manual-installation-and-update"></a><span data-ttu-id="5e7c8-222">Atualização e instalação manual</span><span class="sxs-lookup"><span data-stu-id="5e7c8-222">Manual installation and update</span></span>
<span data-ttu-id="5e7c8-223">O agente de VM já está presente em VMs criadas na galeria do Azure.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-223">The VM agent is already present in VMs that are created from the Azure gallery.</span></span> <span data-ttu-id="5e7c8-224">No entanto, as máquinas virtuais que são migradas de datacenters locais não teriam o agente de VM instalado.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-224">However, virtual machines that are migrated from on-premises datacenters would not have the VM agent installed.</span></span> <span data-ttu-id="5e7c8-225">Para essas VMs, o agente de VM precisa ser instalado explicitamente.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-225">For such VMs, the VM agent needs to be installed explicitly.</span></span> <span data-ttu-id="5e7c8-226">Leia mais sobre [Instalando o Agente de VM em uma VM existente](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx).</span><span class="sxs-lookup"><span data-stu-id="5e7c8-226">Read more about [installing the VM agent on an existing VM](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx).</span></span>

| <span data-ttu-id="5e7c8-227">**Operação**</span><span class="sxs-lookup"><span data-stu-id="5e7c8-227">**Operation**</span></span> | <span data-ttu-id="5e7c8-228">**Windows**</span><span class="sxs-lookup"><span data-stu-id="5e7c8-228">**Windows**</span></span> | <span data-ttu-id="5e7c8-229">**Linux**</span><span class="sxs-lookup"><span data-stu-id="5e7c8-229">**Linux**</span></span> |
| --- | --- | --- |
| <span data-ttu-id="5e7c8-230">Instalando o agente de VM</span><span class="sxs-lookup"><span data-stu-id="5e7c8-230">Installing the VM agent</span></span> |<li><span data-ttu-id="5e7c8-231">Baixe e instale o [agente MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span><span class="sxs-lookup"><span data-stu-id="5e7c8-231">Download and install the [agent MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span></span> <span data-ttu-id="5e7c8-232">Você precisará de privilégios de Administrador para concluir a instalação.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-232">You will need Administrator privileges to complete the installation.</span></span> <li><span data-ttu-id="5e7c8-233">[Atualize a propriedade de VM](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) para indicar que o agente está instalado.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-233">[Update the VM property](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) to indicate that the agent is installed.</span></span> |<li> <span data-ttu-id="5e7c8-234">Instale o [agente Linux](https://github.com/Azure/WALinuxAgent) mais recente do GitHub.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-234">Install the latest [Linux agent](https://github.com/Azure/WALinuxAgent) from GitHub.</span></span> <span data-ttu-id="5e7c8-235">Você precisará de privilégios de Administrador para concluir a instalação.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-235">You will need Administrator privileges to complete the installation.</span></span> <li> <span data-ttu-id="5e7c8-236">[Atualize a propriedade de VM](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) para indicar que o agente está instalado.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-236">[Update the VM property](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) to indicate that the agent is installed.</span></span> |
| <span data-ttu-id="5e7c8-237">Atualizando o agente de VM</span><span class="sxs-lookup"><span data-stu-id="5e7c8-237">Updating the VM agent</span></span> |<span data-ttu-id="5e7c8-238">A atualização do agente de VM é tão simples quanto reinstalar os [binários do agente de VM](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span><span class="sxs-lookup"><span data-stu-id="5e7c8-238">Updating the VM agent is as simple as reinstalling the [VM agent binaries](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span></span> <br><br><span data-ttu-id="5e7c8-239">Verifique se nenhuma operação de backup está em execução enquanto o agente de VM está sendo atualizado.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-239">Ensure that no backup operation is running while the VM agent is being updated.</span></span> |<span data-ttu-id="5e7c8-240">Siga as instruções em [Atualizando o agente de VM do Linux ](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="5e7c8-240">Follow the instructions on [updating the Linux VM agent ](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span></span> <br><br><span data-ttu-id="5e7c8-241">Verifique se nenhuma operação de backup está em execução enquanto o agente de VM está sendo atualizado.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-241">Ensure that no backup operation is running while the VM agent is being updated.</span></span> |
| <span data-ttu-id="5e7c8-242">Validação da instalação do agente de VM</span><span class="sxs-lookup"><span data-stu-id="5e7c8-242">Validating the VM agent installation</span></span> |<li><span data-ttu-id="5e7c8-243">Navegue até a pasta *C:\WindowsAzure\Packages* na VM do Azure.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-243">Navigate to the *C:\WindowsAzure\Packages* folder in the Azure VM.</span></span> <li><span data-ttu-id="5e7c8-244">Você deve encontrar o arquivo WaAppAgent.exe presente.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-244">You should find the WaAppAgent.exe file present.</span></span><li> <span data-ttu-id="5e7c8-245">Clique com o botão direito do mouse no arquivo, vá para **Propriedades** e selecione a guia **Detalhes**.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-245">Right-click the file, go to **Properties**, and then select the **Details** tab.</span></span> <span data-ttu-id="5e7c8-246">O campo Versão do Produto deve ser 2.6.1198.718 ou mais recente.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-246">The Product Version field should be 2.6.1198.718 or higher.</span></span> |<span data-ttu-id="5e7c8-247">N/D</span><span class="sxs-lookup"><span data-stu-id="5e7c8-247">N/A</span></span> |

<span data-ttu-id="5e7c8-248">Saiba mais sobre o [Agente de VM](https://go.microsoft.com/fwLink/?LinkID=390493&clcid=0x409) e [como instalá-lo](https://azure.microsoft.com/blog/2014/04/15/vm-agent-and-extensions-part-2/).</span><span class="sxs-lookup"><span data-stu-id="5e7c8-248">Learn about the [VM agent](https://go.microsoft.com/fwLink/?LinkID=390493&clcid=0x409) and [how to install it](https://azure.microsoft.com/blog/2014/04/15/vm-agent-and-extensions-part-2/).</span></span>

### <a name="backup-extension"></a><span data-ttu-id="5e7c8-249">Extensão de backup</span><span class="sxs-lookup"><span data-stu-id="5e7c8-249">Backup extension</span></span>
<span data-ttu-id="5e7c8-250">Para fazer backup da máquina virtual, o serviço do Backup do Azure instala uma extensão para o agente de VM.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-250">To back up the virtual machine, the Azure Backup service installs an extension to the VM agent.</span></span> <span data-ttu-id="5e7c8-251">O serviço do Backup do Azure atualiza e corrige perfeitamente a extensão de backup sem intervenção adicional do usuário.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-251">The Azure Backup service seamlessly upgrades and patches the backup extension without additional user intervention.</span></span>

<span data-ttu-id="5e7c8-252">A extensão de backup será instalada se a VM estiver em execução.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-252">The backup extension is installed if the VM is running.</span></span> <span data-ttu-id="5e7c8-253">Uma VM em execução também oferece uma maior chance de obter um ponto de recuperação consistente com o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-253">A running VM also provides the greatest chance of getting an application-consistent recovery point.</span></span> <span data-ttu-id="5e7c8-254">No entanto, o serviço do Backup do Azure continuará a realizar o backup da VM mesmo quando esta estiver desativada e a extensão não puder ser instalada (também conhecida como VM Offline).</span><span class="sxs-lookup"><span data-stu-id="5e7c8-254">However, the Azure Backup service will continue to back up the VM--even if it is turned off, and the extension could not be installed (aka Offline VM).</span></span> <span data-ttu-id="5e7c8-255">Nesse caso, o ponto de recuperação será *falha consistente* , como discutido anteriormente.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-255">In this case, the recovery point will be *crash consistent* as discussed above.</span></span>

## <a name="questions"></a><span data-ttu-id="5e7c8-256">Perguntas?</span><span class="sxs-lookup"><span data-stu-id="5e7c8-256">Questions?</span></span>
<span data-ttu-id="5e7c8-257">Se você tiver dúvidas ou gostaria de ver algum recurso incluído, [envie-nos seus comentários](http://aka.ms/azurebackup_feedback).</span><span class="sxs-lookup"><span data-stu-id="5e7c8-257">If you have questions, or if there is any feature that you would like to see included, [send us feedback](http://aka.ms/azurebackup_feedback).</span></span>

## <a name="next-steps"></a><span data-ttu-id="5e7c8-258">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="5e7c8-258">Next steps</span></span>
<span data-ttu-id="5e7c8-259">Agora que você já preparou seu ambiente para fazer backup de sua VM, a próxima etapa lógica será criar um backup.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-259">Now that you have prepared your environment for backing up your VM, your next logical step is to create a backup.</span></span> <span data-ttu-id="5e7c8-260">O artigo de planejamento oferece informações mais detalhadas sobre o backup de máquinas virtuais.</span><span class="sxs-lookup"><span data-stu-id="5e7c8-260">The planning article provides more detailed information about backing up VMs.</span></span>

* [<span data-ttu-id="5e7c8-261">Backup de máquinas virtuais</span><span class="sxs-lookup"><span data-stu-id="5e7c8-261">Back up virtual machines</span></span>](backup-azure-vms.md)
* [<span data-ttu-id="5e7c8-262">Planeje sua infraestrutura de backup da VM</span><span class="sxs-lookup"><span data-stu-id="5e7c8-262">Plan your VM backup infrastructure</span></span>](backup-azure-vms-introduction.md)
* [<span data-ttu-id="5e7c8-263">Gerenciar backups de máquinas virtuais</span><span class="sxs-lookup"><span data-stu-id="5e7c8-263">Manage virtual machine backups</span></span>](backup-azure-manage-vms.md)
