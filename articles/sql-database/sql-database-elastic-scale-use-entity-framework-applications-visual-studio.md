---
title: "biblioteca de cliente de banco de dados Elástico aaaUsing com o Entity Framework | Microsoft Docs"
description: "Usar a biblioteca de cliente do Banco de Dados Elástico e o Entity Framework para bancos de dados de codificação"
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
editor: 
ms.assetid: b9c3065b-cb92-41be-aa7f-deba23e7e159
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/06/2017
ms.author: torsteng
ms.openlocfilehash: 917f6d28d9855c0b42afe2c008613a9bbb3ec6b6
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/06/2017
---
# <a name="elastic-database-client-library-with-entity-framework"></a><span data-ttu-id="7cef5-103">Biblioteca cliente do Banco de Dados Elástico com Entity Framework</span><span class="sxs-lookup"><span data-stu-id="7cef5-103">Elastic Database client library with Entity Framework</span></span>
<span data-ttu-id="7cef5-104">Este documento mostra as alterações de saudação em um aplicativo do Entity Framework que são necessária toointegrate com hello [ferramentas de banco de dados Elástico](sql-database-elastic-scale-introduction.md).</span><span class="sxs-lookup"><span data-stu-id="7cef5-104">This document shows hello changes in an Entity Framework application that are needed toointegrate with hello [Elastic Database tools](sql-database-elastic-scale-introduction.md).</span></span> <span data-ttu-id="7cef5-105">Olá foco é compor [gerenciamento de mapa do fragmento](sql-database-elastic-scale-shard-map-management.md) e [roteamento dependente de dados](sql-database-elastic-scale-data-dependent-routing.md) com hello Entity Framework **Code First** abordagem.</span><span class="sxs-lookup"><span data-stu-id="7cef5-105">hello focus is on composing [shard map management](sql-database-elastic-scale-shard-map-management.md) and [data-dependent routing](sql-database-elastic-scale-data-dependent-routing.md) with hello Entity Framework **Code First** approach.</span></span> <span data-ttu-id="7cef5-106">Olá [código primeiro - novo banco de dados](http://msdn.microsoft.com/data/jj193542.aspx) tutorial de EF serve como exemplo de execução ao longo deste documento.</span><span class="sxs-lookup"><span data-stu-id="7cef5-106">hello [Code First - New Database](http://msdn.microsoft.com/data/jj193542.aspx) tutorial for EF serves as our running example throughout this document.</span></span> <span data-ttu-id="7cef5-107">código de exemplo Hello que acompanha este documento é parte das ferramentas de banco de dados Elástico conjunto de amostras Olá exemplos de código do Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="7cef5-107">hello sample code accompanying this document is part of elastic database tools' set of samples in hello Visual Studio Code Samples.</span></span>

## <a name="downloading-and-running-hello-sample-code"></a><span data-ttu-id="7cef5-108">Baixando e executando o código de exemplo de hello</span><span class="sxs-lookup"><span data-stu-id="7cef5-108">Downloading and Running hello Sample Code</span></span>
<span data-ttu-id="7cef5-109">código de saudação toodownload para este artigo:</span><span class="sxs-lookup"><span data-stu-id="7cef5-109">toodownload hello code for this article:</span></span>

* <span data-ttu-id="7cef5-110">É necessário o Visual Studio 2012 ou posterior.</span><span class="sxs-lookup"><span data-stu-id="7cef5-110">Visual Studio 2012 or later is required.</span></span> 
* <span data-ttu-id="7cef5-111">Baixar Olá [Elástico ferramentas de banco de dados do SQL Azure - exemplo de integração do Entity Framework](https://code.msdn.microsoft.com/windowsapps/Elastic-Scale-with-Azure-bae904ba) do MSDN.</span><span class="sxs-lookup"><span data-stu-id="7cef5-111">Download hello [Elastic DB Tools for Azure SQL - Entity Framework Integration sample](https://code.msdn.microsoft.com/windowsapps/Elastic-Scale-with-Azure-bae904ba) from MSDN.</span></span> <span data-ttu-id="7cef5-112">Descompacte Olá exemplo tooa de local de sua escolha.</span><span class="sxs-lookup"><span data-stu-id="7cef5-112">Unzip hello sample tooa location of your choosing.</span></span>
* <span data-ttu-id="7cef5-113">Inicie o Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="7cef5-113">Start Visual Studio.</span></span> 
* <span data-ttu-id="7cef5-114">No Visual Studio, selecione Arquivo -> Abrir Projeto/Solução.</span><span class="sxs-lookup"><span data-stu-id="7cef5-114">In Visual Studio, select File -> Open Project/Solution.</span></span> 
* <span data-ttu-id="7cef5-115">Em Olá **Abrir projeto** caixa de diálogo, navegue toohello exemplo que você baixou e selecione **EntityFrameworkCodeFirst.sln** tooopen exemplo de hello.</span><span class="sxs-lookup"><span data-stu-id="7cef5-115">In hello **Open Project** dialog, navigate toohello sample you downloaded and select **EntityFrameworkCodeFirst.sln** tooopen hello sample.</span></span> 

<span data-ttu-id="7cef5-116">exemplo de hello toorun, é necessário toocreate três bancos de dados vazios no banco de dados do SQL Azure:</span><span class="sxs-lookup"><span data-stu-id="7cef5-116">toorun hello sample, you need toocreate three empty databases in Azure SQL Database:</span></span>

* <span data-ttu-id="7cef5-117">Banco de dados do Gerenciador do mapa do fragmento</span><span class="sxs-lookup"><span data-stu-id="7cef5-117">Shard Map Manager database</span></span>
* <span data-ttu-id="7cef5-118">Banco de dados do fragmento 1</span><span class="sxs-lookup"><span data-stu-id="7cef5-118">Shard 1 database</span></span>
* <span data-ttu-id="7cef5-119">Banco de dados do fragmento 2</span><span class="sxs-lookup"><span data-stu-id="7cef5-119">Shard 2 database</span></span>

<span data-ttu-id="7cef5-120">Depois de criar esses bancos de dados, preencha espaços reservados de saudação em **Program.cs** com o nome do seu servidor de banco de dados do Azure SQL, nomes de banco de dados de saudação e seus bancos de dados credenciais tooconnect toohello.</span><span class="sxs-lookup"><span data-stu-id="7cef5-120">Once you have created these databases, fill in hello place holders in **Program.cs** with your Azure SQL DB server name, hello database names and your credentials tooconnect toohello databases.</span></span> <span data-ttu-id="7cef5-121">Compile a solução Olá no Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="7cef5-121">Build hello solution in Visual Studio.</span></span> <span data-ttu-id="7cef5-122">Visual Studio baixará os pacotes do NuGet Olá necessária para biblioteca de cliente do banco de dados Elástico hello, Entity Framework e Transient Fault handling como parte do processo de compilação de saudação.</span><span class="sxs-lookup"><span data-stu-id="7cef5-122">Visual Studio will download hello required NuGet packages for hello elastic database client library, Entity Framework, and Transient Fault handling as part of hello build process.</span></span> <span data-ttu-id="7cef5-123">Certifique-se de que a restauração de pacotes NuGet está habilitada para sua solução.</span><span class="sxs-lookup"><span data-stu-id="7cef5-123">Make sure that restoring NuGet packages is enabled for your solution.</span></span> <span data-ttu-id="7cef5-124">Você pode habilitar essa configuração, o botão direito no arquivo de solução Olá Olá Gerenciador de soluções do Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="7cef5-124">You can enable this setting by right-clicking on hello solution file in hello Visual Studio Solution Explorer.</span></span> 

## <a name="entity-framework-workflows"></a><span data-ttu-id="7cef5-125">Fluxos de trabalho do Entity Framework</span><span class="sxs-lookup"><span data-stu-id="7cef5-125">Entity Framework workflows</span></span>
<span data-ttu-id="7cef5-126">Os desenvolvedores do Entity Framework contam com uma saudação quatro tooensure persistência para os objetos de aplicativo e aplicativos de toobuild de fluxos de trabalho a seguir:</span><span class="sxs-lookup"><span data-stu-id="7cef5-126">Entity Framework developers rely on one of hello following four workflows toobuild applications and tooensure persistence for application objects:</span></span> 

* <span data-ttu-id="7cef5-127">**Code First (novo banco de dados)**: Olá desenvolvedor EF cria o modelo de Olá no código do aplicativo hello e, em seguida, o EF gera o banco de dados de saudação dele.</span><span class="sxs-lookup"><span data-stu-id="7cef5-127">**Code First (New Database)**: hello EF developer creates hello model in hello application code and then EF generates hello database from it.</span></span> 
* <span data-ttu-id="7cef5-128">**Code First (banco de dados existente)**: desenvolvedor Olá permite EF gerar código do aplicativo hello para modelo de saudação do banco de dados existente.</span><span class="sxs-lookup"><span data-stu-id="7cef5-128">**Code First (Existing Database)**: hello developer lets EF generate hello application code for hello model from an existing database.</span></span>
* <span data-ttu-id="7cef5-129">**Modelo primeiro**: desenvolvedor Olá cria o modelo de saudação no designer EF hello e EF cria Olá de banco de dados do modelo de saudação.</span><span class="sxs-lookup"><span data-stu-id="7cef5-129">**Model First**: hello developer creates hello model in hello EF designer and then EF creates hello database from hello model.</span></span>
* <span data-ttu-id="7cef5-130">**Banco de dados primeiro**: desenvolvedor Olá usa EF ferramentas tooinfer modelo de saudação do banco de dados existente.</span><span class="sxs-lookup"><span data-stu-id="7cef5-130">**Database First**: hello developer uses EF tooling tooinfer hello model from an existing database.</span></span> 

<span data-ttu-id="7cef5-131">Todas essas abordagens dependem tootransparently de classe DbContext Olá gerenciam conexões de banco de dados e esquema de banco de dados para um aplicativo.</span><span class="sxs-lookup"><span data-stu-id="7cef5-131">All these approaches rely on hello DbContext class tootransparently manage database connections and database schema for an application.</span></span> <span data-ttu-id="7cef5-132">Como abordaremos em mais detalhes posteriormente neste documento hello, construtores diferentes na classe base do hello DbContext permitem para diferentes níveis de controle sobre a criação de conexão, o criação de inicialização e o esquema de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="7cef5-132">As we will discuss in more detail later in hello document, different constructors on hello DbContext base class allow for different levels of control over connection creation, database bootstrapping and schema creation.</span></span> <span data-ttu-id="7cef5-133">Desafios são provenientes principalmente de fato Olá gerenciamento de conexão de banco de dados de saudação fornecido pelo EF interseção com recursos de gerenciamento de conexão Olá Olá dados dependentes de interfaces de roteamento fornecidas pela biblioteca de cliente do banco de dados Elástico hello.</span><span class="sxs-lookup"><span data-stu-id="7cef5-133">Challenges arise primarily from hello fact that hello database connection management provided by EF intersects with hello connection management capabilities of hello data dependent routing interfaces provided by hello elastic database client library.</span></span> 

## <a name="elastic-database-tools-assumptions"></a><span data-ttu-id="7cef5-134">Suposições sobre ferramentas de banco de dados elástico</span><span class="sxs-lookup"><span data-stu-id="7cef5-134">Elastic database tools assumptions</span></span>
<span data-ttu-id="7cef5-135">Para obter definições de termos, consulte o [Glossário de ferramentas do Banco de Dados Elástico](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="7cef5-135">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span>

<span data-ttu-id="7cef5-136">Com a biblioteca de cliente de banco de dados elástico, você define partições dos seus dados de aplicativo chamados shardlets.</span><span class="sxs-lookup"><span data-stu-id="7cef5-136">With elastic database client library, you define partitions of your application data called shardlets.</span></span> <span data-ttu-id="7cef5-137">Shardlets são identificados por uma chave de fragmentação e são mapeadas toospecific bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="7cef5-137">Shardlets are identified by a sharding key and are mapped toospecific databases.</span></span> <span data-ttu-id="7cef5-138">Um aplicativo pode ter tantos bancos de dados conforme necessário e distribuir Olá shardlets tooprovide suficiente capacidade ou desempenho, considerando os requisitos de negócios atual.</span><span class="sxs-lookup"><span data-stu-id="7cef5-138">An application may have as many databases as needed and distribute hello shardlets tooprovide enough capacity or performance given current business requirements.</span></span> <span data-ttu-id="7cef5-139">mapeamento de saudação de bancos de dados de toohello de valores de chave fragmentação é armazenado por um mapa do fragmento fornecido pelo cliente de banco de dados Elástico Olá APIs.</span><span class="sxs-lookup"><span data-stu-id="7cef5-139">hello mapping of sharding key values toohello databases is stored by a shard map provided by hello elastic database client APIs.</span></span> <span data-ttu-id="7cef5-140">Chamamos essa funcionalidade de **Gerenciamento de Mapa de Fragmentos**ou SMM (abreviada do inglês: Shard Map Management).</span><span class="sxs-lookup"><span data-stu-id="7cef5-140">We call this capability **Shard Map Management**, or SMM for short.</span></span> <span data-ttu-id="7cef5-141">mapa do fragmento Olá também serve como agente de saudação de conexões de banco de dados para solicitações que contêm uma chave de fragmentação.</span><span class="sxs-lookup"><span data-stu-id="7cef5-141">hello shard map also serves as hello broker of database connections for requests that carry a sharding key.</span></span> <span data-ttu-id="7cef5-142">Nós nos referimos a funcionalidade de toothis como **roteamento dependente de dados**.</span><span class="sxs-lookup"><span data-stu-id="7cef5-142">We refer toothis capability as **data-dependent routing**.</span></span> 

<span data-ttu-id="7cef5-143">Gerenciador do mapa de fragmentos Olá protege os usuários contra modos de exibição inconsistente em dados de shardlet que podem ocorrer quando as operações de gerenciamento de shardlet simultâneas (como realocando dados de um fragmento tooanother) estão ocorrendo.</span><span class="sxs-lookup"><span data-stu-id="7cef5-143">hello shard map manager protects users from inconsistent views into shardlet data that can occur when concurrent shardlet management operations (such as relocating data from one shard tooanother) are happening.</span></span> <span data-ttu-id="7cef5-144">toodo Olá assim, mapas de fragmento gerenciados pelo Olá biblioteca broker Olá banco de dados conexões de cliente para um aplicativo.</span><span class="sxs-lookup"><span data-stu-id="7cef5-144">toodo so, hello shard maps managed by hello client library broker hello database connections for an application.</span></span> <span data-ttu-id="7cef5-145">Isso permite kill do hello fragmento mapa funcionalidade tooautomatically uma conexão de banco de dados quando as operações de gerenciamento de fragmento podem afetar Olá shardlet que foi criado para a conexão de saudação.</span><span class="sxs-lookup"><span data-stu-id="7cef5-145">This allows hello shard map functionality tooautomatically kill a database connection when shard management operations could impact hello shardlet that hello connection has been created for.</span></span> <span data-ttu-id="7cef5-146">Essa abordagem deve toointegrate com algumas das funcionalidades do EF, como a criação de novas conexões de um um toocheck existente para a existência de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="7cef5-146">This approach needs toointegrate with some of EF’s functionality, such as creating new connections from an existing one toocheck for database existence.</span></span> <span data-ttu-id="7cef5-147">Em geral, nosso Observação foi que construtores de DbContext padrão Olá só funcionam de forma confiável para conexões de banco de dados fechado que podem ser clonadas com segurança para o trabalho EF.</span><span class="sxs-lookup"><span data-stu-id="7cef5-147">In general, our observation has been that hello standard DbContext constructors only work reliably for closed database connections that can safely be cloned for EF work.</span></span> <span data-ttu-id="7cef5-148">em vez disso, o princípio de design de saudação do banco de dados Elástico é tooonly broker aberto conexões.</span><span class="sxs-lookup"><span data-stu-id="7cef5-148">hello design principle of elastic database instead is tooonly broker opened connections.</span></span> <span data-ttu-id="7cef5-149">Alguém pode pensar que fechar uma conexão orientada por biblioteca de saudação do cliente antes de enviar a ele pela toohello EF DbContext pode resolver esse problema.</span><span class="sxs-lookup"><span data-stu-id="7cef5-149">One might think that closing a connection brokered by hello client library before handing it over toohello EF DbContext may solve this issue.</span></span> <span data-ttu-id="7cef5-150">No entanto, ao fechar conexão hello e confiar no EF toore-open, um foregoes Olá validação e verificações de consistência executadas pela biblioteca de saudação.</span><span class="sxs-lookup"><span data-stu-id="7cef5-150">However, by closing hello connection and relying on EF toore-open it, one foregoes hello validation and consistency checks performed by hello library.</span></span> <span data-ttu-id="7cef5-151">funcionalidade de migrações Olá no EF, no entanto, usa Olá de toomanage essas conexões subjacentes do esquema de banco de dados de forma transparente toohello aplicativo.</span><span class="sxs-lookup"><span data-stu-id="7cef5-151">hello migrations functionality in EF, however, uses these connections toomanage hello underlying database schema in a way that is transparent toohello application.</span></span> <span data-ttu-id="7cef5-152">Idealmente, podemos deseja tooretain e combinar todos esses recursos de biblioteca de cliente do banco de dados Elástico hello e EF no hello mesmo aplicativo.</span><span class="sxs-lookup"><span data-stu-id="7cef5-152">Ideally, we would like tooretain and combine all these capabilities from both hello elastic database client library and EF in hello same application.</span></span> <span data-ttu-id="7cef5-153">Olá seção a seguir descreve essas propriedades e os requisitos mais detalhadamente.</span><span class="sxs-lookup"><span data-stu-id="7cef5-153">hello following section discusses these properties and requirements in more detail.</span></span> 

## <a name="requirements"></a><span data-ttu-id="7cef5-154">Requisitos</span><span class="sxs-lookup"><span data-stu-id="7cef5-154">Requirements</span></span>
<span data-ttu-id="7cef5-155">Ao trabalhar com a biblioteca de cliente do banco de dados Elástico hello e APIs do Entity Framework, queremos Olá tooretain propriedades a seguir:</span><span class="sxs-lookup"><span data-stu-id="7cef5-155">When working with both hello elastic database client library and Entity Framework APIs, we want tooretain hello following properties:</span></span> 

* <span data-ttu-id="7cef5-156">**Expansão**: tooadd ou remover bancos de dados Olá da camada de dados do aplicativo fragmentados Olá conforme necessário para atender às demandas de capacidade de saudação do aplicativo hello.</span><span class="sxs-lookup"><span data-stu-id="7cef5-156">**Scale-out**: tooadd or remove databases from hello data tier of hello sharded application as necessary for hello capacity demands of hello application.</span></span> <span data-ttu-id="7cef5-157">Isso significa controle sobre a criação de Olá Olá e a exclusão de bancos de dados e usando Olá banco de dados Elástico fragmento mapa manager APIs toomanage bancos de dados e mapeamentos de shardlets.</span><span class="sxs-lookup"><span data-stu-id="7cef5-157">This means control over hello hello creation and deletion of databases and using hello elastic database shard map manager APIs toomanage databases, and mappings of shardlets.</span></span> 
* <span data-ttu-id="7cef5-158">**Consistência**: aplicativo hello emprega fragmentação e usa Olá recursos de roteamento dependente de dados da biblioteca de cliente de saudação.</span><span class="sxs-lookup"><span data-stu-id="7cef5-158">**Consistency**: hello application employs sharding, and uses hello data dependent routing capabilities of hello client library.</span></span> <span data-ttu-id="7cef5-159">tooavoid corrupção ou resultados da consulta incorreta, as conexões são orientadas por meio do Gerenciador do mapa de fragmentos hello.</span><span class="sxs-lookup"><span data-stu-id="7cef5-159">tooavoid corruption or wrong query results, connections are brokered through hello shard map manager.</span></span> <span data-ttu-id="7cef5-160">Isso também mantém a consistência e a validação.</span><span class="sxs-lookup"><span data-stu-id="7cef5-160">This also retains validation and consistency.</span></span>
* <span data-ttu-id="7cef5-161">**Code First**: tooretain conveniência de saudação do paradigma de primeiro do EF código.</span><span class="sxs-lookup"><span data-stu-id="7cef5-161">**Code First**: tooretain hello convenience of EF’s code first paradigm.</span></span> <span data-ttu-id="7cef5-162">No Code First, as classes no aplicativo hello são mapeadas transparentemente toohello subjacente estruturas de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="7cef5-162">In Code First, classes in hello application are mapped transparently toohello underlying database structures.</span></span> <span data-ttu-id="7cef5-163">código do aplicativo Hello interage com DbSets que mascarar a maioria dos aspectos envolvidos em Olá subjacente de processamento do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="7cef5-163">hello application code interacts with DbSets that mask most aspects involved in hello underlying database processing.</span></span>
* <span data-ttu-id="7cef5-164">**Esquema**: o Entity Framework lida com a criação de esquema do banco de dados inicial e com a evolução de esquemas subsequentes por meio de migrações.</span><span class="sxs-lookup"><span data-stu-id="7cef5-164">**Schema**: Entity Framework handles initial database schema creation and subsequent schema evolution through migrations.</span></span> <span data-ttu-id="7cef5-165">Mantendo esses recursos, é fácil Olá dados evolui adaptar seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="7cef5-165">By retaining these capabilities, adapting your app is easy as hello data evolves.</span></span> 

<span data-ttu-id="7cef5-166">Olá diretrizes a seguir instrui como toosatisfy esses requisitos para Code First aplicativos usando as ferramentas de banco de dados Elástico.</span><span class="sxs-lookup"><span data-stu-id="7cef5-166">hello following guidance instructs how toosatisfy these requirements for Code First applications using elastic database tools.</span></span> 

## <a name="data-dependent-routing-using-ef-dbcontext"></a><span data-ttu-id="7cef5-167">Roteamento dependente de dados usando o EF DbContext</span><span class="sxs-lookup"><span data-stu-id="7cef5-167">Data dependent routing using EF DbContext</span></span>
<span data-ttu-id="7cef5-168">Conexões de banco de dados com o Entity Framework são normalmente gerenciadas por meio de subclasses do **DbContext**.</span><span class="sxs-lookup"><span data-stu-id="7cef5-168">Database connections with Entity Framework are typically managed through subclasses of **DbContext**.</span></span> <span data-ttu-id="7cef5-169">Crie essas subclasses derivando por meio do **DbContext**.</span><span class="sxs-lookup"><span data-stu-id="7cef5-169">Create these subclasses by deriving from **DbContext**.</span></span> <span data-ttu-id="7cef5-170">Isso é onde você define o **DbSets** que implementam a coleções de saudação feito pelo banco de dados de objetos CLR para seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="7cef5-170">This is where you define your **DbSets** that implement hello database-backed collections of CLR objects for your application.</span></span> <span data-ttu-id="7cef5-171">No contexto de saudação do roteamento dependente de dados, é possível identificar várias propriedades úteis que não necessariamente mantêm para outros cenários de aplicativo EF código primeiro:</span><span class="sxs-lookup"><span data-stu-id="7cef5-171">In hello context of data dependent routing, we can identify several helpful properties that do not necessarily hold for other EF code first application scenarios:</span></span> 

* <span data-ttu-id="7cef5-172">banco de dados de saudação já existe e foi registrado no mapa de fragmento de banco de dados Elástico hello.</span><span class="sxs-lookup"><span data-stu-id="7cef5-172">hello database already exists and has been registered in hello elastic database shard map.</span></span> 
* <span data-ttu-id="7cef5-173">esquema de saudação do aplicativo hello já foi implantado toohello banco de dados (explicado abaixo).</span><span class="sxs-lookup"><span data-stu-id="7cef5-173">hello schema of hello application has already been deployed toohello database (explained below).</span></span> 
* <span data-ttu-id="7cef5-174">Dependente de dados roteamento conexões toohello banco de dados são orientadas pelo mapa do fragmento hello.</span><span class="sxs-lookup"><span data-stu-id="7cef5-174">Data-dependent routing connections toohello database are brokered by hello shard map.</span></span> 

<span data-ttu-id="7cef5-175">toointegrate **DbContexts** com roteamento dependente de dados de expansão:</span><span class="sxs-lookup"><span data-stu-id="7cef5-175">toointegrate **DbContexts** with data-dependent routing for scale-out:</span></span>

1. <span data-ttu-id="7cef5-176">Criar conexões de banco de dados físico por meio das interfaces de cliente do banco de dados Elástico saudação do Gerenciador do mapa de fragmento Olá,</span><span class="sxs-lookup"><span data-stu-id="7cef5-176">Create physical database connections through hello elastic database client interfaces of hello shard map manager,</span></span> 
2. <span data-ttu-id="7cef5-177">Encapsular conexão Olá com hello **DbContext** subclasse</span><span class="sxs-lookup"><span data-stu-id="7cef5-177">Wrap hello connection with hello **DbContext** subclass</span></span>
3. <span data-ttu-id="7cef5-178">Passar conexão Olá para baixo para Olá **DbContext** base classes tooensure todo o processamento Olá no lado do EF Olá também acontece.</span><span class="sxs-lookup"><span data-stu-id="7cef5-178">Pass hello connection down into hello **DbContext** base classes tooensure all hello processing on hello EF side happens as well.</span></span> 

<span data-ttu-id="7cef5-179">saudação de exemplo de código a seguir ilustra essa abordagem.</span><span class="sxs-lookup"><span data-stu-id="7cef5-179">hello following code example illustrates this approach.</span></span> <span data-ttu-id="7cef5-180">(Esse código também é em Olá que acompanha o projeto do Visual Studio)</span><span class="sxs-lookup"><span data-stu-id="7cef5-180">(This code is also in hello accompanying Visual Studio project)</span></span>

    public class ElasticScaleContext<T> : DbContext
    {
    public DbSet<Blog> Blogs { get; set; }
    …

        // C'tor for data dependent routing. This call will open a validated connection 
        // routed toohello proper shard by hello shard map manager. 
        // Note that hello base class c'tor call will fail for an open connection
        // if migrations need toobe done and SQL credentials are used. This is hello reason for hello 
        // separation of c'tors into hello data-dependent routing case (this c'tor) and hello internal c'tor for new shards.
        public ElasticScaleContext(ShardMap shardMap, T shardingKey, string connectionStr)
            : base(CreateDDRConnection(shardMap, shardingKey, connectionStr), 
            true /* contextOwnsConnection */)
        {
        }

        // Only static methods are allowed in calls into base class c'tors.
        private static DbConnection CreateDDRConnection(
        ShardMap shardMap, 
        T shardingKey, 
        string connectionStr)
        {
            // No initialization
            Database.SetInitializer<ElasticScaleContext<T>>(null);

            // Ask shard map toobroker a validated connection for hello given key
            SqlConnection conn = shardMap.OpenConnectionForKey<T>
                                (shardingKey, connectionStr, ConnectionOptions.Validate);
            return conn;
        }    

## <a name="main-points"></a><span data-ttu-id="7cef5-181">Principais pontos</span><span class="sxs-lookup"><span data-stu-id="7cef5-181">Main points</span></span>
* <span data-ttu-id="7cef5-182">Um novo construtor substitui o construtor padrão de saudação de subclasse de DbContext Olá</span><span class="sxs-lookup"><span data-stu-id="7cef5-182">A new constructor replaces hello default constructor in hello DbContext subclass</span></span> 
* <span data-ttu-id="7cef5-183">Olá novo construtor usa argumentos Olá que são necessários para roteamento dependente de dados por meio da biblioteca de cliente do banco de dados Elástico:</span><span class="sxs-lookup"><span data-stu-id="7cef5-183">hello new constructor takes hello arguments that are required for data dependent routing through elastic database client library:</span></span>
  
  * <span data-ttu-id="7cef5-184">tooaccess de mapa do fragmento Olá Olá interfaces de roteamento dependente de dados,</span><span class="sxs-lookup"><span data-stu-id="7cef5-184">hello shard map tooaccess hello data-dependent routing interfaces,</span></span>
  * <span data-ttu-id="7cef5-185">Olá fragmentação tooidentify chave Olá shardlet,</span><span class="sxs-lookup"><span data-stu-id="7cef5-185">hello sharding key tooidentify hello shardlet,</span></span>
  * <span data-ttu-id="7cef5-186">uma cadeia de caracteres de conexão com credenciais Olá para fragmento Olá toohello conexão, roteamento dependente de dados.</span><span class="sxs-lookup"><span data-stu-id="7cef5-186">a connection string with hello credentials for hello data-dependent routing connection toohello shard.</span></span> 
* <span data-ttu-id="7cef5-187">Construtor de classe base Olá chamada toohello leva um desvio em um método estático que executa todas as etapas de saudação necessários para roteamento dependente de dados.</span><span class="sxs-lookup"><span data-stu-id="7cef5-187">hello call toohello base class constructor takes a detour into a static method that performs all hello steps necessary for data-dependent routing.</span></span> 
  
  * <span data-ttu-id="7cef5-188">Ele usa a chamada de OpenConnectionForKey Olá das interfaces de cliente do banco de dados Elástico Olá no tooestablish de mapa de fragmento Olá uma conexão aberta.</span><span class="sxs-lookup"><span data-stu-id="7cef5-188">It uses hello OpenConnectionForKey call of hello elastic database client interfaces on hello shard map tooestablish an open connection.</span></span>
  * <span data-ttu-id="7cef5-189">mapa do fragmento Olá cria fragmento toohello do hello conexão aberta que contém o shardlet Olá para Olá recebe a chave de fragmentação.</span><span class="sxs-lookup"><span data-stu-id="7cef5-189">hello shard map creates hello open connection toohello shard that holds hello shardlet for hello given sharding key.</span></span>
  * <span data-ttu-id="7cef5-190">Essa conexão aberta é passado toohello back construtor da classe base de DbContext tooindicate essa conexão é toobe usado pelo EF em vez de deixar que o EF criar uma nova conexão automaticamente.</span><span class="sxs-lookup"><span data-stu-id="7cef5-190">This open connection is passed back toohello base class constructor of DbContext tooindicate that this connection is toobe used by EF instead of letting EF create a new connection automatically.</span></span> <span data-ttu-id="7cef5-191">Esta conexão de saudação de maneira foi marcada pelo cliente de banco de dados Elástico Olá API para que ele pode garantir a consistência em operações de gerenciamento de mapa do fragmento.</span><span class="sxs-lookup"><span data-stu-id="7cef5-191">This way hello connection has been tagged by hello elastic database client API so that it can guarantee consistency under shard map management operations.</span></span>

<span data-ttu-id="7cef5-192">Use Olá novo construtor para a subclasse DbContext em vez do construtor do saudação padrão em seu código.</span><span class="sxs-lookup"><span data-stu-id="7cef5-192">Use hello new constructor for your DbContext subclass instead of hello default constructor in your code.</span></span> <span data-ttu-id="7cef5-193">Aqui está um exemplo:</span><span class="sxs-lookup"><span data-stu-id="7cef5-193">Here is an example:</span></span> 

    // Create and save a new blog.

    Console.Write("Enter a name for a new blog: "); 
    var name = Console.ReadLine(); 

    using (var db = new ElasticScaleContext<int>( 
                            sharding.ShardMap,  
                            tenantId1,  
                            connStrBldr.ConnectionString)) 
    { 
        var blog = new Blog { Name = name }; 
        db.Blogs.Add(blog); 
        db.SaveChanges(); 

        // Display all Blogs for tenant 1 
        var query = from b in db.Blogs 
                    orderby b.Name 
                    select b; 
     … 
    }

<span data-ttu-id="7cef5-194">construtor new Olá abre o fragmento de toohello de conexão de saudação que armazena dados de saudação do shardlet Olá identificado pelo valor de saudação do **tenantid1**.</span><span class="sxs-lookup"><span data-stu-id="7cef5-194">hello new constructor opens hello connection toohello shard that holds hello data for hello shardlet identified by hello value of **tenantid1**.</span></span> <span data-ttu-id="7cef5-195">Olá código Olá **usando** bloco permanece inalterado tooaccess Olá **DbSet** para blogs usando EF no fragmento Olá para **tenantid1**.</span><span class="sxs-lookup"><span data-stu-id="7cef5-195">hello code in hello **using** block stays unchanged tooaccess hello **DbSet** for blogs using EF on hello shard for **tenantid1**.</span></span> <span data-ttu-id="7cef5-196">Isso altera a semântica para código Olá Olá usando o bloco de modo que todas as operações de banco de dados agora estão no escopo toohello um fragmento onde **tenantid1** é mantida.</span><span class="sxs-lookup"><span data-stu-id="7cef5-196">This changes semantics for hello code in hello using block such that all database operations are now scoped toohello one shard where **tenantid1** is kept.</span></span> <span data-ttu-id="7cef5-197">Por exemplo, uma consulta LINQ sobre Olá blogs **DbSet** seriam retornar apenas os blogs armazenado no fragmento de saudação atual, mas não Olá aqueles armazenados em outros fragmentos.</span><span class="sxs-lookup"><span data-stu-id="7cef5-197">For instance, a LINQ query over hello blogs **DbSet** would only return blogs stored on hello current shard, but not hello ones stored on other shards.</span></span>  

#### <a name="transient-faults-handling"></a><span data-ttu-id="7cef5-198">Tratamento de falhas transitórias</span><span class="sxs-lookup"><span data-stu-id="7cef5-198">Transient faults handling</span></span>
<span data-ttu-id="7cef5-199">Olá Microsoft Patterns & Practices equipe Olá publicado [Olá Transient Fault Handling Application Block](https://msdn.microsoft.com/library/dn440719.aspx).</span><span class="sxs-lookup"><span data-stu-id="7cef5-199">hello Microsoft Patterns & Practices team published hello [hello Transient Fault Handling Application Block](https://msdn.microsoft.com/library/dn440719.aspx).</span></span> <span data-ttu-id="7cef5-200">Olá biblioteca é usada com a biblioteca de cliente de escala elástica em combinação com o EF.</span><span class="sxs-lookup"><span data-stu-id="7cef5-200">hello library is used with elastic scale client library in combination with EF.</span></span> <span data-ttu-id="7cef5-201">No entanto, certifique-se de que qualquer exceção transitória retorna tooa local onde podemos garantir que esse construtor novo hello está sendo usado após uma falha temporária para que qualquer nova tentativa de conexão é feita usando construtores Olá que é ter ajustada.</span><span class="sxs-lookup"><span data-stu-id="7cef5-201">However, ensure that any transient exception returns tooa place where we can ensure that hello new constructor is being used after a transient fault so that any new connection attempt is made using hello constructors we have tweaked.</span></span> <span data-ttu-id="7cef5-202">Caso contrário, um toohello de conexão correta fragmento não é garantido e não há nenhuma garantia conexão Olá é mantido como alterações de mapa do fragmento toohello ocorrer.</span><span class="sxs-lookup"><span data-stu-id="7cef5-202">Otherwise, a connection toohello correct shard is not guaranteed, and there are no assurances hello connection is maintained as changes toohello shard map occur.</span></span> 

<span data-ttu-id="7cef5-203">Olá exemplo de código a seguir ilustra como uma política de repetição SQL pode ser usada em torno de saudação novo **DbContext** construtores subclasse:</span><span class="sxs-lookup"><span data-stu-id="7cef5-203">hello following code sample illustrates how a SQL retry policy can be used around hello new **DbContext** subclass constructors:</span></span> 

    SqlDatabaseUtils.SqlRetryPolicy.ExecuteAction(() => 
    { 
        using (var db = new ElasticScaleContext<int>( 
                                sharding.ShardMap,  
                                tenantId1,  
                                connStrBldr.ConnectionString)) 
            { 
                    var blog = new Blog { Name = name }; 
                    db.Blogs.Add(blog); 
                    db.SaveChanges(); 
            … 
            } 
        }); 

<span data-ttu-id="7cef5-204">**SqlDatabaseUtils.SqlRetryPolicy** Olá código acima é definido como um **SqlDatabaseTransientErrorDetectionStrategy** com uma contagem de repetição de 10 e 5 segundos tempo de espera entre as repetições.</span><span class="sxs-lookup"><span data-stu-id="7cef5-204">**SqlDatabaseUtils.SqlRetryPolicy** in hello code above is defined as a **SqlDatabaseTransientErrorDetectionStrategy** with a retry count of 10, and 5 seconds wait time between retries.</span></span> <span data-ttu-id="7cef5-205">Essa abordagem é semelhante orientação toohello EF e transações iniciadas pelo usuário (consulte [limitações com estratégias de repetição de execução (EF6 em diante)](http://msdn.microsoft.com/data/dn307226).</span><span class="sxs-lookup"><span data-stu-id="7cef5-205">This approach is similar toohello guidance for EF and user-initiated transactions (see [Limitations with Retrying Execution Strategies (EF6 onwards)](http://msdn.microsoft.com/data/dn307226).</span></span> <span data-ttu-id="7cef5-206">Duas situações exigem que o programa aplicativo hello controla Olá escopo toowhich Olá exceção transitória retorna: tooeither reabrir transação hello, ou (conforme mostrado) recriar o contexto de saudação do construtor adequada de saudação usa Olá banco de dados Elástico biblioteca de cliente.</span><span class="sxs-lookup"><span data-stu-id="7cef5-206">Both situations require that hello application program controls hello scope toowhich hello transient exception returns: tooeither reopen hello transaction, or (as shown) recreate hello context from hello proper constructor that uses hello elastic database client library.</span></span>

<span data-ttu-id="7cef5-207">Olá necessidade toocontrol onde exceções transitórias, conduza-no escopo também impede que use Olá internos Olá **SqlAzureExecutionStrategy** que acompanha o EF.</span><span class="sxs-lookup"><span data-stu-id="7cef5-207">hello need toocontrol where transient exceptions take us back in scope also precludes hello use of hello built-in **SqlAzureExecutionStrategy** that comes with EF.</span></span> <span data-ttu-id="7cef5-208">**SqlAzureExecutionStrategy** seria reabrir uma conexão, mas não use **OpenConnectionForKey** e, portanto, ignorar todas as validações de saudação que é executada como parte da saudação **OpenConnectionForKey** chamar.</span><span class="sxs-lookup"><span data-stu-id="7cef5-208">**SqlAzureExecutionStrategy** would reopen a connection but not use **OpenConnectionForKey** and therefore bypass all hello validation that is performed as part of hello **OpenConnectionForKey** call.</span></span> <span data-ttu-id="7cef5-209">Em vez disso, o exemplo de código de saudação usa internas Olá **DefaultExecutionStrategy** que também vem com EF.</span><span class="sxs-lookup"><span data-stu-id="7cef5-209">Instead, hello code sample uses hello built-in **DefaultExecutionStrategy** that also comes with EF.</span></span> <span data-ttu-id="7cef5-210">Ao contrário do muito**SqlAzureExecutionStrategy**, ele funciona corretamente em combinação com a política de repetição de saudação do tratamento de falhas transitórias.</span><span class="sxs-lookup"><span data-stu-id="7cef5-210">As opposed too**SqlAzureExecutionStrategy**, it works correctly in combination with hello retry policy from Transient Fault Handling.</span></span> <span data-ttu-id="7cef5-211">política de execução de saudação é definida no hello **ElasticScaleDbConfiguration** classe.</span><span class="sxs-lookup"><span data-stu-id="7cef5-211">hello execution policy is set in hello **ElasticScaleDbConfiguration** class.</span></span> <span data-ttu-id="7cef5-212">Observe que isso decidimos não toouse **DefaultSqlExecutionStrategy** desde que sugere toouse **SqlAzureExecutionStrategy** se ocorrerem exceções transitórias - o que poderia levar comportamento toowrong conforme discutido.</span><span class="sxs-lookup"><span data-stu-id="7cef5-212">Note that we decided not toouse **DefaultSqlExecutionStrategy** since it suggests toouse **SqlAzureExecutionStrategy** if transient exceptions occur - which would lead toowrong behavior as discussed.</span></span> <span data-ttu-id="7cef5-213">Para obter mais informações sobre políticas de repetição diferente hello e EF, consulte [resiliência de Conexão no EF](http://msdn.microsoft.com/data/dn456835.aspx).</span><span class="sxs-lookup"><span data-stu-id="7cef5-213">For more information on hello different retry policies and EF, see [Connection Resiliency in EF](http://msdn.microsoft.com/data/dn456835.aspx).</span></span>     

#### <a name="constructor-rewrites"></a><span data-ttu-id="7cef5-214">O construtor reescreve</span><span class="sxs-lookup"><span data-stu-id="7cef5-214">Constructor rewrites</span></span>
<span data-ttu-id="7cef5-215">exemplos de código acima Hello ilustram padrão Olá construtor regrava necessário para seu aplicativo, dados de pedidos toouse dependentes de roteamento com saudação do Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="7cef5-215">hello code examples above illustrate hello default constructor re-writes required for your application in order toouse  data dependent routing with hello Entity Framework.</span></span> <span data-ttu-id="7cef5-216">a tabela a seguir de saudação generaliza construtores de tooother essa abordagem.</span><span class="sxs-lookup"><span data-stu-id="7cef5-216">hello following table generalizes this approach tooother constructors.</span></span> 

| <span data-ttu-id="7cef5-217">Construtor atual</span><span class="sxs-lookup"><span data-stu-id="7cef5-217">Current Constructor</span></span> | <span data-ttu-id="7cef5-218">Construtor regravado para dados</span><span class="sxs-lookup"><span data-stu-id="7cef5-218">Rewritten Constructor for data</span></span> | <span data-ttu-id="7cef5-219">Construtor base</span><span class="sxs-lookup"><span data-stu-id="7cef5-219">Base Constructor</span></span> | <span data-ttu-id="7cef5-220">Observações</span><span class="sxs-lookup"><span data-stu-id="7cef5-220">Notes</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="7cef5-221">MyContext()</span><span class="sxs-lookup"><span data-stu-id="7cef5-221">MyContext()</span></span> |<span data-ttu-id="7cef5-222">ElasticScaleContext(ShardMap, TKey)</span><span class="sxs-lookup"><span data-stu-id="7cef5-222">ElasticScaleContext(ShardMap, TKey)</span></span> |<span data-ttu-id="7cef5-223">DbContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="7cef5-223">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="7cef5-224">conexão Olá precisa toobe uma função de mapa do fragmento hello e chave de roteamento do hello dependente de dados.</span><span class="sxs-lookup"><span data-stu-id="7cef5-224">hello connection needs toobe a function of hello shard map and hello data-dependent routing key.</span></span> <span data-ttu-id="7cef5-225">Você precisa de criação de conexão automática tooby passa por EF e em vez disso, use conexão de Olá Olá fragmento mapa toobroker.</span><span class="sxs-lookup"><span data-stu-id="7cef5-225">You need tooby-pass automatic connection creation by EF and instead use hello shard map toobroker hello connection.</span></span> |
| <span data-ttu-id="7cef5-226">MyContext(string)</span><span class="sxs-lookup"><span data-stu-id="7cef5-226">MyContext(string)</span></span> |<span data-ttu-id="7cef5-227">ElasticScaleContext(ShardMap, TKey)</span><span class="sxs-lookup"><span data-stu-id="7cef5-227">ElasticScaleContext(ShardMap, TKey)</span></span> |<span data-ttu-id="7cef5-228">DbContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="7cef5-228">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="7cef5-229">conexão de saudação é uma função de mapa do fragmento hello e chave de roteamento do hello dependente de dados.</span><span class="sxs-lookup"><span data-stu-id="7cef5-229">hello connection is a function of hello shard map and hello data-dependent routing key.</span></span> <span data-ttu-id="7cef5-230">Uma cadeia de caracteres de nome ou conexão de banco de dados fixa não funcionará conforme elas validação desviar pelo mapa do fragmento hello.</span><span class="sxs-lookup"><span data-stu-id="7cef5-230">A fixed database name or connection string will not work as they by-pass validation by hello shard map.</span></span> |
| <span data-ttu-id="7cef5-231">MyContext(DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="7cef5-231">MyContext(DbCompiledModel)</span></span> |<span data-ttu-id="7cef5-232">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="7cef5-232">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span></span> |<span data-ttu-id="7cef5-233">DbContext(DbConnection, DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="7cef5-233">DbContext(DbConnection, DbCompiledModel, bool)</span></span> |<span data-ttu-id="7cef5-234">conexão Hello serão é criada para Olá dado chave de fragmentação e mapa de fragmento com saudação do modelo fornecido.</span><span class="sxs-lookup"><span data-stu-id="7cef5-234">hello connection will get created for hello given shard map and sharding key with hello model provided.</span></span> <span data-ttu-id="7cef5-235">modelo compilado Hello será passado na toohello c'tor de base.</span><span class="sxs-lookup"><span data-stu-id="7cef5-235">hello compiled model will be passed on toohello base c’tor.</span></span> |
| <span data-ttu-id="7cef5-236">MyContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="7cef5-236">MyContext(DbConnection, bool)</span></span> |<span data-ttu-id="7cef5-237">ElasticScaleContext(ShardMap, TKey, bool)</span><span class="sxs-lookup"><span data-stu-id="7cef5-237">ElasticScaleContext(ShardMap, TKey, bool)</span></span> |<span data-ttu-id="7cef5-238">DbContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="7cef5-238">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="7cef5-239">conexão Olá precisa toobe inferido do mapa do fragmento hello e chave de saudação.</span><span class="sxs-lookup"><span data-stu-id="7cef5-239">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="7cef5-240">Ele não pode ser fornecido como uma entrada (a menos que essa entrada já estava usando o mapa do fragmento hello e a chave de saudação).</span><span class="sxs-lookup"><span data-stu-id="7cef5-240">It cannot be provided as an input (unless that input was already using hello shard map and hello key).</span></span> <span data-ttu-id="7cef5-241">Olá booliano será passada na.</span><span class="sxs-lookup"><span data-stu-id="7cef5-241">hello Boolean will be passed on.</span></span> |
| <span data-ttu-id="7cef5-242">MyContext(string, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="7cef5-242">MyContext(string, DbCompiledModel)</span></span> |<span data-ttu-id="7cef5-243">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="7cef5-243">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span></span> |<span data-ttu-id="7cef5-244">DbContext(DbConnection, DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="7cef5-244">DbContext(DbConnection, DbCompiledModel, bool)</span></span> |<span data-ttu-id="7cef5-245">conexão Olá precisa toobe inferido do mapa do fragmento hello e chave de saudação.</span><span class="sxs-lookup"><span data-stu-id="7cef5-245">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="7cef5-246">Ele não pode ser fornecido como uma entrada (a menos que essa entrada foi usando o mapa do fragmento hello e a chave de saudação).</span><span class="sxs-lookup"><span data-stu-id="7cef5-246">It cannot be provided as an input (unless that input was using hello shard map and hello key).</span></span> <span data-ttu-id="7cef5-247">modelo compilado Hello será passado na.</span><span class="sxs-lookup"><span data-stu-id="7cef5-247">hello compiled model will be passed on.</span></span> |
| <span data-ttu-id="7cef5-248">MyContext(ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="7cef5-248">MyContext(ObjectContext, bool)</span></span> |<span data-ttu-id="7cef5-249">ElasticScaleContext(ShardMap, TKey, ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="7cef5-249">ElasticScaleContext(ShardMap, TKey, ObjectContext, bool)</span></span> |<span data-ttu-id="7cef5-250">DbContext(ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="7cef5-250">DbContext(ObjectContext, bool)</span></span> |<span data-ttu-id="7cef5-251">construtor new Olá precisa tooensure qualquer conexão no hello que ObjectContext passado como entrada é redirecionados tooa conexão gerenciado pelo escala elástica.</span><span class="sxs-lookup"><span data-stu-id="7cef5-251">hello new constructor needs tooensure that any connection in hello ObjectContext passed as an input is re-routed tooa connection managed by Elastic Scale.</span></span> <span data-ttu-id="7cef5-252">Uma discussão detalhada da ObjectContexts está além do escopo deste documento hello.</span><span class="sxs-lookup"><span data-stu-id="7cef5-252">A detailed discussion of ObjectContexts is beyond hello scope of this document.</span></span> |
| <span data-ttu-id="7cef5-253">MyContext(DbConnection, DbCompiledModel,bool)</span><span class="sxs-lookup"><span data-stu-id="7cef5-253">MyContext(DbConnection, DbCompiledModel,bool)</span></span> |<span data-ttu-id="7cef5-254">ElasticScaleContext(ShardMap, TKey, DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="7cef5-254">ElasticScaleContext(ShardMap, TKey, DbCompiledModel, bool)</span></span> |<span data-ttu-id="7cef5-255">DbContext(DbConnection, DbCompiledModel, bool);</span><span class="sxs-lookup"><span data-stu-id="7cef5-255">DbContext(DbConnection, DbCompiledModel, bool);</span></span> |<span data-ttu-id="7cef5-256">conexão Olá precisa toobe inferido do mapa do fragmento hello e chave de saudação.</span><span class="sxs-lookup"><span data-stu-id="7cef5-256">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="7cef5-257">conexão de saudação não pode ser fornecido como uma entrada (a menos que essa entrada já estava usando o mapa do fragmento hello e a chave de saudação).</span><span class="sxs-lookup"><span data-stu-id="7cef5-257">hello connection cannot be provided as an input (unless that input was already using hello shard map and hello key).</span></span> <span data-ttu-id="7cef5-258">Modelo e Boolean são passadas no construtor de classe base toohello.</span><span class="sxs-lookup"><span data-stu-id="7cef5-258">Model and Boolean are passed on toohello base class constructor.</span></span> |

## <a name="shard-schema-deployment-through-ef-migrations"></a><span data-ttu-id="7cef5-259">Implantação de esquema de fragmento por meio de migrações do EF</span><span class="sxs-lookup"><span data-stu-id="7cef5-259">Shard schema deployment through EF migrations</span></span>
<span data-ttu-id="7cef5-260">Gerenciamento automático de esquema é uma conveniência fornecida pelo saudação do Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="7cef5-260">Automatic schema management is a convenience provided by hello Entity Framework.</span></span> <span data-ttu-id="7cef5-261">No contexto de saudação de aplicativos usando as ferramentas de banco de dados Elástico, queremos tooretain fragmentos de toonewly criado esse recurso tooautomatically provisionar Olá esquema quando os bancos de dados são adicionados aplicativos fragmentados toohello.</span><span class="sxs-lookup"><span data-stu-id="7cef5-261">In hello context of applications using elastic database tools, we want tooretain this capability tooautomatically provision hello schema toonewly created shards when databases are added toohello sharded application.</span></span> <span data-ttu-id="7cef5-262">caso de uso primário de saudação é tooincrease capacidade na camada de dados Olá aplicativos fragmentados usando EF.</span><span class="sxs-lookup"><span data-stu-id="7cef5-262">hello primary use case is tooincrease capacity at hello data tier for sharded applications using EF.</span></span> <span data-ttu-id="7cef5-263">Depender de recursos do EF para gerenciamento de esquema reduz o esforço de administração de banco de dados de saudação com um aplicativo fragmentado baseado no EF.</span><span class="sxs-lookup"><span data-stu-id="7cef5-263">Relying on EF’s capabilities for schema management reduces hello database administration effort with a sharded application built on EF.</span></span> 

<span data-ttu-id="7cef5-264">A implantação de esquema por meio de migrações EF funciona melhor em **conexões não abertas**.</span><span class="sxs-lookup"><span data-stu-id="7cef5-264">Schema deployment through EF migrations works best on **unopened connections**.</span></span> <span data-ttu-id="7cef5-265">Por outro lado, esse é o cenário de toohello para roteamento dependente de dados que se baseia em conexão Olá aberto fornecido pela API do cliente do banco de dados Elástico hello.</span><span class="sxs-lookup"><span data-stu-id="7cef5-265">This is in contrast toohello scenario for data dependent routing that relies on hello opened connection provided by hello elastic database client API.</span></span> <span data-ttu-id="7cef5-266">Outra diferença é o requisito de consistência Olá: ao consistência tooensure desejável para tooprotect de conexões roteamento dependente de todos os dados em relação a manipulação de mapa do fragmento simultâneas, não é um problema com o esquema inicial implantação tooa novo banco de dados que tem ainda não foi registrado no mapa do fragmento Olá e ainda não foi alocado toohold shardlets.</span><span class="sxs-lookup"><span data-stu-id="7cef5-266">Another difference is hello consistency requirement: While desirable tooensure consistency for all data-dependent routing connections tooprotect against concurrent shard map manipulation, it is not a concern with initial schema deployment tooa new database that has not yet been registered in hello shard map, and not yet been allocated toohold shardlets.</span></span> <span data-ttu-id="7cef5-267">Portanto, podemos contar com conexões de banco de dados regulares para este cenários, como roteamento de toodata dependente contrário.</span><span class="sxs-lookup"><span data-stu-id="7cef5-267">We can therefore rely on regular database connections for this scenarios, as opposed toodata-dependent routing.</span></span>  

<span data-ttu-id="7cef5-268">Isso leva tooan abordagem em que a implantação de esquema por meio de migrações EF está acoplada ao registro de saudação do novo banco de dados de saudação como um fragmento no mapa do fragmento do aplicativo hello.</span><span class="sxs-lookup"><span data-stu-id="7cef5-268">This leads tooan approach where schema deployment through EF migrations is tightly coupled with hello registration of hello new database as a shard in hello application’s shard map.</span></span> <span data-ttu-id="7cef5-269">Isso se baseia em Olá pré-requisitos a seguir:</span><span class="sxs-lookup"><span data-stu-id="7cef5-269">This relies on hello following prerequisites:</span></span> 

* <span data-ttu-id="7cef5-270">banco de dados de saudação já foi criado.</span><span class="sxs-lookup"><span data-stu-id="7cef5-270">hello database has already been created.</span></span> 
* <span data-ttu-id="7cef5-271">banco de dados de saudação está vazio - ele contém nenhum esquema de usuário e nenhum dado de usuário.</span><span class="sxs-lookup"><span data-stu-id="7cef5-271">hello database is empty - it holds no user schema and no user data.</span></span>
* <span data-ttu-id="7cef5-272">banco de dados de saudação ainda não pode ser acessado por meio de APIs de cliente de banco de dados Elástico Olá para roteamento dependente de dados.</span><span class="sxs-lookup"><span data-stu-id="7cef5-272">hello database cannot yet be accessed through hello elastic database client APIs for data-dependent routing.</span></span> 

<span data-ttu-id="7cef5-273">Com esses pré-requisitos estabelecidos, podemos criar uma expressão não aberto **SqlConnection** tookick off migrações EF para implantação de esquema.</span><span class="sxs-lookup"><span data-stu-id="7cef5-273">With these prerequisites in place, we can create a regular un-opened **SqlConnection** tookick off EF migrations for schema deployment.</span></span> <span data-ttu-id="7cef5-274">saudação de exemplo de código a seguir ilustra essa abordagem.</span><span class="sxs-lookup"><span data-stu-id="7cef5-274">hello following code sample illustrates this approach.</span></span> 

        // Enter a new shard - i.e. an empty database - toohello shard map, allocate a first tenant tooit  
        // and kick off EF intialization of hello database toodeploy schema 

        public void RegisterNewShard(string server, string database, string connStr, int key) 
        { 

            Shard shard = this.ShardMap.CreateShard(new ShardLocation(server, database)); 

            SqlConnectionStringBuilder connStrBldr = new SqlConnectionStringBuilder(connStr); 
            connStrBldr.DataSource = server; 
            connStrBldr.InitialCatalog = database; 

            // Go into a DbContext tootrigger migrations and schema deployment for hello new shard. 
            // This requires an un-opened connection. 
            using (var db = new ElasticScaleContext<int>(connStrBldr.ConnectionString)) 
            { 
                // Run a query tooengage EF migrations 
                (from b in db.Blogs 
                    select b).Count(); 
            } 

            // Register hello mapping of hello tenant toohello shard in hello shard map. 
            // After this step, data-dependent routing on hello shard map can be used 

            this.ShardMap.CreatePointMapping(key, shard); 
        } 


<span data-ttu-id="7cef5-275">Este exemplo mostra o método hello **RegisterNewShard** registra Olá fragmento no mapa do fragmento hello, implanta o esquema de saudação por meio de migrações EF e armazena um mapeamento de um fragmento de toohello chave de fragmentação.</span><span class="sxs-lookup"><span data-stu-id="7cef5-275">This sample shows hello method **RegisterNewShard** that registers hello shard in hello shard map, deploys hello schema through EF migrations, and stores a mapping of a sharding key toohello shard.</span></span> <span data-ttu-id="7cef5-276">Ele se baseia em um construtor de saudação **DbContext** subclasse (**ElasticScaleContext** no exemplo hello) que usa uma cadeia de caracteres de conexão SQL como entrada.</span><span class="sxs-lookup"><span data-stu-id="7cef5-276">It relies on a constructor of hello **DbContext** subclass (**ElasticScaleContext** in hello sample) that takes a SQL connection string as input.</span></span> <span data-ttu-id="7cef5-277">código de saudação desse construtor é direta, como Olá mostrado no exemplo a seguir:</span><span class="sxs-lookup"><span data-stu-id="7cef5-277">hello code of this constructor is straight-forward, as hello following example shows:</span></span> 

        // C'tor toodeploy schema and migrations tooa new shard 
        protected internal ElasticScaleContext(string connectionString) 
            : base(SetInitializerForConnection(connectionString)) 
        { 
        } 

        // Only static methods are allowed in calls into base class c'tors 
        private static string SetInitializerForConnection(string connnectionString) 
        { 
            // We want existence checks so that hello schema can get deployed 
            Database.SetInitializer<ElasticScaleContext<T>>( 
        new CreateDatabaseIfNotExists<ElasticScaleContext<T>>()); 

            return connnectionString; 
        } 

<span data-ttu-id="7cef5-278">Um pode ter usado a versão Olá Olá construtor herdada da classe base hello.</span><span class="sxs-lookup"><span data-stu-id="7cef5-278">One might have used hello version of hello constructor inherited from hello base class.</span></span> <span data-ttu-id="7cef5-279">Mas Olá código necessidades tooensure que Olá inicializador de padrão de EF é usado na conexão.</span><span class="sxs-lookup"><span data-stu-id="7cef5-279">But hello code needs tooensure that hello default initializer for EF is used when connecting.</span></span> <span data-ttu-id="7cef5-280">Olá, portanto, desvio curto no método estático hello antes de chamar o construtor da classe base Olá com a cadeia de caracteres de conexão de saudação.</span><span class="sxs-lookup"><span data-stu-id="7cef5-280">Hence hello short detour into hello static method before calling into hello base class constructor with hello connection string.</span></span> <span data-ttu-id="7cef5-281">Observe que deve executar o registro de saudação de fragmentos em um tooensure aplicativos diferentes de domínio ou o processo de configurações de inicializador Olá para o EF não entrem em conflito.</span><span class="sxs-lookup"><span data-stu-id="7cef5-281">Note that hello registration of shards should run in a different app domain or process tooensure that hello initializer settings for EF do not conflict.</span></span> 

## <a name="limitations"></a><span data-ttu-id="7cef5-282">Limitações</span><span class="sxs-lookup"><span data-stu-id="7cef5-282">Limitations</span></span>
<span data-ttu-id="7cef5-283">abordagens de saudação descritas neste documento envolvem algumas limitações:</span><span class="sxs-lookup"><span data-stu-id="7cef5-283">hello approaches outlined in this document entail a couple of limitations:</span></span> 

* <span data-ttu-id="7cef5-284">Aplicativos de EF que usam **LocalDb** primeiro precisa toomigrate tooa regulares do SQL Server banco de dados antes de usar a biblioteca de cliente do banco de dados Elástico.</span><span class="sxs-lookup"><span data-stu-id="7cef5-284">EF applications that use **LocalDb** first need toomigrate tooa regular SQL Server database before using elastic database client library.</span></span> <span data-ttu-id="7cef5-285">Não é possível escalar verticalmente um aplicativo por meio de fragmentação com Escala Elástica com o **LocalDb**.</span><span class="sxs-lookup"><span data-stu-id="7cef5-285">Scaling out an application through sharding with Elastic Scale is not possible with **LocalDb**.</span></span> <span data-ttu-id="7cef5-286">Observe que o desenvolvimento ainda pode usar **LocalDb**.</span><span class="sxs-lookup"><span data-stu-id="7cef5-286">Note that development can still use **LocalDb**.</span></span> 
* <span data-ttu-id="7cef5-287">Qualquer aplicativo toohello alterações que implicam em alterações de esquema de banco de dados necessário toogo por meio de migrações EF em todos os fragmentos.</span><span class="sxs-lookup"><span data-stu-id="7cef5-287">Any changes toohello application that imply database schema changes need toogo through EF migrations on all shards.</span></span> <span data-ttu-id="7cef5-288">código de exemplo Hello para este documento demonstra como toodo isso.</span><span class="sxs-lookup"><span data-stu-id="7cef5-288">hello sample code for this document does not demonstrate how toodo this.</span></span> <span data-ttu-id="7cef5-289">Considere o uso de atualização de banco de dados com um tooiterate de parâmetro ConnectionString sobre todos os fragmentos; ou extrair Olá T-SQL script para Olá pendentes migração usando o Update-Database com hello - opção de Script e aplicar os fragmentos de tooyour script hello T-SQL.</span><span class="sxs-lookup"><span data-stu-id="7cef5-289">Consider using Update-Database with a ConnectionString parameter tooiterate over all shards; or extract hello T-SQL script for hello pending migration using Update-Database with hello -Script option and apply hello T-SQL script tooyour shards.</span></span>  
* <span data-ttu-id="7cef5-290">Recebe uma solicitação, presume-se que todo o processamento do banco de dados está contida em um único fragmento conforme identificado pela chave de fragmentação Olá fornecida por solicitação hello.</span><span class="sxs-lookup"><span data-stu-id="7cef5-290">Given a request, it is assumed that all of its database processing is contained within a single shard as identified by hello sharding key provided by hello request.</span></span> <span data-ttu-id="7cef5-291">No entanto, esse pressuposto nem sempre é verdadeiro.</span><span class="sxs-lookup"><span data-stu-id="7cef5-291">However, this assumption does not always hold true.</span></span> <span data-ttu-id="7cef5-292">Por exemplo, quando não é possível toomake uma chave de fragmentação disponível.</span><span class="sxs-lookup"><span data-stu-id="7cef5-292">For example, when it is not possible toomake a sharding key available.</span></span> <span data-ttu-id="7cef5-293">tooaddress, Olá biblioteca de cliente fornece Olá **MultiShardQuery** classe que implementa uma abstração de conexão para consultas em vários fragmentos.</span><span class="sxs-lookup"><span data-stu-id="7cef5-293">tooaddress this, hello client library provides hello **MultiShardQuery** class that implements a connection abstraction for querying over several shards.</span></span> <span data-ttu-id="7cef5-294">Aprendizado Olá toouse **MultiShardQuery** em combinação com EF está além do escopo deste documento Olá</span><span class="sxs-lookup"><span data-stu-id="7cef5-294">Learning toouse hello **MultiShardQuery** in combination with EF is beyond hello scope of this document</span></span>

## <a name="conclusion"></a><span data-ttu-id="7cef5-295">Conclusão</span><span class="sxs-lookup"><span data-stu-id="7cef5-295">Conclusion</span></span>
<span data-ttu-id="7cef5-296">Etapas Olá descritas neste documento, aplicativos de EF podem usar recursos da biblioteca de cliente do banco de dados Elástico Olá para dados dependentes de roteamento pela refatoração construtores de saudação **DbContext** subclasses usadas em Olá EF aplicativo.</span><span class="sxs-lookup"><span data-stu-id="7cef5-296">Through hello steps outlined in this document, EF applications can use hello elastic database client library's capability for data dependent routing by refactoring constructors of hello **DbContext** subclasses used in hello EF application.</span></span> <span data-ttu-id="7cef5-297">Essa alteração na Olá limites necessária toothose locais onde **DbContext** classes já existem.</span><span class="sxs-lookup"><span data-stu-id="7cef5-297">This limits hello  changes required toothose places where **DbContext** classes already exist.</span></span> <span data-ttu-id="7cef5-298">Além disso, os aplicativos de EF podem continuar toobenefit de implantação automática de esquema combinando etapas Olá que invocam Olá necessário EF migrações com registro Olá dos mapeamentos no mapa do fragmento hello e novos fragmentos.</span><span class="sxs-lookup"><span data-stu-id="7cef5-298">In addition, EF applications can continue toobenefit from automatic schema deployment by combining hello steps that invoke hello necessary EF migrations with hello registration of new shards and mappings in hello shard map.</span></span> 

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-scale-use-entity-framework-applications-visual-studio/sample.png
