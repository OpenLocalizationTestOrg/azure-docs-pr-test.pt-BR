---
title: "Atualizações de aplicativo sem interrupção - Banco de dados SQL do Azure | Microsoft Docs"
description: "Saiba como usar a replicação geográfica do Banco de Dados SQL do Azure para dar suporte a atualizações online de seu aplicativo na nuvem."
services: sql-database
documentationcenter: 
author: anosov1960
manager: jhubbard
editor: monicar
ms.assetid: 58f42859-1e37-463c-a3d8-a3ca2e867148
ms.service: sql-database
ms.custom: business continuity
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 07/16/2016
ms.author: sashan
ms.openlocfilehash: 4b59c8aa3dea3e8fba692ab66420295a09210d3b
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="managing-rolling-upgrades-of-cloud-applications-using-sql-database-active-geo-replication"></a><span data-ttu-id="8243c-103">Gerenciando a rolagem de atualizações de aplicativos na nuvem usando a replicação geográfica ativa do Banco de dados SQL</span><span class="sxs-lookup"><span data-stu-id="8243c-103">Managing rolling upgrades of cloud applications using SQL Database active geo-replication</span></span>
> [!NOTE]
> <span data-ttu-id="8243c-104">A [replicação geográfica ativa](sql-database-geo-replication-overview.md) agora está disponível para todos os bancos de dados em todas as camadas.</span><span class="sxs-lookup"><span data-stu-id="8243c-104">[Active geo-replication](sql-database-geo-replication-overview.md) is now available for all databases in all tiers.</span></span>
> 

<span data-ttu-id="8243c-105">Saiba como usar a [replicação geográfica](sql-database-geo-replication-overview.md) no Banco de dados SQL para habilitar a rolagem de atualizações de seu aplicativo na nuvem.</span><span class="sxs-lookup"><span data-stu-id="8243c-105">Learn how to use [geo-replication](sql-database-geo-replication-overview.md) in SQL Database to enable rolling upgrades of your cloud application.</span></span> <span data-ttu-id="8243c-106">Como a atualização é uma operação com interrupção, ele deve fazer parte de seu design e planejamento de continuidade dos negócios.</span><span class="sxs-lookup"><span data-stu-id="8243c-106">Because upgrade is a disruptive operation, it should be part of your business continuity planning and design.</span></span> <span data-ttu-id="8243c-107">Neste artigo, examinamos dois métodos diferentes de orquestrar o processo de atualização e discutiremos os benefícios e as desvantagens de cada opção.</span><span class="sxs-lookup"><span data-stu-id="8243c-107">In this article we look at two different methods of orchestrating the upgrade process, and discuss the benefits and trade-offs of each option.</span></span> <span data-ttu-id="8243c-108">Para os fins deste artigo, usaremos um aplicativo simples que consiste em um site conectado a um banco de dados individual como sua camada de dados.</span><span class="sxs-lookup"><span data-stu-id="8243c-108">For the purposes of this article we will use a simple application that consists of a web site connected to a single database as its data tier.</span></span> <span data-ttu-id="8243c-109">Nosso objetivo é atualizar a versão 1 do aplicativo para a versão 2, sem impactos significativos na experiência do usuário final.</span><span class="sxs-lookup"><span data-stu-id="8243c-109">Our goal is to upgrade version 1 of the application to version 2 without any significant impact on the end-user experience.</span></span> 

<span data-ttu-id="8243c-110">Ao avaliar as opções de atualização, você deve considerar os seguintes fatores:</span><span class="sxs-lookup"><span data-stu-id="8243c-110">When evaluating the upgrade options you should consider the following factors:</span></span>

* <span data-ttu-id="8243c-111">Impacto na disponibilidade do aplicativo durante atualizações.</span><span class="sxs-lookup"><span data-stu-id="8243c-111">Impact on application availability during upgrades.</span></span> <span data-ttu-id="8243c-112">Por quanto tempo a função do aplicativo pode ser limitada ou degradada.</span><span class="sxs-lookup"><span data-stu-id="8243c-112">How long the application function may be limited or degraded.</span></span>
* <span data-ttu-id="8243c-113">Capacidade de reversão em caso de falha durante a atualização.</span><span class="sxs-lookup"><span data-stu-id="8243c-113">Ability to roll back in case of an upgrade failure.</span></span>
* <span data-ttu-id="8243c-114">Vulnerabilidade do aplicativo se ocorrer uma falha catastrófica não relacionada durante a atualização.</span><span class="sxs-lookup"><span data-stu-id="8243c-114">Vulnerability of the application if an unrelated catastrophic failure occurs during the upgrade.</span></span>
* <span data-ttu-id="8243c-115">Custo total em dólares.</span><span class="sxs-lookup"><span data-stu-id="8243c-115">Total dollar cost.</span></span>  <span data-ttu-id="8243c-116">Isso inclui redundância adicional e custos incrementais dos componentes temporários usados pelo processo de atualização.</span><span class="sxs-lookup"><span data-stu-id="8243c-116">This includes additional redundancy and incremental costs of the temporary components  used by the upgrade process.</span></span> 

## <a name="upgrading-applications-that-rely-on-database-backups-for-disaster-recovery"></a><span data-ttu-id="8243c-117">Atualizando aplicativos que dependem de backups de banco de dados para recuperação de desastre</span><span class="sxs-lookup"><span data-stu-id="8243c-117">Upgrading applications that rely on database backups for disaster recovery</span></span>
<span data-ttu-id="8243c-118">Se seu aplicativo depende de backups automáticos de banco de dados e usa a restauração geográfica para recuperação de desastre, ele normalmente é implantado em uma única região do Azure.</span><span class="sxs-lookup"><span data-stu-id="8243c-118">If your application relies on automatic database backups and uses geo-restore for disaster recovery, it is usually deployed to a single Azure region.</span></span> <span data-ttu-id="8243c-119">Nesse caso, o processo de atualização envolve a criação de uma implantação de backup de todos os componentes do aplicativo de backup envolvidos na atualização.</span><span class="sxs-lookup"><span data-stu-id="8243c-119">In this case the upgrade process involves creating a backup deployment of all application components involved in the upgrade.</span></span> <span data-ttu-id="8243c-120">Para minimizar a interrupção do usuário final, você utilizará o WATM (Gerenciador de Tráfego do Azure) com o perfil de failover.</span><span class="sxs-lookup"><span data-stu-id="8243c-120">To minimize the end-user disruption you will leverage Azure Traffic Manager (WATM) with the failover profile.</span></span>  <span data-ttu-id="8243c-121">O diagrama a seguir ilustra o ambiente operacional antes do processo de atualização.</span><span class="sxs-lookup"><span data-stu-id="8243c-121">The following diagram illustrates the operational environment prior to the upgrade process.</span></span> <span data-ttu-id="8243c-122">O ponto de extremidade <i>contoso-1.azurewebsites.net</i> representa um slot de produção do aplicativo que precisa ser atualizado.</span><span class="sxs-lookup"><span data-stu-id="8243c-122">The endpoint <i>contoso-1.azurewebsites.net</i> represents a production slot of the application that needs to be upgraded.</span></span> <span data-ttu-id="8243c-123">Para habilitar a capacidade de reverter a atualização, você precisará criar um slot de preparo com uma cópia totalmente sincronizada do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8243c-123">To enable the ability to roll back the upgrade, you need create a stage slot with a fully synchronized copy of the application.</span></span> <span data-ttu-id="8243c-124">As etapas a seguir são necessárias para preparar o aplicativo para a atualização:</span><span class="sxs-lookup"><span data-stu-id="8243c-124">The following steps are required to prepare the application for the upgrade:</span></span>

1. <span data-ttu-id="8243c-125">Crie um slot de preparo para a atualização.</span><span class="sxs-lookup"><span data-stu-id="8243c-125">Create a stage slot for the upgrade.</span></span> <span data-ttu-id="8243c-126">Para fazer isso, crie um banco de dados secundário (1) e implante um site da Web idêntico na mesma região do Azure.</span><span class="sxs-lookup"><span data-stu-id="8243c-126">To do that create a secondary database (1) and deploy an identical web site in the same Azure region.</span></span> <span data-ttu-id="8243c-127">Monitore o secundário para ver se o processo de propagação é concluído.</span><span class="sxs-lookup"><span data-stu-id="8243c-127">Monitor the secondary to see if the seeding process is completed.</span></span>
2. <span data-ttu-id="8243c-128">Crie um perfil de failover no WATM com <i>contoso-1.azurewebsites.net</i> como ponto de extremidade online e <i>contoso-2.azurewebsites.net</i> como offline.</span><span class="sxs-lookup"><span data-stu-id="8243c-128">Create a failover profile in WATM with <i>contoso-1.azurewebsites.net</i> as online endpoint and <i>contoso-2.azurewebsites.net</i> as offline.</span></span> 

> [!NOTE]
> <span data-ttu-id="8243c-129">Observe que as etapas de preparação não terão impacto sobre o aplicativo no slot de produção e poderão funcionar no modo de acesso completo.</span><span class="sxs-lookup"><span data-stu-id="8243c-129">Note the preparation steps will not impact the application in the production slot and it can function in full access mode.</span></span>
>  

![Configuração da Replicação Geográfica do Banco de Dados SQL.](media/sql-database-manage-application-rolling-upgrade/Option1-1.png)

<span data-ttu-id="8243c-132">Depois de concluir as etapas de preparação, o aplicativo estará pronto para a atualização real.</span><span class="sxs-lookup"><span data-stu-id="8243c-132">Once the preparation steps are completed the application is ready for the actual upgrade.</span></span> <span data-ttu-id="8243c-133">O diagrama a seguir ilustra as etapas envolvidas no processo de atualização.</span><span class="sxs-lookup"><span data-stu-id="8243c-133">The following diagram illustrates the steps involved in the upgrade process.</span></span> 

1. <span data-ttu-id="8243c-134">Defina o banco de dados primário no slot de produção para o modo somente leitura (3).</span><span class="sxs-lookup"><span data-stu-id="8243c-134">Set the primary database in the production slot to read-only mode (3).</span></span> <span data-ttu-id="8243c-135">Isso garantirá que a instância de produção do aplicativo (V1) permanecerá somente leitura durante a atualização, evitando assim divergência de dados entre as instâncias de banco de dados V1 e V2.</span><span class="sxs-lookup"><span data-stu-id="8243c-135">This will guarantee that the production instance of the application (V1) will remain read-only during the upgrade thus preventing the data divergence between the V1 and V2 database instances.</span></span>  
2. <span data-ttu-id="8243c-136">Desconecte o banco de dados secundário usando o modo de encerramento planejado (4).</span><span class="sxs-lookup"><span data-stu-id="8243c-136">Disconnect the secondary database using the planned termination mode (4).</span></span> <span data-ttu-id="8243c-137">Ele criará uma cópia independente totalmente sincronizada do banco de dados primário.</span><span class="sxs-lookup"><span data-stu-id="8243c-137">It will create a fully synchronized independent copy of the primary database.</span></span> <span data-ttu-id="8243c-138">Este banco de dados será atualizado.</span><span class="sxs-lookup"><span data-stu-id="8243c-138">This database will be upgraded.</span></span>
3. <span data-ttu-id="8243c-139">Modifique o banco de dados primário para o modo de leitura/gravação e execute o script de atualização no slot de preparo (5).</span><span class="sxs-lookup"><span data-stu-id="8243c-139">Turn the primary database to read-write mode and run the upgrade script in the stage slot  (5).</span></span>     

![Configuração da replicação geográfica do banco de dados SQL.](media/sql-database-manage-application-rolling-upgrade/Option1-2.png)

<span data-ttu-id="8243c-142">Se a atualização foi concluída com êxito, você agora está pronto para alternar os usuários finais para a cópia de preparo do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8243c-142">If the upgrade completed successfully you are now ready to switch the end users to the staged copy the application.</span></span> <span data-ttu-id="8243c-143">Agora, ele se tornará o slot de produção do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8243c-143">It will now become the production slot of the application.</span></span>  <span data-ttu-id="8243c-144">Isso envolve mais algumas etapas conforme ilustrado no diagrama a seguir.</span><span class="sxs-lookup"><span data-stu-id="8243c-144">This involves a few more steps as illustrated on the following diagram.</span></span>

1. <span data-ttu-id="8243c-145">Alterne o ponto de extremidade online no perfil do WATM para <i>contoso-2.azurewebsites.net</i>, que aponta para a versão V2 do site da Web (6).</span><span class="sxs-lookup"><span data-stu-id="8243c-145">Switch the online endpoint in the WATM profile to <i>contoso-2.azurewebsites.net</i>, which points to the V2 version of the web site (6).</span></span> <span data-ttu-id="8243c-146">Agora, ele se torna o slot de produção com o aplicativo V2 e o tráfego de usuário final é direcionado a ele.</span><span class="sxs-lookup"><span data-stu-id="8243c-146">It now becomes the production slot with the V2 application and the end-user traffic is directed to it.</span></span>  
2. <span data-ttu-id="8243c-147">Se você não precisar mais dos componentes do aplicativo V1, poderá removê-los com segurança (7).</span><span class="sxs-lookup"><span data-stu-id="8243c-147">If you no longer need the V1 application components so you can safely remove them (7).</span></span>   

![Configuração da replicação geográfica do banco de dados SQL.](media/sql-database-manage-application-rolling-upgrade/Option1-3.png)

<span data-ttu-id="8243c-150">Se o processo de atualização não for bem-sucedido, por exemplo, devido a um erro no script de atualização, o slot de preparo deverá ser considerado como comprometido.</span><span class="sxs-lookup"><span data-stu-id="8243c-150">If the upgrade process is unsuccessful, for example due to an error in the upgrade script, the stage slot should be considered compromised.</span></span> <span data-ttu-id="8243c-151">Para reverter o aplicativo para o estado de pré-atualização, você simplesmente deve reverter o aplicativo no slot de produção para acesso completo.</span><span class="sxs-lookup"><span data-stu-id="8243c-151">To roll back the application to the pre-upgrade state you simply revert the application in the production slot to full access.</span></span> <span data-ttu-id="8243c-152">As etapas envolvidas são mostradas no diagrama seguinte.</span><span class="sxs-lookup"><span data-stu-id="8243c-152">The steps involved are shown on the next diagram.</span></span>    

1. <span data-ttu-id="8243c-153">Defina a cópia do banco de dados para o modo de leitura/gravação (8).</span><span class="sxs-lookup"><span data-stu-id="8243c-153">Set the database copy to read-write mode (8).</span></span> <span data-ttu-id="8243c-154">Isso vai restaurar a funcionalidade completa do V1 no slot de produção.</span><span class="sxs-lookup"><span data-stu-id="8243c-154">This will restore the full V1 functionally in the production slot.</span></span>
2. <span data-ttu-id="8243c-155">Execute a análise da causa raiz e remova os componentes comprometidos no slot de preparo (9).</span><span class="sxs-lookup"><span data-stu-id="8243c-155">Perform the root cause analysis and remove the compromised components in the stage slot (9).</span></span> 

<span data-ttu-id="8243c-156">Neste ponto, o aplicativo é totalmente funcional e as etapas de atualização podem ser repetidas.</span><span class="sxs-lookup"><span data-stu-id="8243c-156">At this point the application is fully functional and the upgrade steps can be repeated.</span></span>

> [!NOTE]
> <span data-ttu-id="8243c-157">A reversão não requer alterações no perfil do WATM, pois ele já aponta para <i>contoso-1.azurewebsites.net</i> como o ponto de extremidade ativo.</span><span class="sxs-lookup"><span data-stu-id="8243c-157">The rollback does not require changes in WATM profile as it already points to <i>contoso-1.azurewebsites.net</i> as the active endpoint.</span></span>
> 
> 

![Configuração da replicação geográfica do banco de dados SQL.](media/sql-database-manage-application-rolling-upgrade/Option1-4.png)

<span data-ttu-id="8243c-160">A principal **vantagem** dessa opção é que você pode atualizar um aplicativo em uma única região usando um conjunto de etapas simples.</span><span class="sxs-lookup"><span data-stu-id="8243c-160">The key **advantage** of this option is that you can upgrade an application in a single region using a set of simple steps.</span></span> <span data-ttu-id="8243c-161">O custo da atualização é relativamente baixo.</span><span class="sxs-lookup"><span data-stu-id="8243c-161">The dollar cost of the upgrade is relatively low.</span></span> <span data-ttu-id="8243c-162">A principal **compensação** é que, se ocorrer uma falha catastrófica durante a atualização, a recuperação para o estado de pré-atualização envolverá reimplantação do aplicativo em uma região diferente e a restauração do banco de dados de backup usando a restauração geográfica.</span><span class="sxs-lookup"><span data-stu-id="8243c-162">The main **tradeoff** is that if a catastrophic failure occurs during the upgrade the recovery to the pre-upgrade state will involve re-deployment of the application in a different region and restoring the database from backup using geo-restore.</span></span> <span data-ttu-id="8243c-163">Esse processo resultará em um tempo de inatividade significativo.</span><span class="sxs-lookup"><span data-stu-id="8243c-163">This process will result in significant downtime.</span></span>   

## <a name="upgrading-applications-that-rely-on-database-geo-replication-for-disaster-recovery"></a><span data-ttu-id="8243c-164">Atualizando aplicativos que dependem de replicação geográfica de banco de dados para recuperação de desastre</span><span class="sxs-lookup"><span data-stu-id="8243c-164">Upgrading applications that rely on database geo-replication for disaster recovery</span></span>
<span data-ttu-id="8243c-165">Se seu aplicativo usar a replicação geográfica para continuidade dos negócios, ele será implantado em ao menos duas regiões diferentes com uma implantação ativa na região Primária e uma implantação em espera na região de Backup.</span><span class="sxs-lookup"><span data-stu-id="8243c-165">If your application leverages geo-replication for business continuity, it is deployed  to at least two different regions with an active deployment in Primary region and a standby deployment in Backup region.</span></span> <span data-ttu-id="8243c-166">Além dos fatores mencionados anteriormente, o processo de atualização deve garantir que:</span><span class="sxs-lookup"><span data-stu-id="8243c-166">In addition to the factors mentioned earlier, the upgrade process must guarantee that:</span></span>

* <span data-ttu-id="8243c-167">O aplicativo permaneça protegido contra falhas catastróficas em todos os momentos durante o processo de atualização</span><span class="sxs-lookup"><span data-stu-id="8243c-167">The application remains protected from catastrophic failures at all times during the upgrade process</span></span>
* <span data-ttu-id="8243c-168">Os componentes com redundância geográfica do aplicativo sejam atualizados em paralelo com os componentes ativos</span><span class="sxs-lookup"><span data-stu-id="8243c-168">The geo-redundant components of the application are upgraded in parallel with the active components</span></span>

<span data-ttu-id="8243c-169">Para atingir essas metas, você utilizará o WATM (Gerenciador de Tráfego do Azure) usando o perfil de failover com um ponto de extremidade ativo e três de backup.</span><span class="sxs-lookup"><span data-stu-id="8243c-169">To achieve these goals you will leverage Azure Traffic Manager (WATM) using the failover profile with one active and three backup endpoints.</span></span>  <span data-ttu-id="8243c-170">O diagrama a seguir ilustra o ambiente operacional antes do processo de atualização.</span><span class="sxs-lookup"><span data-stu-id="8243c-170">The following diagram illustrates the operational environment prior to the upgrade process.</span></span> <span data-ttu-id="8243c-171">Os sites da Web <i>contoso-1.azurewebsites.net</i> e <i>contoso-dr.azurewebsites.net</i> representam um slot de produção do aplicativo com redundância geográfica completa.</span><span class="sxs-lookup"><span data-stu-id="8243c-171">The web sites <i>contoso-1.azurewebsites.net</i> and <i>contoso-dr.azurewebsites.net</i> represent a production slot of the application with full geographic redundancy.</span></span> <span data-ttu-id="8243c-172">Para habilitar a capacidade de reverter a atualização, você precisará criar um slot de preparo com uma cópia totalmente sincronizada do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8243c-172">To enable the ability to roll back the upgrade, you need create a stage slot with a fully synchronized copy of the application.</span></span> <span data-ttu-id="8243c-173">Como você precisa garantir que o aplicativo pode se recuperar rapidamente no caso de uma falha catastrófica durante o processo de atualização, o slot de preparo também deve ter redundância geográfica.</span><span class="sxs-lookup"><span data-stu-id="8243c-173">Because you need to ensure that the application can quickly recover in case a catastrophic failure occurs during the upgrade process, the stage slot needs to be geo-redundant as well.</span></span> <span data-ttu-id="8243c-174">As etapas a seguir são necessárias para preparar o aplicativo para a atualização:</span><span class="sxs-lookup"><span data-stu-id="8243c-174">The following steps are required to prepare the application for the upgrade:</span></span>

1. <span data-ttu-id="8243c-175">Crie um slot de preparo para a atualização.</span><span class="sxs-lookup"><span data-stu-id="8243c-175">Create a stage slot for the upgrade.</span></span> <span data-ttu-id="8243c-176">Para fazer isso, crie um banco de dados secundário (1) e implante uma cópia idêntica do site da Web na mesma região do Azure.</span><span class="sxs-lookup"><span data-stu-id="8243c-176">To do that create a secondary database (1) and deploy an identical copy of the web site in the same Azure region.</span></span> <span data-ttu-id="8243c-177">Monitore o secundário para ver se o processo de propagação é concluído.</span><span class="sxs-lookup"><span data-stu-id="8243c-177">Monitor the secondary to see if the seeding process is completed.</span></span>
2. <span data-ttu-id="8243c-178">Crie um banco de dados secundário com redundância geográfica no slot de preparo ao fazer replicação geográfica do banco de dados secundário na região de backup (isso é chamado de "replicação geográfica encadeada").</span><span class="sxs-lookup"><span data-stu-id="8243c-178">Create a geo-redundant secondary database in the stage slot by geo-replicating the secondary database to the backup region (this is called "chained geo-replication").</span></span> <span data-ttu-id="8243c-179">Monitore o secundário do backup para ver se o processo de propagação é concluído (3).</span><span class="sxs-lookup"><span data-stu-id="8243c-179">Monitor the backup secondary to see if the seeding process is completed (3).</span></span>
3. <span data-ttu-id="8243c-180">Crie uma cópia em espera do site da Web na região de backup e vincule-a ao secundário com redundância geográfica (4).</span><span class="sxs-lookup"><span data-stu-id="8243c-180">Create a standby copy of the web site in the backup region and link it to the geo-redundant secondary (4).</span></span>  
4. <span data-ttu-id="8243c-181">Adicione pontos de extremidade adicionais <i>contoso-2.azurewebsites.net</i> e <i>contoso-3.azurewebsites.net</i> ao perfil de failover no WATM como pontos de extremidade offline (5).</span><span class="sxs-lookup"><span data-stu-id="8243c-181">Add the additional endpoints <i>contoso-2.azurewebsites.net</i> and <i>contoso-3.azurewebsites.net</i> to the failover profile in WATM as offline endpoints (5).</span></span> 

> [!NOTE]
> <span data-ttu-id="8243c-182">Observe que as etapas de preparação não terão impacto sobre o aplicativo no slot de produção e poderão funcionar no modo de acesso completo.</span><span class="sxs-lookup"><span data-stu-id="8243c-182">Note the preparation steps will not impact the application in the production slot and it can function in full access mode.</span></span>
> 
> 

![Configuração da replicação geográfica do banco de dados SQL.](media/sql-database-manage-application-rolling-upgrade/Option2-1.png)

<span data-ttu-id="8243c-185">Depois de concluir as etapas de preparação, o slot de preparo estará pronto para a atualização.</span><span class="sxs-lookup"><span data-stu-id="8243c-185">Once the preparation steps are completed, the stage slot is ready for the upgrade.</span></span> <span data-ttu-id="8243c-186">O diagrama a seguir ilustra as etapas de atualização.</span><span class="sxs-lookup"><span data-stu-id="8243c-186">The following diagram illustrates the upgrade steps.</span></span>

1. <span data-ttu-id="8243c-187">Defina o banco de dados primário no slot de produção para o modo somente leitura (6).</span><span class="sxs-lookup"><span data-stu-id="8243c-187">Set the primary database in the production slot to read-only mode (6).</span></span> <span data-ttu-id="8243c-188">Isso garantirá que a instância de produção do aplicativo (V1) permanecerá somente leitura durante a atualização, evitando assim divergência de dados entre as instâncias de banco de dados V1 e V2.</span><span class="sxs-lookup"><span data-stu-id="8243c-188">This will guarantee that the production instance of the application (V1) will remain read-only during the upgrade thus preventing the data divergence between the V1 and V2 database instances.</span></span>  
2. <span data-ttu-id="8243c-189">Desconecte o banco de dados secundário na mesma região usando o modo de encerramento planejado (7).</span><span class="sxs-lookup"><span data-stu-id="8243c-189">Disconnect the secondary database in the same region using the planned termination mode (7).</span></span> <span data-ttu-id="8243c-190">Ele criará uma cópia independente totalmente sincronizada do banco de dados primário, que se tornará automaticamente um primário após a finalização.</span><span class="sxs-lookup"><span data-stu-id="8243c-190">It will create a fully synchronized independent copy of the primary database, which will automatically become a primary after the termination.</span></span> <span data-ttu-id="8243c-191">Este banco de dados será atualizado.</span><span class="sxs-lookup"><span data-stu-id="8243c-191">This database will be upgraded.</span></span>
3. <span data-ttu-id="8243c-192">Modifique o banco de dados primário no slot de preparo para o modo de leitura/gravação e execute o script de atualização (8).</span><span class="sxs-lookup"><span data-stu-id="8243c-192">Turn the primary database in the stage slot to read-write mode and run the upgrade script (8).</span></span>    

![Configuração da replicação geográfica do banco de dados SQL.](media/sql-database-manage-application-rolling-upgrade/Option2-2.png)

<span data-ttu-id="8243c-195">Se a atualização foi concluída com êxito, você agora está pronto para alternar os usuários finais para a versão V2 do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8243c-195">If the upgrade completed successfully you are now ready to switch the end users to the V2 version of the application.</span></span> <span data-ttu-id="8243c-196">O diagrama a seguir ilustra as etapas envolvidas.</span><span class="sxs-lookup"><span data-stu-id="8243c-196">The following diagram illustrates the steps involved.</span></span>

1. <span data-ttu-id="8243c-197">Alterne o ponto de extremidade ativo no perfil do WATM para <i>contoso-2.azurewebsites.net</i>, que aponta para a versão V2 do site da Web (9).</span><span class="sxs-lookup"><span data-stu-id="8243c-197">Switch the active endpoint in the WATM profile to <i>contoso-2.azurewebsites.net</i>, which now points to the V2 version of the web site (9).</span></span> <span data-ttu-id="8243c-198">Agora, ele se torna um slot de produção com o aplicativo V2 e o tráfego de usuário final é direcionado a ele.</span><span class="sxs-lookup"><span data-stu-id="8243c-198">It now becomes a production slot with the V2 application and end-user traffic is directed to it.</span></span> 
2. <span data-ttu-id="8243c-199">Se você não precisar mais do aplicativo V1, poderá removê-lo com segurança (10 e 11).</span><span class="sxs-lookup"><span data-stu-id="8243c-199">If you no longer need the V1 application so you can safely remove it (10 and 11).</span></span>  

![Configuração da replicação geográfica do banco de dados SQL.](media/sql-database-manage-application-rolling-upgrade/Option2-3.png)

<span data-ttu-id="8243c-202">Se o processo de atualização não for bem-sucedido, por exemplo, devido a um erro no script de atualização, o slot de preparo deverá ser considerado como comprometido.</span><span class="sxs-lookup"><span data-stu-id="8243c-202">If the upgrade process is unsuccessful, for example due to an error in the upgrade script, the stage slot should be considered compromised.</span></span> <span data-ttu-id="8243c-203">Para reverter o aplicativo para o estado de pré-atualização, você simplesmente deve reverter o uso do aplicativo no slot de produção com acesso completo.</span><span class="sxs-lookup"><span data-stu-id="8243c-203">To roll back the application to the pre-upgrade state you simply revert to using the application in the production slot with full access.</span></span> <span data-ttu-id="8243c-204">As etapas envolvidas são mostradas no diagrama seguinte.</span><span class="sxs-lookup"><span data-stu-id="8243c-204">The steps involved are shown on the next diagram.</span></span>    

1. <span data-ttu-id="8243c-205">Defina a cópia do banco de dados primário no slot de produção para o modo de leitura/gravação (12).</span><span class="sxs-lookup"><span data-stu-id="8243c-205">Set the primary database copy in the production slot to read-write mode (12).</span></span> <span data-ttu-id="8243c-206">Isso vai restaurar a funcionalidade completa do V1 no slot de produção.</span><span class="sxs-lookup"><span data-stu-id="8243c-206">This will restore the full V1 functionally in the production slot.</span></span>
2. <span data-ttu-id="8243c-207">Execute a análise da causa raiz e remova os componentes comprometidos no slot de preparo (13 e 14).</span><span class="sxs-lookup"><span data-stu-id="8243c-207">Perform the root cause analysis and remove the compromised components in the stage slot (13 and 14).</span></span> 

<span data-ttu-id="8243c-208">Neste ponto, o aplicativo é totalmente funcional e as etapas de atualização podem ser repetidas.</span><span class="sxs-lookup"><span data-stu-id="8243c-208">At this point the application is fully functional and the upgrade steps can be repeated.</span></span>

> [!NOTE]
> <span data-ttu-id="8243c-209">A reversão não requer alterações no perfil do WATM, pois ele já aponta para <i>contoso-1.azurewebsites.net</i> como o ponto de extremidade ativo.</span><span class="sxs-lookup"><span data-stu-id="8243c-209">The rollback does not require changes in WATM profile as it already points to  <i>contoso-1.azurewebsites.net</i> as the active endpoint.</span></span>
> 
> 

![Configuração da replicação geográfica do banco de dados SQL.](media/sql-database-manage-application-rolling-upgrade/Option2-4.png)

<span data-ttu-id="8243c-212">A principal **vantagem** dessa opção é que você pode atualizar o aplicativo e sua cópia com redundância geográfica em paralelo sem comprometer a continuidade dos negócios durante a atualização.</span><span class="sxs-lookup"><span data-stu-id="8243c-212">The key **advantage** of this option is that you can upgrade both the application and its geo-redundant copy in parallel without compromising your business continuity during the upgrade.</span></span> <span data-ttu-id="8243c-213">A principal **compensação** é que ela exige redundância dupla de cada componente do aplicativo e, portanto, incorre custos mais altos.</span><span class="sxs-lookup"><span data-stu-id="8243c-213">The main **tradeoff** is that it requires double redundancy of each application component and therefore incurs higher dollar cost.</span></span> <span data-ttu-id="8243c-214">Ele também envolve um fluxo de trabalho mais complicado.</span><span class="sxs-lookup"><span data-stu-id="8243c-214">It also involves a more complicated workflow.</span></span> 

## <a name="summary"></a><span data-ttu-id="8243c-215">Resumo</span><span class="sxs-lookup"><span data-stu-id="8243c-215">Summary</span></span>
<span data-ttu-id="8243c-216">Os dois métodos de atualização descritos no artigo diferem em complexidade e custo, mas ambos focam na redução do tempo quando o usuário final está limitado às operações de somente leitura.</span><span class="sxs-lookup"><span data-stu-id="8243c-216">The two upgrade methods described in the article differ in complexity and the dollar cost but they both focus on minimizing the time when the end user is limited to read-only operations.</span></span> <span data-ttu-id="8243c-217">Esse tempo é definido diretamente pela duração do script de atualização.</span><span class="sxs-lookup"><span data-stu-id="8243c-217">That time is directly defined by the duration of the upgrade script.</span></span> <span data-ttu-id="8243c-218">Ele não depende do tamanho do banco de dados, da camada de serviço escolhida, da configuração de site da Web e de outros fatores que você não pode controlar facilmente.</span><span class="sxs-lookup"><span data-stu-id="8243c-218">It does not depend on the database size, the service tier you chose, the web site configuration and other factors that you cannot easily control.</span></span> <span data-ttu-id="8243c-219">Isso ocorre porque todas as etapas de preparação são desacopladas das etapas de atualização e podem ser feitas sem afetar o aplicativo de produção.</span><span class="sxs-lookup"><span data-stu-id="8243c-219">This is because all the preparation steps are decoupled from the upgrade steps and can be done without impacting the production application.</span></span> <span data-ttu-id="8243c-220">A eficiência do script de atualização é o principal fator que determina a experiência do usuário final durante as atualizações.</span><span class="sxs-lookup"><span data-stu-id="8243c-220">The efficiency of the upgrade script is the key factor that determines the end-user experience during upgrades.</span></span> <span data-ttu-id="8243c-221">Portanto, a melhor maneira aprimorá-la é concentrando seus esforços em tornar o script de atualização o mais eficiente possível.</span><span class="sxs-lookup"><span data-stu-id="8243c-221">So the best way you can improve it is by focusing your efforts on making the upgrade script as efficient as possible.</span></span>  

## <a name="next-steps"></a><span data-ttu-id="8243c-222">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="8243c-222">Next steps</span></span>
* <span data-ttu-id="8243c-223">Para obter uma visão geral e os cenários de continuidade dos negócios, consulte [Visão geral da continuidade dos negócios](sql-database-business-continuity.md).</span><span class="sxs-lookup"><span data-stu-id="8243c-223">For a business continuity overview and scenarios, see [Business continuity overview](sql-database-business-continuity.md).</span></span>
* <span data-ttu-id="8243c-224">Para saber mais sobre backups automatizados do Banco de Dados SQL do Azure, confira [Backups automatizados do Banco de Dados SQL](sql-database-automated-backups.md).</span><span class="sxs-lookup"><span data-stu-id="8243c-224">To learn about Azure SQL Database automated backups, see [SQL Database automated backups](sql-database-automated-backups.md).</span></span>
* <span data-ttu-id="8243c-225">Para saber mais sobre como usar backups automatizados de recuperação, confira [Restaurar um banco de dados de backups automatizados](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="8243c-225">To learn about using automated backups for recovery, see [restore a database from automated backups](sql-database-recovery-using-backups.md).</span></span>
* <span data-ttu-id="8243c-226">Para saber mais sobre opções de recuperação mais rápidas, confira [Replicação geográfica ativa](sql-database-geo-replication-overview.md).</span><span class="sxs-lookup"><span data-stu-id="8243c-226">To learn about faster recovery options, see [active geo-replication](sql-database-geo-replication-overview.md).</span></span>


