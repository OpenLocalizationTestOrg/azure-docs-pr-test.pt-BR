---
title: Mover dados entre bancos de dados na nuvem escalados horizontalmente | Microsoft Docs
description: "Explica como manipular fragmentos e mover os dados por meio de um serviço auto-hospedado usando APIs de banco de dados elástico."
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 204fd902-0397-4185-985a-dea3ed7c7d9f
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/24/2016
ms.author: ddove
ms.openlocfilehash: b41b6d6be686168359a97eb7468351a105b748db
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="moving-data-between-scaled-out-cloud-databases"></a><span data-ttu-id="9ce24-103">Mover dados entre bancos de dados na nuvem escalados horizontalmente</span><span class="sxs-lookup"><span data-stu-id="9ce24-103">Moving data between scaled-out cloud databases</span></span>
<span data-ttu-id="9ce24-104">Se você for um desenvolvedor de Software como Serviço e seu aplicativo sofrer uma imensa demanda repentinamente, será necessário acomodar o crescimento.</span><span class="sxs-lookup"><span data-stu-id="9ce24-104">If you are a Software as a Service developer, and suddenly your app undergoes tremendous demand, you need to accommodate the growth.</span></span> <span data-ttu-id="9ce24-105">Por isso você adiciona mais bancos de dados (fragmentos).</span><span class="sxs-lookup"><span data-stu-id="9ce24-105">So you add more databases (shards).</span></span> <span data-ttu-id="9ce24-106">Como você redistribui os dados para novos bancos de dados sem afetar a integridade dos dados?</span><span class="sxs-lookup"><span data-stu-id="9ce24-106">How do you redistribute the data to the new databases without disrupting the data integrity?</span></span> <span data-ttu-id="9ce24-107">Use a **ferramenta de divisão/mesclagem** para mover dados de bancos de dados restritos para novos bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="9ce24-107">Use the **split-merge tool** to move data from constrained databases to the new databases.</span></span>  

<span data-ttu-id="9ce24-108">A ferramenta de divisão/mesclagem é executada como um serviço Web do Azure.</span><span class="sxs-lookup"><span data-stu-id="9ce24-108">The split-merge tool runs as an Azure web service.</span></span> <span data-ttu-id="9ce24-109">Um administrador ou desenvolvedor usa a ferramenta para mover shardlets (dados de um fragmento) entre diferentes bancos de dados (fragmentos).</span><span class="sxs-lookup"><span data-stu-id="9ce24-109">An administrator or developer uses the tool to move shardlets (data from a shard) between different databases (shards).</span></span> <span data-ttu-id="9ce24-110">A ferramenta usa o gerenciamento de mapa de fragmentos para manter o banco de dados de metadados de serviço e garantir mapeamentos consistentes.</span><span class="sxs-lookup"><span data-stu-id="9ce24-110">The tool uses shard map management to maintain the service metadata database, and ensure consistent mappings.</span></span>

![Visão geral][1]

## <a name="download"></a><span data-ttu-id="9ce24-112">Baixar</span><span class="sxs-lookup"><span data-stu-id="9ce24-112">Download</span></span>
[<span data-ttu-id="9ce24-113">Microsoft.Azure.SqlDatabase.ElasticScale.Service.SplitMerge</span><span class="sxs-lookup"><span data-stu-id="9ce24-113">Microsoft.Azure.SqlDatabase.ElasticScale.Service.SplitMerge</span></span>](http://www.nuget.org/packages/Microsoft.Azure.SqlDatabase.ElasticScale.Service.SplitMerge/)

## <a name="documentation"></a><span data-ttu-id="9ce24-114">Documentação</span><span class="sxs-lookup"><span data-stu-id="9ce24-114">Documentation</span></span>
1. [<span data-ttu-id="9ce24-115">Tutorial de ferramenta da Divisão de Mesclagem do banco de dados elástico</span><span class="sxs-lookup"><span data-stu-id="9ce24-115">Elastic database Split-Merge tool tutorial</span></span>](sql-database-elastic-scale-configure-deploy-split-and-merge.md)
2. [<span data-ttu-id="9ce24-116">Configuração de segurança da divisão e mesclagem</span><span class="sxs-lookup"><span data-stu-id="9ce24-116">Split-Merge security configuration</span></span>](sql-database-elastic-scale-split-merge-security-configuration.md)
3. [<span data-ttu-id="9ce24-117">Considerações de segurança de divisão/mesclagem</span><span class="sxs-lookup"><span data-stu-id="9ce24-117">Split-merge security considerations</span></span>](sql-database-elastic-scale-split-merge-security-configuration.md)
4. [<span data-ttu-id="9ce24-118">Gerenciamento de mapa de fragmentos</span><span class="sxs-lookup"><span data-stu-id="9ce24-118">Shard map management</span></span>](sql-database-elastic-scale-shard-map-management.md)
5. [<span data-ttu-id="9ce24-119">Migrar bancos de dados existentes para escala horizontal</span><span class="sxs-lookup"><span data-stu-id="9ce24-119">Migrate existing databases to scale-out</span></span>](sql-database-elastic-convert-to-use-elastic-tools.md)
6. [<span data-ttu-id="9ce24-120">Ferramentas de Banco de Dados Elástico</span><span class="sxs-lookup"><span data-stu-id="9ce24-120">Elastic database tools</span></span>](sql-database-elastic-scale-introduction.md)
7. [<span data-ttu-id="9ce24-121">Glossário de ferramentas do banco de dados elástico</span><span class="sxs-lookup"><span data-stu-id="9ce24-121">Elastic Database tools glossary</span></span>](sql-database-elastic-scale-glossary.md)

## <a name="why-use-the-split-merge-tool"></a><span data-ttu-id="9ce24-122">Por que usar a ferramenta de divisão/mesclagem?</span><span class="sxs-lookup"><span data-stu-id="9ce24-122">Why use the split-merge tool?</span></span>
<span data-ttu-id="9ce24-123">**Flexibilidade**</span><span class="sxs-lookup"><span data-stu-id="9ce24-123">**Flexibility**</span></span>

<span data-ttu-id="9ce24-124">Aplicativos precisam ampliar-se com flexibilidade para além dos limites de um único banco de dados do Banco de Dados SQL do Azure.</span><span class="sxs-lookup"><span data-stu-id="9ce24-124">Applications need to stretch flexibly beyond the limits of a single Azure SQL DB database.</span></span> <span data-ttu-id="9ce24-125">Use a ferramenta para mover os dados conforme necessário para novos bancos de dados, mantendo a integridade.</span><span class="sxs-lookup"><span data-stu-id="9ce24-125">Use the tool to move data as needed to new databases while retaining integrity.</span></span>

<span data-ttu-id="9ce24-126">**Dividir para crescer**</span><span class="sxs-lookup"><span data-stu-id="9ce24-126">**Split to grow**</span></span> 

<span data-ttu-id="9ce24-127">Você precisa aumentar a capacidade geral para lidar com o crescimento explosivo.</span><span class="sxs-lookup"><span data-stu-id="9ce24-127">You need to increase overall capacity to handle explosive growth.</span></span> <span data-ttu-id="9ce24-128">Para tal, crie capacidade adicional fragmentando os dados e distribuindo-os incrementalmente em mais bancos de dados até que as necessidades de capacidade sejam atendidas.</span><span class="sxs-lookup"><span data-stu-id="9ce24-128">To do so, create additional capacity by sharding the data and by distributing it across incrementally more databases until capacity needs are fulfilled.</span></span> <span data-ttu-id="9ce24-129">Este é um exemplo perfeito do recurso “dividir”.</span><span class="sxs-lookup"><span data-stu-id="9ce24-129">This is a prime example of the ‘split’ feature.</span></span> 

<span data-ttu-id="9ce24-130">**Mesclar para reduzir**</span><span class="sxs-lookup"><span data-stu-id="9ce24-130">**Merge to shrink**</span></span>

<span data-ttu-id="9ce24-131">A capacidade precisa ser reduzida devido à natureza sazonal de um negócio.</span><span class="sxs-lookup"><span data-stu-id="9ce24-131">Capacity needs shrink due to the seasonal nature of a business.</span></span> <span data-ttu-id="9ce24-132">A ferramenta permite reduzir verticalmente para menos unidades quando o negócio desacelera.</span><span class="sxs-lookup"><span data-stu-id="9ce24-132">The tool lets you scale down to fewer scale units when business slows.</span></span> <span data-ttu-id="9ce24-133">O recurso ‘mesclar’ no Serviço de divisão/mesclagem de escala elástica aborda esse requisito.</span><span class="sxs-lookup"><span data-stu-id="9ce24-133">The ‘merge’ feature in the Elastic Scale split-merge Service covers this requirement.</span></span> 

<span data-ttu-id="9ce24-134">**Gerenciar pontos de acesso movendo shardlets**</span><span class="sxs-lookup"><span data-stu-id="9ce24-134">**Manage hotspots by moving shardlets**</span></span>

<span data-ttu-id="9ce24-135">Com vários locatários por banco de dados, a alocação de shardlets para fragmentos pode levar a afunilamentos de capacidade em alguns fragmentos.</span><span class="sxs-lookup"><span data-stu-id="9ce24-135">With multiple tenants per database, the allocation of shardlets to shards can lead to capacity bottlenecks on some shards.</span></span> <span data-ttu-id="9ce24-136">Isso exige a realocação de shardlets ou a movimentação de shardlets ocupados para fragmentos novos ou menos utilizados.</span><span class="sxs-lookup"><span data-stu-id="9ce24-136">This requires re-allocating shardlets or moving busy shardlets to new or less utilized shards.</span></span> 

## <a name="concepts--key-features"></a><span data-ttu-id="9ce24-137">Principais recursos e conceitos</span><span class="sxs-lookup"><span data-stu-id="9ce24-137">Concepts & key features</span></span>
<span data-ttu-id="9ce24-138">**Serviços hospedados no cliente**</span><span class="sxs-lookup"><span data-stu-id="9ce24-138">**Customer-hosted services**</span></span>

<span data-ttu-id="9ce24-139">A divisão/mesclagem é fornecida como um serviço hospedado no cliente.</span><span class="sxs-lookup"><span data-stu-id="9ce24-139">The split-merge is delivered as a customer-hosted service.</span></span> <span data-ttu-id="9ce24-140">Você deve implantar e hospedar o serviço na sua assinatura do Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="9ce24-140">You must deploy and host the service in your Microsoft Azure subscription.</span></span> <span data-ttu-id="9ce24-141">O pacote que você baixou do NuGet contém um modelo de configuração para concluir as informações da sua implantação específica.</span><span class="sxs-lookup"><span data-stu-id="9ce24-141">The package you download from NuGet contains a configuration template to complete with the information for your specific deployment.</span></span> <span data-ttu-id="9ce24-142">Veja o [tutorial de ﻿divisão/mesclagem](sql-database-elastic-scale-configure-deploy-split-and-merge.md) para obter mais detalhes.</span><span class="sxs-lookup"><span data-stu-id="9ce24-142">See the [split-merge tutorial](sql-database-elastic-scale-configure-deploy-split-and-merge.md) for details.</span></span> <span data-ttu-id="9ce24-143">Uma vez que o serviço é executado na sua assinatura do Azure, você pode controlar e configurar a maioria dos aspectos de segurança do serviço.</span><span class="sxs-lookup"><span data-stu-id="9ce24-143">Since the service runs in your Azure subscription, you can control and configure most security aspects of the service.</span></span> <span data-ttu-id="9ce24-144">O modelo padrão inclui as opções para configurar o SSL, autenticação de cliente baseada no certificado, criptografia para credenciais armazenadas, proteção DoS e restrições de IP.</span><span class="sxs-lookup"><span data-stu-id="9ce24-144">The default template includes the options to configure SSL, certificate-based client authentication, encryption for stored credentials, DoS guarding and IP restrictions.</span></span> <span data-ttu-id="9ce24-145">Você pode encontrar mais informações sobre os aspectos de segurança no documento de [configuração de segurança de divisão/mesclagem](sql-database-elastic-scale-split-merge-security-configuration.md)a seguir.</span><span class="sxs-lookup"><span data-stu-id="9ce24-145">You can find more information on the security aspects in the following document [split-merge security configuration](sql-database-elastic-scale-split-merge-security-configuration.md).</span></span>

<span data-ttu-id="9ce24-146">O serviço padrão implantado é executado com um operador e uma função web.</span><span class="sxs-lookup"><span data-stu-id="9ce24-146">The default deployed service runs with one worker and one web role.</span></span> <span data-ttu-id="9ce24-147">Cada um usa o tamanho da VM A1 nos Serviços de Nuvem do Azure.</span><span class="sxs-lookup"><span data-stu-id="9ce24-147">Each uses the A1 VM size in Azure Cloud Services.</span></span> <span data-ttu-id="9ce24-148">Embora não seja possível modificar essas configurações durante a implantação do pacote, eles podem ser alterados após uma implantação bem-sucedida no serviço de nuvem em execução (por meio do portal do Azure).</span><span class="sxs-lookup"><span data-stu-id="9ce24-148">While you cannot modify these settings when deploying the package, you could change them after a successful deployment in the running cloud service, (through the Azure portal).</span></span> <span data-ttu-id="9ce24-149">Observe que a função de trabalho não deve ser configurada para mais de uma única instância por motivos técnicos.</span><span class="sxs-lookup"><span data-stu-id="9ce24-149">Note that the worker role must not be configured for more than a single instance for technical reasons.</span></span> 

<span data-ttu-id="9ce24-150">**Integração de mapa de fragmentos**</span><span class="sxs-lookup"><span data-stu-id="9ce24-150">**Shard map integration**</span></span>

<span data-ttu-id="9ce24-151">O serviço de divisão/mesclagem interage com o mapa de fragmentos do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="9ce24-151">The split-merge service interacts with the shard map of the application.</span></span> <span data-ttu-id="9ce24-152">Ao usar o serviço de divisão/mesclagem para dividir ou mesclar intervalos ou para mover shardlets entre dois fragmentos, o serviço mantém automaticamente o mapa de fragmentos atualizado.</span><span class="sxs-lookup"><span data-stu-id="9ce24-152">When using the split-merge service to split or merge ranges or to move shardlets between shards, the service automatically keeps the shard map up to date.</span></span> <span data-ttu-id="9ce24-153">Para fazer isso, o serviço se conecta ao banco de dados do gerenciador de mapa do fragmento do aplicativo e mantém intervalos e mapeamentos como progresso de solicitações de divisão/mesclagem/movimentação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-153">To do so, the service connects to the shard map manager database of the application and maintains ranges and mappings as split/merge/move requests progress.</span></span> <span data-ttu-id="9ce24-154">Isso garante que o mapa de fragmentos sempre apresente uma exibição atualizada quando operações de divisão mesclagem estiverem sendo realizadas.</span><span class="sxs-lookup"><span data-stu-id="9ce24-154">This ensures that the shard map always presents an up-to-date view when split-merge operations are going on.</span></span> <span data-ttu-id="9ce24-155">Operações de divisão, mesclagem e de movimentação de shardlet são implementadas movendo um lote de shardlets do fragmento de origem para o fragmento de destino.</span><span class="sxs-lookup"><span data-stu-id="9ce24-155">Split, merge and shardlet movement operations are implemented by moving a batch of shardlets from the source shard to the target shard.</span></span> <span data-ttu-id="9ce24-156">Durante a operação de movimentação do shardlet, os shardlets sujeitos ao lote atual são marcados como offline no mapa de fragmentos e ficam indisponíveis para conexões de roteamento dependentes de dados usando a API **OpenConnectionForKey** .</span><span class="sxs-lookup"><span data-stu-id="9ce24-156">During the shardlet movement operation the shardlets subject to the current batch are marked as offline in the shard map and are unavailable for data-dependent routing connections using the **OpenConnectionForKey** API.</span></span> 

<span data-ttu-id="9ce24-157">**Conexões consistentes de shardlet**</span><span class="sxs-lookup"><span data-stu-id="9ce24-157">**Consistent shardlet connections**</span></span>

<span data-ttu-id="9ce24-158">Quando a movimentação de dados inicia para um novo lote de shardlets, quaisquer conexões de roteamento dependentes de dados fornecidas pelo mapa do fragmento, ao fragmento armazenando o shardlet são interrompidas e as conexões subsequentes das APIs de mapa do fragmento a esses shardlets são bloqueadas enquanto o movimento de dados está em andamento para evitar inconsistências.</span><span class="sxs-lookup"><span data-stu-id="9ce24-158">When data movement starts for a new batch of shardlets, any shard-map provided data-dependent routing connections to the shard storing the shardlet are killed and subsequent connections from the shard map APIs to the these shardlets are blocked while the data movement is in progress in order to avoid inconsistencies.</span></span> <span data-ttu-id="9ce24-159">Conexões com outros shardlets no mesmo fragmento também serão interrompidas, mas funcionarão de novo, imediatamente em uma nova tentativa.</span><span class="sxs-lookup"><span data-stu-id="9ce24-159">Connections to other shardlets on the same shard will also get killed, but will succeed again immediately on retry.</span></span> <span data-ttu-id="9ce24-160">Depois que o lote é movido, os shardlets são marcados novamente como online para o fragmento de destino e os dados de origem são removidos do fragmento de origem.</span><span class="sxs-lookup"><span data-stu-id="9ce24-160">Once the batch is moved, the shardlets are marked online again for the target shard and the source data is removed from the source shard.</span></span> <span data-ttu-id="9ce24-161">O serviço passa por essas etapas, a cada lote, até que todos os shardlets sejam movidos.</span><span class="sxs-lookup"><span data-stu-id="9ce24-161">The service goes through these steps for every batch until all shardlets have been moved.</span></span> <span data-ttu-id="9ce24-162">Isso levará a várias operações de interrupção de conexão ao longo da operação de divisão/mesclagem/movimentação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-162">This will lead to several connection kill operations during the course of the complete split/merge/move operation.</span></span>  

<span data-ttu-id="9ce24-163">**Gerenciando a disponibilidade de shardlets**</span><span class="sxs-lookup"><span data-stu-id="9ce24-163">**Managing shardlet availability**</span></span>

<span data-ttu-id="9ce24-164">A limitação a interrupção de conexão do lote atual de shardlets, conforme discutido acima, restringe o escopo de indisponibilidade a um lote de shardlets por vez.</span><span class="sxs-lookup"><span data-stu-id="9ce24-164">Limiting the connection killing to the current batch of shardlets as discussed above restricts the scope of unavailability to one batch of shardlets at a time.</span></span> <span data-ttu-id="9ce24-165">Isso é preferível a uma abordagem em que o fragmento completo permaneceria offline para todos os seus shardlets ao longo da operação de divisão/mesclagem.</span><span class="sxs-lookup"><span data-stu-id="9ce24-165">This is preferred over an approach where the complete shard would remain offline for all its shardlets during the course of a split or merge operation.</span></span> <span data-ttu-id="9ce24-166">O tamanho de um lote, definido como o número de shardlets distintos para mover por vez, é um parâmetro de configuração.</span><span class="sxs-lookup"><span data-stu-id="9ce24-166">The size of a batch, defined as the number of distinct shardlets to move at a time, is a configuration parameter.</span></span> <span data-ttu-id="9ce24-167">Ele pode ser definido para cada operação de divisão/mesclagem, dependendo das necessidades de desempenho e de disponibilidade do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="9ce24-167">It can be defined for each split and merge operation depending on the application’s availability and performance needs.</span></span> <span data-ttu-id="9ce24-168">Observe que o intervalo que está sendo bloqueado no mapa do fragmento pode ser maior que o tamanho de lote especificado.</span><span class="sxs-lookup"><span data-stu-id="9ce24-168">Note that the range that is being locked in the shard map may be larger than the batch size specified.</span></span> <span data-ttu-id="9ce24-169">Isso ocorre porque o serviço escolhe o tamanho do intervalo, de modo que o número real de valores de chave de fragmentação nos dados corresponda aproximadamente ao tamanho do lote.</span><span class="sxs-lookup"><span data-stu-id="9ce24-169">This is because the service picks the range size such that the actual number of sharding key values in the data approximately matches the batch size.</span></span> <span data-ttu-id="9ce24-170">É importante lembrar isso, especialmente para chaves de fragmentação escassamente preenchidas.</span><span class="sxs-lookup"><span data-stu-id="9ce24-170">This is important to remember in particular for sparsely populated sharding keys.</span></span> 

<span data-ttu-id="9ce24-171">**Armazenamento de metadados**</span><span class="sxs-lookup"><span data-stu-id="9ce24-171">**Metadata storage**</span></span>

<span data-ttu-id="9ce24-172">O serviço de divisão/mesclagem usa um banco de dados para manter seu status e registros durante o processamento da solicitação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-172">The split-merge service uses a database to maintain its status and to keep logs during request processing.</span></span> <span data-ttu-id="9ce24-173">O usuário cria este banco de dados na sua assinatura e fornece a cadeia de conexão para ele no arquivo de configuração para a implantação do serviço.</span><span class="sxs-lookup"><span data-stu-id="9ce24-173">The user creates this database in their subscription and provides the connection string for it in the configuration file for the service deployment.</span></span> <span data-ttu-id="9ce24-174">Os administradores da organização do usuário também podem se conectar a este banco de dados para examinar o andamento da solicitação e para investigar informações detalhadas sobre falhas potenciais.</span><span class="sxs-lookup"><span data-stu-id="9ce24-174">Administrators from the user’s organization can also connect to this database to review request progress and to investigate detailed information regarding potential failures.</span></span>

<span data-ttu-id="9ce24-175">**Reconhecimento de fragmentação**</span><span class="sxs-lookup"><span data-stu-id="9ce24-175">**Sharding-awareness**</span></span>

<span data-ttu-id="9ce24-176">O serviço de divisão/mesclagem faz distinção entre (1) tabelas fragmentadas, (2) tabelas de referência e (3) tabelas normais.</span><span class="sxs-lookup"><span data-stu-id="9ce24-176">The split-merge service differentiates between (1) sharded tables, (2) reference tables, and (3) normal tables.</span></span> <span data-ttu-id="9ce24-177">A semântica de uma operação de divisão/mesclagem/movimentação depende do tipo da tabela usada e é definida da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="9ce24-177">The semantics of a split/merge/move operation depend on the type of the table used and are defined as follows:</span></span> 

* <span data-ttu-id="9ce24-178">**Tabelas fragmentadas**: operações de divisão, mesclagem e movimentação movem os shardlets do fragmento de origem para o fragmento de destino.</span><span class="sxs-lookup"><span data-stu-id="9ce24-178">**Sharded tables**: Split, merge, and move operations move shardlets from source to target shard.</span></span> <span data-ttu-id="9ce24-179">Após a conclusão bem-sucedida da solicitação geral, esses shardlets não estarão mais presentes na origem.</span><span class="sxs-lookup"><span data-stu-id="9ce24-179">After successful completion of the overall request, those shardlets are no longer present on the source.</span></span> <span data-ttu-id="9ce24-180">Observe que as tabelas de destino precisam existir no fragmento de destino e não podem conter dados no intervalo de destino antes do processamento da operação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-180">Note that the target tables need to exist on the target shard and must not contain data in the target range prior to processing of the operation.</span></span> 
* <span data-ttu-id="9ce24-181">**Tabelas de referência**: em tabelas de referência, as operações de divisão, mesclagem e movimentação copiam os dados do fragmento de origem no fragmento de destino.</span><span class="sxs-lookup"><span data-stu-id="9ce24-181">**Reference tables**: For reference tables, the split, merge and move operations copy the data from the source to the target shard.</span></span> <span data-ttu-id="9ce24-182">No entanto, observe que nenhuma alteração ocorre no fragmento de destino, para uma determinada tabela, se já houver alguma linha nesta tabela, no destino.</span><span class="sxs-lookup"><span data-stu-id="9ce24-182">Note, however, that no changes occur on the target shard for a given table if any row is already present in this table on the target.</span></span> <span data-ttu-id="9ce24-183">A tabela deve estar vazia para que qualquer operação de cópia de tabela de referência seja processada.</span><span class="sxs-lookup"><span data-stu-id="9ce24-183">The table has to be empty for any reference table copy operation to get processed.</span></span>
* <span data-ttu-id="9ce24-184">**Outras tabelas**: outras tabelas podem estar presentes na origem ou no destino de uma operação de divisão/mesclagem.</span><span class="sxs-lookup"><span data-stu-id="9ce24-184">**Other Tables**: Other tables can be present on either the source or the target of a split and merge operation.</span></span> <span data-ttu-id="9ce24-185">A divisão/mesclagem ignora essas tabelas em qualquer operação de cópia ou movimentação de dados.</span><span class="sxs-lookup"><span data-stu-id="9ce24-185">The split-merge service disregards these tables for any data movement or copy operations.</span></span> <span data-ttu-id="9ce24-186">No entanto, observe que elas podem interferir com essas operações no caso de restrições.</span><span class="sxs-lookup"><span data-stu-id="9ce24-186">Note, however, that they can interfere with these operations in case of constraints.</span></span>

<span data-ttu-id="9ce24-187">As informações sobre tabelas de referência versus fragmentadas são fornecidas pelas APIs **SchemaInfo** no mapa de fragmentos.</span><span class="sxs-lookup"><span data-stu-id="9ce24-187">The information on reference vs. sharded tables is provided by the **SchemaInfo** APIs on the shard map.</span></span> <span data-ttu-id="9ce24-188">O exemplo a seguir ilustra o uso dessas APIs em um objeto de gerenciador de mapa de fragmento smm:</span><span class="sxs-lookup"><span data-stu-id="9ce24-188">The following example illustrates the use of these APIs on a given shard map manager object smm:</span></span> 

    // Create the schema annotations 
    SchemaInfo schemaInfo = new SchemaInfo(); 

    // Reference tables 
    schemaInfo.Add(new ReferenceTableInfo("dbo", "region")); 
    schemaInfo.Add(new ReferenceTableInfo("dbo", "nation")); 

    // Sharded tables 
    schemaInfo.Add(new ShardedTableInfo("dbo", "customer", "C_CUSTKEY")); 
    schemaInfo.Add(new ShardedTableInfo("dbo", "orders", "O_CUSTKEY")); 

    // Publish 
    smm.GetSchemaInfoCollection().Add(Configuration.ShardMapName, schemaInfo); 

<span data-ttu-id="9ce24-189">As tabelas “region” e “nation” são definidas como tabelas de referência e serão copiadas com operações de divisão/mesclagem/mover.</span><span class="sxs-lookup"><span data-stu-id="9ce24-189">The tables ‘region’ and ‘nation’ are defined as reference tables and will be copied with split/merge/move operations.</span></span> <span data-ttu-id="9ce24-190">Já “customer” e “order” por sua vez são definidos como tabelas fragmentadas.</span><span class="sxs-lookup"><span data-stu-id="9ce24-190">‘customer’ and ‘orders’ in turn are defined as sharded tables.</span></span> <span data-ttu-id="9ce24-191">C_CUSTKEY e O_CUSTKEY servem como chave de fragmentação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-191">C_CUSTKEY and O_CUSTKEY serve as the sharding key.</span></span> 

<span data-ttu-id="9ce24-192">**Integridade referencial**</span><span class="sxs-lookup"><span data-stu-id="9ce24-192">**Referential Integrity**</span></span>

<span data-ttu-id="9ce24-193">O serviço de ﻿divisão/mesclagem analisa as dependências entre as tabelas e usa relações FK-PK (chave estrangeira-chave primária) para preparar as operações para mover tabelas de referência e shardlets.</span><span class="sxs-lookup"><span data-stu-id="9ce24-193">The split-merge service analyzes dependencies between tables and uses foreign key-primary key relationships to stage the operations for moving reference tables and shardlets.</span></span> <span data-ttu-id="9ce24-194">Em geral, as tabelas de referência são copiadas primeiro em ordem de dependência, os shardlets são então copiados na ordem de suas dependências em cada lote.</span><span class="sxs-lookup"><span data-stu-id="9ce24-194">In general, reference tables are copied first in dependency order, then shardlets are copied in order of their dependencies within each batch.</span></span> <span data-ttu-id="9ce24-195">Isso é necessário para que as restrições FK-PK no fragmento de destino sejam respeitadas a medida que os novos dados chegam.</span><span class="sxs-lookup"><span data-stu-id="9ce24-195">This is necessary so that FK-PK constraints on the target shard are honored as the new data arrives.</span></span> 

<span data-ttu-id="9ce24-196">**Consistência de mapa de fragmentos e eventual conclusão**</span><span class="sxs-lookup"><span data-stu-id="9ce24-196">**Shard Map Consistency and Eventual Completion**</span></span>

<span data-ttu-id="9ce24-197">Na presença de falhas, o serviço de ﻿divisão/mesclagem retoma as operações após qualquer interrupção e visa conclui-las nas solicitações de andamento.</span><span class="sxs-lookup"><span data-stu-id="9ce24-197">In the presence of failures, the split-merge service resumes operations after any outage and aims to complete any in progress requests.</span></span> <span data-ttu-id="9ce24-198">No entanto, podem haver situações irrecuperáveis (ex.: quando o fragmento de destino é perdido ou comprometido e não pode ser reparado).</span><span class="sxs-lookup"><span data-stu-id="9ce24-198">However, there may be unrecoverable situations, e.g., when the target shard is lost or compromised beyond repair.</span></span> <span data-ttu-id="9ce24-199">Sob tais circunstâncias, alguns shardlets que deveriam ser movidos podem continuar a residir no fragmento de origem.</span><span class="sxs-lookup"><span data-stu-id="9ce24-199">Under those circumstances, some shardlets that were supposed to be moved may continue to reside on the source shard.</span></span> <span data-ttu-id="9ce24-200">O serviço garante que os mapeamentos de shardlet são atualizados somente depois que os dados necessários tiverem sido copiados, com êxito, no destino.</span><span class="sxs-lookup"><span data-stu-id="9ce24-200">The service ensures that shardlet mappings are only updated after the necessary data has been successfully copied to the target.</span></span> <span data-ttu-id="9ce24-201">Shardlets só são excluídos na origem depois que todos os seus dados tiverem sido copiados para o destino e os mapeamentos correspondentes atualizados com êxito.</span><span class="sxs-lookup"><span data-stu-id="9ce24-201">Shardlets are only deleted on the source once all their data has been copied to the target and the corresponding mappings have been updated successfully.</span></span> <span data-ttu-id="9ce24-202">A operação de exclusão ocorre em segundo plano quando o intervalo já está online no fragmento de destino.</span><span class="sxs-lookup"><span data-stu-id="9ce24-202">The deletion operation happens in the background while the range is already online on the target shard.</span></span> <span data-ttu-id="9ce24-203">O serviço de divisão/mesclagem sempre garante a exatidão dos mapeamentos armazenados no mapa de fragmentos.</span><span class="sxs-lookup"><span data-stu-id="9ce24-203">The split-merge service always ensures correctness of the mappings stored in the shard map.</span></span>

## <a name="the-split-merge-user-interface"></a><span data-ttu-id="9ce24-204">A interface do usuário de divisão/mesclagem</span><span class="sxs-lookup"><span data-stu-id="9ce24-204">The split-merge user interface</span></span>
<span data-ttu-id="9ce24-205">O pacote de serviço de divisão/mesclagem inclui uma função de trabalho e uma função Web.</span><span class="sxs-lookup"><span data-stu-id="9ce24-205">The split-merge service package includes a worker role and a web role.</span></span> <span data-ttu-id="9ce24-206">A função Web é usada para enviar solicitações de divisão/mesclagem de forma interativa.</span><span class="sxs-lookup"><span data-stu-id="9ce24-206">The web role is used to submit split-merge requests in an interactive way.</span></span> <span data-ttu-id="9ce24-207">Os componentes principais da interface do usuário são os seguintes:</span><span class="sxs-lookup"><span data-stu-id="9ce24-207">The main components of the user interface are as follows:</span></span>

* <span data-ttu-id="9ce24-208">Tipo de operação: o tipo de operação é um botão de opção que controla o tipo de operação executada pelo serviço para esta solicitação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-208">Operation Type: The operation type is a radio button that controls the kind of operation performed by the service for this request.</span></span> <span data-ttu-id="9ce24-209">Você pode escolher entre os cenários de divisão, mesclagem e movimentação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-209">You can choose between the split, merge and move scenarios.</span></span> <span data-ttu-id="9ce24-210">Você também pode cancelar uma operação enviada anteriormente.</span><span class="sxs-lookup"><span data-stu-id="9ce24-210">You can also cancel a previously submitted operation.</span></span> <span data-ttu-id="9ce24-211">Você pode usar divisão, mesclagem e mover solicitações para mapas de fragmento de intervalo.</span><span class="sxs-lookup"><span data-stu-id="9ce24-211">You can use split, merge and move requests for range shard maps.</span></span> <span data-ttu-id="9ce24-212">Os mapas de fragmento da lista apenas oferecem suporte para as operações de movimentação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-212">List shard maps only support move operations.</span></span>
* <span data-ttu-id="9ce24-213">Mapa de fragmentos: a próxima seção de parâmetros de solicitação abrange as informações sobre o mapa de fragmentos e banco de dados que hospeda seu mapa do fragmento.</span><span class="sxs-lookup"><span data-stu-id="9ce24-213">Shard Map: The next section of request parameters cover information about the shard map and the database hosting your shard map.</span></span> <span data-ttu-id="9ce24-214">Em particular, você precisa fornecer o nome do servidor de Banco de Dados SQL do Azure e do banco de dados que hospeda o mapa do fragmento, credenciais para se conectar ao banco de dados de mapa do fragmento e, finalmente, o nome do mapa do fragmento.</span><span class="sxs-lookup"><span data-stu-id="9ce24-214">In particular, you need to provide the name of the Azure SQL Database server and database hosting the shardmap, credentials to connect to the shard map database, and finally the name of the shard map.</span></span> <span data-ttu-id="9ce24-215">Atualmente, a operação aceita apenas um único conjunto de credenciais.</span><span class="sxs-lookup"><span data-stu-id="9ce24-215">Currently, the operation only accepts a single set of credentials.</span></span> <span data-ttu-id="9ce24-216">Essas credenciais precisam ter permissões suficientes para realizar alterações no mapa de fragmento, bem como para os dados do usuário nos fragmentos.</span><span class="sxs-lookup"><span data-stu-id="9ce24-216">These credentials need to have sufficient permissions to perform changes to the shard map as well as to the user data on the shards.</span></span>
* <span data-ttu-id="9ce24-217">Intervalo de origem (dividir e mesclar): uma operação de divisão e mesclagem processa um intervalo usando sua chave de baixa e alta.</span><span class="sxs-lookup"><span data-stu-id="9ce24-217">Source Range (split and merge): A split and merge operation processes a range using its low and high key.</span></span> <span data-ttu-id="9ce24-218">Para especificar uma operação com um valor alto de chave não associado, marque a caixa de seleção "Chave alta é max" e deixe o campo de chave com valor alto vazio.</span><span class="sxs-lookup"><span data-stu-id="9ce24-218">To specify an operation with an unbounded high key value, check the “High key is max” check box and leave the high key field empty.</span></span> <span data-ttu-id="9ce24-219">Os valores de chave do intervalo que você especificar não precisam corresponder exatamente a um mapeamento e seu limite no seu mapa de fragmento.</span><span class="sxs-lookup"><span data-stu-id="9ce24-219">The range key values that you specify do not need to precisely match a mapping and its boundaries in your shard map.</span></span> <span data-ttu-id="9ce24-220">Se você não especificar nenhum limite de intervalo em todos os serviços irá inferir o intervalo mais próximo para você automaticamente.</span><span class="sxs-lookup"><span data-stu-id="9ce24-220">If you do not specify any range boundaries at all the service will infer the closest range for you automatically.</span></span> <span data-ttu-id="9ce24-221">Você pode usar o script do PowerShell GetMappings.ps1 para recuperar os mapeamentos atuais em um determinado mapa de fragmento.</span><span class="sxs-lookup"><span data-stu-id="9ce24-221">You can use the GetMappings.ps1 PowerShell script to retrieve the current mappings in a given shard map.</span></span>
* <span data-ttu-id="9ce24-222">Comportamento de origem de divisão (divisão): para operações de divisão, defina o ponto em que você deseja dividir o intervalo de origem.</span><span class="sxs-lookup"><span data-stu-id="9ce24-222">Split Source Behavior (split): For split operations, define the point to split the source range.</span></span> <span data-ttu-id="9ce24-223">Para tanto, forneça a chave de fragmentação onde deseja que a divisão ocorra.</span><span class="sxs-lookup"><span data-stu-id="9ce24-223">You do this by providing the sharding key where you want the split to occur.</span></span> <span data-ttu-id="9ce24-224">Em seguida, use o botão de opção para definir se deseja mover a parte inferior do intervalo (exceto a chave de divisão) ou a superior (incluindo a chave de divisão).</span><span class="sxs-lookup"><span data-stu-id="9ce24-224">Use the radio button specify whether you want the lower part of the range (excluding the split key) to move, or whether you want the upper part to move (including the split key).</span></span>
* <span data-ttu-id="9ce24-225">Shardlet de origem (movimentação): operações de movimentação são diferentes de divisão ou mesclagem, pois não precisam de um intervalo para descrever a origem.</span><span class="sxs-lookup"><span data-stu-id="9ce24-225">Source Shardlet (move): Move operations are different from split or merge operations as they do not require a range to describe the source.</span></span> <span data-ttu-id="9ce24-226">Uma origem para mover é identificada simplesmente pelo valor de chave de fragmentação que pretende mover.</span><span class="sxs-lookup"><span data-stu-id="9ce24-226">A source for move is simply identified by the sharding key value that you plan to move.</span></span>
* <span data-ttu-id="9ce24-227">Fragmento de destino (divisão): uma vez fornecidas as informações da origem da operação de divisão, será necessário definir onde você deseja que os dados sejam copiados fornecendo os nomes do banco de dados e do servidor do Banco de Dados SQL do Azure e o nome do banco de dados do destino.</span><span class="sxs-lookup"><span data-stu-id="9ce24-227">Target Shard (split): Once you have provided the information on the source of your split operation, you need to define where you want the data to be copied to by providing the Azure SQL Db server and database name for the target.</span></span>
* <span data-ttu-id="9ce24-228">Intervalo de destino (mesclagem): operações de mesclagem movem shardlets para um fragmento existente.</span><span class="sxs-lookup"><span data-stu-id="9ce24-228">Target Range (merge): Merge operations move shardlets to an existing shard.</span></span> <span data-ttu-id="9ce24-229">Você identifica o fragmento existente fornecendo os limites de intervalo do intervalo existente que ao qual deseja mesclar.</span><span class="sxs-lookup"><span data-stu-id="9ce24-229">You identify the existing shard by providing the range boundaries of the existing range that you want to merge with.</span></span>
* <span data-ttu-id="9ce24-230">Tamanho do lote: o tamanho do lote controla o número de shardlets que ficarão offline por vez durante a movimentação de dados.</span><span class="sxs-lookup"><span data-stu-id="9ce24-230">Batch Size: The batch size controls the number of shardlets that will go offline at a time during the data movement.</span></span> <span data-ttu-id="9ce24-231">Isso é um valor inteiro onde for possível usar valores menores quando for sensível a períodos longos de inatividade para shardlets.</span><span class="sxs-lookup"><span data-stu-id="9ce24-231">This is an integer value where you can use smaller values when you are sensitive to long periods of downtime for shardlets.</span></span> <span data-ttu-id="9ce24-232">Valores maiores aumentarão o tempo que um determinado shardlet fica offline, mas podem melhorar o desempenho.</span><span class="sxs-lookup"><span data-stu-id="9ce24-232">Larger values will increase the time that a given shardlet is offline but may improve performance.</span></span>
* <span data-ttu-id="9ce24-233">ID da operação (Cancelamento): se houver uma operação em andamento que não é mais necessária, você pode cancelá-la fornecendo sua ID da operação neste campo.</span><span class="sxs-lookup"><span data-stu-id="9ce24-233">Operation Id (Cancel): If you have an ongoing operation that is no longer needed, you can cancel the operation by providing its operation ID in this field.</span></span> <span data-ttu-id="9ce24-234">Você pode recuperar a ID da operação da tabela de status de solicitação (consulte a seção 8.1) ou da saída do navegador da Web em que enviou a solicitação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-234">You can retrieve the operation ID from the request status table (see Section 8.1) or from the output in the web browser where you submitted the request.</span></span>

## <a name="requirements-and-limitations"></a><span data-ttu-id="9ce24-235">Requisitos e limitações</span><span class="sxs-lookup"><span data-stu-id="9ce24-235">Requirements and Limitations</span></span>
<span data-ttu-id="9ce24-236">A implementação atual do serviço de divisão/mesclagem está sujeita aos requisitos e limitações a seguir:</span><span class="sxs-lookup"><span data-stu-id="9ce24-236">The current implementation of the split-merge service is subject to the following requirements and limitations:</span></span> 

* <span data-ttu-id="9ce24-237">Os fragmentos precisam existir e estarem registrados no mapa de fragmentos para que uma operação de divisão/mesclagem possa ser executada nesses fragmentos.</span><span class="sxs-lookup"><span data-stu-id="9ce24-237">The shards need to exist and be registered in the shard map before a split-merge operation on these shards can be performed.</span></span> 
* <span data-ttu-id="9ce24-238">O serviço não cria tabelas ou quaisquer outros objetos de banco de dados automaticamente como parte de suas operações.</span><span class="sxs-lookup"><span data-stu-id="9ce24-238">The service does not create tables or any other database objects automatically as part of its operations.</span></span> <span data-ttu-id="9ce24-239">Isso significa que o esquema de todas as tabelas fragmentadas e tabelas de referência precisa existir no fragmento de destino antes de qualquer operação de divisão/mesclagem/movimentação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-239">This means that the schema for all sharded tables and reference tables need to exist on the target shard prior to any split/merge/move operation.</span></span> <span data-ttu-id="9ce24-240">Tabelas fragmentadas, em particular, devem estar vazias no intervalo onde novos shardlets devem ser adicionados por uma operação de divisão/mesclagem/movimentação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-240">Sharded tables in particular are required to be empty in the range where new shardlets are to be added by a split/merge/move operation.</span></span> <span data-ttu-id="9ce24-241">Caso contrário, a operação falhará na verificação de consistência inicial no fragmento de destino.</span><span class="sxs-lookup"><span data-stu-id="9ce24-241">Otherwise, the operation will fail the initial consistency check on the target shard.</span></span> <span data-ttu-id="9ce24-242">Observe também que os dados de referência só são copiados se a tabela de referência estiver vazia e se não houver nenhuma garantia de consistência em relação a outras operações de gravação simultâneas nas tabelas de referência.</span><span class="sxs-lookup"><span data-stu-id="9ce24-242">Also note that reference data is only copied if the reference table is empty and that there are no consistency guarantees with regard to other concurrent write operations on the reference tables.</span></span> <span data-ttu-id="9ce24-243">Recomendamos fazer o seguinte: ao executar operações de divisão/mesclagem, nenhuma outra operação de gravação deve fazer alterações nas tabelas de referência.</span><span class="sxs-lookup"><span data-stu-id="9ce24-243">We recommend this: when running split/merge operations, no other write operations make changes to the reference tables.</span></span>
* <span data-ttu-id="9ce24-244">O serviço depende da identidade de linha estabelecida por um índice exclusivo ou chave que inclui a chave de fragmentação para melhorar o desempenho e a confiabilidade de shardlets grandes.</span><span class="sxs-lookup"><span data-stu-id="9ce24-244">The service relies on row identity established by a unique index or key that includes the sharding key to improve performance and reliability for large shardlets.</span></span> <span data-ttu-id="9ce24-245">Isso permite que o serviço mova dados em uma granularidade ainda maior do que apenas fragmentando o valor chave.</span><span class="sxs-lookup"><span data-stu-id="9ce24-245">This allows the service to move data at an even finer granularity than just the sharding key value.</span></span> <span data-ttu-id="9ce24-246">Isso ajuda a reduzir a quantidade máxima de espaço de log e de bloqueios necessários durante a operação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-246">This helps to reduce the maximum amount of log space and locks that are required during the operation.</span></span> <span data-ttu-id="9ce24-247">Considere a criação de um índice exclusivo ou uma chave primária, incluindo a chave de fragmentação em uma determinada tabela, se quiser usar essa tabela com solicitações de divisão/mesclagem/movimentação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-247">Consider creating a unique index or a primary key including the sharding key on a given table if you want to use that table with split/merge/move requests.</span></span> <span data-ttu-id="9ce24-248">Por motivos de desempenho, a chave de fragmentação deve ser a coluna à esquerda na chave ou índice.</span><span class="sxs-lookup"><span data-stu-id="9ce24-248">For performance reasons, the sharding key should be the leading column in the key or the index.</span></span>
* <span data-ttu-id="9ce24-249">Durante o processamento de solicitações, alguns dados de shardlet podem estar presentes tanto no fragmento de origem quanto no de destino.</span><span class="sxs-lookup"><span data-stu-id="9ce24-249">During the course of request processing, some shardlet data may be present both on the source and the target shard.</span></span> <span data-ttu-id="9ce24-250">Isso é necessário para proteger contra falhas durante a movimentação de shardlet.</span><span class="sxs-lookup"><span data-stu-id="9ce24-250">This is necessary to protect against failures during the shardlet movement.</span></span> <span data-ttu-id="9ce24-251">A integração de divisão/mesclagem com o mapa de fragmentos garante que as conexões por meio das APIs de roteamento dependente de dados que usam o método **OpenConnectionForKey** no mapa de fragmentos não encontrem nenhum estado intermediário inconsistente.</span><span class="sxs-lookup"><span data-stu-id="9ce24-251">The integration of split-merge with the shard map ensures that connections through the data dependent routing APIs using the **OpenConnectionForKey** method on the shard map do not see any inconsistent intermediate states.</span></span> <span data-ttu-id="9ce24-252">No entanto, na conexão aos fragmentos de origem ou destino sem usar o método **OpenConnectionForKey** , estados intermediários inconsistentes podem ficar visíveis quando solicitações de divisão/mesclagem/movimentação estiverem ocorrendo.</span><span class="sxs-lookup"><span data-stu-id="9ce24-252">However, when connecting to the source or the target shards without using the **OpenConnectionForKey** method, inconsistent intermediate states might be visible when split/merge/move requests are going on.</span></span> <span data-ttu-id="9ce24-253">Essas conexões podem mostrar resultados parciais ou duplicados, dependendo do tempo ou do fragmento que subjaz à conexão.</span><span class="sxs-lookup"><span data-stu-id="9ce24-253">These connections may show partial or duplicate results depending on the timing or the shard underlying the connection.</span></span> <span data-ttu-id="9ce24-254">Atualmente, essa limitação inclui as conexões feitas por Consultas-Multi-Fragmento de Escala Elástica.</span><span class="sxs-lookup"><span data-stu-id="9ce24-254">This limitation currently includes the connections made by Elastic Scale Multi-Shard-Queries.</span></span>
* <span data-ttu-id="9ce24-255">O banco de dados de metadados para o serviço de divisão/mesclagem não deve ser compartilhado entre diferentes funções.</span><span class="sxs-lookup"><span data-stu-id="9ce24-255">The metadata database for the split-merge service must not be shared between different roles.</span></span> <span data-ttu-id="9ce24-256">Por exemplo, uma função do serviço de divisão/mesclagem executado de preparo precisa apontar para um banco de dados de metadados diferentes da função de produção.</span><span class="sxs-lookup"><span data-stu-id="9ce24-256">For example, a role of the split-merge service running in staging needs to point to a different metadata database than the production role.</span></span>

## <a name="billing"></a><span data-ttu-id="9ce24-257">Cobrança</span><span class="sxs-lookup"><span data-stu-id="9ce24-257">Billing</span></span>
<span data-ttu-id="9ce24-258">O serviço de divisão/mesclagem é executado como um serviço de nuvem em sua assinatura do Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="9ce24-258">The split-merge service runs as a cloud service in your Microsoft Azure subscription.</span></span> <span data-ttu-id="9ce24-259">Portanto, os encargos para serviços de nuvem se aplicam à sua instância do serviço.</span><span class="sxs-lookup"><span data-stu-id="9ce24-259">Therefore charges for cloud services apply to your instance of the service.</span></span> <span data-ttu-id="9ce24-260">A menos que você execute operações de divisão/mesclagem/movimentação com frequência, recomendamos que você exclua seu serviço de nuvem de divisão/mesclagem.</span><span class="sxs-lookup"><span data-stu-id="9ce24-260">Unless you frequently perform split/merge/move operations, we recommend you delete your split-merge cloud service.</span></span> <span data-ttu-id="9ce24-261">Isso reduz os custos de execução ou de instâncias de serviço de nuvem implantadas.</span><span class="sxs-lookup"><span data-stu-id="9ce24-261">That saves costs for running or deployed cloud service instances.</span></span> <span data-ttu-id="9ce24-262">Você pode implantar novamente e iniciar sua configuração prontamente executável sempre que desejar executar operações de divisão/mesclagem.</span><span class="sxs-lookup"><span data-stu-id="9ce24-262">You can re-deploy and start your readily runnable configuration whenever you need to perform split or merge operations.</span></span> 

## <a name="monitoring"></a><span data-ttu-id="9ce24-263">Monitoramento</span><span class="sxs-lookup"><span data-stu-id="9ce24-263">Monitoring</span></span>
### <a name="status-tables"></a><span data-ttu-id="9ce24-264">Tabelas de status</span><span class="sxs-lookup"><span data-stu-id="9ce24-264">Status tables</span></span>
<span data-ttu-id="9ce24-265">O Serviço de divisão/mesclagem fornece a tabela **RequestStatus** no banco de dados de armazenamento dos metadados para o monitoramento das solicitações em andamento e concluídas.</span><span class="sxs-lookup"><span data-stu-id="9ce24-265">The split-merge Service provides the **RequestStatus** table in the metadata store database for monitoring of completed and ongoing requests.</span></span> <span data-ttu-id="9ce24-266">A tabela lista uma linha para cada solicitação de divisão/mesclagem enviada para essa instância do serviço de divisão/mesclagem.</span><span class="sxs-lookup"><span data-stu-id="9ce24-266">The table lists a row for each split-merge request that has been submitted to this instance of the split-merge service.</span></span> <span data-ttu-id="9ce24-267">Ele oferece as seguintes informações para cada solicitação:</span><span class="sxs-lookup"><span data-stu-id="9ce24-267">It gives the following information for each request:</span></span>

* <span data-ttu-id="9ce24-268">**Timestamp**: a hora e a data em que a solicitação foi iniciada.</span><span class="sxs-lookup"><span data-stu-id="9ce24-268">**Timestamp**: The time and date when the request was started.</span></span>
* <span data-ttu-id="9ce24-269">**OperationId**: um GUID que identifica exclusivamente a solicitação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-269">**OperationId**: A GUID that uniquely identifies the request.</span></span> <span data-ttu-id="9ce24-270">Essa solicitação também pode ser usada para cancelar a operação enquanto ela ainda está em andamento.</span><span class="sxs-lookup"><span data-stu-id="9ce24-270">This request can also be used to cancel the operation while it is still ongoing.</span></span>
* <span data-ttu-id="9ce24-271">**Status**: o estado atual da solicitação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-271">**Status**: The current state of the request.</span></span> <span data-ttu-id="9ce24-272">Solicitações em andamento, também relaciona a fase em que a solicitação está no momento.</span><span class="sxs-lookup"><span data-stu-id="9ce24-272">For ongoing requests, it also lists the current phase in which the request is.</span></span>
* <span data-ttu-id="9ce24-273">**CancelRequest**: um sinalizador que indica se a solicitação foi cancelada.</span><span class="sxs-lookup"><span data-stu-id="9ce24-273">**CancelRequest**: A flag that indicates whether the request has been cancelled.</span></span>
* <span data-ttu-id="9ce24-274">**Progress**: uma estimativa percentual da conclusão da operação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-274">**Progress**: A percentage estimate of completion for the operation.</span></span> <span data-ttu-id="9ce24-275">Um valor de 50 indica que a operação está aproximadamente 50% concluída.</span><span class="sxs-lookup"><span data-stu-id="9ce24-275">A value of 50 indicates that the operation is approximately 50% complete.</span></span>
* <span data-ttu-id="9ce24-276">**Detalhes**: um valor XML que fornece um relatório de andamento mais detalhado.</span><span class="sxs-lookup"><span data-stu-id="9ce24-276">**Details**: An XML value that provides a more detailed progress report.</span></span> <span data-ttu-id="9ce24-277">O relatório de andamento é atualizado periodicamente a medida em que conjuntos de linhas são copiados da origem ao destino.</span><span class="sxs-lookup"><span data-stu-id="9ce24-277">The progress report is periodically updated as sets of rows are copied from source to target.</span></span> <span data-ttu-id="9ce24-278">No caso de falhas ou exceções, essa coluna também inclui informações mais detalhadas sobre a falha.</span><span class="sxs-lookup"><span data-stu-id="9ce24-278">In case of failures or exceptions, this column also includes more detailed information about the failure.</span></span>

### <a name="azure-diagnostics"></a><span data-ttu-id="9ce24-279">Diagnóstico do Azure</span><span class="sxs-lookup"><span data-stu-id="9ce24-279">Azure Diagnostics</span></span>
<span data-ttu-id="9ce24-280">O serviço de divisão/mesclagem usa o diagnóstico do Azure com base no SDK do Azure 2.5 para monitoramento e diagnóstico.</span><span class="sxs-lookup"><span data-stu-id="9ce24-280">The split-merge service uses Azure Diagnostics based on Azure SDK 2.5 for monitoring and diagnostics.</span></span> <span data-ttu-id="9ce24-281">Você controla a configuração de diagnóstico conforme explicado aqui: [Habilitando diagnóstico nos Serviços de Nuvem e Máquinas Virtuais do Azure](../cloud-services/cloud-services-dotnet-diagnostics.md).</span><span class="sxs-lookup"><span data-stu-id="9ce24-281">You control the diagnostics configuration as explained here: [Enabling Diagnostics in Azure Cloud Services and Virtual Machines](../cloud-services/cloud-services-dotnet-diagnostics.md).</span></span> <span data-ttu-id="9ce24-282">O pacote de download inclui duas configurações de diagnóstico: uma para a função web e outra para a função de trabalho.</span><span class="sxs-lookup"><span data-stu-id="9ce24-282">The download package includes two diagnostics configurations - one for the web role and one for the worker role.</span></span> <span data-ttu-id="9ce24-283">Essas configurações de diagnóstico para o serviço seguem as orientações contidas em [Noções básicas do Serviço de Nuvem no Microsoft Azure](https://code.msdn.microsoft.com/windowsazure/Cloud-Service-Fundamentals-4ca72649).</span><span class="sxs-lookup"><span data-stu-id="9ce24-283">These diagnostics configurations for the service follow the guidance from [Cloud Service Fundamentals in Microsoft Azure](https://code.msdn.microsoft.com/windowsazure/Cloud-Service-Fundamentals-4ca72649).</span></span> <span data-ttu-id="9ce24-284">Inclui as definições para registrar os Contadores de desempenho, logs do IIS, Logs de Eventos do Windows e logs de eventos do aplicativo de divisão/mesclagem.</span><span class="sxs-lookup"><span data-stu-id="9ce24-284">It includes the definitions to log Performance Counters, IIS logs, Windows Event Logs, and split-merge application event logs.</span></span> 

## <a name="deploy-diagnostics"></a><span data-ttu-id="9ce24-285">Implantar Diagnósticos</span><span class="sxs-lookup"><span data-stu-id="9ce24-285">Deploy Diagnostics</span></span>
<span data-ttu-id="9ce24-286">Para habilitar o monitoramento e diagnóstico usando a configuração de diagnóstico para as funções Web e de trabalho fornecidas pelo pacote NuGet, execute os seguintes comandos usando o Azure PowerShell:</span><span class="sxs-lookup"><span data-stu-id="9ce24-286">To enable monitoring and diagnostics using the diagnostic configuration for the web and worker roles provided by the NuGet package, run the following commands using Azure PowerShell:</span></span> 

    $storage_name = "<YourAzureStorageAccount>" 

    $key = "<YourAzureStorageAccountKey" 

    $storageContext = New-AzureStorageContext -StorageAccountName $storage_name -StorageAccountKey $key  


    $config_path = "<YourFilePath>\SplitMergeWebContent.diagnostics.xml" 

    $service_name = "<YourCloudServiceName>" 

    Set-AzureServiceDiagnosticsExtension -StorageContext $storageContext -DiagnosticsConfigurationPath $config_path -ServiceName $service_name -Slot Production -Role "SplitMergeWeb" 


    $config_path = "<YourFilePath>\SplitMergeWorkerContent.diagnostics.xml" 

    $service_name = "<YourCloudServiceName>" 

    Set-AzureServiceDiagnosticsExtension -StorageContext $storageContext -DiagnosticsConfigurationPath $config_path -ServiceName $service_name -Slot Production -Role "SplitMergeWorker" 

<span data-ttu-id="9ce24-287">Você pode encontrar mais informações sobre como configurar e implantar configurações de diagnóstico aqui: [Habilitando o diagnóstico nos Serviços de Nuvem e nas Máquinas Virtuais do Azure](../cloud-services/cloud-services-dotnet-diagnostics.md).</span><span class="sxs-lookup"><span data-stu-id="9ce24-287">You can find more information on how to configure and deploy diagnostics settings here: [Enabling Diagnostics in Azure Cloud Services and Virtual Machines](../cloud-services/cloud-services-dotnet-diagnostics.md).</span></span> 

## <a name="retrieve-diagnostics"></a><span data-ttu-id="9ce24-288">Recuperar diagnósticos</span><span class="sxs-lookup"><span data-stu-id="9ce24-288">Retrieve diagnostics</span></span>
<span data-ttu-id="9ce24-289">Você pode acessar facilmente o diagnóstico do Gerenciador de Servidores do Visual Studio na parte do Azure da árvore do Gerenciador de Servidores.</span><span class="sxs-lookup"><span data-stu-id="9ce24-289">You can easily access your diagnostics from the Visual Studio Server Explorer in the Azure part of the Server Explorer tree.</span></span> <span data-ttu-id="9ce24-290">Abra uma instância do Visual Studio e, na barra de menus, clique em Modo de exibição e em Gerenciador de Servidores.</span><span class="sxs-lookup"><span data-stu-id="9ce24-290">Open a Visual Studio instance, and in the menu bar click View, and Server Explorer.</span></span> <span data-ttu-id="9ce24-291">Clique no ícone do Azure para conectar-se à sua assinatura do Azure.</span><span class="sxs-lookup"><span data-stu-id="9ce24-291">Click the Azure icon to connect to your Azure subscription.</span></span> <span data-ttu-id="9ce24-292">Em seguida, navegue para Azure -> Armazenamento -> <your storage account> -> Tabelas -> WADLogsTable.</span><span class="sxs-lookup"><span data-stu-id="9ce24-292">Then navigate to Azure -> Storage -> <your storage account> -> Tables -> WADLogsTable.</span></span> <span data-ttu-id="9ce24-293">Para saber mais, veja [Procurando recursos de armazenamento com o Gerenciador de Servidores](http://msdn.microsoft.com/library/azure/ff683677.aspx).</span><span class="sxs-lookup"><span data-stu-id="9ce24-293">For more information, see [Browsing Storage Resources with Server Explorer](http://msdn.microsoft.com/library/azure/ff683677.aspx).</span></span> 

![WADLogsTable][2]

<span data-ttu-id="9ce24-295">O WADLogsTable destacado na figura acima contém os eventos detalhados do log de aplicativo do serviço de divisão/mesclagem.</span><span class="sxs-lookup"><span data-stu-id="9ce24-295">The WADLogsTable highlighted in the figure above contains the detailed events from the split-merge service’s application log.</span></span> <span data-ttu-id="9ce24-296">Observe que a configuração padrão do pacote baixado destina-se a uma implantação de produção.</span><span class="sxs-lookup"><span data-stu-id="9ce24-296">Note that the default configuration of the downloaded package is geared towards a production deployment.</span></span> <span data-ttu-id="9ce24-297">Por isso, o intervalo em que contadores e logs são extraídos das instâncias de serviço é grande (5 minutos).</span><span class="sxs-lookup"><span data-stu-id="9ce24-297">Therefore the interval at which logs and counters are pulled from the service instances is large (5 minutes).</span></span> <span data-ttu-id="9ce24-298">Para teste e desenvolvimento, você pode diminuir o intervalo, ajustando as configurações de diagnóstico da função Web ou de trabalho, de acordo com as suas necessidades.</span><span class="sxs-lookup"><span data-stu-id="9ce24-298">For test and development, lower the interval by adjusting the diagnostics settings of the web or the worker role to your needs.</span></span> <span data-ttu-id="9ce24-299">Você pode fazer isso clicando com o botão direito na função no Gerenciador de Servidores do Visual Studio (veja acima) e, em seguida, ajustando o Período de Transferência na caixa de diálogo de configuração do Diagnóstico:</span><span class="sxs-lookup"><span data-stu-id="9ce24-299">Right-click on the role in the Visual Studio Server Explorer (see above) and then adjust the Transfer Period in the dialog for the Diagnostics configuration settings:</span></span> 

![Configuração][3]

## <a name="performance"></a><span data-ttu-id="9ce24-301">Desempenho</span><span class="sxs-lookup"><span data-stu-id="9ce24-301">Performance</span></span>
<span data-ttu-id="9ce24-302">Em geral, é esperado um melhor desempenho das camadas de serviço maiores e mais funcionais no Banco de dados SQL do Azure.</span><span class="sxs-lookup"><span data-stu-id="9ce24-302">In general, better performance is to be expected from the higher, more performant service tiers in Azure SQL Database.</span></span> <span data-ttu-id="9ce24-303">Alocações de E/S, CPU e memória maiores para camadas de serviço mais altas beneficiarão a cópia em massa e excluirão operações que o serviço de divisão/mesclagem usa internamente.</span><span class="sxs-lookup"><span data-stu-id="9ce24-303">Higher IO, CPU and memory allocations for the higher service tiers benefit the bulk copy and delete operations that the split-merge service uses.</span></span> <span data-ttu-id="9ce24-304">Por esse motivo, aumente a camada de serviço apenas para os bancos de dados por um período definido e limitado.</span><span class="sxs-lookup"><span data-stu-id="9ce24-304">For that reason, increase the service tier just for those databases for a defined, limited period of time.</span></span>

<span data-ttu-id="9ce24-305">O serviço também executa consultas de validação como parte de suas operações normais.</span><span class="sxs-lookup"><span data-stu-id="9ce24-305">The service also performs validation queries as part of its normal operations.</span></span> <span data-ttu-id="9ce24-306">Essas consultas de validação verificam a presença inesperada de dados no intervalo de destino e garantem que qualquer operação de divisão/mesclagem/movimentação comecem de um estado consistente.</span><span class="sxs-lookup"><span data-stu-id="9ce24-306">These validation queries check for unexpected presence of data in the target range and ensure that any split/merge/move operation starts from a consistent state.</span></span> <span data-ttu-id="9ce24-307">Todas essas consultas funcionam em intervalos de chave de fragmentação definidos pelo escopo da operação e o tamanho do lote fornecido como parte da definição de solicitação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-307">These queries all work over sharding key ranges defined by the scope of the operation and the batch size provided as part of the request definition.</span></span> <span data-ttu-id="9ce24-308">Essas consultas têm melhor desempenho quando um índice é apresentado com a chave de fragmentação como coluna à esquerda.</span><span class="sxs-lookup"><span data-stu-id="9ce24-308">These queries perform best when an index is present that has the sharding key as the leading column.</span></span> 

<span data-ttu-id="9ce24-309">Além disso, uma propriedade de exclusividade com a chave de fragmentação como a coluna principal permitirá que o serviço use uma abordagem otimizada, que limita o consumo de recursos em termos de memória e de espaço de log.</span><span class="sxs-lookup"><span data-stu-id="9ce24-309">In addition, a uniqueness property with the sharding key as the leading column will allow the service to use an optimized approach that limits resource consumption in terms of log space and memory.</span></span> <span data-ttu-id="9ce24-310">Essa propriedade de exclusividade é necessária para mover os tamanhos de dados grandes (normalmente acima de 1GB).</span><span class="sxs-lookup"><span data-stu-id="9ce24-310">This uniqueness property is required to move large data sizes (typically above 1GB).</span></span> 

## <a name="how-to-upgrade"></a><span data-ttu-id="9ce24-311">Como atualizar</span><span class="sxs-lookup"><span data-stu-id="9ce24-311">How to upgrade</span></span>
1. <span data-ttu-id="9ce24-312">Siga as etapas em [Implantar um serviço de divisão/mesclagem](sql-database-elastic-scale-configure-deploy-split-and-merge.md).</span><span class="sxs-lookup"><span data-stu-id="9ce24-312">Follow the steps in [Deploy a split-merge service](sql-database-elastic-scale-configure-deploy-split-and-merge.md).</span></span>
2. <span data-ttu-id="9ce24-313">Altere o arquivo de configuração do serviço de nuvem para sua implantação de divisão/mesclagem refletir os novos parâmetros de configuração.</span><span class="sxs-lookup"><span data-stu-id="9ce24-313">Change your cloud service configuration file for your split-merge deployment to reflect the new configuration parameters.</span></span> <span data-ttu-id="9ce24-314">Um novo parâmetro obrigatório são as informações sobre o certificado usado para criptografia.</span><span class="sxs-lookup"><span data-stu-id="9ce24-314">A new required parameter is the information about the certificate used for encryption.</span></span> <span data-ttu-id="9ce24-315">Uma maneira fácil de fazer isso é comparar o novo arquivo de modelo de configuração do download em relação a sua configuração existente.</span><span class="sxs-lookup"><span data-stu-id="9ce24-315">An easy way to do this is to compare the new configuration template file from the download against your existing configuration.</span></span> <span data-ttu-id="9ce24-316">Certifique-se de que adicionar as configurações para "DataEncryptionPrimaryCertificateThumbprint" e "DataEncryptionPrimary" para a função de trabalho e da web.</span><span class="sxs-lookup"><span data-stu-id="9ce24-316">Make sure you add the settings for “DataEncryptionPrimaryCertificateThumbprint” and “DataEncryptionPrimary” for both the web and the worker role.</span></span>
3. <span data-ttu-id="9ce24-317">Antes de implantar a atualização para o Azure, certifique-se de que todas as operações de divisão/mesclagem em execução no momento terminaram.</span><span class="sxs-lookup"><span data-stu-id="9ce24-317">Before deploying the update to Azure, ensure that all currently running split-merge operations have finished.</span></span> <span data-ttu-id="9ce24-318">Você pode fazer isso facilmente consultando as tabelas RequestStatus e PendingWorkflows no banco de dados de metadados de divisão/mesclagem para as solicitações em andamento.</span><span class="sxs-lookup"><span data-stu-id="9ce24-318">You can easily do this by querying the RequestStatus and PendingWorkflows tables in the split-merge metadata database for ongoing requests.</span></span>
4. <span data-ttu-id="9ce24-319">Atualize sua implantação de serviço de nuvem existente para divisão/mesclagem na sua assinatura do Azure com o novo pacote e o seu arquivo de configuração de serviço atualizado.</span><span class="sxs-lookup"><span data-stu-id="9ce24-319">Update your existing cloud service deployment for split-merge in your Azure subscription with the new package and your updated service configuration file.</span></span>

<span data-ttu-id="9ce24-320">Você não precisa provisionar um novo banco de dados de metadados para atualizar a divisão/mesclagem.</span><span class="sxs-lookup"><span data-stu-id="9ce24-320">You do not need to provision a new metadata database for split-merge to upgrade.</span></span> <span data-ttu-id="9ce24-321">A nova versão irá atualizar automaticamente seu banco de dados de metadados existentes para a nova versão.</span><span class="sxs-lookup"><span data-stu-id="9ce24-321">The new version will automatically upgrade your existing metadata database to the new version.</span></span> 

## <a name="best-practices--troubleshooting"></a><span data-ttu-id="9ce24-322">Práticas recomendadas e solução de problemas</span><span class="sxs-lookup"><span data-stu-id="9ce24-322">Best practices & troubleshooting</span></span>
* <span data-ttu-id="9ce24-323">Defina um locatário de teste e exercite suas operações mais importantes de divisão/mesclagem/movimentação com o locatário de teste ao longo de vários fragmentos.</span><span class="sxs-lookup"><span data-stu-id="9ce24-323">Define a test tenant and exercise your most important split/merge/move operations with the test tenant across several shards.</span></span> <span data-ttu-id="9ce24-324">Isso ajudará a garantir que todos os metadados sejam definidos corretamente no seu mapa de fragmentos e que as operações não violem restrições ou chaves estrangeiras.</span><span class="sxs-lookup"><span data-stu-id="9ce24-324">Ensure that all metadata is defined correctly in your shard map and that the operations do not violate constraints or foreign keys.</span></span>
* <span data-ttu-id="9ce24-325">Mantenha o tamanho dos dados de locatário de teste acima do tamanho máximo de dados do seu maior locatário para garantir que você não encontrará problemas relacionados ao tamanho dos dados.</span><span class="sxs-lookup"><span data-stu-id="9ce24-325">Keep the test tenant data size above the maximum data size of your largest tenant to ensure you are not encountering data size related issues.</span></span> <span data-ttu-id="9ce24-326">Isso também ajudará a avaliar um limite superior no tempo que leva para mover um único locatário.</span><span class="sxs-lookup"><span data-stu-id="9ce24-326">This helps you assess an upper bound on the time it takes to move a single tenant around.</span></span> 
* <span data-ttu-id="9ce24-327">Certifique-se de que seu esquema permita exclusões.</span><span class="sxs-lookup"><span data-stu-id="9ce24-327">Make sure that your schema allows deletions.</span></span> <span data-ttu-id="9ce24-328">O serviço de divisão/mesclagem requer a capacidade de remover dados de fragmento de origem depois que os dados tiverem sido copiados com êxito para o destino.</span><span class="sxs-lookup"><span data-stu-id="9ce24-328">The split-merge service requires the ability to remove data from the source shard once the data has been successfully copied to the target.</span></span> <span data-ttu-id="9ce24-329">Por exemplo, **excluir gatilhos** pode impedir o serviço de excluir os dados na origem e causar falha nas operações.</span><span class="sxs-lookup"><span data-stu-id="9ce24-329">For example, **delete triggers** can prevent the service from deleting the data on the source and may cause operations to fail.</span></span>
* <span data-ttu-id="9ce24-330">A chave de fragmentação deve estar na primeira coluna à esquerda da sua chave primária ou definição de índice exclusivo.</span><span class="sxs-lookup"><span data-stu-id="9ce24-330">The sharding key should be the leading column in your primary key or unique index definition.</span></span> <span data-ttu-id="9ce24-331">Isso vai garantir um melhor desempenho para as consultas de validação de divisão/mesclagem e para as operações de movimentação e exclusão de dados reais que sempre operam em intervalos de chave de fragmentação.</span><span class="sxs-lookup"><span data-stu-id="9ce24-331">That ensures the best performance for the split or merge validation queries, and for the actual data movement and deletion operations which always operate on sharding key ranges.</span></span>
* <span data-ttu-id="9ce24-332">Coloque seu serviço de divisão/mesclagem no data center e região onde residem os bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="9ce24-332">Collocate your split-merge service in the region and data center where your databases reside.</span></span> 

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Anchors-->
<!--Image references-->
[1]:./media/sql-database-elastic-scale-overview-split-and-merge/split-merge-overview.png
[2]:./media/sql-database-elastic-scale-overview-split-and-merge/diagnostics.png
[3]:./media/sql-database-elastic-scale-overview-split-and-merge/diagnostics-config.png

