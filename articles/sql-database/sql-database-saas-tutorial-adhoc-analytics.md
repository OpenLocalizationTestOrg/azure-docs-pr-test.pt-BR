---
title: "Executar consultas de análise ad hoc entre vários bancos de dados Azure SQL | Microsoft Docs"
description: "Execute consultas de análise ad hoc em vários bancos de dados SQL no aplicativo SaaS Wingtip multilocatário."
keywords: tutorial do banco de dados SQL
services: sql-database
documentationcenter: 
author: stevestein
manager: jhubbard
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/23/2017
ms.author: billgib; sstein
ms.openlocfilehash: c287fe5d6b333c749b0580b5253e7e46ac27232b
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="run-ad-hoc-analytics-queries-across-all-wingtip-saas-tenants"></a><span data-ttu-id="3574a-104">Executar consultas de análise ad hoc em todos os locatários SaaS Wingtip</span><span class="sxs-lookup"><span data-stu-id="3574a-104">Run ad-hoc analytics queries across all Wingtip SaaS tenants</span></span>

<span data-ttu-id="3574a-105">Neste tutorial, você executa consultas distribuídas em todo o conjunto de bancos de dados locatários para habilitar análises ad-hoc.</span><span class="sxs-lookup"><span data-stu-id="3574a-105">In this tutorial, you run distributed queries across the entire set of tenant databases to enable ad-hoc analytics.</span></span> <span data-ttu-id="3574a-106">A Consulta Elástica é usada para habilitar consultas distribuídas, o que exige que um banco de dados de análise adicional seja implantado (para o servidor de catálogo).</span><span class="sxs-lookup"><span data-stu-id="3574a-106">Elastic Query is used to enable distributed queries, which requires an additional analytics database is deployed (to the catalog server).</span></span> <span data-ttu-id="3574a-107">Essas consultas podem extrair informações escondidas nos dados operacionais diários do aplicativo de SaaS do Wingtip.</span><span class="sxs-lookup"><span data-stu-id="3574a-107">These queries can extract insights buried in the day-to-day operational data of the Wingtip SaaS app.</span></span>


<span data-ttu-id="3574a-108">Neste tutorial, você aprende:</span><span class="sxs-lookup"><span data-stu-id="3574a-108">In this tutorial you learn:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="3574a-109">Sobre as exibições globais em cada banco de dados, que permitem a consulta eficiente entre locatários</span><span class="sxs-lookup"><span data-stu-id="3574a-109">About the global views in each database, that enable efficient querying across tenants</span></span>
> * <span data-ttu-id="3574a-110">Como implantar um banco de dados de análise ad hoc</span><span class="sxs-lookup"><span data-stu-id="3574a-110">How to deploy an ad-hoc analytics database</span></span>
> * <span data-ttu-id="3574a-111">Como executar consultas distribuídas entre todos os bancos de dados de locatário</span><span class="sxs-lookup"><span data-stu-id="3574a-111">How to run distributed queries across all tenant databases</span></span>



<span data-ttu-id="3574a-112">Para concluir este tutorial, verifique se todos os pré-requisitos a seguir são atendidos:</span><span class="sxs-lookup"><span data-stu-id="3574a-112">To complete this tutorial, make sure the following prerequisites are completed:</span></span>

* <span data-ttu-id="3574a-113">O aplicativo SaaS Wingtip é implantado.</span><span class="sxs-lookup"><span data-stu-id="3574a-113">The Wingtip SaaS app is deployed.</span></span> <span data-ttu-id="3574a-114">Para implantar em menos de cinco minutos, confira [Implantar e explorar o aplicativo de SaaS do Wingtip](sql-database-saas-tutorial.md)</span><span class="sxs-lookup"><span data-stu-id="3574a-114">To deploy in less than five minutes, see [Deploy and explore the Wingtip SaaS application](sql-database-saas-tutorial.md)</span></span>
* <span data-ttu-id="3574a-115">O Azure PowerShell está instalado.</span><span class="sxs-lookup"><span data-stu-id="3574a-115">Azure PowerShell is installed.</span></span> <span data-ttu-id="3574a-116">Para obter detalhes, consulte [Introdução ao Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span><span class="sxs-lookup"><span data-stu-id="3574a-116">For details, see [Getting started with Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span></span>
* <span data-ttu-id="3574a-117">O SSMS (SQL Server Management Studio) está instalado.</span><span class="sxs-lookup"><span data-stu-id="3574a-117">SQL Server Management Studio (SSMS) is installed.</span></span> <span data-ttu-id="3574a-118">Para baixar e instalar a versão mais recente do SSMS, confira [Baixar o SSMS (SQL Server Management Studio)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).</span><span class="sxs-lookup"><span data-stu-id="3574a-118">To download and install SSMS, see [Download SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).</span></span>


## <a name="ad-hoc-analytics-pattern"></a><span data-ttu-id="3574a-119">Padrão de análise ad hoc</span><span class="sxs-lookup"><span data-stu-id="3574a-119">Ad-hoc analytics pattern</span></span>

<span data-ttu-id="3574a-120">Uma das ótimas oportunidades com aplicativos SaaS é usar a grande quantidade de dados do locatário armazenados centralmente na nuvem.</span><span class="sxs-lookup"><span data-stu-id="3574a-120">One of the great opportunities with SaaS applications is to use the vast amount of tenant data stored centrally in the cloud.</span></span> <span data-ttu-id="3574a-121">Use esses dados para obter informações sobre a operação e o uso de aplicativos, locatários, usuários, suas preferências, comportamentos etc. Essas informações podem guiar o desenvolvimento do recurso, aprimoramentos de usabilidade e outros investimentos no aplicativo e nos serviços.</span><span class="sxs-lookup"><span data-stu-id="3574a-121">Use this data to gain insights into the operation and usage of your application, your tenants, their users, preferences, behaviors, etc. These insights can guide feature development, usability improvements, and other investments in your apps and services.</span></span>

<span data-ttu-id="3574a-122">É fácil acessar esses dados em um único banco de dados multilocatário, mas não tão fácil quando são distribuídos em escala por, potencialmente, milhares de bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="3574a-122">Accessing this data in a single multi-tenant database is easy, but not so easy when distributed at scale across potentially thousands of databases.</span></span> <span data-ttu-id="3574a-123">Uma abordagem é usar a [Consulta Elástica](sql-database-elastic-query-overview.md), que permite consultas ad hoc em um conjunto distribuído de bancos de dados com esquema comum.</span><span class="sxs-lookup"><span data-stu-id="3574a-123">One approach is to use [Elastic Query](sql-database-elastic-query-overview.md), which enables querying across a distributed set of databases with common schema.</span></span> <span data-ttu-id="3574a-124">A Consulta Elástica usa um único banco de dados *principal* no qual as tabelas externas são definidas que espelham tabelas ou modos de exibição nos bancos de dados distribuídos (de locatário).</span><span class="sxs-lookup"><span data-stu-id="3574a-124">Elastic Query uses a single *head* database in which external tables are defined that mirror tables or views in the distributed (tenant) databases.</span></span> <span data-ttu-id="3574a-125">As consultas enviadas ao banco de dados principal são compiladas para produzir um plano de consulta distribuído, com partes da consulta propagadas para os bancos de dados de locatário, conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="3574a-125">Queries submitted to this head database are compiled to produce a distributed query plan, with portions of the query pushed down to the tenant databases as needed.</span></span> <span data-ttu-id="3574a-126">As Consulta Elásticas usam o mapa de fragmento no banco de dados de catálogo para fornecer o local dos bancos de dados de locatário.</span><span class="sxs-lookup"><span data-stu-id="3574a-126">Elastic Query uses the shard map in the catalog database to provide the location of the tenant databases.</span></span> <span data-ttu-id="3574a-127">A instalação e a consulta são diretas usando o [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference) padrão e dá suporte para consultas ad hoc de ferramentas, como o Power BI e o Excel.</span><span class="sxs-lookup"><span data-stu-id="3574a-127">Setup and query are straightforward using standard [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference), and support ad-hoc querying from tools like Power BI and Excel.</span></span>

<span data-ttu-id="3574a-128">Ao distribuir consultas entre os bancos de dados de locatário, a Consulta Elástica fornece ideias imediatas sobre dados de produção em tempo real.</span><span class="sxs-lookup"><span data-stu-id="3574a-128">By distributing queries across the tenant databases, Elastic Query provides immediate insight into live production data.</span></span> <span data-ttu-id="3574a-129">No entanto, como a Consulta Elástica extrai dados possivelmente de vários bancos de dados, a latência da consulta, às vezes, pode ser maior que para consultas equivalentes enviadas para um único banco de dados de vários locatários.</span><span class="sxs-lookup"><span data-stu-id="3574a-129">However, as Elastic Query pulls data from potentially many databases, query latency can sometimes be higher than for equivalent queries submitted to a single multi-tenant database.</span></span> <span data-ttu-id="3574a-130">Tenha cuidado ao criar consultas para minimizar os dados que são retornados.</span><span class="sxs-lookup"><span data-stu-id="3574a-130">Care should be taken when designing queries to minimize the data that is returned.</span></span> <span data-ttu-id="3574a-131">A Consulta Elástica é geralmente mais adequada para consultar pequenas quantidades de dados em tempo real, em vez de criar consultas ou relatórios de análise complexos ou usados com frequência.</span><span class="sxs-lookup"><span data-stu-id="3574a-131">Elastic Query is often best suited for querying small amounts of real-time data, as opposed to building frequently used or complex analytics queries or reports.</span></span> <span data-ttu-id="3574a-132">Se as consultas não tiverem um bom desempenho, examine o [plano de execução](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan) para ver qual parte da consulta foi propagada para o banco de dados remoto e a quantidade de dados sendo retornada.</span><span class="sxs-lookup"><span data-stu-id="3574a-132">If queries don't perform well, look at the [execution plan](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan) to see what part of the query has been pushed down to the remote database and how much data is being returned.</span></span> <span data-ttu-id="3574a-133">Consultas que exigem processamento analítico complexo podem ser melhor atendidas em alguns casos extraindo dados de locatário em um banco de dados dedicado ou data warehouse otimizado para consultas de análise.</span><span class="sxs-lookup"><span data-stu-id="3574a-133">Queries that require complex analytical processing may be better served in some cases by extracting tenant data into a dedicated database or data warehouse optimized for analytics queries.</span></span> <span data-ttu-id="3574a-134">Esse padrão é explicado no [tutorial de análise de locatário](sql-database-saas-tutorial-tenant-analytics.md).</span><span class="sxs-lookup"><span data-stu-id="3574a-134">This pattern is explained in the [tenant analytics tutorial](sql-database-saas-tutorial-tenant-analytics.md).</span></span> 

## <a name="get-the-wingtip-application-scripts"></a><span data-ttu-id="3574a-135">Obter os scripts do aplicativo Wingtip</span><span class="sxs-lookup"><span data-stu-id="3574a-135">Get the Wingtip application scripts</span></span>

<span data-ttu-id="3574a-136">Os scripts de SaaS do Wingtip e o código-fonte do aplicativo estão disponíveis no repositório GitHub [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS).</span><span class="sxs-lookup"><span data-stu-id="3574a-136">The Wingtip SaaS scripts and application source code are available in the [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) github repo.</span></span> <span data-ttu-id="3574a-137">[Etapas para baixar os scripts do SaaS Wingtip](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span><span class="sxs-lookup"><span data-stu-id="3574a-137">[Steps to download the Wingtip SaaS scripts](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span></span>

## <a name="create-ticket-sales-data"></a><span data-ttu-id="3574a-138">Criar dados de vendas de ingresso</span><span class="sxs-lookup"><span data-stu-id="3574a-138">Create ticket sales data</span></span>

<span data-ttu-id="3574a-139">Para executar consultas em um conjunto de dados mais interessante, crie dados de vendas de ingresso executando o gerador de ingressos.</span><span class="sxs-lookup"><span data-stu-id="3574a-139">To run queries against a more interesting data set, create ticket sales data by running the ticket-generator.</span></span>

1. <span data-ttu-id="3574a-140">No *ISE do PowerShell*, abra o script ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* e defina os seguintes valores:</span><span class="sxs-lookup"><span data-stu-id="3574a-140">In the *PowerShell ISE*, open the ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* script and set the following values:</span></span>
   * <span data-ttu-id="3574a-141">**$DemoScenario** = 1, **Comprar ingressos de eventos em todos os locais**.</span><span class="sxs-lookup"><span data-stu-id="3574a-141">**$DemoScenario** = 1, **Purchase tickets for events at all venues**.</span></span>
2. <span data-ttu-id="3574a-142">Pressione **F5** para executar o script e gerar vendas de ingresso.</span><span class="sxs-lookup"><span data-stu-id="3574a-142">Press **F5** to run the script and generate ticket sales.</span></span> <span data-ttu-id="3574a-143">Enquanto o script é executado, continue as etapas neste tutorial.</span><span class="sxs-lookup"><span data-stu-id="3574a-143">While the script is running, continue the steps in this tutorial.</span></span> <span data-ttu-id="3574a-144">Os dados de ingresso são consultados na seção *Executar consultas distribuídas ad hoc*, portanto, aguarde o gerador de ingressos ser concluído se ele ainda estiver em execução quando chegar a esse exercício.</span><span class="sxs-lookup"><span data-stu-id="3574a-144">The ticket data is queried in the *Run ad-hoc distributed queries* section, so wait for the ticket generator to complete if it's still running when you get to that exercise.</span></span>

## <a name="explore-the-global-views"></a><span data-ttu-id="3574a-145">Explore as exibições globais</span><span class="sxs-lookup"><span data-stu-id="3574a-145">Explore the global views</span></span>

<span data-ttu-id="3574a-146">O aplicativo SaaS Wingtip é criado usando um modelo de locatário por banco de dados e, por isso, o esquema de banco de dados do locatário é definido de uma perspectiva de locatário único.</span><span class="sxs-lookup"><span data-stu-id="3574a-146">The Wingtip SaaS application is built using a tenant-per-database model, so the tenant database schema is defined from a single-tenant perspective.</span></span> <span data-ttu-id="3574a-147">As informações específicas do locatário existem em uma tabela, *Local*, que sempre tem uma única linha e é implementada como um heap, sem uma chave primária.</span><span class="sxs-lookup"><span data-stu-id="3574a-147">Tenant-specific information exists in one table, *Venue*, which always has a single row, and is implemented as a heap, without a primary key.</span></span> <span data-ttu-id="3574a-148">As outras tabelas no esquema não precisam estar relacionadas com a tabela *Local* porque, em condições normais, nunca existe dúvida sobre a qual locatário pertencem os dados.</span><span class="sxs-lookup"><span data-stu-id="3574a-148">Other tables in the schema don't need to be related to the *Venue* table, because in normal use, there is never any doubt which tenant the data belongs to.</span></span>

<span data-ttu-id="3574a-149">No entanto, ao consultar em todos os bancos de dados, é importante que a Consulta Elástica possa tratar os dados como se fizessem parte de um único banco de dados lógico fragmentado por locatário.</span><span class="sxs-lookup"><span data-stu-id="3574a-149">However, when querying across all databases, it's important that Elastic Query can treat the data as if it is part of a single logical database sharded by tenant.</span></span> <span data-ttu-id="3574a-150">Para fazer isso, um conjunto de exibições 'globais' é adicionado ao banco de dados do locatário que projeta uma ID de locatário em cada uma das tabelas consultadas globalmente.</span><span class="sxs-lookup"><span data-stu-id="3574a-150">To achieve this, a set of 'global' views are added to the tenant database that project a tenant id into each of the tables that are queried globally.</span></span> <span data-ttu-id="3574a-151">Por exemplo, a exibição *VenueEvents* adiciona uma *VenueId* computada às colunas projetadas da tabela *Eventos*.</span><span class="sxs-lookup"><span data-stu-id="3574a-151">For example, the *VenueEvents* view adds a computed *VenueId* to the columns projected from the *Events* table.</span></span> <span data-ttu-id="3574a-152">Ao definir a tabela externa no banco de dados principal em *VenueEvents* (em vez da tabela *Eventos* subjacente), A Consulta Elástica é capaz de enviar por push junções com base em *VenueId* para que elas possam ser executadas em paralelo em cada banco de dados remoto (e não no banco de dados principal).</span><span class="sxs-lookup"><span data-stu-id="3574a-152">By defining the external table in the head database over *VenueEvents* (rather than the underlying *Events* table), Elastic Query is able to push down joins based on *VenueId* so they can be executed in parallel on each remote database (rather than on the head database).</span></span> <span data-ttu-id="3574a-153">Isso reduz significativamente a quantidade de dados retornada, o que resulta em um aumento significativo no desempenho para várias consultas.</span><span class="sxs-lookup"><span data-stu-id="3574a-153">This dramatically reduces the amount of data that is returned, which results in a substantial increase in performance for many queries.</span></span> <span data-ttu-id="3574a-154">Essas exibições globais foram pré-criadas em todos os bancos de dados de locatário (e em *basetenantdb*).</span><span class="sxs-lookup"><span data-stu-id="3574a-154">These global views have been pre-created in all tenant databases (and in *basetenantdb*).</span></span>

1. <span data-ttu-id="3574a-155">Abra o SSMS e [conecte-se ao servidor tenants1 -&lt;USER&gt;](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).</span><span class="sxs-lookup"><span data-stu-id="3574a-155">Open SSMS and [connect to the tenants1-&lt;USER&gt; server](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).</span></span>
2. <span data-ttu-id="3574a-156">Expanda **Bancos de Dados**, clique com botão direito do mouse em **contosoconcerthall**e selecione **Nova Consulta**.</span><span class="sxs-lookup"><span data-stu-id="3574a-156">Expand **Databases**, right-click **contosoconcerthall**, and select **New Query**.</span></span>
3. <span data-ttu-id="3574a-157">Execute as seguintes consultas para explorar a diferença entre as tabelas de único locatário e as exibições globais:</span><span class="sxs-lookup"><span data-stu-id="3574a-157">Run the following queries to explore the difference between the single-tenant tables and the global views:</span></span>

   ```T-SQL
   -- The base Venue table, that has no VenueId associated.
   SELECT * FROM Venue

   -- Notice the plural name 'Venues'. This view projects a VenueId column.
   SELECT * FROM Venues

   -- The base Events table, which has no VenueId column.
   SELECT * FROM Events

   -- This view projects the VenueId retrieved from the Venues table.
   SELECT * FROM VenueEvents
   ```

<span data-ttu-id="3574a-158">Nessas exibições, a *VenueId* é calculada como um hash do nome local, mas qualquer abordagem pode ser usada para introduzir um valor exclusivo.</span><span class="sxs-lookup"><span data-stu-id="3574a-158">In these views, the *VenueId* is computed as a hash of the Venue name, but any approach could be used to introduce a unique value.</span></span> <span data-ttu-id="3574a-159">Essa abordagem é semelhante à forma como a chave de locatário é calculada para uso no catálogo.</span><span class="sxs-lookup"><span data-stu-id="3574a-159">This approach is similar to the way the tenant key is computed for use in the catalog.</span></span>

<span data-ttu-id="3574a-160">Para examinar a definição da exibição *Locais*:</span><span class="sxs-lookup"><span data-stu-id="3574a-160">To examine the definition of the *Venues* view:</span></span>

1. <span data-ttu-id="3574a-161">Em **Gerenciador de Objeto**, expanda **contosoconcethall** > **Exibições**:</span><span class="sxs-lookup"><span data-stu-id="3574a-161">In **Object Explorer**, expand **contosoconcethall** > **Views**:</span></span>

   ![Modos de exibição](media/sql-database-saas-tutorial-adhoc-analytics/views.png)

2. <span data-ttu-id="3574a-163">Clique com botão direito do mouse em **dbo.Venues**.</span><span class="sxs-lookup"><span data-stu-id="3574a-163">Right-click **dbo.Venues**.</span></span>
3. <span data-ttu-id="3574a-164">Selecione **Modo de Exibição de Script como** > **CRIAR para** > **Janela do Editor Nova Consulta**</span><span class="sxs-lookup"><span data-stu-id="3574a-164">Select **Script View as** > **CREATE To** > **New Query Editor Window**</span></span>

<span data-ttu-id="3574a-165">Gere o script de qualquer uma das outras exibições *Local* para ver como elas adicionam a *VenueId*.</span><span class="sxs-lookup"><span data-stu-id="3574a-165">Script any of the other *Venue* views to see how they add the *VenueId*.</span></span>

## <a name="deploy-the-database-used-for-ad-hoc-distributed-queries"></a><span data-ttu-id="3574a-166">Implantar o banco de dados usado para consultas distribuídas ad hoc</span><span class="sxs-lookup"><span data-stu-id="3574a-166">Deploy the database used for ad-hoc distributed queries</span></span>

<span data-ttu-id="3574a-167">Neste exercício implanta o banco de dados *adhocanalytics*.</span><span class="sxs-lookup"><span data-stu-id="3574a-167">This exercise deploys the *adhocanalytics* database.</span></span> <span data-ttu-id="3574a-168">Esse é o banco de dados principal que conterá o esquema usado para consultar em todos os bancos de dados de locatário.</span><span class="sxs-lookup"><span data-stu-id="3574a-168">This is the head database that will contain the schema used for querying across all tenant databases.</span></span> <span data-ttu-id="3574a-169">O banco de dados é implantado no servidor de catálogo existente, que é o servidor usado para todos os bancos de dados relacionados ao gerenciamento no aplicativo de exemplo.</span><span class="sxs-lookup"><span data-stu-id="3574a-169">The database is deployed to the existing catalog server, which is the server used for all management-related databases in the sample app.</span></span>

1. <span data-ttu-id="3574a-170">Abra... \\Módulos de Aprendizado\\Análise Operacional\\Análise Adhoc\\*Demo-AdhocAnalytics.ps1* no *PowerShell ISE* e defina os seguintes valores:</span><span class="sxs-lookup"><span data-stu-id="3574a-170">Open ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* in the *PowerShell ISE* and set the following values:</span></span>
   * <span data-ttu-id="3574a-171">**$DemoScenario** = 2, **Implantar banco de dados de análise Ad hoc**.</span><span class="sxs-lookup"><span data-stu-id="3574a-171">**$DemoScenario** = 2, **Deploy Ad-hoc analytics database**.</span></span>

2. <span data-ttu-id="3574a-172">Pressione **F5** para executar o script e criar o banco de dados *adhocanalytics*.</span><span class="sxs-lookup"><span data-stu-id="3574a-172">Press **F5** to run the script and create the *adhocanalytics* database.</span></span>

<span data-ttu-id="3574a-173">Na próxima seção, você adiciona o esquema ao banco de dados para que ele possa ser usado para executar consultas distribuídas.</span><span class="sxs-lookup"><span data-stu-id="3574a-173">In the next section, you add schema to the database so it can be used to run distributed queries.</span></span>

## <a name="configure-the-database-for-running-distributed-queries"></a><span data-ttu-id="3574a-174">Configurar o banco de dados para executar consultas distribuídas</span><span class="sxs-lookup"><span data-stu-id="3574a-174">Configure the database for running distributed queries</span></span>

<span data-ttu-id="3574a-175">Este exercício adiciona o esquema (a fonte de dados externa e as definições de tabela externa) ao banco de dados de análise ad hoc que habilita a consulta em todos os bancos de dados de locatário.</span><span class="sxs-lookup"><span data-stu-id="3574a-175">This exercise adds schema (the external data source and external table definitions) to the ad-hoc analytics database that enables querying across all tenant databases.</span></span>

1. <span data-ttu-id="3574a-176">Abra o SQL Server Management Studio e conecte-se ao banco de dados de Análise Ad hoc criado na etapa anterior.</span><span class="sxs-lookup"><span data-stu-id="3574a-176">Open SQL Server Management Studio, and connect to the Adhoc Analytics database you created in the previous step.</span></span> <span data-ttu-id="3574a-177">O nome do banco de dados será adhocanalytics.</span><span class="sxs-lookup"><span data-stu-id="3574a-177">The name of the database will be adhocanalytics.</span></span>
2. <span data-ttu-id="3574a-178">Abra ...\Learning Modules\Operational Analytics\Adhoc Analytics\ *Initialize-AdhocAnalyticsDB.sql* no SSMS.</span><span class="sxs-lookup"><span data-stu-id="3574a-178">Open ...\Learning Modules\Operational Analytics\Adhoc Analytics\ *Initialize-AdhocAnalyticsDB.sql* in SSMS.</span></span>
3. <span data-ttu-id="3574a-179">Examine o script SQL e observe o seguinte:</span><span class="sxs-lookup"><span data-stu-id="3574a-179">Review the SQL script and note the following:</span></span>

   <span data-ttu-id="3574a-180">A Consulta Elástica usa uma credencial com escopo de banco de dados para acessar cada um dos bancos de dados de locatário.</span><span class="sxs-lookup"><span data-stu-id="3574a-180">Elastic Query uses a database-scoped credential to access each of the tenant databases.</span></span> <span data-ttu-id="3574a-181">Essa credencial precisa estar disponível em todos os bancos de dados e normalmente recebem os direitos mínimos para permitir essas consultas ad hoc.</span><span class="sxs-lookup"><span data-stu-id="3574a-181">This credential needs to be available in all the databases and should normally be granted the minimum rights required to enable these ad-hoc queries.</span></span>

    ![criar credencial](media/sql-database-saas-tutorial-adhoc-analytics/create-credential.png)

   <span data-ttu-id="3574a-183">A fonte de dados externa, que é definida para usar o mapa do fragmento locatário no banco de dados de catálogo.</span><span class="sxs-lookup"><span data-stu-id="3574a-183">The external data source, that is defined to use the tenant shard map in the catalog database.</span></span> <span data-ttu-id="3574a-184">Usando isso como fonte de dados externa, as consultas são distribuídas para todos os bancos de dados registrados no catálogo quando a consulta é executada.</span><span class="sxs-lookup"><span data-stu-id="3574a-184">By using this as the external data source, queries are distributed to all databases registered in the catalog when the query is run.</span></span> <span data-ttu-id="3574a-185">Como os nomes de servidor são diferentes para cada implantação, esse script de inicialização obtém a localização do banco de dados de catálogo recuperando o servidor atual (@@servername) em que o script é executado.</span><span class="sxs-lookup"><span data-stu-id="3574a-185">Because server names are different for each deployment, this initialization script gets the location of the catalog database by retrieving the current server (@@servername) where the script is executed.</span></span>

    ![Criar fonte de dados externa](media/sql-database-saas-tutorial-adhoc-analytics/create-external-data-source.png)

   <span data-ttu-id="3574a-187">As tabelas externas que fazem referência a exibições globais descritas na seção anterior e definidas com **DISTRIBUTION = SHARDED(VenueId)**.</span><span class="sxs-lookup"><span data-stu-id="3574a-187">The external tables that reference the global views described in the previous section, and defined with **DISTRIBUTION = SHARDED(VenueId)**.</span></span> <span data-ttu-id="3574a-188">Como cada *VenueId* mapeia para um banco de dados individual, isso melhora o desempenho em muitos cenários, como mostrado na próxima seção.</span><span class="sxs-lookup"><span data-stu-id="3574a-188">Because each *VenueId* maps to a single database, this improves performance for many scenarios as shown in the next section.</span></span>

    ![criar tabelas externas](media/sql-database-saas-tutorial-adhoc-analytics/external-tables.png)

   <span data-ttu-id="3574a-190">A tabela local *VenueTypes*, que é criada e preenchida.</span><span class="sxs-lookup"><span data-stu-id="3574a-190">The local table *VenueTypes* that is created and populated.</span></span> <span data-ttu-id="3574a-191">Essa tabela de dados de referência é comum em todos os bancos de dados de locatário, portanto ela pode ser representada como uma tabela local e populada com os dados comuns.</span><span class="sxs-lookup"><span data-stu-id="3574a-191">This reference data table is common in all tenant databases, so it can be represented here as a local table and populated with the common data.</span></span> <span data-ttu-id="3574a-192">Para algumas consultas isso pode reduzir a quantidade de dados movidos entre os bancos de dados de locatário e o banco de dados *adhocanalytics*.</span><span class="sxs-lookup"><span data-stu-id="3574a-192">For some queries this may reduce the amount of data moved between the tenant databases and the *adhocanalytics* database.</span></span>

    ![criar tabela](media/sql-database-saas-tutorial-adhoc-analytics/create-table.png)

   <span data-ttu-id="3574a-194">Se você incluir tabelas de referência dessa maneira, certifique-se de atualizar o esquema de tabela e os dados sempre que atualizar os bancos de dados de locatário.</span><span class="sxs-lookup"><span data-stu-id="3574a-194">If you include reference tables in this manner, be sure to update the table schema and data whenever you update the tenant databases.</span></span>

4. <span data-ttu-id="3574a-195">Pressione **F5** para executar o script e inicializar o banco de dados *adhocanalytics*.</span><span class="sxs-lookup"><span data-stu-id="3574a-195">Press **F5** to run the script and initialize the *adhocanalytics* database.</span></span> 

<span data-ttu-id="3574a-196">Agora você pode executar consultas distribuídas e reunir informações entre todos os locatários!</span><span class="sxs-lookup"><span data-stu-id="3574a-196">Now you can run distributed queries, and gather insights across all tenants!</span></span>

## <a name="run-ad-hoc-distributed-queries"></a><span data-ttu-id="3574a-197">Executar consultas distribuídas ad hoc</span><span class="sxs-lookup"><span data-stu-id="3574a-197">Run ad-hoc distributed queries</span></span>

<span data-ttu-id="3574a-198">Agora que o banco de dados *adhocanalytics* está configurado, prossiga e execute algumas consultas distribuídas.</span><span class="sxs-lookup"><span data-stu-id="3574a-198">Now that the *adhocanalytics* database is set up, go ahead and run some distributed queries.</span></span> <span data-ttu-id="3574a-199">Inclua o plano de execução para uma melhor compreensão sobre onde o processamento de consultas está acontecendo.</span><span class="sxs-lookup"><span data-stu-id="3574a-199">Include the execution plan for a better understanding of where the query processing is happening.</span></span> 

<span data-ttu-id="3574a-200">Ao inspecionar o plano de execução, passe o mouse sobre os ícones de plano para obter detalhes.</span><span class="sxs-lookup"><span data-stu-id="3574a-200">When inspecting the execution plan, hover over the plan icons for details.</span></span> 

<span data-ttu-id="3574a-201">É importante observar que configurar **DISTRIBUTION = SHARDED(VenueId)** quando definimos a fonte de dados externa melhora o desempenho em muitos cenários.</span><span class="sxs-lookup"><span data-stu-id="3574a-201">Important to note, is that setting **DISTRIBUTION = SHARDED(VenueId)** when we defined the external data source, improves performance for many scenarios.</span></span> <span data-ttu-id="3574a-202">Como cada *VenueId* mapeia para um banco de dados individual, a filtragem é facilmente feita de forma remota, retornando apenas os dados necessários.</span><span class="sxs-lookup"><span data-stu-id="3574a-202">Because each *VenueId* maps to a single database, filtering is easily done remotely, returning only the data we need.</span></span>

1. <span data-ttu-id="3574a-203">Abra... \\Módulos de Aprendizado\\Análise Operacional\\Análise Ad Hoc\\*Demo-AdhocAnalyticsQueries.sql* no SSMS.</span><span class="sxs-lookup"><span data-stu-id="3574a-203">Open ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalyticsQueries.sql* in SSMS.</span></span>
2. <span data-ttu-id="3574a-204">Verifique se está conectado ao banco de dados do **adhocanalytics**.</span><span class="sxs-lookup"><span data-stu-id="3574a-204">Ensure you are connected to the **adhocanalytics** database.</span></span>
3. <span data-ttu-id="3574a-205">Selecione o menu **Consulta** e clique em **Incluir Plano de Execução Atual**</span><span class="sxs-lookup"><span data-stu-id="3574a-205">Select the **Query** menu and click **Include Actual Execution Plan**</span></span>
4. <span data-ttu-id="3574a-206">Realce a consulta *Which venues are currently registered? (Quais locais estão registrados no momento?)* e pressione **F5**.</span><span class="sxs-lookup"><span data-stu-id="3574a-206">Highlight the *Which venues are currently registered?* query, and press **F5**.</span></span>

   <span data-ttu-id="3574a-207">A consulta retorna a lista de locais inteira, ilustrando o quão rápido e fácil é consultar todos os locatários e retornar dados de cada um.</span><span class="sxs-lookup"><span data-stu-id="3574a-207">The query returns the entire venue list, illustrating how quick and easy it is to query across all tenants and return data from each tenant.</span></span>

   <span data-ttu-id="3574a-208">Inspecione o plano e veja que todo o custo é a consulta remota, pois simplesmente estamos indo até cada banco de dados de locatário e selecionando as informações de local.</span><span class="sxs-lookup"><span data-stu-id="3574a-208">Inspect the plan and see that the entire cost is the remote query because we're simply going to each tenant database and selecting the venue information.</span></span>

   ![SELECT * FROM dbo.Venues](media/sql-database-saas-tutorial-adhoc-analytics/query1-plan.png)

5. <span data-ttu-id="3574a-210">Selecione a próxima consulta e pressione **F5**.</span><span class="sxs-lookup"><span data-stu-id="3574a-210">Select the next query, and press **F5**.</span></span>

   <span data-ttu-id="3574a-211">Essa consulta une dados de bancos de dados de locatário e da tabela *VenueTypes* local (local, como é uma tabela no banco de dados *adhocanalytics*).</span><span class="sxs-lookup"><span data-stu-id="3574a-211">This query joins data from the tenant databases and the local *VenueTypes* table (local, as its a table in the *adhocanalytics* database).</span></span>

   <span data-ttu-id="3574a-212">Inspecione o plano e veja que a maior parte do custo é a consulta remota porque consultamos as informações de local de cada locatário (dbo.Venues) e, em seguida, realizamos uma rápida união com a tabela *VenueTypes* local para exibir o nome amigável.</span><span class="sxs-lookup"><span data-stu-id="3574a-212">Inspect the plan and see that the majority of cost is the remote query because we query each tenant's venue info (dbo.Venues), and then do a quick local join with the local *VenueTypes* table to display the friendly name.</span></span>

   ![Unir dados remotos e locais](media/sql-database-saas-tutorial-adhoc-analytics/query2-plan.png)

6. <span data-ttu-id="3574a-214">Agora selecione a consulta *On which day were the most tickets sold? (Em que dia a maioria dos ingressos foi vendida?)* e pressione **F5**.</span><span class="sxs-lookup"><span data-stu-id="3574a-214">Now select the *On which day were the most tickets sold?* query, and press **F5**.</span></span>

   <span data-ttu-id="3574a-215">Essa consulta faz uma união e uma agregação um pouco mais complexas.</span><span class="sxs-lookup"><span data-stu-id="3574a-215">This query does a bit more complex joining and aggregation.</span></span> <span data-ttu-id="3574a-216">O que é importante observar é que a maioria do processamento é feita remotamente e novamente, trazemos de volta apenas as linhas que precisamos, retornando apenas uma única linha para a contagem de venda de ingressos agregada por dia de cada local.</span><span class="sxs-lookup"><span data-stu-id="3574a-216">What's important to note is that most of the processing is done remotely, and once again, we bring back only the rows we need, returning just a single row for each venue's aggregate ticket sale count per day.</span></span>

   ![query](media/sql-database-saas-tutorial-adhoc-analytics/query3-plan.png)


## <a name="next-steps"></a><span data-ttu-id="3574a-218">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="3574a-218">Next steps</span></span>

<span data-ttu-id="3574a-219">Neste tutorial, você aprendeu a:</span><span class="sxs-lookup"><span data-stu-id="3574a-219">In this tutorial you learned how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="3574a-220">Executar consultas distribuídas entre todos os bancos de dados de locatário</span><span class="sxs-lookup"><span data-stu-id="3574a-220">Run distributed queries across all tenant databases</span></span>
> * <span data-ttu-id="3574a-221">Implantar um banco de dados de análise ad hoc e adicionar o esquema a ele para executar consultas distribuídas.</span><span class="sxs-lookup"><span data-stu-id="3574a-221">Deploy an ad-hoc analytics database and add schema to it to run distributed queries.</span></span>


<span data-ttu-id="3574a-222">Agora, experimente o [Tutorial de análise de locatário](sql-database-saas-tutorial-tenant-analytics.md) para explorar a extração de dados para um banco de dados de análise separado para o processamento de análise mais complexo.</span><span class="sxs-lookup"><span data-stu-id="3574a-222">Now try the [Tenant Analytics tutorial](sql-database-saas-tutorial-tenant-analytics.md) to explore extracting data to a separate analytics database for more complex analytics processing...</span></span>

## <a name="additional-resources"></a><span data-ttu-id="3574a-223">Recursos adicionais</span><span class="sxs-lookup"><span data-stu-id="3574a-223">Additional resources</span></span>

* <span data-ttu-id="3574a-224">[Tutoriais adicionais que aproveitam o aplicativo de SaaS do Wingtip](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span><span class="sxs-lookup"><span data-stu-id="3574a-224">Additional [tutorials that build upon the Wingtip SaaS application](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span></span>
* [<span data-ttu-id="3574a-225">Consulta elástica</span><span class="sxs-lookup"><span data-stu-id="3574a-225">Elastic Query</span></span>](sql-database-elastic-query-overview.md)
