---
title: "consultas de análise ad hoc aaaRun em vários bancos de dados SQL do Azure | Microsoft Docs"
description: "Execute consultas de análise ad hoc em vários bancos de dados do SQL no aplicativo do hello Wingtip SaaS multilocatário."
keywords: tutorial do banco de dados SQL
services: sql-database
documentationcenter: 
author: stevestein
manager: jhubbard
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/23/2017
ms.author: billgib; sstein
ms.openlocfilehash: 140cd51fdd03b5a548147282b51ceb0ad80c944d
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/06/2017
---
# <a name="run-ad-hoc-analytics-queries-across-all-wingtip-saas-tenants"></a><span data-ttu-id="c49fa-104">Executar consultas de análise ad hoc em todos os locatários SaaS Wingtip</span><span class="sxs-lookup"><span data-stu-id="c49fa-104">Run ad-hoc analytics queries across all Wingtip SaaS tenants</span></span>

<span data-ttu-id="c49fa-105">Neste tutorial, você executar consultas distribuídas em todo o conjunto de bancos de dados de locatário Olá tooenable ad-hoc análises.</span><span class="sxs-lookup"><span data-stu-id="c49fa-105">In this tutorial, you run distributed queries across hello entire set of tenant databases tooenable ad-hoc analytics.</span></span> <span data-ttu-id="c49fa-106">Consulta elástica é usado tooenable distribuído de consultas, que requer um banco de dados de análise adicional for implantado (servidor de catálogo toohello).</span><span class="sxs-lookup"><span data-stu-id="c49fa-106">Elastic Query is used tooenable distributed queries, which requires an additional analytics database is deployed (toohello catalog server).</span></span> <span data-ttu-id="c49fa-107">Essas consultas podem extrair insights ocultos em dados operacionais diárias de saudação do aplicativo de SaaS Wingtip hello.</span><span class="sxs-lookup"><span data-stu-id="c49fa-107">These queries can extract insights buried in hello day-to-day operational data of hello Wingtip SaaS app.</span></span>


<span data-ttu-id="c49fa-108">Neste tutorial, você aprende:</span><span class="sxs-lookup"><span data-stu-id="c49fa-108">In this tutorial you learn:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="c49fa-109">Sobre exibições global de saudação em cada banco de dados, que permitem a consulta eficiente entre locatários</span><span class="sxs-lookup"><span data-stu-id="c49fa-109">About hello global views in each database, that enable efficient querying across tenants</span></span>
> * <span data-ttu-id="c49fa-110">Como toodeploy um banco de dados de análise ad hoc</span><span class="sxs-lookup"><span data-stu-id="c49fa-110">How toodeploy an ad-hoc analytics database</span></span>
> * <span data-ttu-id="c49fa-111">Como toorun consultas distribuídas em todos os bancos de dados de locatário</span><span class="sxs-lookup"><span data-stu-id="c49fa-111">How toorun distributed queries across all tenant databases</span></span>



<span data-ttu-id="c49fa-112">toocomplete neste tutorial, verifique Olá se os pré-requisitos a seguir são concluídas:</span><span class="sxs-lookup"><span data-stu-id="c49fa-112">toocomplete this tutorial, make sure hello following prerequisites are completed:</span></span>

* <span data-ttu-id="c49fa-113">Olá Wingtip SaaS aplicativo é implantado.</span><span class="sxs-lookup"><span data-stu-id="c49fa-113">hello Wingtip SaaS app is deployed.</span></span> <span data-ttu-id="c49fa-114">toodeploy em menos de cinco minutos, consulte [implantar e explorar o aplicativo de SaaS Wingtip hello](sql-database-saas-tutorial.md)</span><span class="sxs-lookup"><span data-stu-id="c49fa-114">toodeploy in less than five minutes, see [Deploy and explore hello Wingtip SaaS application](sql-database-saas-tutorial.md)</span></span>
* <span data-ttu-id="c49fa-115">O Azure PowerShell está instalado.</span><span class="sxs-lookup"><span data-stu-id="c49fa-115">Azure PowerShell is installed.</span></span> <span data-ttu-id="c49fa-116">Para obter detalhes, consulte [Introdução ao Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span><span class="sxs-lookup"><span data-stu-id="c49fa-116">For details, see [Getting started with Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span></span>
* <span data-ttu-id="c49fa-117">O SSMS (SQL Server Management Studio) está instalado.</span><span class="sxs-lookup"><span data-stu-id="c49fa-117">SQL Server Management Studio (SSMS) is installed.</span></span> <span data-ttu-id="c49fa-118">toodownload e instale o SSMS, consulte [baixar o SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).</span><span class="sxs-lookup"><span data-stu-id="c49fa-118">toodownload and install SSMS, see [Download SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).</span></span>


## <a name="ad-hoc-analytics-pattern"></a><span data-ttu-id="c49fa-119">Padrão de análise ad hoc</span><span class="sxs-lookup"><span data-stu-id="c49fa-119">Ad-hoc analytics pattern</span></span>

<span data-ttu-id="c49fa-120">Um dos grandes oportunidades Olá com aplicativos SaaS é toouse Olá enorme quantidade de dados de locatário armazenadas centralmente em nuvem hello.</span><span class="sxs-lookup"><span data-stu-id="c49fa-120">One of hello great opportunities with SaaS applications is toouse hello vast amount of tenant data stored centrally in hello cloud.</span></span> <span data-ttu-id="c49fa-121">Use este insights toogain de dados em operação hello e uso de seu aplicativo, seus locatários, seus usuários, preferências, comportamentos, etc. Essas informações podem guiar o desenvolvimento do recurso, aprimoramentos de usabilidade e outros investimentos no aplicativo e nos serviços.</span><span class="sxs-lookup"><span data-stu-id="c49fa-121">Use this data toogain insights into hello operation and usage of your application, your tenants, their users, preferences, behaviors, etc. These insights can guide feature development, usability improvements, and other investments in your apps and services.</span></span>

<span data-ttu-id="c49fa-122">É fácil acessar esses dados em um único banco de dados multilocatário, mas não tão fácil quando são distribuídos em escala por, potencialmente, milhares de bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="c49fa-122">Accessing this data in a single multi-tenant database is easy, but not so easy when distributed at scale across potentially thousands of databases.</span></span> <span data-ttu-id="c49fa-123">Uma abordagem é toouse [consulta Elástico](sql-database-elastic-query-overview.md), que habilita a consulta em um conjunto distribuído de bancos de dados com um esquema comum.</span><span class="sxs-lookup"><span data-stu-id="c49fa-123">One approach is toouse [Elastic Query](sql-database-elastic-query-overview.md), which enables querying across a distributed set of databases with common schema.</span></span> <span data-ttu-id="c49fa-124">Elástica consulta usa um único *head* banco de dados no qual as tabelas externas são definidas que espelho tabelas ou exibições Olá distribuído bancos de dados (Locatário).</span><span class="sxs-lookup"><span data-stu-id="c49fa-124">Elastic Query uses a single *head* database in which external tables are defined that mirror tables or views in hello distributed (tenant) databases.</span></span> <span data-ttu-id="c49fa-125">As consultas enviadas toothis principal de banco de dados é compilado tooproduce um plano de consulta distribuída, com partes de saudação consulta propagados toohello bancos de dados de locatário, conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="c49fa-125">Queries submitted toothis head database are compiled tooproduce a distributed query plan, with portions of hello query pushed down toohello tenant databases as needed.</span></span> <span data-ttu-id="c49fa-126">Consulta elástica usa o mapa do fragmento Olá no local de saudação de tooprovide Olá catálogo banco de dados de bancos de dados de locatário de saudação.</span><span class="sxs-lookup"><span data-stu-id="c49fa-126">Elastic Query uses hello shard map in hello catalog database tooprovide hello location of hello tenant databases.</span></span> <span data-ttu-id="c49fa-127">A instalação e a consulta são diretas usando o [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference) padrão e dá suporte para consultas ad hoc de ferramentas, como o Power BI e o Excel.</span><span class="sxs-lookup"><span data-stu-id="c49fa-127">Setup and query are straightforward using standard [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference), and support ad-hoc querying from tools like Power BI and Excel.</span></span>

<span data-ttu-id="c49fa-128">Distribuindo consultas em bancos de dados de locatário hello, consulta Elástico fornece ideias imediatas sobre dados de produção.</span><span class="sxs-lookup"><span data-stu-id="c49fa-128">By distributing queries across hello tenant databases, Elastic Query provides immediate insight into live production data.</span></span> <span data-ttu-id="c49fa-129">No entanto, como a consulta Elástico extrai dados de vários bancos de dados, consulta latência às vezes pode ser maior do que para consultas equivalentes enviados tooa único banco de dados de vários locatários.</span><span class="sxs-lookup"><span data-stu-id="c49fa-129">However, as Elastic Query pulls data from potentially many databases, query latency can sometimes be higher than for equivalent queries submitted tooa single multi-tenant database.</span></span> <span data-ttu-id="c49fa-130">Tenha cuidado ao projetar consultas dados saudação toominimize que são retornados.</span><span class="sxs-lookup"><span data-stu-id="c49fa-130">Care should be taken when designing queries toominimize hello data that is returned.</span></span> <span data-ttu-id="c49fa-131">Consulta elástica é geralmente mais adequada para consultar pequenas quantidades de dados em tempo real, relatórios, as consultas analíticas complexas ou toobuilding contrário usados com frequência.</span><span class="sxs-lookup"><span data-stu-id="c49fa-131">Elastic Query is often best suited for querying small amounts of real-time data, as opposed toobuilding frequently used or complex analytics queries or reports.</span></span> <span data-ttu-id="c49fa-132">Se as consultas não executam bem, examinar Olá [plano de execução](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan) toosee qual parte da consulta Olá foi pressionado toohello banco de dados remoto e a quantidade de dados está sendo retornado.</span><span class="sxs-lookup"><span data-stu-id="c49fa-132">If queries don't perform well, look at hello [execution plan](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan) toosee what part of hello query has been pushed down toohello remote database and how much data is being returned.</span></span> <span data-ttu-id="c49fa-133">Consultas que exigem processamento analítico complexo podem ser melhor atendidas em alguns casos extraindo dados de locatário em um banco de dados dedicado ou data warehouse otimizado para consultas de análise.</span><span class="sxs-lookup"><span data-stu-id="c49fa-133">Queries that require complex analytical processing may be better served in some cases by extracting tenant data into a dedicated database or data warehouse optimized for analytics queries.</span></span> <span data-ttu-id="c49fa-134">Esse padrão é explicado em Olá [tutorial de análise de locatário](sql-database-saas-tutorial-tenant-analytics.md).</span><span class="sxs-lookup"><span data-stu-id="c49fa-134">This pattern is explained in hello [tenant analytics tutorial](sql-database-saas-tutorial-tenant-analytics.md).</span></span> 

## <a name="get-hello-wingtip-application-scripts"></a><span data-ttu-id="c49fa-135">Obter scripts de aplicativo hello Wingtip</span><span class="sxs-lookup"><span data-stu-id="c49fa-135">Get hello Wingtip application scripts</span></span>

<span data-ttu-id="c49fa-136">Hello Wingtip SaaS scripts e código fonte do aplicativo estão disponíveis no hello [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) repositório github.</span><span class="sxs-lookup"><span data-stu-id="c49fa-136">hello Wingtip SaaS scripts and application source code are available in hello [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) github repo.</span></span> <span data-ttu-id="c49fa-137">[As etapas de scripts de SaaS Wingtip Olá toodownload](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span><span class="sxs-lookup"><span data-stu-id="c49fa-137">[Steps toodownload hello Wingtip SaaS scripts](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span></span>

## <a name="create-ticket-sales-data"></a><span data-ttu-id="c49fa-138">Criar dados de vendas de ingresso</span><span class="sxs-lookup"><span data-stu-id="c49fa-138">Create ticket sales data</span></span>

<span data-ttu-id="c49fa-139">toorun as consultas em um conjunto de dados mais interessante, crie dados de vendas de tíquete executando o gerador de tíquete hello.</span><span class="sxs-lookup"><span data-stu-id="c49fa-139">toorun queries against a more interesting data set, create ticket sales data by running hello ticket-generator.</span></span>

1. <span data-ttu-id="c49fa-140">Em Olá *PowerShell ISE*, abra hello... \\Módulos de aprendizado\\análise operacional\\análise ad hoc\\*AdhocAnalytics.ps1 demonstração* script e definir Olá valores a seguir:</span><span class="sxs-lookup"><span data-stu-id="c49fa-140">In hello *PowerShell ISE*, open hello ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* script and set hello following values:</span></span>
   * <span data-ttu-id="c49fa-141">**$DemoScenario** = 1, **Comprar ingressos de eventos em todos os locais**.</span><span class="sxs-lookup"><span data-stu-id="c49fa-141">**$DemoScenario** = 1, **Purchase tickets for events at all venues**.</span></span>
2. <span data-ttu-id="c49fa-142">Pressione **F5** para executar o script hello e gerar vendas de tíquete.</span><span class="sxs-lookup"><span data-stu-id="c49fa-142">Press **F5** to run hello script and generate ticket sales.</span></span> <span data-ttu-id="c49fa-143">Durante a execução de script hello, continue com as etapas de saudação neste tutorial.</span><span class="sxs-lookup"><span data-stu-id="c49fa-143">While hello script is running, continue hello steps in this tutorial.</span></span> <span data-ttu-id="c49fa-144">dados de tíquete de saudação são consultados em Olá *executar consultas ad hoc distribuída* seção, aguarde até Olá tíquete gerador toocomplete se ele ainda está em execução quando você obter toothat exercício.</span><span class="sxs-lookup"><span data-stu-id="c49fa-144">hello ticket data is queried in hello *Run ad-hoc distributed queries* section, so wait for hello ticket generator toocomplete if it's still running when you get toothat exercise.</span></span>

## <a name="explore-hello-global-views"></a><span data-ttu-id="c49fa-145">Explore os modos de exibição globais Olá</span><span class="sxs-lookup"><span data-stu-id="c49fa-145">Explore hello global views</span></span>

<span data-ttu-id="c49fa-146">Olá aplicativo SaaS Wingtip é criado usando um modelo de locatário por banco de dados, portanto o esquema de banco de dados de locatário Olá é definida de uma perspectiva de único locatário.</span><span class="sxs-lookup"><span data-stu-id="c49fa-146">hello Wingtip SaaS application is built using a tenant-per-database model, so hello tenant database schema is defined from a single-tenant perspective.</span></span> <span data-ttu-id="c49fa-147">As informações específicas do locatário existem em uma tabela, *Local*, que sempre tem uma única linha e é implementada como um heap, sem uma chave primária.</span><span class="sxs-lookup"><span data-stu-id="c49fa-147">Tenant-specific information exists in one table, *Venue*, which always has a single row, and is implemented as a heap, without a primary key.</span></span> <span data-ttu-id="c49fa-148">Outras tabelas no esquema de saudação não é necessário toobe relacionada toohello *foro* tabela, porque em uso normal, nunca há alguma dúvida quais dados de saudação do locatário pertencem.</span><span class="sxs-lookup"><span data-stu-id="c49fa-148">Other tables in hello schema don't need toobe related toohello *Venue* table, because in normal use, there is never any doubt which tenant hello data belongs to.</span></span>

<span data-ttu-id="c49fa-149">No entanto, ao consultar em todos os bancos de dados, é importante que consulta Elástico pode tratar dados saudação como se faz parte de um único banco de dados lógico fragmentado por locatário.</span><span class="sxs-lookup"><span data-stu-id="c49fa-149">However, when querying across all databases, it's important that Elastic Query can treat hello data as if it is part of a single logical database sharded by tenant.</span></span> <span data-ttu-id="c49fa-150">tooachieve isso, um conjunto de exibições 'globais' são toohello adicionado locatário banco de dados do projeto uma id de locatário em cada uma das tabelas de saudação que são consultadas globalmente.</span><span class="sxs-lookup"><span data-stu-id="c49fa-150">tooachieve this, a set of 'global' views are added toohello tenant database that project a tenant id into each of hello tables that are queried globally.</span></span> <span data-ttu-id="c49fa-151">Por exemplo, Olá *VenueEvents* exibição adiciona um computada *VenueId* toohello colunas projetadas de saudação *eventos* tabela.</span><span class="sxs-lookup"><span data-stu-id="c49fa-151">For example, hello *VenueEvents* view adds a computed *VenueId* toohello columns projected from hello *Events* table.</span></span> <span data-ttu-id="c49fa-152">Definindo a tabela externa Olá no banco de dados principal Olá sobre *VenueEvents* (em vez da saudação subjacente *eventos* tabela), consulta Elástico é capaz de toopush para baixo de junções com base em *VenueId* para que eles podem ser executados em paralelo em cada banco de dados remoto (e não no banco de dados principal Olá).</span><span class="sxs-lookup"><span data-stu-id="c49fa-152">By defining hello external table in hello head database over *VenueEvents* (rather than hello underlying *Events* table), Elastic Query is able toopush down joins based on *VenueId* so they can be executed in parallel on each remote database (rather than on hello head database).</span></span> <span data-ttu-id="c49fa-153">Isso drasticamente reduz a quantidade de saudação de dados que são retornados, o que resulta em um aumento significativo no desempenho para várias consultas.</span><span class="sxs-lookup"><span data-stu-id="c49fa-153">This dramatically reduces hello amount of data that is returned, which results in a substantial increase in performance for many queries.</span></span> <span data-ttu-id="c49fa-154">Essas exibições globais foram pré-criadas em todos os bancos de dados de locatário (e em *basetenantdb*).</span><span class="sxs-lookup"><span data-stu-id="c49fa-154">These global views have been pre-created in all tenant databases (and in *basetenantdb*).</span></span>

1. <span data-ttu-id="c49fa-155">Abra o SSMS e [conectar toohello tenants1 -&lt;usuário&gt; server](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).</span><span class="sxs-lookup"><span data-stu-id="c49fa-155">Open SSMS and [connect toohello tenants1-&lt;USER&gt; server](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).</span></span>
2. <span data-ttu-id="c49fa-156">Expanda **Bancos de Dados**, clique com botão direito do mouse em **contosoconcerthall**e selecione **Nova Consulta**.</span><span class="sxs-lookup"><span data-stu-id="c49fa-156">Expand **Databases**, right-click **contosoconcerthall**, and select **New Query**.</span></span>
3. <span data-ttu-id="c49fa-157">Execute Olá diferença de saudação tooexplore consultas entre tabelas de único locatário hello e modos de exibição globais Olá a seguir:</span><span class="sxs-lookup"><span data-stu-id="c49fa-157">Run hello following queries tooexplore hello difference between hello single-tenant tables and hello global views:</span></span>

   ```T-SQL
   -- hello base Venue table, that has no VenueId associated.
   SELECT * FROM Venue

   -- Notice hello plural name 'Venues'. This view projects a VenueId column.
   SELECT * FROM Venues

   -- hello base Events table, which has no VenueId column.
   SELECT * FROM Events

   -- This view projects hello VenueId retrieved from hello Venues table.
   SELECT * FROM VenueEvents
   ```

<span data-ttu-id="c49fa-158">Esses modos de exibição, Olá *VenueId* é calculado como um hash do nome de local de hello, mas qualquer abordagem pode ser usado toointroduce um valor exclusivo.</span><span class="sxs-lookup"><span data-stu-id="c49fa-158">In these views, hello *VenueId* is computed as a hash of hello Venue name, but any approach could be used toointroduce a unique value.</span></span> <span data-ttu-id="c49fa-159">Essa abordagem é semelhante maneira toohello chave de locatário Olá é calculado para uso no catálogo de saudação.</span><span class="sxs-lookup"><span data-stu-id="c49fa-159">This approach is similar toohello way hello tenant key is computed for use in hello catalog.</span></span>

<span data-ttu-id="c49fa-160">definição de saudação tooexamine de saudação *locais* exibição:</span><span class="sxs-lookup"><span data-stu-id="c49fa-160">tooexamine hello definition of hello *Venues* view:</span></span>

1. <span data-ttu-id="c49fa-161">Em **Gerenciador de Objeto**, expanda **contosoconcethall** > **Exibições**:</span><span class="sxs-lookup"><span data-stu-id="c49fa-161">In **Object Explorer**, expand **contosoconcethall** > **Views**:</span></span>

   ![Modos de exibição](media/sql-database-saas-tutorial-adhoc-analytics/views.png)

2. <span data-ttu-id="c49fa-163">Clique com botão direito do mouse em **dbo.Venues**.</span><span class="sxs-lookup"><span data-stu-id="c49fa-163">Right-click **dbo.Venues**.</span></span>
3. <span data-ttu-id="c49fa-164">Selecione **Modo de Exibição de Script como** > **CRIAR para** > **Janela do Editor Nova Consulta**</span><span class="sxs-lookup"><span data-stu-id="c49fa-164">Select **Script View as** > **CREATE To** > **New Query Editor Window**</span></span>

<span data-ttu-id="c49fa-165">Script de qualquer um dos outros Olá *foro* exibições toosee como adicionam Olá *VenueId*.</span><span class="sxs-lookup"><span data-stu-id="c49fa-165">Script any of hello other *Venue* views toosee how they add hello *VenueId*.</span></span>

## <a name="deploy-hello-database-used-for-ad-hoc-distributed-queries"></a><span data-ttu-id="c49fa-166">Implantar banco de dados de saudação usado para consultas distribuída ad hoc</span><span class="sxs-lookup"><span data-stu-id="c49fa-166">Deploy hello database used for ad-hoc distributed queries</span></span>

<span data-ttu-id="c49fa-167">Este exercício implanta Olá *adhocanalytics* banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c49fa-167">This exercise deploys hello *adhocanalytics* database.</span></span> <span data-ttu-id="c49fa-168">Isso é o banco de dados principal do hello que conterá o esquema de saudação usado para consultar em todos os bancos de dados de locatário.</span><span class="sxs-lookup"><span data-stu-id="c49fa-168">This is hello head database that will contain hello schema used for querying across all tenant databases.</span></span> <span data-ttu-id="c49fa-169">banco de dados de saudação é implantado toohello existente do servidor de catálogo, que é o servidor de saudação usado para todos os relacionadas ao gerenciamento de bancos de dados no aplicativo de exemplo hello.</span><span class="sxs-lookup"><span data-stu-id="c49fa-169">hello database is deployed toohello existing catalog server, which is hello server used for all management-related databases in hello sample app.</span></span>

1. <span data-ttu-id="c49fa-170">Abrir... \\Módulos de aprendizado\\análise operacional\\análise ad hoc\\*demonstração AdhocAnalytics.ps1* em Olá *PowerShell ISE* e hello conjunto os valores a seguir:</span><span class="sxs-lookup"><span data-stu-id="c49fa-170">Open ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* in hello *PowerShell ISE* and set hello following values:</span></span>
   * <span data-ttu-id="c49fa-171">**$DemoScenario** = 2, **Implantar banco de dados de análise Ad hoc**.</span><span class="sxs-lookup"><span data-stu-id="c49fa-171">**$DemoScenario** = 2, **Deploy Ad-hoc analytics database**.</span></span>

2. <span data-ttu-id="c49fa-172">Pressione **F5** toorun Olá script e criar hello *adhocanalytics* banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c49fa-172">Press **F5** toorun hello script and create hello *adhocanalytics* database.</span></span>

<span data-ttu-id="c49fa-173">Na próxima seção, Olá, adicionar o banco de dados do esquema toohello que ela possa ser usada toorun distribuída consultas.</span><span class="sxs-lookup"><span data-stu-id="c49fa-173">In hello next section, you add schema toohello database so it can be used toorun distributed queries.</span></span>

## <a name="configure-hello-database-for-running-distributed-queries"></a><span data-ttu-id="c49fa-174">Configurar Olá banco de dados para executar consultas distribuídas</span><span class="sxs-lookup"><span data-stu-id="c49fa-174">Configure hello database for running distributed queries</span></span>

<span data-ttu-id="c49fa-175">Este exercício adiciona o esquema (fonte de dados externa hello e definições de tabela externa) toohello ad-hoc análise banco de dados que habilita a consulta em todos os bancos de dados de locatário.</span><span class="sxs-lookup"><span data-stu-id="c49fa-175">This exercise adds schema (hello external data source and external table definitions) toohello ad-hoc analytics database that enables querying across all tenant databases.</span></span>

1. <span data-ttu-id="c49fa-176">Abra o SQL Server Management Studio e conecte toohello banco de dados de análise ad hoc que você criou na etapa anterior hello.</span><span class="sxs-lookup"><span data-stu-id="c49fa-176">Open SQL Server Management Studio, and connect toohello Adhoc Analytics database you created in hello previous step.</span></span> <span data-ttu-id="c49fa-177">nome de saudação do banco de dados de saudação será adhocanalytics.</span><span class="sxs-lookup"><span data-stu-id="c49fa-177">hello name of hello database will be adhocanalytics.</span></span>
2. <span data-ttu-id="c49fa-178">Abra ...\Learning Modules\Operational Analytics\Adhoc Analytics\ *Initialize-AdhocAnalyticsDB.sql* no SSMS.</span><span class="sxs-lookup"><span data-stu-id="c49fa-178">Open ...\Learning Modules\Operational Analytics\Adhoc Analytics\ *Initialize-AdhocAnalyticsDB.sql* in SSMS.</span></span>
3. <span data-ttu-id="c49fa-179">Examine o script SQL Olá e observe Olá seguinte:</span><span class="sxs-lookup"><span data-stu-id="c49fa-179">Review hello SQL script and note hello following:</span></span>

   <span data-ttu-id="c49fa-180">Elástica consulta usa uma credencial no escopo do banco de dados tooaccess cada um dos bancos de dados de locatário hello.</span><span class="sxs-lookup"><span data-stu-id="c49fa-180">Elastic Query uses a database-scoped credential tooaccess each of hello tenant databases.</span></span> <span data-ttu-id="c49fa-181">Essa credencial precisa toobe disponível em todos os bancos de dados hello e normalmente deve ser concedida direitos mínimos Olá necessário tooenable essas consultas ad hoc.</span><span class="sxs-lookup"><span data-stu-id="c49fa-181">This credential needs toobe available in all hello databases and should normally be granted hello minimum rights required tooenable these ad-hoc queries.</span></span>

    ![criar credencial](media/sql-database-saas-tutorial-adhoc-analytics/create-credential.png)

   <span data-ttu-id="c49fa-183">Hello fonte de dados externa, que é definido pelo mapa do fragmento toouse Olá locatário no banco de dados de catálogo hello.</span><span class="sxs-lookup"><span data-stu-id="c49fa-183">hello external data source, that is defined toouse hello tenant shard map in hello catalog database.</span></span> <span data-ttu-id="c49fa-184">Usando isso como fonte de dados externa hello, as consultas são bancos de dados distribuído tooall registrados no catálogo de saudação quando Olá consulta for executada.</span><span class="sxs-lookup"><span data-stu-id="c49fa-184">By using this as hello external data source, queries are distributed tooall databases registered in hello catalog when hello query is run.</span></span> <span data-ttu-id="c49fa-185">Como nomes de servidor são diferentes para cada implantação, esse script de inicialização obtém o local de saudação do banco de dados de catálogo Olá recuperando o servidor atual hello (@@servername) onde o script hello é executada.</span><span class="sxs-lookup"><span data-stu-id="c49fa-185">Because server names are different for each deployment, this initialization script gets hello location of hello catalog database by retrieving hello current server (@@servername) where hello script is executed.</span></span>

    ![Criar fonte de dados externa](media/sql-database-saas-tutorial-adhoc-analytics/create-external-data-source.png)

   <span data-ttu-id="c49fa-187">Olá tabelas externas que fazem referência a saudação modos de exibição globais descrito na seção anterior hello e definido com **distribuição = SHARDED(VenueId)**.</span><span class="sxs-lookup"><span data-stu-id="c49fa-187">hello external tables that reference hello global views described in hello previous section, and defined with **DISTRIBUTION = SHARDED(VenueId)**.</span></span> <span data-ttu-id="c49fa-188">Como cada *VenueId* mapeia tooa único banco de dados, isso melhora o desempenho para muitos cenários conforme mostrado na próxima seção, Olá.</span><span class="sxs-lookup"><span data-stu-id="c49fa-188">Because each *VenueId* maps tooa single database, this improves performance for many scenarios as shown in hello next section.</span></span>

    ![criar tabelas externas](media/sql-database-saas-tutorial-adhoc-analytics/external-tables.png)

   <span data-ttu-id="c49fa-190">tabela local Olá *VenueTypes* que é criada e preenchida.</span><span class="sxs-lookup"><span data-stu-id="c49fa-190">hello local table *VenueTypes* that is created and populated.</span></span> <span data-ttu-id="c49fa-191">Essa tabela de dados de referência é comum em todos os bancos de dados de locatário, portanto ele pode ser representado como uma tabela local e preenchida com dados comuns hello.</span><span class="sxs-lookup"><span data-stu-id="c49fa-191">This reference data table is common in all tenant databases, so it can be represented here as a local table and populated with hello common data.</span></span> <span data-ttu-id="c49fa-192">Para algumas consultas que isso pode reduzir Olá quantidade de dados movidos entre bancos de dados de locatário hello e hello *adhocanalytics* banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c49fa-192">For some queries this may reduce hello amount of data moved between hello tenant databases and hello *adhocanalytics* database.</span></span>

    ![criar tabela](media/sql-database-saas-tutorial-adhoc-analytics/create-table.png)

   <span data-ttu-id="c49fa-194">Se você incluir tabelas de referência dessa maneira, ser dados e o esquema da tabela Olá tooupdate-se de que sempre que você atualizar bancos de dados de locatário hello.</span><span class="sxs-lookup"><span data-stu-id="c49fa-194">If you include reference tables in this manner, be sure tooupdate hello table schema and data whenever you update hello tenant databases.</span></span>

4. <span data-ttu-id="c49fa-195">Pressione **F5** toorun Olá script e inicializar Olá *adhocanalytics* banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c49fa-195">Press **F5** toorun hello script and initialize hello *adhocanalytics* database.</span></span> 

<span data-ttu-id="c49fa-196">Agora você pode executar consultas distribuídas e reunir informações entre todos os locatários!</span><span class="sxs-lookup"><span data-stu-id="c49fa-196">Now you can run distributed queries, and gather insights across all tenants!</span></span>

## <a name="run-ad-hoc-distributed-queries"></a><span data-ttu-id="c49fa-197">Executar consultas distribuídas ad hoc</span><span class="sxs-lookup"><span data-stu-id="c49fa-197">Run ad-hoc distributed queries</span></span>

<span data-ttu-id="c49fa-198">Agora que Olá *adhocanalytics* banco de dados está configurado, vá em frente e execute algumas consultas distribuídas.</span><span class="sxs-lookup"><span data-stu-id="c49fa-198">Now that hello *adhocanalytics* database is set up, go ahead and run some distributed queries.</span></span> <span data-ttu-id="c49fa-199">Inclua plano de execução de saudação para melhor compreender onde o processamento de consulta hello está acontecendo.</span><span class="sxs-lookup"><span data-stu-id="c49fa-199">Include hello execution plan for a better understanding of where hello query processing is happening.</span></span> 

<span data-ttu-id="c49fa-200">Ao inspecionar o plano de execução hello, passe o mouse sobre os ícones de plano Olá para obter detalhes.</span><span class="sxs-lookup"><span data-stu-id="c49fa-200">When inspecting hello execution plan, hover over hello plan icons for details.</span></span> 

<span data-ttu-id="c49fa-201">Toonote importante, é a configuração **distribuição = SHARDED(VenueId)** quando definimos fonte de dados externa hello, melhora o desempenho para muitos cenários.</span><span class="sxs-lookup"><span data-stu-id="c49fa-201">Important toonote, is that setting **DISTRIBUTION = SHARDED(VenueId)** when we defined hello external data source, improves performance for many scenarios.</span></span> <span data-ttu-id="c49fa-202">Como cada *VenueId* mapeia tooa único banco de dados, a filtragem é dados facilmente concluído remotamente, retornando Olá somente é necessário.</span><span class="sxs-lookup"><span data-stu-id="c49fa-202">Because each *VenueId* maps tooa single database, filtering is easily done remotely, returning only hello data we need.</span></span>

1. <span data-ttu-id="c49fa-203">Abra... \\Módulos de Aprendizado\\Análise Operacional\\Análise Ad Hoc\\*Demo-AdhocAnalyticsQueries.sql* no SSMS.</span><span class="sxs-lookup"><span data-stu-id="c49fa-203">Open ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalyticsQueries.sql* in SSMS.</span></span>
2. <span data-ttu-id="c49fa-204">Certifique-se de que você está conectado toohello **adhocanalytics** banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c49fa-204">Ensure you are connected toohello **adhocanalytics** database.</span></span>
3. <span data-ttu-id="c49fa-205">Selecione Olá **consulta** menu e clique em **incluir plano de execução real**</span><span class="sxs-lookup"><span data-stu-id="c49fa-205">Select hello **Query** menu and click **Include Actual Execution Plan**</span></span>
4. <span data-ttu-id="c49fa-206">Realçar Olá *quais locais são registrados no momento?* consulta e pressione **F5**.</span><span class="sxs-lookup"><span data-stu-id="c49fa-206">Highlight hello *Which venues are currently registered?* query, and press **F5**.</span></span>

   <span data-ttu-id="c49fa-207">consulta de saudação retorna a lista de local inteiro de hello, ilustrando como rápido e é fácil tooquery em todos os locatários e retornar dados de cada locatário.</span><span class="sxs-lookup"><span data-stu-id="c49fa-207">hello query returns hello entire venue list, illustrating how quick and easy it is tooquery across all tenants and return data from each tenant.</span></span>

   <span data-ttu-id="c49fa-208">Inspecionar o plano de saudação e vê que o custo total por Olá é consulta remota Olá porque estamos simplesmente o banco de dados de locatário de tooeach contínuo e selecionando informações de local de saudação.</span><span class="sxs-lookup"><span data-stu-id="c49fa-208">Inspect hello plan and see that hello entire cost is hello remote query because we're simply going tooeach tenant database and selecting hello venue information.</span></span>

   ![SELECT * FROM dbo.Venues](media/sql-database-saas-tutorial-adhoc-analytics/query1-plan.png)

5. <span data-ttu-id="c49fa-210">Consulta seguinte Olá selecione e pressione **F5**.</span><span class="sxs-lookup"><span data-stu-id="c49fa-210">Select hello next query, and press **F5**.</span></span>

   <span data-ttu-id="c49fa-211">Essa consulta une dados de bancos de dados de locatário hello e Olá local *VenueTypes* tabela (local, como ela é uma tabela em Olá *adhocanalytics* banco de dados).</span><span class="sxs-lookup"><span data-stu-id="c49fa-211">This query joins data from hello tenant databases and hello local *VenueTypes* table (local, as its a table in hello *adhocanalytics* database).</span></span>

   <span data-ttu-id="c49fa-212">Inspecionar plano hello e ver que Olá maioria de custo é consulta remota Olá porque estamos consultar informações de local de cada locatário (dbo. Locais), e, em seguida, faça uma junção de local rápida com hello local *VenueTypes* nome amigável da tabela toodisplay hello.</span><span class="sxs-lookup"><span data-stu-id="c49fa-212">Inspect hello plan and see that hello majority of cost is hello remote query because we query each tenant's venue info (dbo.Venues), and then do a quick local join with hello local *VenueTypes* table toodisplay hello friendly name.</span></span>

   ![Unir dados remotos e locais](media/sql-database-saas-tutorial-adhoc-analytics/query2-plan.png)

6. <span data-ttu-id="c49fa-214">Agora selecione Olá *em qual dia foram Olá a maioria dos tíquetes vendidas?* consulta e pressione **F5**.</span><span class="sxs-lookup"><span data-stu-id="c49fa-214">Now select hello *On which day were hello most tickets sold?* query, and press **F5**.</span></span>

   <span data-ttu-id="c49fa-215">Essa consulta faz uma união e uma agregação um pouco mais complexas.</span><span class="sxs-lookup"><span data-stu-id="c49fa-215">This query does a bit more complex joining and aggregation.</span></span> <span data-ttu-id="c49fa-216">O que é toonote importante é que a maioria do processamento de saudação é feita remotamente, e novamente, estamos trazer de volta somente as linhas Olá que necessária, retornando apenas uma única linha para contagem de venda de tíquete de agregação de cada local por dia.</span><span class="sxs-lookup"><span data-stu-id="c49fa-216">What's important toonote is that most of hello processing is done remotely, and once again, we bring back only hello rows we need, returning just a single row for each venue's aggregate ticket sale count per day.</span></span>

   ![query](media/sql-database-saas-tutorial-adhoc-analytics/query3-plan.png)


## <a name="next-steps"></a><span data-ttu-id="c49fa-218">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="c49fa-218">Next steps</span></span>

<span data-ttu-id="c49fa-219">Neste tutorial, você aprendeu a:</span><span class="sxs-lookup"><span data-stu-id="c49fa-219">In this tutorial you learned how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="c49fa-220">Executar consultas distribuídas entre todos os bancos de dados de locatário</span><span class="sxs-lookup"><span data-stu-id="c49fa-220">Run distributed queries across all tenant databases</span></span>
> * <span data-ttu-id="c49fa-221">Implantar um banco de dados de análise ad hoc e adicionar esquema tooit toorun distribuída consultas.</span><span class="sxs-lookup"><span data-stu-id="c49fa-221">Deploy an ad-hoc analytics database and add schema tooit toorun distributed queries.</span></span>


<span data-ttu-id="c49fa-222">Agora tente Olá [tutorial de análise de locatário](sql-database-saas-tutorial-tenant-analytics.md) tooexplore extrair o banco de dados do data tooa análise separada para o processamento de análise mais complexo...</span><span class="sxs-lookup"><span data-stu-id="c49fa-222">Now try hello [Tenant Analytics tutorial](sql-database-saas-tutorial-tenant-analytics.md) tooexplore extracting data tooa separate analytics database for more complex analytics processing...</span></span>

## <a name="additional-resources"></a><span data-ttu-id="c49fa-223">Recursos adicionais</span><span class="sxs-lookup"><span data-stu-id="c49fa-223">Additional resources</span></span>

* <span data-ttu-id="c49fa-224">Adicionais [tutoriais que se baseiam na Olá aplicativo SaaS Wingtip](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span><span class="sxs-lookup"><span data-stu-id="c49fa-224">Additional [tutorials that build upon hello Wingtip SaaS application](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span></span>
* [<span data-ttu-id="c49fa-225">Consulta elástica</span><span class="sxs-lookup"><span data-stu-id="c49fa-225">Elastic Query</span></span>](sql-database-elastic-query-overview.md)
