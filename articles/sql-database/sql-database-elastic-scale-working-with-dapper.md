---
title: "Usando a biblioteca de cliente de banco de dados elástico com o Dapper | Microsoft Docs"
description: "Usar a biblioteca de cliente de banco de dados elástico com Dapper."
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
ms.assetid: 463d2676-3b19-47c2-83df-f8c50492c9d2
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/27/2016
ms.author: torsteng
ms.openlocfilehash: f0efd37a39c1a60eee7b47304483c27727ca8833
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="using-elastic-database-client-library-with-dapper"></a><span data-ttu-id="b1401-103">Usando a biblioteca de cliente do banco de dados elástico com Dapper</span><span class="sxs-lookup"><span data-stu-id="b1401-103">Using elastic database client library with Dapper</span></span>
<span data-ttu-id="b1401-104">Este documento é destinado aos desenvolvedores que usam Dapper na criação de aplicativos, mas que também desejam adotar as [ferramentas de banco de dados elástico](sql-database-elastic-scale-introduction.md) para criar aplicativos de aplicativos que implementam a fragmentação para escalar horizontalmente sua camada de dados.</span><span class="sxs-lookup"><span data-stu-id="b1401-104">This document is for developers that rely on Dapper to build applications, but also want to embrace [elastic database tooling](sql-database-elastic-scale-introduction.md) to create applications that implement sharding to scale-out their data tier.</span></span>  <span data-ttu-id="b1401-105">Este documento ilustra as alterações em aplicativos baseados em Dapper que são necessários para integrar as ferramentas de banco de dados elástico.</span><span class="sxs-lookup"><span data-stu-id="b1401-105">This document illustrates the changes in Dapper-based applications that are necessary to integrate with elastic database tools.</span></span> <span data-ttu-id="b1401-106">Nosso foco é em criar o gerenciamento de fragmento de banco de dados elástico e roteamento dependente de dados com o Dapper.</span><span class="sxs-lookup"><span data-stu-id="b1401-106">Our focus is on composing the elastic database shard management and data dependent routing with Dapper.</span></span> 

<span data-ttu-id="b1401-107">**Código de exemplo**: [ferramentas de banco de dados elástico para o Banco de Dados SQL do Azure - integração com o Dapper](https://code.msdn.microsoft.com/Elastic-Scale-with-Azure-e19fc77f).</span><span class="sxs-lookup"><span data-stu-id="b1401-107">**Sample Code**: [Elastic database tools for Azure SQL Database - Dapper integration](https://code.msdn.microsoft.com/Elastic-Scale-with-Azure-e19fc77f).</span></span>

<span data-ttu-id="b1401-108">É muito fácil integrar o **Dapper** e **DapperExtensions** com a biblioteca de cliente de banco de dados elástico do Banco de Dados SQL do Azure.</span><span class="sxs-lookup"><span data-stu-id="b1401-108">Integrating **Dapper** and **DapperExtensions** with the elastic database client library for Azure SQL Database is easy.</span></span> <span data-ttu-id="b1401-109">Seus aplicativos podem usar roteamento dependente de dados alterando a criação e abertura de novos objetos [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) para usar a chamada [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) na [biblioteca de cliente](http://msdn.microsoft.com/library/azure/dn765902.aspx).</span><span class="sxs-lookup"><span data-stu-id="b1401-109">Your applications can use data dependent routing by changing the creation and opening of new [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects to use the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call from the [client library](http://msdn.microsoft.com/library/azure/dn765902.aspx).</span></span> <span data-ttu-id="b1401-110">Isso limita as alterações em seu aplicativo apenas quando novas conexões forem criadas e abertas.</span><span class="sxs-lookup"><span data-stu-id="b1401-110">This limits changes in your application to only where new connections are created and opened.</span></span> 

## <a name="dapper-overview"></a><span data-ttu-id="b1401-111">Visão geral do Dapper</span><span class="sxs-lookup"><span data-stu-id="b1401-111">Dapper overview</span></span>
<span data-ttu-id="b1401-112">**Dapper** é um mapeador relacional de objetos.</span><span class="sxs-lookup"><span data-stu-id="b1401-112">**Dapper** is an object-relational mapper.</span></span> <span data-ttu-id="b1401-113">Ele mapeia objetos .NET a partir de seu aplicativo para um banco de dados relacional (e vice-versa).</span><span class="sxs-lookup"><span data-stu-id="b1401-113">It maps .NET objects from your application to a relational database (and vice versa).</span></span> <span data-ttu-id="b1401-114">A primeira parte do código de exemplo ilustra como você pode integrar a biblioteca de cliente do banco de dados elástico com aplicativos baseados em Dapper.</span><span class="sxs-lookup"><span data-stu-id="b1401-114">The first part of the sample code illustrates how you can integrate the elastic database client library with Dapper-based applications.</span></span> <span data-ttu-id="b1401-115">A segunda parte do código de exemplo ilustra como integrar ao usar o Dapper e as DapperExtensions.</span><span class="sxs-lookup"><span data-stu-id="b1401-115">The second part of the sample code illustrates how to integrate when using both Dapper and DapperExtensions.</span></span>  

<span data-ttu-id="b1401-116">A funcionalidade do mapeador em Dapper fornece métodos de extensão em conexões de banco de dados que simplificam o envio de instruções T-SQL para execução ou consulta ao banco de dados.</span><span class="sxs-lookup"><span data-stu-id="b1401-116">The mapper functionality in Dapper provides extension methods on database connections that simplify submitting T-SQL statements for execution or querying the database.</span></span> <span data-ttu-id="b1401-117">Por exemplo, o Dapper torna mais fácil mapear entre seus objetos .NET e os parâmetros de instruções SQL por chamadas **Execute** ou para consumir os resultados de suas consultas SQL em objetos .NET usando chamadas **Query** no Dapper.</span><span class="sxs-lookup"><span data-stu-id="b1401-117">For instance, Dapper makes it easy to map between your .NET objects and the parameters of SQL statements for **Execute** calls, or to consume the results of your SQL queries into .NET objects using **Query** calls from Dapper.</span></span> 

<span data-ttu-id="b1401-118">Ao usar DapperExtensions, você não precisa fornecer as instruções SQL.</span><span class="sxs-lookup"><span data-stu-id="b1401-118">When using DapperExtensions, you no longer need to provide the SQL statements.</span></span> <span data-ttu-id="b1401-119">Métodos de extensão, como **GetList** ou **Insert** através da conexão de banco de dados cria as instruções SQL nos bastidores.</span><span class="sxs-lookup"><span data-stu-id="b1401-119">Extensions methods such as **GetList** or **Insert** over the database connection create the SQL statements behind the scenes.</span></span>

<span data-ttu-id="b1401-120">Outro benefício do Dapper e também das DapperExtensions é que o aplicativo controla a criação da conexão de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="b1401-120">Another benefit of Dapper and also DapperExtensions is that the application controls the creation of the database connection.</span></span> <span data-ttu-id="b1401-121">Isso ajuda a interagir com a biblioteca de cliente de banco de dados elástico que intermedia as conexões com base no mapeamento de shardlets para bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="b1401-121">This helps interact with the elastic database client library which brokers database connections based on the mapping of shardlets to databases.</span></span>

<span data-ttu-id="b1401-122">Para obter os assemblies do Dapper, consulte [Dapper dot net](http://www.nuget.org/packages/Dapper/).</span><span class="sxs-lookup"><span data-stu-id="b1401-122">To get the Dapper assemblies, see [Dapper dot net](http://www.nuget.org/packages/Dapper/).</span></span> <span data-ttu-id="b1401-123">Para ver as extensões do Dapper, consulte [DapperExtensions](http://www.nuget.org/packages/DapperExtensions).</span><span class="sxs-lookup"><span data-stu-id="b1401-123">For the Dapper extensions, see [DapperExtensions](http://www.nuget.org/packages/DapperExtensions).</span></span>

## <a name="a-quick-look-at-the-elastic-database-client-library"></a><span data-ttu-id="b1401-124">Uma olhada rápida pela biblioteca de cliente de banco de dados elástico</span><span class="sxs-lookup"><span data-stu-id="b1401-124">A quick Look at the elastic database client library</span></span>
<span data-ttu-id="b1401-125">Com a biblioteca de cliente do banco de dados elástico, você definir partições de dados do aplicativo chamados *shardlets*, mapeá-las para bancos de dados e identificá-las por *chaves de fragmentação*.</span><span class="sxs-lookup"><span data-stu-id="b1401-125">With the elastic database client library, you define partitions of your application data called *shardlets* , map them to databases, and identify them by *sharding keys*.</span></span> <span data-ttu-id="b1401-126">Você pode ter quantos bancos de dados conforme necessário e distribuir seu shardlets entre esses bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="b1401-126">You can have as many databases as you need and distribute your shardlets across these databases.</span></span> <span data-ttu-id="b1401-127">O mapeamento de valores chave de fragmentação para os bancos de dados é armazenado por um mapa de fragmentos fornecido pelas APIs da biblioteca.</span><span class="sxs-lookup"><span data-stu-id="b1401-127">The mapping of sharding key values to the databases is stored by a shard map provided by the library’s APIs.</span></span> <span data-ttu-id="b1401-128">Essa funcionalidade é chamada de **gerenciamento de mapa de fragmentos**.</span><span class="sxs-lookup"><span data-stu-id="b1401-128">This capability is called **shard map management**.</span></span> <span data-ttu-id="b1401-129">O mapa do fragmento também serve como o agente de conexões de banco de dados para solicitações que carregam uma chave de fragmentação.</span><span class="sxs-lookup"><span data-stu-id="b1401-129">The shard map also serves as the broker of database connections for requests that carry a sharding key.</span></span> <span data-ttu-id="b1401-130">Essa funcionalidade é conhecida como **Roteamento dependente de dados**.</span><span class="sxs-lookup"><span data-stu-id="b1401-130">This capability is referred to as **data dependent routing**.</span></span>

![Mapas de fragmentos e roteamento dependente de dados][1]

<span data-ttu-id="b1401-132">O gerenciador de mapa de fragmentos protege os usuários contra exibições inconsistentes em dados de shardlet que podem ocorrer quando as operações de gerenciamento simultâneo de shardlet ocorrem nos bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="b1401-132">The shard map manager protects users from inconsistent views into shardlet data that can occur when concurrent shardlet management operations are happening on the databases.</span></span> <span data-ttu-id="b1401-133">Para fazer isso, os mapas de fragmento intermediam as conexões de banco de dados para um aplicativo criado com a biblioteca.</span><span class="sxs-lookup"><span data-stu-id="b1401-133">To do so, the shard maps broker the database connections for an application built with the library.</span></span> <span data-ttu-id="b1401-134">Quando as operações de gerenciamento de fragmentação podem afetar o shardlet, isso permite que a funcionalidade de mapa do fragmento elimine automaticamente uma conexão de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="b1401-134">When shard management operations could impact the shardlet, this allows the shard map functionality to automatically kill a database connection.</span></span> 

<span data-ttu-id="b1401-135">Em vez de usar a maneira tradicional de criar conexões para Dapper, precisamos usar o método [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn824099.aspx).</span><span class="sxs-lookup"><span data-stu-id="b1401-135">Instead of using the traditional way to create connections for Dapper, we need to use the [OpenConnectionForKey method](http://msdn.microsoft.com/library/azure/dn824099.aspx).</span></span> <span data-ttu-id="b1401-136">Isso garante que todos as validações ocorram e as conexões são gerenciadas corretamente quando os dados se movem entre os fragmentos.</span><span class="sxs-lookup"><span data-stu-id="b1401-136">This ensures that all the validation takes place and connections are managed properly when any data moves between shards.</span></span>

### <a name="requirements-for-dapper-integration"></a><span data-ttu-id="b1401-137">Requisitos para a integração do Dapper</span><span class="sxs-lookup"><span data-stu-id="b1401-137">Requirements for Dapper integration</span></span>
<span data-ttu-id="b1401-138">Ao trabalhar com a biblioteca de cliente do banco de dados elástico e de APIs do Dapper, queremos manter as seguintes propriedades:</span><span class="sxs-lookup"><span data-stu-id="b1401-138">When working with both the elastic database client library and the Dapper APIs, we want to retain the following properties:</span></span>

* <span data-ttu-id="b1401-139">**Escala horizontal**: queremos adicionar ou remover bancos de dados da camada de dados do aplicativo fragmentado, conforme necessário para as demandas de capacidade do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="b1401-139">**Scaleout**: We want to add or remove databases from the data tier of the sharded application as necessary for the capacity demands of the application.</span></span> 
* <span data-ttu-id="b1401-140">**Consistência**: como nosso aplicativo é dimensionado com o uso de fragmentação, precisamos executar roteamento dependente de dados.</span><span class="sxs-lookup"><span data-stu-id="b1401-140">**Consistency**: Since our application is scaled out using sharding, we need to perform data dependent routing.</span></span> <span data-ttu-id="b1401-141">Queremos usar os recursos de roteamento dependentes de dados da biblioteca para fazer isso.</span><span class="sxs-lookup"><span data-stu-id="b1401-141">We want to use the Data dependent routing capabilities of the library to do so.</span></span> <span data-ttu-id="b1401-142">Queremos reter especialmente a validação e garantir a consistência fornecida pelas conexões intermediadas por meio do gerenciador de mapa de fragmentos para evitar corrompimento ou resultados de consulta incorretos.</span><span class="sxs-lookup"><span data-stu-id="b1401-142">In particular, we want to retain the validation and consistency guarantees provided by connections that are brokered through the shard map manager in order to avoid corruption or wrong query results.</span></span> <span data-ttu-id="b1401-143">Isso garante que conexões para um determinado shardlet sejam rejeitadas ou interrompidas se (por exemplo) o shardlet é movido num momento para um fragmento diferente usando APIs de divisão/mesclagem.</span><span class="sxs-lookup"><span data-stu-id="b1401-143">This ensures that connections to a given shardlet are rejected or stopped if (for instance) the shardlet is currently moved to a different shard using Split/Merge APIs.</span></span>
* <span data-ttu-id="b1401-144">**Mapeamento de objetos**: queremos manter a conveniência dos mapeamentos fornecidos pelo Dapper para converter entre classes no aplicativo e as estruturas de banco de dados subjacente.</span><span class="sxs-lookup"><span data-stu-id="b1401-144">**Object Mapping**: We want to retain the convenience of the mappings provided by Dapper to translate between classes in the application and the underlying database structures.</span></span> 

<span data-ttu-id="b1401-145">A seção a seguir fornece diretrizes para esses requisitos de aplicativos com base em **Dapper** e **DapperExtensions**.</span><span class="sxs-lookup"><span data-stu-id="b1401-145">The following section provides guidance for these requirements for applications based on **Dapper** and **DapperExtensions**.</span></span>

## <a name="technical-guidance"></a><span data-ttu-id="b1401-146">Orientações técnicas</span><span class="sxs-lookup"><span data-stu-id="b1401-146">Technical Guidance</span></span>
### <a name="data-dependent-routing-with-dapper"></a><span data-ttu-id="b1401-147">Roteamento dependente de dados com Dapper</span><span class="sxs-lookup"><span data-stu-id="b1401-147">Data dependent routing with Dapper</span></span>
<span data-ttu-id="b1401-148">Com Dapper, o aplicativo é geralmente responsável por criar e abrir as conexões de banco de dados subjacente.</span><span class="sxs-lookup"><span data-stu-id="b1401-148">With Dapper, the application is typically responsible for creating and opening the connections to the underlying database.</span></span> <span data-ttu-id="b1401-149">Fornecendo um tipo T pelo aplicativo, o Dapper retorna resultados da consulta como coleções .NET do tipo T. O Dapper executa o mapeamento das linhas de resultado do T-SQL para os objetos do tipo T. Da mesma forma, o Dapper mapeia objetos .NET em valores ou parâmetros SQL para instruções de linguagem de manipulação de dados (DML).</span><span class="sxs-lookup"><span data-stu-id="b1401-149">Given a type T by the application, Dapper returns query results as .NET collections of type T. Dapper performs the mapping from the T-SQL result rows to the objects of type T. Similarly, Dapper maps .NET objects into SQL values or parameters for data manipulation language (DML) statements.</span></span> <span data-ttu-id="b1401-150">O Dapper oferece essa funcionalidade por meio de métodos de extensão no objeto [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) normal por meio de bibliotecas do Cliente SQL do ADO .NET.</span><span class="sxs-lookup"><span data-stu-id="b1401-150">Dapper offers this functionality via extension methods on the regular [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) object from the ADO .NET SQL Client libraries.</span></span> <span data-ttu-id="b1401-151">A conexão do SQL retornada por APIs de escala elástica para DDR também são objetos regulares da [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx).</span><span class="sxs-lookup"><span data-stu-id="b1401-151">The SQL connection returned by the Elastic Scale APIs for DDR are also regular [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects.</span></span> <span data-ttu-id="b1401-152">Isso nos permite usar extensões Dapper diretamente no tipo retornado pela API de DDR da biblioteca de cliente, pois ele também é uma conexão SQL Client simples.</span><span class="sxs-lookup"><span data-stu-id="b1401-152">This allows us to directly use Dapper extensions over the type returned by the client library’s DDR API, as it is also a simple SQL Client connection.</span></span>

<span data-ttu-id="b1401-153">Essas observações simplificam o uso de conexões intermediadas pela biblioteca de cliente de banco de dados elástico para Dapper.</span><span class="sxs-lookup"><span data-stu-id="b1401-153">These observations make it straightforward to use connections brokered by the elastic database client library for Dapper.</span></span>

<span data-ttu-id="b1401-154">Este exemplo de código (do exemplo que acompanha este artigo) ilustra a abordagem em que a chave de fragmentação é fornecida pelo aplicativo para a biblioteca para intermediar a conexão para o fragmento correto.</span><span class="sxs-lookup"><span data-stu-id="b1401-154">This code example (from the accompanying sample) illustrates the approach where the sharding key is provided by the application to the library to broker the connection to the right shard.</span></span>   

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                     key: tenantId1, 
                     connectionString: connStrBldr.ConnectionString, 
                     options: ConnectionOptions.Validate))
    {
        var blog = new Blog { Name = name };
        sqlconn.Execute(@"
                      INSERT INTO
                            Blog (Name)
                            VALUES (@name)", new { name = blog.Name }
                        );
    }

<span data-ttu-id="b1401-155">A chamada para a API [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) substitui a criação e a abertura padrão de uma conexão de cliente SQL.</span><span class="sxs-lookup"><span data-stu-id="b1401-155">The call to the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) API replaces the default creation and opening of a SQL Client connection.</span></span> <span data-ttu-id="b1401-156">A chamada [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) usa os argumentos que são necessários para roteamento dependente de dados com escala elástica:</span><span class="sxs-lookup"><span data-stu-id="b1401-156">The [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call takes the arguments that are required for data dependent routing:</span></span> 

* <span data-ttu-id="b1401-157">o mapa do fragmento para acessar as interfaces de roteamento dependente de dados</span><span class="sxs-lookup"><span data-stu-id="b1401-157">The shard map to access the data dependent routing interfaces</span></span>
* <span data-ttu-id="b1401-158">a chave de fragmentação para identificar o shardlet</span><span class="sxs-lookup"><span data-stu-id="b1401-158">The sharding key to identify the shardlet</span></span>
* <span data-ttu-id="b1401-159">as credenciais (nome de usuário e senha) para conectar-se ao fragmento</span><span class="sxs-lookup"><span data-stu-id="b1401-159">The credentials (user name and password) to connect to the shard</span></span>

<span data-ttu-id="b1401-160">o objeto do mapa do fragmento cria uma conexão para o fragmento que mantém o shardlet para a chave de fragmentação determinada.</span><span class="sxs-lookup"><span data-stu-id="b1401-160">The shard map object creates a connection to the shard that holds the shardlet for the given sharding key.</span></span> <span data-ttu-id="b1401-161">As APIs de cliente do banco de dados elástico também marca a conexão para implementar suas garantias de consistência.</span><span class="sxs-lookup"><span data-stu-id="b1401-161">The elastic database client APIs also tag the connection to implement its consistency guarantees.</span></span> <span data-ttu-id="b1401-162">Uma vez que a chamada para [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) retorna um objeto de conexão do Cliente SQL regular, a chamada subsequente para o método de extensão **Execute** do Dapper segue a prática padrão do Dapper.</span><span class="sxs-lookup"><span data-stu-id="b1401-162">Since the call to [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) returns a regular SQL Client connection object, the subsequent call to the **Execute** extension method from Dapper follows the standard Dapper practice.</span></span>

<span data-ttu-id="b1401-163">As consultas funcionam praticamente da mesma forma — você primeiro abre a conexão usando [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) na API do cliente.</span><span class="sxs-lookup"><span data-stu-id="b1401-163">Queries work very much the same way - you first open the connection using [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) from the client API.</span></span> <span data-ttu-id="b1401-164">Em seguida, você deve usar os métodos de extensão Dapper regulares para mapear os resultados da consulta SQL nos objetos .NET:</span><span class="sxs-lookup"><span data-stu-id="b1401-164">Then you use the regular Dapper extension methods to map the results of your SQL query into .NET objects:</span></span>

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId1, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate ))
    {    
           // Display all Blogs for tenant 1
           IEnumerable<Blog> result = sqlconn.Query<Blog>(@"
                                SELECT * 
                                FROM Blog
                                ORDER BY Name");

           Console.WriteLine("All blogs for tenant id {0}:", tenantId1);
           foreach (var item in result)
           {
                Console.WriteLine(item.Name);
            }
    }

<span data-ttu-id="b1401-165">Observe que o bloco **using** com a conexão DDR abrange todas as operações de banco de dados dentro do bloco para o único fragmento em que tenantId1 é mantido.</span><span class="sxs-lookup"><span data-stu-id="b1401-165">Note that the **using** block with the DDR connection scopes all database operations within the block to the one shard where tenantId1 is kept.</span></span> <span data-ttu-id="b1401-166">A consulta retorna apenas os blogs armazenados no fragmento atual, mas não os arquivos armazenados em quaisquer outros fragmentos.</span><span class="sxs-lookup"><span data-stu-id="b1401-166">The query only returns blogs stored on the current shard, but not the ones stored on any other shards.</span></span> 

## <a name="data-dependent-routing-with-dapper-and-dapperextensions"></a><span data-ttu-id="b1401-167">Roteamento dependente de dados com Dapper e DapperExtensions</span><span class="sxs-lookup"><span data-stu-id="b1401-167">Data dependent routing with Dapper and DapperExtensions</span></span>
<span data-ttu-id="b1401-168">O Dapper vem com um ecossistema de extensões adicionais que podem fornecer mais conveniência e abstração do banco de dados ao desenvolver aplicativos de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="b1401-168">Dapper comes with an ecosystem of additional extensions that can provide further convenience and abstraction from the database when developing database applications.</span></span> <span data-ttu-id="b1401-169">O DapperExtensions é um exemplo.</span><span class="sxs-lookup"><span data-stu-id="b1401-169">DapperExtensions is an example.</span></span> 

<span data-ttu-id="b1401-170">O uso do DapperExtensions em seu aplicativo não muda como conexões de banco de dados são criadas e gerenciadas.</span><span class="sxs-lookup"><span data-stu-id="b1401-170">Using DapperExtensions in your application does not change how database connections are created and managed.</span></span> <span data-ttu-id="b1401-171">Ainda é responsabilidade do aplicativo abrir conexões, e objetos de conexão do Cliente SQL regulares são aguardados pelos métodos de extensão.</span><span class="sxs-lookup"><span data-stu-id="b1401-171">It is still the application’s responsibility to open connections, and regular SQL Client connection objects are expected by the extension methods.</span></span> <span data-ttu-id="b1401-172">Podemos usar a [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) conforme descrito acima.</span><span class="sxs-lookup"><span data-stu-id="b1401-172">We can rely on the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) as outlined above.</span></span> <span data-ttu-id="b1401-173">Como mostram os exemplos de código a seguir, a única alteração é que não temos de escrever as instruções T-SQL:</span><span class="sxs-lookup"><span data-stu-id="b1401-173">As the following code samples show, the only change is that we do no longer have to write the T-SQL statements:</span></span>

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId2, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate))
    {
           var blog = new Blog { Name = name2 };
           sqlconn.Insert(blog);
    }

<span data-ttu-id="b1401-174">E aqui está o exemplo de código para a consulta:</span><span class="sxs-lookup"><span data-stu-id="b1401-174">And here is the code sample for the query:</span></span> 

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId2, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate))
    {
           // Display all Blogs for tenant 2
           IEnumerable<Blog> result = sqlconn.GetList<Blog>();
           Console.WriteLine("All blogs for tenant id {0}:", tenantId2);
           foreach (var item in result)
           {
               Console.WriteLine(item.Name);
           }
    }

### <a name="handling-transient-faults"></a><span data-ttu-id="b1401-175">Tratamento de falhas transitórias</span><span class="sxs-lookup"><span data-stu-id="b1401-175">Handling transient faults</span></span>
<span data-ttu-id="b1401-176">A equipe Microsoft Patterns & Practices publicou o [Bloco de aplicativos de tratamento de falhas transitórias](http://msdn.microsoft.com/library/hh680934.aspx) para ajudar os desenvolvedores de aplicativos a atenuarem condições de falha transitória comuns encontradas durante a execução na nuvem.</span><span class="sxs-lookup"><span data-stu-id="b1401-176">The Microsoft Patterns & Practices team published the [Transient Fault Handling Application Block](http://msdn.microsoft.com/library/hh680934.aspx) to help application developers mitigate common transient fault conditions encountered when running in the cloud.</span></span> <span data-ttu-id="b1401-177">Para obter mais informações, consulte [Perseverança, segredo de todos os triunfos: usando o bloco de aplicativos de tratamento de falhas temporárias](http://msdn.microsoft.com/library/dn440719.aspx).</span><span class="sxs-lookup"><span data-stu-id="b1401-177">For more information, see [Perseverance, Secret of All Triumphs: Using the Transient Fault Handling Application Block](http://msdn.microsoft.com/library/dn440719.aspx).</span></span>

<span data-ttu-id="b1401-178">O código de exemplo se baseia na biblioteca de falha transitória para proteger contra falhas transitórias.</span><span class="sxs-lookup"><span data-stu-id="b1401-178">The code sample relies on the transient fault library to protect against transient faults.</span></span> 

    SqlDatabaseUtils.SqlRetryPolicy.ExecuteAction(() =>
    {
       using (SqlConnection sqlconn = 
          shardingLayer.ShardMap.OpenConnectionForKey(tenantId2, connStrBldr.ConnectionString, ConnectionOptions.Validate))
          {
              var blog = new Blog { Name = name2 };
              sqlconn.Insert(blog);
          }
    });

<span data-ttu-id="b1401-179">**SqlDatabaseUtils.SqlRetryPolicy** no código acima é definido como um **SqlDatabaseTransientErrorDetectionStrategy** com uma contagem de repetições de 10, com tempo de espera de 5 segundos entre as tentativas.</span><span class="sxs-lookup"><span data-stu-id="b1401-179">**SqlDatabaseUtils.SqlRetryPolicy** in the code above is defined as a **SqlDatabaseTransientErrorDetectionStrategy** with a retry count of 10, and 5 seconds wait time between retries.</span></span> <span data-ttu-id="b1401-180">Se você estiver usando transações, certifique-se de que o escopo de repetição volta para o início da transação no caso de uma falha temporária.</span><span class="sxs-lookup"><span data-stu-id="b1401-180">If you are using transactions, make sure that your retry scope goes back to the beginning of the transaction in the case of a transient fault.</span></span>

## <a name="limitations"></a><span data-ttu-id="b1401-181">Limitações</span><span class="sxs-lookup"><span data-stu-id="b1401-181">Limitations</span></span>
<span data-ttu-id="b1401-182">As abordagens descritas neste documento envolvem algumas limitações:</span><span class="sxs-lookup"><span data-stu-id="b1401-182">The approaches outlined in this document entail a couple of limitations:</span></span>

* <span data-ttu-id="b1401-183">O código de exemplo para este documento demonstra como gerenciar o esquema em fragmentos.</span><span class="sxs-lookup"><span data-stu-id="b1401-183">The sample code for this document does not demonstrate how to manage schema across shards.</span></span>
* <span data-ttu-id="b1401-184">Recebida uma solicitação, pressupomos que todo o processamento de seu banco de dados está contido em um único fragmento como identificado pela chave de fragmentação fornecida pela solicitação.</span><span class="sxs-lookup"><span data-stu-id="b1401-184">Given a request, we assume that all its database processing is contained within a single shard as identified by the sharding key provided by the request.</span></span> <span data-ttu-id="b1401-185">No entanto, esse pressuposto não é sempre mantido, por exemplo, quando não é possível disponibilizar uma chave de fragmentação.</span><span class="sxs-lookup"><span data-stu-id="b1401-185">However, this assumption does not always hold, for example, when it is not possible to make a sharding key available.</span></span> <span data-ttu-id="b1401-186">Para resolver isso, a biblioteca de cliente do banco de dados elástico inclui a [classe MultiShardQuery](http://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardexception.aspx).</span><span class="sxs-lookup"><span data-stu-id="b1401-186">To address this, the elastic database client library includes the [MultiShardQuery class](http://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardexception.aspx).</span></span> <span data-ttu-id="b1401-187">A classe implementa uma abstração de conexão para consultas em vários fragmentos.</span><span class="sxs-lookup"><span data-stu-id="b1401-187">The class implements a connection abstraction for querying over several shards.</span></span> <span data-ttu-id="b1401-188">O uso da MultiShardQuery em combinação com Dapper está além do escopo deste documento.</span><span class="sxs-lookup"><span data-stu-id="b1401-188">Using MultiShardQuery in combination with Dapper is beyond the scope of this document.</span></span>

## <a name="conclusion"></a><span data-ttu-id="b1401-189">Conclusão</span><span class="sxs-lookup"><span data-stu-id="b1401-189">Conclusion</span></span>
<span data-ttu-id="b1401-190">Aplicativos que usam Dapper e DapperExtensions podem aproveitar facilmente as ferramentas de banco de dados elástico para o Banco de Dados SQL do Azure.</span><span class="sxs-lookup"><span data-stu-id="b1401-190">Applications using Dapper and DapperExtensions can easily benefit from elastic database tools for Azure SQL Database.</span></span> <span data-ttu-id="b1401-191">Através das etapas descritas neste documento, esses aplicativos podem usar funcionalidade da ferramenta para roteamento dependente de dados alterando a criação e abertura de novos objetos [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) para usar a chamada [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) da biblioteca de cliente de banco de dados elástico.</span><span class="sxs-lookup"><span data-stu-id="b1401-191">Through the steps outlined in this document, those applications can use the tool's capability for data dependent routing by changing the creation and opening of new [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects to use the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call of the elastic database client library.</span></span> <span data-ttu-id="b1401-192">Isso limita as alterações de aplicativo necessárias para os locais onde as novas conexões são criadas e abertas.</span><span class="sxs-lookup"><span data-stu-id="b1401-192">This limits the application changes required to those places where new connections are created and opened.</span></span> 

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-scale-working-with-dapper/dapperimage1.png
