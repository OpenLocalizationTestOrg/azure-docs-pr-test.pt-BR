---
title: "Provisionar novos locatários em um aplicativo multilocatário que usa o Banco de Dados SQL do Azure | Microsoft Docs"
description: "Saiba como provisionar e catalogar novos locatários no aplicativo SaaS Wingtip"
keywords: tutorial do banco de dados SQL
services: sql-database
documentationcenter: 
author: stevestein
manager: craigg
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/11/2017
ms.author: sstein
ms.openlocfilehash: 8fa4c4f95386a92c8c818eef1a5b4de5a086fe07
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/18/2017
---
# <a name="provision-new-tenants-and-register-them-in-the-catalog"></a><span data-ttu-id="9f35f-104">Provisionar novos locatários e registrá-los no catálogo</span><span class="sxs-lookup"><span data-stu-id="9f35f-104">Provision new tenants and register them in the catalog</span></span>

<span data-ttu-id="9f35f-105">Neste tutorial, você aprenderá sobre os padrões de provisionamento e catálogo de SaaS, e como eles são implementados no aplicativo SaaS Wingtip.</span><span class="sxs-lookup"><span data-stu-id="9f35f-105">In this tutorial, you learn about the provision and catalog SaaS patterns, and how they are implemented in the Wingtip SaaS application.</span></span> <span data-ttu-id="9f35f-106">Você vai criar e inicializar novos bancos de dados de locatário e os registrará no catálogo de locatários do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="9f35f-106">You create and initialize new tenant databases, and register them in the application’s tenant catalog.</span></span> <span data-ttu-id="9f35f-107">O catálogo é um banco de dados que mantém o mapeamento entre os vários locatários do aplicativo SaaS e seus dados.</span><span class="sxs-lookup"><span data-stu-id="9f35f-107">The catalog is a database that maintains the mapping between the SaaS application's many tenants and their data.</span></span> <span data-ttu-id="9f35f-108">O catálogo desempenha uma função importante no direcionamento das solicitações de aplicativo para o banco de dados correto.</span><span class="sxs-lookup"><span data-stu-id="9f35f-108">The catalog plays an important role directing application requests to the correct database.</span></span>  

<span data-ttu-id="9f35f-109">Neste tutorial, você aprenderá como:</span><span class="sxs-lookup"><span data-stu-id="9f35f-109">In this tutorial, you learn how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="9f35f-110">Provisionar um novo locatário individual, o que inclui como isso é implementado</span><span class="sxs-lookup"><span data-stu-id="9f35f-110">Provision a single new tenant, including stepping through how this is implemented</span></span>
> * <span data-ttu-id="9f35f-111">Provisionar um lote de locatários adicionais</span><span class="sxs-lookup"><span data-stu-id="9f35f-111">Provision a batch of additional tenants</span></span>


<span data-ttu-id="9f35f-112">Para concluir este tutorial, verifique se todos os pré-requisitos a seguir são atendidos:</span><span class="sxs-lookup"><span data-stu-id="9f35f-112">To complete this tutorial, make sure the following prerequisites are completed:</span></span>

* <span data-ttu-id="9f35f-113">O aplicativo SaaS Wingtip é implantado.</span><span class="sxs-lookup"><span data-stu-id="9f35f-113">The Wingtip SaaS app is deployed.</span></span> <span data-ttu-id="9f35f-114">Para implantar em menos de cinco minutos, confira [Implantar e explorar o aplicativo de SaaS do Wingtip](sql-database-saas-tutorial.md)</span><span class="sxs-lookup"><span data-stu-id="9f35f-114">To deploy in less than five minutes, see [Deploy and explore the Wingtip SaaS application](sql-database-saas-tutorial.md)</span></span>
* <span data-ttu-id="9f35f-115">O Azure PowerShell está instalado.</span><span class="sxs-lookup"><span data-stu-id="9f35f-115">Azure PowerShell is installed.</span></span> <span data-ttu-id="9f35f-116">Para obter detalhes, consulte [Introdução ao Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span><span class="sxs-lookup"><span data-stu-id="9f35f-116">For details, see [Getting started with Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span></span>

## <a name="introduction-to-the-saas-catalog-pattern"></a><span data-ttu-id="9f35f-117">Introdução ao padrão de catálogo de SaaS</span><span class="sxs-lookup"><span data-stu-id="9f35f-117">Introduction to the SaaS Catalog pattern</span></span>

<span data-ttu-id="9f35f-118">Em um aplicativo de SaaS multilocatário com suporte de banco de dados, é importante saber o local em que estão armazenadas as informações de cada locatário.</span><span class="sxs-lookup"><span data-stu-id="9f35f-118">In a database-backed multi-tenant SaaS application, it's important to know where information for each tenant is stored.</span></span> <span data-ttu-id="9f35f-119">No padrão de catálogo de SaaS, um banco de dados de catálogo é usado para manter o mapeamento entre cada locatário e o local onde seus dados estão armazenados.</span><span class="sxs-lookup"><span data-stu-id="9f35f-119">In the SaaS catalog pattern, a catalog database is used to hold the mapping between each tenant and where their data is stored.</span></span> <span data-ttu-id="9f35f-120">O aplicativo SaaS Wingtip usa uma arquitetura de locatário único por banco de dados, mas o padrão básico de armazenamento do mapeamento de locatário para banco de dados em um catálogo aplica-se tanto ao uso de um banco de dados multilocatário quanto ao de locatário único.</span><span class="sxs-lookup"><span data-stu-id="9f35f-120">The Wingtip SaaS app uses a single-tenant per database architecture, but the basic pattern of storing tenant-to-database mapping in a catalog applies whether a multi-tenant or single-tenant database is used.</span></span>

<span data-ttu-id="9f35f-121">Cada locatário recebe uma chave que o identifica no catálogo, e que é mapeada até o local do banco de dados apropriado.</span><span class="sxs-lookup"><span data-stu-id="9f35f-121">Each tenant is assigned a key that identifies them in the catalog and which is mapped to the location of the appropriate database.</span></span> <span data-ttu-id="9f35f-122">No aplicativo SaaS Wingtip, a chave é formada por um hash do nome do locatário.</span><span class="sxs-lookup"><span data-stu-id="9f35f-122">In the Wingtip SaaS app, the key is formed from a hash of the tenant’s name.</span></span> <span data-ttu-id="9f35f-123">Isso permite que a parte do nome do locatário da URL do aplicativo seja usada para construir a chave.</span><span class="sxs-lookup"><span data-stu-id="9f35f-123">This allows the tenant name portion of the application URL to be used to construct the key.</span></span> <span data-ttu-id="9f35f-124">Outros esquemas de chave de locatário podem ser usados.</span><span class="sxs-lookup"><span data-stu-id="9f35f-124">Other tenant key schemes could be used.</span></span>  

<span data-ttu-id="9f35f-125">O catálogo permite que o nome ou local do banco de dados seja alterado com impacto mínimo sobre o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="9f35f-125">The catalog allows the name or location of the database to be changed with minimal impact on the application.</span></span>  <span data-ttu-id="9f35f-126">Em um modelo de banco de dados multilocatário, isso também acomoda a 'movimentação' de um locatário entre bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="9f35f-126">In a multi-tenant database model, this also accommodates ‘moving’ a tenant between databases.</span></span>  <span data-ttu-id="9f35f-127">O catálogo também pode ser usado para indicar se um locatário ou banco de dados está offline para manutenção ou outras ações.</span><span class="sxs-lookup"><span data-stu-id="9f35f-127">The catalog can also be used to indicate whether a tenant or database is offline for maintenance or other actions.</span></span> <span data-ttu-id="9f35f-128">Isso é explorado no [tutorial de restauração de locatário único](sql-database-saas-tutorial-restore-single-tenant.md).</span><span class="sxs-lookup"><span data-stu-id="9f35f-128">This is explored in the [restore single tenant tutorial](sql-database-saas-tutorial-restore-single-tenant.md).</span></span>

<span data-ttu-id="9f35f-129">Além disso, o catálogo, que é, na verdade, um banco de dados de gerenciamento de um aplicativo SaaS, pode armazenar metadados adicionais de locatário ou de banco de dados, como a camada ou edição de um banco de dados, versão do esquema, plano de serviço ou SLAs oferecidos aos locatários, e outras informações que permitem o gerenciamento de aplicativos, atendimento ao cliente ou processos de devOps.</span><span class="sxs-lookup"><span data-stu-id="9f35f-129">In addition, the catalog, which is in effect a management database for a SaaS application, can store additional tenant or database metadata, such as the tier or edition of a database, schema version, service plan, or SLAs offered to tenants, and other info that enables application management, customer support, or devops processes.</span></span>  

<span data-ttu-id="9f35f-130">Além do aplicativo SaaS, o catálogo pode habilitar as ferramentas de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="9f35f-130">Beyond the SaaS application, the catalog can enable database tools.</span></span>  <span data-ttu-id="9f35f-131">No exemplo de SaaS Wingtip, o catálogo é usado para permitir consultas entre locatários, exploradas no [tutorial de análise ad hoc](sql-database-saas-tutorial-adhoc-analytics.md).</span><span class="sxs-lookup"><span data-stu-id="9f35f-131">In the Wingtip SaaS sample, the catalog is used to enable cross-tenant query, explored in the [ad hoc analytics tutorial](sql-database-saas-tutorial-adhoc-analytics.md).</span></span> <span data-ttu-id="9f35f-132">O gerenciamento de trabalhos entre bancos de dados é explorado nos tutoriais [gerenciamento de esquema](sql-database-saas-tutorial-schema-management.md) e [análise de locatários](sql-database-saas-tutorial-tenant-analytics.md).</span><span class="sxs-lookup"><span data-stu-id="9f35f-132">Cross-database job management is explored in the [schema management](sql-database-saas-tutorial-schema-management.md) and [tenant analytics](sql-database-saas-tutorial-tenant-analytics.md) tutorials.</span></span> 

<span data-ttu-id="9f35f-133">No aplicativo SaaS Wingtip, o catálogo é implementado usando os recursos de Gerenciamento de Fragmentos na [EDCL (Biblioteca de Cliente do Banco de Dados Elástico)](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="9f35f-133">In the Wingtip SaaS app, the catalog is implemented using the Shard Management features of the [Elastic Database Client Library (EDCL)](sql-database-elastic-database-client-library.md).</span></span> <span data-ttu-id="9f35f-134">O EDCL permite que um aplicativo crie, gerencie e use um mapa de fragmentos com backup no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="9f35f-134">The EDCL enables an application to create, manage, and use a database-backed shard map.</span></span> <span data-ttu-id="9f35f-135">Um mapa de fragmentos contém uma lista de fragmentos (bancos de dados) e o mapeamento entre chaves (locatários) e bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="9f35f-135">A shard map contains a list of shards (databases) and the mapping between keys (tenants) and databases.</span></span>  <span data-ttu-id="9f35f-136">As funções de EDCL podem ser usadas em aplicativos ou scripts do PowerShell durante o provisionamento de locatários, a fim de criar as entradas no mapa de fragmentos, e em aplicativos para conexão eficiente ao banco de dados correto.</span><span class="sxs-lookup"><span data-stu-id="9f35f-136">EDCL functions can be used from applications or PowerShell scripts during tenant provisioning to create the entries in the shard map, and from applications to efficiently connect to the correct database.</span></span> <span data-ttu-id="9f35f-137">O EDCL armazena informações de conexão em cache para minimizar o tráfego ao banco de dados de catálogo e acelerar o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="9f35f-137">EDCL caches connection information to minimize the traffic to the catalog database and speed up the application.</span></span>  

> [!IMPORTANT]
> <span data-ttu-id="9f35f-138">Os dados de mapeamento estão acessíveis no banco de dados de catálogo, mas *não os edite*!</span><span class="sxs-lookup"><span data-stu-id="9f35f-138">The mapping data is accessible in the catalog database, but *don't edit it*!</span></span> <span data-ttu-id="9f35f-139">Edite os dados de mapeamento somente com o uso de APIs da Biblioteca de Cliente do Banco de Dados Elástico.</span><span class="sxs-lookup"><span data-stu-id="9f35f-139">Edit mapping data using Elastic Database Client Library APIs only.</span></span> <span data-ttu-id="9f35f-140">Manipular diretamente os dados de mapeamento gera o risco de corrupção do catálogo e não há suporte para isso.</span><span class="sxs-lookup"><span data-stu-id="9f35f-140">Directly manipulating the mapping data risks corrupting the catalog and is not supported.</span></span>


## <a name="introduction-to-the-saas-provisioning-pattern"></a><span data-ttu-id="9f35f-141">Introdução ao padrão de Provisionamento de SaaS</span><span class="sxs-lookup"><span data-stu-id="9f35f-141">Introduction to the SaaS Provisioning pattern</span></span>

<span data-ttu-id="9f35f-142">Ao integrar um novo locatário em um aplicativo SaaS que usa um modelo de banco de dados de locatário único, é necessário provisionar um novo banco de dados de locatário.</span><span class="sxs-lookup"><span data-stu-id="9f35f-142">When onboarding a new tenant in a SaaS application that uses a single-tenant database model a new tenant database must be provisioned.</span></span>  <span data-ttu-id="9f35f-143">Ele deve ser criado no local e na camada de serviço apropriados, inicializado com o esquema e os dados de referência apropriados e, em seguida, registrado no catálogo sob a chave de locatário apropriada.</span><span class="sxs-lookup"><span data-stu-id="9f35f-143">It must be created in the appropriate location and service tier, initialized with appropriate schema and reference data, and then registered in the catalog under the appropriate tenant key.</span></span>  

<span data-ttu-id="9f35f-144">Abordagens diferentes podem ser usadas no provisionamento de banco de dados, o que pode incluir a execução de scripts SQL, a implantação de um bacpac ou a cópia de um banco de dados de modelo 'final'.</span><span class="sxs-lookup"><span data-stu-id="9f35f-144">Different approaches can be used to database provisioning, which could include executing SQL scripts, deploying a bacpac, or copying a 'golden' template database.</span></span>  

<span data-ttu-id="9f35f-145">A abordagem de provisionamento usada deve ser compreendida em sua estratégia geral de gerenciamento de esquema, que deve garantir que novos bancos de dados sejam provisionados com o esquema mais recente.</span><span class="sxs-lookup"><span data-stu-id="9f35f-145">The provisioning approach you use must be comprehended in your overall schema management strategy, which must ensure that new databases are provisioned with the latest schema.</span></span>  <span data-ttu-id="9f35f-146">Isso é explorado no [tutorial de gerenciamento de esquema](sql-database-saas-tutorial-schema-management.md).</span><span class="sxs-lookup"><span data-stu-id="9f35f-146">This is explored in the [schema management tutorial](sql-database-saas-tutorial-schema-management.md).</span></span>  

<span data-ttu-id="9f35f-147">Os aplicativo SaaS Wingtip provisiona novos locatários copiando um banco de dados final chamado basetenantdb, implantado no servidor de catálogo.</span><span class="sxs-lookup"><span data-stu-id="9f35f-147">The Wingtip SaaS app provisions new tenants by copying a golden database named basetenantdb, deployed on the catalog server.</span></span>  <span data-ttu-id="9f35f-148">O provisionamento pode ser integrado ao aplicativo como parte de uma experiência de inscrição, e/ou com suporte offline por meio do uso de scripts.</span><span class="sxs-lookup"><span data-stu-id="9f35f-148">Provisioning could be integrated into the application as part of a sign-up experience, and/or supported offline using scripts.</span></span> <span data-ttu-id="9f35f-149">Este tutorial explorará o provisionamento usando o PowerShell.</span><span class="sxs-lookup"><span data-stu-id="9f35f-149">This tutorial will explore provisioning using PowerShell.</span></span> <span data-ttu-id="9f35f-150">Os scripts de provisionamento copiam basetenantdb para criar um novo banco de dados de locatário em um pool elástico e, depois, o inicializam com informações específicas do locatário e o registram no mapa de fragmentos do catálogo.</span><span class="sxs-lookup"><span data-stu-id="9f35f-150">The provisioning scripts copy the basetenantdb to create a new tenant database in an elastic pool, then initialize it with tenant-specific info and register it in the catalog shard map.</span></span>  <span data-ttu-id="9f35f-151">No aplicativo de exemplo, os bancos de dados recebem nomes com base no nome do locatário, mas isso não é uma parte crítica do padrão, o uso do catálogo permite que qualquer nome seja atribuído ao banco de dados.+</span><span class="sxs-lookup"><span data-stu-id="9f35f-151">In the sample app, databases are given names based on the tenant name, but this is not a critical part of the pattern – the use of the catalog allows any name to be assigned to the database.+</span></span> 


## <a name="get-the-wingtip-application-scripts"></a><span data-ttu-id="9f35f-152">Obter os scripts do aplicativo Wingtip</span><span class="sxs-lookup"><span data-stu-id="9f35f-152">Get the Wingtip application scripts</span></span>

<span data-ttu-id="9f35f-153">Os scripts de SaaS do Wingtip e o código-fonte do aplicativo estão disponíveis no repositório GitHub [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS).</span><span class="sxs-lookup"><span data-stu-id="9f35f-153">The Wingtip SaaS scripts and application source code are available in the [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) github repo.</span></span> <span data-ttu-id="9f35f-154">[Etapas para baixar os scripts do SaaS Wingtip](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span><span class="sxs-lookup"><span data-stu-id="9f35f-154">[Steps to download the Wingtip SaaS scripts](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span></span>


## <a name="provision-and-catalog-detailed-walkthrough"></a><span data-ttu-id="9f35f-155">Passo a passo detalhado para provisionar e catalogar</span><span class="sxs-lookup"><span data-stu-id="9f35f-155">Provision and catalog detailed walkthrough</span></span>

<span data-ttu-id="9f35f-156">Para entender como o aplicativo Wingtip implementa o novo provisionamento de locatário, adicione um ponto de interrupção e percorra o fluxo de trabalho durante o provisionamento de um locatário:</span><span class="sxs-lookup"><span data-stu-id="9f35f-156">To understand how the Wingtip application implements new tenant provisioning, add a breakpoint and step through the workflow while provisioning a tenant:</span></span>

1. <span data-ttu-id="9f35f-157">Abra ...\\Learning Modules\\ProvisionAndCatalog\\_Demo-ProvisionAndCatalog.ps1_ e defina estes parâmetros:</span><span class="sxs-lookup"><span data-stu-id="9f35f-157">Open ...\\Learning Modules\\ProvisionAndCatalog\\_Demo-ProvisionAndCatalog.ps1_ and set the following parameters:</span></span>
   * <span data-ttu-id="9f35f-158">**$TenantName** = o nome do novo local do evento (por exemplo, *Bushwillow Blues*).</span><span class="sxs-lookup"><span data-stu-id="9f35f-158">**$TenantName** = the name of the new venue (for example, *Bushwillow Blues*).</span></span>
   * <span data-ttu-id="9f35f-159">**$VenueType** = um dos tipos predefinidos de local: *blues*, classicalmusic, dance, jazz, judo, motorracing, multipurpose, opera, rockmusic, soccer.</span><span class="sxs-lookup"><span data-stu-id="9f35f-159">**$VenueType** = one of the pre-defined venue types: *blues*, classicalmusic, dance, jazz, judo, motorracing, multipurpose, opera, rockmusic, soccer.</span></span>
   * <span data-ttu-id="9f35f-160">**$DemoScenario** = **1**, defina como **1** para *Provisionar um único locatário*.</span><span class="sxs-lookup"><span data-stu-id="9f35f-160">**$DemoScenario** = **1**, Set to **1** to *Provision a single tenant*.</span></span>

1. <span data-ttu-id="9f35f-161">Adicione um ponto de interrupção, colocando o cursor em qualquer local na linha 48, que diz: *New-Tenant \`* e pressione **F9**.</span><span class="sxs-lookup"><span data-stu-id="9f35f-161">Add a breakpoint by putting your cursor anywhere on line 48, the line that says: *New-Tenant \`*, and press **F9**.</span></span>

   ![ponto de interrupção](media/sql-database-saas-tutorial-provision-and-catalog/breakpoint.png)

1. <span data-ttu-id="9f35f-163">Para executar o script, pressione **F5**.</span><span class="sxs-lookup"><span data-stu-id="9f35f-163">To run the script press **F5**.</span></span>

1. <span data-ttu-id="9f35f-164">Depois que a execução do script for interrompida no ponto de interrupção, pressione **F11** para entrar no código.</span><span class="sxs-lookup"><span data-stu-id="9f35f-164">After the script execution stops at the breakpoint, press **F11** to step into the code.</span></span>

   ![ponto de interrupção](media/sql-database-saas-tutorial-provision-and-catalog/debug.png)



<span data-ttu-id="9f35f-166">Rastreie a execução do script usando as opções de menu **Depurar** – **F10** e **F11** para passar por cima ou intervir nas funções chamadas.</span><span class="sxs-lookup"><span data-stu-id="9f35f-166">Trace the script's execution using the **Debug** menu options - **F10** and **F11** to step over or into the called functions.</span></span> <span data-ttu-id="9f35f-167">Para saber mais sobre como depurar scripts do PowerShell, confira [Dicas sobre como trabalhar e depurar scripts do PowerShell](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise).</span><span class="sxs-lookup"><span data-stu-id="9f35f-167">For more information about debugging PowerShell scripts, see [Tips on working with and debugging PowerShell scripts](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise).</span></span>


<span data-ttu-id="9f35f-168">As etapas a seguir não devem ser explicitamente seguidas porque são uma explicação do fluxo de trabalho pelo qual você passará ao depurar o script:</span><span class="sxs-lookup"><span data-stu-id="9f35f-168">The following are not steps to explicitly follow, but an explanation of the workflow you step through while debugging the script:</span></span>

1. <span data-ttu-id="9f35f-169">**Importar o módulo SubscriptionManagement.psm1** que contém funções para entrar no Azure e selecionar a assinatura do Azure com a qual você está trabalhando.</span><span class="sxs-lookup"><span data-stu-id="9f35f-169">**Import the SubscriptionManagement.psm1** module that contains functions for signing in to Azure and selecting the Azure subscription you are working with.</span></span>
1. <span data-ttu-id="9f35f-170">**Importar o módulo CatalogAndDatabaseManagement.psm1** que fornece um catálogo e uma abstração em nível de locatário em relação às funções de [Gerenciamento de Fragmentos](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="9f35f-170">**Import the CatalogAndDatabaseManagement.psm1** module that provides a catalog and tenant-level abstraction over the [Shard Management](sql-database-elastic-scale-shard-map-management.md) functions.</span></span> <span data-ttu-id="9f35f-171">Este é um módulo importante que encapsula a maior parte do padrão do catálogo e vale a pena explorar.</span><span class="sxs-lookup"><span data-stu-id="9f35f-171">This is an important module that encapsulates much of the catalog pattern and is worth exploring.</span></span>
1. <span data-ttu-id="9f35f-172">**Obter detalhes de configuração**.</span><span class="sxs-lookup"><span data-stu-id="9f35f-172">**Get configuration details**.</span></span> <span data-ttu-id="9f35f-173">Intervenha em Get-Configuration (com F11) e veja como a configuração do aplicativo é especificada.</span><span class="sxs-lookup"><span data-stu-id="9f35f-173">Step into Get-Configuration (with F11) and see how the app config is specified.</span></span> <span data-ttu-id="9f35f-174">Os nomes de recursos e outros valores específicos do aplicativo são definidos aqui, mas não altere nenhum desses valores até que você esteja familiarizado com os scripts.</span><span class="sxs-lookup"><span data-stu-id="9f35f-174">Resource names and other app-specific values are defined here, but do not change any of these values until you are familiar with the scripts.</span></span>
1. <span data-ttu-id="9f35f-175">**Obter o objeto de catálogo**.</span><span class="sxs-lookup"><span data-stu-id="9f35f-175">**Get the catalog object**.</span></span> <span data-ttu-id="9f35f-176">Intervenha em Get-Catalog que compõe e retorna um objeto de catálogo usado no script de nível superior.</span><span class="sxs-lookup"><span data-stu-id="9f35f-176">Step into Get-Catalog which composes and returns a catalog object that is used in the higher-level script.</span></span>  <span data-ttu-id="9f35f-177">Essa função usa funções de Gerenciamento de Fragmentos importadas do **AzureShardManagement.psm1**.</span><span class="sxs-lookup"><span data-stu-id="9f35f-177">This function uses Shard Management functions that are imported from **AzureShardManagement.psm1**.</span></span> <span data-ttu-id="9f35f-178">O objeto de catálogo é composto pelo seguinte:</span><span class="sxs-lookup"><span data-stu-id="9f35f-178">The catalog object is composed of the following:</span></span>
   * <span data-ttu-id="9f35f-179">O $catalogServerFullyQualifiedName é criado usando o tronco padrão além do seu nome de Usuário: _catalog-\<usuário\>.database.windows.net_.</span><span class="sxs-lookup"><span data-stu-id="9f35f-179">$catalogServerFullyQualifiedName is constructed using the standard stem plus your User name: _catalog-\<user\>.database.windows.net_.</span></span>
   * <span data-ttu-id="9f35f-180">O $catalogDatabaseName é recuperado da configuração: *tenantcatalog*.</span><span class="sxs-lookup"><span data-stu-id="9f35f-180">$catalogDatabaseName is retrieved from the config: *tenantcatalog*.</span></span>
   * <span data-ttu-id="9f35f-181">O objeto $shardMapManager é inicializado no banco de dados do catálogo.</span><span class="sxs-lookup"><span data-stu-id="9f35f-181">$shardMapManager object is initialized from the catalog database.</span></span>
   * <span data-ttu-id="9f35f-182">O objeto $shardMap é inicializado por meio do mapa do fragmentos do *tenantcatalog* no banco de dados de catálogo.</span><span class="sxs-lookup"><span data-stu-id="9f35f-182">$shardMap object is initialized from the *tenantcatalog* shard map in the catalog database.</span></span>
   <span data-ttu-id="9f35f-183">Um objeto de catálogo é composto e retornado e usado no script de nível superior.</span><span class="sxs-lookup"><span data-stu-id="9f35f-183">A catalog object is composed and returned, and used in the higher-level script.</span></span>
1. <span data-ttu-id="9f35f-184">**Calcular a nova chave de locatário**.</span><span class="sxs-lookup"><span data-stu-id="9f35f-184">**Calculate the new tenant key**.</span></span> <span data-ttu-id="9f35f-185">Uma função de hash é usada para criar a chave de locatário com base no nome do locatário.</span><span class="sxs-lookup"><span data-stu-id="9f35f-185">A hash function is used to create the tenant key from the tenant name.</span></span>
1. <span data-ttu-id="9f35f-186">**Verificar se a chave de locatário já existe**.</span><span class="sxs-lookup"><span data-stu-id="9f35f-186">**Check if the tenant key already exists**.</span></span> <span data-ttu-id="9f35f-187">O catálogo é verificado para garantir que a chave está disponível.</span><span class="sxs-lookup"><span data-stu-id="9f35f-187">The catalog is checked to ensure the key is available.</span></span>
1. <span data-ttu-id="9f35f-188">**O banco de dados do locatário é provisionado com New-TenantDatabase.**</span><span class="sxs-lookup"><span data-stu-id="9f35f-188">**The tenant database is provisioned with New-TenantDatabase.**</span></span> <span data-ttu-id="9f35f-189">Use **F11** para intervir e ver como o banco de dados é provisionado usando um [modelo do Azure Resource Manager](../azure-resource-manager/resource-manager-template-walkthrough.md).</span><span class="sxs-lookup"><span data-stu-id="9f35f-189">Use **F11** to step in and see how the database is provisioned using an [Azure Resource Manager template](../azure-resource-manager/resource-manager-template-walkthrough.md).</span></span>

<span data-ttu-id="9f35f-190">O nome do banco de dados é construído com base no nome do locatário para deixar claro qual fragmento pertence a qual locatário.</span><span class="sxs-lookup"><span data-stu-id="9f35f-190">The database name is constructed from the tenant name to make it clear which shard belongs to which tenant.</span></span> <span data-ttu-id="9f35f-191">(Outras estratégias para nomenclatura de banco de dados podem ser usadas com facilidade.)+ Um modelo do Resource Manager é usado para criar um banco de dados de locatário com a cópia de um banco de dados final (baseTenantDB) no servidor de catálogo.</span><span class="sxs-lookup"><span data-stu-id="9f35f-191">(Other strategies for database naming could easily be used.)+ A Resource Manager template is used to create a tenant database by copying a golden database (baseTenantDB) on the catalog server.</span></span> <span data-ttu-id="9f35f-192">Uma abordagem alternativa seria criar um banco de dados vazio e, em seguida, inicializá-lo com a importação de um bacpac, ou executar um script de inicialização de um local bem conhecido.</span><span class="sxs-lookup"><span data-stu-id="9f35f-192">An alternative approach could be to create an empty database and then initialize it by importing a bacpac, or to execute an initialization script from a well-known location.</span></span>  

<span data-ttu-id="9f35f-193">O modelo do Resource Manager está na pasta ...\Módulos de Aprendizado\Comum\: *tenantdatabasecopytemplate.json*</span><span class="sxs-lookup"><span data-stu-id="9f35f-193">The Resource Manager template is in the …\Learning Modules\Common\ folder: *tenantdatabasecopytemplate.json*</span></span>

<span data-ttu-id="9f35f-194">Depois que o banco de dados do locatário é criado, ele é, em seguida, **inicializado com o nome do local (locatário) e o tipo de local**.</span><span class="sxs-lookup"><span data-stu-id="9f35f-194">After the tenant database is created, it is then further **initialized with the venue (tenant) name and the venue type**.</span></span> <span data-ttu-id="9f35f-195">Outra inicialização também poderia ser feita aqui.</span><span class="sxs-lookup"><span data-stu-id="9f35f-195">Other initialization could also be done here.</span></span>

<span data-ttu-id="9f35f-196">O **banco de dados de locatário é registrado no catálogo** com *Add-TenantDatabaseToCatalog* usando a chave do locatário.</span><span class="sxs-lookup"><span data-stu-id="9f35f-196">The **tenant database is registered in the catalog** with *Add-TenantDatabaseToCatalog* using the tenant key.</span></span> <span data-ttu-id="9f35f-197">Use **F11** para ver os detalhes:</span><span class="sxs-lookup"><span data-stu-id="9f35f-197">Use **F11** to step into the details:</span></span>

* <span data-ttu-id="9f35f-198">O banco de dados de catálogo é adicionado ao mapa de fragmentos (a lista de bancos de dados conhecidos).</span><span class="sxs-lookup"><span data-stu-id="9f35f-198">The catalog database is added to the shard map (the list of known databases).</span></span>
* <span data-ttu-id="9f35f-199">O mapeamento que vincula o valor da chave ao fragmento é criado.</span><span class="sxs-lookup"><span data-stu-id="9f35f-199">The mapping that links the key value to the shard is created.</span></span>
* <span data-ttu-id="9f35f-200">Metadados adicionais (o nome do local) sobre o locatário são adicionados à tabela Locatários no catálogo.</span><span class="sxs-lookup"><span data-stu-id="9f35f-200">Additional meta data (the venue's name) about the tenant is added to the Tenants table in the catalog.</span></span>  <span data-ttu-id="9f35f-201">A tabela Locatários não faz parte do esquema ShardManagement e não é instalada pelo EDCL.</span><span class="sxs-lookup"><span data-stu-id="9f35f-201">The Tenants table is not part of the ShardManagement schema and is not installed by the EDCL.</span></span>  <span data-ttu-id="9f35f-202">Esta tabela ilustra como o banco de dados Catálogo pode ser estendido para dar suporte a dados específicos de aplicativos adicionais.</span><span class="sxs-lookup"><span data-stu-id="9f35f-202">This table illustrates how the Catalog database can be extended to support additional application-specific data.</span></span>   


<span data-ttu-id="9f35f-203">Depois que o provisionamento for concluído, a execução retornará ao script original *Demo-ProvisionAndCatalog*, que abre a página **Eventos** do novo locatário no navegador:</span><span class="sxs-lookup"><span data-stu-id="9f35f-203">After provisioning completes, execution returns to the original *Demo-ProvisionAndCatalog* script, which opens the **Events** page for the new tenant in the browser:</span></span>

   ![events](media/sql-database-saas-tutorial-provision-and-catalog/new-tenant.png)


## <a name="provision-a-batch-of-tenants"></a><span data-ttu-id="9f35f-205">Provisionar um lote de locatários</span><span class="sxs-lookup"><span data-stu-id="9f35f-205">Provision a batch of tenants</span></span>

<span data-ttu-id="9f35f-206">Este exercício provisiona um lote com 17 locatários.</span><span class="sxs-lookup"><span data-stu-id="9f35f-206">This exercise provisions a batch of 17 tenants.</span></span> <span data-ttu-id="9f35f-207">É recomendável provisionar esse lote de locatários antes de iniciar os outros tutoriais de SaaS do Wingtip, de forma que haja mais do que apenas alguns bancos de dados com os quais trabalhar.</span><span class="sxs-lookup"><span data-stu-id="9f35f-207">It’s recommended you provision this batch of tenants before starting other Wingtip SaaS tutorials, so there's more than just a few databases to work with.</span></span>

1. <span data-ttu-id="9f35f-208">Abra ...\\Módulos de Aprendizado\\ProvisionAndCatalog\\*Demo-ProvisionAndCatalog.ps1* no *ISE do PowerShell* e altere o parâmetro *$DemoScenario* para 3:</span><span class="sxs-lookup"><span data-stu-id="9f35f-208">Open ...\\Learning Modules\\ProvisionAndCatalog\\*Demo-ProvisionAndCatalog.ps1* in the *PowerShell ISE* and change the *$DemoScenario* parameter to 3:</span></span>
   * <span data-ttu-id="9f35f-209">**$DemoScenario** = **3**, altere para **3** para *Provisionar um lote de locatários*.</span><span class="sxs-lookup"><span data-stu-id="9f35f-209">**$DemoScenario** = **3**, change to **3** to *Provision a batch of tenants*.</span></span>
1. <span data-ttu-id="9f35f-210">Pressione **F5** e execute o script.</span><span class="sxs-lookup"><span data-stu-id="9f35f-210">Press **F5** and run the script.</span></span>

<span data-ttu-id="9f35f-211">O script implanta um lote de locatários adicionais.</span><span class="sxs-lookup"><span data-stu-id="9f35f-211">The script deploys a batch of additional tenants.</span></span> <span data-ttu-id="9f35f-212">Ele usa um [modelo do Azure Resource Manager](../azure-resource-manager/resource-manager-template-walkthrough.md) que controla o lote e, em seguida, delega o provisionamento de cada banco de dados a um modelo vinculado.</span><span class="sxs-lookup"><span data-stu-id="9f35f-212">It uses an [Azure Resource Manager template](../azure-resource-manager/resource-manager-template-walkthrough.md) that controls the batch and then delegates provisioning of each database to a linked template.</span></span> <span data-ttu-id="9f35f-213">O uso de modelos dessa maneira permite que Azure Resource Manager seja o agente do processo de provisionamento do seu script.</span><span class="sxs-lookup"><span data-stu-id="9f35f-213">Using templates in this way allows Azure Resource Manager to broker the provisioning process for your script.</span></span> <span data-ttu-id="9f35f-214">Os modelos provisionam bancos de dados em paralelo nos locais em que isso for possível e lidam com repetições, se necessário, otimizando o processo geral.</span><span class="sxs-lookup"><span data-stu-id="9f35f-214">Templates provision databases in parallel where it can, and handles retries if needed, optimizing the overall process.</span></span> <span data-ttu-id="9f35f-215">O script é idempotente; portanto, se ele falhar ou parar por qualquer motivo, execute-o novamente.</span><span class="sxs-lookup"><span data-stu-id="9f35f-215">The script is idempotent so if it fails or stops for any reason, run it again.</span></span>

### <a name="verify-the-batch-of-tenants-successfully-deployed"></a><span data-ttu-id="9f35f-216">Verificar se o lote de locatários foi implantado com êxito</span><span class="sxs-lookup"><span data-stu-id="9f35f-216">Verify the batch of tenants successfully deployed</span></span>

* <span data-ttu-id="9f35f-217">Abra o servidor *tenants1* navegando até sua lista de servidores no [Portal do Azure](https://portal.azure.com), clique em **Bancos de Dados SQL** e verifique se o lote de 17 bancos de dados adicionais está na lista:</span><span class="sxs-lookup"><span data-stu-id="9f35f-217">Open the *tenants1* server by browsing to your list of servers in the [Azure portal](https://portal.azure.com), click **SQL databases**, and verify the batch of 17 additional databases are now in the list:</span></span>

   ![lista de banco de dados](media/sql-database-saas-tutorial-provision-and-catalog/database-list.png)



## <a name="other-provisioning-patterns"></a><span data-ttu-id="9f35f-219">Outros padrões de provisionamento</span><span class="sxs-lookup"><span data-stu-id="9f35f-219">Other provisioning patterns</span></span>

<span data-ttu-id="9f35f-220">Outros padrões de provisionamento não mencionados nesse tutorial incluem:</span><span class="sxs-lookup"><span data-stu-id="9f35f-220">Other provisioning patterns not included in this tutorial include:</span></span>

<span data-ttu-id="9f35f-221">**Pré-provisionamento de bancos de dados.**</span><span class="sxs-lookup"><span data-stu-id="9f35f-221">**Pre-provisioning databases.**</span></span> <span data-ttu-id="9f35f-222">O padrão de pré-provisionamento explora o fato de que os bancos de dados de um pool elástico não adicionam custo extra.</span><span class="sxs-lookup"><span data-stu-id="9f35f-222">The pre-provisioning pattern exploits the fact that databases in an elastic pool do not add extra cost.</span></span> <span data-ttu-id="9f35f-223">A cobrança é pelo pool elástico, não pelos bancos de dados e os bancos de dados ociosos não consomem nenhum recurso.</span><span class="sxs-lookup"><span data-stu-id="9f35f-223">Billing is for the elastic pool, not the databases, and idle databases consume no resources.</span></span> <span data-ttu-id="9f35f-224">Ao pré-provisionar bancos de dados em um pool e alocá-los quando necessário, o tempo de integração do locatário poderá ser reduzido consideravelmente.</span><span class="sxs-lookup"><span data-stu-id="9f35f-224">By pre-provisioning databases in a pool and allocating them when needed, tenant onboarding time can be reduced significantly.</span></span> <span data-ttu-id="9f35f-225">O número de bancos de dados pré-provisionados pode ser ajustado conforme necessário para manter um buffer adequado para a taxa de provisionamento esperada.</span><span class="sxs-lookup"><span data-stu-id="9f35f-225">The number of databases pre-provisioned could be adjusted as needed to keep a buffer suitable for the anticipated provisioning rate.</span></span>

<span data-ttu-id="9f35f-226">**Provisionamento automático.**</span><span class="sxs-lookup"><span data-stu-id="9f35f-226">**Auto-provisioning.**</span></span> <span data-ttu-id="9f35f-227">No padrão de provisionamento automático, um serviço de provisionamento dedicado é usado para provisionar servidores, pools e bancos de dados automaticamente, conforme necessário – incluindo o pré-provisionamento de bancos de dados em pools elásticos, se desejado.</span><span class="sxs-lookup"><span data-stu-id="9f35f-227">In the auto-provisioning pattern, a dedicated provisioning service is used to provision servers, pools, and databases automatically as needed – including pre-provisioning databases in elastic pools if desired.</span></span> <span data-ttu-id="9f35f-228">E se os bancos de dados forem encerrados e excluídos, as lacunas nos pools elásticos poderão ser preenchidas pelo serviço de provisionamento conforme desejado.</span><span class="sxs-lookup"><span data-stu-id="9f35f-228">And if databases are de-commissioned and deleted, gaps in elastic pools can be filled by the provisioning service as desired.</span></span> <span data-ttu-id="9f35f-229">Esse serviço poderá ser simples ou complexo – por exemplo, manipulação do provisionamento em várias áreas geográficas e poderá configurar a replicação geográfica automaticamente, caso essa estratégia esteja sendo usada para a recuperação de desastre.</span><span class="sxs-lookup"><span data-stu-id="9f35f-229">Such a service could be simple or complex – for example, handling provisioning across multiple geographies, and could set up geo-replication automatically if that strategy is being used for disaster recovery.</span></span> <span data-ttu-id="9f35f-230">Com o padrão de provisionamento automático, um script ou aplicativo cliente poderia enviar uma solicitação de provisionamento para uma fila para ser processada pelo serviço de provisionamento e, em seguida, pesquisaria o serviço para determinar a conclusão.</span><span class="sxs-lookup"><span data-stu-id="9f35f-230">With the auto-provisioning pattern, a client application or script would submit a provisioning request to a queue to be processed by the provisioning service, and would then poll the service to determine completion.</span></span> <span data-ttu-id="9f35f-231">Se o pré-provisionamento fosse usado, as solicitações seriam manipuladas rapidamente com o serviço gerenciando o provisionamento de um banco de dados de substituição em execução em segundo plano.</span><span class="sxs-lookup"><span data-stu-id="9f35f-231">If pre-provisioning is used, requests would be handled quickly with the service managing provisioning of a replacement database running in the background.</span></span>



## <a name="next-steps"></a><span data-ttu-id="9f35f-232">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="9f35f-232">Next steps</span></span>

<span data-ttu-id="9f35f-233">Neste tutorial, você aprendeu a:</span><span class="sxs-lookup"><span data-stu-id="9f35f-233">In this tutorial you learned how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="9f35f-234">Provisionar um novo único locatário</span><span class="sxs-lookup"><span data-stu-id="9f35f-234">Provision a single new tenant</span></span>
> * <span data-ttu-id="9f35f-235">Provisionar um lote de locatários adicionais</span><span class="sxs-lookup"><span data-stu-id="9f35f-235">Provision a batch of additional tenants</span></span>
> * <span data-ttu-id="9f35f-236">Intervir nos detalhes do provisionamento de locatários e do registro deles no catálogo</span><span class="sxs-lookup"><span data-stu-id="9f35f-236">Step into the details of provisioning tenants, and registering them into the catalog</span></span>

<span data-ttu-id="9f35f-237">Experimente o [Tutorial de monitoramento de desempenho](sql-database-saas-tutorial-performance-monitoring.md).</span><span class="sxs-lookup"><span data-stu-id="9f35f-237">Try the [Performance monitoring tutorial](sql-database-saas-tutorial-performance-monitoring.md).</span></span>

## <a name="additional-resources"></a><span data-ttu-id="9f35f-238">Recursos adicionais</span><span class="sxs-lookup"><span data-stu-id="9f35f-238">Additional Resources</span></span>

* <span data-ttu-id="9f35f-239">[Tutoriais adicionais que aproveitam o aplicativo de SaaS do Wingtip](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span><span class="sxs-lookup"><span data-stu-id="9f35f-239">Additional [tutorials that build upon the Wingtip SaaS application](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span></span>
* [<span data-ttu-id="9f35f-240">Biblioteca de cliente do banco de dados elástico</span><span class="sxs-lookup"><span data-stu-id="9f35f-240">Elastic database client library</span></span>](https://docs.microsoft.com/azure/sql-database/sql-database-elastic-database-client-library)
* [<span data-ttu-id="9f35f-241">Como depurar scripts no ISE do Windows PowerShell</span><span class="sxs-lookup"><span data-stu-id="9f35f-241">How to Debug Scripts in Windows PowerShell ISE</span></span>](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise)
