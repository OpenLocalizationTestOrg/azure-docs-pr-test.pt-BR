---
title: "aaaUsing toofix do Gerenciador de recuperação do fragmento mapear problemas | Microsoft Docs"
description: "Use Olá RecoveryManager classe toosolve problemas mapas de fragmento"
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 45520ca3-6903-4b39-88ba-1d41b22da9fe
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/25/2016
ms.author: ddove
ms.openlocfilehash: 2218fb15122f1df466e65483480461e366317f2f
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/06/2017
---
# <a name="using-hello-recoverymanager-class-toofix-shard-map-problems"></a><span data-ttu-id="3400b-103">Usando os problemas de mapa de fragmento Olá RecoveryManager classe toofix</span><span class="sxs-lookup"><span data-stu-id="3400b-103">Using hello RecoveryManager class toofix shard map problems</span></span>
<span data-ttu-id="3400b-104">Olá [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) classe fornece aplicativos ADO.Net Olá capacidade tooeasily detectar e corrigir as inconsistências entre o mapa do fragmento global de saudação (GSM) e o mapa de fragmentos de local de saudação (LSM) em um ambiente de banco de dados fragmentado.</span><span class="sxs-lookup"><span data-stu-id="3400b-104">hello [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) class provides ADO.Net applications hello ability tooeasily detect and correct any inconsistencies between hello global shard map (GSM) and hello local shard map (LSM) in a sharded database environment.</span></span> 

<span data-ttu-id="3400b-105">Olá GSM LSM acompanhar Olá mapeamento e de cada banco de dados em um ambiente fragmentado.</span><span class="sxs-lookup"><span data-stu-id="3400b-105">hello GSM and LSM track hello mapping of each database in a sharded environment.</span></span> <span data-ttu-id="3400b-106">Ocasionalmente, uma quebra ocorre entre Olá GSM e hello LSM.</span><span class="sxs-lookup"><span data-stu-id="3400b-106">Occasionally, a break occurs between hello GSM and hello LSM.</span></span> <span data-ttu-id="3400b-107">Nesse caso, use Olá RecoveryManager classe toodetect e reparar quebra hello.</span><span class="sxs-lookup"><span data-stu-id="3400b-107">In that case, use hello RecoveryManager class toodetect and repair hello break.</span></span>

<span data-ttu-id="3400b-108">Olá RecoveryManager classe faz parte da saudação [biblioteca de cliente do banco de dados Elástico](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="3400b-108">hello RecoveryManager class is part of hello [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> 

![Mapa de fragmentos][1]

<span data-ttu-id="3400b-110">Para obter definições de termos, consulte o [Glossário de ferramentas do Banco de Dados Elástico](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="3400b-110">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span> <span data-ttu-id="3400b-111">como Olá toounderstand **ShardMapManager** toomanage usados dados em uma solução fragmentada, consulte [gerenciamento de mapa do fragmento](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="3400b-111">toounderstand how hello **ShardMapManager** is used toomanage data in a sharded solution, see [Shard map management](sql-database-elastic-scale-shard-map-management.md).</span></span>

## <a name="why-use-hello-recovery-manager"></a><span data-ttu-id="3400b-112">Por que usar o Gerenciador de recuperação Olá?</span><span class="sxs-lookup"><span data-stu-id="3400b-112">Why use hello recovery manager?</span></span>
<span data-ttu-id="3400b-113">Em um ambiente de banco de dados fragmentado, há um locatário por banco de dados e muitos bancos de dados por servidor.</span><span class="sxs-lookup"><span data-stu-id="3400b-113">In a sharded database environment, there is one tenant per database, and many databases per server.</span></span> <span data-ttu-id="3400b-114">Também pode haver vários servidores no ambiente de saudação.</span><span class="sxs-lookup"><span data-stu-id="3400b-114">There can also be many servers in hello environment.</span></span> <span data-ttu-id="3400b-115">Cada banco de dados está mapeado no mapa do fragmento hello, para que chamadas possam ser banco de dados e o servidor correto toohello roteadas.</span><span class="sxs-lookup"><span data-stu-id="3400b-115">Each database is mapped in hello shard map, so calls can be routed toohello correct server and database.</span></span> <span data-ttu-id="3400b-116">Bancos de dados são controlados de acordo com o tooa **chave de fragmentação**, e cada fragmento é atribuído um **intervalo de valores de chave**.</span><span class="sxs-lookup"><span data-stu-id="3400b-116">Databases are tracked according tooa **sharding key**, and each shard is assigned a **range of key values**.</span></span> <span data-ttu-id="3400b-117">Por exemplo, uma chave de fragmentação pode representar os nomes de clientes de saudação de "D" muito "f"</span><span class="sxs-lookup"><span data-stu-id="3400b-117">For example, a sharding key may represent hello customer names from "D" too"F."</span></span> <span data-ttu-id="3400b-118">Olá mapeamento de todos os fragmentos (também conhecido como bancos de dados) e seus intervalos de mapeamento estão contidos em Olá **mapa do fragmento global (GSM)**.</span><span class="sxs-lookup"><span data-stu-id="3400b-118">hello mapping of all shards (aka databases) and their mapping ranges are contained in hello **global shard map (GSM)**.</span></span> <span data-ttu-id="3400b-119">Cada banco de dados também contém um mapa de intervalos de saudação contidos no fragmento de saudação que é conhecido como Olá **mapa do fragmento local (LSM)**.</span><span class="sxs-lookup"><span data-stu-id="3400b-119">Each database also contains a map of hello ranges contained on hello shard that is known as hello **local shard map (LSM)**.</span></span> <span data-ttu-id="3400b-120">Quando um aplicativo se conecta tooa fragmento, mapeamento de saudação é armazenado em cache com o aplicativo hello para recuperação rápida.</span><span class="sxs-lookup"><span data-stu-id="3400b-120">When an app connects tooa shard, hello mapping is cached with hello app for quick retrieval.</span></span> <span data-ttu-id="3400b-121">Olá LSM é usado toovalidate em cache dados.</span><span class="sxs-lookup"><span data-stu-id="3400b-121">hello LSM is used toovalidate cached data.</span></span> 

<span data-ttu-id="3400b-122">Olá GSM e LSM podem se tornar fora de sincronia para Olá motivos a seguir:</span><span class="sxs-lookup"><span data-stu-id="3400b-122">hello GSM and LSM may become out of sync for hello following reasons:</span></span>

1. <span data-ttu-id="3400b-123">exclusão de saudação de um fragmento cujo intervalo considerado toono mais estar em uso ou a renomeação de um fragmento.</span><span class="sxs-lookup"><span data-stu-id="3400b-123">hello deletion of a shard whose range is believed toono longer be in use, or renaming of a shard.</span></span> <span data-ttu-id="3400b-124">A exclusão de um fragmento resulta em um **mapeamento de fragmento órfão**.</span><span class="sxs-lookup"><span data-stu-id="3400b-124">Deleting a shard results in an **orphaned shard mapping**.</span></span> <span data-ttu-id="3400b-125">De modo semelhante, um banco de dados renomeado pode causar um mapeamento de fragmentos órfãos.</span><span class="sxs-lookup"><span data-stu-id="3400b-125">Similarly, a renamed database can cause an orphaned shard mapping.</span></span> <span data-ttu-id="3400b-126">Dependendo da intenção de saudação de alteração hello, fragmento de saudação pode precisar toobe removido ou local de fragmento de saudação precisa toobe atualizado.</span><span class="sxs-lookup"><span data-stu-id="3400b-126">Depending on hello intent of hello change, hello shard may need toobe removed or hello shard location needs toobe updated.</span></span> <span data-ttu-id="3400b-127">toorecover um banco de dados excluído, consulte [restaurar um banco de dados excluído](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="3400b-127">toorecover a deleted database, see [Restore a deleted database](sql-database-recovery-using-backups.md).</span></span>
2. <span data-ttu-id="3400b-128">Ocorre um evento de failover geográfico.</span><span class="sxs-lookup"><span data-stu-id="3400b-128">A geo-failover event occurs.</span></span> <span data-ttu-id="3400b-129">toocontinue, um deve atualizar o nome do servidor de saudação e nome de banco de dados do Gerenciador do mapa de fragmentos no aplicativo hello e, em seguida, detalhes de mapeamento de fragmentos de saudação atualização para todos os fragmentos em um mapa do fragmento.</span><span class="sxs-lookup"><span data-stu-id="3400b-129">toocontinue, one must update hello server name, and database name of shard map manager in hello application and then update hello shard mapping details for all shards in a shard map.</span></span> <span data-ttu-id="3400b-130">Se houver um failover geográfico, uma lógica de recuperação deve ser automatizada de fluxo de trabalho de failover de saudação.</span><span class="sxs-lookup"><span data-stu-id="3400b-130">If there is a geo-failover, such recovery logic should be automated within hello failover workflow.</span></span> <span data-ttu-id="3400b-131">A automação das ações de recuperação proporciona capacidade de gerenciamento ininterrupta para bancos de dados habilitados geograficamente e evita ações humanas manuais.</span><span class="sxs-lookup"><span data-stu-id="3400b-131">Automating recovery actions enables a frictionless manageability for geo-enabled databases and avoids manual human actions.</span></span> <span data-ttu-id="3400b-132">toolearn sobre opções toorecover um banco de dados se houver uma interrupção de centro de dados, consulte [continuidade dos negócios](sql-database-business-continuity.md) e [a recuperação de desastres](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="3400b-132">toolearn about options toorecover a database if there is a data center outage, see [Business Continuity](sql-database-business-continuity.md) and [Disaster Recovery](sql-database-disaster-recovery.md).</span></span>
3. <span data-ttu-id="3400b-133">Banco de dados ShardMapManager um fragmento ou Olá é restaurado tooan ponto no tempo anterior.</span><span class="sxs-lookup"><span data-stu-id="3400b-133">Either a shard or hello ShardMapManager database is restored tooan earlier point-in time.</span></span> <span data-ttu-id="3400b-134">toolearn sobre recuperação pontual usando backups, consulte [recuperação usando backups](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="3400b-134">toolearn about point in time recovery using backups, see [Recovery using backups](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="3400b-135">Para obter mais informações sobre ferramentas de banco de dados Elástico banco de dados SQL, a replicação geográfica e restauração, consulte o seguinte hello:</span><span class="sxs-lookup"><span data-stu-id="3400b-135">For more information about Azure SQL Database Elastic Database tools, geo-replication and Restore, see hello following:</span></span> 

* [<span data-ttu-id="3400b-136">Visão geral: continuidade de negócios em nuvem e recuperação de desastre do banco de dados com o banco de dados SQL</span><span class="sxs-lookup"><span data-stu-id="3400b-136">Overview: Cloud business continuity and database disaster recovery with SQL Database</span></span>](sql-database-business-continuity.md) 
* [<span data-ttu-id="3400b-137">Comece com ferramentas de banco de dados elástico</span><span class="sxs-lookup"><span data-stu-id="3400b-137">Get started with elastic database tools</span></span>](sql-database-elastic-scale-get-started.md)  
* [<span data-ttu-id="3400b-138">Gerenciamento de ShardMap</span><span class="sxs-lookup"><span data-stu-id="3400b-138">ShardMap Management</span></span>](sql-database-elastic-scale-shard-map-management.md)

## <a name="retrieving-recoverymanager-from-a-shardmapmanager"></a><span data-ttu-id="3400b-139">Recuperando o RecoveryManager de um ShardMapManager</span><span class="sxs-lookup"><span data-stu-id="3400b-139">Retrieving RecoveryManager from a ShardMapManager</span></span>
<span data-ttu-id="3400b-140">Olá primeira etapa é toocreate uma instância de RecoveryManager.</span><span class="sxs-lookup"><span data-stu-id="3400b-140">hello first step is toocreate a RecoveryManager instance.</span></span> <span data-ttu-id="3400b-141">Olá [GetRecoveryManager método](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) retorna Olá Gerenciador de recuperação para Olá atual [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instância.</span><span class="sxs-lookup"><span data-stu-id="3400b-141">hello [GetRecoveryManager method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) returns hello recovery manager for hello current [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span></span> <span data-ttu-id="3400b-142">tooaddress quaisquer inconsistências no fragmento de saudação do mapa, primeiro você deve recuperar hello RecoveryManager para mapa do fragmento específico de saudação.</span><span class="sxs-lookup"><span data-stu-id="3400b-142">tooaddress any inconsistencies in hello shard map, you must first retrieve hello RecoveryManager for hello particular shard map.</span></span> 

   ```
    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 
   ```

<span data-ttu-id="3400b-143">Neste exemplo, Olá RecoveryManager é inicializada de saudação ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="3400b-143">In this example, hello RecoveryManager is initialized from hello ShardMapManager.</span></span> <span data-ttu-id="3400b-144">Olá ShardMapManager que contém um ShardMap também já foi inicializado.</span><span class="sxs-lookup"><span data-stu-id="3400b-144">hello ShardMapManager containing a ShardMap is also already initialized.</span></span> 

<span data-ttu-id="3400b-145">Desde que este código de aplicativo manipula o mapa do fragmento Olá em si, Olá credenciais usadas no método de fábrica hello (em Olá anterior como exemplo, smmConnectionString) devem ser credenciais que têm permissões de leitura e gravação no banco de dados do GSM Olá referenciado por Olá cadeia de caracteres de conexão.</span><span class="sxs-lookup"><span data-stu-id="3400b-145">Since this application code manipulates hello shard map itself, hello credentials used in hello factory method (in hello preceding example, smmConnectionString) should be credentials that have read-write permissions on hello GSM database referenced by hello connection string.</span></span> <span data-ttu-id="3400b-146">Essas credenciais são normalmente diferentes das credenciais usadas tooopen conexões de roteamento dependente de dados.</span><span class="sxs-lookup"><span data-stu-id="3400b-146">These credentials are typically different from credentials used tooopen connections for data-dependent routing.</span></span> <span data-ttu-id="3400b-147">Para obter mais informações, consulte [usando as credenciais no cliente de banco de dados Elástico Olá](sql-database-elastic-scale-manage-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="3400b-147">For more information, see [Using credentials in hello elastic database client](sql-database-elastic-scale-manage-credentials.md).</span></span>

## <a name="removing-a-shard-from-hello-shardmap-after-a-shard-is-deleted"></a><span data-ttu-id="3400b-148">Removendo um fragmento de saudação ShardMap depois que um fragmento é excluído</span><span class="sxs-lookup"><span data-stu-id="3400b-148">Removing a shard from hello ShardMap after a shard is deleted</span></span>
<span data-ttu-id="3400b-149">Olá [DetachShard método](https://msdn.microsoft.com/library/azure/dn842083.aspx) desanexa Olá fornecida fragmento do mapa do fragmento hello e exclui os mapeamentos associados a fragmentos de saudação.</span><span class="sxs-lookup"><span data-stu-id="3400b-149">hello [DetachShard method](https://msdn.microsoft.com/library/azure/dn842083.aspx) detaches hello given shard from hello shard map and deletes mappings associated with hello shard.</span></span>  

* <span data-ttu-id="3400b-150">parâmetro de local de saudação é o local de fragmento de hello, especificamente o nome do servidor e o nome do banco de dados de fragmento hello está sendo desanexado.</span><span class="sxs-lookup"><span data-stu-id="3400b-150">hello location parameter is hello shard location, specifically server name and database name, of hello shard being detached.</span></span> 
* <span data-ttu-id="3400b-151">parâmetro de shardMapName Hello é nome do mapa de fragmentos hello.</span><span class="sxs-lookup"><span data-stu-id="3400b-151">hello shardMapName parameter is hello shard map name.</span></span> <span data-ttu-id="3400b-152">Isso só é necessária quando vários mapas de fragmento são gerenciados pelo Olá mesmo Gerenciador de mapa do fragmento.</span><span class="sxs-lookup"><span data-stu-id="3400b-152">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="3400b-153">Opcional.</span><span class="sxs-lookup"><span data-stu-id="3400b-153">Optional.</span></span> 


> [!IMPORTANT]
> <span data-ttu-id="3400b-154">Use essa técnica somente se você tiver certeza de que o intervalo de saudação para mapeamento de saudação atualizado é vazio.</span><span class="sxs-lookup"><span data-stu-id="3400b-154">Use this technique only if you are certain that hello range for hello updated mapping is empty.</span></span> <span data-ttu-id="3400b-155">métodos de saudação acima não verificam dados para o intervalo de saudação que está sendo movido, portanto, é melhor tooinclude verifica no seu código.</span><span class="sxs-lookup"><span data-stu-id="3400b-155">hello methods above do not check data for hello range being moved, so it is best tooinclude checks in your code.</span></span>
>

<span data-ttu-id="3400b-156">Este exemplo remove os fragmentos de mapa do fragmento hello.</span><span class="sxs-lookup"><span data-stu-id="3400b-156">This example removes shards from hello shard map.</span></span> 

   ```
   rm.DetachShard(s.Location, customerMap);
   ``` 

<span data-ttu-id="3400b-157">mapa do fragmento Olá reflete o local de fragmento Olá Olá GSM antes da exclusão de saudação do fragmento hello.</span><span class="sxs-lookup"><span data-stu-id="3400b-157">hello shard map reflects hello shard location in hello GSM before hello deletion of hello shard.</span></span> <span data-ttu-id="3400b-158">Como fragmentos Olá foi excluído, será considerado foi intencional e intervalo de chave de fragmentação Olá não está mais em uso.</span><span class="sxs-lookup"><span data-stu-id="3400b-158">Because hello shard was deleted, it is assumed this was intentional, and hello sharding key range is no longer in use.</span></span> <span data-ttu-id="3400b-159">Se esse não for o caso, você poderá executar a restauração pontual.</span><span class="sxs-lookup"><span data-stu-id="3400b-159">If not, you can execute point-in time restore.</span></span> <span data-ttu-id="3400b-160">fragmento de saudação toorecover de um point-in-time anterior.</span><span class="sxs-lookup"><span data-stu-id="3400b-160">toorecover hello shard from an earlier point-in-time.</span></span> <span data-ttu-id="3400b-161">(Nesse caso, examine Olá inconsistências de fragmento de toodetect seção a seguir). toorecover, consulte [recuperação pontual](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="3400b-161">(In that case, review hello following section toodetect shard inconsistencies.) toorecover, see [Point in time recovery](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="3400b-162">Considerando a exclusão de banco de dados Olá tenha sido intencional, hello ação de limpeza administrativas final é fragmento do toodelete Olá entrada toohello no Gerenciador do mapa de fragmento de saudação.</span><span class="sxs-lookup"><span data-stu-id="3400b-162">Since it is assumed hello database deletion was intentional, hello final administrative cleanup action is toodelete hello entry toohello shard in hello shard map manager.</span></span> <span data-ttu-id="3400b-163">Isso impede que o aplicativo hello inadvertidamente gravar o intervalo de tooa informações que não é esperado.</span><span class="sxs-lookup"><span data-stu-id="3400b-163">This prevents hello application from inadvertently writing information tooa range that is not expected.</span></span>

## <a name="toodetect-mapping-differences"></a><span data-ttu-id="3400b-164">diferenças de mapeamento de toodetect</span><span class="sxs-lookup"><span data-stu-id="3400b-164">toodetect mapping differences</span></span>
<span data-ttu-id="3400b-165">Olá [DetectMappingDifferences método](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) seleciona e retorna um dos mapas de fragmento da saudação (locais ou globais) como fonte de saudação da verdade e reconcilia os mapeamentos de ambos os mapas de fragmento (GSM e LSM).</span><span class="sxs-lookup"><span data-stu-id="3400b-165">hello [DetectMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selects and returns one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   rm.DetectMappingDifferences(location, shardMapName);
   ```

* <span data-ttu-id="3400b-166">Olá *local* Especifica o nome do servidor de saudação e o nome do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="3400b-166">hello *location* specifies hello server name and database name.</span></span> 
* <span data-ttu-id="3400b-167">Olá *shardMapName* parâmetro é o nome do mapa de fragmentos hello.</span><span class="sxs-lookup"><span data-stu-id="3400b-167">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="3400b-168">Isso só é necessário se vários mapas de fragmento são gerenciados pelo Olá mesmo Gerenciador de mapa do fragmento.</span><span class="sxs-lookup"><span data-stu-id="3400b-168">This is only required if multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="3400b-169">Opcional.</span><span class="sxs-lookup"><span data-stu-id="3400b-169">Optional.</span></span> 

## <a name="tooresolve-mapping-differences"></a><span data-ttu-id="3400b-170">diferenças de mapeamento de tooresolve</span><span class="sxs-lookup"><span data-stu-id="3400b-170">tooresolve mapping differences</span></span>
<span data-ttu-id="3400b-171">Olá [ResolveMappingDifferences método](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) seleciona um dos mapas de fragmento da saudação (locais ou globais) como fonte de saudação da verdade e reconcilia os mapeamentos de ambos os mapas de fragmento (GSM e LSM).</span><span class="sxs-lookup"><span data-stu-id="3400b-171">hello [ResolveMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selects one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   ```

* <span data-ttu-id="3400b-172">Olá *RecoveryToken* parâmetro enumera Olá diferenças mapeamentos de saudação hello GSM e hello LSM para fragmentos específicos hello.</span><span class="sxs-lookup"><span data-stu-id="3400b-172">hello *RecoveryToken* parameter enumerates hello differences in hello mappings between hello GSM and hello LSM for hello specific shard.</span></span> 
* <span data-ttu-id="3400b-173">Olá [MappingDifferenceResolution enumeração](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) é usado tooindicate Olá método para resolver a diferença de saudação entre mapeamentos de fragmento de saudação.</span><span class="sxs-lookup"><span data-stu-id="3400b-173">hello [MappingDifferenceResolution enumeration](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) is used tooindicate hello method for resolving hello difference between hello shard mappings.</span></span> 
* <span data-ttu-id="3400b-174">**MappingDifferenceResolution.KeepShardMapping** é recomendável que, quando Olá LSM contém mapeamento precisas hello e, portanto, o mapeamento de saudação no fragmento de saudação deve ser usado.</span><span class="sxs-lookup"><span data-stu-id="3400b-174">**MappingDifferenceResolution.KeepShardMapping** is recommended that when hello LSM contains hello accurate mapping and therefore hello mapping in hello shard should be used.</span></span> <span data-ttu-id="3400b-175">Isso acontece normalmente Olá se houver um failover: fragmento Olá agora reside em um novo servidor.</span><span class="sxs-lookup"><span data-stu-id="3400b-175">This is typically hello case if there is a failover: hello shard now resides on a new server.</span></span> <span data-ttu-id="3400b-176">Desde que o fragmento de saudação deve ser removido da saudação GSM (usando o método de RecoveryManager.DetachShard hello), um mapeamento não existe mais no hello GSM.</span><span class="sxs-lookup"><span data-stu-id="3400b-176">Since hello shard must first be removed from hello GSM (using hello RecoveryManager.DetachShard method), a mapping no longer exists on hello GSM.</span></span> <span data-ttu-id="3400b-177">Portanto, Olá LSM deve ser usado toore-estabelecer Olá mapeamento de fragmentos.</span><span class="sxs-lookup"><span data-stu-id="3400b-177">Therefore, hello LSM must be used toore-establish hello shard mapping.</span></span>

## <a name="attach-a-shard-toohello-shardmap-after-a-shard-is-restored"></a><span data-ttu-id="3400b-178">Anexar um fragmento de toohello ShardMap depois que um fragmento é restaurado</span><span class="sxs-lookup"><span data-stu-id="3400b-178">Attach a shard toohello ShardMap after a shard is restored</span></span>
<span data-ttu-id="3400b-179">Olá [AttachShard método](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) anexa Olá mapa do fragmento toohello fragmento especificado.</span><span class="sxs-lookup"><span data-stu-id="3400b-179">hello [AttachShard method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) attaches hello given shard toohello shard map.</span></span> <span data-ttu-id="3400b-180">Ele detecta as inconsistências de mapa do fragmento e atualiza o fragmento de saudação do hello mapeamentos toomatch no ponto de saudação da restauração de fragmento de saudação.</span><span class="sxs-lookup"><span data-stu-id="3400b-180">It then detects any shard map inconsistencies and updates hello mappings toomatch hello shard at hello point of hello shard restoration.</span></span> <span data-ttu-id="3400b-181">Presume-se que esse banco de dados de saudação é também tooreflect renomeado Olá banco de dados nome original (antes de fragmento de saudação foi restaurado), desde que a restauração pontual de saudação padrões tooa novo banco de dados anexado com carimbo de hora hello.</span><span class="sxs-lookup"><span data-stu-id="3400b-181">It is assumed that hello database is also renamed tooreflect hello original database name (before hello shard was restored), since hello point-in time restoration defaults tooa new database appended with hello timestamp.</span></span> 

   ```
   rm.AttachShard(location, shardMapName)
   ``` 

* <span data-ttu-id="3400b-182">Olá *local* parâmetro é o nome do servidor de saudação e o nome do banco de dados de fragmento Olá que está sendo anexado.</span><span class="sxs-lookup"><span data-stu-id="3400b-182">hello *location* parameter is hello server name and database name, of hello shard being attached.</span></span> 
* <span data-ttu-id="3400b-183">Olá *shardMapName* parâmetro é o nome do mapa de fragmentos hello.</span><span class="sxs-lookup"><span data-stu-id="3400b-183">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="3400b-184">Isso só é necessária quando vários mapas de fragmento são gerenciados pelo Olá mesmo Gerenciador de mapa do fragmento.</span><span class="sxs-lookup"><span data-stu-id="3400b-184">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="3400b-185">Opcional.</span><span class="sxs-lookup"><span data-stu-id="3400b-185">Optional.</span></span> 

<span data-ttu-id="3400b-186">Este exemplo adiciona um mapa do fragmento toohello fragmento que foram restaurado recentemente de um tempo de ponto anterior.</span><span class="sxs-lookup"><span data-stu-id="3400b-186">This example adds a shard toohello shard map that has been recently restored from an earlier point-in time.</span></span> <span data-ttu-id="3400b-187">Como o fragmento hello (ou seja, Olá mapeamento de fragmentos de saudação em Olá LSM) tiver sido restaurado, é potencialmente inconsistente com entrada de fragmento Olá Olá GSM.</span><span class="sxs-lookup"><span data-stu-id="3400b-187">Since hello shard (namely hello mapping for hello shard in hello LSM) has been restored, it is potentially inconsistent with hello shard entry in hello GSM.</span></span> <span data-ttu-id="3400b-188">Fora do código de exemplo, o fragmento de saudação foi restaurado e renomeado toohello o nome original do banco de dados de saudação.</span><span class="sxs-lookup"><span data-stu-id="3400b-188">Outside of this example code, hello shard was restored and renamed toohello original name of hello database.</span></span> <span data-ttu-id="3400b-189">Desde que ele foi restaurado, presume-se mapeamento de saudação no hello LSM é mapeamento confiável hello.</span><span class="sxs-lookup"><span data-stu-id="3400b-189">Since it was restored, it is assumed hello mapping in hello LSM is hello trusted mapping.</span></span> 

   ```
   rm.AttachShard(s.Location, customerMap); 
   var gs = rm.DetectMappingDifferences(s.Location); 
      foreach (RecoveryToken g in gs) 
       { 
       rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
       } 
   ```

## <a name="updating-shard-locations-after-a-geo-failover-restore-of-hello-shards"></a><span data-ttu-id="3400b-190">Atualizar locais de fragmento após um failover geográfico (Restaurar) de fragmentos de saudação</span><span class="sxs-lookup"><span data-stu-id="3400b-190">Updating shard locations after a geo-failover (restore) of hello shards</span></span>
<span data-ttu-id="3400b-191">Se houver um failover geográfico, o banco de dados secundário Olá é disponibilizado de gravação e se torna Olá novo principal banco de dados.</span><span class="sxs-lookup"><span data-stu-id="3400b-191">If there is a geo-failover, hello secondary database is made write accessible and becomes hello new primary database.</span></span> <span data-ttu-id="3400b-192">Olá nome do servidor de saudação e, potencialmente, banco de dados de saudação (dependendo da configuração), pode ser diferente do primário original hello.</span><span class="sxs-lookup"><span data-stu-id="3400b-192">hello name of hello server, and potentially hello database (depending on your configuration), may be different from hello original primary.</span></span> <span data-ttu-id="3400b-193">Olá, portanto, as entradas de mapeamento de fragmento de saudação em Olá GSM e LSM deve ser corrigido.</span><span class="sxs-lookup"><span data-stu-id="3400b-193">Therefore hello mapping entries for hello shard in hello GSM and LSM must be fixed.</span></span> <span data-ttu-id="3400b-194">Da mesma forma, se hello banco de dados é restaurado tooa outro nome ou local ou tooan ponto anterior no tempo, isso pode causar inconsistências no hello mapas de fragmento.</span><span class="sxs-lookup"><span data-stu-id="3400b-194">Similarly, if hello database is restored tooa different name or location, or tooan earlier point in time, this might cause inconsistencies in hello shard maps.</span></span> <span data-ttu-id="3400b-195">Olá Gerenciador do mapa de fragmentos lida com a distribuição de saudação do banco de dados correto do toohello conexões abertas.</span><span class="sxs-lookup"><span data-stu-id="3400b-195">hello Shard Map Manager handles hello distribution of open connections toohello correct database.</span></span> <span data-ttu-id="3400b-196">Distribuição baseia-se em dados de saudação no mapa do fragmento hello e valor de saudação da chave de fragmentação Olá Olá destino da solicitação de aplicativos de saudação.</span><span class="sxs-lookup"><span data-stu-id="3400b-196">Distribution is based on hello data in hello shard map and hello value of hello sharding key that is hello target of hello applications request.</span></span> <span data-ttu-id="3400b-197">Após um failover geográfico, essas informações devem ser atualizadas com o nome do servidor precisa de saudação, nome do banco de dados e mapeamento de fragmentos de banco de dados recuperado Olá.</span><span class="sxs-lookup"><span data-stu-id="3400b-197">After a geo-failover, this information must be updated with hello accurate server name, database name and shard mapping of hello recovered database.</span></span> 

## <a name="best-practices"></a><span data-ttu-id="3400b-198">Práticas recomendadas</span><span class="sxs-lookup"><span data-stu-id="3400b-198">Best practices</span></span>
<span data-ttu-id="3400b-199">Failover de replicação geográfica e recuperação são operações que normalmente são gerenciadas por um administrador de nuvem do aplicativo hello intencionalmente utilizando um dos recursos de continuidade de negócios de bancos de dados do Azure SQL.</span><span class="sxs-lookup"><span data-stu-id="3400b-199">Geo-failover and recovery are operations typically managed by a cloud administrator of hello application intentionally utilizing one of Azure SQL Databases business continuity features.</span></span> <span data-ttu-id="3400b-200">Planejamento de continuidade de negócios exige processos, procedimentos e medidas tooensure que operações comerciais possam continuar sem interrupções.</span><span class="sxs-lookup"><span data-stu-id="3400b-200">Business continuity planning requires processes, procedures, and measures tooensure that business operations can continue without interruption.</span></span> <span data-ttu-id="3400b-201">Olá métodos disponíveis como parte do hello RecoveryManager classe deve ser usada nessa saudação de tooensure de fluxo de trabalho GSM e LSM são mantidos atualizados com base na ação de recuperação Olá realizada.</span><span class="sxs-lookup"><span data-stu-id="3400b-201">hello methods available as part of hello RecoveryManager class should be used within this work flow tooensure hello GSM and LSM are kept up-to-date based on hello recovery action taken.</span></span> <span data-ttu-id="3400b-202">Há cinco etapas básicas tooproperly garantindo Olá GSM e LSM refletem informações precisas de saudação após um evento de failover.</span><span class="sxs-lookup"><span data-stu-id="3400b-202">There are five basic steps tooproperly ensuring hello GSM and LSM reflect hello accurate information after a failover event.</span></span> <span data-ttu-id="3400b-203">Olá tooexecute de código de aplicativo, que essas etapas podem ser integradas no fluxo de trabalho e as ferramentas existentes.</span><span class="sxs-lookup"><span data-stu-id="3400b-203">hello application code tooexecute these steps can be integrated into existing tools and workflow.</span></span> 

1. <span data-ttu-id="3400b-204">Recupere Olá RecoveryManager de saudação ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="3400b-204">Retrieve hello RecoveryManager from hello ShardMapManager.</span></span> 
2. <span data-ttu-id="3400b-205">Desanexe o fragmento antigo de saudação do mapa do fragmento hello.</span><span class="sxs-lookup"><span data-stu-id="3400b-205">Detach hello old shard from hello shard map.</span></span>
3. <span data-ttu-id="3400b-206">Anexe Olá novo fragmento toohello mapa do fragmento, incluindo o novo local de fragmento hello.</span><span class="sxs-lookup"><span data-stu-id="3400b-206">Attach hello new shard toohello shard map, including hello new shard location.</span></span>
4. <span data-ttu-id="3400b-207">Detecte inconsistências no hello mapeamento entre hello GSM e LSM.</span><span class="sxs-lookup"><span data-stu-id="3400b-207">Detect inconsistencies in hello mapping between hello GSM and LSM.</span></span> 
5. <span data-ttu-id="3400b-208">Resolva as diferenças entre Olá GSM e hello LSM, Olá confiante LSM.</span><span class="sxs-lookup"><span data-stu-id="3400b-208">Resolve differences between hello GSM and hello LSM, trusting hello LSM.</span></span> 

<span data-ttu-id="3400b-209">Este exemplo executa Olá etapas a seguir:</span><span class="sxs-lookup"><span data-stu-id="3400b-209">This example performs hello following steps:</span></span>

1. <span data-ttu-id="3400b-210">Remove fragmentos Olá mapa do fragmento que refletem os locais de fragmento antes do evento de failover de saudação.</span><span class="sxs-lookup"><span data-stu-id="3400b-210">Removes shards from hello Shard Map that reflect shard locations before hello failover event.</span></span>
2. <span data-ttu-id="3400b-211">Anexa fragmentos toohello mapa do fragmento refletindo Olá novos fragmentos locais (parâmetro hello "Configuration.SecondaryServer" é o novo nome do servidor Olá mas Olá mesmo nome de banco de dados).</span><span class="sxs-lookup"><span data-stu-id="3400b-211">Attaches shards toohello Shard Map reflecting hello new shard locations (hello parameter "Configuration.SecondaryServer" is hello new server name but hello same database name).</span></span>
3. <span data-ttu-id="3400b-212">Recupera os tokens de recuperação Olá detectando diferenças de mapeamento entre hello GSM e hello LSM para cada fragmento.</span><span class="sxs-lookup"><span data-stu-id="3400b-212">Retrieves hello recovery tokens by detecting mapping differences between hello GSM and hello LSM for each shard.</span></span> 
4. <span data-ttu-id="3400b-213">Resolve inconsistências Olá mapeando confiante Olá da saudação LSM de cada fragmento.</span><span class="sxs-lookup"><span data-stu-id="3400b-213">Resolves hello inconsistencies by trusting hello mapping from hello LSM of each shard.</span></span> 
   
   ```
   var shards = smm.GetShards(); 
   foreach (shard s in shards) 
   { 
     if (s.Location.Server == Configuration.PrimaryServer) 
   
         { 
          ShardLocation slNew = new ShardLocation(Configuration.SecondaryServer, s.Location.Database); 
   
          rm.DetachShard(s.Location); 
   
          rm.AttachShard(slNew); 
   
          var gs = rm.DetectMappingDifferences(slNew); 
   
          foreach (RecoveryToken g in gs) 
            { 
               rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
            } 
        } 
    } 
   ```

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png

