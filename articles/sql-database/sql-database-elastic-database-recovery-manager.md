---
title: "Usando o Gerenciador de Recuperação para corrigir problemas do mapa de fragmentos | Microsoft Docs"
description: Use a classe RecoveryManager para resolver problemas com mapas de fragmentos
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 45520ca3-6903-4b39-88ba-1d41b22da9fe
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/25/2016
ms.author: ddove
ms.openlocfilehash: e60e2295484873ea15d52108b7d619319a57827f
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="using-the-recoverymanager-class-to-fix-shard-map-problems"></a><span data-ttu-id="2332d-103">Usando a classe RecoveryManager para corrigir problemas do mapa de fragmentos</span><span class="sxs-lookup"><span data-stu-id="2332d-103">Using the RecoveryManager class to fix shard map problems</span></span>
<span data-ttu-id="2332d-104">A classe [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) fornece aos aplicativos ADO.Net a capacidade de detectar e de corrigir facilmente qualquer inconsistência entre o GSM (mapa de fragmentos global) e o LSM (mapa de fragmentos local) em um ambiente de banco de dados fragmentado.</span><span class="sxs-lookup"><span data-stu-id="2332d-104">The [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) class provides ADO.Net applications the ability to easily detect and correct any inconsistencies between the global shard map (GSM) and the local shard map (LSM) in a sharded database environment.</span></span> 

<span data-ttu-id="2332d-105">O GSM e o LSM rastreiam o mapeamento de cada banco de dados em um ambiente fragmentado.</span><span class="sxs-lookup"><span data-stu-id="2332d-105">The GSM and LSM track the mapping of each database in a sharded environment.</span></span> <span data-ttu-id="2332d-106">Ocasionalmente, ocorre uma interrupção entre o GSM e o LSM.</span><span class="sxs-lookup"><span data-stu-id="2332d-106">Occasionally, a break occurs between the GSM and the LSM.</span></span> <span data-ttu-id="2332d-107">Nesse caso, use a classe RecoveryManager para detectar e reparar a interrupção.</span><span class="sxs-lookup"><span data-stu-id="2332d-107">In that case, use the RecoveryManager class to detect and repair the break.</span></span>

<span data-ttu-id="2332d-108">A classe RecoveryManager faz parte da [biblioteca de cliente do Banco de Dados Elástico](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="2332d-108">The RecoveryManager class is part of the [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> 

![Mapa de fragmentos][1]

<span data-ttu-id="2332d-110">Para obter definições de termos, consulte o [Glossário de ferramentas do Banco de Dados Elástico](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="2332d-110">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span> <span data-ttu-id="2332d-111">Para entender como o **ShardMapManager** é usado para gerenciar dados em uma solução fragmentada, consulte [Gerenciamento do mapa de fragmentos](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="2332d-111">To understand how the **ShardMapManager** is used to manage data in a sharded solution, see [Shard map management](sql-database-elastic-scale-shard-map-management.md).</span></span>

## <a name="why-use-the-recovery-manager"></a><span data-ttu-id="2332d-112">Por que usar o gerenciador de recuperação?</span><span class="sxs-lookup"><span data-stu-id="2332d-112">Why use the recovery manager?</span></span>
<span data-ttu-id="2332d-113">Em um ambiente de banco de dados fragmentado, há um locatário por banco de dados e muitos bancos de dados por servidor.</span><span class="sxs-lookup"><span data-stu-id="2332d-113">In a sharded database environment, there is one tenant per database, and many databases per server.</span></span> <span data-ttu-id="2332d-114">Também pode haver vários servidores no ambiente.</span><span class="sxs-lookup"><span data-stu-id="2332d-114">There can also be many servers in the environment.</span></span> <span data-ttu-id="2332d-115">Cada banco de dados é mapeado no mapa de fragmento para que as chamadas possam ser encaminhadas para o banco de dados e servidor corretos.</span><span class="sxs-lookup"><span data-stu-id="2332d-115">Each database is mapped in the shard map, so calls can be routed to the correct server and database.</span></span> <span data-ttu-id="2332d-116">Os bancos de dados são controlados de acordo com uma **chave de fragmentação** e um **intervalo de valores de chave** é atribuído a cada fragmento.</span><span class="sxs-lookup"><span data-stu-id="2332d-116">Databases are tracked according to a **sharding key**, and each shard is assigned a **range of key values**.</span></span> <span data-ttu-id="2332d-117">Por exemplo, uma chave de fragmentação pode representar os nomes de clientes de "D" a "F".</span><span class="sxs-lookup"><span data-stu-id="2332d-117">For example, a sharding key may represent the customer names from "D" to "F."</span></span> <span data-ttu-id="2332d-118">O mapeamento de todos os fragmentos (também conhecido como bancos de dados) e seus intervalos de mapeamento estão contidos no **GSM (mapa de fragmentos global)**.</span><span class="sxs-lookup"><span data-stu-id="2332d-118">The mapping of all shards (aka databases) and their mapping ranges are contained in the **global shard map (GSM)**.</span></span> <span data-ttu-id="2332d-119">Cada banco de dados também contém um mapa dos intervalos contidos no fragmento – isso é conhecido como o **LSM (mapa de fragmentos local)**.</span><span class="sxs-lookup"><span data-stu-id="2332d-119">Each database also contains a map of the ranges contained on the shard that is known as the **local shard map (LSM)**.</span></span> <span data-ttu-id="2332d-120">Quando um aplicativo se conecta a um fragmento, o mapeamento é armazenado em cache com o aplicativo para recuperação rápida.</span><span class="sxs-lookup"><span data-stu-id="2332d-120">When an app connects to a shard, the mapping is cached with the app for quick retrieval.</span></span> <span data-ttu-id="2332d-121">O LSM é usado para validar dados em cache.</span><span class="sxs-lookup"><span data-stu-id="2332d-121">The LSM is used to validate cached data.</span></span> 

<span data-ttu-id="2332d-122">O GSM e o LSM podem ficar fora de sincronia pelos seguintes motivos:</span><span class="sxs-lookup"><span data-stu-id="2332d-122">The GSM and LSM may become out of sync for the following reasons:</span></span>

1. <span data-ttu-id="2332d-123">Exclusão de um fragmento cujo intervalo acredita-se não estar mais sendo usado, ou renomeação de um fragmento.</span><span class="sxs-lookup"><span data-stu-id="2332d-123">The deletion of a shard whose range is believed to no longer be in use, or renaming of a shard.</span></span> <span data-ttu-id="2332d-124">A exclusão de um fragmento resulta em um **mapeamento de fragmento órfão**.</span><span class="sxs-lookup"><span data-stu-id="2332d-124">Deleting a shard results in an **orphaned shard mapping**.</span></span> <span data-ttu-id="2332d-125">De modo semelhante, um banco de dados renomeado pode causar um mapeamento de fragmentos órfãos.</span><span class="sxs-lookup"><span data-stu-id="2332d-125">Similarly, a renamed database can cause an orphaned shard mapping.</span></span> <span data-ttu-id="2332d-126">Dependendo da intenção da alteração, o fragmento pode precisar ser removido ou a localização do fragmento precisa ser atualizada.</span><span class="sxs-lookup"><span data-stu-id="2332d-126">Depending on the intent of the change, the shard may need to be removed or the shard location needs to be updated.</span></span> <span data-ttu-id="2332d-127">Para recuperar um banco de dados excluído, consulte [Restaurar um banco de dados excluído](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="2332d-127">To recover a deleted database, see [Restore a deleted database](sql-database-recovery-using-backups.md).</span></span>
2. <span data-ttu-id="2332d-128">Ocorre um evento de failover geográfico.</span><span class="sxs-lookup"><span data-stu-id="2332d-128">A geo-failover event occurs.</span></span> <span data-ttu-id="2332d-129">Para continuar, é necessário atualizar o nome do servidor e o nome do banco de dados do gerenciador do mapa de fragmento no aplicativo e atualizar os detalhes do mapeamento de fragmento para todos os fragmentos em um mapa de fragmentos.</span><span class="sxs-lookup"><span data-stu-id="2332d-129">To continue, one must update the server name, and database name of shard map manager in the application and then update the shard mapping details for all shards in a shard map.</span></span> <span data-ttu-id="2332d-130">Em caso de um failover geográfico, tal lógica de recuperação deverá ser automatizada no fluxo de trabalho do failover.</span><span class="sxs-lookup"><span data-stu-id="2332d-130">If there is a geo-failover, such recovery logic should be automated within the failover workflow.</span></span> <span data-ttu-id="2332d-131">A automação das ações de recuperação proporciona capacidade de gerenciamento ininterrupta para bancos de dados habilitados geograficamente e evita ações humanas manuais.</span><span class="sxs-lookup"><span data-stu-id="2332d-131">Automating recovery actions enables a frictionless manageability for geo-enabled databases and avoids manual human actions.</span></span> <span data-ttu-id="2332d-132">Para saber mais sobre as opções para recuperar um banco de dados no caso de uma interrupção do data center, consulte [Continuidade dos negócios](sql-database-business-continuity.md) e [Recuperação de desastre](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="2332d-132">To learn about options to recover a database if there is a data center outage, see [Business Continuity](sql-database-business-continuity.md) and [Disaster Recovery](sql-database-disaster-recovery.md).</span></span>
3. <span data-ttu-id="2332d-133">Um fragmento ou o banco de dados ShardMapManager é restaurado para um ponto anterior.</span><span class="sxs-lookup"><span data-stu-id="2332d-133">Either a shard or the ShardMapManager database is restored to an earlier point-in time.</span></span> <span data-ttu-id="2332d-134">Para saber mais sobre recuperação pontual usando backups, consulte [Recuperação usando backups](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="2332d-134">To learn about point in time recovery using backups, see [Recovery using backups](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="2332d-135">Para saber mais sobre as ferramentas do Banco de dados elástico do Banco de dados SQL do Azure, a Restauração e a Replicação geográfica, consulte os artigos a seguir:</span><span class="sxs-lookup"><span data-stu-id="2332d-135">For more information about Azure SQL Database Elastic Database tools, geo-replication and Restore, see the following:</span></span> 

* [<span data-ttu-id="2332d-136">Visão geral: continuidade de negócios em nuvem e recuperação de desastre do banco de dados com o banco de dados SQL</span><span class="sxs-lookup"><span data-stu-id="2332d-136">Overview: Cloud business continuity and database disaster recovery with SQL Database</span></span>](sql-database-business-continuity.md) 
* [<span data-ttu-id="2332d-137">Comece com ferramentas de banco de dados elástico</span><span class="sxs-lookup"><span data-stu-id="2332d-137">Get started with elastic database tools</span></span>](sql-database-elastic-scale-get-started.md)  
* [<span data-ttu-id="2332d-138">Gerenciamento de ShardMap</span><span class="sxs-lookup"><span data-stu-id="2332d-138">ShardMap Management</span></span>](sql-database-elastic-scale-shard-map-management.md)

## <a name="retrieving-recoverymanager-from-a-shardmapmanager"></a><span data-ttu-id="2332d-139">Recuperando o RecoveryManager de um ShardMapManager</span><span class="sxs-lookup"><span data-stu-id="2332d-139">Retrieving RecoveryManager from a ShardMapManager</span></span>
<span data-ttu-id="2332d-140">A primeira etapa é criar uma instância do RecoveryManager.</span><span class="sxs-lookup"><span data-stu-id="2332d-140">The first step is to create a RecoveryManager instance.</span></span> <span data-ttu-id="2332d-141">O [método GetRecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) retorna o gerenciador de recuperação da instância [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) atual.</span><span class="sxs-lookup"><span data-stu-id="2332d-141">The [GetRecoveryManager method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) returns the recovery manager for the current [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span></span> <span data-ttu-id="2332d-142">Para solucionar as inconsistências no mapa de fragmentos, você deverá primeiramente recuperar o RecoveryManager para o mapa de fragmentos específico.</span><span class="sxs-lookup"><span data-stu-id="2332d-142">To address any inconsistencies in the shard map, you must first retrieve the RecoveryManager for the particular shard map.</span></span> 

   ```
    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 
   ```

<span data-ttu-id="2332d-143">Neste exemplo, o RecoveryManager é inicializado no ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="2332d-143">In this example, the RecoveryManager is initialized from the ShardMapManager.</span></span> <span data-ttu-id="2332d-144">O ShardMapManager que contém um ShardMap também já foi inicializado.</span><span class="sxs-lookup"><span data-stu-id="2332d-144">The ShardMapManager containing a ShardMap is also already initialized.</span></span> 

<span data-ttu-id="2332d-145">Uma vez que o código desse aplicativo manipula o mapa de fragmentos em si, as credenciais usadas no método de fábrica (no exemplo anterior, smmConnectionString) devem ser credenciais que tenham permissões de leitura/gravação no banco de dados GSM referenciado pela cadeia de conexão.</span><span class="sxs-lookup"><span data-stu-id="2332d-145">Since this application code manipulates the shard map itself, the credentials used in the factory method (in the preceding example, smmConnectionString) should be credentials that have read-write permissions on the GSM database referenced by the connection string.</span></span> <span data-ttu-id="2332d-146">Essas credenciais normalmente são diferentes das credenciais usadas para abrir conexões de roteamento dependente de dados.</span><span class="sxs-lookup"><span data-stu-id="2332d-146">These credentials are typically different from credentials used to open connections for data-dependent routing.</span></span> <span data-ttu-id="2332d-147">Para saber mais, consulte [Usando credenciais no cliente do banco de dados elástico](sql-database-elastic-scale-manage-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="2332d-147">For more information, see [Using credentials in the elastic database client](sql-database-elastic-scale-manage-credentials.md).</span></span>

## <a name="removing-a-shard-from-the-shardmap-after-a-shard-is-deleted"></a><span data-ttu-id="2332d-148">Removendo um fragmento do ShardMap depois que um fragmento é excluído</span><span class="sxs-lookup"><span data-stu-id="2332d-148">Removing a shard from the ShardMap after a shard is deleted</span></span>
<span data-ttu-id="2332d-149">O [método DetachShard](https://msdn.microsoft.com/library/azure/dn842083.aspx) desanexa o fragmento determinado do mapa de fragmentos e exclui os mapeamentos associados ao fragmento.</span><span class="sxs-lookup"><span data-stu-id="2332d-149">The [DetachShard method](https://msdn.microsoft.com/library/azure/dn842083.aspx) detaches the given shard from the shard map and deletes mappings associated with the shard.</span></span>  

* <span data-ttu-id="2332d-150">O parâmetro location é o local do fragmento, especificamente o nome do servidor e o nome do banco de dados, do fragmento que está sendo desanexado.</span><span class="sxs-lookup"><span data-stu-id="2332d-150">The location parameter is the shard location, specifically server name and database name, of the shard being detached.</span></span> 
* <span data-ttu-id="2332d-151">O parâmetro shardMapName é o nome do mapa de fragmentos.</span><span class="sxs-lookup"><span data-stu-id="2332d-151">The shardMapName parameter is the shard map name.</span></span> <span data-ttu-id="2332d-152">Isso só será necessário quando vários mapas de fragmentos forem gerenciados pelo mesmo gerenciador de mapas de fragmentos.</span><span class="sxs-lookup"><span data-stu-id="2332d-152">This is only required when multiple shard maps are managed by the same shard map manager.</span></span> <span data-ttu-id="2332d-153">Opcional.</span><span class="sxs-lookup"><span data-stu-id="2332d-153">Optional.</span></span> 


> [!IMPORTANT]
> <span data-ttu-id="2332d-154">Use essa técnica somente se você tiver certeza de que o intervalo para o mapeamento atualizado está vazio.</span><span class="sxs-lookup"><span data-stu-id="2332d-154">Use this technique only if you are certain that the range for the updated mapping is empty.</span></span> <span data-ttu-id="2332d-155">Os métodos acima não verificam os dados para o intervalo que está sendo movido, portanto, é melhor incluir verificações em seu código.</span><span class="sxs-lookup"><span data-stu-id="2332d-155">The methods above do not check data for the range being moved, so it is best to include checks in your code.</span></span>
>

<span data-ttu-id="2332d-156">Este exemplo remove fragmentos do mapa do fragmento.</span><span class="sxs-lookup"><span data-stu-id="2332d-156">This example removes shards from the shard map.</span></span> 

   ```
   rm.DetachShard(s.Location, customerMap);
   ``` 

<span data-ttu-id="2332d-157">O mapa de fragmento reflete a localização do fragmento no GSM antes de sua exclusão.</span><span class="sxs-lookup"><span data-stu-id="2332d-157">The shard map reflects the shard location in the GSM before the deletion of the shard.</span></span> <span data-ttu-id="2332d-158">Como o fragmento foi excluído, é pressuposto que isso foi intencional, e o intervalo de chaves de fragmentação não está mais em uso.</span><span class="sxs-lookup"><span data-stu-id="2332d-158">Because the shard was deleted, it is assumed this was intentional, and the sharding key range is no longer in use.</span></span> <span data-ttu-id="2332d-159">Se esse não for o caso, você poderá executar a restauração pontual.</span><span class="sxs-lookup"><span data-stu-id="2332d-159">If not, you can execute point-in time restore.</span></span> <span data-ttu-id="2332d-160">para recuperar o fragmento de um ponto no tempo anterior.</span><span class="sxs-lookup"><span data-stu-id="2332d-160">to recover the shard from an earlier point-in-time.</span></span> <span data-ttu-id="2332d-161">(Nesse caso, examine a seção a seguir para detectar inconsistências de fragmento.) Para recuperar, consulte [Recuperação pontual](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="2332d-161">(In that case, review the following section to detect shard inconsistencies.) To recover, see [Point in time recovery](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="2332d-162">Uma vez que é pressuposto que a exclusão do banco de dados foi intencional, a ação de limpeza administrativa final é excluir a entrada para o fragmento no gerenciador de mapas de fragmentos.</span><span class="sxs-lookup"><span data-stu-id="2332d-162">Since it is assumed the database deletion was intentional, the final administrative cleanup action is to delete the entry to the shard in the shard map manager.</span></span> <span data-ttu-id="2332d-163">Isso impede que o aplicativo grave informações inadvertidamente em um intervalo não esperado.</span><span class="sxs-lookup"><span data-stu-id="2332d-163">This prevents the application from inadvertently writing information to a range that is not expected.</span></span>

## <a name="to-detect-mapping-differences"></a><span data-ttu-id="2332d-164">Para detectar diferenças de mapeamento</span><span class="sxs-lookup"><span data-stu-id="2332d-164">To detect mapping differences</span></span>
<span data-ttu-id="2332d-165">O [método DetectMappingDifferences](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) seleciona e retorna um dos mapas de fragmentos (local ou global) como a fonte da relação de confiança e reconcilia os mapeamentos em ambos os mapas de fragmento (GSM e LSM).</span><span class="sxs-lookup"><span data-stu-id="2332d-165">The [DetectMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selects and returns one of the shard maps (either local or global) as the source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   rm.DetectMappingDifferences(location, shardMapName);
   ```

* <span data-ttu-id="2332d-166">O *local* especifica o nome do servidor e o nome do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="2332d-166">The *location* specifies the server name and database name.</span></span> 
* <span data-ttu-id="2332d-167">O parâmetro *shardMapName* é o nome do mapa de fragmentos.</span><span class="sxs-lookup"><span data-stu-id="2332d-167">The *shardMapName* parameter is the shard map name.</span></span> <span data-ttu-id="2332d-168">Isso só será necessário se vários mapas de fragmentos forem gerenciados pelo mesmo gerenciador de mapas de fragmentos.</span><span class="sxs-lookup"><span data-stu-id="2332d-168">This is only required if multiple shard maps are managed by the same shard map manager.</span></span> <span data-ttu-id="2332d-169">Opcional.</span><span class="sxs-lookup"><span data-stu-id="2332d-169">Optional.</span></span> 

## <a name="to-resolve-mapping-differences"></a><span data-ttu-id="2332d-170">Para resolver as diferenças de mapeamento</span><span class="sxs-lookup"><span data-stu-id="2332d-170">To resolve mapping differences</span></span>
<span data-ttu-id="2332d-171">O [método ResolveMappingDifferences](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) seleciona um dos mapas de fragmentos (local ou global) como a fonte da relação de confiança e reconcilia os mapeamentos em ambos os mapas de fragmento (GSM e LSM).</span><span class="sxs-lookup"><span data-stu-id="2332d-171">The [ResolveMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selects one of the shard maps (either local or global) as the source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   ```

* <span data-ttu-id="2332d-172">O parâmetro *RecoveryToken* enumera as diferenças nos mapeamentos entre o GSM e o LSM para o fragmento específico.</span><span class="sxs-lookup"><span data-stu-id="2332d-172">The *RecoveryToken* parameter enumerates the differences in the mappings between the GSM and the LSM for the specific shard.</span></span> 
* <span data-ttu-id="2332d-173">A [enumeração MappingDifferenceResolution](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) é usada para indicar o método de resolução da diferença entre os mapeamentos de fragmento.</span><span class="sxs-lookup"><span data-stu-id="2332d-173">The [MappingDifferenceResolution enumeration](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) is used to indicate the method for resolving the difference between the shard mappings.</span></span> 
* <span data-ttu-id="2332d-174">**MappingDifferenceResolution.KeepShardMapping** é recomendado no caso em que o LSM contém o mapeamento preciso e, portanto, o mapeamento no fragmento deve ser usado.</span><span class="sxs-lookup"><span data-stu-id="2332d-174">**MappingDifferenceResolution.KeepShardMapping** is recommended that when the LSM contains the accurate mapping and therefore the mapping in the shard should be used.</span></span> <span data-ttu-id="2332d-175">Normalmente, isso acontece no caso de um failover: o fragmento agora reside em um novo servidor.</span><span class="sxs-lookup"><span data-stu-id="2332d-175">This is typically the case if there is a failover: the shard now resides on a new server.</span></span> <span data-ttu-id="2332d-176">Uma vez que o fragmento deve primeiramente ser removido do GSM (usando o método RecoveryManager.DetachShard), um mapeamento não existe mais no GSM.</span><span class="sxs-lookup"><span data-stu-id="2332d-176">Since the shard must first be removed from the GSM (using the RecoveryManager.DetachShard method), a mapping no longer exists on the GSM.</span></span> <span data-ttu-id="2332d-177">Assim, o LSM deve ser usado para restabelecer o mapeamento de fragmento.</span><span class="sxs-lookup"><span data-stu-id="2332d-177">Therefore, the LSM must be used to re-establish the shard mapping.</span></span>

## <a name="attach-a-shard-to-the-shardmap-after-a-shard-is-restored"></a><span data-ttu-id="2332d-178">Anexar um fragmento ao ShardMap depois que um fragmento é restaurado</span><span class="sxs-lookup"><span data-stu-id="2332d-178">Attach a shard to the ShardMap after a shard is restored</span></span>
<span data-ttu-id="2332d-179">O [método AttachShard](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) anexa o fragmento determinado ao mapa de fragmentos.</span><span class="sxs-lookup"><span data-stu-id="2332d-179">The [AttachShard method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) attaches the given shard to the shard map.</span></span> <span data-ttu-id="2332d-180">Ele detecta todas as inconsistências do mapa de fragmentos e atualiza os mapeamentos para corresponder ao fragmento no ponto de restauração do fragmento.</span><span class="sxs-lookup"><span data-stu-id="2332d-180">It then detects any shard map inconsistencies and updates the mappings to match the shard at the point of the shard restoration.</span></span> <span data-ttu-id="2332d-181">É pressuposto que o banco de dados também seja renomeado para refletir o nome do banco de dados original (antes de o fragmento ter sido restaurado), já que a restauração pontual é padronizada para um novo banco de dados com o carimbo de data/hora.</span><span class="sxs-lookup"><span data-stu-id="2332d-181">It is assumed that the database is also renamed to reflect the original database name (before the shard was restored), since the point-in time restoration defaults to a new database appended with the timestamp.</span></span> 

   ```
   rm.AttachShard(location, shardMapName)
   ``` 

* <span data-ttu-id="2332d-182">O parâmetro *location* é o nome do servidor e o nome do banco de dados do fragmento que está sendo anexado.</span><span class="sxs-lookup"><span data-stu-id="2332d-182">The *location* parameter is the server name and database name, of the shard being attached.</span></span> 
* <span data-ttu-id="2332d-183">O parâmetro *shardMapName* é o nome do mapa de fragmentos.</span><span class="sxs-lookup"><span data-stu-id="2332d-183">The *shardMapName* parameter is the shard map name.</span></span> <span data-ttu-id="2332d-184">Isso só será necessário quando vários mapas de fragmentos forem gerenciados pelo mesmo gerenciador de mapas de fragmentos.</span><span class="sxs-lookup"><span data-stu-id="2332d-184">This is only required when multiple shard maps are managed by the same shard map manager.</span></span> <span data-ttu-id="2332d-185">Opcional.</span><span class="sxs-lookup"><span data-stu-id="2332d-185">Optional.</span></span> 

<span data-ttu-id="2332d-186">Este exemplo adiciona um fragmento ao Mapa de Fragmentos que foi restaurado recentemente de um ponto anterior.</span><span class="sxs-lookup"><span data-stu-id="2332d-186">This example adds a shard to the shard map that has been recently restored from an earlier point-in time.</span></span> <span data-ttu-id="2332d-187">Uma vez que o fragmento (ou seja, o mapeamento para o fragmento no LSM) tenha sido restaurado, ele é potencialmente inconsistente com a entrada de fragmento no GSM.</span><span class="sxs-lookup"><span data-stu-id="2332d-187">Since the shard (namely the mapping for the shard in the LSM) has been restored, it is potentially inconsistent with the shard entry in the GSM.</span></span> <span data-ttu-id="2332d-188">Fora desse código de exemplo, o fragmento foi restaurado e renomeado para o nome original do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="2332d-188">Outside of this example code, the shard was restored and renamed to the original name of the database.</span></span> <span data-ttu-id="2332d-189">Como ele foi restaurado, é pressuposto que o mapeamento no LSM seja o mapeamento confiável.</span><span class="sxs-lookup"><span data-stu-id="2332d-189">Since it was restored, it is assumed the mapping in the LSM is the trusted mapping.</span></span> 

   ```
   rm.AttachShard(s.Location, customerMap); 
   var gs = rm.DetectMappingDifferences(s.Location); 
      foreach (RecoveryToken g in gs) 
       { 
       rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
       } 
   ```

## <a name="updating-shard-locations-after-a-geo-failover-restore-of-the-shards"></a><span data-ttu-id="2332d-190">Atualizando os locais do fragmento depois de um failover geográfico (restauração) dos fragmentos</span><span class="sxs-lookup"><span data-stu-id="2332d-190">Updating shard locations after a geo-failover (restore) of the shards</span></span>
<span data-ttu-id="2332d-191">Em caso de um failover geográfico, o banco de dados secundário será disponibilizado para gravação e se tornará o novo banco de dados primário.</span><span class="sxs-lookup"><span data-stu-id="2332d-191">If there is a geo-failover, the secondary database is made write accessible and becomes the new primary database.</span></span> <span data-ttu-id="2332d-192">O nome do servidor e, possivelmente, do banco de dados (dependendo da sua configuração) podem ser diferentes do primário original.</span><span class="sxs-lookup"><span data-stu-id="2332d-192">The name of the server, and potentially the database (depending on your configuration), may be different from the original primary.</span></span> <span data-ttu-id="2332d-193">Portanto, as entradas do mapeamento para o fragmento no GSM e LSM devem ser corrigidas.</span><span class="sxs-lookup"><span data-stu-id="2332d-193">Therefore the mapping entries for the shard in the GSM and LSM must be fixed.</span></span> <span data-ttu-id="2332d-194">Da mesma forma, se o banco de dados for restaurado para um nome ou local diferente, ou para um ponto anterior no tempo, isso poderá causar inconsistências nos mapas de fragmentos.</span><span class="sxs-lookup"><span data-stu-id="2332d-194">Similarly, if the database is restored to a different name or location, or to an earlier point in time, this might cause inconsistencies in the shard maps.</span></span> <span data-ttu-id="2332d-195">O Gerenciador de Mapas de Fragmentos manipula a distribuição de conexões abertas para o banco de dados correto.</span><span class="sxs-lookup"><span data-stu-id="2332d-195">The Shard Map Manager handles the distribution of open connections to the correct database.</span></span> <span data-ttu-id="2332d-196">A distribuição baseia-se nos dados no mapa de fragmentos e no valor da chave de fragmentação que é o destino da solicitação dos aplicativos.</span><span class="sxs-lookup"><span data-stu-id="2332d-196">Distribution is based on the data in the shard map and the value of the sharding key that is the target of the applications request.</span></span> <span data-ttu-id="2332d-197">Após um failover geográfico, essas informações devem ser atualizadas com o nome de servidor, nome do banco de dados e mapeamento de fragmentos precisos do banco de dados recuperado.</span><span class="sxs-lookup"><span data-stu-id="2332d-197">After a geo-failover, this information must be updated with the accurate server name, database name and shard mapping of the recovered database.</span></span> 

## <a name="best-practices"></a><span data-ttu-id="2332d-198">Práticas recomendadas</span><span class="sxs-lookup"><span data-stu-id="2332d-198">Best practices</span></span>
<span data-ttu-id="2332d-199">O failover geográfico e a recuperação são operações normalmente gerenciadas por um administrador de nuvem do aplicativo intencionalmente utilizando um dos recursos de continuidade de negócios dos Bancos de Dados SQL do Azure.</span><span class="sxs-lookup"><span data-stu-id="2332d-199">Geo-failover and recovery are operations typically managed by a cloud administrator of the application intentionally utilizing one of Azure SQL Databases business continuity features.</span></span> <span data-ttu-id="2332d-200">O planejamento da continuidade de negócios exige processos, procedimentos e medidas para garantir que as operações de negócios possam continuar sem interrupção.</span><span class="sxs-lookup"><span data-stu-id="2332d-200">Business continuity planning requires processes, procedures, and measures to ensure that business operations can continue without interruption.</span></span> <span data-ttu-id="2332d-201">Os métodos disponíveis como parte da classe RecoveryManager devem ser usados dentro desse fluxo de trabalho para garantir que o GSM e LSM sejam mantidos atualizados com base na ação de recuperação tomada.</span><span class="sxs-lookup"><span data-stu-id="2332d-201">The methods available as part of the RecoveryManager class should be used within this work flow to ensure the GSM and LSM are kept up-to-date based on the recovery action taken.</span></span> <span data-ttu-id="2332d-202">Há cinco etapas básicas para garantir que o GSM e o LSM reflitam adequadamente as informações precisas depois de um evento de failover.</span><span class="sxs-lookup"><span data-stu-id="2332d-202">There are five basic steps to properly ensuring the GSM and LSM reflect the accurate information after a failover event.</span></span> <span data-ttu-id="2332d-203">O código do aplicativo para executar essas etapas pode ser integrado ao fluxo de trabalho e às ferramentas existentes.</span><span class="sxs-lookup"><span data-stu-id="2332d-203">The application code to execute these steps can be integrated into existing tools and workflow.</span></span> 

1. <span data-ttu-id="2332d-204">Recupere o RecoveryManager do ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="2332d-204">Retrieve the RecoveryManager from the ShardMapManager.</span></span> 
2. <span data-ttu-id="2332d-205">Desanexe o fragmento antigo do mapa de fragmentos.</span><span class="sxs-lookup"><span data-stu-id="2332d-205">Detach the old shard from the shard map.</span></span>
3. <span data-ttu-id="2332d-206">Anexe o novo fragmento ao mapa de fragmentos, incluindo o novo local do fragmento.</span><span class="sxs-lookup"><span data-stu-id="2332d-206">Attach the new shard to the shard map, including the new shard location.</span></span>
4. <span data-ttu-id="2332d-207">Detecte inconsistências no mapeamento entre o GSM e o LSM.</span><span class="sxs-lookup"><span data-stu-id="2332d-207">Detect inconsistencies in the mapping between the GSM and LSM.</span></span> 
5. <span data-ttu-id="2332d-208">Resolva as diferenças entre o GSM e o LSM, confiando no LSM.</span><span class="sxs-lookup"><span data-stu-id="2332d-208">Resolve differences between the GSM and the LSM, trusting the LSM.</span></span> 

<span data-ttu-id="2332d-209">Este exemplo executa as seguintes etapas:</span><span class="sxs-lookup"><span data-stu-id="2332d-209">This example performs the following steps:</span></span>

1. <span data-ttu-id="2332d-210">Remove os fragmentos do Mapa de Fragmentos que refletem locais do fragmento antes do evento de failover.</span><span class="sxs-lookup"><span data-stu-id="2332d-210">Removes shards from the Shard Map that reflect shard locations before the failover event.</span></span>
2. <span data-ttu-id="2332d-211">Anexa fragmentos ao Mapa de Fragmentos que reflete os novos locais do fragmento (o parâmetro "Configuration.SecondaryServer" é o novo nome do servidor, mas o nome do banco de dados é o mesmo).</span><span class="sxs-lookup"><span data-stu-id="2332d-211">Attaches shards to the Shard Map reflecting the new shard locations (the parameter "Configuration.SecondaryServer" is the new server name but the same database name).</span></span>
3. <span data-ttu-id="2332d-212">Recupera os tokens de recuperação detectando diferenças de mapeamento entre o GSM e o LSM para cada fragmento.</span><span class="sxs-lookup"><span data-stu-id="2332d-212">Retrieves the recovery tokens by detecting mapping differences between the GSM and the LSM for each shard.</span></span> 
4. <span data-ttu-id="2332d-213">Resolve as inconsistências confiando no mapeamento do LSM de cada fragmento.</span><span class="sxs-lookup"><span data-stu-id="2332d-213">Resolves the inconsistencies by trusting the mapping from the LSM of each shard.</span></span> 
   
   ```
   var shards = smm.GetShards(); 
   foreach (shard s in shards) 
   { 
     if (s.Location.Server == Configuration.PrimaryServer) 
   
         { 
          ShardLocation slNew = new ShardLocation(Configuration.SecondaryServer, s.Location.Database); 
   
          rm.DetachShard(s.Location); 
   
          rm.AttachShard(slNew); 
   
          var gs = rm.DetectMappingDifferences(slNew); 
   
          foreach (RecoveryToken g in gs) 
            { 
               rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
            } 
        } 
    } 
   ```

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png

