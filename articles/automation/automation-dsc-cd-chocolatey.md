---
title: "Implantação Contínua de DSC de Automação do Azure com Chocolatey | Microsoft Docs"
description: "Implantação contínua de DevOps usando DSC de Automação do Azure e o gerenciador de pacotes Chocolatey.  Exemplo com modelo ARM JSON completo e fonte do PowerShell."
services: automation
documentationcenter: 
author: eslesar
manager: carmonm
editor: tysonn
ms.assetid: c0baa411-eb76-4f91-8d14-68f68b4805b6
ms.service: automation
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: na
ms.date: 10/29/2016
ms.author: golive
ms.openlocfilehash: f23d7374a8954a0a95853fa9e00b54a8d9c468c4
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="usage-example-continuous-deployment-to-virtual-machines-using-automation-dsc-and-chocolatey"></a><span data-ttu-id="a3900-104">Exemplo de uso: implantação contínua em Máquinas Virtuais usando a DSC de Automação e o Chocolatey</span><span class="sxs-lookup"><span data-stu-id="a3900-104">Usage Example: Continuous deployment to Virtual Machines using Automation DSC and Chocolatey</span></span>
<span data-ttu-id="a3900-105">Em um mundo de DevOps, há várias ferramentas para ajudá-lo em vários pontos no pipeline de Integração Contínua.</span><span class="sxs-lookup"><span data-stu-id="a3900-105">In a DevOps world there are many tools to assist with various points in the Continuous Integration pipeline.</span></span>  <span data-ttu-id="a3900-106">A DSC (Configuração do Estado Desejado) da Automação do Azure é uma nova adição bem-vinda para as opções que podem ser utilizadas por equipes de DevOps.</span><span class="sxs-lookup"><span data-stu-id="a3900-106">Azure Automation Desired State Configuration (DSC) is a welcome new addition to the options that DevOps teams can employ.</span></span>  <span data-ttu-id="a3900-107">Este artigo demonstra a configuração da CD (Implantação Contínua) para um computador com Windows.</span><span class="sxs-lookup"><span data-stu-id="a3900-107">This article demonstrates setting up Continuous Deployment (CD) for a Windows computer.</span></span>  <span data-ttu-id="a3900-108">Você pode facilmente ampliar a técnica para incluir tantos computadores com Windows quantos forem necessários na função (um site, por exemplo) e também para funções adicionais.</span><span class="sxs-lookup"><span data-stu-id="a3900-108">You can easily extend the technique to include as many Windows computers as necessary in the role (a web site, for example), and from there to additional roles as well.</span></span>

![Implantação contínua para VMs do IaaS](./media/automation-dsc-cd-chocolatey/cdforiaasvm.png)

## <a name="at-a-high-level"></a><span data-ttu-id="a3900-110">Em um alto nível</span><span class="sxs-lookup"><span data-stu-id="a3900-110">At a high level</span></span>
<span data-ttu-id="a3900-111">Há bem pouco acontecendo aqui, mas, felizmente, é possível dividir tudo em dois processos principais:</span><span class="sxs-lookup"><span data-stu-id="a3900-111">There is quite a bit going on here, but fortunately it can be broken into two main processes:</span></span> 

* <span data-ttu-id="a3900-112">Escrever código e testá-lo e, depois, criar e publicar pacotes de instalação para as versões principais e secundárias do sistema.</span><span class="sxs-lookup"><span data-stu-id="a3900-112">Writing code and testing it, then creating and publishing installation packages for major and minor versions of the system.</span></span> 
* <span data-ttu-id="a3900-113">Criar e gerenciar VMs que vão instalar e executar o código nos pacotes.</span><span class="sxs-lookup"><span data-stu-id="a3900-113">Creating and managing VMs that will install and execute the code in the packages.</span></span>  

<span data-ttu-id="a3900-114">Depois que esses dois processos principais são realizados, leva pouco tempo para atualizar automaticamente o pacote em execução em qualquer VM específica, à medida que novas versões são criadas e implantadas.</span><span class="sxs-lookup"><span data-stu-id="a3900-114">Once both of these core processes are in place, it’s a short step to automatically update the package running on any particular VM as new versions are created and deployed.</span></span>

## <a name="component-overview"></a><span data-ttu-id="a3900-115">Visão geral do componente</span><span class="sxs-lookup"><span data-stu-id="a3900-115">Component overview</span></span>
<span data-ttu-id="a3900-116">Os gerenciadores de pacotes como [apt-get](https://en.wikipedia.org/wiki/Advanced_Packaging_Tool) são muito conhecidos no mundo do Linux, mas nem tanto no mundo do Windows.</span><span class="sxs-lookup"><span data-stu-id="a3900-116">Package managers such as [apt-get](https://en.wikipedia.org/wiki/Advanced_Packaging_Tool) are pretty well known in the Linux world, but not so much in the Windows world.</span></span>  <span data-ttu-id="a3900-117">O [Chocolatey](https://chocolatey.org/) é um deles, e o [blog](http://www.hanselman.com/blog/IsTheWindowsUserReadyForAptget.aspx) de Scott Hanselman sobre esse tópico é uma excelente introdução.</span><span class="sxs-lookup"><span data-stu-id="a3900-117">[Chocolatey](https://chocolatey.org/) is such a thing, and Scott Hanselman’s [blog](http://www.hanselman.com/blog/IsTheWindowsUserReadyForAptget.aspx) on the topic is a great intro.</span></span>  <span data-ttu-id="a3900-118">Resumindo, o Chocolatey permite instalar pacotes de um repositório central de pacotes em um sistema do Windows usando a linha de comando.</span><span class="sxs-lookup"><span data-stu-id="a3900-118">In a nutshell, Chocolatey allows you to install packages from a central repository of packages into a Windows system using the command line.</span></span>  <span data-ttu-id="a3900-119">Você pode criar e gerenciar seu próprio repositório, e o Chocolatey pode instalar pacotes de qualquer repositório que você designar.</span><span class="sxs-lookup"><span data-stu-id="a3900-119">You can create and manage your own repository, and Chocolatey can install packages from any number of repositories that you designate.</span></span>

<span data-ttu-id="a3900-120">A DSC (Configuração de Estado Desejado) ([visão geral](https://technet.microsoft.com/library/dn249912.aspx)) é uma ferramenta do PowerShell que permite declarar a configuração que você deseja usar em um computador.</span><span class="sxs-lookup"><span data-stu-id="a3900-120">Desired State Configuration (DSC) ([overview](https://technet.microsoft.com/library/dn249912.aspx)) is a PowerShell tool that allows you to declare the configuration that you want for a machine.</span></span>  <span data-ttu-id="a3900-121">Por exemplo, você pode dizer: "Quero o Chocolatey instalado, quero o IIS instalado, quero a porta 80 aberta, quero a versão 1.0.0 de meu site instalada".</span><span class="sxs-lookup"><span data-stu-id="a3900-121">For example, you can say, “I want Chocolatey installed, I want IIS installed, I want port 80 opened, I want version 1.0.0 of my website installed.”</span></span>  <span data-ttu-id="a3900-122">O LCM (Gerenciador de configuração Local) da DSC implementa essa configuração.</span><span class="sxs-lookup"><span data-stu-id="a3900-122">The DSC Local Configuration Manager (LCM) implements that configuration.</span></span> <span data-ttu-id="a3900-123">Um Servidor de recepção da DSC mantém um repositório de configurações para seus computadores.</span><span class="sxs-lookup"><span data-stu-id="a3900-123">A DSC Pull Server holds a repository of configurations for your machines.</span></span> <span data-ttu-id="a3900-124">O LCM em cada computador verifica periodicamente se sua configuração corresponde à configuração armazenada.</span><span class="sxs-lookup"><span data-stu-id="a3900-124">The LCM on each machine checks in periodically to see if its configuration matches the stored configuration.</span></span> <span data-ttu-id="a3900-125">Ele pode relatar o status ou tentar realinhar o computador com a configuração armazenada.</span><span class="sxs-lookup"><span data-stu-id="a3900-125">It can either report status or attempt to bring the machine back into alignment with the stored configuration.</span></span> <span data-ttu-id="a3900-126">Você pode editar a configuração armazenada no servidor de recepção para alinhar um computador ou um conjunto de computadores com a configuração alterada.</span><span class="sxs-lookup"><span data-stu-id="a3900-126">You can edit the stored configuration on the pull server to cause a machine or set of machines to come into alignment with the changed configuration.</span></span>

<span data-ttu-id="a3900-127">A Automação do Azure é um serviço gerenciado no Microsoft Azure que permite automatizar várias tarefas usando runbooks, nós, credenciais, recursos e ativos, como agendamentos e variáveis globais.</span><span class="sxs-lookup"><span data-stu-id="a3900-127">Azure Automation is a managed service in Microsoft Azure that allows you to automate various tasks using runbooks, nodes, credentials, resources and assets such as schedules and global variables.</span></span> <span data-ttu-id="a3900-128">A DSC de Automação do Azure amplia esse recurso de automação para incluir ferramentas da DSC do PowerShell.</span><span class="sxs-lookup"><span data-stu-id="a3900-128">Azure Automation DSC extends this automation capability to include PowerShell DSC tools.</span></span>  <span data-ttu-id="a3900-129">Confira uma excelente [visão geral](automation-dsc-overview.md).</span><span class="sxs-lookup"><span data-stu-id="a3900-129">Here’s a great [overview](automation-dsc-overview.md).</span></span>

<span data-ttu-id="a3900-130">Um Recurso DSC é um módulo de código que tem recursos específicos, como gerenciar redes, o Active Directory ou o SQL Server.</span><span class="sxs-lookup"><span data-stu-id="a3900-130">A DSC Resource is a module of code that has specific capabilities, such as managing networking, Active Directory, or SQL Server.</span></span>  <span data-ttu-id="a3900-131">O Recurso DSC do Chocolatey sabe como acessar um Servidor do NuGet (entre outros), baixar e instalar pacotes e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="a3900-131">The Chocolatey DSC Resource knows how to access a NuGet Server (among others), download packages, install packages, and so on.</span></span>  <span data-ttu-id="a3900-132">Há muitos outros Recursos de DSC na [Galeria do PowerShell](http://www.powershellgallery.com/packages?q=dsc+resources&prerelease=&sortOrder=package-title).</span><span class="sxs-lookup"><span data-stu-id="a3900-132">There are many other DSC Resources in the [PowerShell Gallery](http://www.powershellgallery.com/packages?q=dsc+resources&prerelease=&sortOrder=package-title).</span></span>  <span data-ttu-id="a3900-133">Esses módulos são instalados no Servidor de Recepção da DSC de Automação do Azure (por você) para que possam ser usados por suas configurações.</span><span class="sxs-lookup"><span data-stu-id="a3900-133">These modules are installed into your Azure Automation DSC Pull Server (by you) so they can be used by your configurations.</span></span>

<span data-ttu-id="a3900-134">Os modelos do Resource Manager fornecem uma maneira declarativa de gerar sua infraestrutura (itens como redes, sub-redes, roteamento e segurança de rede, balanceadores de carga, NICs, VMs e assim por diante).</span><span class="sxs-lookup"><span data-stu-id="a3900-134">Resource Manager templates provide a declarative way of generating your infrastructure - things like networks, subnets, network security and routing, load balancers, NICs, VMs, and so on.</span></span>  <span data-ttu-id="a3900-135">Aqui está um [artigo](../azure-resource-manager/resource-manager-deployment-model.md) que compara o modelo de implantação de Resource Manager (declarativo) com o modelo de implantação do Azure Service Management (ASM ou clássico) (imperativo) e discute os principais provedores de recursos, computação, armazenamento e rede.</span><span class="sxs-lookup"><span data-stu-id="a3900-135">Here’s an [article](../azure-resource-manager/resource-manager-deployment-model.md) that compares the Resource Manager deployment model (declarative) with the Azure Service Management (ASM, or classic) deployment model (imperative), and discusses the core resource providers, compute, storage and network.</span></span>

<span data-ttu-id="a3900-136">Um recurso principal de um modelo do Resource Manager é sua capacidade de instalar uma extensão de VM na VM quando ela é provisionada.</span><span class="sxs-lookup"><span data-stu-id="a3900-136">One key feature of an Resource Manager template is its ability to install a VM extension into the VM as it’s provisioned.</span></span>  <span data-ttu-id="a3900-137">Uma extensão de VM tem recursos específicos, como executar um script personalizado, instalar software antivírus ou executar um script de configuração de DSC.</span><span class="sxs-lookup"><span data-stu-id="a3900-137">A VM extension has specific capabilities such as running a custom script, installing anti-virus software, or running a DSC configuration script.</span></span>  <span data-ttu-id="a3900-138">Há muitos outros tipos de extensões de VM.</span><span class="sxs-lookup"><span data-stu-id="a3900-138">There are many other types of VM extensions.</span></span>

## <a name="quick-trip-around-the-diagram"></a><span data-ttu-id="a3900-139">Explicação rápida do diagrama</span><span class="sxs-lookup"><span data-stu-id="a3900-139">Quick trip around the diagram</span></span>
<span data-ttu-id="a3900-140">Começando pela parte superior, você escreve o código, compila e testa e, depois, cria um pacote de instalação.</span><span class="sxs-lookup"><span data-stu-id="a3900-140">Starting at the top, you write your code, build and test, then create an installation package.</span></span>  <span data-ttu-id="a3900-141">O Chocolatey pode manipular vários tipos de pacotes de instalação, como MSI, MSU e ZIP.</span><span class="sxs-lookup"><span data-stu-id="a3900-141">Chocolatey can handle various types of installation packages, such as MSI, MSU, ZIP.</span></span>  <span data-ttu-id="a3900-142">Você conta com toda a capacidade do PowerShell para realizar a instalação real, caso os recursos nativos do Chocolatey não sejam suficientes.</span><span class="sxs-lookup"><span data-stu-id="a3900-142">And you have the full power of PowerShell to do the actual installation if Chocolatey’s native capabilities aren’t quite up to it.</span></span>  <span data-ttu-id="a3900-143">Coloque o pacote em algum lugar acessível – um repositório de pacotes.</span><span class="sxs-lookup"><span data-stu-id="a3900-143">Put the package into someplace reachable – a package repository.</span></span>  <span data-ttu-id="a3900-144">Este exemplo de uso usa uma pasta pública em uma conta de armazenamento de blob do Azure, mas pode estar em qualquer outro lugar.</span><span class="sxs-lookup"><span data-stu-id="a3900-144">This usage example uses a public folder in an Azure blob storage account, but it can be anywhere.</span></span>  <span data-ttu-id="a3900-145">O Chocolatey funciona nativamente com servidores do NuGet e alguns outras para o gerenciamento de metadados de pacote.</span><span class="sxs-lookup"><span data-stu-id="a3900-145">Chocolatey works natively with NuGet servers and a few others for management of package metadata.</span></span>  <span data-ttu-id="a3900-146">[Este artigo](https://github.com/chocolatey/choco/wiki/How-To-Host-Feed) descreve as opções.</span><span class="sxs-lookup"><span data-stu-id="a3900-146">[This article](https://github.com/chocolatey/choco/wiki/How-To-Host-Feed) describes the options.</span></span>  <span data-ttu-id="a3900-147">Este exemplo de uso usa o NuGet.</span><span class="sxs-lookup"><span data-stu-id="a3900-147">This usage example uses NuGet.</span></span>  <span data-ttu-id="a3900-148">Um Nuspec consiste em metadados sobre seus pacotes.</span><span class="sxs-lookup"><span data-stu-id="a3900-148">A Nuspec is metadata about your packages.</span></span>  <span data-ttu-id="a3900-149">O Nuspec é "compilado" no NuPkg e armazenado em um servidor do NuGet.</span><span class="sxs-lookup"><span data-stu-id="a3900-149">The Nuspec’s are “compiled” into NuPkg’s and stored in a NuGet server.</span></span>  <span data-ttu-id="a3900-150">Quando a configuração solicita um pacote por nome e faz referência a um servidor do NuGet, o Recurso DSC do Chocolatey (agora na VM) obtém o pacote e o instala para você.</span><span class="sxs-lookup"><span data-stu-id="a3900-150">When your configuration requests a package by name, and references a NuGet server, the Chocolatey DSC Resource (now on the VM) grabs the package and installs it for you.</span></span>  <span data-ttu-id="a3900-151">Você também pode solicitar uma versão específica de um pacote.</span><span class="sxs-lookup"><span data-stu-id="a3900-151">You can also request a specific version of a package.</span></span>

<span data-ttu-id="a3900-152">Na parte inferior esquerda da imagem, há um modelo do ARM (Gerenciador de Recursos do Azure).</span><span class="sxs-lookup"><span data-stu-id="a3900-152">In the bottom left portion of the picture, there is an Azure Resource Manager (ARM) template.</span></span>  <span data-ttu-id="a3900-153">Neste exemplo de uso, a extensão de VM registra a VM no Servidor de Recepção da DSC de Automação do Azure (ou seja, um servidor de recepção) como um Nó.</span><span class="sxs-lookup"><span data-stu-id="a3900-153">In this usage example, the VM extension registers the VM with the Azure Automation DSC Pull Server (that is, a pull server) as a Node.</span></span>  <span data-ttu-id="a3900-154">A configuração é armazenada no servidor de recepção.</span><span class="sxs-lookup"><span data-stu-id="a3900-154">The configuration is stored in the pull server.</span></span>  <span data-ttu-id="a3900-155">Na verdade, ela é armazenada duas vezes: uma vez como texto sem formatação e uma vez compilada como um arquivo MOF (para aqueles que os conhecem.)  No portal, o MOF é uma "configuração de nó" (em vez de simplesmente uma "configuração").</span><span class="sxs-lookup"><span data-stu-id="a3900-155">Actually, it’s stored twice: once as plain text and once compiled as an MOF file (for those that know about such things.)  In the portal, the MOF is a “node configuration” (as opposed to simply “configuration”).</span></span>  <span data-ttu-id="a3900-156">É o artefato associado a um nó para que o nó saiba sua configuração.</span><span class="sxs-lookup"><span data-stu-id="a3900-156">It’s the artifact that’s associated with a Node so the node will know its configuration.</span></span>  <span data-ttu-id="a3900-157">Os detalhes a seguir mostram como atribuir a configuração de nó ao nó.</span><span class="sxs-lookup"><span data-stu-id="a3900-157">Details below show how to assign the node configuration to the node.</span></span>

<span data-ttu-id="a3900-158">Provavelmente, você já está realizando a ação na parte superior, ou a maior parte dela.</span><span class="sxs-lookup"><span data-stu-id="a3900-158">Presumably you’re already doing the bit at the top, or most of it.</span></span>  <span data-ttu-id="a3900-159">Criar o nuspec, compilá-lo e armazená-lo em um servidor do NuGet é uma tarefa pequena.</span><span class="sxs-lookup"><span data-stu-id="a3900-159">Creating the nuspec, compiling and storing it in a NuGet server is a small thing.</span></span>  <span data-ttu-id="a3900-160">E você já está gerenciando VMs.</span><span class="sxs-lookup"><span data-stu-id="a3900-160">And you’re already managing VMs.</span></span>  <span data-ttu-id="a3900-161">O próximo passo para a implantação contínua requer a configuração do servidor de recepção (uma vez), o registro dos nós (uma vez) e a criação e o armazenamento da configuração neles (inicialmente).</span><span class="sxs-lookup"><span data-stu-id="a3900-161">Taking the next step to continuous deployment requires setting up the pull server (once), registering your nodes with it (once), and creating and storing the configuration there (initially).</span></span>  <span data-ttu-id="a3900-162">Em seguida, à medida que os pacotes forem atualizados e implantados no repositório, atualize a Configuração e a Configuração de Nó no servidor de recepção (repita conforme necessário).</span><span class="sxs-lookup"><span data-stu-id="a3900-162">Then as packages are upgraded and deployed to the repository, refresh the Configuration and Node Configuration in the pull server (repeat as needed).</span></span>

<span data-ttu-id="a3900-163">Se você não estiver começando com um modelo do ARM, isso também está OK.</span><span class="sxs-lookup"><span data-stu-id="a3900-163">If you’re not starting with an ARM template, that’s also OK.</span></span>  <span data-ttu-id="a3900-164">Há cmdlets do PowerShell projetados para ajudá-lo a registrar suas VMs no servidor de recepção e todo o restante.</span><span class="sxs-lookup"><span data-stu-id="a3900-164">There are PowerShell cmdlets designed to help you register your VMs with the pull server and all of the rest.</span></span> <span data-ttu-id="a3900-165">Para obter mais detalhes, confira este artigo: [Integrando máquinas para o gerenciamento pelo DSC de Automação do Azure](automation-dsc-onboarding.md)</span><span class="sxs-lookup"><span data-stu-id="a3900-165">For more details, see this article: [Onboarding machines for management by Azure Automation DSC](automation-dsc-onboarding.md)</span></span>

## <a name="step-1-setting-up-the-pull-server-and-automation-account"></a><span data-ttu-id="a3900-166">Etapa 1: configurar o servidor de recepção e a conta de automação</span><span class="sxs-lookup"><span data-stu-id="a3900-166">Step 1: Setting up the pull server and automation account</span></span>
<span data-ttu-id="a3900-167">Em uma linha de comando do PowerShell (Add-AzureRmAccount) autenticada: (pode demorar alguns minutos enquanto o servidor pull é configurado)</span><span class="sxs-lookup"><span data-stu-id="a3900-167">At an authenticated (Add-AzureRmAccount) PowerShell command line:  (can take a few minutes while the pull server is set up)</span></span>

    New-AzureRmResourceGroup –Name MY-AUTOMATION-RG –Location MY-RG-LOCATION-IN-QUOTES
    New-AzureRmAutomationAccount –ResourceGroupName MY-AUTOMATION-RG –Location MY-RG-LOCATION-IN-QUOTES –Name MY-AUTOMATION-ACCOUNT 

<span data-ttu-id="a3900-168">Você pode colocar sua conta de automação em qualquer uma das seguintes regiões (também conhecido como local): Leste dos EUA 2, Centro-Sul dos EUA, Gov. EUA - Virgínia, Europa Ocidental, Sudeste Asiático, Leste do Japão, Índia Central e Sudeste da Austrália, Canadá Central e Europa Setentrional.</span><span class="sxs-lookup"><span data-stu-id="a3900-168">You can put your automation account into any of the following regions (aka location):  East US 2, South Central US, US Gov Virginia, West Europe, Southeast Asia, Japan East, Central India and Australia Southeast, Canada Central, North Europe.</span></span>

## <a name="step-2-vm-extension-tweaks-to-the-arm-template"></a><span data-ttu-id="a3900-169">Etapa 2: ajustes da extensão de VM para o modelo ARM</span><span class="sxs-lookup"><span data-stu-id="a3900-169">Step 2: VM extension tweaks to the ARM template</span></span>
<span data-ttu-id="a3900-170">Detalhes do registro de VM (usando a extensão de VM de DSC do PowerShell) são fornecidos neste [Modelo de Início Rápido do Azure](https://github.com/Azure/azure-quickstart-templates/tree/master/dsc-extension-azure-automation-pullserver).</span><span class="sxs-lookup"><span data-stu-id="a3900-170">Details for VM registration (using the PowerShell DSC VM extension) provided in this [Azure Quickstart Template](https://github.com/Azure/azure-quickstart-templates/tree/master/dsc-extension-azure-automation-pullserver).</span></span>  <span data-ttu-id="a3900-171">Esta etapa registra sua nova VM no servidor de recepção na lista de Nós DSC.</span><span class="sxs-lookup"><span data-stu-id="a3900-171">This step registers your new VM with the pull server in the list of DSC Nodes.</span></span>  <span data-ttu-id="a3900-172">Parte do registro especifica a configuração de nó a ser aplicada ao nó.</span><span class="sxs-lookup"><span data-stu-id="a3900-172">Part of this registration is specifying the node configuration to be applied to the node.</span></span>  <span data-ttu-id="a3900-173">Essa configuração de nó não precisa existir ainda no servidor pull, portanto, não há problemas se isso for feito pela primeira vez apenas na Etapa 4.</span><span class="sxs-lookup"><span data-stu-id="a3900-173">This node configuration doesn't have to exist yet in the pull server, so it's OK that Step 4 is where this is done for the first time.</span></span>  <span data-ttu-id="a3900-174">Mas aqui na Etapa 2, é necessário decidir o nome do nó e o nome da configuração.</span><span class="sxs-lookup"><span data-stu-id="a3900-174">But here in Step 2 you do need to have decided the name of the node and the name of the configuration.</span></span>  <span data-ttu-id="a3900-175">Neste exemplo de uso, o nó é “isvbox” e a configuração é “ISVBoxConfig”.</span><span class="sxs-lookup"><span data-stu-id="a3900-175">In this usage example, the node is 'isvbox' and the configuration is 'ISVBoxConfig'.</span></span>  <span data-ttu-id="a3900-176">Portanto, o nome da configuração de nó (a ser especificado em DeploymentTemplate.json) é “ISVBoxConfig.isvbox”.</span><span class="sxs-lookup"><span data-stu-id="a3900-176">So the node configuration name (to be specified in DeploymentTemplate.json) is 'ISVBoxConfig.isvbox'.</span></span>  

## <a name="step-3-adding-required-dsc-resources-to-the-pull-server"></a><span data-ttu-id="a3900-177">Etapa 3: adicionar recursos de DSC necessários para o servidor de recepção</span><span class="sxs-lookup"><span data-stu-id="a3900-177">Step 3: Adding required DSC resources to the pull server</span></span>
<span data-ttu-id="a3900-178">A Galeria do PowerShell é instrumentada para instalar recursos de DSC em sua conta da Automação do Azure.</span><span class="sxs-lookup"><span data-stu-id="a3900-178">The PowerShell Gallery is instrumented to install DSC resources into your Azure Automation account.</span></span>  <span data-ttu-id="a3900-179">Navegue até o recurso desejado e clique no botão "Implantar na Automação do Azure".</span><span class="sxs-lookup"><span data-stu-id="a3900-179">Navigate to the resource you want and click the “Deploy to Azure Automation” button.</span></span>

![Exemplo da Galeria do PowerShell](./media/automation-dsc-cd-chocolatey/xNetworking.PNG)

<span data-ttu-id="a3900-181">Outra técnica recentemente adicionada ao Portal do Azure permite criar novos módulos ou atualizar módulos existentes.</span><span class="sxs-lookup"><span data-stu-id="a3900-181">Another technique recently added to the Azure Portal allows you to pull in new modules or update existing modules.</span></span> <span data-ttu-id="a3900-182">Clique no recurso Conta de Automação, no bloco Ativos e, por fim, no bloco Módulos.</span><span class="sxs-lookup"><span data-stu-id="a3900-182">Click through the Automation Account resource, the Assets tile, and finally the Modules tile.</span></span>  <span data-ttu-id="a3900-183">O ícone Procurar na Galeria permite ver a lista de módulos na galeria, filtrar para ver detalhes e, por fim, importar para sua Conta de Automação.</span><span class="sxs-lookup"><span data-stu-id="a3900-183">The Browse Gallery icon allows you to see the list of modules in the gallery, drill down into details and ultimately import into your Automation Account.</span></span> <span data-ttu-id="a3900-184">Isso é uma ótima maneira de manter atualizados os módulos periodicamente.</span><span class="sxs-lookup"><span data-stu-id="a3900-184">This is a great way to keep your modules up to date from time to time.</span></span> <span data-ttu-id="a3900-185">Além disso, o recurso de importação verifica dependências com outros módulos para garantir que nada esteja fora de sincronização.</span><span class="sxs-lookup"><span data-stu-id="a3900-185">And, the import feature checks dependencies with other modules to ensure nothing gets out of sync.</span></span>

<span data-ttu-id="a3900-186">Ou então, há a abordagem manual.</span><span class="sxs-lookup"><span data-stu-id="a3900-186">Or, there’s the manual approach.</span></span>  <span data-ttu-id="a3900-187">A estrutura de pastas de um Módulo de Integração do PowerShell para um computador com Windows é um pouco diferente da estrutura de pastas esperada pela Automação do Azure.</span><span class="sxs-lookup"><span data-stu-id="a3900-187">The folder structure of a PowerShell Integration Module for a Windows computer is a little different from the folder structure expected by the Azure Automation.</span></span>  <span data-ttu-id="a3900-188">Isso exige que você faça alguns ajustes.</span><span class="sxs-lookup"><span data-stu-id="a3900-188">This requires a little tweaking on your part.</span></span>  <span data-ttu-id="a3900-189">Porém, não é difícil, e isso só precisa ser feito uma vez por recurso (a menos que você deseje atualizá-lo no futuro).  Para saber mais sobre como criar Módulos de Integração do PowerShell, confira este artigo: [Criando Módulos de Integração para a Automação do Azure](https://azure.microsoft.com/blog/authoring-integration-modules-for-azure-automation/)</span><span class="sxs-lookup"><span data-stu-id="a3900-189">But it’s not hard, and it’s done only once per resource (unless you want to upgrade it in future.)  For more information on authoring PowerShell Integration Modules, see this article: [Authoring Integration Modules for Azure Automation](https://azure.microsoft.com/blog/authoring-integration-modules-for-azure-automation/)</span></span>

* <span data-ttu-id="a3900-190">Instale o módulo necessário na estação de trabalho, da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="a3900-190">Install the module that you need on your workstation, as follows:</span></span>
  * <span data-ttu-id="a3900-191">Instale o [Windows Management Framework, v5](http://aka.ms/wmf5latest) (não é necessário para o Windows 10)</span><span class="sxs-lookup"><span data-stu-id="a3900-191">Install [Windows Management Framework, v5](http://aka.ms/wmf5latest) (not needed for Windows 10)</span></span>
  * <span data-ttu-id="a3900-192">`Install-Module –Name MODULE-NAME`    <—captura o módulo da Galeria do PowerShell</span><span class="sxs-lookup"><span data-stu-id="a3900-192">`Install-Module –Name MODULE-NAME`    <—grabs the module from the PowerShell Gallery</span></span> 
* <span data-ttu-id="a3900-193">Copie a pasta de módulo de `c:\Program Files\WindowsPowerShell\Modules\MODULE-NAME` em uma pasta temporária</span><span class="sxs-lookup"><span data-stu-id="a3900-193">Copy the module folder from `c:\Program Files\WindowsPowerShell\Modules\MODULE-NAME` to a temp folder</span></span> 
* <span data-ttu-id="a3900-194">Exclua os exemplos e a documentação da pasta principal</span><span class="sxs-lookup"><span data-stu-id="a3900-194">Delete samples and documentation from the main folder</span></span> 
* <span data-ttu-id="a3900-195">Compacte a pasta principal, nomeando o arquivo ZIP exatamente como a pasta</span><span class="sxs-lookup"><span data-stu-id="a3900-195">Zip the main folder, naming the ZIP file exactly the same as the folder</span></span> 
* <span data-ttu-id="a3900-196">Coloque o arquivo ZIP em um local http acessível, como o armazenamento de blobs em uma Conta do Armazenamento do Azure.</span><span class="sxs-lookup"><span data-stu-id="a3900-196">Put the ZIP file into a reachable HTTP location, such as blob storage in an Azure Storage Account.</span></span>
* <span data-ttu-id="a3900-197">Execute este PowerShell:</span><span class="sxs-lookup"><span data-stu-id="a3900-197">Run this PowerShell:</span></span>
  
      New-AzureRmAutomationModule `
          -ResourceGroupName MY-AUTOMATION-RG -AutomationAccountName MY-AUTOMATION-ACCOUNT `
          -Name MODULE-NAME –ContentLink "https://STORAGE-URI/CONTAINERNAME/MODULE-NAME.zip"

<span data-ttu-id="a3900-198">O exemplo incluído executa estas etapas para cChoco e xNetworking.</span><span class="sxs-lookup"><span data-stu-id="a3900-198">The included example performs these steps for cChoco and xNetworking.</span></span> <span data-ttu-id="a3900-199">Veja as [Observações](#notes) para obter o tratamento especial para o cChoco.</span><span class="sxs-lookup"><span data-stu-id="a3900-199">See the [Notes](#notes) for special handling for cChoco.</span></span>

## <a name="step-4-adding-the-node-configuration-to-the-pull-server"></a><span data-ttu-id="a3900-200">Etapa 4: adicionar a configuração de nó ao servidor de recepção</span><span class="sxs-lookup"><span data-stu-id="a3900-200">Step 4: Adding the node configuration to the pull server</span></span>
<span data-ttu-id="a3900-201">Não há nada de especial na primeira vez que você importa a configuração para o servidor de recepção e realiza a compilação.</span><span class="sxs-lookup"><span data-stu-id="a3900-201">There’s nothing special about the first time you import your configuration into the pull server and compile.</span></span>  <span data-ttu-id="a3900-202">Todas as importações/compilações subsequentes da mesma configuração têm exatamente a mesma aparência.</span><span class="sxs-lookup"><span data-stu-id="a3900-202">All subsequent import/compiles of the same configuration look exactly the same.</span></span>  <span data-ttu-id="a3900-203">Sempre que atualiza o pacote e precisa enviá-lo para produção, você realiza esta etapa após garantir que o arquivo de configuração está correto, incluindo a nova versão do pacote.</span><span class="sxs-lookup"><span data-stu-id="a3900-203">Each time you update your package and need to push it out to production you do this step after ensuring the configuration file is correct – including the new version of your package.</span></span>  <span data-ttu-id="a3900-204">Aqui estão o arquivo de configuração e o PowerShell:</span><span class="sxs-lookup"><span data-stu-id="a3900-204">Here’s the configuration file and PowerShell:</span></span>

<span data-ttu-id="a3900-205">ISVBoxConfig.ps1:</span><span class="sxs-lookup"><span data-stu-id="a3900-205">ISVBoxConfig.ps1:</span></span>

    Configuration ISVBoxConfig 
    { 
        Import-DscResource -ModuleName cChoco 
        Import-DscResource -ModuleName xNetworking

        Node "isvbox" {   

            cChocoInstaller installChoco 
            { 
                InstallDir = "C:\choco" 
            }

            WindowsFeature installIIS 
            { 
                Ensure="Present" 
                Name="Web-Server" 
            }

            xFirewall WebFirewallRule 
            { 
                Direction = "Inbound" 
                Name = "Web-Server-TCP-In" 
                DisplayName = "Web Server (TCP-In)" 
                Description = "IIS allow incoming web site traffic." 
                DisplayGroup = "IIS Incoming Traffic" 
                State = "Enabled" 
                Access = "Allow" 
                Protocol = "TCP" 
                LocalPort = "80" 
                Ensure = "Present" 
            }

            cChocoPackageInstaller trivialWeb 
            {            
                Name = "trivialweb" 
                Version = "1.0.0" 
                Source = “MY-NUGET-V2-SERVER-ADDRESS” 
                DependsOn = "[cChocoInstaller]installChoco", 
                "[WindowsFeature]installIIS" 
            } 
        }    
    }

<span data-ttu-id="a3900-206">New-ConfigurationScript.ps1:</span><span class="sxs-lookup"><span data-stu-id="a3900-206">New-ConfigurationScript.ps1:</span></span>

    Import-AzureRmAutomationDscConfiguration ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -SourcePath C:\temp\AzureAutomationDsc\ISVBoxConfig.ps1 ` 
        -Published –Force

    $jobData = Start-AzureRmAutomationDscCompilationJob ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -ConfigurationName ISVBoxConfig 

    $compilationJobId = $jobData.Id

    Get-AzureRmAutomationDscCompilationJob ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -Id $compilationJobId

<span data-ttu-id="a3900-207">Essas etapas resultam em uma nova configuração de nó chamada “ISVBoxConfig.isvbox” colocada no servidor de recepção.</span><span class="sxs-lookup"><span data-stu-id="a3900-207">These steps result in a new node configuration named “ISVBoxConfig.isvbox” being placed on the pull server.</span></span>  <span data-ttu-id="a3900-208">O nome da configuração de nó é compilado como “configurationName.nodeName”.</span><span class="sxs-lookup"><span data-stu-id="a3900-208">The node configuration name is built as “configurationName.nodeName”.</span></span>

## <a name="step-5-creating-and-maintaining-package-metadata"></a><span data-ttu-id="a3900-209">Etapa 5: criar e manter metadados de pacote</span><span class="sxs-lookup"><span data-stu-id="a3900-209">Step 5: Creating and maintaining package metadata</span></span>
<span data-ttu-id="a3900-210">Para cada pacote que você coloca no repositório de pacotes, é necessário um nuspec que o descreve.</span><span class="sxs-lookup"><span data-stu-id="a3900-210">For each package that you put into the package repository, you need a nuspec that describes it.</span></span>  <span data-ttu-id="a3900-211">Esse nuspec deve ser compilado e armazenado em seu servidor do NuGet.</span><span class="sxs-lookup"><span data-stu-id="a3900-211">That nuspec must be compiled and stored in your NuGet server.</span></span> <span data-ttu-id="a3900-212">Este processo é descrito [aqui](http://docs.nuget.org/create/creating-and-publishing-a-package).</span><span class="sxs-lookup"><span data-stu-id="a3900-212">This process is described [here](http://docs.nuget.org/create/creating-and-publishing-a-package).</span></span>  <span data-ttu-id="a3900-213">Você pode usar MyGet.org como um servidor do NuGet.</span><span class="sxs-lookup"><span data-stu-id="a3900-213">You can use MyGet.org as a NuGet server.</span></span>  <span data-ttu-id="a3900-214">Eles vendem este serviço, mas há uma SKU inicial que é gratuita.</span><span class="sxs-lookup"><span data-stu-id="a3900-214">They sell this service, but have a starter SKU that’s free.</span></span>  <span data-ttu-id="a3900-215">Em NuGet.org, você encontrará instruções sobre como instalar seu próprio servidor do NuGet para seus pacotes privados.</span><span class="sxs-lookup"><span data-stu-id="a3900-215">At NuGet.org you’ll find instructions on installing your own NuGet server for your private packages.</span></span>

## <a name="step-6-tying-it-all-together"></a><span data-ttu-id="a3900-216">Etapa 6: reunir tudo isso</span><span class="sxs-lookup"><span data-stu-id="a3900-216">Step 6: Tying it all together</span></span>
<span data-ttu-id="a3900-217">Sempre que uma versão passar na garantia de qualidade e for aprovada para implantação, o pacote será criado e o nuspec e o nupkg serão atualizados e implantados no servidor do NuGet.</span><span class="sxs-lookup"><span data-stu-id="a3900-217">Each time a version passes QA and is approved for deployment, the package is created, nuspec and nupkg updated and deployed to the NuGet server.</span></span>  <span data-ttu-id="a3900-218">Além disso, a configuração (Etapa 4 acima) deve ser atualizada de acordo com o novo número de versão.</span><span class="sxs-lookup"><span data-stu-id="a3900-218">In addition, the configuration (Step 4 above) must be updated to agree with the new version number.</span></span>  <span data-ttu-id="a3900-219">Ela deve ser enviada para o servidor de recepção e compilada.</span><span class="sxs-lookup"><span data-stu-id="a3900-219">It must be sent to the pull server and compiled.</span></span>  <span data-ttu-id="a3900-220">Daí em diante, as VMs que dependem dessa configuração serão responsáveis por receber a atualização e instalá-la.</span><span class="sxs-lookup"><span data-stu-id="a3900-220">From that point on, it's up to the VMs that depend on that configuration to pull the update and install it.</span></span>  <span data-ttu-id="a3900-221">Cada uma dessas atualizações é simples - apenas uma ou duas linhas do PowerShell.</span><span class="sxs-lookup"><span data-stu-id="a3900-221">Each of these updates are simple - just a line or two of PowerShell.</span></span>  <span data-ttu-id="a3900-222">No caso do Visual Studio Team Services, algumas delas são encapsuladas em tarefas de compilação que podem ser encadeadas juntas em uma compilação.</span><span class="sxs-lookup"><span data-stu-id="a3900-222">In the case of Visual Studio Team Services, some of them are encapsulated in build tasks that can be chained together in a build.</span></span>  <span data-ttu-id="a3900-223">Este [artigo](https://www.visualstudio.com/en-us/docs/alm-devops-feature-index#continuous-delivery) fornece mais detalhes.</span><span class="sxs-lookup"><span data-stu-id="a3900-223">This [article](https://www.visualstudio.com/en-us/docs/alm-devops-feature-index#continuous-delivery) provides more details.</span></span>  <span data-ttu-id="a3900-224">Este [repositório GitHub](https://github.com/Microsoft/vso-agent-tasks) fornece detalhes das várias tarefas de compilação disponíveis.</span><span class="sxs-lookup"><span data-stu-id="a3900-224">This [GitHub repo](https://github.com/Microsoft/vso-agent-tasks) details the various available build tasks.</span></span>

## <a name="notes"></a><span data-ttu-id="a3900-225">Observações</span><span class="sxs-lookup"><span data-stu-id="a3900-225">Notes</span></span>
<span data-ttu-id="a3900-226">Este exemplo de uso começa com uma VM de uma imagem genérica do Windows Server 2012 R2 da galeria do Azure.</span><span class="sxs-lookup"><span data-stu-id="a3900-226">This usage example starts with a VM from a generic Windows Server 2012 R2 image from the Azure gallery.</span></span>  <span data-ttu-id="a3900-227">Você poderá iniciar de qualquer imagem armazenada e ajustá-la com a configuração da DSC.</span><span class="sxs-lookup"><span data-stu-id="a3900-227">You can start from any stored image and then tweak from there with the DSC configuration.</span></span>  <span data-ttu-id="a3900-228">No entanto, é muito mais difícil alterar a configuração incorporada a uma imagem do que atualizar de forma dinâmica a configuração usando a DSC.</span><span class="sxs-lookup"><span data-stu-id="a3900-228">However, changing configuration that is baked into an image is much harder than dynamically updating the configuration using DSC.</span></span>

<span data-ttu-id="a3900-229">Você não precisa usar um modelo ARM e a extensão de VM para usar essa técnica com suas VMs.</span><span class="sxs-lookup"><span data-stu-id="a3900-229">You don’t have to use an ARM template and the VM extension to use this technique with your VMs.</span></span>  <span data-ttu-id="a3900-230">E suas VMs não precisam estar no Azure para estar no gerenciamento de CD.</span><span class="sxs-lookup"><span data-stu-id="a3900-230">And your VMs don’t have to be on Azure to be under CD management.</span></span>  <span data-ttu-id="a3900-231">Basta que o Chocolatey seja instalado e o LCM seja configurado na máquina virtual para que ele saiba onde está o servidor de recepção.</span><span class="sxs-lookup"><span data-stu-id="a3900-231">All that’s necessary is that Chocolatey be installed and the LCM configured on the VM so it knows where the pull server is.</span></span>  

<span data-ttu-id="a3900-232">É claro que, ao atualizar um pacote em uma VM que está em produção, você precisa colocar a VM fora de rotação enquanto a atualização é instalada.</span><span class="sxs-lookup"><span data-stu-id="a3900-232">Of course, when you update a package on a VM that’s in production, you need to take that VM out of rotation while the update is installed.</span></span>  <span data-ttu-id="a3900-233">A maneira de fazer isso varia muito.</span><span class="sxs-lookup"><span data-stu-id="a3900-233">How you do this varies widely.</span></span>  <span data-ttu-id="a3900-234">Por exemplo, com uma VM por trás de um Balanceador de Carga do Azure, você pode adicionar uma Sonda Personalizada.</span><span class="sxs-lookup"><span data-stu-id="a3900-234">For example, with a VM behind an Azure Load Balancer, you can add a Custom Probe.</span></span>  <span data-ttu-id="a3900-235">Ao atualizar a VM, faça com que o ponto de extremidade da sonda retorne um 400.</span><span class="sxs-lookup"><span data-stu-id="a3900-235">While updating the VM, have the probe endpoint return a 400.</span></span>  <span data-ttu-id="a3900-236">O ajuste necessário para fazer essa alteração pode ser dentro de sua configuração, da mesma forma como o ajuste para que 200 volte a ser retornado depois que a atualização for concluída.</span><span class="sxs-lookup"><span data-stu-id="a3900-236">The tweak necessary to cause this change can be inside your configuration, as can the tweak to switch it back to returning a 200 once the update is complete.</span></span>

<span data-ttu-id="a3900-237">O código-fonte completo deste exemplo de uso está [neste projeto do Visual Studio](https://github.com/sebastus/ARM/tree/master/CDIaaSVM) no GitHub.</span><span class="sxs-lookup"><span data-stu-id="a3900-237">Full source for this usage example is in [this Visual Studio project](https://github.com/sebastus/ARM/tree/master/CDIaaSVM) on GitHub.</span></span>

## <a name="related-articles"></a><span data-ttu-id="a3900-238">Artigos relacionados</span><span class="sxs-lookup"><span data-stu-id="a3900-238">Related Articles</span></span>
* [<span data-ttu-id="a3900-239">Visão geral da DSC da Automação do Azure</span><span class="sxs-lookup"><span data-stu-id="a3900-239">Azure Automation DSC Overview</span></span>](automation-dsc-overview.md)
* [<span data-ttu-id="a3900-240">cmdlets da DSC de Automação do Azure</span><span class="sxs-lookup"><span data-stu-id="a3900-240">Azure Automation DSC cmdlets</span></span>](https://msdn.microsoft.com/library/mt244122.aspx)
* [<span data-ttu-id="a3900-241">Máquinas de integração para o gerenciamento pelo DSC de Automação do Azure</span><span class="sxs-lookup"><span data-stu-id="a3900-241">Onboarding machines for management by Azure Automation DSC</span></span>](automation-dsc-onboarding.md)

