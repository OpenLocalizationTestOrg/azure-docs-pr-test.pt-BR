---
title: "Chamando um Runbook de Automação do Azure a partir de um Alerta do Log Analytics | Microsoft Docs"
description: "Este artigo fornece uma visão geral de como chamar um runbook de Automação a partir de um alerta do Log Analytics do OMS da Microsoft."
services: automation
documentationcenter: 
author: mgoedtel
manager: jwhit
editor: 
ms.assetid: 
ms.service: automation
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 01/31/2017
ms.author: magoedte
ms.openlocfilehash: 81cf490eae7f283c0180875cb3a2ed2ffe6333c8
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="calling-an-azure-automation-runbook-from-an-oms-log-analytics-alert"></a><span data-ttu-id="eedb2-103">Chamando um runbook de Automação do Azure a partir de um alerta do Log Analytics do OMS</span><span class="sxs-lookup"><span data-stu-id="eedb2-103">Calling an Azure Automation runbook from an OMS Log Analytics alert</span></span>

<span data-ttu-id="eedb2-104">Quando um alerta for configurado no Log Analytics para criar um registro de alerta, se os resultados corresponderem a um critério específico, como um aumento prolongado na utilização do processador, ou um determinado processo do aplicativo crítico para a funcionalidade de um aplicativo de negócios falhar e gravar um evento correspondente no log de eventos do Windows, esse alerta poderá executar automaticamente um runbook de Automação em uma tentativa de corrigir o problema.</span><span class="sxs-lookup"><span data-stu-id="eedb2-104">When an alert is configured in Log Analytics to create an alert record if results match a particular criteria, such as a prolonged spike in processor utilization or a particular application process critical to the functionality of a business application fails and writes a corresponding event in the Windows event log, that alert can automatically run an Automation runbook in an attempt to auto-remediate the issue.</span></span>  

<span data-ttu-id="eedb2-105">Há duas opções para chamar um runbook ao configurar o alerta.</span><span class="sxs-lookup"><span data-stu-id="eedb2-105">There are two options to call a runbook when configuring the alert.</span></span>  <span data-ttu-id="eedb2-106">Especificamente:</span><span class="sxs-lookup"><span data-stu-id="eedb2-106">Specifically,</span></span>

1. <span data-ttu-id="eedb2-107">Usando um Webhook.</span><span class="sxs-lookup"><span data-stu-id="eedb2-107">Using a Webhook.</span></span>
   * <span data-ttu-id="eedb2-108">Essa será a única opção disponível se seu espaço de trabalho do OMS não está vinculado a uma conta de Automação.</span><span class="sxs-lookup"><span data-stu-id="eedb2-108">This is the only option available if your OMS workspace is not linked to an Automation account.</span></span>
   * <span data-ttu-id="eedb2-109">Se você já tiver uma conta de Automação vinculada a um espaço de trabalho do OMS, essa opção ainda estará disponível.</span><span class="sxs-lookup"><span data-stu-id="eedb2-109">If you already have an Automation account linked to an OMS workspace, this option is still available.</span></span>  

2. <span data-ttu-id="eedb2-110">Selecione um runbook diretamente.</span><span class="sxs-lookup"><span data-stu-id="eedb2-110">Select a runbook directly.</span></span>
   * <span data-ttu-id="eedb2-111">Esta opção está disponível somente quando o espaço de trabalho do OMS está vinculado a uma conta de Automação.</span><span class="sxs-lookup"><span data-stu-id="eedb2-111">This option is available only when the OMS workspace is linked to an Automation account.</span></span>  

## <a name="calling-a-runbook-using-a-webhook"></a><span data-ttu-id="eedb2-112">Chamando um runbook com um webhook</span><span class="sxs-lookup"><span data-stu-id="eedb2-112">Calling a runbook using a webhook</span></span>

<span data-ttu-id="eedb2-113">Um webhook permite que você inicie um runbook específico na Automação do Azure por meio de uma única solicitação HTTP.</span><span class="sxs-lookup"><span data-stu-id="eedb2-113">A webhook allows you to start a particular runbook in Azure Automation through a single HTTP request.</span></span>  <span data-ttu-id="eedb2-114">Antes de configurar o [alerta do Log Analytics](../log-analytics/log-analytics-alerts.md#alert-rules) para chamar o runbook usando um webhook como uma ação de alerta, primeiro você precisará criar um webhook para o runbook que será chamado com esse método.</span><span class="sxs-lookup"><span data-stu-id="eedb2-114">Before configuring the [Log Analytics alert](../log-analytics/log-analytics-alerts.md#alert-rules) to call the runbook using a webhook as an alert action, you will need to first create a webhook for the runbook that will be called using this method.</span></span>  <span data-ttu-id="eedb2-115">Examine e siga as etapas no artigo [Criar um webhook](automation-webhooks.md#creating-a-webhook) e lembre de registrar a URL do webhook para que você possa referenciá-la ao configurar a regra de alerta.</span><span class="sxs-lookup"><span data-stu-id="eedb2-115">Review and follow the steps in the [create a webhook](automation-webhooks.md#creating-a-webhook) article and remember to record the webhook URL so that you can reference it while configuring the alert rule.</span></span>   

## <a name="calling-a-runbook-directly"></a><span data-ttu-id="eedb2-116">Chamando um runbook diretamente</span><span class="sxs-lookup"><span data-stu-id="eedb2-116">Calling a runbook directly</span></span>

<span data-ttu-id="eedb2-117">Se você tiver a oferta Automação e Controle instalada e configurada em seu espaço de trabalho do OMS, ao configurar a opção de ações do Runbook para o alerta, poderá exibir todos os runbooks na lista suspensa **Selecionar um runbook** e selecionar o runbook específico que deseja executar em resposta ao alerta.</span><span class="sxs-lookup"><span data-stu-id="eedb2-117">If you have the Automation & Control offering installed and configured in your OMS workspace, when configuring the Runbook actions option for the alert, you can view all runbooks from the **Select a runbook** dropdown list and select the specific runbook you want to run in response to the alert.</span></span>  <span data-ttu-id="eedb2-118">O runbook selecionado pode ser executado em um espaço de trabalho na nuvem do Azure ou em um Hybrid Runbook Worker.</span><span class="sxs-lookup"><span data-stu-id="eedb2-118">The selected runbook can run in a workspace in the Azure cloud or on a hybrid runbook worker.</span></span>  <span data-ttu-id="eedb2-119">Quando o alerta for criado usando a opção do runbook, um webhook será criado para o runbook.</span><span class="sxs-lookup"><span data-stu-id="eedb2-119">When the alert is created using the runbook option, a webhook will be created for the runbook.</span></span>  <span data-ttu-id="eedb2-120">Você poderá ver o webhook se for para a conta de Automação e navegar até a folha do webhook do runbook selecionado.</span><span class="sxs-lookup"><span data-stu-id="eedb2-120">You can see the webhook if you go to the Automation account and navigate to the webhook blade of the selected runbook.</span></span>  <span data-ttu-id="eedb2-121">Se você excluir o alerta, o webhook não será excluído, mas o usuário poderá excluir o webhook manualmente.</span><span class="sxs-lookup"><span data-stu-id="eedb2-121">If you delete the alert, the webhook is not deleted, but the user can delete the webhook manually.</span></span>  <span data-ttu-id="eedb2-122">Não será um problema se o webhook não for excluído, ele é apenas um item órfão que precisará ser excluído para manter uma conta de Automação organizada.</span><span class="sxs-lookup"><span data-stu-id="eedb2-122">It is not a problem if the webhook is not deleted, it is just an orphaned item that will eventually need to be deleted in order to maintain an organized Automation account.</span></span>  

## <a name="characteristics-of-a-runbook-for-both-options"></a><span data-ttu-id="eedb2-123">Características de um runbook (para ambas as opções)</span><span class="sxs-lookup"><span data-stu-id="eedb2-123">Characteristics of a runbook (for both options)</span></span>

<span data-ttu-id="eedb2-124">Os dois métodos para chamar o runbook a partir do alerta do Log Analytics têm características de comportamento diferentes que precisam ser compreendidas antes de configurar suas regras de alerta.</span><span class="sxs-lookup"><span data-stu-id="eedb2-124">Both methods for calling the runbook from the Log Analytics alert have different behavior characteristics that need to be understood before you configure your alert rules.</span></span>  

* <span data-ttu-id="eedb2-125">Você deve ter um parâmetro de entrada do runbook denominado **WebhookData** que é do tipo **Objeto**.</span><span class="sxs-lookup"><span data-stu-id="eedb2-125">You must have a runbook input parameter called **WebhookData** that is **Object** type.</span></span>  <span data-ttu-id="eedb2-126">Pode ser obrigatório ou opcional.</span><span class="sxs-lookup"><span data-stu-id="eedb2-126">It can be mandatory or optional.</span></span>  <span data-ttu-id="eedb2-127">O alerta passa os resultados da pesquisa para o runbook usando o parâmetro de entrada.</span><span class="sxs-lookup"><span data-stu-id="eedb2-127">The alert passes the search results to the runbook using this input parameter.</span></span>

        param  
         (  
          [Parameter (Mandatory=$true)]  
          [object] $WebhookData  
         )

*  <span data-ttu-id="eedb2-128">Você deve ter o código para converter o WebhookData em um objeto do PowerShell.</span><span class="sxs-lookup"><span data-stu-id="eedb2-128">You must have code to convert the WebhookData to a PowerShell object.</span></span>

    `$SearchResults = (ConvertFrom-Json $WebhookData.RequestBody).SearchResults.value`

    <span data-ttu-id="eedb2-129">*$SearchResults* será uma matriz de objetos; cada objeto contém campos com os valores de um resultado da pesquisa</span><span class="sxs-lookup"><span data-stu-id="eedb2-129">*$SearchResults* will be an array of objects; each object contains the fields with values from one search result</span></span>

### <a name="webhookdata-inconsistencies-between-the-webhook-option-and-runbook-option"></a><span data-ttu-id="eedb2-130">Inconsistências do WebhookData entre a opção do webhook e a opção do runbook</span><span class="sxs-lookup"><span data-stu-id="eedb2-130">WebhookData inconsistencies between the webhook option and runbook option</span></span>

* <span data-ttu-id="eedb2-131">Ao configurar um alerta para chamar um Webhook, insira a URL do webhook criada para um runbook e clique no botão **Testar Webhook**.</span><span class="sxs-lookup"><span data-stu-id="eedb2-131">When configuring an alert to call a Webhook, enter a webhook URL you created for a runbook, and click the **Test Webhook** button.</span></span>  <span data-ttu-id="eedb2-132">O WebhookData resultante enviado para o runbook não contém *.SearchResult* nem *.SearchResults*.</span><span class="sxs-lookup"><span data-stu-id="eedb2-132">The resulting WebhookData sent to the runbook does not contain either *.SearchResult* or *.SearchResults*.</span></span>

*  <span data-ttu-id="eedb2-133">Se você salvar esse alerta, quando o alerta disparar e chamar o webhook, o WebhookData enviado para o runbook conterá *.SearchResult*.</span><span class="sxs-lookup"><span data-stu-id="eedb2-133">If you save that alert, when the alert triggers and calls the webhook, the WebhookData sent to the runbook contains *.SearchResult*.</span></span>
* <span data-ttu-id="eedb2-134">Se você criar um alerta e configurá-lo para chamar um runbook (que também cria um webhook), quando o alerta disparar, enviará o WebhookData para o runbook que contém *.SearchResults*.</span><span class="sxs-lookup"><span data-stu-id="eedb2-134">If you create an alert, and configure it to call a runbook (which also creates a webhook), when the alert triggers it sends WebhookData to the runbook that contains *.SearchResults*.</span></span>

<span data-ttu-id="eedb2-135">Portanto, no exemplo de código acima, você precisará obter *.SearchResult* se o alerta chamar um webhook e será necessário obter *.SearchResults* se o alerta chamar um runbook diretamente.</span><span class="sxs-lookup"><span data-stu-id="eedb2-135">Thus in the code example above, you will need to get *.SearchResult* if the alert calls a webhook, and will need to get *.SearchResults* if the alert calls a runbook directly.</span></span>

## <a name="example-walkthrough"></a><span data-ttu-id="eedb2-136">Exemplo de passo a passo</span><span class="sxs-lookup"><span data-stu-id="eedb2-136">Example walkthrough</span></span>

<span data-ttu-id="eedb2-137">Demonstraremos como isso funciona usando o seguinte runbook gráfico de exemplo, que inicia um serviço do Windows.</span><span class="sxs-lookup"><span data-stu-id="eedb2-137">We will demonstrate how this works by using the following example graphical runbook, which starts a Windows service.</span></span><br><br> ![Iniciar Runbook Gráfico do Serviço do Windows](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice.png)<br>

<span data-ttu-id="eedb2-139">O runbook tem um parâmetro de entrada do tipo **Objeto** que é denominado **WebhookData** e inclui os dados do webhook passados a partir do alerta que contém *.SearchResults*.</span><span class="sxs-lookup"><span data-stu-id="eedb2-139">The runbook has one input parameter of type **Object** that is called **WebhookData** and includes the webhook data passed from the alert containing *.SearchResults*.</span></span><br><br> <span data-ttu-id="eedb2-140">![Parâmetros de entrada do runbook](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice-inputparameter.png)</span><span class="sxs-lookup"><span data-stu-id="eedb2-140">![Runbook input parameters](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice-inputparameter.png)</span></span><br>

<span data-ttu-id="eedb2-141">Para este exemplo, no Log Analytics criamos dois campos personalizados, *SvcDisplayName_CF* e *SvcState_CF*, para extrair o nome de exibição do serviço e o estado do serviço (ou seja, em execução ou parado) do evento gravado no Log de eventos do sistema.</span><span class="sxs-lookup"><span data-stu-id="eedb2-141">For this example, in Log Analytics we created two custom fields, *SvcDisplayName_CF* and *SvcState_CF*, to extract the service display name and the state of the service (i.e. running or stopped) from the event written to the System event log.</span></span>  <span data-ttu-id="eedb2-142">Em seguida, criamos uma regra de alerta com a seguinte consulta de pesquisa: `Type=Event SvcDisplayName_CF="Print Spooler" SvcState_CF="stopped"` para podermos detectar quando o serviço do Spooler de Impressão é interrompido no sistema do Windows.</span><span class="sxs-lookup"><span data-stu-id="eedb2-142">We then create an alert rule with the following search query: `Type=Event SvcDisplayName_CF="Print Spooler" SvcState_CF="stopped"` so that we can detect when the Print Spooler service is stopped on the Windows system.</span></span>  <span data-ttu-id="eedb2-143">Pode ser qualquer serviço de interesse, mas para este exemplo, fazemos referência a um dos serviços preexistentes que são incluídos com o SO do Windows.</span><span class="sxs-lookup"><span data-stu-id="eedb2-143">It can be any service of interest, but for this example we are referencing one of the pre-existing services that are included with the Windows OS.</span></span>  <span data-ttu-id="eedb2-144">A ação de alerta está configurada para executar nosso runbook usado neste exemplo e ser executada no Hybrid Runbook Worker, que estão habilitados nos sistemas de destino.</span><span class="sxs-lookup"><span data-stu-id="eedb2-144">The alert action is configured to execute our runbook used in this example and run on the Hybrid Runbook Worker, which are enabled on the target systems.</span></span>   

<span data-ttu-id="eedb2-145">A atividade de código do runbook **Obter o Nome do Serviço de LA** converterá a cadeia de caracteres formatada do JSON em um tipo de objeto, filtrará o item *SvcDisplayName_CF* para extrair o nome de exibição do serviço do Windows e passará isso para a próxima atividade que verificará se o serviço está parado antes de tentar reiniciá-lo.</span><span class="sxs-lookup"><span data-stu-id="eedb2-145">The runbook code activity **Get Service Name from LA** will convert the JSON-formatted string into an object type and filter on the item *SvcDisplayName_CF* to extract the display name of the Windows service and pass this onto the next activity which will verify the service is stopped before attempting to restart it.</span></span>  <span data-ttu-id="eedb2-146">*SvcDisplayName_CF* é um [campo personalizado](../log-analytics/log-analytics-custom-fields.md) criado no Log Analytics para demonstrar este exemplo.</span><span class="sxs-lookup"><span data-stu-id="eedb2-146">*SvcDisplayName_CF* is a [custom field](../log-analytics/log-analytics-custom-fields.md) created in Log Analytics to demonstrate this example.</span></span>

    $SearchResults = (ConvertFrom-Json $WebhookData.RequestBody).SearchResults.value
    $SearchResults.SvcDisplayName_CF  

<span data-ttu-id="eedb2-147">Quando o serviço parar, a regra de alerta no Log Analytics irá detectar uma correspondência, disparar o runbook e enviar o contexto do alerta para o runbook.</span><span class="sxs-lookup"><span data-stu-id="eedb2-147">When the service stops, the alert rule in Log Analytics will detect a match and trigger the runbook and send the alert context to the runbook.</span></span> <span data-ttu-id="eedb2-148">O runbook tomará uma ação para verificar se o serviço está parado e se estiver, tentará reiniciar o serviço, irá verificar se ele iniciou corretamente e enviará os resultados.</span><span class="sxs-lookup"><span data-stu-id="eedb2-148">The runbook will take action to verify the service is stopped, and if so attempt to restart the service and verify it started correctly and output the results.</span></span>     

<span data-ttu-id="eedb2-149">Como alternativa, se você não tivesse sua conta de Automação vinculada ao espaço de trabalho do OMS, configuraria a regra de alerta com uma ação do webhook para disparar o runbook, configuraria o runbook para converter a cadeia de caracteres formatada do JSON e filtraria *.SearchResult* seguindo as orientações mencionadas anteriormente.</span><span class="sxs-lookup"><span data-stu-id="eedb2-149">Alternatively if you don't have your Automation account linked to your OMS workspace, you would configure the alert rule with a webhook action to trigger the runbook and configure the runbook to convert the JSON-formatted string and filter on *.SearchResult* following the guidance mentioned earlier.</span></span>    

## <a name="next-steps"></a><span data-ttu-id="eedb2-150">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="eedb2-150">Next steps</span></span>

* <span data-ttu-id="eedb2-151">Para saber mais sobre os alertas no Log Analytics e como criar um, consulte [Alertas no Log Analytics](../log-analytics/log-analytics-alerts.md).</span><span class="sxs-lookup"><span data-stu-id="eedb2-151">To learn more about alerts in Log Analytics and how to create one, see [Alerts in Log Analytics](../log-analytics/log-analytics-alerts.md).</span></span>

* <span data-ttu-id="eedb2-152">Para entender como disparar runbooks usando um webhook, consulte [Webhooks de Automação do Azure](automation-webhooks.md).</span><span class="sxs-lookup"><span data-stu-id="eedb2-152">To understand how to trigger runbooks using a webhook, see [Azure Automation webhooks](automation-webhooks.md).</span></span>
