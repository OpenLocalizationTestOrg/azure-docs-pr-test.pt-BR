---
title: "Persistir saída de tarefa e de trabalho no Armazenamento do Azure - com API do serviço de Lote do Azure | Microsoft Docs"
description: "Saiba como usar a API do serviço de lote para manter a saída de tarefa e o trabalho em lotes no Armazenamento do Azure."
services: batch
author: tamram
manager: timlt
editor: 
ms.service: batch
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: big-compute
ms.date: 06/16/2017
ms.author: tamram
ms.openlocfilehash: 2530b7c20347b9fb58aee4dfe693847cf3911741
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/29/2017
---
# <a name="persist-task-data-to-azure-storage-with-the-batch-service-api"></a><span data-ttu-id="c789f-103">Manter os dados de tarefa para o Armazenamento do Azure com a API de serviço de lote</span><span class="sxs-lookup"><span data-stu-id="c789f-103">Persist task data to Azure Storage with the Batch service API</span></span>

[!INCLUDE [batch-task-output-include](../../includes/batch-task-output-include.md)]

<span data-ttu-id="c789f-104">Começando com a versão de 01/05/2017, a API de serviço de Lote fornece suporte para manter dados de saída para o Armazenamento do Azure para tarefas e tarefas do gerenciador de trabalho, que são executadas em pools com a configuração de máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="c789f-104">Starting with version 2017-05-01, the Batch service API supports persisting output data to Azure Storage for tasks and job manager tasks that run on pools with the virtual machine configuration.</span></span> <span data-ttu-id="c789f-105">Quando você adiciona uma tarefa, pode especificar um contêiner no Armazenamento do Azure como o destino para a saída da tarefa.</span><span class="sxs-lookup"><span data-stu-id="c789f-105">When you add a task, you can specify a container in Azure Storage as the destination for the task's output.</span></span> <span data-ttu-id="c789f-106">O serviço de lote grava os dados de saída nesse contêiner quando a tarefa é concluída.</span><span class="sxs-lookup"><span data-stu-id="c789f-106">The Batch service then writes any output data to that container when the task is complete.</span></span>

<span data-ttu-id="c789f-107">Uma vantagem de usar a API do serviço de lote para manter a saída da tarefa é que você não precisa modificar o aplicativo que a tarefa está sendo executada.</span><span class="sxs-lookup"><span data-stu-id="c789f-107">An advantage to using the Batch service API to persist task output is that you do not need to modify the application that the task is running.</span></span> <span data-ttu-id="c789f-108">Em vez disso, com algumas modificações simples no seu aplicativo cliente, você pode manter a saída da tarefa de dentro do código que cria a tarefa.</span><span class="sxs-lookup"><span data-stu-id="c789f-108">Instead, with a few simple modifications to your client application, you can persist the task's output from within the code that creates the task.</span></span>   

## <a name="when-do-i-use-the-batch-service-api-to-persist-task-output"></a><span data-ttu-id="c789f-109">Quando uso a API do serviço de Lote para manter a saída da tarefa?</span><span class="sxs-lookup"><span data-stu-id="c789f-109">When do I use the Batch service API to persist task output?</span></span>

<span data-ttu-id="c789f-110">O Lote do Azure fornece mais de uma maneira de manter a saída da tarefa.</span><span class="sxs-lookup"><span data-stu-id="c789f-110">Azure Batch provides more than one way to persist task output.</span></span> <span data-ttu-id="c789f-111">Usar a API de serviço de lote é uma abordagem conveniente que é mais adequada para esses cenários:</span><span class="sxs-lookup"><span data-stu-id="c789f-111">Using the Batch service API is a convenient approach that's best suited to these scenarios:</span></span>

- <span data-ttu-id="c789f-112">Você deseja escrever o código para manter a saída da tarefa de dentro de seu aplicativo cliente, sem modificar o aplicativo que sua tarefa está executando.</span><span class="sxs-lookup"><span data-stu-id="c789f-112">You want to write code to persist task output from within your client application, without modifying the application that your task is running.</span></span>
- <span data-ttu-id="c789f-113">Você deseja manter a saída das tarefas em Lote e as tarefas do gerenciador de trabalho em pools criados com a configuração de máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="c789f-113">You want to persist output from Batch tasks and job manager tasks in pools created with the virtual machine configuration.</span></span>
- <span data-ttu-id="c789f-114">Você deseja manter a saída a um contêiner de Armazenamento do Azure com um nome arbitrário.</span><span class="sxs-lookup"><span data-stu-id="c789f-114">You want to persist output to an Azure Storage container with an arbitrary name.</span></span>
- <span data-ttu-id="c789f-115">Você deseja manter a saída a um contêiner de Armazenamento do Azure nomeado de acordo com o [padrão de Convenções de Arquivo em Lotes](https://github.com/Azure/azure-sdk-for-net/tree/vs17Dev/src/SDKs/Batch/Support/FileConventions#conventions).</span><span class="sxs-lookup"><span data-stu-id="c789f-115">You want to persist output to an Azure Storage container named according to the [Batch File Conventions standard](https://github.com/Azure/azure-sdk-for-net/tree/vs17Dev/src/SDKs/Batch/Support/FileConventions#conventions).</span></span> 

<span data-ttu-id="c789f-116">Se seu cenário for diferente daqueles listados acima, poderá ser necessário considerar uma abordagem diferente.</span><span class="sxs-lookup"><span data-stu-id="c789f-116">If your scenario differs from those listed above, you may need to consider a different approach.</span></span> <span data-ttu-id="c789f-117">Por exemplo, a API de serviço de lote atualmente não suporta saída de transmissão para o armazenamento do Azure durante a execução da tarefa.</span><span class="sxs-lookup"><span data-stu-id="c789f-117">For example, the Batch service API does not currently support streaming output to Azure Storage while the task is running.</span></span> <span data-ttu-id="c789f-118">Para a saída de fluxo, considere usar a biblioteca de Convenções de Arquivo em Lotes, disponível para .NET.</span><span class="sxs-lookup"><span data-stu-id="c789f-118">To stream output, consider using the Batch File Conventions library, available for .NET.</span></span> <span data-ttu-id="c789f-119">Para outros idiomas, você precisará implantar sua própria solução.</span><span class="sxs-lookup"><span data-stu-id="c789f-119">For other languages, you'll need to implement your own solution.</span></span> <span data-ttu-id="c789f-120">Para obter mais informações sobre outras opções para manter a saída da tarefa, consulte [Manter saída de trabalho e tarefa no Armazenamento do Azure](batch-task-output.md).</span><span class="sxs-lookup"><span data-stu-id="c789f-120">For more information on other options for persisting task output, see [Persist job and task output to Azure Storage](batch-task-output.md).</span></span> 

## <a name="create-a-container-in-azure-storage"></a><span data-ttu-id="c789f-121">Criar um contêiner no Armazenamento do Azure</span><span class="sxs-lookup"><span data-stu-id="c789f-121">Create a container in Azure Storage</span></span>

<span data-ttu-id="c789f-122">Para manter a saída da tarefa no Armazenamento do Azure, você precisará criar um contêiner que serve como o destino para seus arquivos de saída.</span><span class="sxs-lookup"><span data-stu-id="c789f-122">To persist task output to Azure Storage, you'll need to create a container that serves as the destination for your output files.</span></span> <span data-ttu-id="c789f-123">Crie o contêiner antes de executar a tarefa, preferencialmente antes de enviar seu trabalho.</span><span class="sxs-lookup"><span data-stu-id="c789f-123">Create the container before you run your task, preferably before you submit your job.</span></span> <span data-ttu-id="c789f-124">Para criar o contêiner, use a biblioteca de cliente de Armazenamento do Azure apropriada ou o SDK.</span><span class="sxs-lookup"><span data-stu-id="c789f-124">To create the container, use the appropriate Azure Storage client library or SDK.</span></span> <span data-ttu-id="c789f-125">Para obter mais informações sobre APIs de Armazenamento do Azure, consulte a [documentação do Armazenamento do Azure](https://docs.microsoft.com/azure/storage/).</span><span class="sxs-lookup"><span data-stu-id="c789f-125">For more information about Azure Storage APIs, see the [Azure Storage documentation](https://docs.microsoft.com/azure/storage/).</span></span>

<span data-ttu-id="c789f-126">Por exemplo, se você estiver escrevendo seu aplicativo em C#, use a [biblioteca de cliente de Armazenamento do Azure para .NET](https://www.nuget.org/packages/WindowsAzure.Storage/).</span><span class="sxs-lookup"><span data-stu-id="c789f-126">For example, if you are writing your application in C#, use the [Azure Storage client library for .NET](https://www.nuget.org/packages/WindowsAzure.Storage/).</span></span> <span data-ttu-id="c789f-127">O exemplo a seguir mostra como criar um contêiner:</span><span class="sxs-lookup"><span data-stu-id="c789f-127">The following example shows how to create a container:</span></span>

```csharp
CloudBlobContainer container = storageAccount.CreateCloudBlobClient().GetContainerReference(containerName);
await conainer.CreateIfNotExists();
```

## <a name="get-a-shared-access-signature-for-the-container"></a><span data-ttu-id="c789f-128">Obtenha uma assinatura de acesso compartilhado para o contêiner</span><span class="sxs-lookup"><span data-stu-id="c789f-128">Get a shared access signature for the container</span></span>

<span data-ttu-id="c789f-129">Depois de criar o contêiner, obtenha uma assinatura de acesso compartilhado (SAS) com acesso de gravação ao contêiner.</span><span class="sxs-lookup"><span data-stu-id="c789f-129">After you create the container, get a shared access signature (SAS) with write access to the container.</span></span> <span data-ttu-id="c789f-130">Uma SAS fornece acesso delegado para o contêiner.</span><span class="sxs-lookup"><span data-stu-id="c789f-130">A SAS provides delegated access to the container.</span></span> <span data-ttu-id="c789f-131">A SAS concede acesso com um conjunto especificado de permissões e em um intervalo de tempo especificado.</span><span class="sxs-lookup"><span data-stu-id="c789f-131">The SAS grants access with a specified set of permissions and over a specified time interval.</span></span> <span data-ttu-id="c789f-132">O serviço de lote precisa de uma SAS com permissões de gravação para gravar a saída da tarefa no contêiner.</span><span class="sxs-lookup"><span data-stu-id="c789f-132">The Batch service needs a SAS with write permissions to write task output to the container.</span></span> <span data-ttu-id="c789f-133">Para saber mais sobre SAS, confira [Uso de assinaturas de acesso compartilhado \(SAS\) no Armazenamento do Azure](../storage/common/storage-dotnet-shared-access-signature-part-1.md).</span><span class="sxs-lookup"><span data-stu-id="c789f-133">For more information about SAS, see [Using shared access signatures \(SAS\) in Azure Storage](../storage/common/storage-dotnet-shared-access-signature-part-1.md).</span></span>

<span data-ttu-id="c789f-134">Quando você receber uma SAS usando as APIs de Armazenamento do Azure, a API retorna uma cadeia de caracteres de token SAS.</span><span class="sxs-lookup"><span data-stu-id="c789f-134">When you get a SAS using the Azure Storage APIs, the API returns a SAS token string.</span></span> <span data-ttu-id="c789f-135">Essa cadeia de caracteres de token inclui todos os parâmetros de SAS, incluindo as permissões e o intervalo no qual a SAS é válida.</span><span class="sxs-lookup"><span data-stu-id="c789f-135">This token string includes all parameters of the SAS, including the permissions and the interval over which the SAS is valid.</span></span> <span data-ttu-id="c789f-136">Para usar a SAS para acessar um contêiner no Armazenamento do Azure, você precisa anexar a cadeia de caracteres de token SAS para o URI do recurso.</span><span class="sxs-lookup"><span data-stu-id="c789f-136">To use the SAS to access a container in Azure Storage, you need to append the SAS token string to the resource URI.</span></span> <span data-ttu-id="c789f-137">O URI de recurso, junto com o token SAS anexado, fornece acesso autenticado ao Armazenamento do Azure.</span><span class="sxs-lookup"><span data-stu-id="c789f-137">The resource URI, together with the appended SAS token, provides authenticated access to Azure Storage.</span></span>

<span data-ttu-id="c789f-138">O exemplo a seguir mostra como obter uma cadeia de token de SAS somente gravação para o contêiner e anexa a SAS para o URI do contêiner:</span><span class="sxs-lookup"><span data-stu-id="c789f-138">The following example shows how to get a write-only SAS token string for the container, then appends the SAS to the container URI:</span></span>

```csharp
string containerSasToken = container.GetSharedAccessSignature(new SharedAccessBlobPolicy()
{
    SharedAccessExpiryTime = DateTimeOffset.UtcNow.AddDays(1),
    Permissions = SharedAccessBlobPermissions.Write
});

string containerSasUrl = container.Uri.AbsoluteUri + containerSasToken; 
```

## <a name="specify-output-files-for-task-output"></a><span data-ttu-id="c789f-139">Especificar arquivos de saída para a saída da tarefa</span><span class="sxs-lookup"><span data-stu-id="c789f-139">Specify output files for task output</span></span>

<span data-ttu-id="c789f-140">Para especificar os arquivos de saída para uma tarefa, crie uma coleção de objetos [OutputFile](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfile) e a atribua para a propriedade de [CloudTask.OutputFiles](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudtask.outputfiles#Microsoft_Azure_Batch_CloudTask_OutputFiles) ao criar a tarefa.</span><span class="sxs-lookup"><span data-stu-id="c789f-140">To specify output files for a task, create a collection of [OutputFile](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfile) objects and assign it to the [CloudTask.OutputFiles](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.cloudtask.outputfiles#Microsoft_Azure_Batch_CloudTask_OutputFiles) property when you create the task.</span></span> 

<span data-ttu-id="c789f-141">O exemplo de código .NET a seguir cria uma tarefa que grava números aleatórios para um arquivo chamado `output.txt`.</span><span class="sxs-lookup"><span data-stu-id="c789f-141">The following .NET code example creates a task that writes random numbers to a file named `output.txt`.</span></span> <span data-ttu-id="c789f-142">O exemplo cria um arquivo de saída para `output.txt` a ser gravado para o contêiner.</span><span class="sxs-lookup"><span data-stu-id="c789f-142">The example creates an output file for `output.txt` to be written to the container.</span></span> <span data-ttu-id="c789f-143">O exemplo também cria arquivos de saída para os arquivos de log que correspondem ao padrão de arquivo `std*.txt` (_, por exemplo,_, `stdout.txt` e `stderr.txt`).</span><span class="sxs-lookup"><span data-stu-id="c789f-143">The example also creates output files for any log files that match the file pattern `std*.txt` (_e.g._, `stdout.txt` and `stderr.txt`).</span></span> <span data-ttu-id="c789f-144">A URL do contêiner requer o SAS que foi criado anteriormente para o contêiner.</span><span class="sxs-lookup"><span data-stu-id="c789f-144">The container URL requires the SAS that was created previously for the container.</span></span> <span data-ttu-id="c789f-145">O serviço de lote usa as SAS para autenticar o acesso ao contêiner:</span><span class="sxs-lookup"><span data-stu-id="c789f-145">The Batch service uses the SAS to authenticate access to the container:</span></span> 

```csharp
new CloudTask(taskId, "cmd /v:ON /c \"echo off && set && (FOR /L %i IN (1,1,100000) DO (ECHO !RANDOM!)) > output.txt\"")
{
    OutputFiles = new List<OutputFile>
    {
        new OutputFile(
            filePattern: @"..\std*.txt",
            destination: new OutputFileDestination(
         new OutputFileBlobContainerDestination(
                    containerUrl: containerSasUrl,
                    path: taskId)),
            uploadOptions: new OutputFileUploadOptions(
            uploadCondition: OutputFileUploadCondition.TaskCompletion)),
        new OutputFile(
            filePattern: @"output.txt",
            destination: 
         new OutputFileDestination(new OutputFileBlobContainerDestination(
                    containerUrl: containerSasUrl,
                    path: taskId + @"\output.txt")),
            uploadOptions: new OutputFileUploadOptions(
            uploadCondition: OutputFileUploadCondition.TaskCompletion)),
}
```

### <a name="specify-a-file-pattern-for-matching"></a><span data-ttu-id="c789f-146">Especifique um padrão de arquivo para correspondência</span><span class="sxs-lookup"><span data-stu-id="c789f-146">Specify a file pattern for matching</span></span>

<span data-ttu-id="c789f-147">Quando você especifica um arquivo de saída, você pode usar a propriedade [OutputFile.FilePattern](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfile.filepattern#Microsoft_Azure_Batch_OutputFile_FilePattern) para especificar um padrão de arquivo para correspondência.</span><span class="sxs-lookup"><span data-stu-id="c789f-147">When you specify an output file, you can use the [OutputFile.FilePattern](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfile.filepattern#Microsoft_Azure_Batch_OutputFile_FilePattern) property to specify a file pattern for matching.</span></span> <span data-ttu-id="c789f-148">O padrão de arquivo pode corresponder a zero arquivos, um único arquivo ou um conjunto de arquivos que são criados pela tarefa.</span><span class="sxs-lookup"><span data-stu-id="c789f-148">The file pattern may match zero files, a single file, or a set of files that are created by the task.</span></span>

<span data-ttu-id="c789f-149">A propriedade **FilePattern** oferece suporte a caracteres curinga do sistema de arquivos padrão como `*` (para não-recursivo corresponde) e `**` (para corresponde recursivo).</span><span class="sxs-lookup"><span data-stu-id="c789f-149">The **FilePattern** property supports standard filesystem wildcards such as `*` (for non-recursive matches) and `**` (for recursive matches).</span></span> <span data-ttu-id="c789f-150">Por exemplo, o exemplo de código acima especifica o padrão de arquivo para corresponder `std*.txt` não recursiva:</span><span class="sxs-lookup"><span data-stu-id="c789f-150">For example, the code sample above specifies the file pattern to match `std*.txt` non-recursively:</span></span> 

`filePattern: @"..\std*.txt"`

<span data-ttu-id="c789f-151">Para carregar um único arquivo, especifique um padrão de arquivo sem curingas.</span><span class="sxs-lookup"><span data-stu-id="c789f-151">To upload a single file, specify a file pattern with no wildcards.</span></span> <span data-ttu-id="c789f-152">Por exemplo, o exemplo de código acima especifica o padrão de arquivo para corresponder `output.txt`:</span><span class="sxs-lookup"><span data-stu-id="c789f-152">For example, the code sample above specifies the file pattern to match `output.txt`:</span></span>

`filePattern: @"output.txt"`

### <a name="specify-an-upload-condition"></a><span data-ttu-id="c789f-153">Especificar uma condição de upload</span><span class="sxs-lookup"><span data-stu-id="c789f-153">Specify an upload condition</span></span>

<span data-ttu-id="c789f-154">A propriedade [OutputFileUploadOptions.UploadCondition](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfileuploadoptions.uploadcondition#Microsoft_Azure_Batch_OutputFileUploadOptions_UploadCondition) permite o upload condicional de arquivos de saída.</span><span class="sxs-lookup"><span data-stu-id="c789f-154">The [OutputFileUploadOptions.UploadCondition](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfileuploadoptions.uploadcondition#Microsoft_Azure_Batch_OutputFileUploadOptions_UploadCondition) property permits conditional uploading of output files.</span></span> <span data-ttu-id="c789f-155">Um cenário comum é carregar um conjunto de arquivos se a tarefa for bem-sucedida, e um conjunto diferente de arquivos se ele falhar.</span><span class="sxs-lookup"><span data-stu-id="c789f-155">A common scenario is to upload one set of files if the task succeeds, and a different set of files if it fails.</span></span> <span data-ttu-id="c789f-156">Por exemplo, você talvez queira carregar arquivos de log detalhados somente quando a tarefa falhar e for encerrada com um código de saída diferente de zero.</span><span class="sxs-lookup"><span data-stu-id="c789f-156">For example, you may want to upload verbose log files only when the task fails and exits with a nonzero exit code.</span></span> <span data-ttu-id="c789f-157">Da mesma forma, você talvez queira carregar arquivos de resultado somente se a tarefa for bem-sucedida, pois esses arquivos podem estar ausentes ou incompletos se a tarefa falhar.</span><span class="sxs-lookup"><span data-stu-id="c789f-157">Similarly, you may want to upload result files only if the task succeeds, as those files may be missing or incomplete if the task fails.</span></span>

<span data-ttu-id="c789f-158">O exemplo de código acima define a propriedade **UploadCondition** para **TaskCompletion**.</span><span class="sxs-lookup"><span data-stu-id="c789f-158">The code sample above sets the **UploadCondition** property to **TaskCompletion**.</span></span> <span data-ttu-id="c789f-159">Essa configuração especifica que o arquivo será carregado após a conclusão de tarefas, independentemente do valor do código de saída.</span><span class="sxs-lookup"><span data-stu-id="c789f-159">This setting specifies that the file is to be uploaded after the tasks completes, regardless of the value of the exit code.</span></span> 

`uploadCondition: OutputFileUploadCondition.TaskCompletion`

<span data-ttu-id="c789f-160">Para outras configurações, consulte o enum [OutputFileUploadCondition](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.common.outputfileuploadcondition).</span><span class="sxs-lookup"><span data-stu-id="c789f-160">For other settings, see the [OutputFileUploadCondition](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.common.outputfileuploadcondition) enum.</span></span>

### <a name="disambiguate-files-with-the-same-name"></a><span data-ttu-id="c789f-161">Desfazer a ambiguidade de arquivos com o mesmo nome</span><span class="sxs-lookup"><span data-stu-id="c789f-161">Disambiguate files with the same name</span></span>

<span data-ttu-id="c789f-162">As tarefas em um trabalho podem produzir os arquivos que têm o mesmo nome.</span><span class="sxs-lookup"><span data-stu-id="c789f-162">The tasks in a job may produce files that have the same name.</span></span> <span data-ttu-id="c789f-163">Por exemplo, `stdout.txt` e `stderr.txt` são criados para cada tarefa que executa em um trabalho.</span><span class="sxs-lookup"><span data-stu-id="c789f-163">For example, `stdout.txt` and `stderr.txt` are created for every task that runs in a job.</span></span> <span data-ttu-id="c789f-164">Como cada tarefa é executada em seu próprio contexto, esses arquivos não estão em conflito no sistema de arquivos do nó.</span><span class="sxs-lookup"><span data-stu-id="c789f-164">Because each task runs in its own context, these files don't conflict on the node's file system.</span></span> <span data-ttu-id="c789f-165">No entanto, quando você carrega arquivos de várias tarefas para um contêiner compartilhado, você precisará desfazer a ambiguidade de arquivos com o mesmo nome.</span><span class="sxs-lookup"><span data-stu-id="c789f-165">However, when you upload files from multiple tasks to a shared container, you'll need to disambiguate files with the same name.</span></span>

<span data-ttu-id="c789f-166">A propriedade [OutputFileBlobContainerDestination.Path](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfileblobcontainerdestination.path#Microsoft_Azure_Batch_OutputFileBlobContainerDestination_Path) especifica o blob de destino ou o diretório virtual para arquivos de saída.</span><span class="sxs-lookup"><span data-stu-id="c789f-166">The [OutputFileBlobContainerDestination.Path](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfileblobcontainerdestination.path#Microsoft_Azure_Batch_OutputFileBlobContainerDestination_Path) property specifies the destination blob or virtual directory for output files.</span></span> <span data-ttu-id="c789f-167">Você pode usar a propriedade de **caminho** para nomear o blob ou diretório virtual de forma que os arquivos de saída com o mesmo nome são nomeados exclusivamente no Armazenamento do Azure.</span><span class="sxs-lookup"><span data-stu-id="c789f-167">You can use the **Path** property to name the blob or virtual directory in such a way that output files with the same name are uniquely named in Azure Storage.</span></span> <span data-ttu-id="c789f-168">Usando a ID da tarefa no caminho é uma boa maneira de garantir nomes exclusivos e identificar facilmente os arquivos.</span><span class="sxs-lookup"><span data-stu-id="c789f-168">Using the task ID in the path is a good way to ensure unique names and easily identify files.</span></span>

<span data-ttu-id="c789f-169">Se a propriedade **FilePattern** é definida como uma expressão curinga, em seguida, todos os arquivos que correspondem ao padrão são carregados para o diretório virtual especificado pela propriedade **caminho**.</span><span class="sxs-lookup"><span data-stu-id="c789f-169">If the **FilePattern** property is set to a wildcard expression, then all files that match the pattern are uploaded to the virtual directory specified by the **Path** property.</span></span> <span data-ttu-id="c789f-170">Por exemplo, se o contêiner for `mycontainer`, a tarefa de ID é `mytask`, e o padrão de arquivo é `..\std*.txt`, em seguida, os URIs absolutos para arquivos de saída no Armazenamento do Azure serão semelhantes a:</span><span class="sxs-lookup"><span data-stu-id="c789f-170">For example, if the container is `mycontainer`, the task ID is `mytask`, and the file pattern is `..\std*.txt`, then the absolute URIs to the output files in Azure Storage will be similar to:</span></span>

```
https://myaccount.blob.core.windows.net/mycontainer/mytask/stderr.txt
https://myaccount.blob.core.windows.net/mycontainer/mytask/stdout.txt
```

<span data-ttu-id="c789f-171">Se a propriedade **FilePattern** está definida para corresponder a um nome de arquivo único, que significa que ele não contém caracteres curinga, o valor da propriedade **caminho** especifica o nome totalmente qualificado do blob.</span><span class="sxs-lookup"><span data-stu-id="c789f-171">If the **FilePattern** property is set to match a single file name, meaning it does not contain any wildcard characters, then the value of the **Path** property specifies the fully qualified blob name.</span></span> <span data-ttu-id="c789f-172">Se você antecipar conflitos de nomes com um único arquivo de várias tarefas, em seguida, inclua o nome do diretório virtual como parte do nome do arquivo para resolver a ambiguidade desses arquivos.</span><span class="sxs-lookup"><span data-stu-id="c789f-172">If you anticipate naming conflicts with a single file from multiple tasks, then include the name of the virtual directory as part of the file name to disambiguate those files.</span></span> <span data-ttu-id="c789f-173">Por exemplo, definir a propriedade **caminho** para incluir a ID da tarefa, o caractere delimitador (normalmente uma barra invertida) e o nome do arquivo:</span><span class="sxs-lookup"><span data-stu-id="c789f-173">For example, set the **Path** property to include the task ID, the delimiter character (typically a forward slash), and the file name:</span></span>

`path: taskId + @"/output.txt"`

<span data-ttu-id="c789f-174">O URIs absolutos para arquivos de saída para um conjunto de tarefas será semelhante a:</span><span class="sxs-lookup"><span data-stu-id="c789f-174">The absolute URIs to the output files for a set of tasks will be similar to:</span></span>

```
https://myaccount.blob.core.windows.net/mycontainer/task1/output.txt
https://myaccount.blob.core.windows.net/mycontainer/task2/output.txt
```

<span data-ttu-id="c789f-175">Para obter mais informações sobre diretórios virtuais no Armazenamento do Azure, consulte [Listar os blobs em um contêiner](../storage/blobs/storage-dotnet-how-to-use-blobs.md#list-the-blobs-in-a-container).</span><span class="sxs-lookup"><span data-stu-id="c789f-175">For more information about virtual directories in Azure Storage, see [List the blobs in a container](../storage/blobs/storage-dotnet-how-to-use-blobs.md#list-the-blobs-in-a-container).</span></span>


## <a name="diagnose-file-upload-errors"></a><span data-ttu-id="c789f-176">Diagnosticar erros de carregamento de arquivo</span><span class="sxs-lookup"><span data-stu-id="c789f-176">Diagnose file upload errors</span></span>

<span data-ttu-id="c789f-177">Se o carregamento de arquivos de saída no Armazenamento do Azure falhar, então a tarefa será movida para o estado **concluído** e a propriedade [TaskExecutionInformation.FailureInformation](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskexecutioninformation.failureinformation#Microsoft_Azure_Batch_TaskExecutionInformation_FailureInformation) é definida.</span><span class="sxs-lookup"><span data-stu-id="c789f-177">If uploading output files to Azure Storage fails, then the task moves to the **Completed** state and the [TaskExecutionInformation.FailureInformation](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskexecutioninformation.failureinformation#Microsoft_Azure_Batch_TaskExecutionInformation_FailureInformation) property is set.</span></span> <span data-ttu-id="c789f-178">Analise a propriedade **FailureInformation** para determinar o erro.</span><span class="sxs-lookup"><span data-stu-id="c789f-178">Examine the **FailureInformation** property to determine what error occurred.</span></span> <span data-ttu-id="c789f-179">Por exemplo, aqui está um erro que ocorre no upload do arquivo se o contêiner não pode ser encontrado:</span><span class="sxs-lookup"><span data-stu-id="c789f-179">For example, here is an error that occurs on file upload if the container cannot be found:</span></span> 

```
Category: UserError
Code: FileUploadContainerNotFound
Message: One of the specified Azure container(s) was not found while attempting to upload an output file
```

<span data-ttu-id="c789f-180">Em cada upload de arquivo, o lote grava dois arquivos de log para o nó de computação, `fileuploadout.txt` e `fileuploaderr.txt`.</span><span class="sxs-lookup"><span data-stu-id="c789f-180">On every file upload, Batch writes two log files to the compute node, `fileuploadout.txt` and `fileuploaderr.txt`.</span></span> <span data-ttu-id="c789f-181">Você pode analisar esses arquivos de log para saber mais sobre uma falha específica.</span><span class="sxs-lookup"><span data-stu-id="c789f-181">You can examine these log files to learn more about a specific failure.</span></span> <span data-ttu-id="c789f-182">Em casos em que o upload do arquivo nunca foi tentado, por exemplo porque não foi possível executar a própria tarefa, então esses arquivos de log não existirão.</span><span class="sxs-lookup"><span data-stu-id="c789f-182">In cases where the file upload was never attempted, for example because the task itself couldn’t run, then these log files will not exist.</span></span>

## <a name="diagnose-file-upload-performance"></a><span data-ttu-id="c789f-183">Diagnosticar desempenho de carregamento de arquivo</span><span class="sxs-lookup"><span data-stu-id="c789f-183">Diagnose file upload performance</span></span>

<span data-ttu-id="c789f-184">O arquivo `fileuploadout.txt` registra em log o progresso de upload.</span><span class="sxs-lookup"><span data-stu-id="c789f-184">The `fileuploadout.txt` file logs upload progress.</span></span> <span data-ttu-id="c789f-185">Você pode analisar este arquivo para obter mais informações sobre o quanto os carregamentos de arquivo estão demorando.</span><span class="sxs-lookup"><span data-stu-id="c789f-185">You can examine this file to learn more about how long your file uploads are taking.</span></span> <span data-ttu-id="c789f-186">Tenha em mente que há muitos fatores que contribuem para o desempenho de upload, incluindo o tamanho do nó, outra atividade no nó no momento do upload, se o contêiner de destino está na mesma região que o pool de lote, quantos nós estão carregando a conta de armazenamento ao mesmo tempo, e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="c789f-186">Keep in mind that there are many contributing factors to upload performance, including the size of the node, other activity on the node at the time of the upload, whether the target container is in the same region as the Batch pool, how many nodes are uploading to the storage account at the same time, and so on.</span></span>

## <a name="use-the-batch-service-api-with-the-batch-file-conventions-standard"></a><span data-ttu-id="c789f-187">Usar a API de serviço de lote com o padrão de convenções de arquivo em lotes</span><span class="sxs-lookup"><span data-stu-id="c789f-187">Use the Batch service API with the Batch File Conventions standard</span></span>

<span data-ttu-id="c789f-188">Quando você mantém a saída da tarefa com a API de serviço de lote, você pode nomear o contêiner de destino e os blobs como desejar.</span><span class="sxs-lookup"><span data-stu-id="c789f-188">When you persist task output with the Batch service API, you can name your destination container and blobs however you like.</span></span> <span data-ttu-id="c789f-189">Você também pode optar por nomeá-los de acordo com o [padrão de Convenções de Arquivo em Lotes](https://github.com/Azure/azure-sdk-for-net/tree/vs17Dev/src/SDKs/Batch/Support/FileConventions#conventions).</span><span class="sxs-lookup"><span data-stu-id="c789f-189">You can also choose to name them according to the [Batch File Conventions standard](https://github.com/Azure/azure-sdk-for-net/tree/vs17Dev/src/SDKs/Batch/Support/FileConventions#conventions).</span></span> <span data-ttu-id="c789f-190">O padrão de Convenções de Arquivo determina os nomes do contêiner de destino e do blob no Armazenamento do Azure para um determinado arquivo de saída com base nos nomes do trabalho e da tarefa.</span><span class="sxs-lookup"><span data-stu-id="c789f-190">The File Conventions standard determines the names of the destination container and blob in Azure Storage for a given output file based on the names of the job and task.</span></span> <span data-ttu-id="c789f-191">Se você usar o padrão de Convenções de Arquivo para nomear arquivos de saída, os arquivos de saída estarão disponíveis para exibição no [portal do Azure](https://portal.azure.com).</span><span class="sxs-lookup"><span data-stu-id="c789f-191">If you do use the File Conventions standard for naming output files, then your output files are available for viewing in the [Azure portal](https://portal.azure.com).</span></span>

<span data-ttu-id="c789f-192">Se você estiver desenvolvendo em C#, poderá usar os métodos incorporados à [biblioteca Convenções de Arquivo em Lote do Azure para .NET](https://www.nuget.org/packages/Microsoft.Azure.Batch.Conventions.Files).</span><span class="sxs-lookup"><span data-stu-id="c789f-192">If you are developing in C#, you can use the methods built into the [Batch File Conventions library for .NET](https://www.nuget.org/packages/Microsoft.Azure.Batch.Conventions.Files).</span></span> <span data-ttu-id="c789f-193">Essa biblioteca cria os contêineres corretamente nomeados e os caminhos de blob para você.</span><span class="sxs-lookup"><span data-stu-id="c789f-193">This library creates the properly named containers and blob paths for you.</span></span> <span data-ttu-id="c789f-194">Por exemplo, você pode chamar a API para obter o nome correto para o contêiner, com base no nome do trabalho:</span><span class="sxs-lookup"><span data-stu-id="c789f-194">For example, you can call the API to get the correct name for the container, based on the job name:</span></span>

```csharp
string containerName = job.OutputStorageContainerName();
```

<span data-ttu-id="c789f-195">Você pode usar o método [CloudJobExtensions.GetOutputStorageContainerUrl](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.conventions.files.cloudjobextensions.getoutputstoragecontainerurl) para retornar uma URL de assinatura de acesso compartilhado (SAS) que é usada para gravar no contêiner.</span><span class="sxs-lookup"><span data-stu-id="c789f-195">You can use the [CloudJobExtensions.GetOutputStorageContainerUrl](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.conventions.files.cloudjobextensions.getoutputstoragecontainerurl) method to return a shared access signature (SAS) URL that is used to write to the container.</span></span> <span data-ttu-id="c789f-196">Você pode passar esse SAS para o construtor [OutputFileBlobContainerDestination](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfileblobcontainerdestination).</span><span class="sxs-lookup"><span data-stu-id="c789f-196">You can then pass this SAS to the [OutputFileBlobContainerDestination](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.outputfileblobcontainerdestination) constructor.</span></span>

<span data-ttu-id="c789f-197">Se você estiver desenvolvendo com uma linguagem que não C#, precisará implantar o padrão de Convenções de Arquivo você mesmo.</span><span class="sxs-lookup"><span data-stu-id="c789f-197">If you are developing in a language other than C#, you will need to implement the File Conventions standard yourself.</span></span>

## <a name="code-sample"></a><span data-ttu-id="c789f-198">Exemplo de código</span><span class="sxs-lookup"><span data-stu-id="c789f-198">Code sample</span></span>

<span data-ttu-id="c789f-199">O projeto de exemplo [PersistOutputs][github_persistoutputs] é um dos [exemplos de código do Lote do Azure][github_samples] no GitHub.</span><span class="sxs-lookup"><span data-stu-id="c789f-199">The [PersistOutputs][github_persistoutputs] sample project is one of the [Azure Batch code samples][github_samples] on GitHub.</span></span> <span data-ttu-id="c789f-200">Essa solução do Visual Studio demonstra como usar a biblioteca de cliente em lotes para .NET para manter a saída da tarefa para o armazenamento durável.</span><span class="sxs-lookup"><span data-stu-id="c789f-200">This Visual Studio solution demonstrates how to use the Batch client library for .NET to persist task output to durable storage.</span></span> <span data-ttu-id="c789f-201">Para executar o exemplo, siga estas etapas:</span><span class="sxs-lookup"><span data-stu-id="c789f-201">To run the sample, follow these steps:</span></span>

1. <span data-ttu-id="c789f-202">Abra o projeto no **Visual Studio 2015 ou mais recente**.</span><span class="sxs-lookup"><span data-stu-id="c789f-202">Open the project in **Visual Studio 2015 or newer**.</span></span>
2. <span data-ttu-id="c789f-203">Adicione suas **credenciais de conta** do Lote e do Armazenamento a **AccountSettings.settings** no projeto Microsoft.Azure.Batch.Samples.Common.</span><span class="sxs-lookup"><span data-stu-id="c789f-203">Add your Batch and Storage **account credentials** to **AccountSettings.settings** in the Microsoft.Azure.Batch.Samples.Common project.</span></span>
3. <span data-ttu-id="c789f-204">**Compile** (mas não execute) a solução.</span><span class="sxs-lookup"><span data-stu-id="c789f-204">**Build** (but do not run) the solution.</span></span> <span data-ttu-id="c789f-205">Restaure todos os pacotes NuGet, se solicitado.</span><span class="sxs-lookup"><span data-stu-id="c789f-205">Restore any NuGet packages if prompted.</span></span>
4. <span data-ttu-id="c789f-206">Use o portal do Azure para carregar um [pacote de aplicativos](batch-application-packages.md) para **PersistOutputsTask**.</span><span class="sxs-lookup"><span data-stu-id="c789f-206">Use the Azure portal to upload an [application package](batch-application-packages.md) for **PersistOutputsTask**.</span></span> <span data-ttu-id="c789f-207">Inclua o `PersistOutputsTask.exe` e seus assemblies dependentes no pacote .zip, defina a ID do aplicativo como "PersistOutputsTask" e a versão do pacote de aplicativos como "1.0".</span><span class="sxs-lookup"><span data-stu-id="c789f-207">Include the `PersistOutputsTask.exe` and its dependent assemblies in the .zip package, set the application ID to "PersistOutputsTask", and the application package version to "1.0".</span></span>
5. <span data-ttu-id="c789f-208">**Inicie** (execute) o projeto **PersistOutputs**.</span><span class="sxs-lookup"><span data-stu-id="c789f-208">**Start** (run) the **PersistOutputs** project.</span></span>
6. <span data-ttu-id="c789f-209">Quando solicitado a escolher a tecnologia de persistência a usar para executar o exemplo, digite **2** para executar o exemplo usando a API do serviço de lote para manter a saída da tarefa.</span><span class="sxs-lookup"><span data-stu-id="c789f-209">When prompted to choose the persistence technology to use for running the sample, enter **2** to run the sample using the Batch service API to persist task output.</span></span>
7. <span data-ttu-id="c789f-210">Se desejado, execute o exemplo novamente, inserindo **3** para manter a saída com a API de serviço de lote e também para nomear o contêiner de destino e o caminho de blob de acordo com o padrão de Convenções de Arquivo.</span><span class="sxs-lookup"><span data-stu-id="c789f-210">If desired, run the sample again, entering **3** to persist output with the Batch service API, and also to name the destination container and blob path according to the File Conventions standard.</span></span>

## <a name="next-steps"></a><span data-ttu-id="c789f-211">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="c789f-211">Next steps</span></span>

- <span data-ttu-id="c789f-212">Para obter mais informações sobre manter a saída da tarefa com a biblioteca de Convenções de Arquivo para .NET, consulte [Manter dados de trabalho e tarefa no Armazenamento do Azure com a biblioteca de Convenções de Arquivo em Lotes para .NET para manter ](batch-task-output-file-conventions.md).</span><span class="sxs-lookup"><span data-stu-id="c789f-212">For more information on persisting task output with the File Conventions library for .NET, see [Persist job and task data to Azure Storage with the Batch File Conventions library for .NET to persist ](batch-task-output-file-conventions.md).</span></span>
- <span data-ttu-id="c789f-213">Para obter mais informações sobre outras abordagens para manter os dados de saída em lote do Azure, consulte [Manter saída de trabalho e tarefa no Armazenamento do Azure](batch-task-output.md).</span><span class="sxs-lookup"><span data-stu-id="c789f-213">For information on other approaches for persisting output data in Azure Batch, see [Persist job and task output to Azure Storage](batch-task-output.md).</span></span>

[github_persistoutputs]: https://github.com/Azure/azure-batch-samples/tree/master/CSharp/ArticleProjects/PersistOutputs
[github_samples]: https://github.com/Azure/azure-batch-samples
