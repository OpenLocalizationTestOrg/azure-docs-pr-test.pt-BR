---
title: "Investigações personalizadas do Balanceador de Carga e monitoramento do status da integridade | Microsoft Docs"
description: "Saiba como usar investigações personalizadas para o Balanceador de Carga do Azure a fim de monitorar instâncias por trás de um Balanceador de Carga"
services: load-balancer
documentationcenter: na
author: kumudd
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 46b152c5-6a27-4bfc-bea3-05de9ce06a57
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/24/2016
ms.author: kumud
ms.openlocfilehash: cab028fed58d544a56f2f6b12b72364c7baf4d86
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/11/2017
---
# <a name="understand-load-balancer-probes"></a><span data-ttu-id="ba911-103">Entender as investigações do balanceador de carga</span><span class="sxs-lookup"><span data-stu-id="ba911-103">Understand load balancer probes</span></span>

<span data-ttu-id="ba911-104">O Balanceador de Carga do Azure oferece a capacidade de monitorar a integridade das instâncias do servidor usando investigações.</span><span class="sxs-lookup"><span data-stu-id="ba911-104">Azure Load Balancer offers the capability to monitor the health of server instances by using probes.</span></span> <span data-ttu-id="ba911-105">Quando uma investigação não responde, o Balanceador de Carga interrompe o envio de novas conexões para as instâncias não íntegras.</span><span class="sxs-lookup"><span data-stu-id="ba911-105">When a probe fails to respond, Load Balancer stops sending new connections to the unhealthy instance.</span></span> <span data-ttu-id="ba911-106">As conexões existentes não são afetadas e novas conexões são enviadas para instâncias íntegras.</span><span class="sxs-lookup"><span data-stu-id="ba911-106">The existing connections are not affected, and new connections are sent to healthy instances.</span></span>

<span data-ttu-id="ba911-107">Funções do serviço de nuvem (funções de trabalho e da Web) usam um agente convidado para o monitoramento de investigação.</span><span class="sxs-lookup"><span data-stu-id="ba911-107">Cloud service roles (worker roles and web roles) use a guest agent for probe monitoring.</span></span> <span data-ttu-id="ba911-108">As investigações personalizadas de TCP ou HTTP devem ser configuradas quando você usa máquinas virtuais por trás de um Balanceador de Carga.</span><span class="sxs-lookup"><span data-stu-id="ba911-108">TCP or HTTP custom probes must be configured when you use virtual machines behind Load Balancer.</span></span>

## <a name="understand-probe-count-and-timeout"></a><span data-ttu-id="ba911-109">Noções básicas sobre contagem da investigação e tempo limite</span><span class="sxs-lookup"><span data-stu-id="ba911-109">Understand probe count and timeout</span></span>

<span data-ttu-id="ba911-110">O comportamento de investigação depende do seguinte:</span><span class="sxs-lookup"><span data-stu-id="ba911-110">Probe behavior depends on:</span></span>

* <span data-ttu-id="ba911-111">Do número de investigações bem-sucedidas que permitem a uma instância ser rotulada como em execução.</span><span class="sxs-lookup"><span data-stu-id="ba911-111">The number of successful probes that allow an instance to be labeled as up.</span></span>
* <span data-ttu-id="ba911-112">Do número de investigações com falha que fazem com que uma instância seja rotulada como inoperante.</span><span class="sxs-lookup"><span data-stu-id="ba911-112">The number of failed probes that cause an instance to be labeled as down.</span></span>

<span data-ttu-id="ba911-113">O valor de tempo limite e de frequência definido em SuccessFailCount determina se uma instância foi confirmada como em execução ou não.</span><span class="sxs-lookup"><span data-stu-id="ba911-113">The timeout and frequency value set in  SuccessFailCount determine whether an instance is confirmed to be running or not running.</span></span> <span data-ttu-id="ba911-114">Para o Portal do Azure, o tempo limite é definido como duas vezes o valor da frequência.</span><span class="sxs-lookup"><span data-stu-id="ba911-114">In the Azure portal, the timeout is set to two times the value of the frequency.</span></span>

<span data-ttu-id="ba911-115">A configuração da investigação de todas as instâncias com balanceamento de carga para um ponto de extremidade (ou seja, um conjunto com balanceamento de carga) deve ser a mesma.</span><span class="sxs-lookup"><span data-stu-id="ba911-115">The probe configuration of all load-balanced instances for an endpoint (that is, a load-balanced set) must be the same.</span></span> <span data-ttu-id="ba911-116">Isso significa que você não pode ter uma configuração de investigação diferente para cada instância de função ou máquina virtual no mesmo serviço hospedado para uma combinação de ponto de extremidade específica.</span><span class="sxs-lookup"><span data-stu-id="ba911-116">This means you cannot have a different probe configuration for each role instance or virtual machine in the same hosted service for a particular endpoint combination.</span></span> <span data-ttu-id="ba911-117">Por exemplo, cada instância deve ter portas locais e tempos limite idênticos.</span><span class="sxs-lookup"><span data-stu-id="ba911-117">For example, each instance must have identical local ports and timeouts.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="ba911-118">A investigação de um Balanceador de Carga usa um endereço IP 168.63.129.16.</span><span class="sxs-lookup"><span data-stu-id="ba911-118">A Load Balancer probe uses the IP address 168.63.129.16.</span></span> <span data-ttu-id="ba911-119">Esse endereço IP público facilita a comunicação com recursos internos de plataforma para o cenário de Rede Virtual do Azure com seu próprio IP.</span><span class="sxs-lookup"><span data-stu-id="ba911-119">This public IP address facilitates communication to internal platform resources for the bring-your-own-IP Azure Virtual Network scenario.</span></span> <span data-ttu-id="ba911-120">O endereço IP público 168.63.129.16 virtual é usado em todas as regiões e não será alterado.</span><span class="sxs-lookup"><span data-stu-id="ba911-120">The virtual public IP address 168.63.129.16 is used in all regions and will not change.</span></span> <span data-ttu-id="ba911-121">Recomendamos que você permita esse endereço IP em todas as políticas de firewall local.</span><span class="sxs-lookup"><span data-stu-id="ba911-121">We recommend that you allow this IP address in any local firewall policies.</span></span> <span data-ttu-id="ba911-122">Ele não deve ser considerado um risco de segurança, pois somente a plataforma interna do Azure pode originar uma mensagem a partir dele.</span><span class="sxs-lookup"><span data-stu-id="ba911-122">It should not be considered a security risk because only the internal Azure platform can source a message from that address.</span></span> <span data-ttu-id="ba911-123">Se você não fizer isso, haverá em um comportamento inesperado em vários cenários, como a configuração do mesmo intervalo de endereços IP como 168.63.129.16 e endereços IP duplicados.</span><span class="sxs-lookup"><span data-stu-id="ba911-123">If you do not do this, there will be unexpected behavior in a variety of scenarios like configuring the same IP address range of 168.63.129.16 and having duplicated IP addresses.</span></span>

## <a name="learn-about-the-types-of-probes"></a><span data-ttu-id="ba911-124">Saiba mais sobre os tipos de investigações</span><span class="sxs-lookup"><span data-stu-id="ba911-124">Learn about the types of probes</span></span>

### <a name="guest-agent-probe"></a><span data-ttu-id="ba911-125">Investigação do agente convidado</span><span class="sxs-lookup"><span data-stu-id="ba911-125">Guest agent probe</span></span>

<span data-ttu-id="ba911-126">Essa investigação só está disponível para os Serviços de Nuvem do Azure.</span><span class="sxs-lookup"><span data-stu-id="ba911-126">This probe is available for Azure Cloud Services only.</span></span> <span data-ttu-id="ba911-127">O Balanceador de Carga utiliza o agente convidado dentro da máquina virtual e, então, escuta e responde com uma resposta HTTP 200 OK somente quando a instância estiver no estado Pronto (ou seja, não em outro estado como Ocupado, Reciclando ou Parando).</span><span class="sxs-lookup"><span data-stu-id="ba911-127">Load Balancer utilizes the guest agent inside the virtual machine, and then listens and responds with an HTTP 200 OK response only when the instance is in the Ready state (that is, not in another state such as Busy, Recycling, or Stopping).</span></span>

<span data-ttu-id="ba911-128">Para saber mais, consulte [Configuring the service definition file (csdef) for health probes (Configurando o arquivo de definição de serviço (csdef) para investigações de integridade)](https://msdn.microsoft.com/library/azure/ee758710.aspx) ou [Get started creating an Internet-facing load balancer for cloud services (Introdução à criação de um balanceador de carga para Internet para serviços de nuvem)](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services).</span><span class="sxs-lookup"><span data-stu-id="ba911-128">For more information, see [Configuring the service definition file (csdef) for health probes](https://msdn.microsoft.com/library/azure/ee758710.aspx) or [Get started creating an Internet-facing load balancer for cloud services](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services).</span></span>

### <a name="what-makes-a-guest-agent-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="ba911-129">O que faz uma investigação de agente convidado marcar uma instância como não íntegra?</span><span class="sxs-lookup"><span data-stu-id="ba911-129">What makes a guest agent probe mark an instance as unhealthy?</span></span>

<span data-ttu-id="ba911-130">Se o agente convidado não responder com HTTP 200 OK, o Balanceador de Carga marcará a instância como sem resposta e interromperá o envio de tráfego para essa instância.</span><span class="sxs-lookup"><span data-stu-id="ba911-130">If the guest agent fails to respond with HTTP 200 OK, the load balancer marks the instance as unresponsive and stops sending traffic to that instance.</span></span> <span data-ttu-id="ba911-131">O balanceador de carga continuará executando o ping nessa instância.</span><span class="sxs-lookup"><span data-stu-id="ba911-131">The load balancer continues to ping the instance.</span></span> <span data-ttu-id="ba911-132">Se o agente convidado responder com um HTTP 200, o Balanceador de Carga enviará o tráfego para essa instância novamente.</span><span class="sxs-lookup"><span data-stu-id="ba911-132">If the guest agent responds with an HTTP 200, the load balancer sends traffic to that instance again.</span></span>

<span data-ttu-id="ba911-133">Quando você usa uma função Web, o código do site geralmente é executado no w3wp.exe, que não é monitorado nem pela malha do Azure nem pelo agente convidado.</span><span class="sxs-lookup"><span data-stu-id="ba911-133">When you use a web role, the website code typically runs in w3wp.exe, which is not monitored by the Azure fabric or guest agent.</span></span> <span data-ttu-id="ba911-134">Isso significa que as falhas no w3wp.exe (por exemplo, as respostas HTTP 500) não serão relatadas para o agente convidado, e o balanceador de carga não retirará essa instância da rotação.</span><span class="sxs-lookup"><span data-stu-id="ba911-134">This means that failures in w3wp.exe (for example, HTTP 500 responses) will not be reported to the guest agent, and the load balancer will not take that instance out of rotation.</span></span>

### <a name="http-custom-probe"></a><span data-ttu-id="ba911-135">Investigação personalizada do HTTP</span><span class="sxs-lookup"><span data-stu-id="ba911-135">HTTP custom probe</span></span>

<span data-ttu-id="ba911-136">A investigação personalizada do Balanceador de Carga HTTP substitui a investigação do agente convidado padrão, o que permite a criação de sua própria lógica personalizada para determinar a integridade da instância de função.</span><span class="sxs-lookup"><span data-stu-id="ba911-136">The custom HTTP Load Balancer probe overrides the default guest agent probe, which means that you can create your own custom logic to determine the health of the role instance.</span></span> <span data-ttu-id="ba911-137">Por padrão, o balanceador de carga investiga seu ponto de extremidade a cada 15 segundos.</span><span class="sxs-lookup"><span data-stu-id="ba911-137">The load balancer probes your endpoint every 15 seconds, by default.</span></span> <span data-ttu-id="ba911-138">A instância será considerada em rotação do balanceador de carga se ela responder com um HTTP 200 dentro do período de tempo limite (31 segundos por padrão).</span><span class="sxs-lookup"><span data-stu-id="ba911-138">The instance is considered to be in the load balancer rotation if it responds with an HTTP 200 within the timeout period (31 seconds by default).</span></span>

<span data-ttu-id="ba911-139">Isso pode ser útil ser você quiser implementar sua própria lógica para remover instâncias da rotação do balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="ba911-139">This can be useful if you want to implement your own logic to remove instances from load balancer rotation.</span></span> <span data-ttu-id="ba911-140">Por exemplo, você pode decidir remover uma instância se ela estiver usando mais de 90% da CPU e retornar um status diferente de 200.</span><span class="sxs-lookup"><span data-stu-id="ba911-140">For example, you could decide to remove an instance if it is above 90% CPU and returns a non-200 status.</span></span> <span data-ttu-id="ba911-141">Se houver funções Web que usam o w3wp.exe, também significará que seu site é monitorado automaticamente, pois as falhas no código do site retornarão um status diferente de 200 para a investigação do balanceador de carga.</span><span class="sxs-lookup"><span data-stu-id="ba911-141">If you have web roles that use w3wp.exe, this also means you get automatic monitoring of your website, because failures in your website code will return a non-200 status to the load balancer probe.</span></span>

> [!NOTE]
> <span data-ttu-id="ba911-142">A investigação personalizada HTTP só oferece suporte aos caminhos relativos e ao protocolo HTTP.</span><span class="sxs-lookup"><span data-stu-id="ba911-142">The HTTP custom probe supports relative paths and HTTP protocol only.</span></span> <span data-ttu-id="ba911-143">Não há suporte para HTTPS.</span><span class="sxs-lookup"><span data-stu-id="ba911-143">HTTPS is not supported.</span></span>

### <a name="what-makes-an-http-custom-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="ba911-144">O que faz uma investigação personalizada HTTP marcar uma instância como não íntegra?</span><span class="sxs-lookup"><span data-stu-id="ba911-144">What makes an HTTP custom probe mark an instance as unhealthy?</span></span>

* <span data-ttu-id="ba911-145">O aplicativo HTTP retorna um código de resposta HTTP diferente de 200 (por exemplo, 403, 404 ou 500).</span><span class="sxs-lookup"><span data-stu-id="ba911-145">The HTTP application returns an HTTP response code other than 200 (for example, 403, 404, or 500).</span></span> <span data-ttu-id="ba911-146">Essa é uma confirmação positiva de que a instância do aplicativo deve ser retirada do serviço imediatamente.</span><span class="sxs-lookup"><span data-stu-id="ba911-146">This is a positive acknowledgment that the application instance should be taken out of service right away.</span></span>
* <span data-ttu-id="ba911-147">O servidor HTTP não responde após o período de tempo limite.</span><span class="sxs-lookup"><span data-stu-id="ba911-147">The HTTP server does not respond at all after the timeout period.</span></span> <span data-ttu-id="ba911-148">Dependendo do valor de tempo limite definido, várias solicitações de investigação podem ficar sem resposta antes de a investigação ser marcada como não estando em execução (ou seja, antes das investigações SuccessFailCount serem enviadas).</span><span class="sxs-lookup"><span data-stu-id="ba911-148">Depending on the timeout value that is set, this might mean that multiple probe requests go unanswered before the probe gets marked as not running (that is, before SuccessFailCount probes are sent).</span></span>
* <span data-ttu-id="ba911-149">O servidor fecha a conexão por meio de uma redefinição TCP.</span><span class="sxs-lookup"><span data-stu-id="ba911-149">The server closes the connection via a TCP reset.</span></span>

### <a name="tcp-custom-probe"></a><span data-ttu-id="ba911-150">Investigação personalizada do TCP</span><span class="sxs-lookup"><span data-stu-id="ba911-150">TCP custom probe</span></span>

<span data-ttu-id="ba911-151">As investigações de TCP iniciam uma conexão executando um handshake de três vias na porta definida.</span><span class="sxs-lookup"><span data-stu-id="ba911-151">TCP probes initiate a connection by performing a three-way handshake with the defined port.</span></span>

### <a name="what-makes-a-tcp-custom-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="ba911-152">O que faz uma investigação personalizada TCP marcar uma instância como não íntegra?</span><span class="sxs-lookup"><span data-stu-id="ba911-152">What makes a TCP custom probe mark an instance as unhealthy?</span></span>

* <span data-ttu-id="ba911-153">O servidor TCP não responde após o período de tempo limite.</span><span class="sxs-lookup"><span data-stu-id="ba911-153">The TCP server does not respond at all after the timeout period.</span></span> <span data-ttu-id="ba911-154">A marcação da investigação como não estando em execução depende da configuração da quantidade de solicitações de investigação sem resposta.</span><span class="sxs-lookup"><span data-stu-id="ba911-154">When the probe is marked as not running depends on the number of failed probe requests that were configured to go unanswered before marking the probe as not running.</span></span>
* <span data-ttu-id="ba911-155">A investigação recebe uma redefinição de TCP da instância de função.</span><span class="sxs-lookup"><span data-stu-id="ba911-155">The probe receives a TCP reset from the role instance.</span></span>

<span data-ttu-id="ba911-156">Para saber mais sobre como configurar uma investigação de integridade HTTP ou uma investigação de TCP, confira [Introdução à criação de um balanceador de carga para a Internet no Resource Manager usando o PowerShell](load-balancer-get-started-internet-arm-ps.md).</span><span class="sxs-lookup"><span data-stu-id="ba911-156">For more information about configuring an HTTP health probe or a TCP probe, see [Get started creating an Internet-facing load balancer in Resource Manager using PowerShell](load-balancer-get-started-internet-arm-ps.md).</span></span>

## <a name="add-healthy-instances-back-into-load-balancer-rotation"></a><span data-ttu-id="ba911-157">Adicionar instâncias íntegras de volta à rotação do balanceador de carga</span><span class="sxs-lookup"><span data-stu-id="ba911-157">Add healthy instances back into load balancer rotation</span></span>

<span data-ttu-id="ba911-158">As investigações de TCP e HTTP são consideradas íntegras e marcam a instância de função como íntegra quando:</span><span class="sxs-lookup"><span data-stu-id="ba911-158">TCP and HTTP probes are considered healthy and mark the role instance as healthy when:</span></span>

* <span data-ttu-id="ba911-159">O balanceador de carga obtém uma investigação positiva na primeira vez em que a VM é iniciada.</span><span class="sxs-lookup"><span data-stu-id="ba911-159">The load balancer gets a positive probe the first time the VM boots.</span></span>
* <span data-ttu-id="ba911-160">O número SuccessFailCount (descrito acima) define o valor de investigações bem-sucedidas necessárias para marcar a instância de função como íntegra.</span><span class="sxs-lookup"><span data-stu-id="ba911-160">The number SuccessFailCount (described earlier) defines the value of successful probes that are required to mark the role instance as healthy.</span></span> <span data-ttu-id="ba911-161">Se uma instância de função tiver sido removida, o número de investigações bem-sucedidas e sucessivas deverá ser igual ou exceder o valor de SuccessFailCount a fim de marcar a instância de função como em execução.</span><span class="sxs-lookup"><span data-stu-id="ba911-161">If a role instance was removed, the number of successful, successive probes must equal or exceed the value of SuccessFailCount to mark the role instance as running.</span></span>

> [!NOTE]
> <span data-ttu-id="ba911-162">Se a integridade de uma instância de função for flutuante, o balanceador de carga aguardará antes de colocar a instância de função de volta ao estado íntegro.</span><span class="sxs-lookup"><span data-stu-id="ba911-162">If the health of a role instance is fluctuating, the load balancer waits longer before putting the role instance back in the healthy state.</span></span> <span data-ttu-id="ba911-163">Isso é feito por meio de uma política para proteger o usuário e a infraestrutura.</span><span class="sxs-lookup"><span data-stu-id="ba911-163">This is done via policy to protect the user and the infrastructure.</span></span>

## <a name="use-log-analytics-for-load-balancer"></a><span data-ttu-id="ba911-164">Usar análise de log para o Balanceador de Carga</span><span class="sxs-lookup"><span data-stu-id="ba911-164">Use log analytics for Load Balancer</span></span>

<span data-ttu-id="ba911-165">Você pode usar a [análise de logs para o Balanceador de Carga](load-balancer-monitor-log.md) para verificar o status da integridade da investigação e a contagem da investigação.</span><span class="sxs-lookup"><span data-stu-id="ba911-165">You can use [log analytics for Load Balancer](load-balancer-monitor-log.md) to check on the probe health status and probe count.</span></span> <span data-ttu-id="ba911-166">O registro em log pode ser usado com o Power BI ou com o Azure Operational Insights para fornecer estatísticas sobre o status da integridade do Balanceador de Carga.</span><span class="sxs-lookup"><span data-stu-id="ba911-166">Logging can be used with Power BI or Azure Operational Insights to provide statistics about Load Balancer health status.</span></span>
