---
title: "aaaIntegrate Cofre de chaves com o SQL Server em máquinas virtuais do Windows no Azure (clássica) | Microsoft Docs"
description: "Saiba como tooautomate Olá configuração de criptografia do SQL Server para uso com o Cofre de chaves do Azure. Este tópico explica como toouse integração do cofre da chave do Azure com máquinas virtuais do SQL Server cria no modelo de implantação clássico hello."
services: virtual-machines-windows
documentationcenter: 
author: rothja
manager: jhubbard
editor: 
tags: azure-service-management
ms.assetid: ab8d41a7-1971-4032-ab71-eb435c455dc1
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 02/17/2017
ms.author: jroth
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 54664875b76dac7271d5a9f00b3f41fdc9c08491
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/06/2017
---
# <a name="configure-azure-key-vault-integration-for-sql-server-on-azure-virtual-machines-classic"></a><span data-ttu-id="f58c6-104">Configurar a Integração do Azure Key Vault para SQL Server em Máquinas Virtuais do Azure (Clássicas)</span><span class="sxs-lookup"><span data-stu-id="f58c6-104">Configure Azure Key Vault Integration for SQL Server on Azure Virtual Machines (Classic)</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="f58c6-105">Gerenciador de Recursos</span><span class="sxs-lookup"><span data-stu-id="f58c6-105">Resource Manager</span></span>](../sql/virtual-machines-windows-ps-sql-keyvault.md)
> * [<span data-ttu-id="f58c6-106">Clássico</span><span class="sxs-lookup"><span data-stu-id="f58c6-106">Classic</span></span>](../classic/ps-sql-keyvault.md)
> 
> 

## <a name="overview"></a><span data-ttu-id="f58c6-107">Visão geral</span><span class="sxs-lookup"><span data-stu-id="f58c6-107">Overview</span></span>
<span data-ttu-id="f58c6-108">Há vários recursos de criptografia do SQL Server, como [TDE (Transparent Data Encryption)](https://msdn.microsoft.com/library/bb934049.aspx), [CLE (criptografia de nível de coluna)](https://msdn.microsoft.com/library/ms173744.aspx) e [criptografia de backup](https://msdn.microsoft.com/library/dn449489.aspx).</span><span class="sxs-lookup"><span data-stu-id="f58c6-108">There are multiple SQL Server encryption features, such as [transparent data encryption (TDE)](https://msdn.microsoft.com/library/bb934049.aspx), [column level encryption (CLE)](https://msdn.microsoft.com/library/ms173744.aspx), and [backup encryption](https://msdn.microsoft.com/library/dn449489.aspx).</span></span> <span data-ttu-id="f58c6-109">Esses formulários de criptografia exigem que você toomanage e armazenam chaves de criptografia Olá usado para criptografia.</span><span class="sxs-lookup"><span data-stu-id="f58c6-109">These forms of encryption require you toomanage and store hello cryptographic keys you use for encryption.</span></span> <span data-ttu-id="f58c6-110">Olá serviço Azure Key Vault (AKV) é projetado tooimprove Olá segurança e o gerenciamento dessas chaves em um local seguro e altamente disponível.</span><span class="sxs-lookup"><span data-stu-id="f58c6-110">hello Azure Key Vault (AKV) service is designed tooimprove hello security and management of these keys in a secure and highly available location.</span></span> <span data-ttu-id="f58c6-111">Olá [SQL Server Connector](http://www.microsoft.com/download/details.aspx?id=45344) permite que o SQL Server toouse essas chaves do Cofre de chaves do Azure.</span><span class="sxs-lookup"><span data-stu-id="f58c6-111">hello [SQL Server Connector](http://www.microsoft.com/download/details.aspx?id=45344) enables SQL Server toouse these keys from Azure Key Vault.</span></span>

> [!IMPORTANT] 
> <span data-ttu-id="f58c6-112">O Azure tem dois modelos de implantação diferentes para criar e trabalhar com recursos: [Gerenciador de Recursos e Clássico](../../../azure-resource-manager/resource-manager-deployment-model.md).</span><span class="sxs-lookup"><span data-stu-id="f58c6-112">Azure has two different deployment models for creating and working with resources: [Resource Manager and Classic](../../../azure-resource-manager/resource-manager-deployment-model.md).</span></span> <span data-ttu-id="f58c6-113">Este artigo aborda usando o modelo de implantação clássico hello.</span><span class="sxs-lookup"><span data-stu-id="f58c6-113">This article covers using hello Classic deployment model.</span></span> <span data-ttu-id="f58c6-114">A Microsoft recomenda que mais novas implantações de usam o modelo do Gerenciador de recursos de saudação.</span><span class="sxs-lookup"><span data-stu-id="f58c6-114">Microsoft recommends that most new deployments use hello Resource Manager model.</span></span>

<span data-ttu-id="f58c6-115">Se você estiver executando o SQL Server com computadores locais, há [etapas que você pode seguir tooaccess Azure Key Vault da máquina local do SQL Server](https://msdn.microsoft.com/library/dn198405.aspx).</span><span class="sxs-lookup"><span data-stu-id="f58c6-115">If you are running SQL Server with on-premises machines, there are [steps you can follow tooaccess Azure Key Vault from your on-premises SQL Server machine](https://msdn.microsoft.com/library/dn198405.aspx).</span></span> <span data-ttu-id="f58c6-116">Mas para SQL Server em máquinas virtuais do Azure, você pode economizar tempo usando Olá *integração do cofre da chave do Azure* recurso.</span><span class="sxs-lookup"><span data-stu-id="f58c6-116">But for SQL Server in Azure VMs, you can save time by using hello *Azure Key Vault Integration* feature.</span></span> <span data-ttu-id="f58c6-117">Com alguns tooenable de cmdlets do PowerShell do Azure esse recurso, você pode automatizar Olá seu Cofre de chaves de configuração necessárias para uma VM do SQL tooaccess.</span><span class="sxs-lookup"><span data-stu-id="f58c6-117">With a few Azure PowerShell cmdlets tooenable this feature, you can automate hello configuration necessary for a SQL VM tooaccess your key vault.</span></span>

<span data-ttu-id="f58c6-118">Quando esse recurso está habilitado, ele automaticamente instala Olá conector do SQL Server, configura Olá EKM provedor tooaccess Cofre de chaves do Azure e cria Olá credencial tooallow você tooaccess seu cofre.</span><span class="sxs-lookup"><span data-stu-id="f58c6-118">When this feature is enabled, it automatically installs hello SQL Server Connector, configures hello EKM provider tooaccess Azure Key Vault, and creates hello credential tooallow you tooaccess your vault.</span></span> <span data-ttu-id="f58c6-119">Se você examinou etapas Olá Olá mencionado anteriormente documentação local, você pode ver que esse recurso automatiza as etapas 2 e 3.</span><span class="sxs-lookup"><span data-stu-id="f58c6-119">If you looked at hello steps in hello previously mentioned on-premises documentation, you can see that this feature automates steps 2 and 3.</span></span> <span data-ttu-id="f58c6-120">Olá única você ainda precisaria toodo manualmente é chaves e cofre da chave toocreate hello.</span><span class="sxs-lookup"><span data-stu-id="f58c6-120">hello only thing you would still need toodo manually is toocreate hello key vault and keys.</span></span> <span data-ttu-id="f58c6-121">A partir daí, a configuração inteira Olá da sua VM do SQL é automatizada.</span><span class="sxs-lookup"><span data-stu-id="f58c6-121">From there, hello entire setup of your SQL VM is automated.</span></span> <span data-ttu-id="f58c6-122">Depois que esse recurso foi concluída a instalação, você pode executar toobegin de instruções T-SQL criptografar seu ou backups de bancos de dados como faria normalmente.</span><span class="sxs-lookup"><span data-stu-id="f58c6-122">Once this feature has completed this setup, you can execute T-SQL statements toobegin encrypting your databases or backups as you normally would.</span></span>

[!INCLUDE [AKV Integration Prepare](../../../../includes/virtual-machines-sql-server-akv-prepare.md)]

## <a name="configure-akv-integration"></a><span data-ttu-id="f58c6-123">Configurar a integração de AKV</span><span class="sxs-lookup"><span data-stu-id="f58c6-123">Configure AKV Integration</span></span>
<span data-ttu-id="f58c6-124">Use o PowerShell tooconfigure integração do cofre da chave do Azure.</span><span class="sxs-lookup"><span data-stu-id="f58c6-124">Use PowerShell tooconfigure Azure Key Vault Integration.</span></span> <span data-ttu-id="f58c6-125">Olá seções a seguir fornece uma visão geral dos parâmetros de saudação necessárias e, em seguida, um exemplo de script do PowerShell.</span><span class="sxs-lookup"><span data-stu-id="f58c6-125">hello following sections provide an overview of hello required parameters and then a sample PowerShell script.</span></span>

### <a name="install-hello-sql-server-iaas-extension"></a><span data-ttu-id="f58c6-126">Instalar Olá extensão de IaaS do SQL Server</span><span class="sxs-lookup"><span data-stu-id="f58c6-126">Install hello SQL Server IaaS Extension</span></span>
<span data-ttu-id="f58c6-127">Primeiro, [instalar Olá extensão do SQL Server IaaS](../classic/sql-server-agent-extension.md).</span><span class="sxs-lookup"><span data-stu-id="f58c6-127">First, [install hello SQL Server IaaS Extension](../classic/sql-server-agent-extension.md).</span></span>

### <a name="understand-hello-input-parameters"></a><span data-ttu-id="f58c6-128">Entender os parâmetros de entrada hello</span><span class="sxs-lookup"><span data-stu-id="f58c6-128">Understand hello input parameters</span></span>
<span data-ttu-id="f58c6-129">Olá seguinte tabela lista Olá parâmetros necessários script do PowerShell Olá toorun na próxima seção, Olá.</span><span class="sxs-lookup"><span data-stu-id="f58c6-129">hello following table lists hello parameters required toorun hello PowerShell script in hello next section.</span></span>

| <span data-ttu-id="f58c6-130">Parâmetro</span><span class="sxs-lookup"><span data-stu-id="f58c6-130">Parameter</span></span> | <span data-ttu-id="f58c6-131">Descrição</span><span class="sxs-lookup"><span data-stu-id="f58c6-131">Description</span></span> | <span data-ttu-id="f58c6-132">Exemplo</span><span class="sxs-lookup"><span data-stu-id="f58c6-132">Example</span></span> |
| --- | --- | --- |
| <span data-ttu-id="f58c6-133">**$akvURL**</span><span class="sxs-lookup"><span data-stu-id="f58c6-133">**$akvURL**</span></span> |<span data-ttu-id="f58c6-134">**URL de Cofre de chaves Olá**</span><span class="sxs-lookup"><span data-stu-id="f58c6-134">**hello key vault URL**</span></span> |<span data-ttu-id="f58c6-135">"https://contosokeyvault.vault.azure.net/"</span><span class="sxs-lookup"><span data-stu-id="f58c6-135">"https://contosokeyvault.vault.azure.net/"</span></span> |
| <span data-ttu-id="f58c6-136">**$spName**</span><span class="sxs-lookup"><span data-stu-id="f58c6-136">**$spName**</span></span> |<span data-ttu-id="f58c6-137">**Nome da Entidade de Serviço**</span><span class="sxs-lookup"><span data-stu-id="f58c6-137">**Service Principal name**</span></span> |<span data-ttu-id="f58c6-138">"fde2b411-33d5-4e11-af04eb07b669ccf2"</span><span class="sxs-lookup"><span data-stu-id="f58c6-138">"fde2b411-33d5-4e11-af04eb07b669ccf2"</span></span> |
| <span data-ttu-id="f58c6-139">**$spSecret**</span><span class="sxs-lookup"><span data-stu-id="f58c6-139">**$spSecret**</span></span> |<span data-ttu-id="f58c6-140">**Segredo da Entidade de Serviço**</span><span class="sxs-lookup"><span data-stu-id="f58c6-140">**Service Principal secret**</span></span> |<span data-ttu-id="f58c6-141">"9VTJSQwzlFepD8XODnzy8n2V01Jd8dAjwm/azF1XDKM="</span><span class="sxs-lookup"><span data-stu-id="f58c6-141">"9VTJSQwzlFepD8XODnzy8n2V01Jd8dAjwm/azF1XDKM="</span></span> |
| <span data-ttu-id="f58c6-142">**$credName**</span><span class="sxs-lookup"><span data-stu-id="f58c6-142">**$credName**</span></span> |<span data-ttu-id="f58c6-143">**Nome da credencial**: integração AKV cria uma credencial do SQL Server, permitindo que o cofre da chave de toohello Olá VM toohave acesso.</span><span class="sxs-lookup"><span data-stu-id="f58c6-143">**Credential name**: AKV Integration creates a credential within SQL Server, allowing hello VM toohave access toohello key vault.</span></span> <span data-ttu-id="f58c6-144">Escolha um nome para essa credencial.</span><span class="sxs-lookup"><span data-stu-id="f58c6-144">Choose a name for this credential.</span></span> |<span data-ttu-id="f58c6-145">"mycred1"</span><span class="sxs-lookup"><span data-stu-id="f58c6-145">"mycred1"</span></span> |
| <span data-ttu-id="f58c6-146">**$vmName**</span><span class="sxs-lookup"><span data-stu-id="f58c6-146">**$vmName**</span></span> |<span data-ttu-id="f58c6-147">**Nome da máquina virtual**: nome de saudação de uma VM de SQL criado anteriormente.</span><span class="sxs-lookup"><span data-stu-id="f58c6-147">**Virtual machine name**: hello name of a previously created SQL VM.</span></span> |<span data-ttu-id="f58c6-148">"myvmname"</span><span class="sxs-lookup"><span data-stu-id="f58c6-148">"myvmname"</span></span> |
| <span data-ttu-id="f58c6-149">**$serviceName**</span><span class="sxs-lookup"><span data-stu-id="f58c6-149">**$serviceName**</span></span> |<span data-ttu-id="f58c6-150">**Nome do serviço**: nome de serviço de nuvem Olá associado Olá VM do SQL.</span><span class="sxs-lookup"><span data-stu-id="f58c6-150">**Service name**: hello Cloud Service name that is associated with hello SQL VM.</span></span> |<span data-ttu-id="f58c6-151">"mycloudservicename"</span><span class="sxs-lookup"><span data-stu-id="f58c6-151">"mycloudservicename"</span></span> |

### <a name="enable-akv-integration-with-powershell"></a><span data-ttu-id="f58c6-152">Habilitar a integração de AKV com o PowerShell</span><span class="sxs-lookup"><span data-stu-id="f58c6-152">Enable AKV Integration with PowerShell</span></span>
<span data-ttu-id="f58c6-153">Olá **AzureVMSqlServerKeyVaultCredentialConfig novo** cmdlet cria um objeto de configuração para o recurso de integração do Azure Key Vault hello.</span><span class="sxs-lookup"><span data-stu-id="f58c6-153">hello **New-AzureVMSqlServerKeyVaultCredentialConfig** cmdlet creates a configuration object for hello Azure Key Vault Integration feature.</span></span> <span data-ttu-id="f58c6-154">Olá **conjunto AzureVMSqlServerExtension** configura essa integração com hello **KeyVaultCredentialSettings** parâmetro.</span><span class="sxs-lookup"><span data-stu-id="f58c6-154">hello **Set-AzureVMSqlServerExtension** configures this integration with hello **KeyVaultCredentialSettings** parameter.</span></span> <span data-ttu-id="f58c6-155">Olá mostram as etapas a seguir como toouse esses comandos.</span><span class="sxs-lookup"><span data-stu-id="f58c6-155">hello following steps show how toouse these commands.</span></span>

1. <span data-ttu-id="f58c6-156">No Azure PowerShell primeiro configure parâmetros de entrada hello com seus valores específicos conforme descrito nas seções anteriores Olá neste tópico.</span><span class="sxs-lookup"><span data-stu-id="f58c6-156">In Azure PowerShell, first configure hello input parameters with your specific values as described in hello previous sections of this topic.</span></span> <span data-ttu-id="f58c6-157">saudação de script a seguir está um exemplo.</span><span class="sxs-lookup"><span data-stu-id="f58c6-157">hello following script is an example.</span></span>
   
        $akvURL = "https://contosokeyvault.vault.azure.net/"
        $spName = "fde2b411-33d5-4e11-af04eb07b669ccf2"
        $spSecret = "9VTJSQwzlFepD8XODnzy8n2V01Jd8dAjwm/azF1XDKM="
        $credName = "mycred1"
        $vmName = "myvmname"
        $serviceName = "mycloudservicename"
2. <span data-ttu-id="f58c6-158">Em seguida, a seguir Olá use script tooconfigure e habilite a integração de AKV.</span><span class="sxs-lookup"><span data-stu-id="f58c6-158">Then use hello following script tooconfigure and enable AKV Integration.</span></span>
   
        $secureakv =  $spSecret | ConvertTo-SecureString -AsPlainText -Force
        $akvs = New-AzureVMSqlServerKeyVaultCredentialConfig -Enable -CredentialName $credname -AzureKeyVaultUrl $akvURL -ServicePrincipalName $spName -ServicePrincipalSecret $secureakv
        Get-AzureVM -ServiceName $serviceName -Name $vmName | Set-AzureVMSqlServerExtension -KeyVaultCredentialSettings $akvs | Update-AzureVM

<span data-ttu-id="f58c6-159">Olá extensão do agente SQL IaaS atualizará Olá VM do SQL com essa nova configuração.</span><span class="sxs-lookup"><span data-stu-id="f58c6-159">hello SQL IaaS Agent Extension will update hello SQL VM with this new configuration.</span></span>

[!INCLUDE [AKV Integration Next Steps](../../../../includes/virtual-machines-sql-server-akv-next-steps.md)]

