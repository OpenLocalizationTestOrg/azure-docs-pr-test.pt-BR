---
title: Criar e carregar um VHD Linux no Azure
description: "Saiba como criar e carregar um VHD (disco rígido virtual) do Azure que contenha um sistema operacional Linux."
services: virtual-machines-linux
documentationcenter: 
author: szarkos
manager: timlt
editor: tysonn
tags: azure-resource-manager,azure-service-management
ms.assetid: d351396c-95a0-4092-b7bf-c6aae0bbd112
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.devlang: na
ms.topic: article
ms.date: 02/02/2017
ms.author: szark
ms.openlocfilehash: ccadf55c492c097ef96f25e469dbf36fc87b6102
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/03/2017
---
# <a name="information-for-non-endorsed-distributions"></a><span data-ttu-id="2b137-103">Informações para as distribuições não endossadas</span><span class="sxs-lookup"><span data-stu-id="2b137-103">Information for Non-Endorsed Distributions</span></span>
[!INCLUDE [learn-about-deployment-models](../../../includes/learn-about-deployment-models-both-include.md)]

<span data-ttu-id="2b137-104">O SLA (contrato de nível de serviço) da plataforma do Azure aplica-se a máquinas virtuais com o sistema operacional Linux somente quando uma das [distribuições endossadas](endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) é usada com os detalhes da configuração especificados neste artigo.</span><span class="sxs-lookup"><span data-stu-id="2b137-104">The Azure platform SLA applies to virtual machines running the Linux OS only when one of the [endorsed distributions](endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) is used.</span></span> <span data-ttu-id="2b137-105">Todas as distribuições do Linux fornecidas na galeria de imagens do Azure são distribuições endossadas com a configuração necessária.</span><span class="sxs-lookup"><span data-stu-id="2b137-105">All Linux distributions that are provided in the Azure image gallery are endorsed distributions with the required configuration.</span></span>

* [<span data-ttu-id="2b137-106">Linux no Azure - Distribuições endossadas</span><span class="sxs-lookup"><span data-stu-id="2b137-106">Linux on Azure - Endorsed Distributions</span></span>](endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)
* [<span data-ttu-id="2b137-107">Suporte para imagens Linux no Microsoft Azure</span><span class="sxs-lookup"><span data-stu-id="2b137-107">Support for Linux images in Microsoft Azure</span></span>](https://support.microsoft.com/kb/2941892)

<span data-ttu-id="2b137-108">Todas as distribuições em execução no Azure precisam atender a diversos pré-requisitos para ter a chance de serem executadas corretamente na plataforma.</span><span class="sxs-lookup"><span data-stu-id="2b137-108">All distributions running on Azure will need to meet a number of prerequisites to have a chance to properly run on the platform.</span></span>  <span data-ttu-id="2b137-109">Este artigo não é conclusivo, já que cada distribuição é diferente. Dessa forma, mesmo que você atenda a todos os critérios abaixo, talvez seja necessário ajustar significativamente o seu sistema Linux para garantir que ele seja executado corretamente na plataforma.</span><span class="sxs-lookup"><span data-stu-id="2b137-109">This article is by no means comprehensive as every distribution is different; and it is quite possible that even if you meet all the criteria below you will still need to significantly tweak your Linux system to ensure that it properly runs on the platform.</span></span>

<span data-ttu-id="2b137-110">Por isso, recomendamos que você inicie com uma das nossas [distribuições endossadas do Linux no Azure](endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) sempre que possível.</span><span class="sxs-lookup"><span data-stu-id="2b137-110">It is for this reason that we recommend that you start with one of our [Linux on Azure Endorsed Distributions](endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) when possible.</span></span> <span data-ttu-id="2b137-111">Os artigos a seguir guiam você pela preparação das diversas distribuições endossadas do Linux que têm suporte no Azure:</span><span class="sxs-lookup"><span data-stu-id="2b137-111">The following articles will guide you through how to prepare the various endorsed Linux distributions that are supported on Azure:</span></span>

* <span data-ttu-id="2b137-112">**[Distribuições com base em CentOS](create-upload-centos.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span><span class="sxs-lookup"><span data-stu-id="2b137-112">**[CentOS-based Distributions](create-upload-centos.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span></span>
* <span data-ttu-id="2b137-113">**[Debian Linux](debian-create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span><span class="sxs-lookup"><span data-stu-id="2b137-113">**[Debian Linux](debian-create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span></span>
* <span data-ttu-id="2b137-114">**[Oracle Linux](oracle-create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span><span class="sxs-lookup"><span data-stu-id="2b137-114">**[Oracle Linux](oracle-create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span></span>
* <span data-ttu-id="2b137-115">**[Red Hat Enterprise Linux](redhat-create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span><span class="sxs-lookup"><span data-stu-id="2b137-115">**[Red Hat Enterprise Linux](redhat-create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span></span>
* <span data-ttu-id="2b137-116">**[SLES & openSUSE](suse-create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span><span class="sxs-lookup"><span data-stu-id="2b137-116">**[SLES & openSUSE](suse-create-upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span></span>
* <span data-ttu-id="2b137-117">**[Ubuntu](create-upload-ubuntu.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span><span class="sxs-lookup"><span data-stu-id="2b137-117">**[Ubuntu](create-upload-ubuntu.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**</span></span>

<span data-ttu-id="2b137-118">O restante deste artigo traz orientações gerais para execução da sua distribuição do Linux no Azure.</span><span class="sxs-lookup"><span data-stu-id="2b137-118">The rest of this article will focus on general guidance for running your Linux distribution on Azure.</span></span>

## <a name="general-linux-installation-notes"></a><span data-ttu-id="2b137-119">Notas de instalação gerais do Linux</span><span class="sxs-lookup"><span data-stu-id="2b137-119">General Linux Installation Notes</span></span>
* <span data-ttu-id="2b137-120">O formato VHDX não tem suporte no Azure, somente o **VHD fixo**.</span><span class="sxs-lookup"><span data-stu-id="2b137-120">The VHDX format is not supported in Azure, only **fixed VHD**.</span></span>  <span data-ttu-id="2b137-121">Você pode converter o disco em formato VHD usando o Gerenciador do Hyper-V ou o cmdlet convert-vhd.</span><span class="sxs-lookup"><span data-stu-id="2b137-121">You can convert the disk to VHD format using Hyper-V Manager or the convert-vhd cmdlet.</span></span> <span data-ttu-id="2b137-122">Se você estiver usando o VirtualBox, isso significará selecionar **Tamanho fixo** em vez do padrão alocado dinamicamente durante a criação do disco.</span><span class="sxs-lookup"><span data-stu-id="2b137-122">If you are using VirtualBox this means selecting **Fixed size** as opposed to the default dynamically allocated when creating the disk.</span></span>
* <span data-ttu-id="2b137-123">O Azure oferece suporte somente para máquinas virtuais de geração 1.</span><span class="sxs-lookup"><span data-stu-id="2b137-123">Azure only supports generation 1 virtual machines.</span></span> <span data-ttu-id="2b137-124">Você pode converter uma máquina virtual de geração 1 do formato de arquivo VHDX em VHD e de expansão dinâmica em um disco de tamanho fixo.</span><span class="sxs-lookup"><span data-stu-id="2b137-124">You can convert a generation 1 virtual machine from VHDX to the VHD file format and from dynamically expanding to a fixed sized disk.</span></span> <span data-ttu-id="2b137-125">Mas não é possível alterar a geração de uma máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="2b137-125">But you can't change a virtual machine's generation.</span></span> <span data-ttu-id="2b137-126">Para saber mais, confira [Devo criar uma máquina virtual de geração 1 ou 2 no Hyper-V?](https://technet.microsoft.com/en-us/windows-server-docs/compute/hyper-v/plan/should-i-create-a-generation-1-or-2-virtual-machine-in-hyper-v)</span><span class="sxs-lookup"><span data-stu-id="2b137-126">For more information, see [Should I create a generation 1 or 2 virtual machine in Hyper-V?](https://technet.microsoft.com/en-us/windows-server-docs/compute/hyper-v/plan/should-i-create-a-generation-1-or-2-virtual-machine-in-hyper-v)</span></span>
* <span data-ttu-id="2b137-127">O tamanho máximo permitido para o VHD é 1.023 GB.</span><span class="sxs-lookup"><span data-stu-id="2b137-127">The maximum size allowed for the VHD is 1,023 GB.</span></span>
* <span data-ttu-id="2b137-128">Ao instalar o sistema Linux, é *recomendável* que você use partições padrão em vez de LVM (geralmente o padrão para muitas instalações).</span><span class="sxs-lookup"><span data-stu-id="2b137-128">When installing the Linux system it is *recommended* that you use standard partitions rather than LVM (often the default for many installations).</span></span> <span data-ttu-id="2b137-129">Isso irá evitar conflitos de nome LVM com VMs clonadas, especialmente se um disco do sistema operacional precisar ser anexado a outra VM idêntica para solução de problemas.</span><span class="sxs-lookup"><span data-stu-id="2b137-129">This will avoid LVM name conflicts with cloned VMs, particularly if an OS disk ever needs to be attached to another identical VM for troubleshooting.</span></span> <span data-ttu-id="2b137-130">[LVM](configure-lvm.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) ou [RAID](configure-raid.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) podem ser usados nos discos de dados.</span><span class="sxs-lookup"><span data-stu-id="2b137-130">[LVM](configure-lvm.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) or [RAID](configure-raid.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) may be used on data disks.</span></span>
* <span data-ttu-id="2b137-131">É necessário suporte a kernel para montar sistemas de arquivos UDF.</span><span class="sxs-lookup"><span data-stu-id="2b137-131">Kernel support for mounting UDF file systems is required.</span></span> <span data-ttu-id="2b137-132">Na primeira inicialização no Azure, a configuração de provisionamento é transmitida à VM do Linux por meio de mídia formatada para UDF, a qual é anexada ao convidado.</span><span class="sxs-lookup"><span data-stu-id="2b137-132">At first boot on Azure the provisioning configuration is passed to the Linux VM via UDF-formatted media that is attached to the guest.</span></span> <span data-ttu-id="2b137-133">O agente de Linux do Azure deve ser capaz de montar o sistema de arquivos UDF para ler sua configuração e provisionar a VM.</span><span class="sxs-lookup"><span data-stu-id="2b137-133">The Azure Linux agent must be able to mount the UDF file system to read its configuration and provision the VM.</span></span>
* <span data-ttu-id="2b137-134">Versões de kernel do Linux abaixo de 2.6.37 não dão suporte ao NUMA no Hyper-V com tamanhos maiores de VM.</span><span class="sxs-lookup"><span data-stu-id="2b137-134">Linux kernel versions below 2.6.37 do not support NUMA on Hyper-V with larger VM sizes.</span></span> <span data-ttu-id="2b137-135">Esse problema afeta principalmente distribuições mais antigas usando kernel Red Hat 2.6.32 upstream e foi corrigido no RHEL 6.6 (kernel-2.6.32-504).</span><span class="sxs-lookup"><span data-stu-id="2b137-135">This issue primarily impacts older distributions using the upstream Red Hat 2.6.32 kernel, and was fixed in RHEL 6.6 (kernel-2.6.32-504).</span></span> <span data-ttu-id="2b137-136">Sistemas que executam kernels personalizados anteriores a 2.6.37 ou com base em RHEL anteriores a 2.6.32-504 devem definir o parâmetro de inicialização `numa=off` na linha de comando do kernel em grub.conf.</span><span class="sxs-lookup"><span data-stu-id="2b137-136">Systems running custom kernels older than 2.6.37, or RHEL-based kernels older than 2.6.32-504 must set the boot parameter `numa=off` on the kernel command-line in grub.conf.</span></span> <span data-ttu-id="2b137-137">Para obter mais informações, confira o [KB 436883](https://access.redhat.com/solutions/436883) do Red Hat.</span><span class="sxs-lookup"><span data-stu-id="2b137-137">For more information see Red Hat [KB 436883](https://access.redhat.com/solutions/436883).</span></span>
* <span data-ttu-id="2b137-138">Não configure uma partição de permuta no disco do SO.</span><span class="sxs-lookup"><span data-stu-id="2b137-138">Do not configure a swap partition on the OS disk.</span></span> <span data-ttu-id="2b137-139">O agente Linux pode ser configurado para criar um arquivo de permuta no disco de recursos temporários.</span><span class="sxs-lookup"><span data-stu-id="2b137-139">The Linux agent can be configured to create a swap file on the temporary resource disk.</span></span>  <span data-ttu-id="2b137-140">Verifique as etapas a seguir para obter mais informações a esse respeito.</span><span class="sxs-lookup"><span data-stu-id="2b137-140">More information about this can be found in the steps below.</span></span>
* <span data-ttu-id="2b137-141">Todos os VHDs devem ter tamanhos que sejam múltiplos de 1 MB.</span><span class="sxs-lookup"><span data-stu-id="2b137-141">All of the VHDs must have sizes that are multiples of 1 MB.</span></span>

### <a name="installing-kernel-modules-without-hyper-v"></a><span data-ttu-id="2b137-142">Instalação dos módulos de kernel sem Hyper-V</span><span class="sxs-lookup"><span data-stu-id="2b137-142">Installing kernel modules without Hyper-V</span></span>
<span data-ttu-id="2b137-143">O Azure é executado no hipervisor Hyper-V, de modo que o Linux requer que determinados módulos de kernel estejam instalados para executar no Azure.</span><span class="sxs-lookup"><span data-stu-id="2b137-143">Azure runs on the Hyper-V hypervisor, so Linux requires that certain kernel modules are installed in order to run in Azure.</span></span> <span data-ttu-id="2b137-144">Se você tem uma VM que foi criada fora do Hyper-V, os instaladores do Linux não incluem os drivers Hyper-V no ramdisk inicial (initrd ou initramfs), a menos que ele detecte que está executando um ambiente Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="2b137-144">If you have a VM that was created outside of Hyper-V, the Linux installers may not include the drivers for Hyper-V in the initial ramdisk (initrd or initramfs) unless it detects that it is running an a Hyper-V environment.</span></span> <span data-ttu-id="2b137-145">Ao usar um sistema de virtualização diferente (ou seja, Virtualbox, KVM, etc.) para preparar a imagem do Linux, talvez seja necessário recompilar o initrd para garantir que pelo menos os módulos kernel `hv_vmbus` e `hv_storvsc` estejam disponíveis no ramdisk inicial.</span><span class="sxs-lookup"><span data-stu-id="2b137-145">When using a different virtualization system (i.e. Virtualbox, KVM, etc.) to prepare your Linux image, you may need to rebuild the initrd to ensure that at least the `hv_vmbus` and `hv_storvsc` kernel modules are available on the initial ramdisk.</span></span>  <span data-ttu-id="2b137-146">Isso é um problema conhecido pelo menos em sistemas com base na distribuição Red Hat upstream.</span><span class="sxs-lookup"><span data-stu-id="2b137-146">This is a known issue at least on systems based on the upstream Red Hat distribution.</span></span>

<span data-ttu-id="2b137-147">O mecanismo para recriar a imagem initrd ou initramfs pode variar dependendo da distribuição.</span><span class="sxs-lookup"><span data-stu-id="2b137-147">The mechanism for rebuilding the initrd or initramfs image may vary depending on the distribution.</span></span> <span data-ttu-id="2b137-148">Consulte a documentação da distribuição ou suporte para o procedimento adequado.</span><span class="sxs-lookup"><span data-stu-id="2b137-148">Please consult your distribution's documentation or support for the proper procedure.</span></span>  <span data-ttu-id="2b137-149">Aqui está um exemplo de como recompilar o initrd usando o utilitário `mkinitrd` :</span><span class="sxs-lookup"><span data-stu-id="2b137-149">Here is one example for how to rebuild the initrd using the `mkinitrd` utility:</span></span>

<span data-ttu-id="2b137-150">Primeiro, faça backup da imagem initrd existente:</span><span class="sxs-lookup"><span data-stu-id="2b137-150">First, back up the existing initrd image:</span></span>

    # cd /boot
    # sudo cp initrd-`uname -r`.img  initrd-`uname -r`.img.bak

<span data-ttu-id="2b137-151">Em seguida, recompile o initrd com os módulos kernel `hv_vmbus` e `hv_storvsc`:</span><span class="sxs-lookup"><span data-stu-id="2b137-151">Next, rebuild the initrd with the `hv_vmbus` and `hv_storvsc` kernel modules:</span></span>

    # sudo mkinitrd --preload=hv_storvsc --preload=hv_vmbus -v -f initrd-`uname -r`.img `uname -r`


### <a name="resizing-vhds"></a><span data-ttu-id="2b137-152">Redimensionando VHDs</span><span class="sxs-lookup"><span data-stu-id="2b137-152">Resizing VHDs</span></span>
<span data-ttu-id="2b137-153">As imagens de VHD no Azure devem ter um tamanho virtual alinhado para 1MB.</span><span class="sxs-lookup"><span data-stu-id="2b137-153">VHD images on Azure must have a virtual size aligned to 1MB.</span></span>  <span data-ttu-id="2b137-154">Normalmente, os VHDs criados usando o Hyper-V já foram alinhados corretamente.</span><span class="sxs-lookup"><span data-stu-id="2b137-154">Typically, VHDs created using Hyper-V should already be aligned correctly.</span></span>  <span data-ttu-id="2b137-155">Se o VHD não estiver alinhado corretamente, você receberá uma mensagem de erro semelhante à seguinte quando tentar criar uma *imagem* de seu VHD:</span><span class="sxs-lookup"><span data-stu-id="2b137-155">If the VHD is not aligned correctly then you may receive an error message similar to the following when you attempt to create an *image* from your VHD:</span></span>

    "The VHD http://<mystorageaccount>.blob.core.windows.net/vhds/MyLinuxVM.vhd has an unsupported virtual size of 21475270656 bytes. The size must be a whole number (in MBs).”

<span data-ttu-id="2b137-156">Para corrigir isso, você pode redimensionar a VM usando o console do Gerenciador do Hyper-V ou o cmdlet do Powershell [Resize-VHD](http://technet.microsoft.com/library/hh848535.aspx) .</span><span class="sxs-lookup"><span data-stu-id="2b137-156">To remedy this you can resize the VM using either the Hyper-V Manager console or the [Resize-VHD](http://technet.microsoft.com/library/hh848535.aspx) Powershell cmdlet.</span></span>  <span data-ttu-id="2b137-157">Se você não estiver executando em um ambiente Windows, então é recomendável usar qemu-img para converter (se necessário) e redimensionar o VHD.</span><span class="sxs-lookup"><span data-stu-id="2b137-157">If you are not running in a Windows environment then it is recommended to use qemu-img to convert (if needed) and resize the VHD.</span></span>

> [!NOTE]
> <span data-ttu-id="2b137-158">Há um bug conhecido nas versões qemu-img > = 2.2.1 que resulta em um VHD formatado incorretamente.</span><span class="sxs-lookup"><span data-stu-id="2b137-158">There is a known bug in qemu-img versions >=2.2.1 that results in an improperly formatted VHD.</span></span> <span data-ttu-id="2b137-159">O problema foi corrigido na versão QEMU 2.6.</span><span class="sxs-lookup"><span data-stu-id="2b137-159">The issue has been fixed in QEMU 2.6.</span></span> <span data-ttu-id="2b137-160">É recomendável usar o qemu-img 2.2.0 ou inferior, ou atualizar para a versão 2.6 ou posterior.</span><span class="sxs-lookup"><span data-stu-id="2b137-160">It is recommended to use either qemu-img 2.2.0 or lower, or update to 2.6 or higher.</span></span> <span data-ttu-id="2b137-161">Referência: https://bugs.launchpad.net/qemu/+bug/1490611.</span><span class="sxs-lookup"><span data-stu-id="2b137-161">Reference: https://bugs.launchpad.net/qemu/+bug/1490611.</span></span>
> 
> 

1. <span data-ttu-id="2b137-162">Redimensionar o VHD diretamente, usando ferramentas como `qemu-img` ou `vbox-manage` pode resultar em um VHD incapaz de ser inicializado.</span><span class="sxs-lookup"><span data-stu-id="2b137-162">Resizing the VHD directly using tools such as `qemu-img` or `vbox-manage` may result in an unbootable VHD.</span></span>  <span data-ttu-id="2b137-163">Então convém primeiro converter o VHD para uma imagem de disco bruta.</span><span class="sxs-lookup"><span data-stu-id="2b137-163">So it is recommended to first convert the VHD to a RAW disk image.</span></span>  <span data-ttu-id="2b137-164">Se a imagem VM já foi criada como imagem de disco bruta (o padrão para alguns Hypervisors como KVM), você pode ignorar esta etapa:</span><span class="sxs-lookup"><span data-stu-id="2b137-164">If the VM image was already created as RAW disk image (the default for some Hypervisors such as KVM) then you may skip this step:</span></span>
   
       # qemu-img convert -f vpc -O raw MyLinuxVM.vhd MyLinuxVM.raw

2. <span data-ttu-id="2b137-165">Calcule o tamanho necessário da imagem do disco para garantir que o tamanho virtual esteja alinhado para 1MB.</span><span class="sxs-lookup"><span data-stu-id="2b137-165">Calculate the required size of the disk image to ensure that the virtual size is aligned to 1MB.</span></span>  <span data-ttu-id="2b137-166">O seguinte script de bash shell pode ajudar com isso.</span><span class="sxs-lookup"><span data-stu-id="2b137-166">The following bash shell script can assist with this.</span></span>  <span data-ttu-id="2b137-167">O script usa "`qemu-img info`" para determinar o tamanho virtual da imagem do disco e, em seguida, calcula o tamanho para o próximo 1 MB:</span><span class="sxs-lookup"><span data-stu-id="2b137-167">The script uses "`qemu-img info`" to determine the virtual size of the disk image and then calculates the size to the next 1MB:</span></span>
   
       rawdisk="MyLinuxVM.raw"
       vhddisk="MyLinuxVM.vhd"
   
       MB=$((1024*1024))
       size=$(qemu-img info -f raw --output json "$rawdisk" | \
              gawk 'match($0, /"virtual-size": ([0-9]+),/, val) {print val[1]}')
   
       rounded_size=$((($size/$MB + 1)*$MB))
       echo "Rounded Size = $rounded_size"

3. <span data-ttu-id="2b137-168">Redimensione o disco bruto usando $rounded_size conforme definido no script acima:</span><span class="sxs-lookup"><span data-stu-id="2b137-168">Resize the raw disk using $rounded_size as set in the above script:</span></span>
   
       # qemu-img resize MyLinuxVM.raw $rounded_size

4. <span data-ttu-id="2b137-169">Agora, converta o disco bruto em um VHD de tamanho fixo:</span><span class="sxs-lookup"><span data-stu-id="2b137-169">Now, convert the RAW disk back to a fixed-size VHD:</span></span>
   
       # qemu-img convert -f raw -o subformat=fixed -O vpc MyLinuxVM.raw MyLinuxVM.vhd

   <span data-ttu-id="2b137-170">Ou então, com a versão de qemu **2.6 ou superior**, inclui a opção `force_size`:</span><span class="sxs-lookup"><span data-stu-id="2b137-170">Or, with qemu version **2.6+** include the `force_size` option:</span></span>

       # qemu-img convert -f raw -o subformat=fixed,force_size -O vpc MyLinuxVM.raw MyLinuxVM.vhd

## <a name="linux-kernel-requirements"></a><span data-ttu-id="2b137-171">Requisitos do kernel do Linux</span><span class="sxs-lookup"><span data-stu-id="2b137-171">Linux Kernel Requirements</span></span>
<span data-ttu-id="2b137-172">Os drivers LIS (Serviços de Integração do Linux) para Hyper-V e Azure são obtidos diretamente no kernel upstream do Linux.</span><span class="sxs-lookup"><span data-stu-id="2b137-172">The Linux Integration Services (LIS) drivers for Hyper-V and Azure are contributed directly to the upstream Linux kernel.</span></span> <span data-ttu-id="2b137-173">Muitas distribuições que contam com uma versão recente do kernel do Linux (por exemplo, versões 3.x) já terão esses drivers ou fornecerão versões revertidas desses drivers com seus kernels.</span><span class="sxs-lookup"><span data-stu-id="2b137-173">Many distributions that include a recent Linux kernel version (i.e. 3.x) will have these drivers available already, or otherwise provide backported versions of these drivers with their kernels.</span></span>  <span data-ttu-id="2b137-174">Os drivers são atualizados constantemente no kernel upstream com reparos e recursos. Por isso, recomendamos que você execute, sempre que possível, uma [distribuição endossada](endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) que inclua esses reparos e essas atualizações.</span><span class="sxs-lookup"><span data-stu-id="2b137-174">These drivers are constantly being updated in the upstream kernel with new fixes and features, so when possible it is recommended to run an [endorsed distribution](endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) that will include these fixes and updates.</span></span>

<span data-ttu-id="2b137-175">Se você estiver executando uma variante das versões **de 6.0 a 6.3** do Red Hat Enterprise Linux, será necessário instalar os drivers LIS mais recentes para o Hyper-V.</span><span class="sxs-lookup"><span data-stu-id="2b137-175">If you are running a variant of Red Hat Enterprise Linux versions **6.0-6.3**, then you will need to install the latest LIS drivers for Hyper-V.</span></span> <span data-ttu-id="2b137-176">Os drivers LIS com o kernel já estão incluídos nas versões [6.4 e posteriores](http://go.microsoft.com/fwlink/p/?LinkID=254263&clcid=0x409)do RHEL (e derivados).</span><span class="sxs-lookup"><span data-stu-id="2b137-176">The drivers can be found [at this location](http://go.microsoft.com/fwlink/p/?LinkID=254263&clcid=0x409).</span></span> <span data-ttu-id="2b137-177">Os drivers LIS com o kernel já estão incluídos nas versões **6.4 e posteriores** do RHEL (e derivados). Por isso, não é necessário ter outros pacotes de instalação para executar esses sistemas no Azure.</span><span class="sxs-lookup"><span data-stu-id="2b137-177">As of RHEL **6.4+** (and derivatives) the LIS drivers are already included with the kernel and so no additional installation packages are needed to run those systems on Azure.</span></span>

<span data-ttu-id="2b137-178">Se for necessário usar um kernel personalizado, recomendamos que você use uma versão mais recente ( **3.8 ou posterior**).</span><span class="sxs-lookup"><span data-stu-id="2b137-178">If a custom kernel is required, it is recommended to use a more recent kernel version (i.e. **3.8+**).</span></span> <span data-ttu-id="2b137-179">No caso das distribuições ou dos fornecedores que mantêm seus próprios kernels, será necessário um pouco de esforço para a reversão dos drivers LIS do kernel upstream para seu kernel personalizado.</span><span class="sxs-lookup"><span data-stu-id="2b137-179">For those distributions or vendors who maintain their own kernel, some effort will be required to regularly backport the LIS drivers from the upstream kernel to your custom kernel.</span></span>  <span data-ttu-id="2b137-180">Recomendamos que você acompanhe os reparos upstream nos drivers LIS e faça as reversões necessárias, mesmo se estiver executando uma versão relativamente recente do kernel.</span><span class="sxs-lookup"><span data-stu-id="2b137-180">Even if you are already running a relatively recent kernel version, it is highly recommended to keep track of any upstream fixes in the LIS drivers and backport those as needed.</span></span> <span data-ttu-id="2b137-181">A localização dos arquivos de origem do driver do LIS consta no arquivo [MAINTAINERS](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/MAINTAINERS) , na árvore do kernel do Linux:</span><span class="sxs-lookup"><span data-stu-id="2b137-181">The location of the LIS driver source files is available in the [MAINTAINERS](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/MAINTAINERS) file in the Linux kernel source tree:</span></span>

    F:    arch/x86/include/asm/mshyperv.h
    F:    arch/x86/include/uapi/asm/hyperv.h
    F:    arch/x86/kernel/cpu/mshyperv.c
    F:    drivers/hid/hid-hyperv.c
    F:    drivers/hv/
    F:    drivers/input/serio/hyperv-keyboard.c
    F:    drivers/net/hyperv/
    F:    drivers/scsi/storvsc_drv.c
    F:    drivers/video/fbdev/hyperv_fb.c
    F:    include/linux/hyperv.h
    F:    tools/hv/

<span data-ttu-id="2b137-182">Sabemos que a ausência dos patches a seguir resulta em problemas no Azure. Por isso, eles devem constar no kernel.</span><span class="sxs-lookup"><span data-stu-id="2b137-182">At a very minimum, the absence of the following patches have been known to cause problems on Azure and so these must be included in the kernel.</span></span> <span data-ttu-id="2b137-183">De forma alguma essa lista pode ser considerada completa para todas as distribuições:</span><span class="sxs-lookup"><span data-stu-id="2b137-183">This list is by no means exhaustive or complete for all distributions:</span></span>

* [<span data-ttu-id="2b137-184">ata_piix: adie os discos para os drivers Hyper-V por padrão</span><span class="sxs-lookup"><span data-stu-id="2b137-184">ata_piix: defer disks to the Hyper-V drivers by default</span></span>](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/drivers/ata/ata_piix.c?id=cd006086fa5d91414d8ff9ff2b78fbb593878e3c)
* [<span data-ttu-id="2b137-185">storvsc: conta para pacotes em trânsito no caminho RESET</span><span class="sxs-lookup"><span data-stu-id="2b137-185">storvsc: Account for in-transit packets in the RESET path</span></span>](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/drivers/scsi/storvsc_drv.c?id=5c1b10ab7f93d24f29b5630286e323d1c5802d5c)
* [<span data-ttu-id="2b137-186">storvsc: evite o uso de WRITE_SAME</span><span class="sxs-lookup"><span data-stu-id="2b137-186">storvsc: avoid usage of WRITE_SAME</span></span>](https://git.kernel.org/cgit/linux/kernel/git/next/linux-next.git/commit/drivers/scsi/storvsc_drv.c?id=3e8f4f4065901c8dfc51407e1984495e1748c090)
* [<span data-ttu-id="2b137-187">storvsc: desabilite WRITE SAME para RAID e drivers do adaptador de host virtual</span><span class="sxs-lookup"><span data-stu-id="2b137-187">storvsc: Disable WRITE SAME for RAID and virtual host adapter drivers</span></span>](https://git.kernel.org/cgit/linux/kernel/git/next/linux-next.git/commit/drivers/scsi/storvsc_drv.c?id=54b2b50c20a61b51199bedb6e5d2f8ec2568fb43)
* [<span data-ttu-id="2b137-188">storvsc: correção de desreferência de ponteiro NULL</span><span class="sxs-lookup"><span data-stu-id="2b137-188">storvsc: NULL pointer dereference fix</span></span>](https://git.kernel.org/cgit/linux/kernel/git/next/linux-next.git/commit/drivers/scsi/storvsc_drv.c?id=b12bb60d6c350b348a4e1460cd68f97ccae9822e)
* [<span data-ttu-id="2b137-189">storvsc: as falhas do buffer de anéis podem resultar em congelamento de E/S</span><span class="sxs-lookup"><span data-stu-id="2b137-189">storvsc: ring buffer failures may result in I/O freeze</span></span>](https://git.kernel.org/cgit/linux/kernel/git/next/linux-next.git/commit/drivers/scsi/storvsc_drv.c?id=e86fb5e8ab95f10ec5f2e9430119d5d35020c951)
* [<span data-ttu-id="2b137-190">scsi_sysfs: proteger contra a execução dupla de __scsi_remove_device</span><span class="sxs-lookup"><span data-stu-id="2b137-190">scsi_sysfs: protect against double execution of __scsi_remove_device</span></span>](https://git.kernel.org/cgit/linux/kernel/git/next/linux-next.git/commit/drivers/scsi/scsi_sysfs.c?id=be821fd8e62765de43cc4f0e2db363d0e30a7e9b)

## <a name="the-azure-linux-agent"></a><span data-ttu-id="2b137-191">O agente Linux do Azure</span><span class="sxs-lookup"><span data-stu-id="2b137-191">The Azure Linux Agent</span></span>
<span data-ttu-id="2b137-192">O [agente Linux do Azure](../windows/agent-user-guide.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) (waagent) é necessário para garantir o provisionamento correto da máquina virtual Linux no Azure.</span><span class="sxs-lookup"><span data-stu-id="2b137-192">The [Azure Linux Agent](../windows/agent-user-guide.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) (waagent) is required to properly provision a Linux virtual machine in Azure.</span></span> <span data-ttu-id="2b137-193">Você pode obter a versão mais recente, verificar os problemas com arquivos ou enviar solicitações pull no [repositório GitHub do agente Linux](https://github.com/Azure/WALinuxAgent).</span><span class="sxs-lookup"><span data-stu-id="2b137-193">You can get the latest version, file issues or submit pull requests at the [Linux Agent GitHub repo](https://github.com/Azure/WALinuxAgent).</span></span>

* <span data-ttu-id="2b137-194">O agente Linux consta na licença do Apache 2.0.</span><span class="sxs-lookup"><span data-stu-id="2b137-194">The Linux agent is released under the Apache 2.0 license.</span></span> <span data-ttu-id="2b137-195">Diversas distribuições já fornecem pacotes RPM ou DEB para o agente. Assim, em alguns casos, é possível instalá-los e atualizá-los sem dificuldades.</span><span class="sxs-lookup"><span data-stu-id="2b137-195">Many distributions already provide RPM or deb packages for the agent, and so in some cases this can be installed and updated with little effort.</span></span>
* <span data-ttu-id="2b137-196">O agente Linux do Azure requer Python v2.6+.</span><span class="sxs-lookup"><span data-stu-id="2b137-196">The Azure Linux Agent requires Python v2.6+.</span></span>
* <span data-ttu-id="2b137-197">Além disso, o agente requer o módulo python-pyasn1.</span><span class="sxs-lookup"><span data-stu-id="2b137-197">The agent also requires the python-pyasn1 module.</span></span> <span data-ttu-id="2b137-198">A maioria das distribuições fornece esse módulo como uma pacote autônomo instalável.</span><span class="sxs-lookup"><span data-stu-id="2b137-198">Most distributions provide this as a separate package that can be installed.</span></span>
* <span data-ttu-id="2b137-199">Em alguns casos, é possível que o agente Linux do Azure não seja compatível com o NetworkManager.</span><span class="sxs-lookup"><span data-stu-id="2b137-199">In some cases the Azure Linux Agent may not be compatible with NetworkManager.</span></span> <span data-ttu-id="2b137-200">Muitos pacotes RPM/DEB fornecidos pelas distribuições configuram o NetworkManager como um conflito para o pacote do waagent e, portanto, desinstalam o NetworkManager quando você instala o pacote do agente Linux.</span><span class="sxs-lookup"><span data-stu-id="2b137-200">Many of the RPM/Deb packages provided by distributions configure NetworkManager as a conflict to the waagent package, and thus will uninstall NetworkManager when you install the Linux agent package.</span></span>

## <a name="general-linux-system-requirements"></a><span data-ttu-id="2b137-201">Requisitos gerais do sistema Linux</span><span class="sxs-lookup"><span data-stu-id="2b137-201">General Linux System Requirements</span></span>

* <span data-ttu-id="2b137-202">Modifique a linha de inicialização do kernel no GRUB ou GRUB2 para incluir os parâmetros a seguir.</span><span class="sxs-lookup"><span data-stu-id="2b137-202">Modify the kernel boot line in GRUB or GRUB2 to include the following parameters.</span></span> <span data-ttu-id="2b137-203">Isso garantirá que todas as mensagens do console sejam enviadas para a primeira porta serial, que pode auxiliar o suporte do Azure com problemas de depuração:</span><span class="sxs-lookup"><span data-stu-id="2b137-203">This will also ensure all console messages are sent to the first serial port, which can assist Azure support with debugging issues:</span></span>
  
        console=ttyS0,115200n8 earlyprintk=ttyS0,115200 rootdelay=300
  
    <span data-ttu-id="2b137-204">Isso garantirá que todas as mensagens do console sejam enviadas para a primeira porta serial, que pode auxiliar o suporte do Azure com problemas de depuração.</span><span class="sxs-lookup"><span data-stu-id="2b137-204">This will also ensure all console messages are sent to the first serial port, which can assist Azure support with debugging issues.</span></span>
  
    <span data-ttu-id="2b137-205">Além disso, recomendamos que você *remova* os seguintes parâmetros, se eles existirem:</span><span class="sxs-lookup"><span data-stu-id="2b137-205">In addition to the above, it is recommended to *remove* the following parameters if they exist:</span></span>
  
        rhgb quiet crashkernel=auto
  
    <span data-ttu-id="2b137-206">As inicializações gráfica e silenciosa não são úteis em ambientes de rede, quando queremos que todos os logs sejam enviados para a porta serial.</span><span class="sxs-lookup"><span data-stu-id="2b137-206">Graphical and quiet boot are not useful in a cloud environment where we want all the logs to be sent to the serial port.</span></span> <span data-ttu-id="2b137-207">Você pode deixar configurada a opção `crashkernel` , mas esse parâmetro reduz a memória disponível na máquina virtual em 128 MB ou mais, o que pode ser um problema em máquinas virtuais menores.</span><span class="sxs-lookup"><span data-stu-id="2b137-207">The `crashkernel` option may be left configured if desired, but note that this parameter will reduce the amount of available memory in the VM by 128MB or more, which may be problematic on the smaller VM sizes.</span></span>

* <span data-ttu-id="2b137-208">Instalando o agente Linux do Azure</span><span class="sxs-lookup"><span data-stu-id="2b137-208">Installing the Azure Linux Agent</span></span>
  
    <span data-ttu-id="2b137-209">O agente Linux do Azure é necessário para garantir o provisionamento de uma imagem Linux no Azure.</span><span class="sxs-lookup"><span data-stu-id="2b137-209">The Azure Linux Agent is required for provisioning a Linux image on Azure.</span></span>  <span data-ttu-id="2b137-210">Muitas distribuições fornecem o agente como um pacote RPM ou DEB (o pacote geralmente recebe o nome de "WALinuxAgent" ou "walinuxagent").</span><span class="sxs-lookup"><span data-stu-id="2b137-210">Many distributions provide the agent as an RPM or Deb package (the package is typically called 'WALinuxAgent' or 'walinuxagent').</span></span>  <span data-ttu-id="2b137-211">Você também pode seguir as etapas descritas no [Guia do agente Linux](../windows/agent-user-guide.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)para instalar o agente manualmente.</span><span class="sxs-lookup"><span data-stu-id="2b137-211">The agent can also be installed manually by following the steps in the [Linux Agent Guide](../windows/agent-user-guide.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span></span>

* <span data-ttu-id="2b137-212">Confira se o servidor SSH está instalado e configurado para iniciar no tempo de inicialização.</span><span class="sxs-lookup"><span data-stu-id="2b137-212">Ensure that the SSH server is installed and configured to start at boot time.</span></span>  <span data-ttu-id="2b137-213">Geralmente, esse é o padrão.</span><span class="sxs-lookup"><span data-stu-id="2b137-213">This is usually the default.</span></span>

* <span data-ttu-id="2b137-214">Não crie espaço swap no disco do sistema operacional</span><span class="sxs-lookup"><span data-stu-id="2b137-214">Do not create swap space on the OS disk</span></span>
  
    <span data-ttu-id="2b137-215">O Agente Linux do Azure pode configurar automaticamente o espaço de permuta usando o disco de recurso local que é anexado à VM após o provisionamento no Azure.</span><span class="sxs-lookup"><span data-stu-id="2b137-215">The Azure Linux Agent can automatically configure swap space using the local resource disk that is attached to the VM after provisioning on Azure.</span></span> <span data-ttu-id="2b137-216">Observe que o disco de recurso local é um disco *temporário* e pode ser esvaziado quando a VM é desprovisionada.</span><span class="sxs-lookup"><span data-stu-id="2b137-216">Note that the local resource disk is a *temporary* disk, and might be emptied when the VM is deprovisioned.</span></span> <span data-ttu-id="2b137-217">Depois de instalar o Agente Linux do Azure (consulte a etapa anterior), modifique os seguintes parâmetros em /etc/waagent.conf de maneira apropriada:</span><span class="sxs-lookup"><span data-stu-id="2b137-217">After installing the Azure Linux Agent (see previous step), modify the following parameters in /etc/waagent.conf appropriately:</span></span>
  
        ResourceDisk.Format=y
        ResourceDisk.Filesystem=ext4
        ResourceDisk.MountPoint=/mnt/resource
        ResourceDisk.EnableSwap=y
        ResourceDisk.SwapSizeMB=2048    ## NOTE: set this to whatever you need it to be.

* <span data-ttu-id="2b137-218">Por fim, execute os comandos a seguir para desprovisionar a máquina virtual:</span><span class="sxs-lookup"><span data-stu-id="2b137-218">As a final step, run the following commands to deprovision the virtual machine:</span></span>
  
        # sudo waagent -force -deprovision
        # export HISTSIZE=0
        # logout
  
  > [!NOTE]
  > <span data-ttu-id="2b137-219">No Virtualbox, você pode ver o seguinte erro após executar 'waagent -force -deprovision': `[Errno 5] Input/output error`.</span><span class="sxs-lookup"><span data-stu-id="2b137-219">On Virtualbox you may see the following error after running 'waagent -force -deprovision': `[Errno 5] Input/output error`.</span></span> <span data-ttu-id="2b137-220">Essa mensagem de erro não é crítica e pode ser ignorada.</span><span class="sxs-lookup"><span data-stu-id="2b137-220">This error message is not critical and can be ignored.</span></span>
  > 
  > 

* <span data-ttu-id="2b137-221">Em seguida, você deverá desligar a máquina virtual e carregar o VHD no Azure.</span><span class="sxs-lookup"><span data-stu-id="2b137-221">You will then need to shut down the virtual machine and upload the VHD to Azure.</span></span>

