## <a name="prepare-for-akv-integration"></a><span data-ttu-id="602f5-101">Preparar-se para a integração de AKV</span><span class="sxs-lookup"><span data-stu-id="602f5-101">Prepare for AKV Integration</span></span>
<span data-ttu-id="602f5-102">Para usar a integração do Cofre da Chave do Azure e configurar a VM do SQL Server, há vários pré-requisitos:</span><span class="sxs-lookup"><span data-stu-id="602f5-102">To use Azure Key Vault Integration to configure your SQL Server VM, there are several prerequisites:</span></span> 

1. [<span data-ttu-id="602f5-103">Instalar o Azure Powershell</span><span class="sxs-lookup"><span data-stu-id="602f5-103">Install Azure Powershell</span></span>](#install-azure-powershell)
2. [<span data-ttu-id="602f5-104">Criar um Active Directory do Azure</span><span class="sxs-lookup"><span data-stu-id="602f5-104">Create an Azure Active Directory</span></span>](#create-an-azure-active-directory)
3. [<span data-ttu-id="602f5-105">Criar um cofre de chave</span><span class="sxs-lookup"><span data-stu-id="602f5-105">Create a key vault</span></span>](#create-a-key-vault)

<span data-ttu-id="602f5-106">As seções a seguir descrevem esses pré-requisitos e as informações que você precisa coletar para executar posteriormente os cmdlets do PowerShell.</span><span class="sxs-lookup"><span data-stu-id="602f5-106">The following sections describe these prerequisites and the information you need to collect to later run the PowerShell cmdlets.</span></span>

### <a name="install-azure-powershell"></a><span data-ttu-id="602f5-107">Instalar o Azure Powershell</span><span class="sxs-lookup"><span data-stu-id="602f5-107">Install Azure PowerShell</span></span>
<span data-ttu-id="602f5-108">Verifique se você instalou o SDK mais recente do Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="602f5-108">Make sure you have installed the latest Azure PowerShell SDK.</span></span> <span data-ttu-id="602f5-109">Para saber mais, consulte [Como instalar e configurar o Azure PowerShell](/powershell/azureps-cmdlets-docs):</span><span class="sxs-lookup"><span data-stu-id="602f5-109">For more information, see [How to install and configure Azure PowerShell](/powershell/azureps-cmdlets-docs).</span></span>

### <a name="create-an-azure-active-directory"></a><span data-ttu-id="602f5-110">Criar um Active Directory do Azure</span><span class="sxs-lookup"><span data-stu-id="602f5-110">Create an Azure Active Directory</span></span>
<span data-ttu-id="602f5-111">Primeiro, você precisa ter um [Active Directory do Azure](https://azure.microsoft.com/trial/get-started-active-directory/) (AAD) em sua assinatura.</span><span class="sxs-lookup"><span data-stu-id="602f5-111">First, you need to have an [Azure Active Directory](https://azure.microsoft.com/trial/get-started-active-directory/) (AAD) in your subscription.</span></span> <span data-ttu-id="602f5-112">Entre os diversos benefícios, isso permite que você conceda permissão de acesso ao seu cofre de chave para determinados usuários e aplicativos.</span><span class="sxs-lookup"><span data-stu-id="602f5-112">Among many benefits, this allows you to grant permission to your key vault for certain users and applications.</span></span>

<span data-ttu-id="602f5-113">Em seguida, registre um aplicativo com o AAD</span><span class="sxs-lookup"><span data-stu-id="602f5-113">Next, register an application with AAD.</span></span> <span data-ttu-id="602f5-114">Isso lhe dará uma conta de Entidade de Serviço com acesso ao cofre de chave de que sua máquina virtual precisará.</span><span class="sxs-lookup"><span data-stu-id="602f5-114">This will give you a Service Principal account that has access to your key vault which your VM will need.</span></span> <span data-ttu-id="602f5-115">No artigo Cofre de Chaves do Azure, você pode encontrar estas etapas na seção [Registrar um aplicativo com o Azure Active Directory](../articles/key-vault/key-vault-get-started.md#register), ou pode ver as etapas com capturas de tela na seção **Obter uma identidade para o aplicativo** desta [ostagem de blog](http://blogs.technet.com/b/kv/archive/2015/01/09/azure-key-vault-step-by-step.aspx).</span><span class="sxs-lookup"><span data-stu-id="602f5-115">In the Azure Key Vault article, you can find these steps in the [Register an application with Azure Active Directory](../articles/key-vault/key-vault-get-started.md#register) section, or you can see the steps with screen shots in the **Get an identity for the application section** of [this blog post](http://blogs.technet.com/b/kv/archive/2015/01/09/azure-key-vault-step-by-step.aspx).</span></span> <span data-ttu-id="602f5-116">Antes de concluir essas etapas, observe que você precisa coletar as seguintes informações durante esse registro e que  serão necessárias mais tarde, quando você habilitar a integração da Chave do Cofre do Azure em sua VM do SQL.</span><span class="sxs-lookup"><span data-stu-id="602f5-116">Before completing these steps, note that you need to collect the following information during this registration that is needed later when you enable Azure Key Vault Integration on your SQL VM.</span></span>

* <span data-ttu-id="602f5-117">Após a adição do aplicativo, encontre a **ID do CLIENTE** na guia **CONFIGURAR**.</span><span class="sxs-lookup"><span data-stu-id="602f5-117">After the application is added, find the **CLIENT ID**  on the **CONFIGURE** tab.</span></span> 
    <span data-ttu-id="602f5-118">![ID de cliente do Azure Active Directory](./media/virtual-machines-sql-server-akv-prepare/aad-client-id.png)</span><span class="sxs-lookup"><span data-stu-id="602f5-118">![Azure Active Directory Client ID](./media/virtual-machines-sql-server-akv-prepare/aad-client-id.png)</span></span>
  
    <span data-ttu-id="602f5-119">A ID do cliente é atribuída posteriormente ao parâmetro **$spName** (nome da Entidade de Serviço) no script do PowerShell a fim de habilitar a integração do Cofre da Chave do Azure.</span><span class="sxs-lookup"><span data-stu-id="602f5-119">The client ID is assigned later to the **$spName** (Service Principal name) parameter in the PowerShell script to enable Azure Key Vault Integration.</span></span> 
* <span data-ttu-id="602f5-120">Além disso, durante essas etapas, ao criar a chave, copie o segredo de sua chave conforme mostra a seguinte captura de tela.</span><span class="sxs-lookup"><span data-stu-id="602f5-120">Also, during these steps when you create your key, copy the secret for your key as is shown in the following screenshot.</span></span> <span data-ttu-id="602f5-121">Esse segredo é atribuído posteriormente ao parâmetro **$spSecret** (segredo da Entidade de serviço) no script do PowerShell.</span><span class="sxs-lookup"><span data-stu-id="602f5-121">This key secret is assigned later to the **$spSecret** (Service Principal secret) parameter in the PowerShell script.</span></span>  
    <span data-ttu-id="602f5-122">![Segredo do Azure Active Directory](./media/virtual-machines-sql-server-akv-prepare/aad-sp-secret.png)</span><span class="sxs-lookup"><span data-stu-id="602f5-122">![Azure Active Directory Secret](./media/virtual-machines-sql-server-akv-prepare/aad-sp-secret.png)</span></span>
* <span data-ttu-id="602f5-123">Você deve autorizar essa nova ID de cliente para ter as seguintes permissões de acesso: **encrypt**, **decrypt**, **wrapKey**, **unwrapKey**, **sign** e **verify**.</span><span class="sxs-lookup"><span data-stu-id="602f5-123">You must authorize this new client ID to have the following access permissions: **encrypt**, **decrypt**, **wrapKey**, **unwrapKey**, **sign**, and **verify**.</span></span> <span data-ttu-id="602f5-124">Isso é feito com o cmdlet [Set-AzureRmKeyVaultAccessPolicy](https://msdn.microsoft.com/library/azure/mt603625.aspx) .</span><span class="sxs-lookup"><span data-stu-id="602f5-124">This is done with the [Set-AzureRmKeyVaultAccessPolicy](https://msdn.microsoft.com/library/azure/mt603625.aspx) cmdlet.</span></span> <span data-ttu-id="602f5-125">Para saber mais, consulte [Autorizar o aplicativo a usar a chave ou o segredo](../articles/key-vault/key-vault-get-started.md#authorize).</span><span class="sxs-lookup"><span data-stu-id="602f5-125">For more information see [Authorize the application to use the key or secret](../articles/key-vault/key-vault-get-started.md#authorize).</span></span>

### <a name="create-a-key-vault"></a><span data-ttu-id="602f5-126">Criar um cofre de chave</span><span class="sxs-lookup"><span data-stu-id="602f5-126">Create a key vault</span></span>
<span data-ttu-id="602f5-127">Para usar o Cofre da Chave do Azure a fim de armazenar as chaves que você usará para criptografia em sua VM, você precisa ter acesso em um cofre de chave.</span><span class="sxs-lookup"><span data-stu-id="602f5-127">In order to use Azure Key Vault to store the keys you will use for encryption in your VM, you need access to a key vault.</span></span> <span data-ttu-id="602f5-128">Se você ainda não tiver configurado seu cofre de chave, crie um usando as etapas no tópico [Introdução ao Cofre da Chave do Azure](../articles/key-vault/key-vault-get-started.md) .</span><span class="sxs-lookup"><span data-stu-id="602f5-128">If you have not already set up your key vault, create one by following the steps in the [Getting Started with Azure Key Vault](../articles/key-vault/key-vault-get-started.md) topic.</span></span> <span data-ttu-id="602f5-129">Antes de concluir essas etapas, você precisa coletar algumas informações durante esse configuração que serão necessárias mais tarde quando você habilitar a integração do Cofre da Chave do Azure em sua VM do SQL.</span><span class="sxs-lookup"><span data-stu-id="602f5-129">Before completing these steps, note that there is some information you need to collect during this set up that is needed later when you enable Azure Key Vault Integration on your SQL VM.</span></span>

<span data-ttu-id="602f5-130">Quando você chega à etapa Criar um cofre de chave, observe a propriedade **vaultUri** retornada, que é a URL do cofre de chave.</span><span class="sxs-lookup"><span data-stu-id="602f5-130">When you get to the Create a key vault step, note the returned **vaultUri** property, which is the key vault URL.</span></span> <span data-ttu-id="602f5-131">No exemplo fornecido nesta etapa, mostrado abaixo, o nome do cofre de chaves é ContosoKeyVault, portanto a URL do cofre de chaves seria https://contosokeyvault.vault.azure.net/.</span><span class="sxs-lookup"><span data-stu-id="602f5-131">In the example provided in that step, shown below, the key vault name is ContosoKeyVault, therefore the key vault URL would be https://contosokeyvault.vault.azure.net/.</span></span>

    New-AzureRmKeyVault -VaultName 'ContosoKeyVault' -ResourceGroupName 'ContosoResourceGroup' -Location 'East Asia'

<span data-ttu-id="602f5-132">A URL do cofre de chave será atribuída posteriormente ao parâmetro **$akvURL** no script do PowerShell a fim de habilitar a integração do Cofre da Chave do Azure.</span><span class="sxs-lookup"><span data-stu-id="602f5-132">The key vault URL is assigned later to the **$akvURL** parameter in the PowerShell script to enable Azure Key Vault Integration.</span></span>

